var nt=Object.defineProperty;var it=(s,e,t)=>e in s?nt(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var b=(s,e,t)=>(it(s,typeof e!="symbol"?e+"":e,t),t);import{d as H,D as R,f as x,o as i,Y as y,$ as M,S as C,e8 as ce,a as S,O as P,cM as me,R as Me,ej as G,b as m,w,u as n,aS as K,eb as pe,c as $,dh as ee,dc as ue,aG as Y,e9 as j,ec as O,cO as rt,bT as Le,a0 as te,e as F,g as we,bB as fe,X as ke,ah as _e,Z as oe,bL as Se,cz as lt,cy as dt,cL as ut,eq as ct,aW as pt,ed as Be,eo as ht,d9 as gt,em as ft,en as vt,eh as mt,er as yt,es as wt}from"./index.429d5af1.js";import{M as Ze,u as X,P as kt,_ as _t,a as St,b as bt,g as Oe,c as ae,N as $t,d as It,e as Et,f as Tt,h as xt}from"./vue-flow-minimap.afb4ee1c.js";import{a as Ct,n as Re,v as je,c as Ye}from"./validations.7b07daeb.js";import{u as At}from"./uuid.c43e3a05.js";import{w as he,s as Pt}from"./metadata.20823a2e.js";import{a as Dt}from"./asyncComputed.66031dd4.js";import"./linters.0eb4bc15.js";import{W as de}from"./workspaces.008b1128.js";import{U as Nt,G as Ft}from"./UnsavedChangesHandler.98beb59a.js";import{A as Vt}from"./index.2714d174.js";import{G as Mt}from"./PhArrowCounterClockwise.vue.e8936528.js";import{T as zt}from"./TasksManager.513a2679.js";import{A as Ht}from"./index.5add1827.js";import{t as Ke}from"./index.bef232e8.js";import{B as Lt}from"./Badge.e201058b.js";import{G as ze}from"./PhArrowDown.vue.f022a0ab.js";import"./string.42086dba.js";import"./PhWebhooksLogo.vue.d7fee2df.js";import"./workspaceStore.57ea453d.js";import"./url.2cee4f24.js";import"./colorHelpers.e836055b.js";import"./record.5fdde497.js";import"./ExclamationCircleOutlined.b65ac907.js";import"./tasksController.4335182c.js";import"./gateway.6ce5c614.js";import"./popupNotifcation.9c9c53be.js";import"./polling.734732d4.js";import"./scripts.27f3450c.js";import"./ant-design.91680853.js";import"./PhArrowSquareOut.vue.cdcfeb77.js";import"./AbstraButton.vue_vue_type_script_setup_true_lang.bb04e227.js";import"./Card.7bdc584e.js";import"./TabPane.b4518e4d.js";import"./CollapsePanel.c9085149.js";import"./index.fa9bd0d4.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[e]="5b5d9501-627b-4f92-8563-dd694a7f55f4",s._sentryDebugIdIdentifier="sentry-dbid-5b5d9501-627b-4f92-8563-dd694a7f55f4")}catch{}})();const Bt=["width","height","fill","transform"],Zt={key:0},Ot=S("path",{d:"M244,56v48a12,12,0,0,1-12,12H184a12,12,0,1,1,0-24H201.1l-19-17.38c-.13-.12-.26-.24-.38-.37A76,76,0,1,0,127,204h1a75.53,75.53,0,0,0,52.15-20.72,12,12,0,0,1,16.49,17.45A99.45,99.45,0,0,1,128,228h-1.37A100,100,0,1,1,198.51,57.06L220,76.72V56a12,12,0,0,1,24,0Z"},null,-1),Rt=[Ot],jt={key:1},Yt=S("path",{d:"M216,128a88,88,0,1,1-88-88A88,88,0,0,1,216,128Z",opacity:"0.2"},null,-1),Kt=S("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1,0-16H211.4L184.81,71.64l-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,0,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60L224,85.8V56a8,8,0,1,1,16,0Z"},null,-1),Xt=[Yt,Kt],Wt={key:2},Ut=S("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1-5.66-13.66l17-17-10.55-9.65-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,1,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60l10.93,10L226.34,50.3A8,8,0,0,1,240,56Z"},null,-1),Gt=[Ut],qt={key:3},Jt=S("path",{d:"M238,56v48a6,6,0,0,1-6,6H184a6,6,0,0,1,0-12h32.55l-30.38-27.8c-.06-.06-.12-.13-.19-.19a82,82,0,1,0-1.7,117.65,6,6,0,0,1,8.24,8.73A93.46,93.46,0,0,1,128,222h-1.28A94,94,0,1,1,194.37,61.4L226,90.35V56a6,6,0,1,1,12,0Z"},null,-1),Qt=[Jt],es={key:4},ts=S("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1,0-16H211.4L184.81,71.64l-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,0,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60L224,85.8V56a8,8,0,1,1,16,0Z"},null,-1),ss=[ts],as={key:5},os=S("path",{d:"M236,56v48a4,4,0,0,1-4,4H184a4,4,0,0,1,0-8h37.7L187.53,68.69l-.13-.12a84,84,0,1,0-1.75,120.51,4,4,0,0,1,5.5,5.82A91.43,91.43,0,0,1,128,220h-1.26A92,92,0,1,1,193,62.84l35,32.05V56a4,4,0,1,1,8,0Z"},null,-1),ns=[os],is={name:"PhArrowClockwise"},rs=H({...is,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(s){const e=s,t=R("weight","regular"),a=R("size","1em"),o=R("color","currentColor"),r=R("mirrored",!1),u=x(()=>{var c;return(c=e.weight)!=null?c:t}),h=x(()=>{var c;return(c=e.size)!=null?c:a}),p=x(()=>{var c;return(c=e.color)!=null?c:o}),l=x(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:r?"scale(-1, 1)":void 0);return(c,g)=>(i(),y("svg",ce({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:h.value,height:h.value,fill:p.value,transform:l.value},c.$attrs),[M(c.$slots,"default"),u.value==="bold"?(i(),y("g",Zt,Rt)):u.value==="duotone"?(i(),y("g",jt,Xt)):u.value==="fill"?(i(),y("g",Wt,Gt)):u.value==="light"?(i(),y("g",qt,Qt)):u.value==="regular"?(i(),y("g",es,ss)):u.value==="thin"?(i(),y("g",as,ns)):C("",!0)],16,Bt))}}),ls=["width","height","fill","transform"],ds={key:0},us=S("path",{d:"M234.29,47.91A20,20,0,0,0,216,36H40A20,20,0,0,0,25.2,69.45l.12.14L92,140.75V216a20,20,0,0,0,31.1,16.64l32-21.33A20,20,0,0,0,164,194.66V140.75l66.67-71.16.12-.14A20,20,0,0,0,234.29,47.91Zm-91,79.89A12,12,0,0,0,140,136v56.52l-24,16V136a12,12,0,0,0-3.25-8.2L49.23,60H206.77Z"},null,-1),cs=[us],ps={key:1},hs=S("path",{d:"M221.9,61.38,152,136v58.65a8,8,0,0,1-3.56,6.66l-32,21.33A8,8,0,0,1,104,216V136L34.1,61.38A8,8,0,0,1,40,48H216A8,8,0,0,1,221.9,61.38Z",opacity:"0.2"},null,-1),gs=S("path",{d:"M230.6,49.53A15.81,15.81,0,0,0,216,40H40A16,16,0,0,0,28.19,66.76l.08.09L96,139.17V216a16,16,0,0,0,24.87,13.32l32-21.34A16,16,0,0,0,160,194.66V139.17l67.74-72.32.08-.09A15.8,15.8,0,0,0,230.6,49.53ZM40,56h0Zm106.18,74.58A8,8,0,0,0,144,136v58.66L112,216V136a8,8,0,0,0-2.16-5.47L40,56H216Z"},null,-1),fs=[hs,gs],vs={key:2},ms=S("path",{d:"M227.81,66.76l-.08.09L160,139.17v55.49A16,16,0,0,1,152.87,208l-32,21.34A16,16,0,0,1,96,216V139.17L28.27,66.85l-.08-.09A16,16,0,0,1,40,40H216a16,16,0,0,1,11.84,26.76Z"},null,-1),ys=[ms],ws={key:3},ks=S("path",{d:"M228.77,50.34A13.8,13.8,0,0,0,216,42H40A14,14,0,0,0,29.67,65.42l.06.07L98,138.38V216a14,14,0,0,0,21.77,11.64l32-21.33A14,14,0,0,0,158,194.66V138.38l68.33-73A13.82,13.82,0,0,0,228.77,50.34Zm-11.26,6.94L147.62,131.9A6,6,0,0,0,146,136v58.66a2,2,0,0,1-.89,1.67l-32,21.33A2,2,0,0,1,110,216V136a6,6,0,0,0-1.62-4.1L38.53,57.32A2,2,0,0,1,40,54H216a1.9,1.9,0,0,1,1.83,1.19A1.86,1.86,0,0,1,217.51,57.28Z"},null,-1),_s=[ks],Ss={key:4},bs=S("path",{d:"M230.6,49.53A15.81,15.81,0,0,0,216,40H40A16,16,0,0,0,28.19,66.76l.08.09L96,139.17V216a16,16,0,0,0,24.87,13.32l32-21.34A16,16,0,0,0,160,194.66V139.17l67.74-72.32.08-.09A15.8,15.8,0,0,0,230.6,49.53ZM40,56h0Zm106.18,74.58A8,8,0,0,0,144,136v58.66L112,216V136a8,8,0,0,0-2.16-5.47L40,56H216Z"},null,-1),$s=[bs],Is={key:5},Es=S("path",{d:"M227,51.15A11.85,11.85,0,0,0,216,44H40a12,12,0,0,0-8.88,20.07l.05.05L100,137.59V216a12,12,0,0,0,18.66,10l32-21.33a12,12,0,0,0,5.35-10V137.59l68.86-73.52A11.85,11.85,0,0,0,227,51.15Zm-8,7.5-69.9,74.62A4,4,0,0,0,148,136v58.65a4,4,0,0,1-1.78,3.33l-32,21.33A4,4,0,0,1,108,216V136a4,4,0,0,0-1.08-2.74L37.05,58.67A4,4,0,0,1,40,52H216a4,4,0,0,1,3,6.65Z"},null,-1),Ts=[Es],xs={name:"PhFunnel"},Cs=H({...xs,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(s){const e=s,t=R("weight","regular"),a=R("size","1em"),o=R("color","currentColor"),r=R("mirrored",!1),u=x(()=>{var c;return(c=e.weight)!=null?c:t}),h=x(()=>{var c;return(c=e.size)!=null?c:a}),p=x(()=>{var c;return(c=e.color)!=null?c:o}),l=x(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:r?"scale(-1, 1)":void 0);return(c,g)=>(i(),y("svg",ce({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:h.value,height:h.value,fill:p.value,transform:l.value},c.$attrs),[M(c.$slots,"default"),u.value==="bold"?(i(),y("g",ds,cs)):u.value==="duotone"?(i(),y("g",ps,fs)):u.value==="fill"?(i(),y("g",vs,ys)):u.value==="light"?(i(),y("g",ws,_s)):u.value==="regular"?(i(),y("g",Ss,$s)):u.value==="thin"?(i(),y("g",Is,Ts)):C("",!0)],16,ls))}}),As=P.object({type:P.enum(["forms","hooks","jobs","scripts"]),id:P.string(),title:P.string(),position:P.object({x:P.number(),y:P.number()}),props:P.object({path:P.string().nullable(),filename:P.string().nullable()})}),Ps=P.object({id:P.string(),type:P.literal("task"),sourceStageId:P.string(),targetStageId:P.string(),props:P.object({taskType:P.string().nullable()})}),He=P.object({stages:P.array(As),transitions:P.array(Ps)}),Ds={"Content-Type":"application/json"};class Ns{async load(){const e=await fetch("/_editor/api/workflows");if(e.ok){const t=await e.json();return He.parse(t)}else throw new Error("Failed to fetch initial data")}async update(e){const t=await fetch("/_editor/api/workflows",{method:"PUT",headers:Ds,body:JSON.stringify(e)});if(t.ok){const a=await t.json();return He.parse(a)}else throw new Error("Failed to update workflow")}}const Fs=new Ns;function Xe(){return Math.random().toString(36).slice(2,9)}class se{constructor(e){this.changes=e}apply(e){return this.changes.reduce((t,a)=>a.apply(t),e)}reverse(){return new se(this.changes.map(e=>e.reverse()).reverse())}}class We{constructor(e){b(this,"removed");this.stageId=e,this.removed=null}apply(e){const t=e.stages.find(o=>o.id===this.stageId)||null;if(!t)throw new Error(`Stage ${this.stageId} not found`);const a=e.transitions.filter(o=>o.sourceStageId===this.stageId||o.targetStageId===this.stageId);return this.removed={stage:t,transitions:a},{stages:e.stages.filter(o=>o.id!==t.id),transitions:e.transitions.filter(o=>!a.find(r=>r.id===o.id))}}reverse(){if(!this.removed)throw new Error("Cannot reverse change that was not applied");const e=new Ue(this.removed.stage.type,this.removed.stage.title,this.removed.stage.position,this.removed.stage.id,this.removed.stage.props),t=this.removed.transitions.map(a=>new be(a.sourceStageId,a.targetStageId,a.type,a.id));return new se([e,...t])}}class Ue{constructor(e,t,a,o,r){b(this,"addedStage");this.stageType=e,this.nodeTitle=t,this.position=a,this.id=o,this.props=r,this.addedStage=null}assertStageDoesNotExist(e){if(e.stages.find(t=>t.id===this.id))throw new Error(`Stage ${this.id} already exists`)}assertValidStageType(){if(!he.stages.find(e=>e.typeName===this.stageType))throw new Error(`Invalid stage type ${this.stageType}`)}assertTransitionDoesNotExist(e){if(e.transitions.find(t=>t.sourceStageId===this.id||t.targetStageId===this.id))throw new Error("Stage already has transitions")}makePath(e){switch(this.stageType){case"forms":return`new-form-${e}`;case"hooks":return`new-hook-${e}`;default:return null}}makeFilename(e){switch(this.stageType){case"forms":return`new_form_${e}.py`;case"hooks":return`new_hook_${e}.py`;case"jobs":return`new_job_${e}.py`;case"scripts":return`new_script_${e}.py`;default:return null}}apply(e){var o,r;const t=Xe(),a=(o=this.props)!=null?o:{path:this.makePath(t),filename:this.makeFilename(t)};return this.assertStageDoesNotExist(e),this.assertValidStageType(),this.assertTransitionDoesNotExist(e),this.addedStage={id:(r=this.id)!=null?r:At(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:a},{transitions:e.transitions,stages:[...e.stages,this.addedStage]}}reverse(){if(!this.addedStage)throw new Error("Cannot reverse change that was not applied");return new We(this.addedStage.id)}}class Vs extends se{constructor(e){super(e.map(t=>new Ue(t.type,t.title,t.position,t.id)))}}class Ge{constructor(e){b(this,"removedTransition");this.transitionId=e,this.removedTransition=null}apply(e){const t=e.transitions.find(a=>a.id===this.transitionId);if(!t)throw new Error(`Transition ${this.transitionId} not found`);return this.removedTransition=t!=null?t:null,{stages:e.stages,transitions:e.transitions.filter(a=>a.id!==this.transitionId)}}reverse(){if(!this.removedTransition)throw new Error("Cannot reverse change that was not applied");return new be(this.removedTransition.sourceStageId,this.removedTransition.targetStageId,this.removedTransition.type,this.removedTransition.id)}}class be{constructor(e,t,a,o){b(this,"addedTransition");this.sourceStageId=e,this.targetStageId=t,this.transitionType=a,this.transitionId=o,this.addedTransition=null}assertSourceStageExists(e){if(!e.stages.find(t=>t.id===this.sourceStageId))throw new Error(`Stage ${this.sourceStageId} not found`)}assertTargetStageExists(e){if(!e.stages.find(t=>t.id===this.targetStageId))throw new Error(`Stage ${this.targetStageId} not found`)}assertTransitionDoesNotExist(e){if(e.transitions.find(t=>t.id===this.transitionId))throw new Error(`Transition ${this.transitionId} already exists`)}assertNotSelfTransition(){if(this.sourceStageId===this.targetStageId)throw new Error("Self transitions are not allowed")}assertNoDuplicatedTransitionStages(e){if(e.transitions.find(t=>t.sourceStageId===this.sourceStageId&&t.targetStageId===this.targetStageId))throw me.error({message:"Invalid transition",description:"Transition already exists"}),new Error("Transition already exists")}assertNoStageWithSameId(e){if(e.stages.find(t=>t.id===this.transitionId))throw new Error(`Stage with id ${this.transitionId} already exists`)}apply(e){return this.assertSourceStageExists(e),this.assertTargetStageExists(e),this.assertTransitionDoesNotExist(e),this.assertNotSelfTransition(),this.assertNoDuplicatedTransitionStages(e),this.assertNoStageWithSameId(e),this.addedTransition={id:this.transitionId,sourceStageId:this.sourceStageId,targetStageId:this.targetStageId,type:this.transitionType,props:{taskType:null}},{stages:e.stages,transitions:[...e.transitions,this.addedTransition]}}reverse(){if(!this.addedTransition)throw new Error("Cannot reverse change that was not applied");return new Ge(this.addedTransition.id)}}class Ms extends se{constructor(e){super(e.map(t=>new be(t.sourceStageId,t.targetStageId,t.type,t.id)))}}class $e{constructor(e){b(this,"oldPositions");this.newPositions=e,this.oldPositions=null}assertStagesExists(e){this.newPositions.forEach(({id:t})=>{if(!e.stages.find(a=>a.id===t))throw new Error(`Stage ${t} not found`)})}assertIsNumber(){this.newPositions.forEach(({position:e})=>{if(Number.isNaN(e.x)||Number.isNaN(e.y)||!Number.isFinite(e.x)||!Number.isFinite(e.y))throw new Error("Position must be a number")})}apply(e){return this.assertIsNumber(),this.assertStagesExists(e),this.oldPositions=e.stages.map(a=>({id:a.id,position:a.position})),{stages:e.stages.map(a=>{var r,u;const o=(u=(r=this.newPositions.find(h=>h.id===a.id))==null?void 0:r.position)!=null?u:a.position;return{...a,position:{x:o.x,y:o.y}}}),transitions:e.transitions}}reverse(){if(!this.oldPositions)throw new Error("Cannot reverse change that was not applied");return new $e(this.oldPositions)}}class Ie{constructor(e,t){b(this,"stageId");b(this,"newTitle");b(this,"oldTitle");this.stageId=e,this.newTitle=t,this.oldTitle=""}assertStageExists(e){if(!e.stages.find(t=>t.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}apply(e){return this.assertStageExists(e),this.oldTitle=e.stages.find(t=>t.id===this.stageId).title,{stages:e.stages.map(t=>t.id===this.stageId?{...t,title:this.newTitle}:t),transitions:e.transitions}}reverse(){return new Ie(this.stageId,this.oldTitle)}}class Ee{constructor(e,t){b(this,"stageId");b(this,"newProps");b(this,"oldProps");this.stageId=e,this.newProps=t,this.oldProps={path:null,filename:null}}assertStageExists(e){if(!e.stages.find(t=>t.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}assertValidPath(){if(!this.newProps.path)return;const e=Ct(this.newProps.path);if(!e.valid){me.error({message:"Invalid path",description:e.reason});return}this.newProps.path=Re(this.newProps.path)}assertValidFilename(){if(!this.newProps.filename)return;const e=je(this.newProps.filename);if(!e.valid){me.error({message:"Invalid filename",description:e.reason});return}this.newProps.filename=Ye(this.newProps.filename)}apply(e){return this.assertStageExists(e),this.assertValidPath(),this.assertValidFilename(),this.oldProps=e.stages.find(t=>t.id===this.stageId).props,{stages:e.stages.map(t=>t.id===this.stageId?{...t,props:this.newProps}:t),transitions:e.transitions}}reverse(){return new Ee(this.stageId,this.oldProps)}}class Te{constructor(e,t){b(this,"newProps");b(this,"transitionId");b(this,"oldProps");this.newProps=t,this.transitionId=e,this.oldProps=t}apply(e){return{transitions:e.transitions.map(t=>t.id===this.transitionId?(this.oldProps=t.props,{...t,props:this.newProps}):t),stages:e.stages}}reverse(){return new Te(this.transitionId,this.oldProps)}}class zs extends se{constructor(e,t){super([...t.map(a=>new Ge(a)),...e.map(a=>new We(a))])}}class Hs{constructor(e){b(this,"currentState");b(this,"serverState");b(this,"undoStack");b(this,"redoStack");this.undoStack=[],this.redoStack=[],this.currentState=Me(Object.freeze(e)),this.serverState=Me(Object.freeze(e))}apply(e){return this.currentState.value=e.apply(this.currentState.value),this.undoStack.push(e),this.redoStack=[],this.currentState.value}canUndo(){return this.undoStack.length>0}undo(){const e=this.undoStack.pop();if(e){const t=e.reverse();this.currentState.value=t.apply(this.currentState.value),this.redoStack.push(e)}return this.currentState.value}canRedo(){return this.redoStack.length>0}redo(){const e=this.redoStack.pop();return e&&(this.currentState.value=e.apply(this.currentState.value),this.undoStack.push(e)),this.currentState.value}getState(){return this.currentState.value}setServerState(e){this.serverState.value=e}getServerState(){return this.serverState.value}hasStageChanges(){return!G.exports.isEqual(this.currentState.value.stages,this.serverState.value.stages)}hasChanges(){const e={...this.currentState.value,stages:[...this.currentState.value.stages].sort((a,o)=>a.id.localeCompare(o.id)),transitions:[...this.currentState.value.transitions].sort((a,o)=>a.id.localeCompare(o.id))},t={...this.serverState.value,stages:[...this.serverState.value.stages].sort((a,o)=>a.id.localeCompare(o.id)),transitions:[...this.serverState.value.transitions].sort((a,o)=>a.id.localeCompare(o.id))};return!G.exports.isEqual(e,t)}stageHasChanges(e){const t=this.currentState.value.stages.find(o=>o.id===e),a=this.serverState.value.stages.find(o=>o.id===e);return!G.exports.isEqual(t,a)}stageHasNonPositionChanges(e){const t=this.currentState.value.stages.find(o=>o.id===e),a=this.serverState.value.stages.find(o=>o.id===e);return!G.exports.isEqual(G.exports.omit(t,"position"),G.exports.omit(a,"position"))}}const Ls=2;class xe{constructor(e,t,a){b(this,"api");b(this,"editable");b(this,"history");b(this,"vueFlowNodes");b(this,"vueFlowEdges");this.editable=a,this.api=e,this.history=new Hs(t),this.vueFlowNodes=x(()=>this.computeVueFlowNodes()),this.vueFlowEdges=x(()=>this.computeVueFlowEdges())}static async init(e,t){const a=await e.load();return new xe(e,a,t)}inflateYFactor(){return this.editable?1:Ls}computeVueFlowNodes(){return this.history.getState().stages.map(t=>({id:t.id,type:t.type,data:t,position:{x:t.position.x,y:t.position.y*this.inflateYFactor()}}))}computeVueFlowEdges(){return this.history.getState().transitions.map(t=>({id:t.id,source:t.sourceStageId,target:t.targetStageId,type:"task",label:"task",markerEnd:{type:Ze.Arrow,width:24,height:24},data:t}))}getStage(e){var t;return(t=this.history.getState().stages.find(a=>a.id===e))!=null?t:null}updateStageTitle(e,t){this.history.apply(new Ie(e,t))}updateStageProps(e,t){this.history.apply(new Ee(e,t))}addStages(e){const t=e[0].type.slice(0,-1),a=t==="script"?"on task":t;return this.history.apply(new Vs(e.map(o=>{var r;return{...o,title:(r=o.title)!=null?r:`New ${a}`}}))),this.history.getState().stages.slice(-e.length)}connect(e){this.history.apply(new Ms(e))}move(e){this.history.apply(new $e(e))}delete(e){const t=this.history.getState(),a=t.stages.filter(r=>e.includes(r.id)).map(r=>r.id),o=t.transitions.filter(r=>e.includes(r.id)).map(r=>r.id);this.history.apply(new zs(a,o))}updateTransitionProps(e,t){this.history.apply(new Te(e,t))}hasChanges(){return this.history.hasChanges()}async save(){if(this.history.hasChanges()){const e=await this.api.update(this.history.getState());this.history.setServerState(e)}}}class Ce{static get isMac(){return navigator.userAgent.includes("Mac OS X")}static get buildPlatform(){return{}.CURRENT_PLATFORM||"web"}}const q=s=>Ce.isMac?s.metaKey:s.ctrlKey,Bs=s=>s.altKey,qe=s=>s.shiftKey,ve={alt:Bs,"arrow-up":s=>s.code==="ArrowUp","arrow-down":s=>s.code==="ArrowDown","arrow-left":s=>s.code==="ArrowLeft","arrow-right":s=>s.code==="ArrowRight",ctrl:q,delete:s=>Ce.isMac?s.code==="Backspace":s.code==="Delete",enter:s=>s.code==="Enter",escape:s=>s.code==="Escape",shift:qe,space:s=>s.code==="Space",a:s=>s.code==="KeyA",b:s=>s.code==="KeyB",c:s=>s.code==="KeyC",d:s=>s.code==="KeyD",f:s=>s.code==="KeyF",g:s=>s.code==="KeyG",h:s=>s.code==="KeyH",k:s=>s.code==="KeyK",p:s=>s.code==="KeyP",v:s=>s.code==="KeyV",x:s=>s.code==="KeyX",z:s=>s.code==="KeyZ",0:s=>s.code==="Digit0","[":s=>s.code==="BracketLeft","]":s=>s.code==="BracketRight"};class Zs{constructor(e){b(this,"pressedKeys");b(this,"evt");this.evt=e,this.pressedKeys={};const t=a=>o=>{Object.keys(ve).forEach(r=>{ve[r](o)&&this.setPressed(r,a)})};this.evt||(window.addEventListener("keydown",t(!0)),window.addEventListener("keyup",t(!1)))}setPressed(e,t){this.pressedKeys[e]=t}isPressed(e){var t;return this.evt?ve[e](this.evt):(t=this.pressedKeys[e])!=null?t:!1}}new Zs;const Os=["onDragstart"],Rs=H({__name:"BottomToolbar",props:{controller:{}},emits:["drag-start"],setup(s,{emit:e}){return(t,a)=>(i(),y(K,null,[m(n(ee),{class:"toolbar",align:"center"},{default:w(()=>[(i(!0),y(K,null,pe(n(he).stages,o=>(i(),$(n(rt),{key:o.key,placement:"top"},{title:w(()=>[m(n(ee),{gap:"small"},{default:w(()=>[m(n(ue),null,{default:w(()=>[Y(j(o.title),1)]),_:2},1024),m(n(ue),{keyboard:""},{default:w(()=>[Y(j(o.key),1)]),_:2},1024)]),_:2},1024)]),content:w(()=>[Y(j(o.description),1)]),default:w(()=>[S("div",{draggable:!0,class:"toolbar__item",onDragstart:r=>e("drag-start",r.dataTransfer,o.typeName)},[(i(),$(O(o.icon),{size:18}))],40,Os)]),_:2},1024))),128)),m(n(Vt),{type:"vertical"}),m(n(Le),{disabled:!t.controller.hasChanges(),onClick:a[0]||(a[0]=o=>t.controller.save())},{default:w(()=>[m(n(ee),{align:"center",gap:"small"},{default:w(()=>[m(n(Ft),{size:16}),Y(" Save ")]),_:1})]),_:1},8,["disabled"])]),_:1}),m(Nt,{"has-changes":t.controller.hasChanges()},null,8,["has-changes"])],64))}});const js=te(Rs,[["__scopeId","data-v-0b520c49"]]);function Je(){let s;const e={draggedType:F(null),isDragOver:F(!1),isAdding:F(!1),isDragging:F(!1),mousePosition:F(null)},{draggedType:t,isDragOver:a,isDragging:o,isAdding:r}=e,u=_=>{s=_,document.addEventListener("mousemove",I)},{screenToFlowCoordinate:h}=X();we(r,_=>{document.body.style.userSelect=_?"none":""});function p(_,D){r.value=!0,_?(_.setData("application/vueflow",D),_.effectAllowed="move",t.value=D,o.value=!0,document.addEventListener("drop",g)):(t.value=D,document.addEventListener("click",E))}function l(_){_.preventDefault(),t.value&&(a.value=!0,_.dataTransfer&&(_.dataTransfer.dropEffect="move"))}function c(){a.value=!1}function g(){r.value=!1,o.value=!1,a.value=!1,t.value=null,document.removeEventListener("drop",g)}function I(_){const D={x:_.pageX-200,y:_.pageY-80};e.mousePosition.value=D}function f(_){if(!t.value)throw new Error("No dragged type");return h({x:_.clientX-70,y:_.clientY-25})}function E(_){if(!s)return;if(!t.value)throw new Error("No dragged type");const D=f(_);s.addStages([{type:t.value,position:D}]),g()}function L(){document.removeEventListener("mousemove",I)}return{init:u,tearDown:L,draggedType:t,isDragOver:a,isAdding:r,isDragging:o,mousePosition:e.mousePosition,onDragStart:p,onDragLeave:c,onDragOver:l,onDrop:E}}const Ys={name:"ControlButton",compatConfig:{MODE:3}},Ks=(s,e)=>{const t=s.__vccOpts||s;for(const[a,o]of e)t[a]=o;return t},Xs={class:"vue-flow__controls-button"};function Ws(s,e,t,a,o,r){return i(),y("button",Xs,[M(s.$slots,"default")])}const Q=Ks(Ys,[["render",Ws]]),Us={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32"},Gs=S("path",{d:"M32 18.133H18.133V32h-4.266V18.133H0v-4.266h13.867V0h4.266v13.867H32z"},null,-1),qs=[Gs];function Js(s,e){return i(),y("svg",Us,qs)}const Qs={render:Js},ea={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 5"},ta=S("path",{d:"M0 0h32v4.2H0z"},null,-1),sa=[ta];function aa(s,e){return i(),y("svg",ea,sa)}const oa={render:aa},na={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 30"},ia=S("path",{d:"M3.692 4.63c0-.53.4-.938.939-.938h5.215V0H4.708C2.13 0 0 2.054 0 4.63v5.216h3.692V4.631zM27.354 0h-5.2v3.692h5.17c.53 0 .984.4.984.939v5.215H32V4.631A4.624 4.624 0 0 0 27.354 0zm.954 24.83c0 .532-.4.94-.939.94h-5.215v3.768h5.215c2.577 0 4.631-2.13 4.631-4.707v-5.139h-3.692v5.139zm-23.677.94a.919.919 0 0 1-.939-.94v-5.138H0v5.139c0 2.577 2.13 4.707 4.708 4.707h5.138V25.77H4.631z"},null,-1),ra=[ia];function la(s,e){return i(),y("svg",na,ra)}const da={render:la},ua={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},ca=S("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0 8 0 4.571 3.429 4.571 7.619v3.048H3.048A3.056 3.056 0 0 0 0 13.714v15.238A3.056 3.056 0 0 0 3.048 32h18.285a3.056 3.056 0 0 0 3.048-3.048V13.714a3.056 3.056 0 0 0-3.048-3.047zM12.19 24.533a3.056 3.056 0 0 1-3.047-3.047 3.056 3.056 0 0 1 3.047-3.048 3.056 3.056 0 0 1 3.048 3.048 3.056 3.056 0 0 1-3.048 3.047zm4.724-13.866H7.467V7.619c0-2.59 2.133-4.724 4.723-4.724 2.591 0 4.724 2.133 4.724 4.724v3.048z"},null,-1),pa=[ca];function ha(s,e){return i(),y("svg",ua,pa)}const ga={render:ha},fa={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},va=S("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0c-4.114 1.828-1.37 2.133.305 2.438 1.676.305 4.42 2.59 4.42 5.181v3.048H3.047A3.056 3.056 0 0 0 0 13.714v15.238A3.056 3.056 0 0 0 3.048 32h18.285a3.056 3.056 0 0 0 3.048-3.048V13.714a3.056 3.056 0 0 0-3.048-3.047zM12.19 24.533a3.056 3.056 0 0 1-3.047-3.047 3.056 3.056 0 0 1 3.047-3.048 3.056 3.056 0 0 1 3.048 3.048 3.056 3.056 0 0 1-3.048 3.047z"},null,-1),ma=[va];function ya(s,e){return i(),y("svg",fa,ma)}const wa={render:ya},ka={name:"Controls",compatConfig:{MODE:3}},_a=H({...ka,props:{showZoom:{type:Boolean,default:!0},showFitView:{type:Boolean,default:!0},showInteractive:{type:Boolean,default:!0},fitViewParams:{},position:{default:()=>kt.BottomLeft}},emits:["zoomIn","zoomOut","fitView","interactionChange"],setup(s,{emit:e}){const{nodesDraggable:t,nodesConnectable:a,elementsSelectable:o,setInteractive:r,zoomIn:u,zoomOut:h,fitView:p,viewport:l,minZoom:c,maxZoom:g}=X(),I=fe(()=>t.value||a.value||o.value),f=fe(()=>l.value.zoom<=c.value),E=fe(()=>l.value.zoom>=g.value);function L(){u(),e("zoomIn")}function _(){h(),e("zoomOut")}function D(){p(s.fitViewParams),e("fitView")}function z(){r(!I.value),e("interactionChange",!I.value)}return(T,B)=>(i(),$(n(_t),{class:"vue-flow__controls",position:T.position},{default:w(()=>[M(T.$slots,"top"),T.showZoom?(i(),y(K,{key:0},[M(T.$slots,"control-zoom-in",{},()=>[m(Q,{class:"vue-flow__controls-zoomin",disabled:E.value,onClick:L},{default:w(()=>[M(T.$slots,"icon-zoom-in",{},()=>[(i(),$(O(n(Qs))))])]),_:3},8,["disabled"])]),M(T.$slots,"control-zoom-out",{},()=>[m(Q,{class:"vue-flow__controls-zoomout",disabled:f.value,onClick:_},{default:w(()=>[M(T.$slots,"icon-zoom-out",{},()=>[(i(),$(O(n(oa))))])]),_:3},8,["disabled"])])],64)):C("",!0),T.showFitView?M(T.$slots,"control-fit-view",{key:1},()=>[m(Q,{class:"vue-flow__controls-fitview",onClick:D},{default:w(()=>[M(T.$slots,"icon-fit-view",{},()=>[(i(),$(O(n(da))))])]),_:3})]):C("",!0),T.showInteractive?M(T.$slots,"control-interactive",{key:2},()=>[T.showInteractive?(i(),$(Q,{key:0,class:"vue-flow__controls-interactive",onClick:z},{default:w(()=>[I.value?M(T.$slots,"icon-unlock",{key:0},()=>[(i(),$(O(n(wa))))]):C("",!0),I.value?C("",!0):M(T.$slots,"icon-lock",{key:1},()=>[(i(),$(O(n(ga))))])]),_:3})):C("",!0)]):C("",!0),M(T.$slots,"default")]),_:3},8,["position"]))}}),Sa=H({__name:"ControlButtons",props:{workflow:{}},setup(s){return(e,t)=>(i(),$(n(_a),{position:"top-left","show-interactive":!1},{default:w(()=>[m(n(Q),{title:"Undo",disabled:!e.workflow.history.canUndo(),onClick:t[0]||(t[0]=a=>e.workflow.history.undo())},{default:w(()=>[m(n(Mt))]),_:1},8,["disabled"]),m(n(Q),{title:"Redo",disabled:!e.workflow.history.canRedo(),onClick:t[1]||(t[1]=a=>e.workflow.history.redo())},{default:w(()=>[m(n(rs))]),_:1},8,["disabled"])]),_:1}))}});class ba{constructor(e,t){b(this,"dx");b(this,"dy");this.dx=t.x-e.x,this.dy=t.y-e.y}get x(){return this.dx}get y(){return this.dy}get length(){return Math.sqrt(this.dx*this.dx+this.dy*this.dy)}get m(){return this.dy/this.dx}}function $a(s,e,t=0){const{x:a,y:o}=e.center,{width:r,height:u}=e,h=new ba(s,e.center),p=t*(h.x/h.length),l=t*(h.y/h.length),c=u/r;let g,I;if(Math.abs(h.m)>Math.abs(c)){const f=u/2*(1/h.m);g=a-(h.y>0?f:-f),I=o+(h.y>0?-u/2:u/2)}else{const f=r/2*h.m;g=a+(h.x>0?-r/2:r/2),I=o-(h.x>0?f:-f)}return{x:g+p,y:I+l}}const Ia=(s,e=0,t=0)=>{const a=Math.atan2(s.ty-s.sy,s.tx-s.sx),o=e*Math.sin(a),r=e*Math.cos(a),u=t*Math.cos(a),h=t*Math.sin(a);return{sourceX:s.sx-o+u,sourceY:s.sy+r+h,targetX:s.tx-o-u,targetY:s.ty+r-h}};function ye(s,e,t=0){const a={x:s.computedPosition.x+s.dimensions.width/2,y:s.computedPosition.y+s.dimensions.height/2},r={center:{x:e.computedPosition.x+e.dimensions.width/2,y:e.computedPosition.y+e.dimensions.height/2},width:e.dimensions.width,height:e.dimensions.height};return $a(a,r,t)}function Qe(s,e){const t=ye(s,e,-10),a=ye(e,s,-10);return{sx:a.x,sy:a.y,tx:t.x,ty:t.y}}const Ea=H({__name:"TaskEdge",props:{id:{},sourceNode:{},targetNode:{},source:{},target:{},type:{},label:{type:[String,Object,Function]},style:{},selected:{type:Boolean},sourcePosition:{},targetPosition:{},sourceHandleId:{},targetHandleId:{},animated:{type:Boolean},updatable:{type:Boolean},markerStart:{},markerEnd:{},curvature:{},interactionWidth:{},data:{},events:{},labelStyle:{},labelShowBg:{type:Boolean},labelBgStyle:{},labelBgPadding:{},labelBgBorderRadius:{},sourceX:{},sourceY:{},targetX:{},targetY:{},controller:{}},setup(s){const e=s,t=F(e.data.props.taskType||""),a=F(!1),o=()=>{!a.value||(t.value!==e.data.props.taskType&&e.controller.updateTransitionProps(e.data.id,{taskType:t.value}),a.value=!1)},{onEdgeClick:r,onPaneClick:u}=X();r(c=>{c.edge.id===e.id&&!a.value&&(a.value=!0)}),u(()=>o());const h=x(()=>Qe(e.sourceNode,e.targetNode)),p=x(()=>Oe(Ia(h.value))),l=c=>{c.key==="Enter"&&o()};return ke(()=>window.addEventListener("keydown",l)),_e(()=>window.removeEventListener("keydown",l)),(c,g)=>(i(),y(K,null,[m(n(St),{path:p.value[0],"marker-end":c.markerEnd},null,8,["path","marker-end"]),m(n(bt),null,{default:w(()=>[a.value?(i(),y("div",{key:1,style:oe({transform:`translate(-50%, -50%) translate(${p.value[1]}px,${p.value[2]}px)`}),class:"nodrag nopan edge-input-container"},[m(n(Se),{value:t.value,"onUpdate:value":g[0]||(g[0]=I=>t.value=I),placeholder:"Task type"},null,8,["value"])],4)):(i(),y("div",{key:0,style:oe({transform:`translate(-50%, -50%) translate(${p.value[1]}px,${p.value[2]}px)`}),class:"nodrag nopan edge-label"},[e.data.props.taskType?(i(),$(n(ue),{key:1},{default:w(()=>[Y(j(e.data.props.taskType),1)]),_:1})):(i(),$(n(Cs),{key:0,size:16}))],4))]),_:1})],64))}});const Ta=te(Ea,[["__scopeId","data-v-d1728a8a"]]),xa={key:0},Ca=S("defs",null,[S("marker",{id:"arrowhead",markerWidth:"8",markerHeight:"8",refX:"0",refY:"4",orient:"auto",markerUnits:"strokeWidth"},[S("path",{d:"M0,0 L8,4 L0,8",fill:"none",stroke:"#222","stroke-width":"1"})])],-1),Aa=["d"],Pa=H({__name:"LineFloating",props:{targetX:{},targetY:{},sourcePosition:{},targetPosition:{},sourceNode:{}},setup(s){const e=s,t=F(!0),{onNodeMouseEnter:a,onNodeMouseLeave:o}=X();a(p=>{p.node.id===e.sourceNode.id&&(t.value=!1)}),o(p=>{p.node.id===e.sourceNode.id&&(t.value=!0)});const r=x(()=>({id:"connection-target",computedPosition:{x:e.targetX,y:e.targetY},dimensions:{width:1,height:1}})),u=x(()=>Qe(e.sourceNode,r.value)),h=x(()=>Oe({sourceX:u.value.sx,sourceY:u.value.sy,targetX:u.value.tx,targetY:u.value.ty}));return(p,l)=>t.value?(i(),y("g",xa,[Ca,S("path",{fill:"none",stroke:"#222","stroke-width":1,class:"animated",d:h.value[0],"marker-end":"url(#arrowhead)"},null,8,Aa)])):C("",!0)}}),Da=H({__name:"CreateStageFile",props:{filename:{},creatingFileStatus:{},fileExists:{type:Boolean}},emits:["create-file","cancel","update-filename"],setup(s,{emit:e}){const t=s,a=x(()=>{const o=je(t.filename);return o.valid?t.fileExists?{valid:!0,help:"This file already exists, stage will point to it."}:{valid:!0,help:"File doesn't exist yet. It will be created."}:o});return(o,r)=>(i(),$(n(ut),{open:o.creatingFileStatus==="prompting"||o.creatingFileStatus==="creating",closable:!1,"confirm-loading":o.creatingFileStatus==="creating",onOk:r[1]||(r[1]=u=>e("create-file",o.filename)),onCancel:r[2]||(r[2]=u=>e("cancel"))},{default:w(()=>[m(n(dt),{layout:"vertical",disabled:o.creatingFileStatus=="creating"},{default:w(()=>[m(n(lt),{label:"You're creating a new file. What should it be called?","validate-status":a.value.valid?"success":"error",help:a.value.valid?a.value.help:a.value.reason},{default:w(()=>[m(n(Se),{value:o.filename,onChange:r[0]||(r[0]=u=>e("update-filename",u.target.value||""))},null,8,["value"])]),_:1},8,["validate-status","help"])]),_:1},8,["disabled"])]),_:1},8,["open","confirm-loading"]))}}),Na={name:"NodeToolbar",compatConfig:{MODE:3},inheritAttrs:!1},Fa=H({...Na,props:{nodeId:null,isVisible:{type:Boolean},position:{default:ae.Top},offset:{default:10},align:{default:"center"}},setup(s){const e=s,t=R($t,null),{viewportRef:a,viewport:o,getSelectedNodes:r,findNode:u}=X();function h(f,E,L,_,D){let z=.5;D==="start"?z=0:D==="end"&&(z=1);let T=[(f.x+f.width*z)*E.zoom+E.x,f.y*E.zoom+E.y-_],B=[-100*z,-100];switch(L){case ae.Right:T=[(f.x+f.width)*E.zoom+E.x+_,(f.y+f.height*z)*E.zoom+E.y],B=[0,-100*z];break;case ae.Bottom:T[1]=(f.y+f.height)*E.zoom+E.y+_,B[1]=0;break;case ae.Left:T=[f.x*E.zoom+E.x-_,(f.y+f.height*z)*E.zoom+E.y],B=[-100,-100*z];break}return`translate(${T[0]}px, ${T[1]}px) translate(${B[0]}%, ${B[1]}%)`}const p=x(()=>(Array.isArray(e.nodeId)?e.nodeId:[e.nodeId||t||""]).reduce((f,E)=>{const L=u(E);return L&&f.push(L),f},[])),l=x(()=>typeof e.isVisible=="boolean"?e.isVisible:p.value.length===1&&p.value[0].selected&&r.value.length===1),c=x(()=>It(p.value)),g=x(()=>Math.max(...p.value.map(f=>(f.computedPosition.z||1)+1))),I=x(()=>({position:"absolute",transform:h(c.value,o.value,e.position,e.offset,e.align),zIndex:g.value}));return(f,E)=>(i(),$(ct,{to:n(a),disabled:!n(a)},[n(l)&&n(p).length?(i(),y("div",ce({key:0},f.$attrs,{style:n(I),class:"vue-flow__node-toolbar"}),[M(f.$slots,"default")],16)):C("",!0)],8,["to","disabled"]))}}),Va=H({__name:"NodeMenu",props:{isConnecting:{type:Boolean},isEditing:{type:Boolean},menuOptions:{}},setup(s){return(e,t)=>(i(),$(n(Fa),{"is-visible":e.isConnecting||e.isEditing?!1:void 0,position:n(ae).Right},{default:w(()=>[m(n(ee),{vertical:"",gap:"small",style:oe({marginBottom:`-${16*e.menuOptions.length}%`})},{default:w(()=>[(i(!0),y(K,null,pe(e.menuOptions,a=>(i(),$(n(pt),{key:a.label,title:a.tooltip,placement:"right"},{default:w(()=>[m(n(Le),{class:Be([{"warning-button":a.warning}]),disabled:a.disabled,style:oe({backgroundColor:a.disabled?"#f5f5f5":void 0}),onClick:o=>a.click(o)},{default:w(()=>[m(n(ee),{gap:"small",style:{width:"100%"},justify:"space-between",align:"center"},{default:w(()=>[Y(j(a.label)+" ",1),a.key?(i(),$(n(ue),{key:0,keyboard:"",disabled:a.disabled},{default:w(()=>[Y(j(a.key),1)]),_:2},1032,["disabled"])):C("",!0)]),_:2},1024)]),_:2},1032,["class","disabled","style","onClick"])]),_:2},1032,["title"]))),128))]),_:1},8,["style"])]),_:1},8,["is-visible","position"]))}});const Ma=H({__name:"StageNode",props:{stage:{},node:{},initialFileCheck:{type:Boolean},controller:{}},setup(s){var Ve;const e=s,{useToken:t}=Ke,{token:a}=t(),o=a.value.colorText,r=[{label:"Add transition",key:"T",click:d=>Pe(d)},{label:"Rename",key:"R",click:()=>Z.value=!0},{label:"Go to editor",key:"Enter",click:()=>Ae()},{label:"Tasks",key:"M",click:()=>h.value=!0},{label:"Delete",key:"Del",click:()=>ne(e.stage)}],u=x(()=>{let d=[...r];return p.value||d.unshift({label:"Create missing file",warning:!0,click:()=>L()}),e.controller.hasChanges()&&(d=d.map(k=>k.label==="Go to editor"?{...k,disabled:!0,tooltip:"Save it to allow editing"}:k)),d}),h=F(!1),p=F(e.initialFileCheck);we(()=>e.initialFileCheck,d=>{p.value=d});const l=d=>{I.value=d,g()},c=()=>{var d;f.value="idle",I.value=(d=e.stage.props.filename)!=null?d:"",g()},g=G.exports.debounce(async()=>{const d=I.value;if(!d){p.value=!0;return}de.checkFile(d).then(k=>{p.value=k.exists})},500),I=F((Ve=e.stage.props.filename)!=null?Ve:""),f=F("idle"),E=async()=>{f.value="creating",await de.initFile(I.value,e.stage.type),p.value=!0;const d=await de.checkFile(I.value);p.value=d.exists,f.value="idle",e.controller.updateStageProps(e.stage.id,{path:e.stage.props.path,filename:I.value})},L=()=>{f.value="prompting"},{startConnection:_,updateConnection:D,onNodeClick:z,addEdges:T,endConnection:B,removeNodes:ne,onPaneClick:v,getSelectedNodes:N,flowToScreenCoordinate:A,onNodeMouseEnter:ie,onNodeMouseLeave:re,getNodes:tt,onNodesChange:st,applyNodeChanges:at}=X(),ot=ht(),W=F(!1),Z=F(!1),U=F(e.stage.title),ge=F(!1);st(async d=>{var V;const k=[];for(const J of d)J.type==="remove"?Z.value||((V=e.controller)==null||V.delete([J.id]),k.push(J)):k.push(J);at(k)});const Ae=()=>{const d=e.stage.type==="scripts"?"on-task":e.stage.type.slice(0,-1);ot.push({path:`/_editor/${d}/${e.stage.id}`})},Pe=(d,k=!0)=>{_({nodeId:e.stage.id,type:"source",handleId:e.stage.id},{x:k?d.pageX-180:d.pageX-90,y:k?d.pageY-50:d.pageY-20}),document.addEventListener("mousemove",De),W.value=!0},De=d=>{W.value&&!ge.value&&D({x:d.pageX-180,y:d.pageY-52})};z(d=>{if(d.node.id===e.stage.id&&g(),W.value&&d.node.id!==e.stage.id){const k={sourceStageId:e.stage.id,targetStageId:d.node.id,type:"task",id:Xe(),props:{taskType:null}};try{e.controller.connect([k]),document.removeEventListener("mousemove",De),T({source:e.stage.id,target:d.node.id,type:"task",markerEnd:{type:Ze.Arrow,width:24,height:24},data:k}),B(),W.value=!1}catch(V){console.error(V)}}}),ie(d=>{if(W.value&&d.node.id!==e.stage.id){ge.value=!0;const k=tt.value.find(J=>J.id===e.stage.id);if(!k)return;const V=ye(k,d.node,-10);D(A({x:V.x-180,y:V.y-52}))}}),re(()=>{ge.value=!1});const Ne=()=>{if(!p.value){const d=Ye(U.value+".py");I.value=d;let k={filename:d,path:null};if(["forms","hooks"].includes(e.stage.type)){const V=Re(U.value);k={...k,path:V}}e.controller.updateStageProps(e.stage.id,k)}};v(()=>{Z.value=!1,e.stage.title!==U.value&&(e.controller.updateStageTitle(e.stage.id,U.value),Ne()),W.value=!1,B()});const Fe=d=>{if(!!N.value.map(k=>k.id).includes(e.stage.id)&&f.value==="idle"){if(d.key==="Enter")if(Z.value)Z.value=!1,e.controller.updateStageTitle(e.stage.id,U.value),Ne();else{if(e.controller.hasChanges())return;Ae()}if(!Z.value){if(d.key==="t"||d.key==="T"){const k=A(e.stage.position);Pe({pageX:k.x,pageY:k.y},!1)}(d.key==="r"||d.key==="R")&&(Z.value=!0),(d.key==="m"||d.key==="M")&&(h.value=!0)}}};return ke(()=>{window.addEventListener("keydown",Fe)}),_e(()=>{window.removeEventListener("keydown",Fe)}),(d,k)=>(i(),y(K,null,[m(Va,{"is-connecting":W.value,"is-editing":Z.value,"menu-options":u.value},null,8,["is-connecting","is-editing","menu-options"]),S("div",{class:"stage",onDblclick:k[1]||(k[1]=V=>Z.value=!0)},[m(n(ee),{class:"point",gap:"small",align:"center",style:{padding:"4px 0"}},{default:w(()=>[(i(),$(O(n(Pt)(d.stage.type)),{size:18,color:n(o)},null,8,["color"])),Z.value?(i(),$(n(Se),{key:1,value:U.value,"onUpdate:value":k[0]||(k[0]=V=>U.value=V),class:"input nodrag nopan",autofocus:""},null,8,["value"])):(i(),$(n(gt),{key:0,class:"title"},{default:w(()=>[Y(j(d.stage.title),1)]),_:1}))]),_:1})],32),p.value?C("",!0):(i(),$(n(Lt),{key:0,count:"!",color:"gold",style:{position:"absolute",top:"-4px",right:"-4px","z-index":"1"}})),f.value==="prompting"||f.value==="creating"?(i(),$(Da,{key:1,filename:I.value,"file-exists":p.value,"creating-file-status":f.value,onCreateFile:E,onCancel:c,onUpdateFilename:l},null,8,["filename","file-exists","creating-file-status"])):C("",!0),m(n(Ht),{visible:h.value,"onUpdate:visible":k[2]||(k[2]=V=>h.value=V),title:"Tasks",width:"500",onClose:k[3]||(k[3]=V=>h.value=!1)},{default:w(()=>[m(zt,{"stage-id":d.stage.id},null,8,["stage-id"])]),_:1},8,["visible"])],64))}});const le=te(Ma,[["__scopeId","data-v-d4e2f035"]]),et=s=>(ft("data-v-f4278104"),s=s(),vt(),s),za={class:"empty-hint"},Ha={key:0,class:"drag-hint"},La=et(()=>S("div",{class:"title"},"Start here",-1)),Ba={key:1,class:"drop-hint"},Za=et(()=>S("div",{class:"title"},"Drop here",-1)),Oa={key:2,class:"stages-hint"},Ra={class:"header"},ja={class:"title"},Ya={class:"description"},Ka=H({__name:"EmptyHint",props:{showDragHint:{type:Boolean}},setup(s){return(e,t)=>(i(),y("div",za,[e.showDragHint?(i(),y("div",Ha,[La,m(n(ze),{size:32,class:"arrow"})])):C("",!0),e.showDragHint?C("",!0):(i(),y("div",Ba,[Za,m(n(ze),{size:32,class:"arrow"})])),e.showDragHint?(i(),y("div",Oa,[(i(!0),y(K,null,pe(n(he).stages,a=>(i(),y("div",{key:a.key,class:"stage-hint"},[S("div",Ra,[(i(),$(O(a.icon))),S("span",ja,j(a.title),1)]),S("div",Ya,j(a.description),1)]))),128))])):C("",!0)]))}});const Xa=te(Ka,[["__scopeId","data-v-f4278104"]]),Wa=H({__name:"Workflow",props:{workflow:{},editable:{type:Boolean},showDragHint:{type:Boolean},checkFileStatus:{type:Boolean},initialFileCheckStatus:{}},setup(s){const e=s;mt(l=>({62087824:n(u),"4e9398e2":n(r)}));const t=Je(),{useToken:a}=Ke,{token:o}=a(),r=o.value.colorPrimaryBorder,u=o.value.colorBgElevated,{onInit:h}=X();h(l=>{l.fitView()});const p=l=>{var c;return!e.checkFileStatus||!e.initialFileCheckStatus?!0:l&&(c=e.initialFileCheckStatus[l])!=null?c:!1};return(l,c)=>l.workflow?(i(),$(n(Et),{key:0,nodes:l.workflow.vueFlowNodes.value,edges:l.workflow.vueFlowEdges.value,"max-zoom":1.25,class:"vue-flow-root","select-nodes-on-drag":!1,"zoom-on-double-click":!1,multi:"","multi-selection-key-code":"Shift","nodes-draggable":l.editable,"pan-on-scroll":n(Ce).isMac,"elements-selectable":l.editable,"snap-to-grid":"","apply-default":!1,onDragover:n(t).onDragOver,onDragleave:n(t).onDragLeave},{"connection-line":w(g=>[m(Pa,yt(wt(g)),null,16)]),"edge-task":w(g=>[m(Ta,ce(g,{controller:l.workflow}),null,16,["controller"])]),"node-forms":w(g=>[m(le,{stage:g.data,node:g,controller:l.workflow,"initial-file-check":p(g.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-hooks":w(g=>[m(le,{stage:g.data,node:g,controller:l.workflow,"initial-file-check":p(g.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-scripts":w(g=>[m(le,{stage:g.data,node:g,controller:l.workflow,"initial-file-check":p(g.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-jobs":w(g=>[m(le,{stage:g.data,node:g,controller:l.workflow,"initial-file-check":p(g.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),default:w(()=>[m(n(Tt)),l.editable&&!l.workflow.vueFlowNodes.value.length?(i(),$(Xa,{key:0,"show-drag-hint":l.showDragHint},null,8,["show-drag-hint"])):C("",!0),m(n(xt),{pannable:"",zoomable:""}),l.editable?(i(),$(Sa,{key:1,workflow:l.workflow},null,8,["workflow"])):C("",!0)]),_:1},8,["nodes","edges","nodes-draggable","pan-on-scroll","elements-selectable","onDragover","onDragleave"])):C("",!0)}});const Ua=te(Wa,[["__scopeId","data-v-76b25631"]]),Ga=H({__name:"WorkflowEditor",setup(s){const{init:e,tearDown:t,onDragStart:a,onDrop:o,isDragging:r,isAdding:u,draggedType:h,mousePosition:p}=Je(),{result:l}=Dt(()=>xe.init(Fs,!0)),c=F(null),g=async()=>{if(!l.value)return;const v=l.value.vueFlowNodes.value.map(N=>{var A;return(A=N.data)==null?void 0:A.props.filename});c.value=await de.checkFiles(v.filter(N=>typeof N=="string"))};we(()=>l.value,()=>{l.value&&(e(l.value),g())});const{onNodeDragStop:I,onEdgesChange:f,getSelectedElements:E,getNodes:L,addSelectedNodes:_,zoomIn:D,fitView:z,zoomOut:T,applyEdgeChanges:B}=X();I(v=>{var N;(N=l.value)==null||N.move(v.nodes.map(A=>({id:A.id,position:A.position})))}),f(v=>{var N;for(const A of v)A.type==="remove"&&((N=l.value)==null||N.delete([A.id]));B(v)});const ne=v=>{var N,A;!l.value||((v.key==="z"||v.key==="Z")&&q(v)&&(qe(v)?l.value.history.redo():(N=l.value)==null||N.history.undo(),v.preventDefault()),!E.value.length&&(v.key==="f"||v.key==="F"?a(null,"forms"):v.key==="h"||v.key==="H"?a(null,"hooks"):v.key==="j"||v.key==="J"?a(null,"jobs"):v.key==="o"||v.key==="O"?a(null,"scripts"):v.key==="s"||v.key==="S"?q(v)&&((A=l.value)==null||A.save(),v.preventDefault()):(v.key==="a"||v.key==="A")&&q(v)?(_(L.value),v.preventDefault()):v.key==="0"&&q(v)?(z(),v.preventDefault()):(v.key==="="||v.key==="+")&&q(v)?(v.preventDefault(),D()):v.key==="-"&&q(v)&&(v.preventDefault(),T())))};return ke(()=>{window.addEventListener("keydown",ne)}),_e(()=>{window.removeEventListener("keydown",ne),t()}),(v,N)=>n(l)?(i(),y("div",{key:0,class:Be(["workflow-container",{dragging:n(u)}]),onDrop:N[0]||(N[0]=(...A)=>n(o)&&n(o)(...A))},[m(Ua,{workflow:n(l),editable:"","show-drag-hint":!n(u),"check-file-status":!0,"initial-file-check-status":c.value},null,8,["workflow","show-drag-hint","initial-file-check-status"]),m(js,{controller:n(l),onDragStart:n(a)},null,8,["controller","onDragStart"]),(i(!0),y(K,null,pe(n(he).stages,A=>{var ie,re;return i(),y("div",{key:A.key},[n(u)&&!n(r)&&A.typeName===n(h)?(i(),y("div",{key:0,class:"dragging-node",style:oe({left:`${(ie=n(p))==null?void 0:ie.x}px`,top:`${(re=n(p))==null?void 0:re.y}px`,position:"absolute",cursor:n(u)?"grabbing":"grab"})},[(i(),$(O(A.icon),{size:18}))],4)):C("",!0)])}),128))],34)):C("",!0)}});const Fo=te(Ga,[["__scopeId","data-v-8c16a004"]]);export{Fo as default};
//# sourceMappingURL=WorkflowEditor.7af441ec.js.map
