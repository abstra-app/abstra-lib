var ce=Object.defineProperty;var de=(u,e,n)=>e in u?ce(u,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):u[e]=n;var l=(u,e,n)=>(de(u,typeof e!="symbol"?e+"":e,n),n);import{p as j}from"./passwordlessManager.8b0c672e.js";import{P as he}from"./Passwordless.0943eeec.js";import{e as fe,R as pe}from"./executeJs.5aff51e5.js";import{L as me}from"./CircularLoading.45f7b299.js";import{W as ve}from"./WidgetsFrame.bbded71d.js";import{d as F,a as ge,b as c,c as y,t as _,D as B,B as ye,q as x,r as E,w as te,U as we,z as re,V as Y,x as I,N as T,K as Q,a1 as be,v as _e,a6 as X,o as ke,Y as Ee,G as Z,e as $,a7 as Se,a8 as Pe,a9 as We,F as N,L as O,$ as Le}from"./registerWidgets.cecc7add.js";import{_ as Ae}from"./ActionButton.vue_vue_type_script_setup_true_lang.bfc19705.js";import{i as Ie,j as Ce}from"./icons.a47594f6.js";(function(){try{var u=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(u._sentryDebugIds=u._sentryDebugIds||{},u._sentryDebugIds[e]="cd828f59-8b1b-45e9-a490-f9831d6f0f9b",u._sentryDebugIdIdentifier="sentry-dbid-cd828f59-8b1b-45e9-a490-f9831d6f0f9b")}catch{}})();function P(u){return"key"in u&&"value"in u&&"errors"in u}async function Fe(u){window.should_ask_before_leave=!1,window.location.href=u.url}const Be={redirect:Fe,"execute-js":fe};class H{constructor(e,n){l(this,"endedByPage",!1);l(this,"reactivePollInterval",null);l(this,"programEnded",!1);l(this,"widgetError",()=>{this.newPageState({widgets:[{type:"error"}],actions:[],fullWidth:!1,hasError:!1,steps:null})});l(this,"widgetEnd",()=>{this.endedByPage||this.newPageState({widgets:[{type:"end"}],actions:this.pageActionFactory.restartAction,fullWidth:!1,hasError:!1,steps:null})});l(this,"sendUser",e=>{this.broker.send({type:"auth:saved-jwt",jwt:e.jwt}),this.broker.send({type:"metadata",payload:{authenticated_user:e.claims.email}})});l(this,"sendBrowserTryDisconnect",()=>{this.broker.send({type:"browser:try-disconnect"})});l(this,"newPageStateListener",()=>{});l(this,"updatePageStateListener",()=>{});l(this,"onReactivePollListener",()=>{});l(this,"onErrorListener",()=>{});l(this,"onExitListener",()=>{});l(this,"onStartAuthListener");l(this,"onEndAuthListener");l(this,"onBadAuthListener");this.broker=e,this.pageActionFactory=n}static create(e,n){const t=new H(e,n);return t.broker.onClose(()=>{if(t.programEnded)return;const o="Connection with service closed before program ended";t.widgetError(),t.error(o)}),t.broker.on("form",({widgets:o,actions:i,buttonText:s,endProgram:d,reactivePollingInterval:f,steps:w})=>{t.newPageState({widgets:o,actions:t.pageActionFactory.fromPageActionsDto(s?[s]:i!=null?i:[]),fullWidth:o.some(L=>"fullWidth"in L&&L.fullWidth),hasError:!1,steps:w}),f&&(t.reactivePollInterval=setInterval(t.onReactivePollListener,f*1e3)),d&&(t.endedByPage=!0,t.broker.send({type:"form-response",payload:{},secrets:[]}))}),t.broker.on("action",async({action:o})=>{var d;let i=null,s;try{const{type:f}=o;i=(d=await Be[f](o))!=null?d:null}catch(f){s=f.message}t.broker.send({type:"action-response",value:i,errorMessage:s})}),t.broker.on("auth:require-info",()=>{t.newPageState({widgets:[],actions:[],fullWidth:!1,hasError:!1,steps:null}),t.onStartAuthListener&&t.onStartAuthListener()}),t.broker.on("auth:valid-jwt",()=>{t.onEndAuthListener&&t.onEndAuthListener()}),t.broker.on("auth:invalid-jwt",()=>{console.warn("invalid jwt"),t.onBadAuthListener&&t.onBadAuthListener()}),t.broker.on("program:connection-error",o=>{t.widgetError(),t.error(o)}),t.broker.on("program:end",o=>{t.programEnded=!0,o.exitCode||o.exception?(t.widgetError(),t.error(o)):(t.widgetEnd(),t.exit(o))}),t.broker.on("program:disconnect",o=>{t.exit(o)}),t.broker.on("not-enough-credits",()=>{t.error({error:"not-enough-credits"}),t.programEnded=!0}),t.broker.on("heartbeat",()=>{t.broker.resetHeartbeatCounter()}),t.broker.on("form-update",({widgets:o,validation:i})=>{t.updatePageState({widgets:o,validation:{message:i.message,status:i.status},fullWidth:o.some(s=>"fullWidth"in s&&s.fullWidth)})}),t}handleAction(e,n,t,o,i){if((Object.values(n).some(f=>f.length>0)||!o)&&(t==null?void 0:t.name)!=="Back"){this.updatePageState({hasError:!0});return}this.reactivePollInterval&&clearInterval(this.reactivePollInterval);const d={};Object.entries(e).forEach(([f,w])=>{d[f]=w}),this.broker.send({type:"form-response",payload:d,action:t==null?void 0:t.name,secrets:i})}sendUserEvent(e,n){const t={};Object.entries(e).forEach(([o,i])=>{t[o]=i}),this.broker.send({type:"user-event",payload:t,secrets:n})}init(e){this.broker.resetState(),this.newPageState({widgets:[],actions:[],fullWidth:!1,hasError:!1,steps:null}),this.broker.connect(e!=null?e:{})}newPageState(e){this.newPageStateListener(e)}updatePageState(e){this.updatePageStateListener(e)}listenToNewPageState(e){this.newPageStateListener=e}listenToPageStateUpdate(e){this.updatePageStateListener=e}onReactivePoll(e){this.onReactivePollListener=e}error(e){this.reactivePollInterval&&clearInterval(this.reactivePollInterval),this.onErrorListener(e)}onError(e){this.onErrorListener=e}exit(e){this.reactivePollInterval&&clearInterval(this.reactivePollInterval),this.onExitListener(e)}onExit(e){this.onExitListener=e}onStartAuth(e){this.onStartAuthListener=e}onEndAuth(e){this.onEndAuthListener=e}onBadAuth(e){this.onBadAuthListener=e}}class W{constructor(e,n){l(this,"element",null);this.name=e,this.isDefault=n}static fromDto(e){return typeof e=="string"?new W(e,!1):new W(e.name,e.is_default)}setElement(e){e instanceof HTMLElement&&(this.element=e)}get isFocused(){return this.element===document.activeElement}focusOnButton(){var e;(e=this.element)==null||e.focus()}addKeydownListener(e){var n;(n=this.element)==null||n.addEventListener("keydown",e)}}class M{constructor(e){this.form=e}static from(e){return new M(e)}get startAction(){var e;return[W.fromDto((e=this.form.startButtonText)!=null?e:"Start")]}get restartAction(){var n;const e=(n=this.form.restartButtonText)!=null?n:"Restart";return this.form.allowRestart?[W.fromDto(e)]:[]}fromPageActionsDto(e){return e.filter(n=>!!n).map(n=>W.fromDto(n))}}const xe={class:"outline-button"},De=F({__name:"OutlineButton",props:{iconPath:{},noShadow:{type:Boolean},status:{}},setup(u){return(e,n)=>{const t=ge("icon");return c(),y("button",xe,[e.iconPath?(c(),_(t,{key:0,path:e.iconPath,fill:"#fff",class:"icon"},null,8,["path"])):B("",!0),ye(e.$slots,"default",{},void 0,!0)])}}});const Ue=x(De,[["__scopeId","data-v-d16448de"]]),Re=F({__name:"FormAutoFill",props:{broker:{},form:{}},setup(u){const e=u,n=window.__runs||(window.__runs={previous:[],current:[]});e.broker.on("start",()=>{n.previous=n.current,n.current=[]});const t=E(null);function o(){for(const d in n.current){const f=n.previous[d],w=n.current[d];if(!f||f.type!==w.type||f.type=="form"&&!Y.exports.isEqual(f.widgets,w.widgets)||f.type=="form-response"&&!Y.exports.isEqual(f.payload,w.payload))return null}const s=n.previous[n.current.length];if((s==null?void 0:s.type)!=="form-response")return null;t.value=s}function i(){const s=t.value;s&&e.broker.send(s)}return e.broker.on("form",s=>{n.current.push(s),o()}),e.broker.on("form-response",s=>{n.current.push(s),t.value=null}),(s,d)=>t.value?(c(),_(Ue,{key:0,"icon-path":re(Ie),class:"form-auto-fill-btn",onClick:i},{default:te(()=>[we(" Repeat last answer ")]),_:1},8,["icon-path"])):B("",!0)}});const je=x(Re,[["__scopeId","data-v-9590d96b"]]),$e={key:0,class:"hint"},Ne={class:"icon",viewBox:"0 0 24 24",style:{width:"20px",height:"20px"}},Oe=["d"],Ve={class:"hint-content"},Te=F({__name:"WidgetHint",props:{hint:{}},setup(u){return(e,n)=>e.hint?(c(),y("div",$e,[(c(),y("svg",Ne,[I("path",{d:re(Ce)},null,8,Oe)])),I("div",Ve,T(e.hint),1)])):B("",!0)}});const He=x(Te,[["__scopeId","data-v-419a518f"]]),Me={key:0,class:"form-wrapper"},ze=["id"],Je={key:1,class:"loading-wrapper"},Ge={class:"span-error"},Ke={class:"buttons"},qe=F({__name:"FormRunner",props:{form:{},params:{},isPreview:{type:Boolean},enableAutoFocus:{type:Boolean},broker:{}},emits:["log","error","exit","navigate","logout","start"],setup(u,{expose:e,emit:n}){const t=u,o=[],i=E({}),s=E({}),d=E({}),f=(r,a)=>{o[a]=r},w=E(null),L=Q(()=>M.from(t.form)),ne=r=>n("navigate",r),D=()=>{p.value={widgets:[{type:"start"}],actions:L.value.startAction,fullWidth:!1,hasError:!1,steps:null}};be(()=>t.form,()=>{var r;((r=p.value.widgets[0])==null?void 0:r.type)=="start"&&D()});const b=_e({user:null,authenticating:!1}),p=E({widgets:[],fullWidth:!1,hasError:!1,actions:[],steps:null}),A=E("idle"),z=Q(()=>p.value.widgets.filter(r=>"secret"in r).reduce((r,a)=>"key"in a&&"secret"in a?[...r,{key:a.key,secret:a.secret}]:r,[]));J();function J(){b.user=j.getUser()}const se=()=>{j.removeUser(),J(),n("logout")},g=H.create(t.broker,L.value);g.onError(r=>{var a;if(n("error",r),A.value="error",r.error==="not-enough-credits"){(a=w.value)==null||a.open(),D();return}}),g.onExit(r=>{n("exit",r),A.value="over"}),g.onStartAuth(()=>{b.user?g.sendUser(b.user):b.authenticating=!0}),g.onEndAuth(()=>{b.authenticating=!1}),g.onBadAuth(()=>{j.removeUser(),b.user=null,b.authenticating=!0}),g.onReactivePoll(()=>{g.sendUserEvent(i.value,z.value)});const oe=r=>{b.user=r,g.sendUser(r)};g.listenToNewPageState(r=>{p.value=r,X.init(t.enableAutoFocus,()=>U());const a={},h={};p.value.widgets.forEach(v=>{P(v)&&(a[v.key]=v.value,h[v.key]=v.errors)}),i.value=a,s.value=h}),g.listenToPageStateUpdate(r=>{p.value={...p.value,...r};const a={},h={};p.value.widgets.forEach(v=>{P(v)&&(a[v.key]=v.value,h[v.key]=v.errors)}),i.value=a,s.value=h});const G=r=>{var a;if(!(A.value!=="running"||t.isPreview||!((a=window.should_ask_before_leave)==null||a)))return g.sendBrowserTryDisconnect(),r.preventDefault(),r.returnValue="Are you sure?",""};ke(async()=>{window.addEventListener("beforeunload",G),D(),X.init(t.enableAutoFocus,r=>U(r)),t.form.autoStart&&R()}),Ee(()=>{t.broker.close(),window.removeEventListener("beforeunload",G)});const ae=()=>{o.forEach(r=>{!r||!("setErrors"in r)||typeof r.setErrors!="function"||r.setErrors()})},U=async r=>{var h,v;if(A.value!=="running")return R();ae(),!Object.values(d.value).some(m=>m.length>0)&&g.handleAction(i.value,s.value,r,(v=(h=p.value.validation)==null?void 0:h.status)!=null?v:!0,z.value)},R=async()=>{g.init(t.params),A.value="running",n("start")};function ie(r){var a;return P(r)&&(a=i.value[r.key])!=null?a:null}function K(r){var a,h;return P(r)?[...(a=s.value[r.key])!=null?a:[],...(h=d.value[r.key])!=null?h:[]]:[]}function le(r,a){if(!P(r))return;const h={...i.value};h[r.key]=a,i.value=h,g.sendUserEvent(i.value)}function ue(r,a){if(!P(r))return;const h={...d.value};h[r.key]=a,d.value=h}return e({run:R}),(r,a)=>(c(),_(ve,{class:Z([{preview:r.isPreview},"runner"]),"main-color":r.form.mainColor,theme:r.form.theme,"font-family":r.form.fontFamily,runtime:"form"},{default:te(()=>{var h,v;return[r.isPreview?(c(),_(je,{key:0,class:"auto-fill-btn",broker:r.broker,form:r.form,style:{"z-index":1}},null,8,["broker","form"])):B("",!0),$(pe,{ref_key:"runtimeCommonsRef",ref:w,runtime:r.form,"full-width":p.value.fullWidth,"steps-info":p.value.steps,"is-preview":r.isPreview,"user-email":(h=b.user)==null?void 0:h.claims.email,type:"forms",onLogout:se,onNavigate:ne},null,8,["runtime","full-width","steps-info","is-preview","user-email"]),I("main",null,[b.authenticating?(c(),_(he,{key:0,class:"form-auth",onDone:oe})):(c(),y("div",{key:1,class:Z(["form",{"full-width":p.value.fullWidth}])},[p.value.widgets.length>0?(c(),y("div",Me,[p.value.widgets[0].type=="start"?(c(),_(Se,{key:0,form:r.form},null,8,["form"])):p.value.widgets[0].type=="end"?(c(),_(Pe,{key:1,"end-message":r.form.endMessage},null,8,["end-message"])):p.value.widgets[0].type=="error"?(c(),_(We,{key:2,"error-message":r.form.errorMessage},null,8,["error-message"])):(c(!0),y(N,{key:3},O(p.value.widgets,(m,C)=>{var q;return c(),y("div",{id:m.type+C,key:(q=m.key)!=null?q:m.type+C,class:"widget"},[(c(),_(Le(m.type),{ref_for:!0,ref:k=>f(k,C),value:ie(m),errors:K(m),"user-props":m,runtime:"form","onUpdate:value":k=>le(m,k),"onUpdate:errors":k=>ue(m,k)},null,40,["value","errors","user-props","onUpdate:value","onUpdate:errors"])),$(He,{hint:"hint"in m?m.hint:null},null,8,["hint"]),(c(!0),y(N,null,O(K(m),k=>(c(),y("span",{key:k,class:"span-error"},T(k),1))),128))],8,ze)}),128))])):(c(),y("div",Je,[$(me)])),I("span",Ge,T((v=p.value.validation)==null?void 0:v.message),1),I("div",Ke,[(c(!0),y(N,null,O(p.value.actions,m=>(c(),_(Ae,{key:m.name,action:m,onNext:C=>U(m)},null,8,["action","onNext"]))),128))])],2))])]}),_:1},8,["class","main-color","theme","font-family"]))}});const at=x(qe,[["__scopeId","data-v-782096bc"]]),Ye=[WebSocket.CLOSING,WebSocket.CLOSED];function ee(u,e){const n=u[e.type];if(!n){console.warn("no callback for",e.type);return}n.forEach(t=>t(e))}const S=class{constructor(e){l(this,"formPath",null);l(this,"ws",null);l(this,"callbacks",{"form-response":[],"form-update":[],start:[],"auth:info":[],"auth:saved-jwt":[],"auth:restart":[],"auth:validate-token":[],"auth:resend-token":[],heartbeat:[],metadata:[],"executed-by":[],"action-response":[],"user-event":[],"program:end":[],"program:disconnect":[],"program:connection-error":[],stderr:[],stdout:[],form:[],action:[],"not-enough-credits":[],"auth:require-info":[],"auth:expecting-token":[],"auth:token-expired":[],"auth:invalid-token":[],"auth:invalid-jwt":[],"auth:valid-token":[],"auth:valid-jwt":[],"browser:disconnect":[],"browser:try-disconnect":[]});l(this,"onCloseCallbacks",[]);l(this,"heartbeatCounter",0);l(this,"heartbeatInterval");l(this,"params",{});var n;"formPath"in e&&(this.formPath=(n=e.formPath)!=null?n:null)}static create(e){return S._instance&&S._instance.close(),S._instance=new S(e),S._instance}get url(){return`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}/_socket?formPath=${encodeURIComponent(this.formPath)}`}resetState(){this.close()}resetHeartbeatCounter(){this.heartbeatCounter=0}on(e,n){this.callbacks[e].push(n)}clearWSEvents(){!this.ws||(clearInterval(this.heartbeatInterval),this.ws.onclose=()=>{},this.ws.onerror=()=>{},this.ws.onmessage=()=>{})}async connect(e,n=1){if(!(n>3))return this.params=e!=null?e:this.params,new Promise(t=>{this.clearWSEvents(),this.ws=new WebSocket(this.url),this.ws.onopen=()=>{t(),this.resetHeartbeatCounter(),this.send({type:"start",params:this.params})};let o=!1;const i=()=>{o||(o=!0)};this.ws.onclose=s=>{if(s.code===1006||!s.wasClean)return i();clearInterval(this.heartbeatInterval),this.onCloseCallbacks.forEach(d=>d())},this.ws.onerror=()=>i(),this.ws.onmessage=s=>{const d=JSON.parse(s.data);ee(this.callbacks,d)},this.heartbeatInterval=setInterval(()=>{if(!(!this.ws||this.ws.readyState!==this.ws.OPEN)){if(this.heartbeatCounter++,this.heartbeatCounter>3)return this.ws.onclose=()=>{},clearInterval(this.heartbeatInterval),i();this.send({type:"heartbeat"})}},2e3)}).catch(()=>{this.connect(this.params,n+1)})}onClose(e){this.onCloseCallbacks.push(e)}close(){if(!this.ws){console.warn("no websocket to close");return}this.clearWSEvents(),this.ws.close()}async send(e){if(!this.ws){console.warn("no websocket to send");return}Ye.includes(this.ws.readyState)&&await this.connect(),this.ws.send(JSON.stringify(e)),ee(this.callbacks,e)}};let V=S;l(V,"_instance");export{at as F,V as R};
//# sourceMappingURL=broker.352d6f95.js.map
