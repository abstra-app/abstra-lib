var ue=Object.defineProperty;var he=(o,e,t)=>e in o?ue(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var g=(o,e,t)=>(he(o,typeof e!="symbol"?e+"":e,t),t);import{E as w,d as fe,e3 as pe,f as H,h as ge,g as me,J as Ce,aj as ve,am as U,o as _,K as L,c as N,w as l,b as c,u as r,bE as _e,aP as k,az as h,eb as G,F as y,cs as ye,da as T,bM as S,a as Q,ec as Y,Q as we}from"./index.6d326114.js";import"./linters.993e3ea4.js";import{W as Me}from"./workspaces.7e1beae4.js";import{o as q}from"./omniChatStore.2c2f2b25.js";import{a as X}from"./asyncComputed.ac08d7c2.js";import{u as Ee}from"./polling.9a0b0237.js";import{b as be,a as ke}from"./validations.48fc00e4.js";import{G as Se}from"./PhFolder.vue.e2c83f1e.js";import{l as B,R as ee,e as F,M as P}from"./toggleHighContrast.16b05b95.js";import{A as Ie}from"./index.f4139f06.js";import{C as Oe}from"./Card.9b236a44.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[e]="fd7e6786-1365-48d4-86b3-d8eef7382219",o._sentryDebugIdIdentifier="sentry-dbid-fd7e6786-1365-48d4-86b3-d8eef7382219")}catch{}})();class j{static async getAutocomplete(e){try{return await(await fetch("/_editor/api/pysa/autocomplete",{headers:{"content-type":"application/json"},body:JSON.stringify(e),method:"POST"})).json()}catch{return[]}}static async getHelp(e){try{return await(await fetch("/_editor/api/pysa/help",{headers:{"content-type":"application/json"},body:JSON.stringify(e),method:"POST"})).json()}catch{return[]}}static async getLint(e){try{return await(await fetch("/_editor/api/pysa/lint",{headers:{"content-type":"application/json"},body:JSON.stringify(e),method:"POST"})).json()}catch{return[]}}}let R={};function De(o){return o in R?"\n\n```python\n"+o+" = "+R[o]+"\n```":""}function xe(o){switch(o){case"error":return P.Error;case"warning":return P.Warning;case"info":return P.Info;case"hint":return P.Hint;default:return P.Error}}B.registerHoverProvider("python",{async provideHover(o,e){const t=o.getWordAtPosition(e);return t?{contents:(await j.getHelp({code:o.getValue(),line:e.lineNumber,column:e.column})).map(d=>({value:d.docstring+De(d.name)})),range:new ee(e.lineNumber,t.startColumn,e.lineNumber,t.endColumn)}:null}});B.registerCompletionItemProvider("python",{async provideCompletionItems(o,e){const t=await j.getAutocomplete({code:o.getValue(),line:e.lineNumber,column:e.column-1}),i=o.getWordUntilPosition(e);return{suggestions:t.map(d=>({label:d.name,kind:B.CompletionItemKind.Function,documentation:d.documentation,insertText:d.name,insertTextRules:B.CompletionItemInsertTextRule.InsertAsSnippet,range:{startLineNumber:e.lineNumber,endLineNumber:e.lineNumber,startColumn:i.startColumn,endColumn:i.endColumn}}))}}});const Z=o=>{o.getLanguageId()==="python"&&j.getLint({code:o.getValue(),line:0,column:0}).then(e=>{F.setModelMarkers(o,o.getLanguageId(),e.map(t=>({startLineNumber:t.line,startColumn:t.column,endLineNumber:t.until_line,endColumn:t.until_column,message:t.message,severity:xe(t.severity)})))})},Ne=(o,e,t={})=>{var E;const i=F.create(o,{language:t.language||"python",value:e,minimap:{enabled:!1},readOnly:(E=t.readOnly)!=null?E:!1,contextmenu:!t.readOnly,automaticLayout:!t.readOnly,tabSize:4,fixedOverflowWidgets:!0,theme:t.theme?t.theme:"vs",fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:t.readOnly?0:5,scrollBeyondLastLine:!t.readOnly,renderLineHighlight:t.readOnly?"none":"all",scrollbar:{useShadows:!1,alwaysConsumeMouseWheel:!1}}),d=i.getContribution("editor.contrib.messageController");i.onDidAttemptReadOnlyEdit(()=>{d.showMessage("Cannot edit during preview execution",i.getPosition())});const f=i.createDecorationsCollection([]),W=(m,b)=>{f.set(m.map(u=>({range:new ee(u.lineno,1,u.lineno,1),options:{isWholeLine:!0,className:b}}))),R=m.reduce((u,O)=>({...u,...O.locals}),{})},A=(m,b)=>u=>{const O=u.filter(K=>K.filename.endsWith(b));W(O,m)},M=()=>{f.clear(),R={}},I=m=>{i.updateOptions({readOnly:m})};return Z(i.getModel()),i.onDidChangeModelContent(()=>{Z(i.getModel())}),{editor:i,highlight:A,clearHighlights:M,setReadOnly:I}},Pe=(o,e,t)=>{const i=F.createModel(e),d=F.createModel(t),f=F.createDiffEditor(o,{minimap:{enabled:!1},readOnly:!0,contextmenu:!1,automaticLayout:!0,renderWhitespace:"none",guides:{indentation:!1},fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:0,scrollBeyondLastLine:!1,renderLineHighlight:"none"});return f.setModel({original:i,modified:d}),{diffEditor:f}};class Fe{constructor(e,t,i="python"){g(this,"_script");g(this,"_localEditorCode");g(this,"_monacoEditor");g(this,"_diffEditor");g(this,"_viewMode");g(this,"_alertMessage");g(this,"_conflictingChanges");g(this,"_hasOutdatedCode");g(this,"_language");g(this,"_smartChatCode");this._localEditorCode=e,this._script=t,this._monacoEditor=null,this._diffEditor=null,this._viewMode=w("editor"),this._alertMessage=w(""),this._conflictingChanges=w(!1),this._hasOutdatedCode=w(!1),this._language=w(i),this._smartChatCode=w(null)}get alertMessage(){return this._alertMessage.value}set alertMessage(e){this._alertMessage.value=e}get conflictingChanges(){return this._conflictingChanges.value}set conflictingChanges(e){this._conflictingChanges.value=e}get viewMode(){return this._viewMode.value}set viewMode(e){this._viewMode.value=e}get abstraIDECode(){return this._script.codeContent}get localEditorCode(){return this._localEditorCode}set localEditorCode(e){this._localEditorCode=e}set monacoEditor(e){this._monacoEditor=e}set diffEditor(e){this._diffEditor=e}get smartChatCode(){return this._smartChatCode.value}set smartChatCode(e){this._smartChatCode.value=e}finishPreview(){var e;this._viewMode.value="editor",this._script.codeContent=this._localEditorCode,this._hasOutdatedCode.value&&((e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._hasOutdatedCode.value=!1),this._script.updateInitialState("code_content",this._localEditorCode),this.alertMessage=""}updateCodeWhileEditing(e){var d;const t=e!==this._localEditorCode;if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1;return}const i=!this._script.hasChanges("code_content");if(i){(d=this._monacoEditor)==null||d.setValue(e),this._script.codeContent=e,this._script.updateInitialState("code_content",e);return}if(!i&&t){this.alertMessage="You have conflicting changes with your local editor code",this.conflictingChanges=!0;return}}updateCodeWhileDiff(e){var t,i;if(!this._smartChatCode.value){if(e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1,this.viewMode="editor",this._localEditorCode=e;return}if(e!==this._localEditorCode){(i=(t=this._diffEditor)==null?void 0:t.getModel())==null||i.modified.setValue(e),this._localEditorCode=e;return}}}updateCodeWhilePreview(e){if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="";return}this._hasOutdatedCode.value=!0,this.alertMessage="The changes on your code will be shown after the preview stops running"}updateCode(e){switch(this._viewMode.value){case"editor":return this.updateCodeWhileEditing(e);case"diff":return this.updateCodeWhileDiff(e);case"preview":return this.updateCodeWhilePreview(e)}}keepAbstraIDECode(){var e;(e=this._monacoEditor)==null||e.setValue(this._script.codeContent),this._script.save("code_content"),this._script.updateInitialState("code_content",this._script.codeContent),this._localEditorCode=this._script.codeContent,this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}keepLocalEditor(){var e;(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}declineSmartChatSuggestion(){var e;(e=this._monacoEditor)==null||e.setValue(this._script.codeContent),this._script.updateInitialState("code_content",this._script.codeContent),this._smartChatCode.value=null,this._hasOutdatedCode.value=!1,this.alertMessage="",this.viewMode="editor",this._diffEditor=null}acceptSmartChatSuggestion(){var e,t,i,d,f;(t=this._monacoEditor)==null||t.setValue((e=this._smartChatCode.value)!=null?e:""),this._script.codeContent=(i=this._smartChatCode.value)!=null?i:"",this._script.save("code_content"),this._script.updateInitialState("code_content",(d=this._smartChatCode.value)!=null?d:""),this._localEditorCode=(f=this._smartChatCode.value)!=null?f:"",this._hasOutdatedCode.value=!1,this.alertMessage="",this.viewMode="editor",this._smartChatCode.value=null,this._diffEditor=null}}const We={class:"source-code-container"},Ae={class:"code-container"},Ve={key:0,class:"not-found-container"},He=fe({__name:"SourceCode",props:{script:{},workspace:{},language:{},hideHeader:{type:Boolean}},emits:["update-file"],setup(o,{expose:e,emit:t}){const i=o,d=pe(),f=async a=>{n.value.viewMode="diff",n.value.smartChatCode=a!=null?a:null,await U(),de()},W=H(null),A=H(null);let M,I,E,m;const{result:b}=X(()=>fetch("/_editor/api/workspace/root").then(a=>a.text())),u=H(i.script.file);ge(()=>i.script.file,()=>u.value=i.script.file);const{result:O,refetch:K}=X(()=>Me.checkFile(u.value)),te=()=>{D.value.valid?t("update-file",be(u.value)):t("update-file",u.value),K()},D=me(()=>{var s;const a=ke(u.value);return a.valid?((s=O.value)==null?void 0:s.exists)&&i.script.hasChanges("file")?{valid:!0,help:"This file already exists"}:i.script.hasChanges("file")?{valid:!0,help:"The original file will be renamed"}:a:a}),ie=()=>{d.push({name:"sourceCode"})},V=H(!1),n=w(null),ae=async()=>{var s;if(!i.script.file)return;const a=await i.workspace.readFile(i.script.file);if(a===null){V.value=!0;return}V.value=!1,(s=n.value)==null||s.updateCode(a)},{startPolling:oe,endPolling:se}=Ee({task:ae});Ce(()=>{re(),oe();const a=q.subscribe("replaceCode",({code:s})=>{n.value.alertMessage="Replace code from Smart Chat",f(s)});ve(()=>{q.unsubscribe(a),se()})});const ne=()=>{m(!0),n.value.viewMode="preview"},le=(a,s)=>{if(s)return E("error-line",i.script.file)(a);E("executing-line",i.script.file)(a)},re=async()=>{await U(),i.workspace.readFile(i.script.file).then(a=>{const s=a!=null?a:"";i.script.codeContent=s,i.script.updateInitialState("code_content",s),n.value=new Fe(s,i.script,i.language);const C=Ne(W.value,s,{language:i.language});I=C.clearHighlights,E=C.highlight,m=C.setReadOnly,M=C.editor,C.editor.onDidChangeModelContent(()=>{I()}),n.value.monacoEditor=M,M.onDidChangeModelContent(()=>{i.script.codeContent=M.getValue()})})},de=async()=>{var x;let a=(x=n.value)==null?void 0:x.smartChatCode;if(a||(a=await i.workspace.readFile(i.script.file)),!a)return;const s=i.script.codeContent,C=Pe(A.value,s,a);n.value.diffEditor=C.diffEditor},ce=()=>{var a;i.script.codeContent=(a=n.value.smartChatCode)!=null?a:"",n.value.acceptSmartChatSuggestion()},$=()=>{var a;I(),m(!1),(a=n.value)==null||a.finishPreview()};return e({startPreviewMode:ne,setHighlight:le,restartEditor:$,updateLocalEditorCode:a=>{n.value.localEditorCode=a,$()}}),(a,s)=>{var C,x,z,J;return _(),L("div",We,[a.hideHeader?y("",!0):(_(),N(r(T),{key:0,gap:"8",style:{width:"100%"}},{default:l(()=>[c(r(ye),{"validate-status":D.value.valid?"success":"error",help:D.value.valid?D.value.help:D.value.reason,class:"file-input"},{default:l(()=>[c(r(_e),{value:u.value,"onUpdate:value":s[0]||(s[0]=v=>u.value=v),autocomplete:"off",onChange:te},{addonBefore:l(()=>[r(b)?(_(),L("span",{key:0,class:"clickable",onClick:ie},[c(r(k),{placement:"bottomLeft","overlay-style":{maxWidth:"none"}},{title:l(()=>[h(G(r(b)),1)]),default:l(()=>[c(r(Se),{size:"22"})]),_:1})])):y("",!0)]),_:1},8,["value"])]),_:1},8,["validate-status","help"])]),_:1})),!a.hideHeader&&!!((C=n.value)!=null&&C.alertMessage)?(_(),N(r(Ie),{key:1,type:"warning","show-icon":""},{message:l(()=>{var v;return[h(G((v=n.value)==null?void 0:v.alertMessage),1)]}),action:l(()=>[n.value.conflictingChanges&&n.value.viewMode!=="diff"?(_(),N(r(T),{key:0,gap:"small"},{default:l(()=>[c(r(S),{type:"primary",onClick:s[1]||(s[1]=v=>f(void 0))},{default:l(()=>[h("Compare")]),_:1}),c(r(k),null,{title:l(()=>[h("Keep the local editor version")]),default:l(()=>[c(r(S),{onClick:s[2]||(s[2]=v=>{var p;return(p=n.value)==null?void 0:p.keepLocalEditor()})},{default:l(()=>[h("Discard")]),_:1})]),_:1})]),_:1})):y("",!0),n.value.conflictingChanges&&n.value.viewMode==="diff"?(_(),N(r(T),{key:1,gap:"small"},{default:l(()=>[c(r(k),null,{title:l(()=>[h("Keep your current changes")]),default:l(()=>[c(r(S),{onClick:s[3]||(s[3]=v=>{var p;return(p=n.value)==null?void 0:p.keepAbstraIDECode()})},{default:l(()=>[h("Keep left")]),_:1})]),_:1}),c(r(k),null,{title:l(()=>[h("Keep the local editor version")]),default:l(()=>[c(r(S),{onClick:s[4]||(s[4]=v=>{var p;return(p=n.value)==null?void 0:p.keepLocalEditor()})},{default:l(()=>[h("Keep right")]),_:1})]),_:1})]),_:1})):n.value.smartChatCode&&n.value.viewMode==="diff"?(_(),N(r(T),{key:2,gap:"small"},{default:l(()=>[c(r(k),null,{title:l(()=>[h("Keep your current changes")]),default:l(()=>[c(r(S),{onClick:s[5]||(s[5]=v=>{var p;return(p=n.value)==null?void 0:p.declineSmartChatSuggestion()})},{default:l(()=>[h("Decline")]),_:1})]),_:1}),c(r(k),null,{title:l(()=>[h("Keep the local editor version")]),default:l(()=>[c(r(S),{type:"primary",onClick:ce},{default:l(()=>[h(" Accept ")]),_:1})]),_:1})]),_:1})):y("",!0)]),_:1})):y("",!0),Q("div",Ae,[V.value?(_(),L("div",Ve,[c(r(Oe),null,{title:l(()=>[h("File not found")]),_:1})])):y("",!0),Q("div",{id:"code",ref_key:"codeComponent",ref:W,class:Y(["monaco-element",{hide:((x=n.value)==null?void 0:x.viewMode)==="diff",blur:V.value}])},null,2),((z=n.value)==null?void 0:z.viewMode)==="diff"?(_(),L("div",{key:1,id:"code",ref_key:"codeDiffComponent",ref:A,class:Y(["monaco-element",{hide:((J=n.value)==null?void 0:J.viewMode)!=="diff"}])},null,2)):y("",!0)])])}}});const qe=we(He,[["__scopeId","data-v-330a6c89"]]);export{qe as S};
//# sourceMappingURL=SourceCode.6c786b94.js.map
