import{k as M,A as ct,C as ut}from"./router.1a302c1f.js";import{d as W,at as z,c as j,o as g,ac as x,ae as dt,h as k,ew as gt,e as H,v as ft,r as I,al as L,eH as pt,w as F,a as S,b as v,aY as et,eB as at,ad as ht,t as T,u as d,dj as G,bV as mt,df as O,g as D,_ as ot,f as b,i as _,b0 as q,ez as yt,d6 as xt,cM as R}from"./jwt-decode.esm.a71c2b53.js";import{B as vt}from"./build.9da8b5b9.js";import{c as nt}from"./string.02a8158f.js";import"./tables.6e54b3c6.js";import{u as _t}from"./polling.4285408b.js";import{t as wt}from"./ant-design.a851ece1.js";import{I as tt}from"./PhCopy.vue.d88e6825.js";import{b as bt}from"./index.aaccb0f9.js";(function(){try{var n=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[t]="afc32315-86db-4329-9480-9f9ccdd6ce71",n._sentryDebugIdIdentifier="sentry-dbid-afc32315-86db-4329-9480-9f9ccdd6ce71")}catch{}})();const At=["width","height","fill","transform"],kt={key:0},Ht=H("path",{d:"M72,104a16,16,0,1,1,16,16A16,16,0,0,1,72,104Zm96,16a16,16,0,1,0-16-16A16,16,0,0,0,168,120Zm68-40V192a36,36,0,0,1-36,36H56a36,36,0,0,1-36-36V80A36,36,0,0,1,56,44h60V16a12,12,0,0,1,24,0V44h60A36,36,0,0,1,236,80Zm-24,0a12,12,0,0,0-12-12H56A12,12,0,0,0,44,80V192a12,12,0,0,0,12,12H200a12,12,0,0,0,12-12Zm-12,82a30,30,0,0,1-30,30H86a30,30,0,0,1,0-60h84A30,30,0,0,1,200,162Zm-80-6v12h16V156ZM86,168H96V156H86a6,6,0,0,0,0,12Zm90-6a6,6,0,0,0-6-6H160v12h10A6,6,0,0,0,176,162Z"},null,-1),St=[Ht],Zt={key:1},Ct=H("path",{d:"M200,56H56A24,24,0,0,0,32,80V192a24,24,0,0,0,24,24H200a24,24,0,0,0,24-24V80A24,24,0,0,0,200,56ZM164,184H92a20,20,0,0,1,0-40h72a20,20,0,0,1,0,40Z",opacity:"0.2"},null,-1),Vt=H("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Zm4,28H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24Z"},null,-1),It=[Ct,Vt],Et={key:2},Pt=H("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48ZM172,96a12,12,0,1,1-12,12A12,12,0,0,1,172,96ZM96,184H80a16,16,0,0,1,0-32H96ZM84,120a12,12,0,1,1,12-12A12,12,0,0,1,84,120Zm60,64H112V152h32Zm32,0H160V152h16a16,16,0,0,1,0,32Z"},null,-1),jt=[Pt],Tt={key:3},Dt=H("path",{d:"M200,50H134V16a6,6,0,0,0-12,0V50H56A30,30,0,0,0,26,80V192a30,30,0,0,0,30,30H200a30,30,0,0,0,30-30V80A30,30,0,0,0,200,50Zm18,142a18,18,0,0,1-18,18H56a18,18,0,0,1-18-18V80A18,18,0,0,1,56,62H200a18,18,0,0,1,18,18ZM74,108a10,10,0,1,1,10,10A10,10,0,0,1,74,108Zm88,0a10,10,0,1,1,10,10A10,10,0,0,1,162,108Zm2,30H92a26,26,0,0,0,0,52h72a26,26,0,0,0,0-52Zm-22,12v28H114V150ZM78,164a14,14,0,0,1,14-14h10v28H92A14,14,0,0,1,78,164Zm86,14H154V150h10a14,14,0,0,1,0,28Z"},null,-1),$t=[Dt],Mt={key:4},zt=H("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16Zm-52-56H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Z"},null,-1),Lt=[zt],Rt={key:5},Ot=H("path",{d:"M200,52H132V16a4,4,0,0,0-8,0V52H56A28,28,0,0,0,28,80V192a28,28,0,0,0,28,28H200a28,28,0,0,0,28-28V80A28,28,0,0,0,200,52Zm20,140a20,20,0,0,1-20,20H56a20,20,0,0,1-20-20V80A20,20,0,0,1,56,60H200a20,20,0,0,1,20,20ZM76,108a8,8,0,1,1,8,8A8,8,0,0,1,76,108Zm88,0a8,8,0,1,1,8,8A8,8,0,0,1,164,108Zm0,32H92a24,24,0,0,0,0,48h72a24,24,0,0,0,0-48Zm-20,8v32H112V148ZM76,164a16,16,0,0,1,16-16h12v32H92A16,16,0,0,1,76,164Zm88,16H152V148h12a16,16,0,0,1,0,32Z"},null,-1),Bt=[Ot],Nt={name:"PhRobot"},Ft=W({...Nt,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(n){const t=n,a=z("weight","regular"),i=z("size","1em"),f=z("color","currentColor"),o=z("mirrored",!1),l=j(()=>{var r;return(r=t.weight)!=null?r:a}),c=j(()=>{var r;return(r=t.size)!=null?r:i}),m=j(()=>{var r;return(r=t.color)!=null?r:f}),y=j(()=>t.mirrored!==void 0?t.mirrored?"scale(-1, 1)":void 0:o?"scale(-1, 1)":void 0);return(r,V)=>(g(),x("svg",gt({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:c.value,height:c.value,fill:m.value,transform:y.value},r.$attrs),[dt(r.$slots,"default"),l.value==="bold"?(g(),x("g",kt,St)):l.value==="duotone"?(g(),x("g",Zt,It)):l.value==="fill"?(g(),x("g",Et,jt)):l.value==="light"?(g(),x("g",Tt,$t)):l.value==="regular"?(g(),x("g",Mt,Lt)):l.value==="thin"?(g(),x("g",Rt,Bt)):k("",!0)],16,At))}}),qt=["running","lock-failed","failed","finished","abandoned"];class B{constructor(t){this.dto=t}static from(t){return new B(t)}get entries(){return this.dto.sort((t,a)=>t.sequence-a.sequence).filter(t=>t.event!=="form-message")}}class N{constructor(t){this.dto=t}static from(t){return new N(t)}get id(){return this.dto.id}get shortId(){return this.dto.id.slice(0,8)}get createdAt(){return new Date(this.dto.createdAt)}get updatedAt(){return new Date(this.dto.updatedAt)}get status(){return this.dto.status}get context(){return this.dto.context}get buildId(){var t;return(t=this.dto.buildId)!=null?t:""}get stageId(){return this.dto.stageId}get duration_seconds(){return this.status==="running"?"-":`${(this.updatedAt.getTime()-this.createdAt.getTime())/1e3} s`}get stageRunId(){return this.dto.stageRunId}get projectId(){return this.dto.projectId}}class ce{async list({projectId:t,...a}){var o,l;const i={...a,offset:(o=a.offset)==null?void 0:o.toString(),limit:(l=a.limit)==null?void 0:l.toString()};Object.keys(i).forEach(c=>i[c]===void 0&&delete i[c]);const f=await M.get(`projects/${t}/executions`,i);return{executions:f.executions.map(c=>N.from(c)),totalCount:f.totalCount}}async fetchLogs(t,a,i){const f={};(i==null?void 0:i.limit)!==void 0&&(f.limit=i.limit.toString()),(i==null?void 0:i.offset)!==void 0&&(f.offset=i.offset.toString());const o=Object.keys(f).length>0?`?${new URLSearchParams(f).toString()}`:"",l=await M.get(`projects/${t}/executions/${a}/logs${o}`);return{logs:B.from(l.logs),totalCount:l.totalCount}}async fetchThreadData(t,a){return(await M.get(`projects/${t}/executions/${a}/thread-data`)).response}async getExecutionTasks(t,a){return await M.get(`projects/${t}/executions/${a}/tasks`)}async fetchStages(){throw new Error("Method not implemented.")}}class ue{async list(t){var c,m;const a={...t,offset:(c=t.offset)==null?void 0:c.toString(),limit:(m=t.limit)==null?void 0:m.toString()};Object.keys(a).forEach(y=>a[y]===void 0&&delete a[y]);const i=Object.fromEntries(Object.entries(a!=null?a:{}).filter(([,y])=>y!=null)),f=Object.keys(i).length>0?`?${new URLSearchParams(i).toString()}`:"",l=await(await fetch(`/_editor/api/executions${f}`)).json();return{executions:l.executions.map(y=>N.from(y)),totalCount:l.totalCount}}async fetchLogs(t,a,i){const o=await(await fetch(`/_editor/api/logs/${a}`)).json();return{logs:B.from(o),totalCount:o.length}}async fetchThreadData(){return{}}async getExecutionTasks(t,a){return await(await fetch(`/_editor/api/executions/${a}/tasks`)).json()}async fetchStages(){return await(await fetch("/_editor/api/executions/stages")).json()}}const $=300,de=ft("logs",()=>{const n=I(null),t=I(null),a=I(""),i=I(!1),f=I(),o=L({openedExecutionIds:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],executionData:{}}),l=L({currentIndex:1,pageSize:10,totalCount:0}),c=L({dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0}),m=L({builds:[],stages:[],statuses:qt.map(e=>({label:nt(e),value:e}))}),y=_t({task:()=>Q(),interval:1e4}),r=async e=>{var u;n.value=e.executionRepository,t.value=e.buildRepository,a.value=e.projectId,i.value=(u=e.pool)!=null?u:!1,f.value=e.onFilterChange,Object.assign(c,e.filters||{}),Object.assign(l,e.pagination||{}),e.openedExecutionId&&(o.openedExecutionIds=[e.openedExecutionId]),await Promise.all([w(),J()]),U(),i.value&&y.startPolling()},V=()=>{y.endPolling()},w=async()=>{var e,u,s,p;if(!!n.value){o.loadingExecutions=!0;try{const{executions:h,totalCount:A}=await n.value.list({projectId:a.value,buildId:c.buildId,status:c.status,limit:l.pageSize,offset:(l.currentIndex-1)*l.pageSize,stageId:c.stageId,startDate:(u=(e=c.dateRange)==null?void 0:e[0])==null?void 0:u.toISOString(),endDate:(p=(s=c.dateRange)==null?void 0:s[1])==null?void 0:p.toISOString(),search:c.search});o.executions=h,l.totalCount=A}finally{o.loadingExecutions=!1}}},Z=async()=>{if(!t.value){m.builds=[];return}const u=(await t.value.list(a.value)).map(s=>({label:`[${s.id.slice(0,8)}] ${s.createdAt.toLocaleString()} ${s.latest?"(Latest)":""}`,value:s.id}));m.builds=u},E=async()=>{var p;if(!n.value)return;if(!t.value){const A=(await n.value.fetchStages()).map(C=>({label:C.title,value:C.id}));m.stages=A!=null?A:[];return}const e=(p=c.buildId)!=null?p:m.builds.length>0?m.builds[0].value:void 0;if(!e){console.warn("No buildId available for fetching stage options"),m.stages=[];return}const u=await vt.get(e),s=u==null?void 0:u.runtimes.map(h=>({label:h.title,value:h.id}));m.stages=s!=null?s:[]},J=async()=>{try{await Z(),await E()}catch(e){console.error("Error fetching options:",e)}},P=async(e,u)=>{if(!n.value)return;const s=o.executionData[e],p=u||{limit:$,offset:0},[h,A,C]=await Promise.all([n.value.fetchLogs(a.value,e,p),n.value.fetchThreadData(a.value,e),n.value.getExecutionTasks(a.value,e)]),lt={currentIndex:1,pageSize:$,totalCount:h.totalCount,loading:!1};o.executionData[e]={logs:h.logs,threadData:A,tasks:{triggerTask:C.triggerTask?{type:C.triggerTask.type,payload:C.triggerTask.payload}:null,sentTasks:C.sentTasks.map(K=>({type:K.type,payload:K.payload}))},logsPagination:(s==null?void 0:s.logsPagination)||lt},o.executionData[e].logsPagination&&(o.executionData[e].logsPagination.totalCount=h.totalCount,o.executionData[e].logsPagination.loading=!1)},U=()=>{o.openedExecutionIds.forEach(async e=>{o.executionData[e]||await P(e,{limit:$,offset:0})})},Q=async()=>{o.openedExecutionIds.map(e=>{const u=o.executions.find(p=>p.id===e);if(!u||u.status!=="running")return;const s=o.executionData[e];if(s!=null&&s.logsPagination){const{currentIndex:p,pageSize:h}=s.logsPagination,A=(p-1)*h;return P(e,{limit:h,offset:A})}else return P(e,{limit:$,offset:0})})},Y=()=>{o.waitingDebounce=!0,l.currentIndex=1,st(),f.value&&f.value(c)},st=pt.exports.debounce(async()=>{await w(),o.waitingDebounce=!1},500),it=async e=>{let u=o.executions;return e&&(u=u.filter(p=>p.stageId===e)),u.length===0?null:u.reduce((p,h)=>p.createdAt>h.createdAt?p:h).id},X=async(e,u)=>{const s=o.executionData[e];if(!(s!=null&&s.logsPagination))return;const{pageSize:p}=s.logsPagination;s.logsPagination.loading=!0,s.logsPagination.currentIndex=u;const h=(u-1)*p;await P(e,{limit:p,offset:h})},rt=(e,u)=>{const s=o.executionData[e];!(s!=null&&s.logsPagination)||(s.logsPagination.pageSize=u,s.logsPagination.currentIndex=1,X(e,1))};return F(()=>c.buildId,()=>{E()}),F(c,()=>{o.openedExecutionIds=[],Y()}),F([()=>l.currentIndex,()=>l.pageSize],()=>{o.openedExecutionIds=[],w()}),{state:j(()=>({currentPage:o,pagination:l,filters:c,filterOptions:m})),currentPage:o,pagination:l,filters:c,filterOptions:m,init:r,teardown:V,fetchPage:w,fetchBuildOptions:Z,fetchStageOptions:E,fetchOptions:J,fetchExecutionDetails:P,fetchEmptyLogs:U,refetch:Q,handleFilterChange:Y,getNewestExecutionId:it,fetchExecutionLogsPage:X,setExecutionLogsPageSize:rt,polling:y}}),Gt={key:0,class:"cli"},Wt={key:0},Jt=W({__name:"LogContainer",props:{logs:{},pagination:{}},emits:["page-change"],setup(n){return(t,a)=>(g(),S(d(G),{vertical:"",gap:"small"},{default:v(()=>[n.logs.entries.length?(g(),x("div",Gt,[(g(!0),x(et,null,at(n.logs.entries,i=>(g(),x("p",{key:i.createdAt,style:ht({margin:0,"white-space":"pre-wrap",color:i.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},[i.payload.text?(g(),x("span",Wt,T(i.payload.text.trim()),1)):k("",!0)],4))),128))])):k("",!0),n.pagination?(g(),S(d(G),{key:1,vertical:"",gap:"small",align:"end"},{default:v(()=>[n.pagination.totalCount>d($)?(g(),S(d(mt),{key:0,current:n.pagination.currentIndex,"page-size":n.pagination.pageSize,total:n.pagination.totalCount,"show-size-changer":!1,"show-quick-jumper":!1,size:"small",onChange:a[0]||(a[0]=i=>t.$emit("page-change",i))},null,8,["current","page-size","total"])):k("",!0)]),_:1})):n.logs.entries.length?k("",!0):(g(),S(d(O),{key:2,type:"secondary"},{default:v(()=>[...a[1]||(a[1]=[D("Empty",-1)])]),_:1}))]),_:1}))}});const ge=ot(Jt,[["__scopeId","data-v-ad519bef"]]),Ut={key:0},Qt=["onClick"],Yt=["onClick"],Xt=W({__name:"ExecutionContext",props:{data:{},showFixWithAi:{type:Boolean},isSmartChatIdle:{type:Boolean}},emits:["ask-ai"],setup(n,{emit:t}){const a=n,i=t,f=I(!1),o=r=>{if(r==="legacyThreadData")return _.translate("i18n_executioncontext_thread_data");const V=nt(r);return V.replace(/([A-Z])/g," $1").trim(),V},l=r=>r==null?!0:Array.isArray(r)?r.length===0:typeof r=="object"?Object.keys(r).length===0:!1,c=r=>{typeof r=="object"&&r!==null&&"payload"in r?(navigator.clipboard.writeText(JSON.stringify(r.payload)),R.success({content:_.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),R.error({content:_.translate("i18n_executioncontext_no_payload")}))},m=r=>{f.value=!0,r.stopPropagation(),a.isSmartChatIdle!==!1&&(i("ask-ai"),setTimeout(()=>{f.value=!1},1e3))},y=r=>{typeof r=="object"?(navigator.clipboard.writeText(JSON.stringify(r)),R.success({content:_.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),R.error({content:_.translate("i18n_executioncontext_failed_copy_request")}))};return(r,V)=>(g(),S(d(ut),{bordered:!1,style:{"background-color":"transparent",width:"100%"}},{default:v(()=>[b(d(ct),{key:"execution-context"},{header:v(()=>[b(d(G),{justify:"space-between"},{default:v(()=>[b(d(O),null,{default:v(()=>[D(T(d(_).translate("i18n_executioncontext_header")),1)]),_:1}),b(d(q),{title:n.isSmartChatIdle?"":d(_).translate("i18n_executioncontext_wait_or_stop"),placement:"left"},{default:v(()=>[n.showFixWithAi?(g(),x("div",{key:0,class:yt(["ask-to-ai",{disabled:!n.isSmartChatIdle||f.value}]),onClick:m},[D(T(d(_).translate("i18n_executioncontext_fix_with_ai"))+" ",1),b(d(Ft),{size:16})],2)):k("",!0)]),_:1},8,["title"])]),_:1})]),default:v(()=>[b(d(bt),{direction:"vertical",style:{"border-radius":"5px",padding:"10px",color:"#fff",width:"100%","font-family":"monospace","max-height":"600px",overflow:"auto",border:"1px solid #e8e8e8"}},{default:v(()=>[Object.keys(n.data).length?(g(!0),x(et,{key:1},at(Object.entries(n.data),([w,Z])=>(g(),x("div",{key:w,class:"tree"},[w!=="legacyThreadData"||!l(Z)?(g(),x("div",Ut,[b(d(O),{strong:""},{default:v(()=>[D(T(o(w)),1)]),_:2},1024),w==="request"?(g(),S(d(q),{key:0,title:d(_).translate("i18n_executioncontext_copy_request_tooltip")},{default:v(()=>[H("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:E=>y(Z)},[b(d(tt))],8,Qt)]),_:2},1032,["title"])):k("",!0),w==="triggerTask"?(g(),S(d(q),{key:1,title:d(_).translate("i18n_executioncontext_copy_payload_tooltip")},{default:v(()=>[H("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:E=>c(Z)},[b(d(tt))],8,Yt)]),_:2},1032,["title"])):k("",!0),b(d(xt),{"tree-data":d(wt)(Z),selectable:!1},null,8,["tree-data"])])):k("",!0)]))),128)):(g(),S(d(O),{key:0,type:"secondary"},{default:v(()=>[D(T(d(_).translate("i18n_executioncontext_empty")),1)]),_:1}))]),_:1})]),_:1})]),_:1}))}});const fe=ot(Xt,[["__scopeId","data-v-f7630ec7"]]);export{fe as E,ge as L,ce as R,ue as a,de as u};
//# sourceMappingURL=ExecutionContext.76941819.js.map
