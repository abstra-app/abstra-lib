var ze=Object.defineProperty;var Be=(s,e,t)=>e in s?ze(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var D=(s,e,t)=>(Be(s,typeof e!="symbol"?e+"":e,t),t);import{d as Q,H as g,b as m,ev as _,f as h,u as o,eH as R,ex as N,a$ as U,eC as B,e as x,eD as A,eE as Qe,eF as We,v as W,r as K,F as Se,eM as Ye,eA as Je,eL as je,o as De,L as Ze,c as v,w as n,bT as qe,bw as Ge,bu as z,cF as H,bO as q,b3 as Ne,ar as S,eI as Xe,ez as Me,ew as oe,cE as et,ae as tt,I as st,cB as at}from"./outputWidgets.bb2f46e4.js";import{w as re,s as ue}from"./metadata.9823de2d.js";import{x as it,A as ot,B as nt,e as xe}from"./icons.94ad51fe.js";import"./schema.e8bbb9fb.js";import{W as Pe}from"./workspaces.18464cbe.js";import{v as rt,e as lt,c as ut,d as dt,a as ct,n as ht}from"./validations.2566ac57.js";import{B as mt}from"./index.c46a375d.js";import{A as Z}from"./index.77677488.js";import{A as I}from"./Text.3cea9169.js";import{A as de}from"./FormItem.744edb5b.js";import{A as ke}from"./Link.b478c0f2.js";import{C as ce}from"./Card.37a856a7.js";import"./index.cf4c23b9.js";import"./runnerData.94af0e51.js";import"./url.1b83203f.js";import"./record.dd66f38b.js";import"./pubsub.9e4f8bfd.js";import"./string.22481e13.js";import"./isNumeric.75337b1e.js";import"./Base.3e5c9785.js";import"./hasIn.9a8a8af5.js";import"./TabPane.cc681b73.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[e]="a9387d9e-8615-4bf6-83a4-9cfa800d09fd",s._sentryDebugIdIdentifier="sentry-dbid-a9387d9e-8615-4bf6-83a4-9cfa800d09fd")}catch{}})();const Re=s=>(Qe("data-v-fd735e5b"),s=s(),We(),s),pt={class:"empty-hint"},gt={key:0,class:"drag-hint"},St=Re(()=>x("div",{class:"title"},"Start here",-1)),ft={key:1,class:"drop-hint"},yt=Re(()=>x("div",{class:"title"},"Drop here",-1)),vt={key:2,class:"stages-hint"},It={class:"header"},_t={class:"title"},Tt={class:"description"},wt=Q({__name:"EmptyHint",props:{gui:{}},setup(s){const e=s,t=g(()=>e.gui.model.getState().stages.length===0&&e.gui.mouseState.state!=="ADDING_NEW_STAGES"),a=g(()=>e.gui.model.getState().stages.length===0&&e.gui.mouseState.state==="ADDING_NEW_STAGES");return(i,d)=>(m(),_("div",pt,[t.value?(m(),_("div",gt,[St,h(R,{path:o(it),class:"arrow"},null,8,["path"])])):N("",!0),a.value?(m(),_("div",ft,[yt,h(R,{path:o(ot),class:"arrow"},null,8,["path"])])):N("",!0),t.value?(m(),_("div",vt,[(m(!0),_(U,null,B(o(re).stages,r=>(m(),_("div",{key:r.key,class:"stage-hint"},[x("div",It,[h(R,{path:r.icon},null,8,["path"]),x("span",_t,A(r.title),1)]),x("div",Tt,A(r.description),1)]))),128))])):N("",!0)]))}});const Et=W(wt,[["__scopeId","data-v-fd735e5b"]]);function Nt(s){return At(s.p1,s.p2)}function O(s,e){return{dx:e.x-s.x,dy:e.y-s.y,referential:s.referential}}function X(s,e){return{referential:s.referential,x:s.x+e.dx,y:s.y+e.dy}}function xt(s,e){return{referential:s.referential,dx:s.dx*e,dy:s.dy*e}}function ee(s,e,t){const{x:a,y:i,width:d,height:r}=t,{dx:c,dy:l}=e,{x:p,y:f}=s,P=(a-p)/c,b=(a+d-p)/c,$=(i-f)/l,F=(i+r-f)/l,G=Math.max(Math.min(P,b),Math.min($,F));return{x:p+G*c,y:f+G*l,referential:s.referential}}function Pt(s,e){const t=pe(s),a=pe(e),i=ee(a,O(a,t),s),d=ee(t,O(t,a),e);return{p1:i,p2:d}}function kt(s,e,t=!1){return t?e.x<=s.x&&e.x+e.width>=s.x&&e.y<=s.y&&e.y+e.height>=s.y:e.x<s.x&&e.x+e.width>s.x&&e.y<s.y&&e.y+e.height>s.y}function pe(s){return{x:s.x+s.width/2,y:s.y+s.height/2,referential:s.referential}}const ge=s=>s.reduce((e,t)=>{const a=e?Math.min(e.x,t.x):t.x,i=e?Math.min(e.y,t.y):t.y,d=e?Math.max(e.x+e.width,t.x+t.width):t.x+t.width,r=e?Math.max(e.y+e.height,t.y+t.height):t.y+t.height;return{x:a,y:i,width:d-a,height:r-i,referential:t.referential}},null);function At(s,e){return Math.sqrt((s.x-e.x)**2+(s.y-e.y)**2)}function Ct(s,e){const{p1:t,p2:a}=s,i=Math.atan2(a.y-t.y,a.x-t.x),d=e*Math.sin(i),c={dx:e*Math.cos(i),dy:d,referential:t.referential},l=X(t,c),p=X(a,xt(c,-1));return{p1:l,p2:p}}function Ae(s,e){return{referential:s.referential,x:s.x-e,y:s.y-e,width:s.width+2*e,height:s.height+2*e}}const ae={left:100,right:100,top:100,bottom:100},Ce={width:600,height:600};class fe{constructor(e){D(this,"_state");D(this,"projectedElement");this._state=K({x:0,y:0,zoom:1}),this.projectedElement=e}get x(){return this._state.value.x}set x(e){if(Number.isNaN(e))throw new Error("x is NaN");this._state.value.x=e}get y(){return this._state.value.y}set y(e){if(Number.isNaN(e))throw new Error("y is NaN");this._state.value.y=e}static create(e){return new fe(e)}get zoom(){return this._state.value.zoom}set zoom(e){if(e<=0)throw new Error("Zoom must be positive");this._state.value.zoom=e}fit(e){const t={x:e.x+e.width/2,y:e.y+e.height/2,referential:"world"},a=this.screenRect2world(this.canvasRect);this.x=t.x-a.width/2,this.y=t.y-a.height/2,this.zoomIn(Math.min((this.canvasRect.width-ae.left-ae.right)/Math.max(Ce.width,e.width),(this.canvasRect.height-ae.top-ae.bottom)/Math.max(Ce.height,e.height))/this.zoom,this.worldPoint2screen(t))}screenPoint2world(e){return{x:e.x/this.zoom+this.x,y:e.y/this.zoom+this.y,referential:"world"}}worldPoint2screen(e){return{x:(e.x-this.x)*this.zoom,y:(e.y-this.y)*this.zoom,referential:"screen"}}screenDelta2world(e){return{dx:e.dx/this.zoom,dy:e.dy/this.zoom,referential:"world"}}worldDelta2screen(e){return{dx:e.dx*this.zoom,dy:e.dy*this.zoom,referential:"screen"}}screenRect2world(e){const t=this.screenPoint2world({x:e.x,y:e.y,referential:e.referential}),a=this.screenPoint2world({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:a.x-t.x,height:a.y-t.y,referential:t.referential}}worldRect2screen(e){const t=this.worldPoint2screen({x:e.x,y:e.y,referential:e.referential}),a=this.worldPoint2screen({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:a.x-t.x,height:a.y-t.y,referential:t.referential}}zoomIn(e,t){const a=this.screenPoint2world(t);this.zoom*=e;const i=this.worldPoint2screen(a),d=O(t,i),r=this.screenDelta2world({dx:d.dx,dy:d.dy,referential:"screen"});this.x+=r.dx,this.y+=r.dy}translate(e){this.x+=e.dx,this.y+=e.dy}get canvasRect(){if(!this.projectedElement)throw new Error("No canvas element");const e=this.projectedElement.getBoundingClientRect();return{x:e.x,y:e.y,width:e.width,height:e.height,referential:"screen"}}}class ye{static get isMac(){return navigator.userAgent.includes("Mac OS X")}static get buildPlatform(){return{}.CURRENT_PLATFORM||"web"}}const he=s=>ye.isMac&&s.ctrlKey,L=s=>ye.isMac?s.metaKey:s.ctrlKey,Oe=s=>s.altKey,V=s=>s.shiftKey,me={alt:Oe,"arrow-up":s=>s.code==="ArrowUp","arrow-down":s=>s.code==="ArrowDown","arrow-left":s=>s.code==="ArrowLeft","arrow-right":s=>s.code==="ArrowRight",ctrl:L,delete:s=>ye.isMac?s.code==="Backspace":s.code==="Delete",enter:s=>s.code==="Enter",escape:s=>s.code==="Escape",shift:V,space:s=>s.code==="Space",a:s=>s.code==="KeyA",b:s=>s.code==="KeyB",c:s=>s.code==="KeyC",d:s=>s.code==="KeyD",f:s=>s.code==="KeyF",g:s=>s.code==="KeyG",h:s=>s.code==="KeyH",k:s=>s.code==="KeyK",p:s=>s.code==="KeyP",v:s=>s.code==="KeyV",x:s=>s.code==="KeyX",z:s=>s.code==="KeyZ",0:s=>s.code==="Digit0","[":s=>s.code==="BracketLeft","]":s=>s.code==="BracketRight"};class Dt{constructor(e){D(this,"pressedKeys");D(this,"evt");this.evt=e,this.pressedKeys={};const t=a=>i=>{Object.keys(me).forEach(d=>{me[d](i)&&this.setPressed(d,a)})};this.evt||(window.addEventListener("keydown",t(!0)),window.addEventListener("keyup",t(!1)))}setPressed(e,t){this.pressedKeys[e]=t}isPressed(e){var t;return this.evt?me[e](this.evt):(t=this.pressedKeys[e])!=null?t:!1}}new Dt;class Gt{constructor(e){D(this,"selected");this.model=e,this.selected=Se([])}deselect(e){this.selected.value=this.selected.value.filter(t=>t.type==="stage"?!e.includes(t.stage.id):!e.includes(t.transition.id))}select(e,t=!1){t||(this.selected.value=[]),e.forEach(a=>{const i=this.model.getStage(a);i&&(this.selected.value=[...this.selected.value,{type:"stage",stage:i}]);const d=this.model.getTransition(a);if(d&&(this.selected.value=[...this.selected.value,{type:"transition",transition:d}]),!i&&!d)throw new Error(`Could not find stage or transition with id ${a}`)})}clear(){this.selected.value=[]}selectedStages(){return this.selected.value.map(e=>e.type==="stage"?this.model.getStage(e.stage.id):null).filter(Boolean)}selectedTransitions(){return this.selected.value.map(e=>e.type==="transition"?this.model.getTransition(e.transition.id):null).filter(Boolean)}selectedIds(){return this.selected.value.map(e=>e.type==="stage"?e.stage.id:e.transition.id)}has(e){return this.selected.value.some(t=>t.type==="stage"?t.stage.id===e.id:t.transition.id===e.id)}isEmpty(){return this.selected.value.length===0}selectAllStages(){this.select(this.model.getState().stages.map(e=>e.id))}}function be(s,e,t,a={}){s.strokeStyle=a.color||"black",s.lineWidth=4,s.lineJoin="round",s.lineCap="round";const i=Math.atan2(e.p2.y-e.p1.y,e.p2.x-e.p1.x);s.beginPath(),s.moveTo(e.p1.x,e.p1.y),s.lineTo(e.p2.x,e.p2.y),s.moveTo(e.p2.x-t*Math.cos(i-Math.PI/6),e.p2.y-t*Math.sin(i-Math.PI/6)),s.lineTo(e.p2.x,e.p2.y),s.lineTo(e.p2.x-t*Math.cos(i+Math.PI/6),e.p2.y-t*Math.sin(i+Math.PI/6)),s.stroke()}const Ke="#ababab",ve="#e55b70",ie=15;function ne(s,e){const t=s.getStageRect(e.id);return t?{x:t.x+t.width/2,y:t.y+t.height/2,referential:"screen"}:s.camera.worldPoint2screen({...e.position,referential:"world"})}function te(s,e){const t=s.getStageRect(e.id);if(t)return t;{const a=ne(s,e);return{x:a.x-100/2,y:a.y-100/2,width:100,height:100,referential:"screen"}}}function Ie(s,e){const t=s.model.getStage(e.sourceStageId),a=s.model.getStage(e.targetStageId);if(!t)throw new Error(`Source node ${e.sourceStageId} not found`);if(!a)throw new Error(`Target node ${e.targetStageId} not found`);const i=ne(s,t),d=ne(s,a),r=ee(i,O(i,d),te(s,a));return{p1:ee(r,O(r,i),te(s,t)),p2:r}}function Mt(s,e){const t=s.model.getTransition(e);if(!t)throw new Error(`Transition ${e} not found`);const a=Ie(s,t);return{x:Math.min(a.p1.x,a.p2.x),y:Math.min(a.p1.y,a.p2.y),width:Math.abs(a.p1.x-a.p2.x),height:Math.abs(a.p1.y-a.p2.y),referential:"screen"}}function Rt(s,e){const t=s.selection.has(e),a=10,i=s.model.getStage(e.sourceStageId),d=s.model.getStage(e.targetStageId);if(!i)throw new Error(`Source node ${e.sourceStageId} not found`);if(!d)throw new Error(`Target node ${e.targetStageId} not found`);const r=Ae(te(s,i),ie),c=Ae(te(s,d),ie),l=Pt(r,c);Nt(l)<2*ie||be(s.ctx,l,a,{color:t?ve:Ke})}function Ot(s,e){const t=Ie(s,e);return{x:(t.p1.x+t.p2.x)/2,y:(t.p1.y+t.p2.y)/2,referential:"screen"}}function bt(s){if(s.mouseState.state!=="ADDING_TRANSITION")throw new Error("Invalid state");for(const e of s.selection.selectedStages())if(s.mouseState.snappedTarget)$e(s,{id:"",sourceStageId:e.id,targetStageId:s.mouseState.snappedTarget.id,props:{conditionValue:null}});else{const t=ne(s,e),a=ee(s.mouseState.mousePos,O(s.mouseState.mousePos,t),te(s,e)),i=s.mouseState.mousePos,r=Ct({p1:a,p2:i},ie);be(s.ctx,r,12,{color:Ke})}}function $e(s,e){const t=s.model.getStage(e.sourceStageId),a=s.model.getStage(e.targetStageId);if(!t)throw new Error(`Source node ${e.sourceStageId} not found`);if(!a)throw new Error(`Target node ${e.targetStageId} not found`);Rt(s,e);const i=s.getTransitionRect(e.id);i&&s.ctx.clearRect(i.x,i.y,i.width,i.height)}function Kt(s,e){const t=Ie(s,e);return{x:(t.p1.x+t.p2.x)/2,y:(t.p1.y+t.p2.y)/2,referential:"screen"}}function $t(s,e){var i;const t=s.model.getStage(e.sourceStageId);if(!t)throw new Error(`Source node ${e.sourceStageId} not found`);const a=t.type;if(!a.includes("conditions")&&!a.includes("iterators"))throw new Error("Source node is not a flow controller");return(i=t.props)==null?void 0:i.variableName}function Ht(s,e){const t={...e.position,referential:"world"},a=s.camera.worldPoint2screen(t);return s.mouseState.state==="MOVING"&&s.selection.has(e)?X(a,O(s.mouseState.initialMousePos,s.mouseState.mousePos)):a}function Ft(s,e,t){const a=s.getStageRect(e.id);return a?kt(t,a):!1}class _e{constructor(e,t){D(this,"_mouseState");D(this,"selection");D(this,"canvas");D(this,"ctx");D(this,"camera");D(this,"model");this.canvas=e,this.model=t,this.selection=new Gt(t),this.camera=fe.create(e),this._mouseState=Se({state:"IDLE",mousePos:{x:0,y:0,referential:"screen"}});const a=e.getContext("2d");if(!a)throw new Error("Unable to get canvas context");this.ctx=a}static create(e,t){const a=new _e(e,t);return a.init(),a}get mouseState(){return this._mouseState.value}set mouseState(e){this._mouseState.value=e}async deleteSelection(){this.model.delete(this.selection.selectedIds()),this.clearSelection(),this.goToIdle()}fixSize(){const{width:e,height:t}=this.canvas.getBoundingClientRect();this.canvas.width=e*devicePixelRatio,this.canvas.height=t*devicePixelRatio,this.ctx.scale(devicePixelRatio,devicePixelRatio)}computeCursor(){switch(this.mouseState.state){case"HOVERING_STAGE":this.canvas.style.cursor="pointer";break;case"HOVERING_TRANSITION":this.canvas.style.cursor="pointer";break;case"JUST_CLICKED_STAGE":this.canvas.style.cursor="default";break;case"JUST_CLICKED_TRANSITION":this.canvas.style.cursor="default";break;case"MOVING":this.canvas.style.cursor="move";break;case"PANNING":this.canvas.style.cursor="grabbing";break;case"ADDING_TRANSITION":this.canvas.style.cursor="crosshair";break;case"IDLE":default:this.canvas.style.cursor="grab"}}computePan(e){if(this.mouseState.state!=="PANNING")throw new Error(`Invalid state ${this.mouseState} on computePan`);const t=O(e,this.mouseState.mousePos),a=this.camera.screenDelta2world(t);this.camera.translate(a),this.mouseState={state:"PANNING",initialMousePos:this.mouseState.initialMousePos,mousePos:e}}setUpCanvasKeyDown(){let e=null;addEventListener("mousemove",t=>e=t),this.canvas.addEventListener("keydown",t=>{if(!!e)if(t.key==="f"||t.key==="F")this.dragstart("forms",e);else if(t.key==="h"||t.key==="H")this.dragstart("hooks",e);else if(t.key==="j"||t.key==="J")this.dragstart("jobs",e);else if(t.key==="c"||t.key==="C")this.dragstart("conditions",e);else if(t.key==="i"||t.key==="I")this.dragstart("iterators",e);else if(t.key==="s"||t.key==="S"){if(L(t))return;this.dragstart("scripts",e)}else(t.key==="z"||t.key==="Z")&&L(t)?(V(t)?this.model.history.redo():this.model.history.undo(),t.preventDefault()):(t.key==="a"||t.key==="A")&&L(t)?(this.selection.selectAllStages(),t.preventDefault()):(t.key==="Delete"||t.key==="Backspace")&&this.deleteSelection()})}setupMousemove(){const e=t=>{const a=this.getScreenPointerFromEvent(t);this.mouseState.state==="PANNING"?this.computePan(a):this.mouseState.state==="JUST_CLICKED_STAGE"?this.computeStartMoving(a,Oe(t),this.mouseState.stage):this.mouseState.state==="MOVING"?this.computeKeepMoving(a):this.mouseState.state==="ADDING_TRANSITION"?this.computeKeepLinking(a):this.mouseState.state==="ADDING_NEW_STAGES"&&this.computeKeepAdding(a),this.computeCursor()};addEventListener("mousemove",e)}setupMouseup(){const e=()=>{this.computeMouseRelease(),this.computeCursor()};addEventListener("mouseup",e)}computeMouseRelease(){this.mouseState.state!=="CHANGING_TRANSITION_TYPE"&&(this.mouseState.state==="PANNING"&&this.goToIdle(),this.mouseState.state==="MOVING"&&!this.mouseState.duplicating&&this.computeFinishMoving(),this.mouseState.state==="MOVING"&&this.mouseState.duplicating&&this.computeFinishDuplicating(),this.mouseState.state==="JUST_CLICKED_STAGE"&&this.computeStartHoveringStage(this.mouseState.stage))}setupDragover(){const e=t=>{if(t.preventDefault(),this.mouseState.state!=="ADDING_NEW_STAGES")return;const a=this.getScreenPointerFromEvent(t);this.computeKeepAdding(a)};this.canvas.addEventListener("dragover",e)}setupDrop(){const e=t=>{t.stopPropagation();const a=this.getScreenPointerFromEvent(t);this.computeFinishAdding(a)};this.canvas.addEventListener("drop",e)}setupWheel(){var t;const e=a=>{if(!this.camera)return;const i=this.getScreenPointerFromEvent(a);if(L(a)||he(a))this.computeZoomIn(i,a.deltaY>0?.9:1.1),a.preventDefault();else{const d=V(a)?{dx:a.deltaY,dy:0}:{dx:a.deltaX,dy:a.deltaY},r=this.camera.screenDelta2world({dx:d.dx,dy:d.dy,referential:"screen"});this.camera.translate(r)}a.stopPropagation()};(t=this.canvas.parentElement)==null||t.addEventListener("wheel",e)}setupMousedown(){const e=t=>{const a=this.getScreenPointerFromEvent(t);this.computeStartClicking(a)};this.canvas.addEventListener("mousedown",e)}computeZoomIn(e,t){this.camera.zoomIn(t,e)}computeStartMoving(e,t,a){if(this.mouseState.state!=="JUST_CLICKED_STAGE")throw new Error(`Invalid state ${this.mouseState.state} on computeStartMoving`);this.mouseState={state:"MOVING",duplicating:t,initialMousePos:this.mouseState.mousePos,mousePos:e,pivot:a}}computeKeepMoving(e){if(this.mouseState.state!=="MOVING")throw new Error(`Invalid state ${this.mouseState.state} on computeKeepMoving`);const t=this.mouseState.duplicating;this.mouseState={state:"MOVING",duplicating:t,initialMousePos:this.mouseState.initialMousePos,mousePos:e,pivot:this.mouseState.pivot}}computeFinishMoving(){if(this.mouseState.state!=="MOVING")throw new Error(`Invalid state ${this.mouseState.state} on computeFinishMoving`);const e=this.camera.screenPoint2world(this.mouseState.initialMousePos),t=this.camera.screenPoint2world(this.mouseState.mousePos),a=O(e,t);this.model.move(this.selection.selectedStages().map(d=>({id:d.id,position:X({...d.position,referential:"world"},a)})));const i=this.mouseState.pivot;this.goToIdle(),i&&this.computeStartHoveringStage(i)}createTransition(){if(this.mouseState.state!=="IDLE"&&this.mouseState.state!=="HOVERING_STAGE")throw new Error(`Invalid state ${this.mouseState.state} on createTransition`);this.mouseState={state:"ADDING_TRANSITION",mousePos:this.mouseState.mousePos,initialMousePos:this.mouseState.mousePos,snappedTarget:null}}computeKeepLinking(e){if(this.mouseState.state!=="ADDING_TRANSITION")throw new Error(`Invalid state ${this.mouseState.state} on computeKeepLinking`);const t=this.model.getState().stages.find(a=>Ft(this,a,e));t?this.mouseState={state:"ADDING_TRANSITION",initialMousePos:this.mouseState.initialMousePos,mousePos:e,snappedTarget:t}:this.mouseState={state:"ADDING_TRANSITION",initialMousePos:this.mouseState.initialMousePos,mousePos:e,snappedTarget:null}}computeFinishLinking(){if(this.mouseState.state!=="ADDING_TRANSITION"||!this.mouseState.snappedTarget)throw new Error(`Invalid state ${this.mouseState.state} on computeFinishLinking`);const e=this.mouseState.snappedTarget,t=this.selection.selectedStages().map(a=>({sourceStageId:a.id,targetStageId:e.id}));this.model.addTransitions(t),this.selection.select([this.mouseState.snappedTarget.id]),this.goToIdle(),this.computeStartHoveringStage(e)}duplicateSelection(){if(this.mouseState.state!=="HOVERING_STAGE"&&this.mouseState.state!=="HOVERING_TRANSITION"&&this.mouseState.state!=="IDLE")throw new Error(`Invalid state ${this.mouseState.state} on duplicateSelection`);const e=this.model.duplicateStages([...this.selection.selectedStages()]),t=pe(ge(e.stages.map(i=>({x:i.position.x,y:i.position.y,width:1,height:1,referential:"world"})))),a=this.camera.worldPoint2screen(t);return this.mouseState={state:"MOVING",duplicating:!0,initialMousePos:a,mousePos:this.mouseState.mousePos},e}duplicateThenSelect(){const t=this.duplicateSelection().stages.map(a=>a.id);this.selection.select(t)}computeFinishDuplicating(){if(this.mouseState.state!=="MOVING"||!this.mouseState.duplicating)throw new Error(`Invalid state ${this.mouseState.state} on computeFinishDuplicating`);const e=this.camera.screenPoint2world(this.mouseState.initialMousePos),t=this.camera.screenPoint2world(this.mouseState.mousePos),a=O(e,t);this.model.move(this.selection.selectedStages().map(i=>({id:i.id,position:X({...i.position,referential:"world"},a)}))),this.goToIdle()}computeKeepAdding(e){if(this.mouseState.state!=="ADDING_NEW_STAGES")throw new Error(`Invalid state ${this.mouseState.state} on computeKeepAdding`);this.mouseState={state:"ADDING_NEW_STAGES",mousePos:e,stages:this.mouseState.stages.map(t=>({...t,position:this.camera.screenPoint2world(e)}))}}computeFinishAdding(e){if(this.mouseState.state!=="ADDING_NEW_STAGES")return;this.computeKeepAdding(e);const t=this.model.addStages(this.mouseState.stages);this.selection.select(t.map(a=>a.id)),this.goToIdle()}getScreenPointerFromEvent(e){const t=this.canvas.getBoundingClientRect();return{x:e.pageX-t.x,y:e.pageY-t.y,referential:"screen"}}computeStartClicking(e){this.mouseState.state==="MOVING"&&this.mouseState.duplicating||(this.mouseState.state==="ADDING_NEW_STAGES"?this.computeFinishAdding(e):this.mouseState.state==="STAGE_QUICK_EDIT"?(this.model.updateStageTitle(this.mouseState.stage.id,this.mouseState.stage.title),this.model.updateStageProps(this.mouseState.stage.id,this.mouseState.draftProps),this.goToIdle()):this.mouseState.state==="CHANGING_TRANSITION_TYPE"?this.model.updateTransitionType(this.mouseState.transition.id,this.mouseState.newType):this.mouseState.state==="TRANSITION_QUICK_EDIT"&&this.model.updateTransitionProps(this.mouseState.transition.id,this.mouseState.draftProps),this.clearSelection(),this.mouseState={state:"PANNING",initialMousePos:e,mousePos:e})}stageMouseDown(e,t){if(this.mouseState.state==="HOVERING_STAGE"){if(this.selection.has(t)||this.selection.select([t.id],V(e)),e.button!==0)return;this.mouseState={state:"JUST_CLICKED_STAGE",mousePos:this.getScreenPointerFromEvent(e),stage:t};return}if(this.mouseState.state==="ADDING_TRANSITION"){this.computeFinishLinking();return}if(this.mouseState.state==="STAGE_QUICK_EDIT"){if(this.mouseState.stage.id===t.id)return;this.saveChangesOnChangingEditingEntity(),this.selection.select([t.id],V(e)),this.mouseState={state:"JUST_CLICKED_STAGE",mousePos:this.getScreenPointerFromEvent(e),stage:t}}(this.mouseState.state==="TRANSITION_QUICK_EDIT"||this.mouseState.state==="CHANGING_TRANSITION_TYPE")&&(this.saveChangesOnChangingEditingEntity(),this.selection.select([t.id],V(e)),this.mouseState={state:"JUST_CLICKED_STAGE",mousePos:this.getScreenPointerFromEvent(e),stage:t})}computeStartHoveringStage(e){this.mouseState.state!=="IDLE"&&this.mouseState.state!=="JUST_CLICKED_STAGE"||(this.mouseState={state:"HOVERING_STAGE",stage:e,mousePos:this.mouseState.mousePos})}computeFinishHoveringStage(e){this.mouseState.state==="HOVERING_STAGE"&&this.mouseState.stage.id===e.id&&this.goToIdle()}saveChangesOnChangingEditingEntity(){this.mouseState.state==="STAGE_QUICK_EDIT"&&(this.model.updateStageTitle(this.mouseState.stage.id,this.mouseState.stage.title),this.model.updateStageProps(this.mouseState.stage.id,this.mouseState.draftProps),this.goToIdle()),this.mouseState.state==="TRANSITION_QUICK_EDIT"&&(this.model.updateTransitionProps(this.mouseState.transition.id,this.mouseState.draftProps),this.goToIdle()),this.mouseState.state==="CHANGING_TRANSITION_TYPE"&&(this.model.updateTransitionType(this.mouseState.transition.id,this.mouseState.newType),this.goToIdle())}computeStartEditingStage(e){var t,a,i;if(!(this.mouseState.state==="STAGE_QUICK_EDIT"&&this.mouseState.stage.id===e.id)){if(this.saveChangesOnChangingEditingEntity(),this.mouseState.state!=="IDLE"&&this.mouseState.state!=="HOVERING_STAGE")throw new Error(`Invalid state ${this.mouseState.state} on computeStartEditingStage`);this.mouseState={state:"STAGE_QUICK_EDIT",stage:e,mousePos:this.mouseState.mousePos,draftProps:{path:(t=e.props)==null?void 0:t.path,filename:(a=e.props)==null?void 0:a.filename,variableName:(i=e.props)==null?void 0:i.variableName}},this.clearSelection()}}computeStartEditingStageSelection(){if(this.selection.selectedStages().length!==1)return;const e=this.selection.selectedStages()[0];this.computeStartEditingStage(e)}computeStartChangingTransitionSelection(){if(this.selection.selectedTransitions().length!==1)return;const e=this.selection.selectedTransitions()[0];this.computeStartChangingTransition(e)}computeChangeStage(e,t){if(this.mouseState.state!=="STAGE_QUICK_EDIT")throw new Error(`Invalid state ${this.mouseState.state} on computeChangeStage`);e==="title"?this.mouseState.stage.title=t:this.mouseState.draftProps={...this.mouseState.draftProps,[e]:t}}computeChangeStageType(e){if(this.mouseState.state!=="STAGE_QUICK_EDIT")throw new Error(`Invalid state ${this.mouseState.state} on computeChangeStageType`);this.mouseState.stage.type!==e&&this.model.updateStageType(this.mouseState.stage.id,e)}computeChangeTransition(e,t){this.mouseState.state==="TRANSITION_QUICK_EDIT"&&e==="condition"&&(this.mouseState.draftProps={conditionValue:t}),this.mouseState.state==="CHANGING_TRANSITION_TYPE"&&e==="type"&&(this.mouseState.newType=t)}computeKeyDownStage(e){if(e.key==="Enter"&&this.mouseState.state==="STAGE_QUICK_EDIT"){this.model.updateStageTitle(this.mouseState.stage.id,this.mouseState.stage.title),this.model.updateStageProps(this.mouseState.stage.id,this.mouseState.draftProps),this.goToIdle();return}this.mouseState.state==="STAGE_QUICK_EDIT"||this.mouseState.state==="TRANSITION_QUICK_EDIT"||(e.key==="t"||e.key==="T"?this.createTransition():e.key==="Enter"?this.selection.selectedStages().length===1&&this.computeStartEditingStage(this.selection.selectedStages()[0]):e.key==="d"||e.key==="D"?this.duplicateThenSelect():e.key==="Delete"||e.key==="Backspace"?this.deleteSelection():(e.key==="a"||e.key==="A")&&(L(e)||he(e))?(this.selection.select(this.model.getState().stages.map(t=>t.id)),e.preventDefault()):e.key==="Escape"&&(this.clearSelection(),this.goToIdle()))}transitionMouseDown(e,t){if(e.button===0&&!(this.mouseState.state==="MOVING"&&this.mouseState.duplicating)){if(this.mouseState.state==="TRANSITION_QUICK_EDIT"||this.mouseState.state==="CHANGING_TRANSITION_TYPE"){if(this.mouseState.transition.id===t.id)return;this.saveChangesOnChangingEditingEntity()}this.mouseState.state==="STAGE_QUICK_EDIT"&&this.saveChangesOnChangingEditingEntity(),this.selection.select([t.id],V(e)),this.computeStartHoveringTransition(t)}}computeStartHoveringTransition(e){if(!(this.mouseState.state==="CHANGING_TRANSITION_TYPE"||this.mouseState.state==="TRANSITION_QUICK_EDIT"||this.mouseState.state==="STAGE_QUICK_EDIT"||this.mouseState.state==="MOVING"||this.mouseState.state==="HOVERING_TRANSITION")){if(this.mouseState.state!=="IDLE")throw new Error(`Invalid state ${this.mouseState.state} on computeStartHoveringTransition`);this.mouseState={state:"HOVERING_TRANSITION",transition:e,mousePos:this.mouseState.mousePos}}}computeFinishHoveringTransition(e){if(!(this.mouseState.state==="CHANGING_TRANSITION_TYPE"||this.mouseState.state==="STAGE_QUICK_EDIT"||this.mouseState.state==="TRANSITION_QUICK_EDIT"||this.mouseState.state==="MOVING"||this.mouseState.state==="IDLE")){if(this.mouseState.state!=="HOVERING_TRANSITION")throw new Error(`Invalid state ${this.mouseState.state} on computeFinishHoveringTransition`);this.mouseState.transition.id===e.id&&this.goToIdle()}}computeAddTransition(){if(this.mouseState.state!=="IDLE")throw new Error(`Invalid state ${this.mouseState.state} on computeAddTransition`);this.mouseState={state:"ADDING_TRANSITION",mousePos:this.mouseState.mousePos,initialMousePos:this.mouseState.mousePos,snappedTarget:null}}revertTransitions(){this.selection.selectedTransitions().forEach(t=>this.model.revertTransition(t.id))}computeStartChangingTransition(e){var a;if(this.saveChangesOnChangingEditingEntity(),this.mouseState.state==="CHANGING_TRANSITION_TYPE")return;if(this.mouseState.state!=="HOVERING_TRANSITION"&&this.mouseState.state!=="IDLE")throw new Error(`Invalid state ${this.mouseState.state} on computeStartChangingTransition`);const t=this.model.getStage(e.sourceStageId);(t==null?void 0:t.type)!=="iterators"&&((t==null?void 0:t.type)==="conditions"?this.mouseState={state:"TRANSITION_QUICK_EDIT",transition:e,mousePos:this.mouseState.mousePos,draftProps:{conditionValue:(a=e.props)==null?void 0:a.conditionValue}}:this.mouseState={state:"CHANGING_TRANSITION_TYPE",transition:e,mousePos:this.mouseState.mousePos,newType:e.type})}computeKeyDownTransition(e){if(e.key==="Enter"&&this.mouseState.state==="TRANSITION_QUICK_EDIT"){this.model.updateTransitionProps(this.mouseState.transition.id,this.mouseState.draftProps),this.goToIdle();return}if(e.key==="Enter"&&this.mouseState.state==="CHANGING_TRANSITION_TYPE"){this.model.updateTransitionType(this.mouseState.transition.id,this.mouseState.newType),this.goToIdle();return}this.mouseState.state==="STAGE_QUICK_EDIT"||this.mouseState.state==="TRANSITION_QUICK_EDIT"||(e.key==="Enter"?this.selection.selectedTransitions().length===1&&this.computeStartChangingTransition(this.selection.selectedTransitions()[0]):e.key==="Delete"||e.key==="Backspace"?this.deleteSelection():e.key==="a"&&(L(e)||he(e))?(this.selection.select(this.model.getState().stages.map(t=>t.id)),e.preventDefault()):e.key==="r"||e.key==="R"?this.revertTransitions():e.key==="Escape"&&(this.clearSelection(),this.goToIdle()))}getStageRect(e){var d,r,c,l;this.mouseState,this.camera.x,this.camera.y,this.camera.zoom;const t=(d=this.canvas.parentElement)==null?void 0:d.querySelector(`.items-container [data-type="stage"][data-id="${e}"]`),a=(r=t==null?void 0:t.getBoundingClientRect)==null?void 0:r.call(t),i=(l=(c=t==null?void 0:t.parentElement)==null?void 0:c.getBoundingClientRect)==null?void 0:l.call(c);return!i||!a?null:{x:a.x-i.x,y:a.y-i.y,width:a.width,height:a.height,referential:"screen"}}getTransitionRect(e){var d,r,c,l;const t=(d=this.canvas.parentElement)==null?void 0:d.querySelector(`.items-container [data-type="transition"][data-id="${e}"]`),a=(r=t==null?void 0:t.getBoundingClientRect)==null?void 0:r.call(t),i=(l=(c=t==null?void 0:t.parentElement)==null?void 0:c.getBoundingClientRect)==null?void 0:l.call(c);return!i||!a?null:{x:a.x-i.x,y:a.y-i.y,width:a.width,height:a.height,referential:"screen"}}renderAddTransition(){this.mouseState.state==="ADDING_TRANSITION"&&bt(this)}debug(){this.ctx.fillText(JSON.stringify(this.mouseState,null,2),10,10),this.ctx.fillText(JSON.stringify(this.selection.selectedIds(),null,2),10,30)}render(){try{this.fixSize(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.model.getState().transitions.forEach(e=>{$e(this,e)}),this.renderAddTransition()}finally{requestAnimationFrame(()=>this.render())}}fitCamera(){const t=this.model.getState().stages.map(i=>({height:100,referential:"world",width:100,x:i.position.x-50,y:i.position.y-50})),a=ge(t);!a||this.camera.fit(a)}init(){this.setUpCanvasKeyDown(),this.setupMousemove(),this.setupDragover(),this.setupMousedown(),this.setupDrop(),this.setupMouseup(),this.setupWheel(),this.render(),this.fitCamera()}clearSelection(){this.selection.clear()}dragstart(e,t){const a=this.getScreenPointerFromEvent(t);this.clearSelection(),this.mouseState={state:"ADDING_NEW_STAGES",mousePos:a,stages:[{type:e,position:this.camera.screenPoint2world(a)}]}}goToIdle(){this.mouseState={state:"IDLE",mousePos:this.mouseState.mousePos}}}const Lt=Q({__name:"stage",props:{stage:{},gui:{},workspace:{}},emits:["change","changeType"],setup(s,{emit:e}){const t=s;Ye(u=>({c16a85be:o(ve)}));const a=Je(),i=()=>{const u=a.resolve({path:`/_editor/${t.stage.type.slice(0,-1)}/${t.stage.id}`});window.open(u.href,"_blank")},d=K(!0),r=K(!1),c=je.exports.debounce(async u=>{Pe.checkFile(u).then(E=>{d.value=E.exists,r.value=!1})},500),l=()=>{r.value=!0,!(t.stage.type==="conditions"||t.stage.type==="iterators")&&(t.workspace.initFile(M.value,t.stage.type).then(()=>{d.value=!0,r.value=!1}),Pe.checkFile(M.value).then(u=>{d.value=u.exists,r.value=!1}))},p=()=>{r.value=!0,!(t.stage.type==="conditions"||t.stage.type==="iterators")&&t.workspace.openFile(M.value).then(()=>{r.value=!1})},f=u=>{!u||e("change","title",u)},P=u=>{!u||e("change","path",u)},b=()=>{const u=dt(j.value);j.value=u,Y(u)},$=()=>{const u=ct(M.value);M.value=u,k(u)},F=()=>{const u=ht(J.value);J.value=u,P(u)},G=g(()=>{if(t.stage.type==="conditions"||t.stage.type==="iterators")return{validateStatus:"success",help:""};const u=rt(M.value);return u.valid?{validateStatus:"success",help:""}:{validateStatus:"error",help:u.reason}}),w=g(()=>{if(t.stage.type==="conditions"||t.stage.type==="iterators"||t.stage.type==="jobs"||t.stage.type==="scripts")return{validateStatus:"success",help:""};const u=lt(J.value);return u.valid?{validateStatus:"success",help:""}:{validateStatus:"error",help:u.reason}}),y=g(()=>{if(t.stage.type!=="conditions"&&t.stage.type!=="iterators")return{validateStatus:"success",help:""};const u=ut(j.value);return u.valid?{validateStatus:"success",help:""}:{validateStatus:"error",help:u.reason}}),C=g(()=>G.value.validateStatus==="error"||w.value.validateStatus==="error"||y.value.validateStatus==="error"),k=u=>{!u||(r.value=!0,c(u),e("change","filename",u))},Y=u=>{!u||e("change","variableName",u)},se=u=>{!u||e("changeType",u)},Te=K(t.stage.title),J=K(t.stage.props.path||""),M=K(t.stage.props.filename||""),j=K(t.stage.props.variableName||""),He=g(()=>t.gui.selection.has(t.stage)),le=g(()=>t.gui.mouseState.state==="STAGE_QUICK_EDIT"&&t.gui.mouseState.stage.id===t.stage.id),Fe=g(()=>t.stage.type==="conditions"||t.stage.type==="iterators"),Le=g(()=>t.stage.type==="forms"||t.stage.type==="hooks"),we=g(()=>t.stage.type==="forms"||t.stage.type==="hooks"||t.stage.type==="jobs"),Ve=g(()=>{const u=Ht(t.gui,t.stage);return{transform:`translate(${u.x}px, ${u.y}px) scale(${t.gui.camera.zoom}) translate(-50%, -50%)`,transformOrigin:"top left"}}),Ue=()=>{t.stage.type==="conditions"||t.stage.type==="iterators"||c(M.value)};let Ee;return De(()=>{Ee=setInterval(Ue,1e3)}),Ze(()=>{clearInterval(Ee)}),(u,E)=>(m(),_("div",{class:Me(["stage-card",{selected:He.value}]),style:oe(Ve.value),tabindex:"0"},[le.value?(m(),v(o(ce),{key:0,class:"card"},{title:n(()=>[h(o(Z),{justify:"space-between",align:"center"},{default:n(()=>[h(o(Z),{align:"center"},{default:n(()=>[h(o(qe),{trigger:["click"]},{overlay:n(()=>[h(o(Ge),null,{default:n(()=>[(m(!0),_(U,null,B(o(re).stages,T=>(m(),v(o(z),{key:T.key,onClick:us=>se(T.typeName)},{default:n(()=>[h(o(H),null,{default:n(()=>[h(R,{path:T.icon},null,8,["path"]),h(o(I),{content:T.title},null,8,["content"])]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),default:n(()=>[x("a",null,[h(o(Z),null,{default:n(()=>[h(R,{path:o(ue)(u.stage.type)},null,8,["path"]),h(R,{path:o(nt)},null,8,["path"])]),_:1})])]),_:1}),h(o(q),{value:Te.value,"onUpdate:value":E[0]||(E[0]=T=>Te.value=T),bordered:!1,class:"title-input",onChange:E[1]||(E[1]=T=>f(T.target.value))},null,8,["value"])]),_:1}),u.gui.model.stageHasChanges(u.stage.id)?(m(),v(o(Ne),{key:1},{title:n(()=>[x("span",null,"Save to allow edit in "+A(u.stage.type)+" editor",1)]),default:n(()=>[we.value?(m(),v(R,{key:0,path:o(xe),style:{opacity:"0.5",cursor:"default"}},null,8,["path"])):N("",!0)]),_:1})):(m(),v(o(Ne),{key:0},{title:n(()=>[x("span",null,"Edit more in "+A(u.stage.type)+" editor",1)]),default:n(()=>[we.value?(m(),v(R,{key:0,path:o(xe),onclick:i},null,8,["path"])):N("",!0)]),_:1}))]),_:1})]),default:n(()=>[Fe.value?(m(),v(o(H),{key:0,direction:"vertical",size:4,style:{width:"100%"}},{default:n(()=>[h(o(I),null,{default:n(()=>[S("Variable name")]),_:1}),h(o(de),{"validate-status":y.value.validateStatus,help:y.value.help},{default:n(()=>[h(o(q),{value:j.value,"onUpdate:value":E[2]||(E[2]=T=>j.value=T),onChange:E[3]||(E[3]=T=>Y(T.target.value)),onBlur:b},null,8,["value"])]),_:1},8,["validate-status","help"])]),_:1})):(m(),v(o(H),{key:1,direction:"vertical",style:{width:"100%"}},{default:n(()=>[Le.value?(m(),v(o(H),{key:0,direction:"vertical",size:4,style:{width:"100%"}},{default:n(()=>[h(o(I),null,{default:n(()=>[S("Path")]),_:1}),h(o(de),{"validate-status":w.value.validateStatus,help:w.value.help},{default:n(()=>[h(o(q),{value:J.value,"onUpdate:value":E[4]||(E[4]=T=>J.value=T),onChange:E[5]||(E[5]=T=>P(T.target.value)),onBlur:F},Xe({_:2},[u.stage.type==="forms"?{name:"addonBefore",fn:n(()=>[S("/")]),key:"0"}:u.stage.type==="hooks"?{name:"addonBefore",fn:n(()=>[S("/_hooks/")]),key:"1"}:void 0]),1032,["value"])]),_:1},8,["validate-status","help"])]),_:1})):N("",!0),h(o(H),{direction:"vertical",size:4,style:{width:"100%"}},{default:n(()=>[h(o(I),null,{default:n(()=>[S("File name")]),_:1}),h(o(de),{"validate-status":G.value.validateStatus},{help:n(()=>[M.value.endsWith(".py")?d.value?(m(),v(o(ke),{key:2,onClick:p},{default:n(()=>[S(" Open file ")]),_:1})):(m(),v(o(I),{key:1},{default:n(()=>[S(" This file does not exist. "),h(o(ke),{onClick:l},{default:n(()=>[S("Create file")]),_:1})]),_:1})):(m(),v(o(I),{key:0,type:"danger"},{default:n(()=>[S(A(G.value.help),1)]),_:1}))]),default:n(()=>[h(o(q),{value:M.value,"onUpdate:value":E[6]||(E[6]=T=>M.value=T),loading:r.value,onChange:E[7]||(E[7]=T=>k(T.target.value)),onBlur:$},null,8,["value","loading"])]),_:1},8,["validate-status"])]),_:1})]),_:1}))]),_:1})):N("",!0),!le.value&&C.value?(m(),v(o(mt),{key:1,count:"!"},{default:n(()=>[h(o(ce),{class:"card"},{default:n(()=>[h(o(Z),{align:"center",gap:"small"},{default:n(()=>[h(R,{path:o(ue)(u.stage.type)},null,8,["path"]),h(o(I),{content:u.stage.title},null,8,["content"])]),_:1})]),_:1})]),_:1})):N("",!0),!le.value&&!C.value?(m(),v(o(ce),{key:2,class:"card"},{default:n(()=>[h(o(Z),{align:"center",gap:"small"},{default:n(()=>[h(R,{path:o(ue)(u.stage.type)},null,8,["path"]),h(o(I),{content:u.stage.title,ellipsis:!0},null,8,["content"])]),_:1})]),_:1})):N("",!0)],6))}});const Vt=W(Lt,[["__scopeId","data-v-22d50ce8"]]),Ut={key:2},zt={key:3},Bt={key:4},Qt=Q({__name:"transition",props:{transition:{},gui:{}},emits:["change"],setup(s,{emit:e}){const t=s,a=y=>{e("change","type",String(y))},i=y=>{!y||e("change","condition",y)},d=t.gui.model.getStage(t.transition.sourceStageId);if(!d)throw new Error(`No source stage found for transition ${t.transition.id}`);const r=re.stages.find(y=>y.typeName===d.type),c=g(()=>{const y=r==null?void 0:r.transitions.find(C=>C.typeName===t.transition.type);if(!y)throw new Error(`No metadata found for transition ${t.transition.type}`);return y.title}),l=g(()=>!$.value&&!b.value?"":$t(t.gui,t.transition)),p=g(()=>{var y;return b.value&&((y=t.transition.props)==null?void 0:y.conditionValue)||""}),f=g(()=>t.gui.mouseState.state!=="CHANGING_TRANSITION_TYPE"?!1:t.gui.mouseState.transition.id===t.transition.id),P=g(()=>t.gui.mouseState.state!=="TRANSITION_QUICK_EDIT"?!1:t.gui.mouseState.transition.id===t.transition.id),b=g(()=>t.transition.type.includes("conditions")),$=g(()=>t.transition.type.includes("iterators")),F=g(()=>t.gui.selection.has(t.transition)),G=g(()=>t.gui.mouseState.state!=="CHANGING_TRANSITION_TYPE"?"":t.gui.mouseState.newType),w=g(()=>{const y=Ot(t.gui,t.transition);return{transform:`translate(${y.x}px, ${y.y}px) scale(${t.gui.camera.zoom}) translate(-50%, -50%)`,transformOrigin:"top left"}});return(y,C)=>(m(),_("div",{class:Me(["transition-card",{selected:F.value}]),style:oe(w.value),tabindex:"0"},[f.value?(m(),v(o(H),{key:0,class:"editing"},{default:n(()=>[h(o(tt),{class:"selector","default-value":G.value,"onUpdate:value":a},{default:n(()=>{var k,Y;return[(m(!0),_(U,null,B((Y=(k=o(r))==null?void 0:k.transitions)!=null?Y:[],se=>(m(),v(o(et),{key:se.typeName},{default:n(()=>[S(A(se.title),1)]),_:2},1024))),128))]}),_:1},8,["default-value"])]),_:1})):P.value?(m(),v(o(H),{key:1,class:"editing"},{default:n(()=>[h(o(q),{style:{width:"200px"},"default-value":p.value,onChange:C[0]||(C[0]=k=>i(k.target.value))},{addonBefore:n(()=>[S("= ")]),_:1},8,["default-value"])]),_:1})):b.value?(m(),_("span",Ut,[h(o(I),{code:""},{default:n(()=>[S(A(l.value),1)]),_:1}),S(" = "+A(p.value),1)])):$.value?(m(),_("span",zt,[S("for "),h(o(I),{code:""},{default:n(()=>[S("item")]),_:1}),S(" in "),h(o(I),{code:""},{default:n(()=>[S(A(l.value),1)]),_:1})])):(m(),_("span",Bt,A(c.value),1))],6))}});const Wt=W(Qt,[["__scopeId","data-v-c3016c87"]]),Yt={class:"menu-item"},Jt={class:"menu-item"},jt={class:"menu-item"},Zt={class:"menu-item"},qt={class:"menu-item"},Xt=Q({__name:"selection",props:{gui:{}},emits:["add-transition","duplicate-stages","revert-transitions","edit-stage","edit-transition","delete"],setup(s,{emit:e}){const t=s,a=g(()=>t.gui.selection.selectedIds().length===t.gui.selection.selectedStages().length),i=g(()=>t.gui.selection.selectedIds().length===t.gui.selection.selectedTransitions().length),d=g(()=>t.gui.selection.selectedIds().length>1||t.gui.selection.selectedIds().length===1&&t.gui.selection.selectedTransitions().length>0),r=g(()=>t.gui.selection.selectedIds().length===1),c=g(()=>t.gui.selection.selectedTransitions().some(y=>y.type.includes("iterators"))),l=g(()=>t.gui.selection.selectedIds().length>0&&(t.gui.mouseState.state==="IDLE"||t.gui.mouseState.state==="HOVERING_STAGE"||t.gui.mouseState.state==="HOVERING_TRANSITION"));function p(){const w=t.gui.selection.selectedStages(),y=w.map(k=>t.gui.getStageRect(k.id)),C=t.gui.selection.selectedTransitions();return(C.length>1||w.length>0)&&y.push(...C.map(k=>Mt(t.gui,k.id))),ge(y)}const f=g(()=>{const w=p();if(!w)if(i.value&&r.value){const C=t.gui.selection.selectedTransitions()[0],k=Kt(t.gui,C);return{menu:{transform:`translate(${k.x+50}px, ${k.y-10}px) scale(${t.gui.camera.zoom}) `,transformOrigin:"top left"},hull:{}}}else return{menu:{display:"none"},hull:{display:"none"}};const y={x:w.x+w.width+10,y:w.y,referential:"screen"};return{menu:{transform:`translate(${y.x}px, ${y.y}px)`,transformOrigin:"top left"},hull:{position:"absolute",top:`${w.y}px`,left:`${w.x}px`,width:`${w.width}px`,height:`${w.height}px`,pointerEvents:"none",border:`1px dashed ${ve}`,boxSizing:"border-box"}}}),P=()=>e("add-transition"),b=()=>{a.value?e("edit-stage"):i.value&&e("edit-transition")},$=()=>e("duplicate-stages"),F=()=>e("delete"),G=()=>e("revert-transitions");return(w,y)=>(m(),_(U,null,[l.value?(m(),v(o(Ge),{key:0,class:"selection-menu",style:oe(f.value.menu)},{default:n(()=>[a.value?(m(),v(o(z),{key:0,onClick:P},{default:n(()=>[x("div",Yt,[h(o(I),null,{default:n(()=>[S("Add transition")]),_:1}),h(o(I),{keyboard:""},{default:n(()=>[S("T")]),_:1})])]),_:1})):N("",!0),r.value&&!c.value?(m(),v(o(z),{key:1,onClick:b},{default:n(()=>[x("div",Jt,[h(o(I),null,{default:n(()=>[S("Edit")]),_:1}),h(o(I),{keyboard:""},{default:n(()=>[S("Enter")]),_:1})])]),_:1})):N("",!0),a.value?(m(),v(o(z),{key:2,onClick:$},{default:n(()=>[x("div",jt,[h(o(I),null,{default:n(()=>[S("Duplicate")]),_:1}),h(o(I),{keyboard:""},{default:n(()=>[S("D")]),_:1})])]),_:1})):N("",!0),h(o(z),{onClick:F},{default:n(()=>[x("div",Zt,[h(o(I),null,{default:n(()=>[S("Delete")]),_:1}),h(o(I),{keyboard:""},{default:n(()=>[S("Del")]),_:1})])]),_:1}),i.value?(m(),v(o(z),{key:3,onClick:G},{default:n(()=>[x("div",qt,[h(o(I),null,{default:n(()=>[S("Revert")]),_:1}),h(o(I),{keyboard:""},{default:n(()=>[S("R")]),_:1})])]),_:1})):N("",!0)]),_:1},8,["style"])):N("",!0),d.value?(m(),_("div",{key:1,class:"selection-hull",style:oe(f.value.hull)},null,4)):N("",!0)],64))}});const es=W(Xt,[["__scopeId","data-v-d4bbc465"]]),ts={class:"canvas-container"},ss={key:0,class:"items-container"},as=Q({__name:"CanvasGui",props:{model:{},workspace:{}},setup(s,{expose:e}){const t=s,a=K(null),i=Se(null);e({gui:i}),De(()=>{if(!a.value)throw new Error("canvas is null");i.value=_e.create(a.value,t.model)});const d=g(()=>t.model.getState());return(r,c)=>(m(),_("div",ts,[x("canvas",{ref_key:"canvas",ref:a,class:"workflow-canvas",tabindex:"0"},null,512),i.value?(m(),_("div",ss,[(m(!0),_(U,null,B(d.value.stages,l=>(m(),v(Vt,{key:l.id,gui:i.value,workspace:r.workspace,"data-type":"stage","data-id":l.id,stage:l,onChange:c[0]||(c[0]=(p,f)=>{var P;return(P=i.value)==null?void 0:P.computeChangeStage(p,f)}),onMousedown:p=>{var f;return(f=i.value)==null?void 0:f.stageMouseDown(p,l)},onMouseenter:()=>{var p;return(p=i.value)==null?void 0:p.computeStartHoveringStage(l)},onMouseleave:()=>{var p;return(p=i.value)==null?void 0:p.computeFinishHoveringStage(l)},onKeydown:c[1]||(c[1]=p=>{var f;return(f=i.value)==null?void 0:f.computeKeyDownStage(p)}),onDblclick:()=>{var p;return(p=i.value)==null?void 0:p.computeStartEditingStage(l)},onChangeType:c[2]||(c[2]=p=>{var f;return(f=i.value)==null?void 0:f.computeChangeStageType(p)})},null,8,["gui","workspace","data-id","stage","onMousedown","onMouseenter","onMouseleave","onDblclick"]))),128)),(m(!0),_(U,null,B(d.value.transitions,l=>(m(),v(Wt,{key:l.id,gui:i.value,"data-type":"transition","data-id":l.id,transition:l,onChange:c[3]||(c[3]=(p,f)=>{var P;return(P=i.value)==null?void 0:P.computeChangeTransition(p,f)}),onMousedown:p=>{var f;return(f=i.value)==null?void 0:f.transitionMouseDown(p,l)},onMouseenter:()=>{var p;return(p=i.value)==null?void 0:p.computeStartHoveringTransition(l)},onMouseleave:()=>{var p;return(p=i.value)==null?void 0:p.computeFinishHoveringTransition(l)},onDblclick:()=>{var p;return(p=i.value)==null?void 0:p.computeStartChangingTransition(l)},onKeydown:c[4]||(c[4]=p=>{var f;return(f=i.value)==null?void 0:f.computeKeyDownTransition(p)})},null,8,["gui","data-id","transition","onMousedown","onMouseenter","onMouseleave","onDblclick"]))),128)),h(es,{gui:i.value,onAddTransition:c[5]||(c[5]=()=>{var l;return(l=i.value)==null?void 0:l.computeAddTransition()}),onEditStage:c[6]||(c[6]=()=>{var l;return(l=i.value)==null?void 0:l.computeStartEditingStageSelection()}),onEditTransition:c[7]||(c[7]=()=>{var l;return(l=i.value)==null?void 0:l.computeStartChangingTransitionSelection()}),onRevertTransitions:c[8]||(c[8]=()=>{var l;return(l=i.value)==null?void 0:l.revertTransitions()}),onDuplicateStages:c[9]||(c[9]=()=>{var l;return(l=i.value)==null?void 0:l.duplicateThenSelect()}),onDelete:c[10]||(c[10]=()=>{var l;return(l=i.value)==null?void 0:l.deleteSelection()})},null,8,["gui"])])):N("",!0),i.value&&d.value.stages.length===0?(m(),v(Et,{key:1,gui:i.value},null,8,["gui"])):N("",!0)]))}});const is=W(as,[["__scopeId","data-v-f7844f01"]]),os={class:"workflow-editor"},ns={class:"workflow-toolbar"},rs=["onDragstart"],ls=Q({__name:"WorkflowEditor",props:{workflowModel:{},workspaceModel:{}},setup(s){const e=K(null),t=g(()=>{var i;return(i=e.value)==null?void 0:i.gui}),a=(i,d)=>{var r,c;(r=d.dataTransfer)==null||r.setData("type",i),(c=t.value)==null||c.dragstart(i,d)};return(i,d)=>(m(),_("div",os,[i.workflowModel?(m(),v(is,{key:0,ref_key:"canvasGui",ref:e,model:i.workflowModel,workspace:i.workspaceModel},null,8,["model","workspace"])):N("",!0),x("div",ns,[(m(!0),_(U,null,B(o(re).stages,r=>(m(),v(o(at),{key:r.typeName,placement:"right"},{title:n(()=>[h(o(H),null,{default:n(()=>[h(o(I),null,{default:n(()=>[S(A(r.title),1)]),_:2},1024),h(o(I),{keyboard:""},{default:n(()=>[S(A(r.key),1)]),_:2},1024)]),_:2},1024)]),content:n(()=>[S(A(r.description),1)]),default:n(()=>[x("span",{draggable:"true",onDragstart:c=>a(r.typeName,c)},[h(st,{class:"toolbar-item",path:r.icon},null,8,["path"])],40,rs)]),_:2},1024))),128))])]))}});const Ms=W(ls,[["__scopeId","data-v-dce42ec4"]]);export{Ms as default};
//# sourceMappingURL=WorkflowEditor.3e036198.js.map
