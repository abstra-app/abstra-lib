var ye=Object.defineProperty;var ve=(a,t,n)=>t in a?ye(a,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[t]=n;var B=(a,t,n)=>(ve(a,typeof t!="symbol"?t+"":t,n),n);import{t as ie}from"./ant-design.db871477.js";import{f as o,eE as ue,eZ as he,r as N,F as ce,D as be,o as ke,J as Se,d as q,b as l,et as m,w as s,bo as C,eA as x,eB as b,u as e,t as M,c as u,ao as y,ev as A,cI as de,be as pe,eF as ee,e as F,cA as $,bM as J,bF as we,ab as E,cz as j,a as Ce,cm as Ae,dk as te,ci as xe}from"./outputWidgets.b703ca45.js";import{a as z}from"./asyncComputed.557fdbc3.js";import{s as Oe}from"./metadata.02d96d32.js";import{C as Ie}from"./icons.5202cd65.js";import{A as V}from"./index.44c0d841.js";import{r as De,f as Pe}from"./index.cd3799ce.js";import{F as Re}from"./index.b66fed07.js";import{T as Te,A as Fe}from"./Timeline.0a366f6a.js";import{A as fe}from"./index.349f4a09.js";import{A as _e}from"./index.5255b475.js";import{A as ae,a as ne}from"./Title.c76d824d.js";import{D as $e,A as Ee}from"./index.637a9dc7.js";import{A as W,C as L}from"./CollapsePanel.5ed9fced.js";import{A as je}from"./Link.b9370a79.js";import{_ as Ne}from"./SaveButton.vue_vue_type_script_setup_true_lang.d45cbc44.js";import{A as ze}from"./Text.4646803d.js";import{F as ge}from"./Form.44bc3190.js";import{A as U}from"./FormItem.39e0b98f.js";import{W as Ve}from"./workspaces.ac64317a.js";import{S as Ue}from"./scripts.1bf47b79.js";import{C as qe}from"./Card.3c731ead.js";import{E as Be}from"./ExpandOutlined.854829ba.js";import"./index.dfe99d95.js";import"./Modal.c03e4b0a.js";import"./index.5bccb5b1.js";import"./isNumeric.75337b1e.js";import"./hasIn.66135dec.js";import"./record.6a34e5b4.js";import"./pubsub.781c61cb.js";import"./url.7a748c18.js";import"./TabPane.9316e440.js";(function(){try{var a=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(a._sentryDebugIds=a._sentryDebugIds||{},a._sentryDebugIds[t]="b4a1c307-7ce3-44c1-b674-9f0f917b843d",a._sentryDebugIdIdentifier="sentry-dbid-b4a1c307-7ce3-44c1-b674-9f0f917b843d")}catch{}})();var Je={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM641.7 520.8L442.3 677.6c-7.4 5.8-18.3.6-18.3-8.8V355.3c0-9.4 10.9-14.7 18.3-8.8l199.4 156.7a11.2 11.2 0 010 17.6z"}}]},name:"play-square",theme:"filled"};const Me=Je;function We(a,t){return De(1,arguments),Pe(a,Date.now(),t)}function se(a){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?Object(arguments[t]):{},r=Object.keys(n);typeof Object.getOwnPropertySymbols=="function"&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(d){return Object.getOwnPropertyDescriptor(n,d).enumerable}))),r.forEach(function(d){Le(a,d,n[d])})}return a}function Le(a,t,n){return t in a?Object.defineProperty(a,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):a[t]=n,a}var H=function(t,n){var r=se({},t,n.attrs);return o(ue,se({},r,{icon:he}),null)};H.displayName="EyeOutlined";H.inheritAttrs=!1;const He=H;function re(a){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?Object(arguments[t]):{},r=Object.keys(n);typeof Object.getOwnPropertySymbols=="function"&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(d){return Object.getOwnPropertyDescriptor(n,d).enumerable}))),r.forEach(function(d){Ke(a,d,n[d])})}return a}function Ke(a,t,n){return t in a?Object.defineProperty(a,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):a[t]=n,a}var K=function(t,n){var r=re({},t,n.attrs);return o(ue,re({},r,{icon:Me}),null)};K.displayName="PlaySquareFilled";K.inheritAttrs=!1;const le=K;function Ze(a){switch(a.status){case"waiting":return{color:"blue",text:"Waiting"};case"running":return{color:"processing",text:"Running"};case"finished":return{color:"success",text:"Success"};case"failed":return{color:"error",text:"Failed"};case"abandoned":return{color:"warning",text:"Abandoned"}}}function Ge(){const a=N({state:"closed"});function t(){a.value={state:"closed"}}function n(){a.value={state:"visualizations"}}function r(c,i){a.value={state:"stage-run",stageRun:i}}const d=ce(()=>"stageRun"in a.value?a.value.stageRun:null);return{closeDrawer:t,openVisualizationEditor:n,inspectStageRun:r,drawerState:a,selectedStageRunForDrawer:d}}function Qe({getKanbanData:a,storage:t,getWorkspace:n}){const r=t!=null?t:localStorage;function d(){const f=r.getItem("kanban-selected-stage-ids");if(f)try{return JSON.parse(f)}catch{return[]}else return[]}const c=be(d()),i=z(async()=>{try{const f=await a(c.value);return r.setItem("kanban-selected-stage-ids",JSON.stringify(c.value)),f}catch{return r.setItem("kanban-selected-stage-ids",JSON.stringify([])),{columns:[],next_stage_options:[]}}finally{c.value=d()}}),O=z(()=>n());async function k(f,v){f?c.value=[...c.value.slice(0,v),f]:c.value=c.value.slice(0,v),await i.refetch()}function R(f,v){var I;const _=(I=f.stages)==null?void 0:I.find(g=>g.id===f.selected_stage.id);if((_==null?void 0:_.type)==="form"){const g=(v==null?void 0:v.status)==="waiting"?{"abstra-run-id":v.id}:{};return{path:`/${_.path}`,query:g}}else return null}let D=null;function S(){ke(()=>{D=setInterval(()=>{i.refetch()},1e3)}),Se(()=>{D&&clearInterval(D)})}const w=ce(()=>{var v,_,I;const f=(_=(v=i.result.value)==null?void 0:v.columns)!=null?_:[];return(I=f[f.length-1])==null?void 0:I.selected_stage});return{kanbanAsyncComputed:i,selectedStageIds:c,setNewSelectedStageId:k,workspaceAsyncComputed:O,launchLink:R,lastSelectedStage:w,init:S}}async function Xe(a){return(await fetch("/_editor/api/kanban",{method:"POST",body:JSON.stringify({selected_stages_ids:a}),headers:{"Content-Type":"application/json"}})).json()}async function Ye(a){return(await fetch(`/_editor/api/kanban/logs/${a}`)).json()}async function et(a){return(await fetch("/_editor/api/stage_runs/fork",{method:"POST",body:JSON.stringify({stage_run_id:a}),headers:{"Content-Type":"application/json"}})).json()}const tt={key:0},at={key:1,class:"terminal"},nt=q({__name:"ExecutionInspector",props:{logs:{}},setup(a){return(t,n)=>t.logs.length===0?(l(),m("span",tt)):(l(),m("div",at,[o(e(V),{vertical:""},{default:s(()=>[(l(!0),m(C,null,x(t.logs,r=>(l(),m("pre",{key:r.executionId,class:"log-text"},b(r.payload.text),1))),128))]),_:1})]))}});const st=M(nt,[["__scopeId","data-v-6f310ebb"]]),rt={key:1},lt=["onClick"],ot=q({__name:"StageRunInspector",props:{stageRun:{}},emits:["close"],setup(a,{emit:t}){const n=a,{result:r,loading:d}=z(()=>{var i;return Ye((i=n.stageRun)==null?void 0:i.id)}),c=(i,O)=>{i.stopPropagation(),et(O),t("close")};return(i,O)=>(l(),u(e(fe),{open:"",title:"Stage Run Inspector",size:"large",onClose:O[0]||(O[0]=k=>t("close"))},{extra:s(()=>[o(e(ae),null,{default:s(()=>[o(e(_e),{style:{"font-weight":"600"}},{default:s(()=>{var k;return[y(b((k=i.stageRun)==null?void 0:k.status),1)]}),_:1}),y(" "+b(e(We)(new Date(i.stageRun.created_at),{addSuffix:!0})),1)]),_:1})]),default:s(()=>{var k,R,D;return[(k=i.stageRun)!=null&&k.assignee?(l(),u(e(ae),{key:0},{default:s(()=>{var S;return[y(" Assignee: "+b((S=i.stageRun)==null?void 0:S.assignee),1)]}),_:1})):A("",!0),((R=i.stageRun)==null?void 0:R.content)&&((D=i.stageRun)==null?void 0:D.content.length)>0?(l(),m("div",rt,[o(e(ne),{level:4},{default:s(()=>[y("Current data")]),_:1}),o(e(Ee),{size:"small",column:1},{default:s(()=>{var S;return[(l(!0),m(C,null,x((S=i.stageRun)==null?void 0:S.content,w=>(l(),u(e($e),{key:w.key,label:w.key},{default:s(()=>[o(e(de),{"tree-data":e(ie)(w.value)},null,8,["tree-data"])]),_:2},1032,["label"]))),128))]}),_:1})])):A("",!0),o(e(ne),{level:4,style:{"margin-bottom":"30px"}},{default:s(()=>[y(" Thread history ")]),_:1}),e(d)?(l(),u(e(pe),{key:2})):e(r)?(l(),u(e(Te),{key:3},{default:s(()=>[(l(!0),m(C,null,x(e(r),({stage:S,stage_run:w,logs:f})=>(l(),u(e(Fe),{key:w.id},{default:s(()=>[o(e(L),{ghost:"","expand-icon-position":"end"},{default:s(()=>[o(e(W),{class:"panel"},{header:s(()=>[o(e(V),{align:"center",gap:15},{default:s(()=>[o(ee,{path:e(Oe)(S.type)},null,8,["path"]),y(" "+b(S.title),1)]),_:2},1024)]),extra:s(()=>[F("span",{onClick:v=>c(v,w.id)},[o(e(V),{gap:"small"},{default:s(()=>[o(ee,{path:e(Ie),width:"22"},null,8,["path"]),o(e(je),null,{default:s(()=>[y("Fork")]),_:1})]),_:1})],8,lt)]),default:s(()=>[F("span",null,"Data: "+b(w.data),1),o(st,{logs:f},null,8,["logs"])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):A("",!0)]}),_:1}))}});const it=M(ot,[["__scopeId","data-v-3c0457a1"]]),ut=[{value:"text",label:"Text"},{value:"image",label:"Image"},{value:"table",label:"Table"},{value:"progress-bar",label:"Progress Bar"}];class oe{static async get(){return(await fetch("/_editor/api/visualizations")).json()}static async put(t){const n=await fetch("/_editor/api/visualizations",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return Object.freeze(n.json())}}function ct(a,t){const n=a.length;if(n!==t.length)return!1;for(let r=0;r<n;r++)if(a[r].name!==t[r].name||a[r].type!==t[r].type)return!1;return!0}function T(a,t){var n;return{...a,id:(n=t==null?void 0:t.toString())!=null?n:Math.random().toString(36).slice(2)}}class Z{constructor(t){B(this,"initialItems");B(this,"_items");this.initialItems=t.map((n,r)=>T(n,r)),this._items=N(t.map((n,r)=>T(n,r)))}get items(){return this._items.value}hasChanges(){return!ct(this.initialItems,this.items)}async save(){const t=await oe.put(this.items);this.initialItems=t.map((n,r)=>T(n,r)),this._items.value=t.map((n,r)=>T(n,r))}static async get(){const t=await oe.get();return new Z(t)}add(){this.items.push(T({name:"New var",type:"text"}))}remove(t){const n=this.items.findIndex(r=>r.id===t);n!==-1&&this.items.splice(n,1)}}const dt=q({__name:"VisualizationEditor",setup(a){const{result:t,loading:n}=z(()=>Z.get());return(r,d)=>(l(),u(e(fe),{open:"",title:"Visualization settings"},{extra:s(()=>[e(t)?(l(),u(Ne,{key:0,model:e(t),disabled:!e(t).hasChanges()},null,8,["model","disabled"])):A("",!0)]),default:s(()=>[e(n)||!e(t)?(l(),u(e(pe),{key:0})):(l(),u(e($),{key:1,direction:"vertical",style:{width:"100%"}},{default:s(()=>[o(e(J),{onClick:d[0]||(d[0]=c=>e(t).add())},{default:s(()=>[y("Add")]),_:1}),o(e(L),{bordered:!1},{default:s(()=>[(l(!0),m(C,null,x(e(t).items,c=>(l(),u(e(W),{key:c.id},{header:s(()=>[c.name?(l(),u(e(ze),{key:0,strong:!0},{default:s(()=>[y(b(c.name),1)]),_:2},1024)):A("",!0)]),extra:s(()=>[o(e(J),{danger:"",onClick:i=>e(t).remove(c.id)},{default:s(()=>[y(" Remove ")]),_:2},1032,["onClick"])]),default:s(()=>[o(e(ge),{layout:"vertical"},{default:s(()=>[o(e(U),{label:"Property name"},{default:s(()=>[o(e(we),{value:c.name,"onUpdate:value":i=>c.name=i},null,8,["value","onUpdate:value"])]),_:2},1024),o(e(U),null,{default:s(()=>[o(e(E),{value:c.type,"onUpdate:value":i=>c.type=i,label:"Visualization type"},{default:s(()=>[(l(!0),m(C,null,x(e(ut),i=>(l(),u(e(j),{key:i.value,value:i.value},{default:s(()=>[y(b(i.label),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}))]),_:1}))}}),me=["waiting","running","finished","failed"];function pt(){const a=N([...me]),t=N("");return{filterStatus:a,filterSearch:t}}const ft={class:"stages-container"},_t={class:"stages-content"},gt={style:{"max-height":"200px","overflow-y":"hidden"}},mt=["onClick"],yt=q({__name:"WorkflowKanban",setup(a){const t=async(v,_,I)=>{v.stopPropagation();const g=await Ue.get(_);!g||await g.test(I)},{kanbanAsyncComputed:n,launchLink:r,setNewSelectedStageId:d,lastSelectedStage:c,init:i}=Qe({getKanbanData:Xe,getWorkspace:()=>Ve.get()}),{filterSearch:O,filterStatus:k}=pt(),{closeDrawer:R,inspectStageRun:D,openVisualizationEditor:S,drawerState:w,selectedStageRunForDrawer:f}=Ge();return i(),(v,_)=>{const I=Ce("router-link");return l(),m(C,null,[o(e(V),{vertical:"",style:{height:"100%"}},{default:s(()=>[o(e(L),{ghost:""},{default:s(()=>[o(e(W),{header:"Filters"},{default:s(()=>[o(e(ge),null,{default:s(()=>[o(e(U),{label:"Search"},{default:s(()=>[o(e(Ae),{value:e(O),"onUpdate:value":_[0]||(_[0]=g=>te(O)?O.value=g:null),placeholder:"Search",style:{width:"400px"}},null,8,["value"])]),_:1}),o(e(U),{label:"Status"},{default:s(()=>[o(e(E),{value:e(k),"onUpdate:value":_[1]||(_[1]=g=>te(k)?k.value=g:null),mode:"multiple",style:{width:"400px"}},{default:s(()=>[(l(!0),m(C,null,x(e(me),g=>(l(),u(e(j),{key:g,value:g},{default:s(()=>[y(b(e(Ze)({status:g}).text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),F("div",ft,[F("div",_t,[o(e($),{align:"start"},{default:s(()=>{var g,G,Q;return[(l(!0),m(C,null,x((G=(g=e(n).result.value)==null?void 0:g.columns)!=null?G:[],(p,X)=>(l(),u(e($),{key:X,direction:"vertical"},{default:s(()=>[o(e(E),{style:{width:"100%","min-width":"200px"},"allow-clear":"",value:p.selected_stage.id,"onUpdate:value":h=>e(d)(h,X)},{default:s(()=>[(l(!0),m(C,null,x(p.stages,h=>(l(),u(e(j),{key:h.id,value:h.id},{default:s(()=>[y(b(h.title),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"]),p.selected_stage.id?(l(),u(e($),{key:0,direction:"vertical",style:{width:"100%"}},{default:s(()=>[(l(!0),m(C,null,x(p.stage_run_cards,h=>{var Y;return l(),u(e(qe),{key:h.id,size:"small",style:{"max-width":"250px",cursor:"pointer"},"body-style":{display:((Y=h.content)==null?void 0:Y.length)>0?"block":"none"},onClick:P=>e(D)(p,h)},{title:s(()=>[o(e(_e),null,{default:s(()=>[y(b(h.status),1)]),_:2},1024)]),default:s(()=>[F("div",gt,[(l(!0),m(C,null,x(h.content,P=>(l(),u(e(de),{key:P.key,"tree-data":e(ie)(P.value)},null,8,["tree-data"]))),128))]),y(" "+b(h.assignee),1)]),actions:s(()=>[e(r)(p,h)?(l(),u(I,{key:0,to:e(r)(p,h),target:"_blank",onClick:_[2]||(_[2]=P=>P.stopPropagation())},{default:s(()=>[o(e(le))]),_:2},1032,["to"])):A("",!0),p.selected_stage.type==="script"?(l(),m("span",{key:1,onClick:P=>t(P,p.selected_stage.id,h.id)},[o(e(le))],8,mt)):A("",!0)]),extra:s(()=>[o(e(Be),{onClick:P=>e(D)(p,h)},null,8,["onClick"])]),_:2},1032,["body-style","onClick"])}),128)),p.stage_run_cards.length===0?(l(),u(e(xe),{key:0})):A("",!0),p.selected_stage.can_be_started&&e(r)(p)!==null?(l(),u(I,{key:1,target:"_blank",to:e(r)(p)},{default:s(()=>[o(e(J),{style:{width:"100%"}},{default:s(()=>[y(" Start ")]),_:1})]),_:2},1032,["to"])):A("",!0)]),_:2},1024)):A("",!0)]),_:2},1024))),128)),e(n).result.value&&e(n).result.value.next_stage_options.length>0?(l(),u(e(E),{key:(Q=e(c))==null?void 0:Q.id,style:{width:"100%","min-width":"200px"},"allow-clear":"","onUpdate:value":_[3]||(_[3]=p=>e(d)(p,e(n).result.value.columns.length))},{default:s(()=>[(l(!0),m(C,null,x(e(n).result.value.next_stage_options,p=>(l(),u(e(j),{key:p.id,value:p.id},{default:s(()=>[y(b(p.title),1)]),_:2},1032,["value"]))),128))]),_:1})):A("",!0)]}),_:1})])])]),_:1}),e(w).state==="stage-run"&&e(f)?(l(),u(it,{key:0,"stage-run":e(f),onClose:e(R)},null,8,["stage-run","onClose"])):e(w).state==="visualizations"?(l(),u(dt,{key:1,onClose:e(R)},null,8,["onClose"])):A("",!0),o(e(Re),{onClick:e(S)},{icon:s(()=>[o(e(He))]),_:1},8,["onClick"])],64)}}});const Qt=M(yt,[["__scopeId","data-v-6c203be0"]]);export{Qt as default};
//# sourceMappingURL=WorkflowKanban.dc18d073.js.map
