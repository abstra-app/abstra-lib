var Se=Object.defineProperty;var Me=(o,e,s)=>e in o?Se(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var M=(o,e,s)=>(Me(o,typeof e!="symbol"?e+"":e,s),s);import{u as se}from"./uuid.f36beb61.js";import{G as fe,d as N,r as m,S as ie,H as Q,b as f,ev as k,e as p,ez as H,eE as ve,eF as ge,v as Z,eB as Ie,J as _e,a4 as me,o as ye,L as Ce,a as we,f as h,u as a,I as L,ar as _,eD as T,ex as I,ew as xe,aD as oe,eC as De,c as R,f2 as Fe,f4 as Ae,eJ as Oe,w as c,bz as ke,F as Y,aH as U,bG as j}from"./outputWidgets.cd9a7023.js";import{D as le,E as re,F as ce,i as Re,G as We,H as Be}from"./icons.0bc7085f.js";import{W as He}from"./workspaces.7a569a92.js";import{l as ue}from"./NavbarControls.8453fa0e.js";import"./envVars.b5cd4e38.js";import{H as $e,J as Pe}from"./jobs.f0eac5ef.js";import{S as Le}from"./scripts.7285a17f.js";import{d as Te,v as Ne,e as ze}from"./validations.99b19e23.js";import{A as Ee}from"./Form.6eabd32b.js";import{a as de}from"./asyncComputed.d485b66f.js";import{l as Ke,e as q,R as Ve}from"./toggleHighContrast.86513e1f.js";import{A as pe}from"./index.ad4a79ec.js";import{A as Je}from"./index.95c89dbd.js";import{C as Ge}from"./Card.65be417e.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[e]="4946d539-41ac-4513-baaa-b0b913b572b9",o._sentryDebugIdIdentifier="sentry-dbid-4946d539-41ac-4513-baaa-b0b913b572b9")}catch{}})();class be{constructor(){M(this,"logState",fe({log:[]}));M(this,"_listeners",{})}static create(){return new be}get logs(){return this.logState.log}log(e,s){if(e.type!=="restart"&&e.log.trim()==="")return;const t=s?this.logs.find(i=>i.id===s):null;return t?Object.assign(t,e):this.logs.push({...e,id:s||se()}),this.notifyListeners(e),s}clear(){this.logState.log=[]}listen(e){const s=se();return this._listeners[s]=e,s}unlisten(e){delete this._listeners[e]}notifyListeners(e){Object.values(this._listeners).forEach(s=>s(e))}}class Ue{static async*sendMessage(e,s){var d;const i=(d=(await fetch("/_editor/api/ai/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e,runtime:s})})).body)==null?void 0:d.getReader();if(!i)throw new Error("No response body");for(;;){const b=await i.read();if(b.done)break;yield new TextDecoder().decode(b.value)}}}const je=o=>(ve("data-v-59ca7295"),o=o(),ge(),o),Ye=je(()=>p("div",{class:"text"}," Changes were made in your code. Click Restart to refresh the preview window. ",-1)),he="ignoreCodeChangesWarning",qe=N({__name:"ChangesWarning",props:{hasChanges:{type:Boolean}},setup(o){var d;const e=o,s=m((d=ie.get(he))!=null?d:!1),t=Q(()=>e.hasChanges&&!s.value),i=()=>{ie.set(he,!0),s.value=!0};return(b,y)=>(f(),k("div",{class:H(["changes-warning",{visible:t.value}])},[Ye,p("div",{class:"no-more-alert",onClick:i},"Do not show again")],2))}});const Qe=Z(qe,[["__scopeId","data-v-59ca7295"]]),Xe=o=>(ve("data-v-6ea73c19"),o=o(),ge(),o),Ze={class:"smart-console"},et={class:"header"},tt={class:"left"},st={class:"right"},ot={class:"changes-container"},nt=["unseen-severity"],at={class:"cli"},it={class:"left"},lt=Xe(()=>p("div",{class:"entry ai-output"}," Hello there! I'm both an output console and AI assistant. You can ask me anything. ",-1)),rt={key:1,class:"local-entry"},ct={class:"input"},ut=["pointer-events","onKeydown"],dt={class:"right"},pt=N({__name:"SmartConsole",props:{inputEnabled:{type:Boolean},runtime:{},logService:{},stage:{},workspace:{}},emits:["eval-request","clear-terminal","enter"],setup(o,{expose:e,emit:s}){const t=o,i=m(""),d=m(null),b=Ie(),y=m({type:"seen"}),x=m(!1),$=()=>{E.value=E.value==="assistant"?"debugger":"assistant"};function F(r){switch(r.type){case"ai-input":return{role:"user",content:r.log};case"ai-output":return{role:"assistant",content:r.log};case"stderr":case"stdout":return{role:"user",content:r.log};case"restart":return{role:"user",content:"-- new session --"};case"files-changed":return{role:"user",content:"-- files changed --"};default:throw new Error(`Unknown log type: ${r.type}`)}}const w=Q(()=>t.logService.logs.some(r=>r.type==="files-changed"));function D(){C.value=!C.value,C.value&&(y.value={type:"seen"})}_e(b,()=>{t.logService.clear(),s("clear-terminal")});const v=m(null),E=m("assistant"),P=async r=>{var S;if(r.preventDefault(),i.value=((S=v.value)==null?void 0:S.innerText)||"",r.shiftKey){document.execCommand("insertLineBreak");return}v.value&&(v.value.innerText=""),E.value==="assistant"?await z():await A()},z=async()=>{var l;if(!((l=ue.asyncComputed.result.value)!=null&&l.logged))throw t.logService.log({type:"ai-output",log:"Please login to use the AI assistant."}),new Error("Please login to use the AI assistant.");if(s("enter",i.value),t.logService.log({type:"ai-input",log:i.value}),i.value="",!ue.asyncComputed.result){t.logService.log({type:"stderr",log:"Please login to use the AI assistant."});return}x.value=!0;const r=t.workspace&&t.stage?await t.workspace.readFile(t.stage.file):null,S={role:"user",content:r!=null?r:""};try{const n=se();let g="";const G=Ue.sendMessage([S,...t.logService.logs.map(B=>F(B)),{role:"user",content:i.value}],t.runtime);for await(const B of G)g+=B,t.logService.log({type:"ai-output",log:g},n)}catch(n){t.logService.log({type:"ai-output",log:"Sorry, I don't know how to answer that."}),console.error(n),Ae(n)}finally{x.value=!1}};e({fixJson:async(r,S)=>{t.logService.clear(),t.logService.log({type:"ai-input",log:`here is my json code:
      ${r}
      And I got this error:`}),t.logService.log({type:"stderr",log:S}),C.value=!0,y.value={type:"seen"},i.value="Can you fix this JSON?",await z()}});const A=async()=>{i.value&&(t.logService.log({type:"eval-input",log:`>>> ${i.value}`}),s("eval-request",i.value),i.value="")},ee=()=>{t.logService.clear()};t.logService.listen(async r=>{C.value||(y.value={type:"unseen",count:y.value.type==="unseen"?y.value.count+1:1,severity:r.type==="stderr"?"error":"info"}),r.type!=="restart"&&(await me(),d.value&&(d.value.scrollTop=d.value.scrollHeight))});const C=m(!1),K=m(400),u=Q(()=>({height:`${K.value}px`})),W=m(!1),te=()=>W.value=!0,V=r=>{!W.value||(K.value=document.body.clientHeight-r.clientY)},J=()=>W.value=!1;return ye(()=>{document.addEventListener("mousemove",V),document.addEventListener("mouseup",J)}),Ce(()=>{document.removeEventListener("mousemove",V),document.removeEventListener("mouseup",J)}),(r,S)=>{const l=we("Markdown");return f(),k("div",Ze,[p("div",et,[p("div",tt,[h(L,{path:E.value==="assistant"?a(le):a(re)},null,8,["path"]),_(" Smart Console ")]),p("div",st,[p("div",ot,[h(Qe,{"has-changes":w.value},null,8,["has-changes"])]),p("div",{class:"toggle-button",onClick:D},[h(L,{class:H(["icon",{open:C.value}]),path:a(ce),fill:"#fff"},null,8,["class","path"]),y.value.type==="unseen"?(f(),k("div",{key:0,class:"unseen-count","unseen-severity":y.value.severity},T(y.value.count),9,nt)):I("",!0)])])]),C.value?(f(),k("div",{key:0,class:"terminal",style:xe(u.value)},[p("div",{class:"resize-handler",onMousedown:te},null,32),p("div",at,[p("div",it,[p("div",{ref_key:"entriesContainer",ref:d,class:"entries"},[lt,(f(!0),k(oe,null,De(t.logService.logs,(n,g)=>(f(),k("div",{key:g,class:H([n.type,"entry"])},[n.type==="ai-output"?(f(),R(l,{key:0,source:n.log},null,8,["source"])):(f(),k("div",rt,T(n.type==="restart"?"-- restarted --":n.log),1))],2))),128))],512),p("div",ct,[h(L,{class:H(["icon",{open:C.value}]),path:a(ce)},null,8,["class","path"]),p("div",{ref_key:"inputRef",ref:v,class:"input-text",contenteditable:"","pointer-events":x.value?"none":"auto",placeholder:"Ask AI anything",onKeydown:Fe(P,["enter"])},null,40,ut)])]),p("div",dt,[p("div",{class:"icons",onClick:ee},[h(L,{class:"icon",path:a(Re)},null,8,["path"])]),p("div",null,[h(L,{class:"icon clickable",path:E.value==="assistant"?a(le):a(re),onClick:S[0]||(S[0]=n=>$())},null,8,["path"])])])])],4)):I("",!0)])}}});const Pt=Z(pt,[["__scopeId","data-v-6ea73c19"]]),ht=N({__name:"PathInput",props:{runtime:{}},setup(o){const e=o,s=()=>{const t=Te(e.runtime.path);t&&t!==e.runtime.path&&(e.runtime.path=t)};return(t,i)=>(f(),R(a(ke),{value:t.runtime.path,"onUpdate:value":i[0]||(i[0]=d=>t.runtime.path=d),type:"text",onBlur:s},Oe({_:2},[t.runtime instanceof a($e)?{name:"addonBefore",fn:c(()=>[_(" https://[your-subdomain].abstra.app/_hooks/ ")]),key:"0"}:{name:"addonBefore",fn:c(()=>[_(" https://[your-subdomain].abstra.app/ ")]),key:"1"}]),1032,["value"]))}}),ft={key:1},vt=N({__name:"RuntimeCommonSettings",props:{runtime:{}},setup(o){const e=fe({pathError:null});return(s,t)=>(f(),k(oe,null,[s.runtime instanceof a(Pe)||s.runtime instanceof a(Le)?I("",!0):(f(),R(a(Ee),{key:0,label:"URL path"},{default:c(()=>[h(ht,{runtime:s.runtime},null,8,["runtime"])]),_:1})),e.pathError?(f(),k("div",ft,T(e.pathError),1)):I("",!0)],64))}});const Lt=Z(vt,[["__scopeId","data-v-60a397e0"]]);let X={};function gt(o){return o in X?"\n\n```python\n"+o+" = "+X[o]+"\n```":""}Ke.registerHoverProvider("python",{provideHover:function(o,e){const s=o.getWordAtPosition(e);if(!!s)return{contents:[{value:gt(s.word)}]}}});const _t=(o,e,s={})=>{var F;const t=q.create(o,{language:"python",value:e,minimap:{enabled:!1},readOnly:(F=s.readOnly)!=null?F:!1,contextmenu:!s.readOnly,automaticLayout:!s.readOnly,tabSize:4,fixedOverflowWidgets:!0,theme:s.theme?s.theme:"vs",fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:s.readOnly?0:5,scrollBeyondLastLine:!s.readOnly,renderLineHighlight:s.readOnly?"none":"all",scrollbar:{useShadows:!1,alwaysConsumeMouseWheel:!1}}),i=t.getContribution("editor.contrib.messageController");t.onDidAttemptReadOnlyEdit(()=>{i.showMessage("Cannot edit during preview execution",t.getPosition())});const d=t.createDecorationsCollection([]),b=(w,D)=>{d.set(w.map(v=>({range:new Ve(v.lineno,1,v.lineno,1),options:{isWholeLine:!0,className:D}}))),X=w.reduce((v,E)=>({...v,...E.locals}),{})};return{editor:t,highlight:(w,D)=>v=>{const E=v.filter(P=>P.filename.endsWith(D));b(E,w)},clearHighlights:()=>{d.clear(),X={}},setReadOnly:w=>{t.updateOptions({readOnly:w})}}},mt=(o,e,s)=>{const t=q.createModel(e),i=q.createModel(s),d=q.createDiffEditor(o,{minimap:{enabled:!1},readOnly:!0,contextmenu:!1,automaticLayout:!0,renderWhitespace:"none",guides:{indentation:!1},fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:0,scrollBeyondLastLine:!1,renderLineHighlight:"none"});return d.setModel({original:t,modified:i}),{diffEditor:d}};class yt{constructor(e,s){M(this,"_script");M(this,"_localEditorCode");M(this,"_monacoEditor");M(this,"_diffEditor");M(this,"_viewMode");M(this,"_alertMessage");M(this,"_conflictingChanges");this._localEditorCode=e,this._script=s,this._monacoEditor=null,this._diffEditor=null,this._viewMode=Y("editor"),this._alertMessage=Y(""),this._conflictingChanges=Y(!1)}get alertMessage(){return this._alertMessage.value}set alertMessage(e){this._alertMessage.value=e}get conflictingChanges(){return this._conflictingChanges.value}set conflictingChanges(e){this._conflictingChanges.value=e}get viewMode(){return this._viewMode.value}set viewMode(e){this._viewMode.value=e}get abstraIDECode(){return this._script.codeContent}get localEditorCode(){return this._localEditorCode}set monacoEditor(e){this._monacoEditor=e}set diffEditor(e){this._diffEditor=e}finishPreview(){var e;this._viewMode.value="editor",this._script.codeContent=this._localEditorCode,(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.alertMessage=""}updateCodeWhileEditing(e){var i;const s=e!==this._localEditorCode;if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1;return}const t=!this._script.hasChanges("code_content");if(t){(i=this._monacoEditor)==null||i.setValue(e),this._script.codeContent=e,this._script.updateInitialState("code_content",e);return}if(!t&&s){this.alertMessage="You have conflicting changes with your local editor code",this.conflictingChanges=!0;return}}updateCodeWhileDiff(e){var s,t;if(e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1,this.viewMode="editor",this._localEditorCode=e;return}if(e!==this._localEditorCode){(t=(s=this._diffEditor)==null?void 0:s.getModel())==null||t.modified.setValue(e),this._localEditorCode=e;return}}updateCodeWhilePreview(e){if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="";return}this.alertMessage="The changes on your code will be shown after the preview stops running"}updateCode(e){switch(this._viewMode.value){case"editor":return this.updateCodeWhileEditing(e);case"diff":return this.updateCodeWhileDiff(e);case"preview":return this.updateCodeWhilePreview(e)}}keepAbstraIDECode(){var e;(e=this._monacoEditor)==null||e.setValue(this._script.codeContent),this._script.save("code_content"),this._script.updateInitialState("code_content",this._script.codeContent),this._localEditorCode=this._script.codeContent,this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}keepLocalEditor(){var e;(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}}const Ct={class:"container"},wt=N({__name:"SourceCode",props:{script:{},workspace:{}},emits:["update-file"],setup(o,{expose:e,emit:s}){const t=o,i=()=>{!t.script.file||t.workspace.openFile(t.script.file)},d=()=>{u.value.viewMode="diff",r()},b=m(null),y=m(null);let x,$,F,w;const{result:D}=de(()=>fetch("/_editor/api/workspace/root").then(l=>l.text())),v=m(t.script.file);_e(()=>t.script.file,()=>v.value=t.script.file);const{result:E,refetch:P}=de(()=>He.checkFile(v.value)),z=()=>{A.value.valid?s("update-file",ze(v.value)):s("update-file",v.value),P()},A=Q(()=>{var n;const l=Ne(v.value);return l.valid?((n=E.value)==null?void 0:n.exists)&&t.script.hasChanges("file")?{valid:!0,help:"This file already exists"}:t.script.hasChanges("file")?{valid:!0,help:"The original file will be renamed"}:l:l}),ee=()=>{!t.workspace||!D.value||t.workspace.openFile(".")},C=m(!1),K=async()=>{var n;if(!t.script.file)return;const l=await t.workspace.readFile(t.script.file);if(l===null){C.value=!0;return}C.value=!1,(n=u.value)==null||n.updateCode(l)},u=Y(null);let W;ye(()=>{J(),W=setInterval(K,1e3)}),Ce(()=>{clearInterval(W)});const te=()=>{w(!0),u.value.viewMode="preview"},V=(l,n)=>{if(n)return F("error-line",t.script.file)(l);F("executing-line",t.script.file)(l)},J=async()=>{await me(),t.workspace.readFile(t.script.file).then(l=>{const n=l!=null?l:"";t.script.codeContent=n,t.script.updateInitialState("code_content",n),u.value=new yt(n,t.script);const g=_t(b.value,n);$=g.clearHighlights,F=g.highlight,w=g.setReadOnly,x=g.editor,u.value.monacoEditor=x,x.onDidChangeModelContent(()=>{t.script.codeContent=x.getValue()})})},r=async()=>{const l=await t.workspace.readFile(t.script.file);if(!l)return;const n=t.script.codeContent,g=mt(y.value,n,l);u.value.diffEditor=g.diffEditor};return e({startPreviewMode:te,setHighlight:V,restartEditor:()=>{var l;$(),w(!1),(l=u.value)==null||l.finishPreview()}}),(l,n)=>{var G,B,ne,ae;const g=we("icon");return f(),k(oe,null,[h(a(Ee),{"validate-status":A.value.valid?"success":"error",help:A.value.valid?A.value.help:A.value.reason},{default:c(()=>[h(a(ke),{value:l.script.file,"onUpdate:value":n[0]||(n[0]=O=>l.script.file=O),onBlur:z},{addonBefore:c(()=>[a(D)?(f(),k("span",{key:0,class:"clickable",onClick:ee},[h(a(U),{placement:"bottomLeft","overlay-style":{maxWidth:"none"}},{title:c(()=>[_(T(a(D)),1)]),default:c(()=>[h(g,{path:a(We)},null,8,["path"])]),_:1})])):I("",!0)]),addonAfter:c(()=>[p("span",{class:"clickable",onClick:i},[_(" Open in editor "),h(g,{path:a(Be),width:"22"},null,8,["path"])])]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),(G=u.value)!=null&&G.alertMessage?(f(),R(a(Je),{key:0,type:"warning","show-icon":""},{message:c(()=>{var O;return[_(T((O=u.value)==null?void 0:O.alertMessage),1)]}),action:c(()=>[u.value.conflictingChanges&&u.value.viewMode!=="diff"?(f(),R(a(pe),{key:0,gap:"small"},{default:c(()=>[h(a(j),{type:"primary",onClick:d},{default:c(()=>[_("Compare")]),_:1}),h(a(U),null,{title:c(()=>[_("Keep the local editor version")]),default:c(()=>[h(a(j),{onClick:n[1]||(n[1]=O=>u.value.keepLocalEditor())},{default:c(()=>[_("Discard")]),_:1})]),_:1})]),_:1})):I("",!0),u.value.conflictingChanges&&u.value.viewMode==="diff"?(f(),R(a(pe),{key:1,gap:"small"},{default:c(()=>[h(a(U),null,{title:c(()=>[_("Keep your current changes")]),default:c(()=>[h(a(j),{onClick:n[2]||(n[2]=O=>u.value.keepAbstraIDECode())},{default:c(()=>[_("Keep left")]),_:1})]),_:1}),h(a(U),null,{title:c(()=>[_("Keep the local editor version")]),default:c(()=>[h(a(j),{onClick:n[3]||(n[3]=O=>u.value.keepLocalEditor())},{default:c(()=>[_("Keep right")]),_:1})]),_:1})]),_:1})):I("",!0)]),_:1})):I("",!0),p("div",Ct,[p("div",{id:"code",ref_key:"codeComponent",ref:b,class:H(["code-container",{hide:((B=u.value)==null?void 0:B.viewMode)==="diff",blur:C.value}])},null,2),C.value?(f(),R(a(Ge),{key:0,class:"not-found-popup"},{title:c(()=>[_("File not found")]),_:1})):I("",!0)]),((ne=u.value)==null?void 0:ne.viewMode)==="diff"?(f(),k("div",{key:1,id:"code",ref_key:"codeDiffComponent",ref:y,class:H(["code-container",{hide:((ae=u.value)==null?void 0:ae.viewMode)!=="diff"}])},null,2)):I("",!0)],64)}}});const Tt=Z(wt,[["__scopeId","data-v-6dc20e05"]]);export{be as L,Lt as R,Tt as S,Pt as a};
//# sourceMappingURL=SourceCode.7c9cd948.js.map
