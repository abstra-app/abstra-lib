import{f as s,eG as ye,r as le,H as ie,F as he,d as M,b as r,c as i,w as t,ev as m,eC as F,u as e,cF as j,ar as y,eD as b,cN as me,a$ as O,v as Y,ex as v,bv as ve,eK as ue,e as B,eJ as V,b3 as ke,cn as ce,eE as be,eF as Se,o as we,L as Ae,a as Re,ae as U,dm as xe,cE as z,bV as ne}from"./outputWidgets.f9d55cb0.js";import{a as de}from"./asyncComputed.c2e425ff.js";import{A as Ce,s as H}from"./api.6dd07965.js";import{t as Ie}from"./ant-design.f2b53517.js";import{A as G}from"./Text.8d155850.js";import{A as C}from"./index.922e9b73.js";import{r as De,t as Pe}from"./icons.26963148.js";import{A as pe}from"./index.e3695a5b.js";import{f as Fe}from"./index.8a01d5e4.js";import{A as se}from"./Paragraph.3b137fb5.js";import"./index.218a9012.js";import{A as q}from"./Title.785efc74.js";import"./index.02510c95.js";import{T as Oe,A as Te}from"./Timeline.af38915c.js";import{A as fe,C as _e}from"./CollapsePanel.5afe6c1c.js";import{A as $e}from"./Link.61299810.js";import{A as Ee}from"./index.a9bfe77a.js";import{A as Ne}from"./index.2787c917.js";import{A as Le}from"./contracts.generated.14fc69f0.js";import"./workspaces.0264876b.js";import{S as Ke}from"./scripts.f32619ba.js";import"./envVars.af11a897.js";import{F as je,A as Ve}from"./Form.7dd6cf64.js";import{E as qe}from"./ExpandOutlined.bd16525b.js";import{C as Be}from"./Card.76a3431f.js";import{l as ge}from"./index.630cd210.js";(function(){try{var n=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},a=new Error().stack;a&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[a]="9c828154-cbfe-4da0-9c60-d96a87a85099",n._sentryDebugIdIdentifier="sentry-dbid-9c828154-cbfe-4da0-9c60-d96a87a85099")}catch{}})();var Me={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM641.7 520.8L442.3 677.6c-7.4 5.8-18.3.6-18.3-8.8V355.3c0-9.4 10.9-14.7 18.3-8.8l199.4 156.7a11.2 11.2 0 010 17.6z"}}]},name:"play-square",theme:"filled"};const Ue=Me;function re(n){for(var a=1;a<arguments.length;a++){var o=arguments[a]!=null?Object(arguments[a]):{},l=Object.keys(o);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(o).filter(function(_){return Object.getOwnPropertyDescriptor(o,_).enumerable}))),l.forEach(function(_){ze(n,_,o[_])})}return n}function ze(n,a,o){return a in n?Object.defineProperty(n,a,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[a]=o,n}var Z=function(a,o){var l=re({},a,o.attrs);return s(ye,re({},l,{icon:Ue}),null)};Z.displayName="PlaySquareFilled";Z.inheritAttrs=!1;const oe=Z;function Q(n){switch(n.status){case"waiting":return{color:"blue",text:"Waiting"};case"running":return{color:"processing",text:"Running"};case"finished":return{color:"success",text:"Success"};case"failed":return{color:"error",text:"Failed"};case"abandoned":return{color:"warning",text:"Abandoned"}}}function Je(){const n=le({state:"closed"});function a(){n.value={state:"closed"}}function o(){n.value={state:"visualizations"}}function l(T,S){n.value={state:"stage-run",stageRun:S}}const _=ie(()=>"stageRun"in n.value?n.value.stageRun:null);return{closeDrawer:a,openVisualizationEditor:o,inspectStageRun:l,drawerState:n,selectedStageRunForDrawer:_}}const J="kanban-selected-stage-ids",L=10;function He({kanbanRepository:n,storage:a,filterFactory:o}){const l=he([]),_=de(async()=>{try{return await n.getData({selection:l.value,filter:o()})}catch{return l.value=[],await a.set(J,[]),{columns:[],next_stage_options:[]}}});function T(c){const u=c.selected_stage.id,f=l.value.find(A=>A.stage_id===u);return f!=null&&f.limit?f.limit<c.total_count:!1}async function S(c){var f;const u=l.value.find(A=>A.stage_id===c);u&&(u.limit=((f=u.limit)!=null?f:0)+L,await _.refetch())}async function p(c){const u=l.value.find(f=>f.stage_id===c);u&&u.limit&&u.limit>L&&(u.limit-=L,await _.refetch())}async function w(){const c=await a.get(J)||[];l.value=c.map(u=>({stage_id:u,limit:L,offset:0}))}async function h(c,u){c?l.value=[...l.value.slice(0,u),{stage_id:c,limit:L,offset:0}]:l.value=l.value.slice(0,u),await a.set(J,l.value.map(f=>f.stage_id)),await _.refetch()}function $(c,u){var R;const f=(R=c.stages)==null?void 0:R.find(E=>E.id===c.selected_stage.id);if((f==null?void 0:f.type)!=="form")return null;const A=(u==null?void 0:u.status)==="waiting"?{[Ce]:u.id}:{};return{path:`/${f.path}`,query:A}}let D=null;const k=async()=>{await w(),_.refetch(),D=setInterval(()=>{_.refetch()},1e3)},I=()=>{D&&clearInterval(D)},P=ie(()=>{var u,f,A;const c=(f=(u=_.result.value)==null?void 0:u.columns)!=null?f:[];return(A=c[c.length-1])==null?void 0:A.selected_stage});return{kanbanAsyncComputed:_,selection:l,seeMore:S,hasPagination:T,seeLess:p,setNewSelectedStageId:h,launchLink:$,lastSelectedStage:P,setup:k,tearDown:I}}const W=M({__name:"StageRunData",props:{data:{}},setup(n){return(a,o)=>(r(),i(e(j),{direction:"vertical",style:{"max-height":"200px","overflow-y":"hidden"}},{default:t(()=>[(r(!0),m(O,null,F(a.data,l=>(r(),i(e(j),{key:l.key},{default:t(()=>[s(e(G),{strong:""},{default:t(()=>[y(b(l.key),1)]),_:2},1024),s(e(me),{"tree-data":e(Ie)(l.value)},null,8,["tree-data"])]),_:2},1024))),128))]),_:1}))}}),Ge={key:0},We={key:1,class:"terminal"},Ye=M({__name:"ExecutionInspector",props:{logs:{}},setup(n){return(a,o)=>a.logs.length===0?(r(),m("span",Ge)):(r(),m("div",We,[s(e(C),{vertical:""},{default:t(()=>[(r(!0),m(O,null,F(a.logs,l=>(r(),m("pre",{key:l.executionId,class:"log-text"},b(l.payload.text),1))),128))]),_:1})]))}});const Ze=Y(Ye,[["__scopeId","data-v-032cbeba"]]),Qe=n=>(be("data-v-e10d3de6"),n=n(),Se(),n),Xe={key:1},et={key:1},tt=Qe(()=>B("span",null,"[Deleted Stage]",-1)),at=["onClick"],nt=M({__name:"StageRunInspector",props:{stageRun:{},kanbanRepository:{},stageRunRepository:{}},emits:["close"],setup(n,{emit:a}){const o=n;function l(p){return Object.entries(p).map(([w,h])=>({key:w,value:h,type:typeof h}))}const{result:_,loading:T}=de(()=>{var p;return o.kanbanRepository.getLogs((p=o.stageRun)==null?void 0:p.id)}),S=(p,w)=>{var h;p.stopPropagation(),(h=o.stageRunRepository)==null||h.fork(w),a("close")};return(p,w)=>(r(),i(e(Ne),{open:"",title:"Thread details",size:"large",onClose:w[0]||(w[0]=h=>a("close"))},{extra:t(()=>[s(e(se),null,{default:t(()=>[s(e(pe),{style:{"font-weight":"600"}},{default:t(()=>{var h;return[y(b(e(Q)({status:(h=p.stageRun)==null?void 0:h.status}).text),1)]}),_:1}),y(" "+b(e(Fe)(new Date(p.stageRun.created_at),{addSuffix:!0})),1)]),_:1})]),default:t(()=>{var h,$,D;return[(h=p.stageRun)!=null&&h.assignee?(r(),i(e(se),{key:0},{default:t(()=>{var k;return[y(" Assignee: "+b((k=p.stageRun)==null?void 0:k.assignee),1)]}),_:1})):v("",!0),(($=p.stageRun)==null?void 0:$.content)&&((D=p.stageRun)==null?void 0:D.content.length)>0?(r(),m("div",Xe,[s(e(q),{level:4},{default:t(()=>[y("Current data")]),_:1}),s(W,{data:p.stageRun.content},null,8,["data"])])):v("",!0),s(e(q),{level:4,style:{"margin-bottom":"30px"}},{default:t(()=>[y(" Timeline ")]),_:1}),e(T)?(r(),i(e(ve),{key:2})):e(_)?(r(),i(e(Oe),{key:3},{default:t(()=>[(r(!0),m(O,null,F(e(_),({stage:k,stage_run:I,logs:P})=>(r(),i(e(Te),{key:I.id},{default:t(()=>[s(e(_e),{ghost:"","expand-icon-position":"end"},{default:t(()=>[s(e(fe),{class:"panel"},ue({header:t(()=>[k?(r(),i(e(C),{key:0,align:"center",gap:15},{default:t(()=>[s(V,{path:e(H)(k.type)},null,8,["path"]),P.length?(r(),m("span",et,b(k.title),1)):(r(),i(e(ke),{key:0,placement:"right",title:"No logs"},{default:t(()=>[y(b(k.title),1)]),_:2},1024))]),_:2},1024)):(r(),i(e(C),{key:1,align:"center",gap:15},{default:t(()=>[s(V,{path:e(Pe)},null,8,["path"]),tt]),_:1}))]),default:t(()=>[l(I.data).length||P.length?(r(),i(e(C),{key:0,vertical:""},{default:t(()=>[l(I.data).length?(r(),i(e(C),{key:0,gap:0,vertical:""},{default:t(()=>[s(e(q),{level:5},{default:t(()=>[y(" Output data ")]),_:1}),s(W,{data:l(I.data)},null,8,["data"])]),_:2},1024)):v("",!0),P.length?(r(),i(e(C),{key:1,vertical:"",gap:0},{default:t(()=>[s(e(Ee)),s(e(q),{level:5},{default:t(()=>[y(" Logs ")]),_:1}),s(Ze,{logs:P},null,8,["logs"])]),_:2},1024)):v("",!0)]),_:2},1024)):(r(),i(e(ce),{key:1,description:"No logs"}))]),_:2},[p.stageRunRepository&&k?{name:"extra",fn:t(()=>[B("span",{onClick:c=>S(c,I.id)},[s(e(C),{gap:"small"},{default:t(()=>[s(V,{path:e(De),width:"22"},null,8,["path"]),s(e($e),null,{default:t(()=>[y("Fork")]),_:1})]),_:1})],8,at)]),key:"0"}:void 0]),1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):v("",!0)]}),_:1}))}});const st=Y(nt,[["__scopeId","data-v-e10d3de6"]]),K="Show All",rt=[K,...Le];function ot(){const n=le(K);return{filterStatus:n,filterFactory:()=>n.value==K?{}:{status:n.value},labelOption:l=>l==K?K:Q({status:l}).text}}const lt={style:{width:"100%",padding:"20px"}},it={class:"stages-container"},ut={class:"stages-content"},ct=["onClick"],dt=M({__name:"Kanban",props:{storage:{},kanbanRepository:{},stageRunRepository:{}},setup(n){const a=n,o=async(A,R,E)=>{A.stopPropagation();const x=await Ke.get(R);!x||await x.run(E)},{filterFactory:l,filterStatus:_,labelOption:T}=ot(),{kanbanAsyncComputed:S,launchLink:p,setNewSelectedStageId:w,lastSelectedStage:h,setup:$,tearDown:D,seeMore:k,hasPagination:I}=He({kanbanRepository:a.kanbanRepository,storage:a.storage,filterFactory:l});we($),Ae(D);const{closeDrawer:P,inspectStageRun:c,drawerState:u,selectedStageRunForDrawer:f}=Je();return(A,R)=>{const E=Re("router-link");return r(),m("div",lt,[s(e(C),{vertical:"",style:{height:"100%"}},{default:t(()=>[s(e(_e),{ghost:""},{default:t(()=>[s(e(fe),{header:"Filters"},{default:t(()=>[s(e(je),null,{default:t(()=>[s(e(Ve),{label:"Status"},{default:t(()=>[s(e(U),{value:e(_),"onUpdate:value":R[0]||(R[0]=x=>xe(_)?_.value=x:null),style:{width:"300px"}},{default:t(()=>[(r(!0),m(O,null,F(e(rt),x=>(r(),i(e(z),{key:x,value:x},{default:t(()=>[y(b(e(T)(x)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),B("div",it,[B("div",ut,[s(e(j),{align:"start"},{default:t(()=>{var x,X,ee;return[(r(!0),m(O,null,F((X=(x=e(S).result.value)==null?void 0:x.columns)!=null?X:[],(d,te)=>(r(),i(e(j),{key:te,direction:"vertical"},{default:t(()=>[s(e(U),{style:{width:"250px"},"allow-clear":"",value:d.selected_stage.id,"onUpdate:value":g=>e(w)(g,te)},{default:t(()=>[(r(!0),m(O,null,F(d.stages,g=>(r(),i(e(z),{key:g.id,value:g.id},{default:t(()=>[s(e(C),{gap:"5"},{default:t(()=>[s(V,{path:e(H)(g.type),style:{"flex-shrink":"0"}},null,8,["path"]),s(e(G),{ellipsis:""},{default:t(()=>[y(b(g.title),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"]),d.selected_stage.id?(r(),i(e(j),{key:0,direction:"vertical",style:{width:"100%"}},{default:t(()=>[(r(!0),m(O,null,F(d.stage_run_cards,g=>{var ae;return r(),i(e(Be),{key:g.id,size:"small",style:{"max-width":"250px",cursor:"pointer"},"body-style":{display:((ae=g.content)==null?void 0:ae.length)>0?"block":"none"},onClick:N=>e(c)(d,g)},ue({title:t(()=>[s(e(pe),null,{default:t(()=>[y(b(e(Q)({status:g.status}).text),1)]),_:2},1024)]),default:t(()=>[s(W,{data:g.content},null,8,["data"]),y(" "+b(g.assignee),1)]),extra:t(()=>[s(e(qe),{onClick:N=>e(c)(d,g)},null,8,["onClick"])]),_:2},[g.status==="waiting"?{name:"actions",fn:t(()=>[e(p)(d,g)?(r(),i(E,{key:0,to:e(p)(d,g),target:"_blank",onClick:R[1]||(R[1]=N=>N.stopPropagation())},{default:t(()=>[s(e(oe))]),_:2},1032,["to"])):v("",!0),d.selected_stage.type==="script"?(r(),m("span",{key:1,onClick:N=>o(N,d.selected_stage.id,g.id)},[s(e(oe))],8,ct)):v("",!0)]),key:"0"}:void 0]),1032,["body-style","onClick"])}),128)),d.stage_run_cards.length===0?(r(),i(e(ce),{key:0})):v("",!0),e(I)(d)?(r(),i(e(ne),{key:1,style:{width:"100%"},onClick:g=>e(k)(d.selected_stage.id)},{default:t(()=>[y("See more")]),_:2},1032,["onClick"])):v("",!0),d.selected_stage.can_be_started&&e(p)(d)!==null?(r(),i(E,{key:2,target:"_blank",to:e(p)(d)},{default:t(()=>[s(e(ne),{style:{width:"100%"}},{default:t(()=>[y(" Start ")]),_:1})]),_:2},1032,["to"])):v("",!0)]),_:2},1024)):v("",!0)]),_:2},1024))),128)),e(S).result.value&&e(S).result.value.next_stage_options.length>0?(r(),i(e(U),{key:(ee=e(h))==null?void 0:ee.id,style:{width:"100%","min-width":"200px"},"allow-clear":"","onUpdate:value":R[2]||(R[2]=d=>e(w)(d,e(S).result.value.columns.length))},{default:t(()=>[(r(!0),m(O,null,F(e(S).result.value.next_stage_options,d=>(r(),i(e(z),{key:d.id,value:d.id},{default:t(()=>[s(e(C),{gap:"middle"},{default:t(()=>[s(V,{path:e(H)(d.type)},null,8,["path"]),s(e(G),null,{default:t(()=>[y(b(d.title),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1})):v("",!0)]}),_:1})])])]),_:1}),e(u).state==="stage-run"&&e(f)?(r(),i(st,{key:0,"kanban-repository":a.kanbanRepository,"stage-run":e(f),"stage-run-repository":a.stageRunRepository,onClose:e(P)},null,8,["kanban-repository","stage-run","stage-run-repository","onClose"])):v("",!0)])}}});const Kt=Y(dt,[["__scopeId","data-v-2a074c8a"]]);class jt{constructor(a=ge){this.fetch=a}async getData(a){return(await this.fetch("/_editor/api/kanban",{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}})).json()}async getLogs(a){return(await this.fetch(`/_editor/api/kanban/logs/${a}`)).json()}}class Vt{constructor(a,o=ge){this.authProvider=a,this.fetch=o}get headers(){return{"Content-Type":"application/json",...this.authProvider.authHeaders()}}async getData(a){return(await this.fetch("/_kanban/",{method:"POST",body:JSON.stringify(a),headers:this.headers})).json()}async getLogs(a){return(await this.fetch(`/_kanban/logs/${a}`,{headers:this.headers})).json()}}class qt{constructor(a,o=localStorage){this.contextKey=a,this.storage=o}makeKey(a){return`${this.contextKey}:${a}`}async get(a){const o=this.storage.getItem(this.makeKey(a));return o?JSON.parse(o):null}async set(a,o){this.storage.setItem(this.makeKey(a),JSON.stringify(o))}}export{jt as E,Kt as K,qt as L,Vt as P};
//# sourceMappingURL=repository.e68d48e9.js.map
