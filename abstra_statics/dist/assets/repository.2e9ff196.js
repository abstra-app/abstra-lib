import{f as o,eG as te,r as ae,H,F as _e,d as D,b as l,ev as b,w as n,aD as P,eC as x,eD as w,u as e,v as G,c as d,ar as v,cM as ye,cE as T,ex as A,bg as ve,eJ as ne,e as z,eI as V,aH as se,cm as re,eE as he,eF as Se,eP as be,a as oe,cD as le,ae as ie,bG as Z,eA as ke,o as we,L as Ae,dm as Re}from"./outputWidgets.c8053a9d.js";import{a as ue}from"./asyncComputed.f7e207a4.js";import"./workspaces.a3b629ff.js";import{S as Ie}from"./scripts.b9f6b166.js";import"./envVars.5548ab88.js";import{A as Ce,s as ce}from"./api.9882de13.js";import{A as Oe}from"./contracts.generated.9f8970a0.js";import{A as R}from"./index.5905e3dd.js";import{r as De,t as $e}from"./icons.9e4059c8.js";import{t as Pe}from"./ant-design.73b939ff.js";import{A as B}from"./Text.d464b589.js";import"./index.de5b2d01.js";import{A as K}from"./index.b514db2b.js";import{f as xe}from"./index.a5083d6e.js";import{A as Q}from"./Paragraph.68b1de18.js";import{A as q}from"./Title.ed86be86.js";import"./index.30346fa2.js";import{T as Fe,A as Ee}from"./Timeline.043554e9.js";import{A as de,C as pe}from"./CollapsePanel.f552f72c.js";import{A as Te}from"./Link.f6a9c742.js";import{A as ge}from"./index.9db1ec9c.js";import{A as Ue}from"./index.47a3f989.js";import{E as Le}from"./ExpandOutlined.9b73d8b7.js";import{C as Ne}from"./Card.6e0744ae.js";import{D as je}from"./DownOutlined.3c2069e5.js";import"./index.b8ded2bc.js";import{F as qe,A as ze}from"./Form.034d9295.js";(function(){try{var a=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(a._sentryDebugIds=a._sentryDebugIds||{},a._sentryDebugIds[t]="330ceda8-2e2a-4f15-8b78-4bc66a730358",a._sentryDebugIdIdentifier="sentry-dbid-330ceda8-2e2a-4f15-8b78-4bc66a730358")}catch{}})();var Be={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM641.7 520.8L442.3 677.6c-7.4 5.8-18.3.6-18.3-8.8V355.3c0-9.4 10.9-14.7 18.3-8.8l199.4 156.7a11.2 11.2 0 010 17.6z"}}]},name:"play-square",theme:"filled"};const Ve=Be;var He={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M168 504.2c1-43.7 10-86.1 26.9-126 17.3-41 42.1-77.7 73.7-109.4S337 212.3 378 195c42.4-17.9 87.4-27 133.9-27s91.5 9.1 133.8 27A341.5 341.5 0 01755 268.8c9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47a8 8 0 003 14.1l175.7 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c0-6.7-7.7-10.5-12.9-6.3l-56.4 44.1C765.8 155.1 646.2 92 511.8 92 282.7 92 96.3 275.6 92 503.8a8 8 0 008 8.2h60c4.4 0 7.9-3.5 8-7.8zm756 7.8h-60c-4.4 0-7.9 3.5-8 7.8-1 43.7-10 86.1-26.9 126-17.3 41-42.1 77.8-73.7 109.4A342.45 342.45 0 01512.1 856a342.24 342.24 0 01-243.2-100.8c-9.9-9.9-19.2-20.4-27.8-31.4l60.2-47a8 8 0 00-3-14.1l-175.7-43c-5-1.2-9.9 2.6-9.9 7.7l-.7 181c0 6.7 7.7 10.5 12.9 6.3l56.4-44.1C258.2 868.9 377.8 932 512.2 932c229.2 0 415.5-183.7 419.8-411.8a8 8 0 00-8-8.2z"}}]},name:"sync",theme:"outlined"};const Ke=He;function X(a){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?Object(arguments[t]):{},i=Object.keys(r);typeof Object.getOwnPropertySymbols=="function"&&(i=i.concat(Object.getOwnPropertySymbols(r).filter(function(s){return Object.getOwnPropertyDescriptor(r,s).enumerable}))),i.forEach(function(s){Me(a,s,r[s])})}return a}function Me(a,t,r){return t in a?Object.defineProperty(a,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):a[t]=r,a}var J=function(t,r){var i=X({},t,r.attrs);return o(te,X({},i,{icon:Ve}),null)};J.displayName="PlaySquareFilled";J.inheritAttrs=!1;const Ge=J;function ee(a){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?Object(arguments[t]):{},i=Object.keys(r);typeof Object.getOwnPropertySymbols=="function"&&(i=i.concat(Object.getOwnPropertySymbols(r).filter(function(s){return Object.getOwnPropertyDescriptor(r,s).enumerable}))),i.forEach(function(s){Je(a,s,r[s])})}return a}function Je(a,t,r){return t in a?Object.defineProperty(a,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):a[t]=r,a}var W=function(t,r){var i=ee({},t,r.attrs);return o(te,ee({},i,{icon:Ke}),null)};W.displayName="SyncOutlined";W.inheritAttrs=!1;const We=W;function Ye(){const a=ae({state:"closed"});function t(){a.value={state:"closed"}}function r(){a.value={state:"visualizations"}}function i(u,m){a.value={state:"stage-run",stageRun:m}}const s=H(()=>"stageRun"in a.value?a.value.stageRun:null);return{closeDrawer:t,openVisualizationEditor:r,inspectStageRun:i,drawerState:a,selectedStageRunForDrawer:s}}const U="kanban-selected-stage-ids",L=10,Ze=({kanbanRepository:a,storage:t,filterFactory:r,router:i})=>{const s=_e([]),u=ue(async()=>{try{const f=await a.getData({selection:s.value,filter:r()}),g=await t.get(U)||[];for(const _ of f.not_found_stages)t.set(U,g.filter(h=>h!==_)),s.value=s.value.filter(h=>h.stage_id!==_);return f}catch{return s.value=[],await t.set(U,[]),{columns:[],next_stage_options:[]}}});function m(f){const g=f.selected_stage.id,_=s.value.find(h=>h.stage_id===g);return _!=null&&_.limit?_.limit<f.total_count:!1}async function c(f){var _;const g=s.value.find(h=>h.stage_id===f.selected_stage.id);g&&(g.limit=((_=g.limit)!=null?_:0)+L,await u.refetch())}async function p(f){const g=s.value.find(_=>_.stage_id===f);g&&g.limit&&g.limit>L&&(g.limit-=L,await u.refetch())}async function y(){const f=await t.get(U)||[];s.value=f.map(g=>({stage_id:g,limit:L,offset:0}))}async function I(f,g){f?s.value=[...s.value.slice(0,g),{stage_id:f.id,limit:L,offset:0},...s.value.slice(g+1)]:s.value=[...s.value.slice(0,g),...s.value.slice(g+1)],await t.set(U,s.value.map(_=>_.stage_id)),await u.refetch()}async function F(f){await I(f,s.value.length)}let S=null;return{kanbanAsyncComputed:u,selection:s,increasePagination:c,hasPagination:m,seeLess:p,setStage:I,addStage:F,cardActionHandler:async(f,g)=>{const _=f.selected_stage,h=g.id;if(_.type==="script"){const k=await Ie.get(_.id);if(!k)return;await k.run(h)}if(_.type==="form"){const k=i.resolve({path:`/${_.path}`,query:h?{[Ce]:h}:{}});window.open(k.href,h)}},setup:async()=>{await y(),u.refetch(),S=setInterval(()=>{u.refetch()},1e3)},tearDown:()=>{S&&clearInterval(S)}}};function Y(a){switch(a.status){case"waiting":return{color:"blue",text:"Waiting"};case"running":return{color:"processing",text:"Running"};case"finished":return{color:"success",text:"Success"};case"failed":return{color:"error",text:"Failed"};case"abandoned":return{color:"warning",text:"Abandoned"}}}const N="Show All",Qe=[N,...Oe];function Xe(){const a=ae(N);return{filterStatus:a,filterFactory:()=>a.value==N?{}:{status:a.value},labelOption:i=>i==N?N:Y({status:i}).text}}const et={key:0},tt={key:1,class:"terminal"},at=D({__name:"ExecutionInspector",props:{logs:{}},setup(a){return(t,r)=>t.logs.length===0?(l(),b("span",et)):(l(),b("div",tt,[o(e(R),{vertical:""},{default:n(()=>[(l(!0),b(P,null,x(t.logs,i=>(l(),b("pre",{key:i.executionId,class:"log-text"},w(i.payload.text),1))),128))]),_:1})]))}});const nt=G(at,[["__scopeId","data-v-4e71a195"]]),M=D({__name:"StageRunData",props:{data:{}},setup(a){return(t,r)=>(l(),d(e(T),{direction:"vertical",style:{overflow:"hidden"}},{default:n(()=>[(l(!0),b(P,null,x(t.data,i=>(l(),b("div",{key:i.key},[o(e(B),{strong:""},{default:n(()=>[v(w(i.key),1)]),_:2},1024),o(e(ye),{"tree-data":e(Pe)(i.value),selectable:!1},null,8,["tree-data"])]))),128))]),_:1}))}}),st=a=>(he("data-v-68c9e478"),a=a(),Se(),a),rt={key:1},ot={key:1},lt=st(()=>z("span",null,"[Deleted Stage]",-1)),it=["onClick"],ut=D({__name:"StageRunInspector",props:{stageRun:{},kanbanRepository:{},stageRunRepository:{}},emits:["close"],setup(a,{emit:t}){const r=a;function i(c){return Object.entries(c).map(([p,y])=>({key:p,value:y,type:typeof y}))}const{result:s,loading:u}=ue(()=>{var c;return r.kanbanRepository.getLogs((c=r.stageRun)==null?void 0:c.id)}),m=(c,p)=>{var y;c.stopPropagation(),(y=r.stageRunRepository)==null||y.fork(p),t("close")};return(c,p)=>(l(),d(e(Ue),{open:"",title:"Thread details",size:"large",onClose:p[0]||(p[0]=y=>t("close"))},{extra:n(()=>[o(e(Q),null,{default:n(()=>[o(e(K),{style:{"font-weight":"600"}},{default:n(()=>{var y;return[v(w(e(Y)({status:(y=c.stageRun)==null?void 0:y.status}).text),1)]}),_:1}),v(" "+w(e(xe)(new Date(c.stageRun.created_at),{addSuffix:!0})),1)]),_:1})]),default:n(()=>{var y,I,F;return[(y=c.stageRun)!=null&&y.assignee?(l(),d(e(Q),{key:0},{default:n(()=>{var S;return[v(" Assignee: "+w((S=c.stageRun)==null?void 0:S.assignee),1)]}),_:1})):A("",!0),((I=c.stageRun)==null?void 0:I.content)&&((F=c.stageRun)==null?void 0:F.content.length)>0?(l(),b("div",rt,[o(e(q),{level:4},{default:n(()=>[v("Current data")]),_:1}),o(M,{data:c.stageRun.content},null,8,["data"])])):A("",!0),o(e(q),{level:4,style:{"margin-bottom":"30px"}},{default:n(()=>[v(" Timeline ")]),_:1}),e(u)?(l(),d(e(ve),{key:2})):e(s)?(l(),d(e(Fe),{key:3},{default:n(()=>[(l(!0),b(P,null,x(e(s),({stage:S,stage_run:C,logs:$})=>(l(),d(e(Ee),{key:C.id},{default:n(()=>[o(e(pe),{ghost:"","expand-icon-position":"end"},{default:n(()=>[o(e(de),{class:"panel"},ne({header:n(()=>[S?(l(),d(e(R),{key:0,align:"center",gap:15},{default:n(()=>[o(V,{path:e(ce)(S.type)},null,8,["path"]),$.length?(l(),b("span",ot,w(S.title),1)):(l(),d(e(se),{key:0,placement:"right",title:"No logs"},{default:n(()=>[v(w(S.title),1)]),_:2},1024))]),_:2},1024)):(l(),d(e(R),{key:1,align:"center",gap:15},{default:n(()=>[o(V,{path:e($e)},null,8,["path"]),lt]),_:1}))]),default:n(()=>[i(C.data).length||$.length?(l(),d(e(R),{key:0,vertical:""},{default:n(()=>[i(C.data).length?(l(),d(e(R),{key:0,gap:0,vertical:""},{default:n(()=>[o(e(q),{level:5},{default:n(()=>[v(" Output data ")]),_:1}),o(M,{data:i(C.data)},null,8,["data"])]),_:2},1024)):A("",!0),$.length?(l(),d(e(R),{key:1,vertical:"",gap:0},{default:n(()=>[o(e(ge)),o(e(q),{level:5},{default:n(()=>[v(" Logs ")]),_:1}),o(nt,{logs:$},null,8,["logs"])]),_:2},1024)):A("",!0)]),_:2},1024)):(l(),d(e(re),{key:1,description:"No logs"}))]),_:2},[c.stageRunRepository&&S?{name:"extra",fn:n(()=>[z("span",{onClick:j=>m(j,C.id)},[o(e(R),{gap:"small"},{default:n(()=>[o(V,{path:e(De),width:"22"},null,8,["path"]),o(e(Te),null,{default:n(()=>[v("Fork")]),_:1})]),_:1})],8,it)]),key:"0"}:void 0]),1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):A("",!0)]}),_:1}))}});const ct=G(ut,[["__scopeId","data-v-68c9e478"]]),dt=D({__name:"Card",props:{stage:{},card:{}},emits:["inspect","action"],setup(a){const t=a,r=H(()=>Y({status:t.card.status}).text),i=H(()=>be(new Date(String(t.card.updated_at))));return(s,u)=>{var m;return l(),d(e(Ne),{size:"small",style:{width:"275px",cursor:"pointer"},"body-style":{display:((m=s.card.content)==null?void 0:m.length)>0?"block":"none"}},ne({title:n(()=>[o(e(K),null,{default:n(()=>[v(w(r.value)+" ",1),r.value==="Running"?(l(),d(e(We),{key:0,spin:!0,style:{"margin-left":"4px"}})):A("",!0)]),_:1})]),default:n(()=>[o(e(T),{direction:"vertical",style:{"max-height":"300px",width:"100%",overflow:"hidden"},onClick:u[0]||(u[0]=c=>s.$emit("inspect"))},{default:n(()=>[o(M,{data:s.card.content,disabled:!0},null,8,["data"]),s.card.assignee?(l(),d(e(K),{key:0},{default:n(()=>[v(w(s.card.assignee),1)]),_:1})):A("",!0)]),_:1})]),extra:n(()=>[o(e(R),{gap:"10"},{default:n(()=>[o(e(se),null,{title:n(()=>[v(w(s.card.updated_at),1)]),default:n(()=>[o(e(B),{type:"secondary",style:{"font-size":"12px"}},{default:n(()=>[v(w(i.value),1)]),_:1})]),_:1}),o(e(Le),{onClick:u[2]||(u[2]=c=>s.$emit("inspect"))})]),_:1})]),_:2},[s.card.status==="waiting"?{name:"actions",fn:n(()=>[o(e(Ge),{onClick:u[1]||(u[1]=c=>s.$emit("action"))})]),key:"0"}:void 0]),1032,["body-style"])}}}),fe=D({__name:"ColumnHeader",props:{stageOptions:{},stage:{},stageCount:{}},emits:["stageUpdate"],setup(a,{emit:t}){const r=a,i=s=>{const u=r.stageOptions.find(m=>m.id===s);t("stageUpdate",u!=null?u:null)};return(s,u)=>{var c;const m=oe("icon");return l(),d(e(ie),{style:{width:"275px"},"allow-clear":"",value:((c=s.stage)==null?void 0:c.id)||"","onUpdate:value":i},{suffixIcon:n(()=>[o(e(B),{type:"secondary",style:{"font-size":"small","margin-right":"2px"}},{default:n(()=>[v(w(s.stageCount),1)]),_:1}),o(e(ge),{type:"vertical"}),o(e(je))]),default:n(()=>[(l(!0),b(P,null,x(s.stageOptions,p=>(l(),d(e(le),{key:p.id,value:p.id},{default:n(()=>[o(e(R),{gap:"10",style:{"max-width":"200px"}},{default:n(()=>[o(m,{path:e(ce)(p.type),style:{"flex-shrink":"0",width:"24px"}},null,8,["path"]),o(e(B),{ellipsis:"",content:p.title},null,8,["content"])]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])}}});class pt{constructor(t){this.column=t}get stage(){return this.column.selected_stage}get launchLink(){return!this.stage.can_be_started||this.stage.type!=="form"?null:{path:`/${this.stage.path}`,query:{}}}}const gt=D({__name:"Column",props:{hasPagination:{type:Boolean},column:{}},emits:["increasePagination","cardInspection","cardAction","stageUpdate"],setup(a,{emit:t}){const r=a,s=new pt(r.column).launchLink;return(u,m)=>{const c=oe("router-link");return l(),d(e(T),{direction:"vertical"},{default:n(()=>[o(fe,{"stage-options":u.column.stages,stage:u.column.selected_stage,"stage-count":u.column.total_count,onStageUpdate:m[0]||(m[0]=p=>t("stageUpdate",p))},null,8,["stage-options","stage","stage-count"]),o(e(T),{direction:"vertical",style:{width:"100%"}},{default:n(()=>[u.column.stage_run_cards.length===0?(l(),d(e(re),{key:0})):A("",!0),(l(!0),b(P,null,x(u.column.stage_run_cards,p=>(l(),d(dt,{key:p.id,stage:u.column.selected_stage,card:p,onInspect:y=>t("cardInspection",p),onAction:y=>t("cardAction",p)},null,8,["stage","card","onInspect","onAction"]))),128)),u.hasPagination?(l(),d(e(Z),{key:1,style:{width:"100%"},onClick:m[1]||(m[1]=p=>t("increasePagination"))},{default:n(()=>[v("See more")]),_:1})):A("",!0),e(s)?(l(),d(c,{key:2,target:"_blank",to:e(s)},{default:n(()=>[o(e(Z),{style:{width:"100%"}},{default:n(()=>[v(" Start ")]),_:1})]),_:1},8,["to"])):A("",!0)]),_:1})]),_:1})}}}),ft=D({__name:"EmptyColumn",props:{stages:{}},emits:["stageUpdate"],setup(a,{emit:t}){const r=i=>{t("stageUpdate",i)};return(i,s)=>(l(),d(e(T),{direction:"vertical"},{default:n(()=>[o(fe,{"stage-options":i.stages,onStageUpdate:r},null,8,["stage-options"])]),_:1}))}}),mt={style:{width:"100%",padding:"20px"}},_t={class:"stages-container"},yt={class:"stages-content"},vt=D({__name:"Kanban",props:{storage:{},kanbanRepository:{},stageRunRepository:{}},setup(a){const t=a,r=ke(),{closeDrawer:i,inspectStageRun:s,drawerState:u,selectedStageRunForDrawer:m}=Ye(),{filterFactory:c,filterStatus:p,labelOption:y}=Xe(),{kanbanAsyncComputed:I,setStage:F,addStage:S,setup:C,tearDown:$,cardActionHandler:j,increasePagination:f,hasPagination:g}=Ze({kanbanRepository:t.kanbanRepository,storage:t.storage,filterFactory:c,router:r});return we(C),Ae($),(_,h)=>(l(),b("div",mt,[o(e(R),{vertical:"",style:{height:"100%"}},{default:n(()=>[o(e(pe),{ghost:""},{default:n(()=>[o(e(de),{header:"Filters"},{default:n(()=>[o(e(qe),null,{default:n(()=>[o(e(ze),{label:"Status"},{default:n(()=>[o(e(ie),{value:e(p),"onUpdate:value":h[0]||(h[0]=k=>Re(p)?p.value=k:null),style:{width:"325px"}},{default:n(()=>[(l(!0),b(P,null,x(e(Qe),k=>(l(),d(e(le),{key:k,value:k},{default:n(()=>[v(w(e(y)(k)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),z("div",_t,[z("div",yt,[o(e(T),{align:"start"},{default:n(()=>{var k;return[(l(!0),b(P,null,x(((k=e(I).result.value)==null?void 0:k.columns)||[],(O,me)=>(l(),d(e(gt),{key:O.selected_stage.id,column:O,"has-pagination":e(g)(O),onIncreasePagination:E=>e(f)(O),onCardInspection:E=>e(s)(O,E),onCardAction:E=>e(j)(O,E),onStageUpdate:E=>e(F)(E,me)},null,8,["column","has-pagination","onIncreasePagination","onCardInspection","onCardAction","onStageUpdate"]))),128)),o(e(ft),{stages:e(I).result.value.next_stage_options||[],onStageUpdate:h[1]||(h[1]=O=>e(S)(O))},null,8,["stages"])]}),_:1})])])]),_:1}),e(u).state==="stage-run"&&e(m)?(l(),d(e(ct),{key:0,"kanban-repository":t.kanbanRepository,"stage-run":e(m),"stage-run-repository":t.stageRunRepository,onClose:e(i)},null,8,["kanban-repository","stage-run","stage-run-repository","onClose"])):A("",!0)]))}});const Mt=G(vt,[["__scopeId","data-v-f660bc8e"]]);class Gt{constructor(t,r=localStorage){this.contextKey=t,this.storage=r}makeKey(t){return`${this.contextKey}:${t}`}async get(t){const r=this.storage.getItem(this.makeKey(t));return r?JSON.parse(r):null}async set(t,r){this.storage.setItem(this.makeKey(t),JSON.stringify(r))}}export{Mt as K,Gt as L};
//# sourceMappingURL=repository.2e9ff196.js.map
