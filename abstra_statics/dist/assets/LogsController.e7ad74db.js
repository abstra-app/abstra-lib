var j=Object.defineProperty;var O=(c,t,a)=>t in c?j(c,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):c[t]=a;var u=(c,t,a)=>(O(c,typeof t!="symbol"?t+"":t,a),a);import{d as C,am as H,c as v,o,a5 as p,a7 as F,h as x,e6 as B,e as f,a as b,b as h,aR as E,ec as P,a6 as L,ed as S,u as l,da as w,g as A,de as D,_ as R,f as g,aV as V,ea as $,d1 as z,cH as Z,ae as N,w as k,em as q}from"./jwt-decode.esm.1b301f74.js";import{t as W}from"./ant-design.1cc60cde.js";import{c as T}from"./string.4796d44a.js";import{I}from"./PhCopy.vue.70df4792.js";import{A as J}from"./index.e189c6ed.js";import{A as G,C as Q}from"./router.99a53337.js";import{B as U}from"./build.261de82e.js";import"./tables.13d62f0c.js";import{e as X}from"./repository.4920fb3b.js";import{u as Y}from"./polling.a3bae209.js";(function(){try{var c=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(c._sentryDebugIds=c._sentryDebugIds||{},c._sentryDebugIds[t]="a05808ef-0899-4460-a5ed-6c30f21a761d",c._sentryDebugIdIdentifier="sentry-dbid-a05808ef-0899-4460-a5ed-6c30f21a761d")}catch{}})();const K=["width","height","fill","transform"],tt={key:0},et=f("path",{d:"M72,104a16,16,0,1,1,16,16A16,16,0,0,1,72,104Zm96,16a16,16,0,1,0-16-16A16,16,0,0,0,168,120Zm68-40V192a36,36,0,0,1-36,36H56a36,36,0,0,1-36-36V80A36,36,0,0,1,56,44h60V16a12,12,0,0,1,24,0V44h60A36,36,0,0,1,236,80Zm-24,0a12,12,0,0,0-12-12H56A12,12,0,0,0,44,80V192a12,12,0,0,0,12,12H200a12,12,0,0,0,12-12Zm-12,82a30,30,0,0,1-30,30H86a30,30,0,0,1,0-60h84A30,30,0,0,1,200,162Zm-80-6v12h16V156ZM86,168H96V156H86a6,6,0,0,0,0,12Zm90-6a6,6,0,0,0-6-6H160v12h10A6,6,0,0,0,176,162Z"},null,-1),at=[et],st={key:1},it=f("path",{d:"M200,56H56A24,24,0,0,0,32,80V192a24,24,0,0,0,24,24H200a24,24,0,0,0,24-24V80A24,24,0,0,0,200,56ZM164,184H92a20,20,0,0,1,0-40h72a20,20,0,0,1,0,40Z",opacity:"0.2"},null,-1),ot=f("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Zm4,28H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24Z"},null,-1),rt=[it,ot],nt={key:2},lt=f("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48ZM172,96a12,12,0,1,1-12,12A12,12,0,0,1,172,96ZM96,184H80a16,16,0,0,1,0-32H96ZM84,120a12,12,0,1,1,12-12A12,12,0,0,1,84,120Zm60,64H112V152h32Zm32,0H160V152h16a16,16,0,0,1,0,32Z"},null,-1),ct=[lt],dt={key:3},pt=f("path",{d:"M200,50H134V16a6,6,0,0,0-12,0V50H56A30,30,0,0,0,26,80V192a30,30,0,0,0,30,30H200a30,30,0,0,0,30-30V80A30,30,0,0,0,200,50Zm18,142a18,18,0,0,1-18,18H56a18,18,0,0,1-18-18V80A18,18,0,0,1,56,62H200a18,18,0,0,1,18,18ZM74,108a10,10,0,1,1,10,10A10,10,0,0,1,74,108Zm88,0a10,10,0,1,1,10,10A10,10,0,0,1,162,108Zm2,30H92a26,26,0,0,0,0,52h72a26,26,0,0,0,0-52Zm-22,12v28H114V150ZM78,164a14,14,0,0,1,14-14h10v28H92A14,14,0,0,1,78,164Zm86,14H154V150h10a14,14,0,0,1,0,28Z"},null,-1),ht=[pt],ut={key:4},gt=f("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16Zm-52-56H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Z"},null,-1),ft=[gt],mt={key:5},yt=f("path",{d:"M200,52H132V16a4,4,0,0,0-8,0V52H56A28,28,0,0,0,28,80V192a28,28,0,0,0,28,28H200a28,28,0,0,0,28-28V80A28,28,0,0,0,200,52Zm20,140a20,20,0,0,1-20,20H56a20,20,0,0,1-20-20V80A20,20,0,0,1,56,60H200a20,20,0,0,1,20,20ZM76,108a8,8,0,1,1,8,8A8,8,0,0,1,76,108Zm88,0a8,8,0,1,1,8,8A8,8,0,0,1,164,108Zm0,32H92a24,24,0,0,0,0,48h72a24,24,0,0,0,0-48Zm-20,8v32H112V148ZM76,164a16,16,0,0,1,16-16h12v32H92A16,16,0,0,1,76,164Zm88,16H152V148h12a16,16,0,0,1,0,32Z"},null,-1),xt=[yt],bt={name:"PhRobot"},_t=C({...bt,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(c){const t=c,a=H("weight","regular"),s=H("size","1em"),i=H("color","currentColor"),n=H("mirrored",!1),d=v(()=>{var r;return(r=t.weight)!=null?r:a}),y=v(()=>{var r;return(r=t.size)!=null?r:s}),e=v(()=>{var r;return(r=t.color)!=null?r:i}),m=v(()=>t.mirrored!==void 0?t.mirrored?"scale(-1, 1)":void 0:n?"scale(-1, 1)":void 0);return(r,_)=>(o(),p("svg",B({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:y.value,height:y.value,fill:e.value,transform:m.value},r.$attrs),[F(r.$slots,"default"),d.value==="bold"?(o(),p("g",tt,at)):d.value==="duotone"?(o(),p("g",st,rt)):d.value==="fill"?(o(),p("g",nt,ct)):d.value==="light"?(o(),p("g",dt,ht)):d.value==="regular"?(o(),p("g",ut,ft)):d.value==="thin"?(o(),p("g",mt,xt)):x("",!0)],16,K))}}),At={key:0,class:"cli"},Ht={key:0},vt=C({__name:"LogContainer",props:{logs:{}},setup(c){return(t,a)=>(o(),b(l(D),{vertical:"",gap:"small"},{default:h(()=>[t.logs.entries.length?(o(),p("div",At,[(o(!0),p(E,null,P(t.logs.entries,s=>(o(),p("p",{key:s.createdAt,style:L({margin:0,"white-space":"pre-wrap",color:s.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},[s.payload.text?(o(),p("span",Ht,S(s.payload.text.trim()),1)):x("",!0)],4))),128))])):(o(),b(l(w),{key:1,type:"secondary"},{default:h(()=>[A("Empty")]),_:1}))]),_:1}))}});const Ft=R(vt,[["__scopeId","data-v-b7f04a41"]]),Zt={key:0},wt=["onClick"],Vt=["onClick"],kt=C({__name:"ExecutionContext",props:{data:{},showFixWithAi:{type:Boolean},isSmartChatIdle:{type:Boolean}},emits:["ask-ai"],setup(c,{emit:t}){const a=c,s=e=>{if(e==="legacyThreadData")return"Thread data";const m=T(e);return m.replace(/([A-Z])/g," $1").trim(),m},i=e=>e==null?!0:Array.isArray(e)?e.length===0:typeof e=="object"?Object.keys(e).length===0:!1,n=e=>{typeof e=="object"&&e!==null&&"payload"in e?(navigator.clipboard.writeText(JSON.stringify(e.payload)),Z.success({content:"Copied to clipboard"})):(navigator.clipboard.writeText(""),Z.error({content:"No payload to copy"}))},d=e=>{e.stopPropagation(),a.isSmartChatIdle!==!1&&t("ask-ai")},y=e=>{typeof e=="object"?(navigator.clipboard.writeText(JSON.stringify(e)),Z.success({content:"Copied to clipboard"})):(navigator.clipboard.writeText(""),Z.error({content:"Failed to copy request"}))};return(e,m)=>(o(),b(l(Q),{bordered:!1,style:{"background-color":"transparent",width:"100%"}},{default:h(()=>[g(l(G),{key:"execution-context"},{header:h(()=>[g(l(D),{justify:"space-between"},{default:h(()=>[g(l(w),null,{default:h(()=>[A("Execution context")]),_:1}),g(l(V),{title:e.isSmartChatIdle?"":"Wait or stop the response first",placement:"left"},{default:h(()=>[e.showFixWithAi?(o(),p("div",{key:0,class:$(["ask-to-ai",{disabled:!e.isSmartChatIdle}]),onClick:d},[A(" Fix with AI "),g(l(_t),{size:16})],2)):x("",!0)]),_:1},8,["title"])]),_:1})]),default:h(()=>[g(l(J),{direction:"vertical",style:{"border-radius":"5px",padding:"10px",color:"#fff",width:"100%","font-family":"monospace","max-height":"600px",overflow:"auto",border:"1px solid #e8e8e8"}},{default:h(()=>[Object.keys(e.data).length?(o(!0),p(E,{key:1},P(Object.entries(e.data),([r,_])=>(o(),p("div",{key:r,class:"tree"},[r!=="legacyThreadData"||!i(_)?(o(),p("div",Zt,[g(l(w),{strong:""},{default:h(()=>[A(S(s(r)),1)]),_:2},1024),r==="request"?(o(),b(l(V),{key:0,title:"Copy Request Data"},{default:h(()=>[f("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:M=>y(_)},[g(l(I))],8,wt)]),_:2},1024)):x("",!0),r==="triggerTask"?(o(),b(l(V),{key:1,title:"Copy Payload Data"},{default:h(()=>[f("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:M=>n(_)},[g(l(I))],8,Vt)]),_:2},1024)):x("",!0),g(l(z),{"tree-data":l(W)(_),selectable:!1},null,8,["tree-data"])])):x("",!0)]))),128)):(o(),b(l(w),{key:0,type:"secondary"},{default:h(()=>[A("Empty")]),_:1}))]),_:1})]),_:1})]),_:1}))}});const Bt=R(kt,[["__scopeId","data-v-cdd3162a"]]);class Lt{constructor(t){u(this,"state");u(this,"polling",Y({task:()=>this.refetch(),interval:1e4}));u(this,"executionRepository");u(this,"buildRepository");u(this,"projectId");u(this,"pool");u(this,"onFilterChange");u(this,"handleFilterChange",()=>{this.state.currentPage.waitingDebounce=!0,this.state.pagination.currentIndex=1,this.debouncedPageRefetch(),this.onFilterChange&&this.onFilterChange(this.state.filters)});u(this,"debouncedPageRefetch",q.exports.debounce(async()=>{await this.fetchPage(),this.state.currentPage.waitingDebounce=!1},500));u(this,"fetchEmptyLogs",()=>{this.state.currentPage.openedExecutionIds.forEach(async t=>{this.state.currentPage.executionData[t]||await this.fetchExecutionDetails(t)})});const{executionRepository:a,buildRepository:s,projectId:i,filters:n={},pagination:d={},pool:y=!1,openedExecutionId:e,onFilterChange:m}=t;this.executionRepository=a,this.buildRepository=s,this.projectId=i,this.pool=y,this.onFilterChange=m,this.state=N({currentPage:{openedExecutionIds:e?[e]:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],executionData:{}},pagination:{currentIndex:1,pageSize:10,totalCount:0,...d},filters:{dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0,...n},filterOptions:{builds:[],stages:[],statuses:X.map(r=>({label:T(r),value:r}))}}),k(()=>this.state.filters.buildId,()=>{this.fetchStageOptions()}),k(this.state.filters,()=>{this.state.currentPage.openedExecutionIds=[],this.handleFilterChange()}),k(this.state.pagination,()=>{this.state.currentPage.openedExecutionIds=[],this.fetchPage()})}async init(){await Promise.all([this.fetchPage(),this.fetchOptions()]),this.fetchEmptyLogs(),this.pool&&this.polling.startPolling()}teardown(){this.polling.endPolling()}async getNewestExecutionId(t){let a=this.state.currentPage.executions;return t&&(a=a.filter(i=>i.stageId===t)),a.length===0?null:a.reduce((i,n)=>i.createdAt>n.createdAt?i:n).id}async fetchPage(){var s,i,n,d;this.state.currentPage.loadingExecutions=!0;const{executions:t,totalCount:a}=await this.executionRepository.list({projectId:this.projectId,buildId:this.state.filters.buildId,status:this.state.filters.status,limit:this.state.pagination.pageSize,offset:(this.state.pagination.currentIndex-1)*this.state.pagination.pageSize,stageId:this.state.filters.stageId,startDate:(i=(s=this.state.filters.dateRange)==null?void 0:s[0])==null?void 0:i.toISOString(),endDate:(d=(n=this.state.filters.dateRange)==null?void 0:n[1])==null?void 0:d.toISOString(),search:this.state.filters.search});this.state.currentPage.loadingExecutions=!1,this.state.currentPage.executions=t,this.state.pagination.totalCount=a}async fetchBuildOptions(){if(!this.buildRepository)return;const a=(await this.buildRepository.list(this.projectId)).map(s=>({label:`[${s.id.slice(0,8)}] ${s.createdAt.toLocaleString()} ${s.latest?"(Latest)":""}`,value:s.id}));this.state.filterOptions.builds=a}async fetchStageOptions(){var s;if(!this.buildRepository){const n=(await this.executionRepository.fetchStages()).map(d=>({label:d.title,value:d.id}));this.state.filterOptions.stages=n!=null?n:[];return}const t=await U.get((s=this.state.filters.buildId)!=null?s:this.state.filterOptions.builds[0].value),a=t==null?void 0:t.runtimes.map(i=>({label:i.title,value:i.id}));this.state.filterOptions.stages=a!=null?a:[]}async fetchOptions(){await this.fetchBuildOptions(),await this.fetchStageOptions()}async fetchExecutionDetails(t){const[a,s,i]=await Promise.all([this.executionRepository.fetchLogs(this.projectId,t),this.executionRepository.fetchThreadData(this.projectId,t),this.executionRepository.getExecutionTasks(this.projectId,t)]);this.state.currentPage.executionData[t]={logs:a,threadData:s,tasks:{triggerTask:i.triggerTask?{type:i.triggerTask.type,payload:i.triggerTask.payload}:null,sentTasks:i.sentTasks.map(n=>({type:n.type,payload:n.payload}))}}}async refetch(){this.state.currentPage.openedExecutionIds.map(t=>this.fetchExecutionDetails(t))}}export{Bt as E,Ft as L,Lt as a};
//# sourceMappingURL=LogsController.e7ad74db.js.map
