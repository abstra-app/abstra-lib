import{C as T}from"./router-BfX34XLs.js";import{d as lt,r as C,P as O,a9 as ut,H as q,c as dt,a as K,p as S,e as p,u as c,v as G,w,b,g as _,M,W as tt,K as gt,U as z,c5 as ft,ak as U,S as R,aN as et,j as v,A as B,ae as y,E as pt,h as X,bC as ht,bs as L}from"./jwt-decode.esm-X_JHyrHe.js";import{a as xt}from"./build-BBu8uuN_.js";import{c as at}from"./string-DXA1IHkK.js";import"./tables-DRvslhiY.js";import{u as mt}from"./polling-BCWbcVpw.js";import{t as yt}from"./ant-design-BcHu_TfS.js";import{I as Y}from"./PhCopy.vue-D4jT_0ke.js";import{G as wt}from"./PhRobot.vue-CYXzGMGB.js";import{S as bt}from"./index-D_wdY2um.js";(function(){try{var n=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},a=new Error().stack;a&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[a]="302f9ea5-2763-4926-a96b-c31e61064cbe",n._sentryDebugIdIdentifier="sentry-dbid-302f9ea5-2763-4926-a96b-c31e61064cbe")}catch{}})();const vt=["running","lock-failed","failed","finished","abandoned"];class F{constructor(a){this.dto=a}static from(a){return new F(a)}get entries(){return this.dto.sort((a,t)=>a.sequence-t.sequence).filter(a=>a.event!=="form-message")}}class N{constructor(a){this.dto=a}static from(a){return new N(a)}get id(){return this.dto.id}get shortId(){return this.dto.id.slice(0,8)}get createdAt(){return new Date(this.dto.createdAt)}get updatedAt(){return new Date(this.dto.updatedAt)}get status(){return this.dto.status}get context(){return this.dto.context}get buildId(){return this.dto.buildId??""}get stageId(){return this.dto.stageId}get duration_seconds(){return`${(((this.dto.updatedAt?new Date(this.dto.updatedAt).getTime():Date.now())-this.createdAt.getTime())/1e3).toFixed(3)} s`}get stageRunId(){return this.dto.stageRunId}get projectId(){return this.dto.projectId}}class qt{async list({projectId:a,...t}){const s={...t,offset:t.offset?.toString(),limit:t.limit?.toString()};Object.keys(s).forEach(o=>s[o]===void 0&&delete s[o]);const i=await T.get(`projects/${a}/executions`,s);return{executions:i.executions.map(o=>N.from(o)),totalCount:i.totalCount}}async fetchLogs(a,t,s){const i={};s?.limit!==void 0&&(i.limit=s.limit.toString()),s?.offset!==void 0&&(i.offset=s.offset.toString());const o=Object.keys(i).length>0?`?${new URLSearchParams(i).toString()}`:"",g=await T.get(`projects/${a}/executions/${t}/logs${o}`);return{logs:F.from(g.logs),totalCount:g.totalCount}}async fetchThreadData(a,t){return(await T.get(`projects/${a}/executions/${t}/thread-data`)).response}async get(a,t){const{executions:s}=await this.list({projectId:a,limit:1,search:t}),i=s.find(o=>o.id===t);if(i)return i;throw new Error(`Execution ${t} not found`)}async getExecutionTasks(a,t){return await T.get(`projects/${a}/executions/${t}/tasks`)}async fetchStages(){throw new Error("Method not implemented.")}async stopExecution(a,t){await T.post(`projects/${a}/executions/${t}/stop`,{})}async clear(){throw new Error("Method not implemented.")}}class Bt{async list(a){const t={...a,offset:a.offset?.toString(),limit:a.limit?.toString()};Object.keys(t).forEach(r=>t[r]===void 0&&delete t[r]);const s=Object.fromEntries(Object.entries(t??{}).filter(([,r])=>r!=null)),i=Object.keys(s).length>0?`?${new URLSearchParams(s).toString()}`:"",g=await(await fetch(`/_editor/api/executions${i}`)).json();return{executions:g.executions.map(r=>N.from(r)),totalCount:g.totalCount}}async fetchLogs(a,t,s){const o=await(await fetch(`/_editor/api/logs/${t}`)).json();return{logs:F.from(o),totalCount:o.length}}async fetchThreadData(){return{}}async get(a,t){const{executions:s}=await this.list({limit:1,search:t}),i=s.find(o=>o.id===t);if(i)return i;throw new Error(`Execution ${t} not found`)}async getExecutionTasks(a,t){return await(await fetch(`/_editor/api/executions/${t}/tasks`)).json()}async fetchStages(){return await(await fetch("/_editor/api/executions/stages")).json()}async stopExecution(a,t){if(!(await fetch(`/_editor/api/executions/${t}/stop`,{method:"POST"})).ok)throw new Error(`Failed to stop execution ${t}`)}async clear(){await fetch("/_editor/api/executions/clear",{method:"DELETE"})}}const $=300,Gt=lt("logs",()=>{const n=C(null),a=C(null),t=C(""),s=C(!1),i=C(),o=O({openedExecutionIds:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],executionData:{}}),g=O({currentIndex:1,pageSize:10,totalCount:0}),r=O({dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0}),m=O({builds:[],stages:[],statuses:vt.map(e=>({label:at(e),value:e}))}),I=mt({task:()=>Z(),interval:1e4}),l=async e=>{n.value=e.executionRepository,a.value=e.buildRepository,t.value=e.projectId,s.value=e.pool??!1,i.value=e.onFilterChange,Object.assign(r,e.filters||{}),Object.assign(g,e.pagination||{}),e.openedExecutionId&&(o.openedExecutionIds=[e.openedExecutionId]),await Promise.all([x(),W()]),J(),s.value&&I.startPolling()},D=()=>{I.endPolling()},x=async()=>{if(n.value){o.loadingExecutions=!0;try{const{executions:e,totalCount:u}=await n.value.list({projectId:t.value,buildId:r.buildId,status:r.status,limit:g.pageSize,offset:(g.currentIndex-1)*g.pageSize,stageId:r.stageId,startDate:r.dateRange?.[0]?.toISOString(),endDate:r.dateRange?.[1]?.toISOString(),search:r.search});o.executions=e,g.totalCount=u}finally{o.loadingExecutions=!1}}},E=async()=>{if(!a.value){m.builds=[];return}const u=(await a.value.list(t.value)).map(d=>({label:`[${d.id.slice(0,8)}] ${d.createdAt.toLocaleString()} ${d.latest?"(Latest)":""}`,value:d.id}));m.builds=u},P=async()=>{if(!n.value)return;if(!a.value){const h=(await n.value.fetchStages()).map(k=>({label:k.title,value:k.id}));m.stages=h??[];return}const e=r.buildId??(m.builds.length>0?m.builds[0].value:void 0);if(!e){console.warn("No buildId available for fetching stage options"),m.stages=[];return}const d=(await xt.get(e))?.runtimes.map(f=>({label:f.title,value:f.id}));m.stages=d??[]},W=async()=>{try{await E(),await P()}catch(e){console.error("Error fetching options:",e)}},j=async(e,u)=>{if(!n.value)return;const d=o.executionData[e],f=u||{limit:$,offset:0},[h,k,A]=await Promise.all([n.value.fetchLogs(t.value,e,f),n.value.fetchThreadData(t.value,e),n.value.getExecutionTasks(t.value,e)]),ct={currentIndex:1,pageSize:$,totalCount:h.totalCount,loading:!1};o.executionData[e]={logs:h.logs,threadData:k,tasks:{triggerTask:A.triggerTask?{type:A.triggerTask.type,payload:A.triggerTask.payload}:null,sentTasks:A.sentTasks.map(V=>({type:V.type,payload:V.payload}))},logsPagination:d?.logsPagination||ct},o.executionData[e].logsPagination&&(o.executionData[e].logsPagination.totalCount=h.totalCount,o.executionData[e].logsPagination.loading=!1)},J=()=>{o.openedExecutionIds.forEach(async e=>{o.executionData[e]||await j(e,{limit:$,offset:0})})},Z=async()=>{o.openedExecutionIds.map(e=>{const u=o.executions.find(f=>f.id===e);if(!u||u.status!=="running")return;const d=o.executionData[e];if(d?.logsPagination){const{currentIndex:f,pageSize:h}=d.logsPagination,k=(f-1)*h;return j(e,{limit:h,offset:k})}else return j(e,{limit:$,offset:0})})},H=()=>{o.waitingDebounce=!0,g.currentIndex=1,ot(),i.value&&i.value(r)},ot=ut.debounce(async()=>{await x(),o.waitingDebounce=!1},500),nt=async e=>{let u=o.executions;return e&&(u=u.filter(f=>f.stageId===e)),u.length===0?null:u.reduce((f,h)=>f.createdAt>h.createdAt?f:h).id},Q=async(e,u)=>{const d=o.executionData[e];if(!d?.logsPagination)return;const{pageSize:f}=d.logsPagination;d.logsPagination.loading=!0,d.logsPagination.currentIndex=u;const h=(u-1)*f;await j(e,{limit:f,offset:h})},st=(e,u)=>{const d=o.executionData[e];d?.logsPagination&&(d.logsPagination.pageSize=u,d.logsPagination.currentIndex=1,Q(e,1))},it=async e=>{if(n.value)try{await n.value.stopExecution(t.value,e)}catch(u){console.error("Failed to stop execution",u)}finally{await x()}},rt=async()=>{n.value&&(await n.value.clear(),await x())};return q(()=>r.buildId,()=>{P()}),q(r,()=>{o.openedExecutionIds=[],H()}),q([()=>g.currentIndex,()=>g.pageSize],()=>{o.openedExecutionIds=[],x()}),{state:dt(()=>({currentPage:o,pagination:g,filters:r,filterOptions:m})),currentPage:o,pagination:g,filters:r,filterOptions:m,init:l,teardown:D,fetchPage:x,fetchBuildOptions:E,fetchStageOptions:P,fetchOptions:W,fetchExecutionDetails:j,fetchEmptyLogs:J,refetch:Z,handleFilterChange:H,getNewestExecutionId:nt,fetchExecutionLogsPage:Q,setExecutionLogsPageSize:st,stopExecution:it,clear:rt,polling:I}}),_t={key:0,class:"cli"},Et={key:0},St=K({__name:"LogContainer",props:{logs:{},pagination:{}},emits:["page-change"],setup(n){return(a,t)=>(p(),S(c(G),{vertical:"",gap:"small"},{default:w(()=>[n.logs.entries.length?(p(),b("div",_t,[(p(!0),b(M,null,tt(n.logs.entries,s=>(p(),b("p",{key:s.createdAt,style:gt({margin:0,"white-space":"pre-wrap",color:s.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},[s.payload.text?(p(),b("span",Et,z(s.payload.text.trim()),1)):_("",!0)],4))),128))])):_("",!0),n.pagination?(p(),S(c(G),{key:1,vertical:"",gap:"small",align:"end"},{default:w(()=>[n.pagination.totalCount>c($)?(p(),S(c(ft),{key:0,current:n.pagination.currentIndex,"page-size":n.pagination.pageSize,total:n.pagination.totalCount,"show-size-changer":!1,"show-quick-jumper":!1,size:"small",onChange:t[0]||(t[0]=s=>a.$emit("page-change",s))},null,8,["current","page-size","total"])):_("",!0)]),_:1})):n.logs.entries.length?_("",!0):(p(),S(c(U),{key:2,type:"secondary"},{default:w(()=>[...t[1]||(t[1]=[R("Empty",-1)])]),_:1}))]),_:1}))}}),Mt=et(St,[["__scopeId","data-v-ee1d10cd"]]),kt={key:0},Ct=["onClick"],It=["onClick"],Dt=K({__name:"ExecutionContext",props:{data:{},showFixWithAi:{type:Boolean},isSmartChatIdle:{type:Boolean}},emits:["ask-ai"],setup(n,{emit:a}){const t=n,s=a,i=C(!1),o=l=>{if(l==="legacyThreadData")return y.translate("i18n_executioncontext_thread_data");const D=at(l);return D.replace(/([A-Z])/g," $1").trim(),D},g=l=>l==null?!0:Array.isArray(l)?l.length===0:typeof l=="object"?Object.keys(l).length===0:!1,r=l=>{typeof l=="object"&&l!==null&&"payload"in l?(navigator.clipboard.writeText(JSON.stringify(l.payload)),L.success({content:y.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),L.error({content:y.translate("i18n_executioncontext_no_payload")}))},m=l=>{i.value=!0,l.stopPropagation(),t.isSmartChatIdle!==!1&&(s("ask-ai"),setTimeout(()=>{i.value=!1},1e3))},I=l=>{typeof l=="object"?(navigator.clipboard.writeText(JSON.stringify(l)),L.success({content:y.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),L.error({content:y.translate("i18n_executioncontext_failed_copy_request")}))};return(l,D)=>(p(),b(M,null,[v(c(G),{justify:"end"},{default:w(()=>[v(c(B),{title:n.isSmartChatIdle?"":c(y).translate("i18n_executioncontext_wait_or_stop"),placement:"left"},{default:w(()=>[n.showFixWithAi?(p(),b("div",{key:0,class:pt(["ask-to-ai",{disabled:!n.isSmartChatIdle||i.value}]),onClick:m},[R(z(c(y).translate("i18n_executioncontext_fix_with_ai"))+" ",1),v(c(wt),{size:16})],2)):_("",!0)]),_:1},8,["title"])]),_:1}),v(c(bt),{direction:"vertical",style:{"border-radius":"5px",padding:"10px",color:"#fff",width:"100%","font-family":"monospace","max-height":"600px",overflow:"auto",border:"1px solid #e8e8e8"}},{default:w(()=>[Object.keys(n.data).length?(p(!0),b(M,{key:1},tt(Object.entries(n.data),([x,E])=>(p(),b("div",{key:x,class:"tree"},[x!=="legacyThreadData"||!g(E)?(p(),b("div",kt,[v(c(U),{strong:""},{default:w(()=>[R(z(o(x)),1)]),_:2},1024),x==="request"?(p(),S(c(B),{key:0,title:c(y).translate("i18n_executioncontext_copy_request_tooltip")},{default:w(()=>[X("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:P=>I(E)},[v(c(Y))],8,Ct)]),_:2},1032,["title"])):_("",!0),x==="triggerTask"?(p(),S(c(B),{key:1,title:c(y).translate("i18n_executioncontext_copy_payload_tooltip")},{default:w(()=>[X("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:P=>r(E)},[v(c(Y))],8,It)]),_:2},1032,["title"])):_("",!0),v(c(ht),{"tree-data":c(yt)(E),selectable:!1},null,8,["tree-data"])])):_("",!0)]))),128)):(p(),S(c(U),{key:0,type:"secondary"},{default:w(()=>[R(z(c(y).translate("i18n_executioncontext_empty")),1)]),_:1}))]),_:1})],64))}}),Ut=et(Dt,[["__scopeId","data-v-629427b0"]]);export{Ut as E,Mt as L,qt as R,Bt as a,Gt as u};
//# sourceMappingURL=ExecutionContext-CcrPJ-9i.js.map
