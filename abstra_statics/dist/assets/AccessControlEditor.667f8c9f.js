var me=Object.defineProperty;var fe=(a,e,t)=>e in a?me(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var $=(a,e,t)=>(fe(a,typeof e!="symbol"?e+"":e,t),t);import{C as ge}from"./ContentLayout.8a64aff0.js";import{l as re}from"./fetch.dd071db9.js";import{E as ne}from"./record.820df198.js";import{f as o,eH as ye,d as C,b as g,c as v,w as r,u as s,bF as S,ar as h,ex as O,ev as q,eE as Z,cA as ve,eG as R,aD as E,ae as F,eF as he,r as k,J as _e,I,v as be,e as Ce,cB as T,cy as M,aj as we,eR as Pe,H as Oe,by as ae,dg as te}from"./outputWidgets.be3472c2.js";import{E as ke,a as Ue}from"./repository.0f18d917.js";import{a as N}from"./asyncComputed.a619212b.js";import{d as W}from"./vuedraggable.umd.013cda09.js";import"./workspaces.7dc978fb.js";import{l as Y}from"./login.57a02e8f.js";import"./envVars.3bfc7529.js";import{P as Ae,A as Q,T as Re}from"./TabPane.3d3ce947.js";import{A as Ie}from"./index.557c5800.js";import{s as xe}from"./metadata.1f80fb9b.js";import{G as Se}from"./PhKanban.vue.61eb6c5c.js";import{A as x}from"./Text.c9febe27.js";import{A}from"./index.ba676107.js";import{A as De}from"./Item.e37372b2.js";import{A as le}from"./index.6773e8c7.js";import{A as ie}from"./index.1db198b0.js";import{_ as Te}from"./SaveButton.vue_vue_type_script_setup_true_lang.37d6810a.js";import{A as se}from"./Paragraph.7601abde.js";import{C as je}from"./CrudView.08af3b90.js";import{G as qe}from"./PhPencil.vue.6be3e07b.js";import{A as B,F as ue}from"./Form.254a7379.js";import{A as ce}from"./index.a81a7d37.js";import{A as Ee}from"./Title.65752aa0.js";import"./pubsub.1063a0da.js";import"./router.87bf43b6.js";import"./popupNotifcation.9025cc7b.js";import"./runnerData.c8a20a02.js";import"./url.7fe1be7b.js";import"./hasIn.bddd0a1a.js";import"./PhCheckCircle.vue.7dbbe089.js";import"./PhScroll.vue.8db75bd1.js";import"./PhWebhooksLogo.vue.9a81ff31.js";import"./UnsavedChangesHandler.080c92ef.js";import"./ExclamationCircleOutlined.85892480.js";import"./Modal.304207b8.js";import"./Link.bbb85664.js";import"./DocsButton.vue_vue_type_script_setup_true_lang.f9aebc41.js";import"./BookOutlined.53049b66.js";import"./isNumeric.75337b1e.js";(function(){try{var a=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(a._sentryDebugIds=a._sentryDebugIds||{},a._sentryDebugIds[e]="bfe47281-03d5-47ad-9a98-676424727191",a._sentryDebugIdIdentifier="sentry-dbid-bfe47281-03d5-47ad-9a98-676424727191")}catch{}})();function oe(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?Object(arguments[e]):{},p=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(p=p.concat(Object.getOwnPropertySymbols(t).filter(function(l){return Object.getOwnPropertyDescriptor(t,l).enumerable}))),p.forEach(function(l){$e(a,l,t[l])})}return a}function $e(a,e,t){return e in a?Object.defineProperty(a,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):a[e]=t,a}var K=function(e,t){var p=oe({},e,t.attrs);return o(ye,oe({},p,{icon:Ae}),null)};K.displayName="PlusOutlined";K.inheritAttrs=!1;const Ne=K;class ee{constructor(e){$(this,"record");this.record=ne.from(e)}get id(){return this.record.get("id")}get type(){return this.record.get("type")}get title(){return this.record.get("title")}get isPublic(){return this.record.get("is_public")}set isPublic(e){e&&this.record.set("required_roles",[]),this.record.set("is_public",e)}get requiredRoles(){return this.record.get("required_roles")}set requiredRoles(e){e.length!==0&&this.record.set("is_public",!1),this.record.set("required_roles",e)}makePublic(){this.isPublic=!0}makeProtected(){this.isPublic=!1,this.requiredRoles=[]}require(e){e.length!==0&&(this.isPublic=!1),this.requiredRoles=e}get visibility(){return this.isPublic?"public":this.requiredRoles.length===0?"protected":"private"}hasChanges(){return this.record.hasChanges("is_public")||this.record.hasChangesDeep("required_roles")}get changes(){return this.record.changes}get initialState(){return this.record.initialState}toUpdateDTO(){return{id:this.id,is_public:this.isPublic,required_roles:this.requiredRoles}}commit(){this.record.commit()}static from(e){return new ee(e)}}class Be{constructor(e=re){this.fetch=e}async list(){return(await(await this.fetch("/_editor/api/access-control",{method:"GET",headers:{"Content-Type":"application/json"}})).json()).map(ee.from)}async update(e){const t=e.reduce((l,n)=>(n.hasChanges()&&l.push({id:n.id,...n.changes}),l),[]);return await(await fetch("/_editor/api/access-control",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()}}const V=class{constructor(e){$(this,"record");this.dto=e,this.record=ne.from(e)}static from(e){return new V(e)}toDTO(){return this.record.toDTO()}get id(){return this.record.get("id")}get projectId(){return this.record.get("projectId")}get emailPatterns(){return this.record.get("emailPatterns")}set emailPatterns(e){this.record.set("emailPatterns",e)}get hasChanges(){return this.record.hasChangesDeep("emailPatterns")}get strategy(){return this.dto.emailPatterns.length===0?"inviteOnly":this.dto.emailPatterns.length==1&&this.dto.emailPatterns[0]=="*"?"anyone":"patternOnly"}get changes(){return this.record.changes}allowAnyone(){this.record.set("emailPatterns",["*"])}allowOnlyInvited(){this.record.set("emailPatterns",[])}static validate(e){let t="";return e.startsWith("@")&&(t=e.slice(1)),e.startsWith("*@")&&(t=e.slice(2)),t.match(V.pattern)!==null}};let j=V;$(j,"pattern",/^[a-z0-9.-]+\.[a-z]{2,}$/);class Ve{constructor(e=re){this.fetch=e}async update(e){const{emailPatterns:t}=e.changes;return t?(await this.fetch("/_editor/api/users/signup-policy",{method:"PUT",body:JSON.stringify({email_patterns:t}),headers:{"Content-Type":"application/json"}}),j.from({...e.toDTO(),emailPatterns:t})):e}async get(){const t=await(await this.fetch("/_editor/api/users/signup-policy")).json();return j.from({emailPatterns:t.email_patterns,id:t.id,projectId:t.project_id,createdAt:t.created_at})}}const Fe=C({__name:"RoleSelector",props:{value:{},roleOptions:{}},emits:["update:value"],setup(a,{emit:e}){const t=()=>{var m,c;if(!((m=Y.asyncComputed.result.value)!=null&&m.logged))return;const n=(c=Y.asyncComputed.result.value)==null?void 0:c.project_id;window.open(`https://cloud.abstra.io/projects/${n}/access-control?selected-panel=roles`,"__roles")},p=n=>{e("update:value",n)},l=C({props:{vnodes:{type:Object,required:!0}},render(){return this.vnodes}});return(n,m)=>(g(),v(s(F),{value:n.value,mode:"multiple","onUpdate:value":p},{dropdownRender:r(({menuNode:c})=>{var i;return[o(s(l),{vnodes:c},null,8,["vnodes"]),o(s(Ie),{style:{margin:"4px 0"}}),(i=s(Y).asyncComputed.result.value)!=null&&i.logged?(g(),v(s(S),{key:0,type:"default",style:{width:"100%"},onClick:t},{icon:r(()=>[o(s(Ne))]),default:r(()=>[h(" Create a new role ")]),_:1})):O("",!0)]}),default:r(()=>[(g(!0),q(E,null,Z(n.roleOptions,c=>(g(),v(s(ve),{key:c,value:c},{default:r(()=>[h(R(c),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"]))}}),Ge=a=>a==="internal"?Se:xe(a),Le="Public",He="Requires Sign-Up",Je="Requires Role",X=C({__name:"DraggeableItem",props:{item:{},roleOptions:{}},emits:["update:roles"],setup(a,{emit:e}){const t=a,p=typeof t.roleOptions<"u",l=n=>{e("update:roles",n)};return(n,m)=>(g(),v(s(De),{style:{"list-style":"none"},class:"item"},{default:r(()=>[o(s(A),{align:"center"},{default:r(()=>[(g(),v(he(s(Ge)(t.item.type)),{style:{"flex-shrink":"0",width:"24px"}})),o(s(x),{ellipsis:"",content:n.item.title,style:{"max-width":"90%",margin:"10px"}},null,8,["content"])]),_:1}),p?(g(),v(Fe,{key:0,style:{width:"100%"},value:n.item.requiredRoles||[],"role-options":n.roleOptions||[],"onUpdate:value":l},null,8,["value","role-options"])):O("",!0)]),_:1}))}});const ze=C({__name:"DraggeableSelector",props:{accessControls:{},roles:{}},emits:["update:accessControls"],setup(a,{emit:e}){const t=a,p=y=>y.reduce((d,u)=>{switch(u.visibility){case"public":d.public.push(u);break;case"protected":d.protected.push(u);break;case"private":d.private.push(u);break;default:throw new Error("Invalid visibility")}return d},{public:[],protected:[],private:[]}),l=p(t.accessControls),n=k(l.public),m=k(l.protected),c=k(l.private);_e(()=>t.accessControls,y=>{const d=p(y);n.value=d.public,m.value=d.protected,c.value=d.private},{immediate:!0});const i=I(()=>t.roles.map(y=>y.name)),f=new Map,_=y=>{if("added"in y){const d=t.accessControls.findIndex(u=>u.id===y.added.element.id);if(d===-1)return!0;t.accessControls[d].makePublic(),e("update:accessControls",[...t.accessControls])}return!0},G=y=>{if("added"in y){const d=t.accessControls.findIndex(u=>u.id===y.added.element.id);if(d===-1)return!0;t.accessControls[d].makeProtected(),e("update:accessControls",[...t.accessControls])}return!0},D=y=>{if("added"in y){const d=y.added.element.id,u=f.get(d);if(u){const w=t.accessControls.findIndex(J=>J.id===y.added.element.id);if(w===-1)return!0;t.accessControls[w].require(u),e("update:accessControls",[...t.accessControls])}}return!0},L=y=>{const d=c.value[y];d&&f.set(d.id,d.requiredRoles)},H=(y,d)=>{const u=t.accessControls.findIndex(w=>w.id===y.id);u!==-1&&(t.accessControls[u].require(d),d.length===0?(c.value=c.value.filter(w=>w.id!==y.id),m.value=[y,...m.value]):t.accessControls[u].isPublic=!1,e("update:accessControls",[...t.accessControls]))};return(y,d)=>(g(),v(s(A),{justify:"space-between",gap:"middle"},{default:r(()=>[o(s(A),{vertical:"",class:"container"},{default:r(()=>[o(s(x),{strong:""},{default:r(()=>[h(R(s(Le)),1)]),_:1}),o(s(W),{list:n.value,"onUpdate:list":d[0]||(d[0]=u=>n.value=u),class:"content","item-key":"id",group:"drag","ghost-class":"ghost",onChange:_},{item:r(({element:u})=>[o(X,{class:"item",item:u},null,8,["item"])]),_:1},8,["list"])]),_:1}),o(s(A),{vertical:"",class:"container"},{default:r(()=>[o(s(x),{strong:""},{default:r(()=>[h(R(s(He)),1)]),_:1}),o(s(W),{list:m.value,"onUpdate:list":d[1]||(d[1]=u=>m.value=u),class:"content","item-key":"id",group:"drag","ghost-class":"ghost",onChange:G},{item:r(({element:u})=>[o(X,{class:"item",item:u},null,8,["item"])]),_:1},8,["list"])]),_:1}),o(s(A),{vertical:"",class:"container"},{default:r(()=>[o(s(x),{strong:""},{default:r(()=>[h(R(s(Je)),1)]),_:1}),o(s(W),{list:c.value,"onUpdate:list":d[2]||(d[2]=u=>c.value=u),class:"content","item-key":"id",group:"drag","ghost-class":"ghost",onChange:D,onStart:d[3]||(d[3]=u=>L(u.oldIndex))},{item:r(({element:u})=>[o(X,{class:"item",item:u,"role-options":i.value,"onUpdate:roles":w=>H(u,w)},null,8,["item","role-options","onUpdate:roles"])]),_:1},8,["list"])]),_:1})]),_:1}))}});const Me=be(ze,[["__scopeId","data-v-21c452a6"]]),We=C({__name:"DanglingRolesAlert",props:{danglingRoles:{}},setup(a){return(e,t)=>(g(),v(s(ie),{type:"warning","show-icon":"",closable:""},{description:r(()=>[o(s(x),null,{default:r(()=>[h("The following roles are not defined in the Cloud Console:")]),_:1}),(g(!0),q(E,null,Z(e.danglingRoles,p=>(g(),v(s(le),{key:p,style:{margin:"2px"},color:"red"},{default:r(()=>[h(R(p),1)]),_:2},1024))),128))]),_:1}))}}),Ye=C({__name:"View",props:{accessControls:{},roles:{},loading:{type:Boolean}},emits:["update:access-controls","save"],setup(a,{emit:e}){const t=a,p=I(()=>{var i;return((i=t.accessControls)==null?void 0:i.filter(f=>f.hasChanges()))||[]}),l=I(()=>p.value.length>0),m={save:async()=>{e("save")},hasChanges:()=>l.value},c=I(()=>{const i=t.accessControls.flatMap(_=>_.requiredRoles)||[],f=t.roles.map(_=>_.name)||[];return(i==null?void 0:i.filter(_=>!f.includes(_)))||[]});return(i,f)=>(g(),q(E,null,[o(s(A),{justify:"flex-end"},{default:r(()=>[o(Te,{model:m})]),_:1}),!i.loading&&c.value.length>0?(g(),v(We,{key:0,"dangling-roles":c.value},null,8,["dangling-roles"])):O("",!0),o(Me,{"access-controls":i.accessControls,roles:i.roles||[],"onUpdate:accessControls":f[0]||(f[0]=_=>e("update:access-controls",_))},null,8,["access-controls","roles"])],64))}}),Qe={style:{padding:"30px"}},Xe=C({__name:"View",props:{signupPolicy:{}},emits:["update:signup-policy","save"],setup(a,{emit:e}){const t=a,p=k(t.signupPolicy.strategy),l=k(t.signupPolicy.strategy==="patternOnly"?t.signupPolicy.emailPatterns:[]),n=k(t.signupPolicy.strategy==="patternOnly"?t.signupPolicy.emailPatterns.map(i=>({label:i})):[]),m=i=>{const f=i;if(l.value=f,f.length===0){c("inviteOnly");return}n.value=f.map(_=>({label:_})),t.signupPolicy.emailPatterns=i,e("update:signup-policy",t.signupPolicy)},c=i=>{p.value=i,i!=="patternOnly"&&(i==="anyone"&&t.signupPolicy.allowAnyone(),i==="inviteOnly"&&t.signupPolicy.allowOnlyInvited(),e("update:signup-policy",t.signupPolicy))};return(i,f)=>(g(),v(s(T),{direction:"vertical",style:{"padding-top":"8px"}},{default:r(()=>[o(s(se),null,{default:r(()=>[h(" Control which end users may sign-up to your app. ")]),_:1}),o(s(S),{disabled:!i.signupPolicy.hasChanges,type:"primary",onClick:f[0]||(f[0]=_=>e("save"))},{default:r(()=>[h(" Save changes ")]),_:1},8,["disabled"]),Ce("div",Qe,[o(s(se),{strong:""},{default:r(()=>[h(" Allow self sign-up? ")]),_:1}),o(s(we),{value:p.value,"onUpdate:value":c},{default:r(()=>[o(s(T),{direction:"vertical"},{default:r(()=>[o(s(M),{value:"inviteOnly"},{default:r(()=>[h("No, users must be added by me.")]),_:1}),o(s(T),null,{default:r(()=>[o(s(M),{value:"patternOnly"},{default:r(()=>[h("Yes, but only for users in")]),_:1}),o(s(F),{mode:"tags",value:l.value,style:{"min-width":"250px"},placeholder:"@domain.com or sub.domain.com",disabled:p.value!=="patternOnly",options:n.value,"dropdown-match-select-width":"",open:!1,"onUpdate:value":m},null,8,["value","disabled","options"])]),_:1}),o(s(M),{value:"anyone"},{default:r(()=>[h("Yes, for anyone")]),_:1})]),_:1})]),_:1},8,["value"])])]),_:1}))}}),Ze=C({__name:"View",props:{loading:{type:Boolean},users:{}},emits:["create","edit","delete"],setup(a,{emit:e}){const t=a,p=I(()=>{var l;return{columns:[{name:"Email"},{name:"Roles"},{name:"",align:"right"}],rows:(l=t.users.map(n=>({key:n.email,cells:[{type:"text",text:n.email},{type:"slot",key:"roles",payload:{roles:n.roles}},{type:"actions",actions:[{icon:qe,label:"Edit",onClick:()=>e("edit",n)},{icon:Pe,label:"Delete",onClick:()=>e("delete",n)}]}]})))!=null?l:[]}});return(l,n)=>(g(),q(E,null,[o(je,{"entity-name":"users",title:"",loading:l.loading,description:"List all user profiles to be used for testing purposes.","empty-title":"No users yet",table:p.value,"create-button-text":"Add users",onCreate:n[0]||(n[0]=m=>e("create",m))},{roles:r(({payload:m})=>[(g(!0),q(E,null,Z(m.roles,c=>(g(),v(s(le),{key:c,bordered:""},{default:r(()=>[h(R(c),1)]),_:2},1024))),128))]),_:1},8,["loading","table"]),o(s(ie),{type:"info","show-icon":"",closable:""},{description:r(()=>[o(s(x),null,{default:r(()=>[h("Configurations made here only affect your local environment. To manage real users, please access the Cloud Console.")]),_:1})]),_:1})],64))}}),Ke=C({__name:"NewUser",props:{roleOptions:{}},emits:["created","cancel"],setup(a,{emit:e}){const p=a.roleOptions.map(c=>({label:c.name,value:c.name})),l=Oe({email:"",roles:[]});function n(){e("cancel")}function m(){!l.email||e("created",l)}return(c,i)=>(g(),v(s(ce),{open:"",title:"New user",width:720,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:n},{extra:r(()=>[o(s(T),null,{default:r(()=>[o(s(S),{onClick:n},{default:r(()=>[h("Cancel")]),_:1}),o(s(S),{type:"primary",onClick:m},{default:r(()=>[h("Submit")]),_:1})]),_:1})]),default:r(()=>[o(s(ue),{model:l,layout:"vertical"},{default:r(()=>[o(s(B),{key:"email",label:"Email",required:!0},{default:r(()=>[o(s(ae),{value:l.email,"onUpdate:value":i[0]||(i[0]=f=>l.email=f)},null,8,["value"])]),_:1}),o(s(B),{key:"role",label:"Role"},{default:r(()=>[o(s(F),{value:l.roles,"onUpdate:value":i[1]||(i[1]=f=>l.roles=f),mode:"multiple",options:s(p)},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1}))}}),et=C({__name:"UpdateUser",props:{roleOptions:{},value:{}},emits:["updated","cancel"],setup(a,{emit:e}){const t=a,p=t.roleOptions.map(m=>({label:m.name,value:m.name}));function l(){e("cancel")}function n(){e("updated",t.value)}return(m,c)=>(g(),v(s(ce),{open:"",title:"Update user",width:720,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:l},{extra:r(()=>[o(s(T),null,{default:r(()=>[o(s(S),{onClick:l},{default:r(()=>[h("Cancel")]),_:1}),o(s(S),{type:"primary",onClick:n},{default:r(()=>[h("Submit")]),_:1})]),_:1})]),default:r(()=>[o(s(ue),{layout:"vertical"},{default:r(()=>[o(s(B),{key:"email",label:"Email"},{default:r(()=>[o(s(ae),{value:m.value.email,"onUpdate:value":c[0]||(c[0]=i=>m.value.email=i),disabled:""},null,8,["value"])]),_:1}),o(s(B),{key:"role",label:"Role"},{default:r(()=>[o(s(F),{value:m.value.roles,"onUpdate:value":c[1]||(c[1]=i=>m.value.roles=i),mode:"multiple",options:s(p)},null,8,["value","options"])]),_:1})]),_:1})]),_:1}))}}),Ht=C({__name:"AccessControlEditor",setup(a){const e=()=>{t.value={type:"initial"}},t=k({type:"initial"}),p=k("enforcement"),l=new Be,{result:n,refetch:m}=N(async()=>await l.list()),c=I(()=>{var P;return((P=n.value)==null?void 0:P.filter(b=>b.hasChanges()))||[]}),i=async()=>{await l.update(c.value),await m()},f=new ke,{result:_,loading:G,refetch:D}=N(()=>f.list()),L=async P=>{await f.create(P),await D(),e()},H=async P=>{await f.update(P.id,P.changes),await D(),e()},y=async P=>{await f.delete(P.id),await D(),e()},d=new Ve,{result:u,refetch:w}=N(()=>d.get()),J=async()=>{!u.value||(await d.update(u.value),await w())},de=new Ue,{result:z,loading:pe}=N(()=>de.list(100,0));return(P,b)=>(g(),v(ge,null,{default:r(()=>[o(s(Ee),null,{default:r(()=>[h("Access Control")]),_:1}),o(s(Re),{"active-key":p.value,"onUpdate:activeKey":b[0]||(b[0]=U=>p.value=U)},{default:r(()=>[o(s(Q),{key:"enforcement",tab:"Security Level"}),o(s(Q),{key:"signup-policy",tab:"Sign Up Policy"}),o(s(Q),{key:"users",tab:"Test Users"})]),_:1},8,["active-key"]),p.value==="enforcement"&&s(n)?(g(),v(Ye,{key:0,"access-controls":s(n),"onUpdate:accessControls":b[1]||(b[1]=U=>te(n)?n.value=U:null),roles:s(z)||[],loading:s(pe),onSave:i},null,8,["access-controls","roles","loading"])):O("",!0),p.value==="users"?(g(),v(s(Ze),{key:1,loading:s(G),users:s(_)||[],onDelete:y,onCreate:b[2]||(b[2]=()=>t.value={type:"user-create"}),onEdit:b[3]||(b[3]=U=>t.value={type:"user-update",user:U})},null,8,["loading","users"])):O("",!0),p.value==="signup-policy"&&s(u)?(g(),v(Xe,{key:2,"signup-policy":s(u),"onUpdate:signupPolicy":b[4]||(b[4]=U=>te(u)?u.value=U:null),onSave:J},null,8,["signup-policy"])):O("",!0),t.value.type==="user-create"?(g(),v(s(Ke),{key:3,"role-options":s(z)||[],onCreated:L,onCancel:e},null,8,["role-options"])):O("",!0),t.value.type==="user-update"?(g(),v(s(et),{key:4,value:t.value.user,"role-options":s(z)||[],onUpdated:H,onCancel:e},null,8,["value","role-options"])):O("",!0)]),_:1}))}});export{Ht as default};
//# sourceMappingURL=AccessControlEditor.667f8c9f.js.map
