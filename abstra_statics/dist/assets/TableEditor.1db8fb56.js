import{d as j,H as E,r as N,G as Z,a as T,b as c,et as w,f as a,w as n,b9 as q,aB as g,eB as R,ev as $,e as v,u as e,eA as O,c as k,eF as Y,b_ as S,bT as K,ae as G,cF as ee,v as J,J as fe,ey as te,cB as be,cH as ve,eC as ae,eD as ne,ez as _e,eE as ye}from"./outputWidgets.2df9e511.js";import{B as ge}from"./BaseLayout.37af2166.js";import{p as le,T as he}from"./tables.7805f704.js";import{a as oe}from"./asyncComputed.e495495e.js";import{p as P}from"./popupNotifcation.a29c59ac.js";import"./router.164b69b2.js";import"./columns.f28791e5.js";import{A as F}from"./index.091c9076.js";import{A as L}from"./index.55f34527.js";import{A}from"./Title.1873e880.js";import{F as se}from"./Form.86cd8023.js";import{A as re}from"./index.c24d869b.js";import{Q as ke,w as Ce,R as we}from"./icons.96b46ca5.js";import{A as De}from"./index.96e01015.js";import{L as $e}from"./CircularLoading.d93c4e46.js";import{P as Ie}from"./project.15acd0d8.js";import{O as Te}from"./organization.fae2b659.js";import{T as Ae,A as H}from"./TabPane.0049f7e5.js";import{B as Ue,a as Se,c as Be}from"./index.f95e65f7.js";import"./gateway.7a25b835.js";import"./activeRecord.36a8fe6a.js";import"./pubsub.35a0e00d.js";import"./string.a5a4d3ed.js";import"./Text.cf87271e.js";import"./index.d90c7b8e.js";import"./index.f4ac7424.js";import"./transButton.21d951e2.js";import"./isNumeric.75337b1e.js";(function(){try{var b=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},m=new Error().stack;m&&(b._sentryDebugIds=b._sentryDebugIds||{},b._sentryDebugIds[m]="39b4b7d6-b988-4a3c-8ef1-5fd5b370ab8f",b._sentryDebugIdIdentifier="sentry-dbid-39b4b7d6-b988-4a3c-8ef1-5fd5b370ab8f")}catch{}})();const xe={class:"table-data",style:{width:"calc(100% - 80px)"}},Ee={key:1},Ne=["onClick"],qe=v("a",null,"Delete",-1),Re=j({__name:"TableData",props:{table:{}},setup(b){var u;const m=b,{result:o,loading:l,refetch:C}=oe(()=>m.table.select()),p=E(()=>{var d;return[...(d=m.table)==null?void 0:d.getColumns().map(r=>({title:r.name,dataIndex:r.name})),{title:"Actions",key:"action",fixed:"right",width:100,align:"center"}]}),f=E(()=>{var t;return((t=o.value)==null?void 0:t.map(d=>({key:d.id,...d})))||[]}),h=N(!1),i=N({}),s=()=>{h.value=!0},I=()=>{i.value={},h.value=!1};let _=Z((u=m.table)==null?void 0:u.getUnprotectedColumns().reduce((t,d)=>({...t,[d.name]:""}),{}));async function y(){if(!(!m.table||!_))try{i.value.id?await m.table.updateRow(i.value.id,i.value):await m.table.insertRow(i.value),i.value={},C(),I()}catch(t){t instanceof Error&&P("Database error",t.message)}}const D=async t=>{if(!(!o.value||!o.value.find(d=>d.id===t)))try{await m.table.deleteRow(t),C()}catch(d){d instanceof Error&&P("Database error",d.message)}},U=t=>{var d;i.value=Y.exports.pick(Y.exports.cloneDeep((d=f.value)==null?void 0:d.filter(r=>t===r.key)[0]),m.table.getColumns().map(r=>r.name)),s()};return(t,d)=>{const r=T("a-divider"),z=T("a-popconfirm"),B=T("a-button"),W=T("a-table"),ue=T("a-input"),de=T("a-form-item"),ce=T("a-form"),pe=T("a-space"),me=T("a-drawer");return c(),w("div",xe,[a(W,{columns:p.value,"data-source":f.value,bordered:"",loading:e(l),scroll:{x:2e3,y:720}},{bodyCell:n(({column:x,text:V,record:X})=>[p.value.map(M=>M.title).includes(x.dataIndex)?(c(),w(q,{key:0},[g(R(V),1)],64)):$("",!0),x.key==="action"?(c(),w("div",Ee,[v("span",null,[v("a",{onClick:M=>U(X.id)},"Edit",8,Ne)]),a(r,{type:"vertical"}),a(z,{title:"Sure to delete?",onConfirm:M=>D(X.id)},{default:n(()=>[qe]),_:2},1032,["onConfirm"])])):$("",!0)]),footer:n(()=>[a(B,{type:"primary",onClick:s},{default:n(()=>[g("+ Add New Data")]),_:1})]),_:1},8,["columns","data-source","loading"]),a(me,{title:"Data",width:720,open:h.value,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:I},{extra:n(()=>[a(pe,null,{default:n(()=>[a(B,{onClick:I},{default:n(()=>[g("Cancel")]),_:1}),a(B,{type:"primary",onClick:y},{default:n(()=>[g("Submit")]),_:1})]),_:1})]),default:n(()=>[a(ce,{model:i.value,layout:"vertical"},{default:n(()=>[(c(!0),w(q,null,O(t.table.getUnprotectedColumns(),x=>(c(),k(de,{key:x.id,label:x.name},{default:n(()=>[i.value?(c(),k(ue,{key:0,value:i.value[x.name],"onUpdate:value":V=>i.value[x.name]=V},null,8,["value","onUpdate:value"])):$("",!0)]),_:2},1032,["label"]))),128))]),_:1},8,["model"])]),_:1},8,["open"])])}}});const ze=j({__name:"NewColumn",props:{open:{type:Boolean},table:{}},emits:["created","cancel"],setup(b,{emit:m}){const o=b,l=N({name:"",type:"varchar",nullable:!0,unique:!1}),C=()=>{l.value={name:"",type:"varchar",nullable:!0,unique:!1}};function p(){m("cancel")}async function f(){if(!o.table||!l.value.name||!l.value.type)return;const{success:h,error:i}=await o.table.addColumn(l.value);h||P("Database error",i),C(),m("created")}return(h,i)=>(c(),k(e(re),{title:"New column",width:720,open:o.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:p},{extra:n(()=>[a(e(L),null,{default:n(()=>[a(e(S),{onClick:p},{default:n(()=>[g("Cancel")]),_:1}),a(e(S),{type:"primary",onClick:f},{default:n(()=>[g("Submit")]),_:1})]),_:1})]),default:n(()=>[a(e(se),{model:l.value,layout:"vertical"},{default:n(()=>[a(e(A),{key:"name",label:"Name"},{default:n(()=>[a(e(K),{value:l.value.name,"onUpdate:value":i[0]||(i[0]=s=>l.value.name=s)},null,8,["value"])]),_:1}),a(e(A),{key:"type",label:"Type"},{default:n(()=>[a(e(G),{value:l.value.type,"onUpdate:value":i[1]||(i[1]=s=>l.value.type=s),"default-active-first-option":""},{default:n(()=>[(c(!0),w(q,null,O(e(le),s=>(c(),k(e(ee),{key:s,value:s},{default:n(()=>[g(R(s),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),a(e(A),{key:"nullable",label:"Nullable"},{default:n(()=>[a(e(F),{checked:l.value.nullable,"onUpdate:checked":i[2]||(i[2]=s=>l.value.nullable=s)},null,8,["checked"])]),_:1}),a(e(A),{key:"unique",label:"Unique"},{default:n(()=>[a(e(F),{checked:l.value.unique,"onUpdate:checked":i[3]||(i[3]=s=>l.value.unique=s)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"]))}}),Pe={class:"types-container"},je={class:"fullwidth-input"},Fe={class:"fullwidth-input"},Ke={class:"using-container"},Le={class:"fullwidth-input"},Oe=j({__name:"UpdateColumn",props:{open:{type:Boolean},table:{},column:{}},emits:["updated","cancel"],setup(b,{emit:m}){const o=b;function l(){m("cancel")}const C=()=>o.column.record.hasChangesDeep("type"),p=N({type:"default"});function f(u,t){return t==="varchar"||u==="int"&&t==="boolean"||u==="boolean"&&t==="int"}const h=()=>{s.value&&(p.value={type:"user-defined",using:D.value,mandatory:!0})},i=E(()=>p.value.type==="default"&&f(o.column.record.initialState.type,o.column.type)),s=E(()=>!f(o.column.record.initialState.type,o.column.type));function I(u){u?p.value={type:"default"}:p.value={type:"user-defined",using:D.value,mandatory:!1}}function _(u){if(p.value.type==="default")throw new Error("Can't change using when using default casting");p.value.using=u!=null?u:""}const y=()=>s.value?!0:C()&&p.value.type==="user-defined",D=E(()=>`${o.column.record.initialState.name}::${o.column.type}`);async function U(){if(!o.column)return;const u=p.value.type==="default"?D.value:p.value.using;try{await o.column.update(u),m("updated")}catch(t){t instanceof Error&&P("Database error",t.message)}}return(u,t)=>{const d=T("icon");return c(),k(e(re),{title:"Edit column",width:720,open:o.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:l},{extra:n(()=>[a(e(L),null,{default:n(()=>[a(e(S),{onClick:l},{default:n(()=>[g("Cancel")]),_:1}),a(e(S),{type:"primary",onClick:U},{default:n(()=>[g("Submit")]),_:1})]),_:1})]),default:n(()=>[a(e(se),{model:u.column,layout:"vertical"},{default:n(()=>[a(e(A),{key:"name",label:"Name"},{default:n(()=>[a(e(K),{value:u.column.name,"onUpdate:value":t[0]||(t[0]=r=>u.column.name=r)},null,8,["value"])]),_:1}),v("div",Pe,[v("span",je,[a(e(A),{key:"type",label:"Current Type"},{default:n(()=>[a(e(G),{value:u.column.record.initialState.type,"onUpdate:value":t[1]||(t[1]=r=>u.column.record.initialState.type=r),"default-active-first-option":"",disabled:""},null,8,["value"])]),_:1})]),a(d,{class:"right-arrow",path:e(ke)},null,8,["path"]),v("span",Fe,[a(e(A),{key:"new-type",label:"New Type"},{default:n(()=>[a(e(G),{value:u.column.type,"onUpdate:value":t[2]||(t[2]=r=>u.column.type=r),"default-active-first-option":"",onChange:t[3]||(t[3]=r=>h())},{default:n(()=>[(c(!0),w(q,null,O(e(le),r=>(c(),k(e(ee),{key:r,value:r},{default:n(()=>[g(R(r),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})])]),v("div",Ke,[C()?(c(),k(e(A),{key:"default-casting",label:"Use default casting"},{default:n(()=>[a(e(F),{checked:i.value,disabled:s.value,"onUpdate:checked":t[4]||(t[4]=r=>I(!!r))},null,8,["checked","disabled"])]),_:1})):$("",!0),v("span",Le,[C()?(c(),k(e(A),{key:"using",label:"Using"},{default:n(()=>[a(e(K),{value:p.value.type==="user-defined"?p.value.using:D.value,disabled:!y(),onInput:t[5]||(t[5]=r=>_(r.target.value))},null,8,["value","disabled"])]),_:1})):$("",!0)])]),a(e(A),{key:"nullable",label:"Nullable"},{default:n(()=>[a(e(F),{checked:u.column.nullable,"onUpdate:checked":t[6]||(t[6]=r=>u.column.nullable=r)},null,8,["checked"])]),_:1}),a(e(A),{key:"unique",label:"Unique"},{default:n(()=>[a(e(F),{checked:u.column.unique,"onUpdate:checked":t[7]||(t[7]=r=>u.column.unique=r)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])}}});const Ve=J(Oe,[["__scopeId","data-v-e474c12f"]]),ie=b=>(ae("data-v-4f8ba920"),b=b(),ne(),b),Me={class:"table-settings"},He={key:0},Ge=ie(()=>v("span",null," protected ",-1)),Je=[Ge],Qe={key:1},We=["onClick"],Xe=ie(()=>v("a",null,"Delete",-1)),Ye=j({__name:"TableColumns",props:{table:{},loading:{type:Boolean}},emits:["refresh"],setup(b,{emit:m}){var u;const o=b,l=N(o.loading);fe(()=>o.loading,()=>{l.value=o.loading});const C=te();(u=o.table)==null||u.onUpdate(()=>{var t;C.replace({name:"tableEditor",params:{tableName:(t=o.table)==null?void 0:t.name}})});const f=[...[{title:"Name",dataIndex:"name"},{title:"Type",dataIndex:"type"},{title:"Default Value",dataIndex:"default"},{title:"Nullable",dataIndex:"nullable"},{title:"Primary Key",dataIndex:"primaryKey"}],{title:"Actions",key:"action"}],h=E(()=>{var t;return(t=o.table)==null?void 0:t.getColumns().map(d=>({name:d.name,type:d.type,default:d.default,nullable:d.nullable,primaryKey:d.primaryKey,id:d.id,unique:d.unique}))});function i(){_.value={type:"idle"}}function s(){i(),l.value=!0,setTimeout(()=>{m("refresh")},500)}function I(){_.value={type:"creating"}}const _=N({type:"idle"});function y(t){var d,r;(r=(d=o.table)==null?void 0:d.getColumn(t))==null||r.delete(),l.value=!0,setTimeout(()=>{m("refresh")},500)}const D=t=>{var d,r,z;return(z=(r=(d=o.table)==null?void 0:d.getColumn(t))==null?void 0:r.protected)!=null?z:!1},U=t=>{if(!o.table)throw new Error("Table not found");_.value={type:"editing",column:o.table.getColumn(t)}};return(t,d)=>(c(),w("div",Me,[a(e(ve),{columns:f,"data-source":h.value,bordered:"",loading:l.value,pagination:!1},{bodyCell:n(({column:r,text:z,record:B})=>[r.key!=="action"?(c(),w(q,{key:0},[g(R(z),1)],64)):(c(),w(q,{key:1},[D(B.id)?(c(),w("div",He,Je)):(c(),w("div",Qe,[v("span",null,[v("a",{onClick:()=>U(B.id)},"Edit",8,We)]),a(e(De),{type:"vertical"}),a(e(be),{title:"Sure to delete?",onConfirm:W=>y(B.id)},{default:n(()=>[Xe]),_:2},1032,["onConfirm"])]))],64))]),footer:n(()=>[a(e(S),{type:"primary",onClick:I},{default:n(()=>[g("+ Add New Column")]),_:1})]),_:1},8,["data-source","loading"]),t.table&&_.value.type==="creating"?(c(),k(ze,{key:0,open:"",table:o.table,onClose:i,onCreated:s},null,8,["table"])):$("",!0),t.table&&_.value.type==="editing"?(c(),k(Ve,{key:1,column:_.value.column,open:"",table:t.table,onUpdated:s,onClose:i,onCancel:i},null,8,["column","table"])):$("",!0)]))}});const Ze=J(Ye,[["__scopeId","data-v-4f8ba920"]]),Q=b=>(ae("data-v-06f57b7a"),b=b(),ne(),b),et={class:"table-settings"},tt=Q(()=>v("h2",{class:"title"},"Table settings",-1)),at=Q(()=>v("div",{class:"subtitle"},"Edit table metadata",-1)),nt={key:0,class:"table-presenter"},lt={class:"table-property-item"},ot={class:"property-item"},st={key:1},rt={class:"change-warning"},it={class:"section-title"},ut=Q(()=>v("div",{class:"section-body"}," Changing the table's name can possibly result in the break of running applications. ",-1)),dt={class:"table-name-value-input"},ct={key:0,class:"error"},pt=j({__name:"TableSettings",props:{table:{}},emits:["refresh"],setup(b,{emit:m}){const o=b,l=Z({error:"",editing:!1,loading:!1}),C=()=>l.editing=!0,p=()=>{o.table.resetChanges(),l.editing=!1,l.error=""},f=async()=>{l.error="",l.loading=!0;try{await h()}catch(s){s instanceof Error&&(P("Database error",s.message),l.error=s.message)}l.error||(l.editing=!1),l.loading=!1},h=async()=>{if(!o.table.name){l.error="Table name cannot be empty";return}try{await o.table.save(),m("refresh")}catch(s){s instanceof Error&&(P("Database error",s.message),l.error=s.message)}},i=s=>{o.table.name=s.target.value};return(s,I)=>{var y;const _=T("icon");return c(),w("div",et,[tt,at,l.editing?(c(),w("div",st,[v("div",rt,[v("div",it,[a(_,{path:e(Ce),width:"12",height:"12",fill:"#D35249"},null,8,["path"]),g(" Be careful ")]),ut]),a(e(L),{direction:"vertical"},{default:n(()=>[v("div",dt,[a(e(K),{value:s.table.name,type:"text",onInput:i,onBlur:I[0]||(I[0]=D=>s.table.fixTraillingName())},null,8,["value"])]),l.error?(c(),w("div",ct,[a(_,{path:e(we),fill:"#D35249",width:"12",height:"12"},null,8,["path"]),g(" "+R(l.error),1)])):$("",!0),a(e(L),null,{default:n(()=>[a(e(S),{onClick:p},{default:n(()=>[g("Cancel")]),_:1}),a(e(S),{type:"primary",disabled:!s.table.hasChangesDeep("name"),onClick:f},{default:n(()=>[g(" Save Changes "),l.loading?(c(),k($e,{key:0,size:"16"})):$("",!0)]),_:1},8,["disabled"])]),_:1})]),_:1})])):(c(),w("div",nt,[v("div",lt,[v("div",ot,"Name: "+R((y=s.table)==null?void 0:y.name),1)]),a(e(S),{onClick:C},{default:n(()=>[g("Edit Name")]),_:1})]))])}}});const mt=J(pt,[["__scopeId","data-v-06f57b7a"]]),Lt=j({__name:"TableEditor",setup(b){const m=te(),o=_e(),l=o.params.tableId,C=o.params.projectId,p=N("data"),{result:f,loading:h,refetch:i}=oe(()=>Promise.all([Ie.get(C).then(async _=>{const y=await Te.get(_.organizationId);return{project:_,organization:y}}),he.get(C,l)]).then(([{project:_,organization:y},D])=>ye({project:_,organization:y,table:D}))),s=E(()=>!h.value&&f.value?[{label:"My organizations",path:"/organizations"},{label:f.value.organization.name,path:`/organizations/${f.value.organization.id}`},{label:f.value.project.name,path:`/projects/${f.value.project.id}/tables`}]:void 0);function I(){m.push({name:"tables",params:{projectId:C}})}return(_,y)=>{const D=T("router-link");return c(),k(ge,null,{navbar:n(()=>{var U;return[a(e(Be),{title:(U=e(f))==null?void 0:U.table.name,style:{padding:"5px 10px"},onBack:I},{footer:n(()=>[a(e(Ae),{"active-key":p.value,"onUpdate:activeKey":y[0]||(y[0]=u=>p.value=u)},{default:n(()=>[a(e(H),{key:"data",tab:"Data"}),a(e(H),{key:"columns",tab:"Columns"}),a(e(H),{key:"settings",tab:"Settings"})]),_:1},8,["active-key"])]),breadcrumb:n(()=>[s.value?(c(),k(e(Ue),{key:0},{default:n(()=>[(c(!0),w(q,null,O(s.value,(u,t)=>(c(),k(e(Se),{key:t},{default:n(()=>[a(D,{to:u.path},{default:n(()=>[g(R(u.label),1)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1})):$("",!0)]),_:1},8,["title"])]}),content:n(()=>[e(f)&&p.value==="data"?(c(),k(Re,{key:0,loading:e(h),table:e(f).table},null,8,["loading","table"])):$("",!0),e(f)&&p.value==="columns"?(c(),k(Ze,{key:1,table:e(f).table,loading:e(h),onRefresh:y[1]||(y[1]=U=>e(i)())},null,8,["table","loading"])):$("",!0),e(f)&&p.value==="settings"?(c(),k(mt,{key:2,table:e(f).table,loading:e(h),onRefresh:y[2]||(y[2]=U=>e(i)())},null,8,["table","loading"])):$("",!0)]),_:1})}}});export{Lt as default};
//# sourceMappingURL=TableEditor.1db8fb56.js.map
