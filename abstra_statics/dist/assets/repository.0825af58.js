import{f as o,eG as ge,r as X,H,F as fe,d as $,b as r,ev as S,w as a,aD as O,eC as x,eD as w,u as e,v as G,c as d,ar as v,cM as _e,cE as T,ex as A,bg as me,eK as ee,e as V,eJ as z,aH as te,cm as ae,eE as ye,eF as ve,eP as he,a as ne,cD as se,ae as oe,bG as Y,eA as ke,o as Se,L as be,dm as we}from"./outputWidgets.763535ec.js";import{a as re}from"./asyncComputed.c1b5752d.js";import"./workspaces.e85b3963.js";import{S as Ae}from"./scripts.3b59edc0.js";import"./envVars.56582b39.js";import{A as Re,s as le}from"./api.5e4f0951.js";import{A as Ie}from"./contracts.generated.cf6d5c40.js";import{A as R}from"./index.5c5eefcc.js";import{r as Ce,t as De}from"./icons.39d7577b.js";import{t as $e}from"./ant-design.a18872e6.js";import{A as B}from"./Text.1de1f1d2.js";import"./index.69d1881a.js";import{A as j}from"./index.351b265c.js";import{f as Pe}from"./index.9420351b.js";import{A as Z}from"./Paragraph.1d14da40.js";import{A as q}from"./Title.b6a28a5f.js";import"./index.7857da36.js";import{T as Oe,A as xe}from"./Timeline.97dc7197.js";import{A as ie,C as ue}from"./CollapsePanel.32fe6049.js";import{A as Fe}from"./Link.5693cd06.js";import{A as ce}from"./index.6acdca79.js";import{A as Ee}from"./index.0efd08f1.js";import{S as Te}from"./SyncOutlined.cf45cade.js";import{E as Ue}from"./ExpandOutlined.baeb1f93.js";import{C as Le}from"./Card.5119fefd.js";import{D as Ne}from"./DownOutlined.c29f5017.js";import"./index.7e2e9637.js";import{F as Ke,A as qe}from"./Form.93c1d68a.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[t]="09a8a432-bfd7-416e-91e0-400d0bab6414",s._sentryDebugIdIdentifier="sentry-dbid-09a8a432-bfd7-416e-91e0-400d0bab6414")}catch{}})();var Ve={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM641.7 520.8L442.3 677.6c-7.4 5.8-18.3.6-18.3-8.8V355.3c0-9.4 10.9-14.7 18.3-8.8l199.4 156.7a11.2 11.2 0 010 17.6z"}}]},name:"play-square",theme:"filled"};const Be=Ve;function Q(s){for(var t=1;t<arguments.length;t++){var l=arguments[t]!=null?Object(arguments[t]):{},i=Object.keys(l);typeof Object.getOwnPropertySymbols=="function"&&(i=i.concat(Object.getOwnPropertySymbols(l).filter(function(n){return Object.getOwnPropertyDescriptor(l,n).enumerable}))),i.forEach(function(n){ze(s,n,l[n])})}return s}function ze(s,t,l){return t in s?Object.defineProperty(s,t,{value:l,enumerable:!0,configurable:!0,writable:!0}):s[t]=l,s}var J=function(t,l){var i=Q({},t,l.attrs);return o(ge,Q({},i,{icon:Be}),null)};J.displayName="PlaySquareFilled";J.inheritAttrs=!1;const He=J;function je(){const s=X({state:"closed"});function t(){s.value={state:"closed"}}function l(){s.value={state:"visualizations"}}function i(u,_){s.value={state:"stage-run",stageRun:_}}const n=H(()=>"stageRun"in s.value?s.value.stageRun:null);return{closeDrawer:t,openVisualizationEditor:l,inspectStageRun:i,drawerState:s,selectedStageRunForDrawer:n}}const U="kanban-selected-stage-ids",L=10,Me=({kanbanRepository:s,storage:t,filterFactory:l,router:i})=>{const n=fe([]),u=re(async()=>{try{const f=await s.getData({selection:n.value,filter:l()}),g=await t.get(U)||[];for(const m of f.not_found_stages)t.set(U,g.filter(h=>h!==m)),n.value=n.value.filter(h=>h.stage_id!==m);return f}catch{return n.value=[],await t.set(U,[]),{columns:[],next_stage_options:[]}}});function _(f){const g=f.selected_stage.id,m=n.value.find(h=>h.stage_id===g);return m!=null&&m.limit?m.limit<f.total_count:!1}async function c(f){var m;const g=n.value.find(h=>h.stage_id===f.selected_stage.id);g&&(g.limit=((m=g.limit)!=null?m:0)+L,await u.refetch())}async function p(f){const g=n.value.find(m=>m.stage_id===f);g&&g.limit&&g.limit>L&&(g.limit-=L,await u.refetch())}async function y(){const f=await t.get(U)||[];n.value=f.map(g=>({stage_id:g,limit:L,offset:0}))}async function I(f,g){f?n.value=[...n.value.slice(0,g),{stage_id:f.id,limit:L,offset:0},...n.value.slice(g+1)]:n.value=[...n.value.slice(0,g),...n.value.slice(g+1)],await t.set(U,n.value.map(m=>m.stage_id)),await u.refetch()}async function F(f){await I(f,n.value.length)}let k=null;return{kanbanAsyncComputed:u,selection:n,increasePagination:c,hasPagination:_,seeLess:p,setStage:I,addStage:F,cardActionHandler:async(f,g)=>{const m=f.selected_stage,h=g.id;if(m.type==="script"){const b=await Ae.get(m.id);if(!b)return;await b.run(h)}if(m.type==="form"){const b=i.resolve({path:`/${m.path}`,query:h?{[Re]:h}:{}});window.open(b.href,h)}},setup:async()=>{await y(),u.refetch(),k=setInterval(()=>{u.refetch()},1e3)},tearDown:()=>{k&&clearInterval(k)}}};function W(s){switch(s.status){case"waiting":return{color:"blue",text:"Waiting"};case"running":return{color:"processing",text:"Running"};case"finished":return{color:"success",text:"Success"};case"failed":return{color:"error",text:"Failed"};case"abandoned":return{color:"warning",text:"Abandoned"}}}const N="Show All",Ge=[N,...Ie];function Je(){const s=X(N);return{filterStatus:s,filterFactory:()=>s.value==N?{}:{status:s.value},labelOption:i=>i==N?N:W({status:i}).text}}const We={key:0},Ye={key:1,class:"terminal"},Ze=$({__name:"ExecutionInspector",props:{logs:{}},setup(s){return(t,l)=>t.logs.length===0?(r(),S("span",We)):(r(),S("div",Ye,[o(e(R),{vertical:""},{default:a(()=>[(r(!0),S(O,null,x(t.logs,i=>(r(),S("pre",{key:i.executionId,class:"log-text"},w(i.payload.text),1))),128))]),_:1})]))}});const Qe=G(Ze,[["__scopeId","data-v-4e71a195"]]),M=$({__name:"StageRunData",props:{data:{}},setup(s){return(t,l)=>(r(),d(e(T),{direction:"vertical",style:{overflow:"hidden"}},{default:a(()=>[(r(!0),S(O,null,x(t.data,i=>(r(),S("div",{key:i.key},[o(e(B),{strong:""},{default:a(()=>[v(w(i.key),1)]),_:2},1024),o(e(_e),{"tree-data":e($e)(i.value),selectable:!1},null,8,["tree-data"])]))),128))]),_:1}))}}),Xe=s=>(ye("data-v-68c9e478"),s=s(),ve(),s),et={key:1},tt={key:1},at=Xe(()=>V("span",null,"[Deleted Stage]",-1)),nt=["onClick"],st=$({__name:"StageRunInspector",props:{stageRun:{},kanbanRepository:{},stageRunRepository:{}},emits:["close"],setup(s,{emit:t}){const l=s;function i(c){return Object.entries(c).map(([p,y])=>({key:p,value:y,type:typeof y}))}const{result:n,loading:u}=re(()=>{var c;return l.kanbanRepository.getLogs((c=l.stageRun)==null?void 0:c.id)}),_=(c,p)=>{var y;c.stopPropagation(),(y=l.stageRunRepository)==null||y.fork(p),t("close")};return(c,p)=>(r(),d(e(Ee),{open:"",title:"Thread details",size:"large",onClose:p[0]||(p[0]=y=>t("close"))},{extra:a(()=>[o(e(Z),null,{default:a(()=>[o(e(j),{style:{"font-weight":"600"}},{default:a(()=>{var y;return[v(w(e(W)({status:(y=c.stageRun)==null?void 0:y.status}).text),1)]}),_:1}),v(" "+w(e(Pe)(new Date(c.stageRun.created_at),{addSuffix:!0})),1)]),_:1})]),default:a(()=>{var y,I,F;return[(y=c.stageRun)!=null&&y.assignee?(r(),d(e(Z),{key:0},{default:a(()=>{var k;return[v(" Assignee: "+w((k=c.stageRun)==null?void 0:k.assignee),1)]}),_:1})):A("",!0),((I=c.stageRun)==null?void 0:I.content)&&((F=c.stageRun)==null?void 0:F.content.length)>0?(r(),S("div",et,[o(e(q),{level:4},{default:a(()=>[v("Current data")]),_:1}),o(M,{data:c.stageRun.content},null,8,["data"])])):A("",!0),o(e(q),{level:4,style:{"margin-bottom":"30px"}},{default:a(()=>[v(" Timeline ")]),_:1}),e(u)?(r(),d(e(me),{key:2})):e(n)?(r(),d(e(Oe),{key:3},{default:a(()=>[(r(!0),S(O,null,x(e(n),({stage:k,stage_run:C,logs:P})=>(r(),d(e(xe),{key:C.id},{default:a(()=>[o(e(ue),{ghost:"","expand-icon-position":"end"},{default:a(()=>[o(e(ie),{class:"panel"},ee({header:a(()=>[k?(r(),d(e(R),{key:0,align:"center",gap:15},{default:a(()=>[o(z,{path:e(le)(k.type)},null,8,["path"]),P.length?(r(),S("span",tt,w(k.title),1)):(r(),d(e(te),{key:0,placement:"right",title:"No logs"},{default:a(()=>[v(w(k.title),1)]),_:2},1024))]),_:2},1024)):(r(),d(e(R),{key:1,align:"center",gap:15},{default:a(()=>[o(z,{path:e(De)},null,8,["path"]),at]),_:1}))]),default:a(()=>[i(C.data).length||P.length?(r(),d(e(R),{key:0,vertical:""},{default:a(()=>[i(C.data).length?(r(),d(e(R),{key:0,gap:0,vertical:""},{default:a(()=>[o(e(q),{level:5},{default:a(()=>[v(" Output data ")]),_:1}),o(M,{data:i(C.data)},null,8,["data"])]),_:2},1024)):A("",!0),P.length?(r(),d(e(R),{key:1,vertical:"",gap:0},{default:a(()=>[o(e(ce)),o(e(q),{level:5},{default:a(()=>[v(" Logs ")]),_:1}),o(Qe,{logs:P},null,8,["logs"])]),_:2},1024)):A("",!0)]),_:2},1024)):(r(),d(e(ae),{key:1,description:"No logs"}))]),_:2},[c.stageRunRepository&&k?{name:"extra",fn:a(()=>[V("span",{onClick:K=>_(K,C.id)},[o(e(R),{gap:"small"},{default:a(()=>[o(z,{path:e(Ce),width:"22"},null,8,["path"]),o(e(Fe),null,{default:a(()=>[v("Fork")]),_:1})]),_:1})],8,nt)]),key:"0"}:void 0]),1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):A("",!0)]}),_:1}))}});const ot=G(st,[["__scopeId","data-v-68c9e478"]]),rt=$({__name:"Card",props:{stage:{},card:{}},emits:["inspect","action"],setup(s){const t=s,l=H(()=>W({status:t.card.status}).text),i=H(()=>he(new Date(String(t.card.updated_at))));return(n,u)=>{var _;return r(),d(e(Le),{size:"small",style:{width:"275px",cursor:"pointer"},"body-style":{display:((_=n.card.content)==null?void 0:_.length)>0?"block":"none"}},ee({title:a(()=>[o(e(j),null,{default:a(()=>[v(w(l.value)+" ",1),l.value==="Running"?(r(),d(e(Te),{key:0,spin:!0,style:{"margin-left":"4px"}})):A("",!0)]),_:1})]),default:a(()=>[o(e(T),{direction:"vertical",style:{"max-height":"300px",width:"100%",overflow:"hidden"},onClick:u[0]||(u[0]=c=>n.$emit("inspect"))},{default:a(()=>[o(M,{data:n.card.content,disabled:!0},null,8,["data"]),n.card.assignee?(r(),d(e(j),{key:0},{default:a(()=>[v(w(n.card.assignee),1)]),_:1})):A("",!0)]),_:1})]),extra:a(()=>[o(e(R),{gap:"10"},{default:a(()=>[o(e(te),null,{title:a(()=>[v(w(n.card.updated_at),1)]),default:a(()=>[o(e(B),{type:"secondary",style:{"font-size":"12px"}},{default:a(()=>[v(w(i.value),1)]),_:1})]),_:1}),o(e(Ue),{onClick:u[2]||(u[2]=c=>n.$emit("inspect"))})]),_:1})]),_:2},[n.card.status==="waiting"?{name:"actions",fn:a(()=>[o(e(He),{onClick:u[1]||(u[1]=c=>n.$emit("action"))})]),key:"0"}:void 0]),1032,["body-style"])}}}),de=$({__name:"ColumnHeader",props:{stageOptions:{},stage:{},stageCount:{}},emits:["stageUpdate"],setup(s,{emit:t}){const l=s,i=n=>{const u=l.stageOptions.find(_=>_.id===n);t("stageUpdate",u!=null?u:null)};return(n,u)=>{var c;const _=ne("icon");return r(),d(e(oe),{style:{width:"275px"},"allow-clear":"",value:((c=n.stage)==null?void 0:c.id)||"","onUpdate:value":i},{suffixIcon:a(()=>[o(e(B),{type:"secondary",style:{"font-size":"small","margin-right":"2px"}},{default:a(()=>[v(w(n.stageCount),1)]),_:1}),o(e(ce),{type:"vertical"}),o(e(Ne))]),default:a(()=>[(r(!0),S(O,null,x(n.stageOptions,p=>(r(),d(e(se),{key:p.id,value:p.id},{default:a(()=>[o(e(R),{gap:"10",style:{"max-width":"200px"}},{default:a(()=>[o(_,{path:e(le)(p.type),style:{"flex-shrink":"0",width:"24px"}},null,8,["path"]),o(e(B),{ellipsis:"",content:p.title},null,8,["content"])]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])}}});class lt{constructor(t){this.column=t}get stage(){return this.column.selected_stage}get launchLink(){return!this.stage.can_be_started||this.stage.type!=="form"?null:{path:`/${this.stage.path}`,query:{}}}}const it=$({__name:"Column",props:{hasPagination:{type:Boolean},column:{}},emits:["increasePagination","cardInspection","cardAction","stageUpdate"],setup(s,{emit:t}){const l=s,n=new lt(l.column).launchLink;return(u,_)=>{const c=ne("router-link");return r(),d(e(T),{direction:"vertical"},{default:a(()=>[o(de,{"stage-options":u.column.stages,stage:u.column.selected_stage,"stage-count":u.column.total_count,onStageUpdate:_[0]||(_[0]=p=>t("stageUpdate",p))},null,8,["stage-options","stage","stage-count"]),o(e(T),{direction:"vertical",style:{width:"100%"}},{default:a(()=>[u.column.stage_run_cards.length===0?(r(),d(e(ae),{key:0})):A("",!0),(r(!0),S(O,null,x(u.column.stage_run_cards,p=>(r(),d(rt,{key:p.id,stage:u.column.selected_stage,card:p,onInspect:y=>t("cardInspection",p),onAction:y=>t("cardAction",p)},null,8,["stage","card","onInspect","onAction"]))),128)),u.hasPagination?(r(),d(e(Y),{key:1,style:{width:"100%"},onClick:_[1]||(_[1]=p=>t("increasePagination"))},{default:a(()=>[v("See more")]),_:1})):A("",!0),e(n)?(r(),d(c,{key:2,target:"_blank",to:e(n)},{default:a(()=>[o(e(Y),{style:{width:"100%"}},{default:a(()=>[v(" Start ")]),_:1})]),_:1},8,["to"])):A("",!0)]),_:1})]),_:1})}}}),ut=$({__name:"EmptyColumn",props:{stages:{}},emits:["stageUpdate"],setup(s,{emit:t}){const l=i=>{t("stageUpdate",i)};return(i,n)=>(r(),d(e(T),{direction:"vertical"},{default:a(()=>[o(de,{"stage-options":i.stages,onStageUpdate:l},null,8,["stage-options"])]),_:1}))}}),ct={style:{width:"100%",padding:"20px"}},dt={class:"stages-container"},pt={class:"stages-content"},gt=$({__name:"Kanban",props:{storage:{},kanbanRepository:{},stageRunRepository:{}},setup(s){const t=s,l=ke(),{closeDrawer:i,inspectStageRun:n,drawerState:u,selectedStageRunForDrawer:_}=je(),{filterFactory:c,filterStatus:p,labelOption:y}=Je(),{kanbanAsyncComputed:I,setStage:F,addStage:k,setup:C,tearDown:P,cardActionHandler:K,increasePagination:f,hasPagination:g}=Me({kanbanRepository:t.kanbanRepository,storage:t.storage,filterFactory:c,router:l});return Se(C),be(P),(m,h)=>(r(),S("div",ct,[o(e(R),{vertical:"",style:{height:"100%"}},{default:a(()=>[o(e(ue),{ghost:""},{default:a(()=>[o(e(ie),{header:"Filters"},{default:a(()=>[o(e(Ke),null,{default:a(()=>[o(e(qe),{label:"Status"},{default:a(()=>[o(e(oe),{value:e(p),"onUpdate:value":h[0]||(h[0]=b=>we(p)?p.value=b:null),style:{width:"325px"}},{default:a(()=>[(r(!0),S(O,null,x(e(Ge),b=>(r(),d(e(se),{key:b,value:b},{default:a(()=>[v(w(e(y)(b)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),V("div",dt,[V("div",pt,[o(e(T),{align:"start"},{default:a(()=>{var b;return[(r(!0),S(O,null,x(((b=e(I).result.value)==null?void 0:b.columns)||[],(D,pe)=>(r(),d(e(it),{key:D.selected_stage.id,column:D,"has-pagination":e(g)(D),onIncreasePagination:E=>e(f)(D),onCardInspection:E=>e(n)(D,E),onCardAction:E=>e(K)(D,E),onStageUpdate:E=>e(F)(E,pe)},null,8,["column","has-pagination","onIncreasePagination","onCardInspection","onCardAction","onStageUpdate"]))),128)),o(e(ut),{stages:e(I).result.value.next_stage_options||[],onStageUpdate:h[1]||(h[1]=D=>e(k)(D))},null,8,["stages"])]}),_:1})])])]),_:1}),e(u).state==="stage-run"&&e(_)?(r(),d(e(ot),{key:0,"kanban-repository":t.kanbanRepository,"stage-run":e(_),"stage-run-repository":t.stageRunRepository,onClose:e(i)},null,8,["kanban-repository","stage-run","stage-run-repository","onClose"])):A("",!0)]))}});const Bt=G(gt,[["__scopeId","data-v-f660bc8e"]]);class zt{constructor(t,l=localStorage){this.contextKey=t,this.storage=l}makeKey(t){return`${this.contextKey}:${t}`}async get(t){const l=this.storage.getItem(this.makeKey(t));return l?JSON.parse(l):null}async set(t,l){this.storage.setItem(this.makeKey(t),JSON.stringify(l))}}export{Bt as K,zt as L};
//# sourceMappingURL=repository.0825af58.js.map
