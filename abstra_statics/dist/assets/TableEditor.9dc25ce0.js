import{d as ee,X as J,H as I,b as s,eu as S,dl as Se,ew as O,ez as Ie,e as A,f as l,eH as Oe,fb as Re,eB as ie,r as N,I as me,eM as ae,c as C,w as a,u as e,bF as R,aq as M,cD as ve,by as W,bf as Le,o as Ve,ad as Ke,v as Ze,eA as xe,G as Ge,a as ze,fc as He,eE as Y,bD as Je,bg as We,be as Ae,aC as fe,cy as Qe,aG as Xe,cF as Ye,eC as Ee,eJ as et,bz as tt,eL as at}from"./outputWidgets.e9677800.js";import{p as Ne,T as X,d as lt}from"./tables.011a2811.js";import{B as nt}from"./BaseLayout.07d4d66c.js";import{a as ge}from"./asyncComputed.37b7af98.js";import{p as oe}from"./popupNotifcation.7148cdf9.js";import"./router.e014ddc2.js";import{P as ye}from"./project.cbeb8ca8.js";import"./index.21e91f9c.js";import{A as Me}from"./index.38c8e62d.js";import{A as U,F as be}from"./Form.9737d51d.js";import{A as le}from"./index.31e940e8.js";import{A as he}from"./index.8ed925b7.js";import{G as rt}from"./PhCaretRight.vue.460a2be4.js";import{a as ut}from"./ant-design.dbbf4726.js";import{E as ot}from"./Base.64d54b8f.js";import{L as st}from"./LoadingOutlined.15e7f451.js";import{A as se}from"./index.42279d35.js";import{D as it}from"./DeleteOutlined.4d93234f.js";import{A as dt}from"./index.64d9fbff.js";import{O as ct}from"./organization.165d6c3c.js";import{G as pt}from"./PhPencil.vue.502d3996.js";import{B as ft,a as mt,c as vt}from"./index.c478ec95.js";import"./record.767f28b7.js";import"./pubsub.9e36d89a.js";import"./string.07505ec9.js";import"./index.cf4c23b9.js";import"./index.a61fac50.js";import"./hasIn.bd3f78ff.js";import"./isNumeric.75337b1e.js";import"./index.bbda4abd.js";import"./Modal.df560cc7.js";import"./Typography.511f4fec.js";import"./DeleteOutlined.f8ba9770.js";import"./ArrowRightOutlined.08fa31dd.js";(function(){try{var f=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},u=new Error().stack;u&&(f._sentryDebugIds=f._sentryDebugIds||{},f._sentryDebugIds[u]="e96b1663-7b2c-4402-9cce-3bab80cd9a99",f._sentryDebugIdIdentifier="sentry-dbid-e96b1663-7b2c-4402-9cce-3bab80cd9a99")}catch{}})();const gt=["width","height","fill","transform"],yt={key:0},bt=A("path",{d:"M176.49,95.51a12,12,0,0,1,0,17l-56,56a12,12,0,0,1-17,0l-24-24a12,12,0,1,1,17-17L112,143l47.51-47.52A12,12,0,0,1,176.49,95.51ZM236,128A108,108,0,1,1,128,20,108.12,108.12,0,0,1,236,128Zm-24,0a84,84,0,1,0-84,84A84.09,84.09,0,0,0,212,128Z"},null,-1),ht=[bt],kt={key:1},wt=A("path",{d:"M224,128a96,96,0,1,1-96-96A96,96,0,0,1,224,128Z",opacity:"0.2"},null,-1),Ct=A("path",{d:"M173.66,98.34a8,8,0,0,1,0,11.32l-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35A8,8,0,0,1,173.66,98.34ZM232,128A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"},null,-1),_t=[wt,Ct],At={key:2},$t=A("path",{d:"M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm45.66,85.66-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35a8,8,0,0,1,11.32,11.32Z"},null,-1),Dt=[$t],St={key:3},It=A("path",{d:"M172.24,99.76a6,6,0,0,1,0,8.48l-56,56a6,6,0,0,1-8.48,0l-24-24a6,6,0,0,1,8.48-8.48L112,151.51l51.76-51.75A6,6,0,0,1,172.24,99.76ZM230,128A102,102,0,1,1,128,26,102.12,102.12,0,0,1,230,128Zm-12,0a90,90,0,1,0-90,90A90.1,90.1,0,0,0,218,128Z"},null,-1),Ot=[It],Lt={key:4},Zt=A("path",{d:"M173.66,98.34a8,8,0,0,1,0,11.32l-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35A8,8,0,0,1,173.66,98.34ZM232,128A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"},null,-1),xt=[Zt],zt={key:5},Et=A("path",{d:"M170.83,101.17a4,4,0,0,1,0,5.66l-56,56a4,4,0,0,1-5.66,0l-24-24a4,4,0,0,1,5.66-5.66L112,154.34l53.17-53.17A4,4,0,0,1,170.83,101.17ZM228,128A100,100,0,1,1,128,28,100.11,100.11,0,0,1,228,128Zm-8,0a92,92,0,1,0-92,92A92.1,92.1,0,0,0,220,128Z"},null,-1),Nt=[Et],Mt={name:"PhCheckCircle"},Ue=ee({...Mt,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(f){const u=f,t=J("weight","regular"),_=J("size","1em"),y=J("color","currentColor"),x=J("mirrored",!1),b=I(()=>{var m;return(m=u.weight)!=null?m:t}),w=I(()=>{var m;return(m=u.size)!=null?m:_}),i=I(()=>{var m;return(m=u.color)!=null?m:y}),j=I(()=>u.mirrored!==void 0?u.mirrored?"scale(-1, 1)":void 0:x?"scale(-1, 1)":void 0);return(m,q)=>(s(),S("svg",Ie({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:w.value,height:w.value,fill:i.value,transform:j.value},m.$attrs),[Se(m.$slots,"default"),b.value==="bold"?(s(),S("g",yt,ht)):b.value==="duotone"?(s(),S("g",kt,_t)):b.value==="fill"?(s(),S("g",At,Dt)):b.value==="light"?(s(),S("g",St,Ot)):b.value==="regular"?(s(),S("g",Lt,xt)):b.value==="thin"?(s(),S("g",zt,Nt)):O("",!0)],16,gt))}}),Ut=["width","height","fill","transform"],qt={key:0},jt=A("path",{d:"M128,20A108,108,0,1,0,236,128,108.12,108.12,0,0,0,128,20Zm0,192a84,84,0,1,1,84-84A84.09,84.09,0,0,1,128,212Zm-12-80V80a12,12,0,0,1,24,0v52a12,12,0,0,1-24,0Zm28,40a16,16,0,1,1-16-16A16,16,0,0,1,144,172Z"},null,-1),Bt=[jt],Tt={key:1},Pt=A("path",{d:"M224,128a96,96,0,1,1-96-96A96,96,0,0,1,224,128Z",opacity:"0.2"},null,-1),Ft=A("path",{d:"M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-8-80V80a8,8,0,0,1,16,0v56a8,8,0,0,1-16,0Zm20,36a12,12,0,1,1-12-12A12,12,0,0,1,140,172Z"},null,-1),Rt=[Pt,Ft],Vt={key:2},Kt=A("path",{d:"M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm-8,56a8,8,0,0,1,16,0v56a8,8,0,0,1-16,0Zm8,104a12,12,0,1,1,12-12A12,12,0,0,1,128,184Z"},null,-1),Gt=[Kt],Ht={key:3},Jt=A("path",{d:"M128,26A102,102,0,1,0,230,128,102.12,102.12,0,0,0,128,26Zm0,192a90,90,0,1,1,90-90A90.1,90.1,0,0,1,128,218Zm-6-82V80a6,6,0,0,1,12,0v56a6,6,0,0,1-12,0Zm16,36a10,10,0,1,1-10-10A10,10,0,0,1,138,172Z"},null,-1),Wt=[Jt],Qt={key:4},Xt=A("path",{d:"M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-8-80V80a8,8,0,0,1,16,0v56a8,8,0,0,1-16,0Zm20,36a12,12,0,1,1-12-12A12,12,0,0,1,140,172Z"},null,-1),Yt=[Xt],ea={key:5},ta=A("path",{d:"M128,28A100,100,0,1,0,228,128,100.11,100.11,0,0,0,128,28Zm0,192a92,92,0,1,1,92-92A92.1,92.1,0,0,1,128,220Zm-4-84V80a4,4,0,0,1,8,0v56a4,4,0,0,1-8,0Zm12,36a8,8,0,1,1-8-8A8,8,0,0,1,136,172Z"},null,-1),aa=[ta],la={name:"PhWarningCircle"},qe=ee({...la,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(f){const u=f,t=J("weight","regular"),_=J("size","1em"),y=J("color","currentColor"),x=J("mirrored",!1),b=I(()=>{var m;return(m=u.weight)!=null?m:t}),w=I(()=>{var m;return(m=u.size)!=null?m:_}),i=I(()=>{var m;return(m=u.color)!=null?m:y}),j=I(()=>u.mirrored!==void 0?u.mirrored?"scale(-1, 1)":void 0:x?"scale(-1, 1)":void 0);return(m,q)=>(s(),S("svg",Ie({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:w.value,height:w.value,fill:i.value,transform:j.value},m.$attrs),[Se(m.$slots,"default"),b.value==="bold"?(s(),S("g",qt,Bt)):b.value==="duotone"?(s(),S("g",Tt,Rt)):b.value==="fill"?(s(),S("g",Vt,Gt)):b.value==="light"?(s(),S("g",Ht,Wt)):b.value==="regular"?(s(),S("g",Qt,Yt)):b.value==="thin"?(s(),S("g",ea,aa)):O("",!0)],16,Ut))}});function $e(f){for(var u=1;u<arguments.length;u++){var t=arguments[u]!=null?Object(arguments[u]):{},_=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(_=_.concat(Object.getOwnPropertySymbols(t).filter(function(y){return Object.getOwnPropertyDescriptor(t,y).enumerable}))),_.forEach(function(y){na(f,y,t[y])})}return f}function na(f,u,t){return u in f?Object.defineProperty(f,u,{value:t,enumerable:!0,configurable:!0,writable:!0}):f[u]=t,f}var ke=function(u,t){var _=$e({},u,t.attrs);return l(Oe,$e({},_,{icon:Re}),null)};ke.displayName="DownOutlined";ke.inheritAttrs=!1;const ra=ke;function De(f){for(var u=1;u<arguments.length;u++){var t=arguments[u]!=null?Object(arguments[u]):{},_=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(_=_.concat(Object.getOwnPropertySymbols(t).filter(function(y){return Object.getOwnPropertyDescriptor(t,y).enumerable}))),_.forEach(function(y){ua(f,y,t[y])})}return f}function ua(f,u,t){return u in f?Object.defineProperty(f,u,{value:t,enumerable:!0,configurable:!0,writable:!0}):f[u]=t,f}var we=function(u,t){var _=De({},u,t.attrs);return l(Oe,De({},_,{icon:ot}),null)};we.displayName="EditOutlined";we.inheritAttrs=!1;const oa=we,je=(f,u)=>u.includes(f)?{status:"error",help:"There already is a column with this name in the table"}:{status:""},sa=ee({__name:"NewColumn",props:{open:{type:Boolean},table:{}},emits:["created","cancel"],setup(f,{emit:u}){const t=f,y=ie().params.projectId,x=I(()=>{var g;return((g=t.table)==null?void 0:g.getColumns().map(p=>p.name))||[]}),b=I(()=>je(i.value.name,x.value)),w={name:"",type:"varchar",default:"",nullable:!0,unique:!1},i=N(w),j=()=>{i.value={...w}},m=N([{value:"reference",label:"reference",isLeaf:!1},...Ne.map(g=>({value:g,label:g,isLeaf:!0}))]),q=g=>{if(!g)return;const p=g[g.length-1];switch(g.length){case 0:return;case 1:p.loading=!0,X.list(y).then($=>{p.children=$.map(T=>({value:T.id,label:T.name,isLeaf:!1})),p.loading=!1});return;case 2:p.loading=!0,X.get(y,p.value).then($=>{p.children=$.getColumns().map(T=>({type:T.type,value:T.id,label:T.name,isLeaf:!0})),p.loading=!1});return}},k=(g,p)=>{if(!!g){if(g.length===1){i.value.type=g[0],i.value.foreignKey=void 0;return}if(g.length===3){const $=p[p.length-1];i.value.type=$.type,i.value.foreignKey={columnId:$.value}}}},L=g=>{const p=g.selectedOptions;return p?p.length===1?p[0].label:p.length===3?`reference to ${p[1].label}(${p[2].label})`:"":"Select type"},h=N({...{status:"success",message:"",fakeLoading:!1}}),V=()=>{h.value.fakeLoading=!0,te()};me(()=>i.value.type,()=>{i.value.default=lt[i.value.type]||"",V()});const te=ae.exports.debounce(async()=>{if(!i.value.default){h.value.status="success",h.value.message="",h.value.fakeLoading=!1;return}const g=`select (${i.value.default})::${i.value.type} `;ye.executeQuery(y,g,[]).then(p=>{h.value.status=p.errors.length>0?"error":"success",h.value.message=p.errors[0]||"",h.value.fakeLoading=!1})},500);function G(){u("cancel")}async function z(){if(!!t.table&&!(!i.value.name||!i.value.type))try{await t.table.addColumn(i.value),j(),u("created")}catch(g){g instanceof Error&&oe("Database error",g.message)}}return(g,p)=>(s(),C(e(he),{title:"New column",width:720,open:t.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:G},{extra:a(()=>[l(e(ve),null,{default:a(()=>[l(e(R),{onClick:G},{default:a(()=>[M("Cancel")]),_:1}),l(e(R),{type:"primary",onClick:z},{default:a(()=>[M("Submit")]),_:1})]),_:1})]),default:a(()=>[l(e(be),{model:i.value,layout:"vertical"},{default:a(()=>[l(e(U),{key:"name",label:"Name",required:"","validate-status":b.value.status,help:b.value.help},{default:a(()=>[l(e(W),{value:i.value.name,"onUpdate:value":p[0]||(p[0]=$=>i.value.name=$)},null,8,["value"])]),_:1},8,["validate-status","help"]),l(e(U),{key:"type",label:"Type",required:""},{default:a(()=>[l(e(Me),{options:m.value,"load-data":q,"display-render":L,"allow-clear":!1,onChange:k},null,8,["options"])]),_:1}),l(e(U),{key:"default-value",label:"Default value","validate-status":h.value.status,help:h.value.message},{default:a(()=>[l(e(W),{value:i.value.default,"onUpdate:value":p[1]||(p[1]=$=>i.value.default=$),onInput:V},{suffix:a(()=>[h.value.fakeLoading?(s(),C(e(Le),{key:0})):O("",!0),!h.value.fakeLoading&&h.value.status==="success"?(s(),C(e(Ue),{key:1,size:"18"})):O("",!0),!h.value.fakeLoading&&h.value.status==="error"?(s(),C(e(qe),{key:2,size:"18"})):O("",!0)]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),l(e(U),{key:"nullable",label:"Nullable"},{default:a(()=>[l(e(le),{checked:i.value.nullable,"onUpdate:checked":p[2]||(p[2]=$=>i.value.nullable=$)},null,8,["checked"])]),_:1}),l(e(U),{key:"unique",label:"Unique"},{default:a(()=>[l(e(le),{checked:i.value.unique,"onUpdate:checked":p[3]||(p[3]=$=>i.value.unique=$)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"]))}}),ia={class:"twin-container"},da={class:"fullwidth-input"},ca={class:"fullwidth-input"},pa={class:"using-container"},fa={class:"fullwidth-input"},ma=ee({__name:"UpdateColumn",props:{open:{type:Boolean},table:{},column:{}},emits:["updated","cancel"],setup(f,{emit:u}){const t=f,y=ie().params.projectId,x=N(t.column.record.initialState.type);Ve(async()=>{if(!t.column.foreignKey)return;x.value="loading...";const n=await X.fromColumnId(y,t.column.foreignKey.columnId),r=n.getColumn(t.column.foreignKey.columnId);x.value=`reference to ${n.name}(${r.name})`});const b=I(()=>{var n;return((n=t.table)==null?void 0:n.getColumns().map(r=>r.record.initialState.name))||[]}),w=I(()=>t.column.name===t.column.record.initialState.name?{status:"",help:""}:je(t.column.name,b.value)),{result:i,loading:j}=ge(async()=>t.table.select({},10,0).then(({total:n})=>n));function m(){t.column.record.resetChanges(),u("cancel")}const k=N({status:"success",message:"",fakeLoading:!1}),L=()=>{k.value.fakeLoading=!0,B()},B=ae.exports.debounce(async()=>{if(!t.column.default){k.value.status="success",k.value.message="",k.value.fakeLoading=!1;return}const n=`select (${t.column.default})::${t.column.type} `,r=await ye.executeQuery(y,n,[]);k.value.status=r.errors.length>0?"error":"success",k.value.message=r.errors[0]||"",k.value.fakeLoading=!1},500),h=N([{value:"reference",label:"reference",isLeaf:!1},...Ne.map(n=>({value:n,label:n,isLeaf:!0}))]),V=n=>{if(!n)return;const r=n[n.length-1];switch(n.length){case 0:return;case 1:r.loading=!0,X.list(y).then(d=>{r.children=d.map(P=>({value:P.id,label:P.name,isLeaf:!1})),r.loading=!1});return;case 2:r.loading=!0,X.get(y,r.value).then(d=>{r.children=d.getColumns().map(P=>({type:P.type,value:P.id,label:P.name,isLeaf:!0})),r.loading=!1});return}},ne=n=>{const r=n.selectedOptions;return r?r.length===1?r[0].label:r.length===3?`reference to ${r[1].label}(${r[2].label})`:"":"Select type"},te=(n,r)=>{if(!!n){if(n.length===1){t.column.type=n[0],t.column.foreignKey=null;return}if(n.length===3){if(t.column.foreignKey&&t.column.foreignKey.columnId===n[2])return;const d=r[r.length-1];t.column.type=d.type,t.column.foreignKey={columnId:d.value}}}},G=()=>i.value===0||j.value?!1:t.column.record.hasChangesDeep("type"),z=N({type:"default"}),g=()=>{t.column.type=t.column.record.initialState.type,z.value={type:"default"}};function p(n,r){return r==="varchar"||n==="int"&&r==="boolean"||n==="boolean"&&r==="int"}me(()=>t.column.type,()=>{L(),T.value||(z.value={type:"user-defined",using:Q.value,mandatory:!0})});const T=I(()=>z.value.type==="default"&&p(t.column.record.initialState.type,t.column.type)),re=I(()=>!p(t.column.record.initialState.type,t.column.type));function ue(n){n?z.value={type:"default"}:z.value={type:"user-defined",using:Q.value,mandatory:!1}}function de(n){if(z.value.type==="default")throw new Error("Can't change using when using default casting");z.value.using=n!=null?n:""}const H=()=>re.value?!0:G()&&z.value.type==="user-defined",Q=I(()=>`${t.column.record.initialState.name}::${t.column.type}`);async function ce(){if(!t.column)return;let n=z.value.type==="default"?Q.value:z.value.using;i.value===0&&(n=`${t.column.name}::text::${t.column.type}`);try{await t.column.update(n),u("updated")}catch(r){r instanceof Error&&oe("Database error",r.message)}}return(n,r)=>(s(),C(e(he),{title:"Edit column",width:720,open:n.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:m},{extra:a(()=>[l(e(ve),null,{default:a(()=>[l(e(R),{onClick:m},{default:a(()=>[M("Cancel")]),_:1}),l(e(R),{type:"primary",onClick:ce},{default:a(()=>[M("Submit")]),_:1})]),_:1})]),default:a(()=>[l(e(be),{model:n.column,layout:"vertical"},{default:a(()=>[l(e(U),{key:"name",label:"Name","validate-status":w.value.status,help:w.value.help},{default:a(()=>[l(e(W),{value:n.column.name,"onUpdate:value":r[0]||(r[0]=d=>n.column.name=d)},null,8,["value"])]),_:1},8,["validate-status","help"]),A("div",ia,[A("span",da,[l(e(U),{key:"type",label:"Current Type"},{default:a(()=>[l(e(Ke),{value:x.value,"onUpdate:value":r[1]||(r[1]=d=>x.value=d),"default-active-first-option":"",disabled:""},null,8,["value"])]),_:1})]),l(e(rt),{class:"right-arrow"}),A("span",ca,[l(e(U),{key:"new-type",label:"New Type"},{default:a(()=>[l(e(Me),{options:h.value,"load-data":V,"display-render":ne,"allow-clear":!0,onClear:g,onChange:te},null,8,["options"])]),_:1})])]),l(e(U),{key:"default-value",label:"Default value","validate-status":k.value.status,help:k.value.message},{default:a(()=>[l(e(W),{value:n.column.default,"onUpdate:value":r[2]||(r[2]=d=>n.column.default=d),onInput:L},{suffix:a(()=>[k.value.fakeLoading?(s(),C(e(Le),{key:0,size:"small"})):O("",!0),!k.value.fakeLoading&&k.value.status==="success"?(s(),C(e(Ue),{key:1,size:18})):O("",!0),!k.value.fakeLoading&&k.value.status==="error"?(s(),C(e(qe),{key:2,size:18})):O("",!0)]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),A("div",pa,[G()?(s(),C(e(U),{key:"default-casting",label:"Use default casting"},{default:a(()=>[l(e(le),{checked:T.value,disabled:re.value,"onUpdate:checked":r[3]||(r[3]=d=>ue(!!d))},null,8,["checked","disabled"])]),_:1})):O("",!0),A("span",fa,[G()?(s(),C(e(U),{key:"using",label:"Using"},{default:a(()=>[l(e(W),{value:z.value.type==="user-defined"?z.value.using:Q.value,disabled:!H(),onInput:r[4]||(r[4]=d=>de(d.target.value))},null,8,["value","disabled"])]),_:1})):O("",!0)])]),l(e(U),{key:"nullable",label:"Nullable"},{default:a(()=>[l(e(le),{checked:n.column.nullable,"onUpdate:checked":r[5]||(r[5]=d=>n.column.nullable=d)},null,8,["checked"])]),_:1}),l(e(U),{key:"unique",label:"Unique"},{default:a(()=>[l(e(le),{checked:n.column.unique,"onUpdate:checked":r[6]||(r[6]=d=>n.column.unique=d)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"]))}});const va=Ze(ma,[["__scopeId","data-v-795220e4"]]),ga={class:"table-data",style:{width:"calc(100% - 120px)"}},ya={style:{overflow:"hidden","white-space":"wrap"}},ba={key:1},ha={key:1},ka={key:1},wa=["onClick"],Ca=A("a",null,"Delete",-1),_a=ee({__name:"TableData",props:{table:{},loading:{type:Boolean}},emits:["refresh"],setup(f,{emit:u}){var Ce;const t=f,_=N(1),y=N(10),x=I(()=>{var o,v;return{total:(v=(o=g.value)==null?void 0:o.total)!=null?v:0,current:_.value,pageSize:y.value,totalBoundaryShowSizeChanger:10,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:async(D,c)=>{_.value=D,y.value=c,await $()}}}),b=ie(),w=xe(),i=N(typeof b.query.q=="string"?b.query.q:""),j=I(()=>{try{return JSON.parse(b.query.where)}catch{return{}}});me(i,()=>{w.replace({query:{...b.query,where:JSON.stringify(b.query.value),q:i.value}})});const m=N(!1),q=N({type:"idle"}),k=()=>{m.value=!0,L()},L=ae.exports.debounce(()=>{$(),m.value=!1},500);function B(){q.value={type:"idle"}}async function h(){B(),u("refresh"),await $(),Q()}function V(){q.value={type:"creating"}}const ne=o=>{if(!t.table)throw new Error("Table not found");q.value={type:"editing",column:t.table.getColumn(o)}};async function te(o){await ut("Are you sure you want to delete this column?")&&await G(o)}async function G(o){var v,D;await((D=(v=t.table)==null?void 0:v.getColumn(o))==null?void 0:D.delete()),u("refresh"),await $(),Q()}const z=I(()=>{var o;return((o=g.value)==null?void 0:o.rows.length)===1}),{result:g,loading:p,refetch:$}=ge(()=>Promise.all([t.table.select(j.value,(_.value-1)*y.value,y.value,i.value),Promise.all(t.table.getColumns().filter(o=>o.foreignKey).map(o=>X.fromColumnId(b.params.projectId,o.foreignKey.columnId).then(v=>[o.name,v])))]).then(([{rows:o,total:v},D])=>({rows:o,total:v,columns:D.reduce((c,[E,F])=>({...c,[E]:F}),{})}))),T=(o,v)=>{var F,Z;const D=(F=t.table)==null?void 0:F.getColumns().find(K=>K.name===o);if(!D)return"";const c=(Z=g.value)==null?void 0:Z.columns[D.name],E=c==null?void 0:c.getColumns().find(K=>{var _e;return K.id===((_e=D.foreignKey)==null?void 0:_e.columnId)});return!c||!E?"":{name:"tableEditor",params:{projectId:b.params.projectId,tableId:c.id},query:{where:JSON.stringify({[E.name]:v})}}},re=(o,v)=>D=>{if(o==="json"&&D==""){d.value[v]="null";return}d.value[v]=D},ue=()=>[...t.table.getColumns().map(o=>{var v;return{key:(v=o.id)!=null?v:"",title:o.name,dataIndex:o.name,width:220,resizable:!0,ellipsis:!1}}),{key:"action",title:"",fixed:"right",width:100,align:"center",resizable:!1,ellipsis:!1}],de=ue(),H=N(de),Q=()=>H.value=ue();function ce(o,v){H.value=H.value.map(D=>D.key===v.key?{...D,width:o}:D)}const n=I(()=>{var o;return((o=g.value)==null?void 0:o.rows.map(v=>({key:v.id,...v})))||[]}),r=N(!1),d=N({}),P=()=>{r.value=!0},pe=()=>{d.value={},r.value=!1};let Be=Ge((Ce=t.table)==null?void 0:Ce.getUnprotectedColumns().reduce((o,v)=>({...o,[v.name]:""}),{}));async function Te(){if(!(!t.table||!Be))try{d.value.id?await t.table.updateRow(d.value.id,d.value):await t.table.insertRow(d.value),d.value={},$(),pe()}catch(o){o instanceof Error&&oe("Database error",o.message)}}const Pe=async o=>{if(!(!g.value||!g.value.rows.find(v=>v.id===o)))try{await t.table.deleteRow(o),z.value&&(_.value=Math.max(1,_.value-1)),$()}catch(v){v instanceof Error&&oe("Database error",v.message)}},Fe=o=>{var F;const v=(F=n.value)==null?void 0:F.filter(Z=>o===Z.key)[0],D=t.table.getColumns(),c=D.map(Z=>Z.name),E=D.filter(Z=>Z.type==="json").map(Z=>Z.name);d.value=ae.exports.pick(ae.exports.cloneDeep(v),c),E.forEach(Z=>{d.value[Z]&&(d.value[Z]=JSON.stringify(d.value[Z]))}),P()};return(o,v)=>{const D=ze("router-link");return s(),S("div",ga,[l(e(se),{justify:"space-between",style:{"margin-bottom":"16px"},gap:"middle"},{default:a(()=>[l(e(W),{value:i.value,"onUpdate:value":[v[0]||(v[0]=c=>i.value=c),k],placeholder:"Search",style:{width:"400px"},"allow-clear":""},{prefix:a(()=>[l(e(He))]),suffix:a(()=>[m.value?(s(),C(e(st),{key:0})):O("",!0)]),_:1},8,["value"]),l(e(R),{type:"primary",onClick:V},{default:a(()=>[M("+ Add new column")]),_:1})]),_:1}),l(e(Ye),{columns:H.value,"data-source":n.value,pagination:x.value,bordered:"",loading:e(p)||o.loading,scroll:{x:1e3,y:720},size:"small",onResizeColumn:ce},{headerCell:a(({column:c})=>[c.title!=="id"&&c.title!=="created_at"&&c.key!=="action"?(s(),C(e(se),{key:0,align:"center",justify:"space-between",gap:"small"},{default:a(()=>[A("span",ya,Y(c.title),1),l(e(Je),{placement:"bottomRight",trigger:"click"},{overlay:a(()=>[l(e(We),null,{default:a(()=>[l(e(Ae),{onClick:E=>ne(String(c.key))},{icon:a(()=>[l(e(oa))]),default:a(()=>[M(" Edit ")]),_:2},1032,["onClick"]),l(e(Ae),{danger:"",onClick:E=>te(String(c.key))},{icon:a(()=>[l(e(it))]),default:a(()=>[M(" Delete ")]),_:2},1032,["onClick"])]),_:2},1024)]),default:a(()=>[l(e(ra))]),_:2},1024)]),_:2},1024)):(s(),S("span",ba,Y(c.title),1))]),bodyCell:a(({column:c,text:E,record:F})=>{var Z;return[H.value.map(K=>K.title).includes(c.dataIndex)?(s(),S(fe,{key:0},[(Z=o.table.getColumns().find(K=>K.name===c.dataIndex))!=null&&Z.foreignKey?(s(),C(D,{key:0,to:T(c.dataIndex,E),target:"_blank"},{default:a(()=>[M(Y(E),1)]),_:2},1032,["to"])):(s(),S("span",ha,Y(E),1))],64)):O("",!0),c.key==="action"?(s(),S("div",ka,[A("span",null,[A("a",{onClick:K=>Fe(F.id)},"Edit",8,wa)]),l(e(dt),{type:"vertical"}),l(e(Qe),{title:"Sure to delete?",onConfirm:K=>Pe(F.id)},{default:a(()=>[Ca]),_:2},1032,["onConfirm"])])):O("",!0)]}),footer:a(()=>[H.value.length===3?(s(),C(e(Xe),{key:0,title:"Add a first column prior to data entry",placement:"right"},{default:a(()=>[l(e(R),{type:"primary",disabled:!0,onClick:P},{default:a(()=>[M(" + Add New Data ")]),_:1})]),_:1})):(s(),C(e(R),{key:1,type:"primary",onClick:P},{default:a(()=>[M("+ Add New Data")]),_:1}))]),_:1},8,["columns","data-source","pagination","loading"]),l(e(he),{title:"Data",width:720,open:r.value,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:pe},{extra:a(()=>[l(e(ve),null,{default:a(()=>[l(e(R),{onClick:pe},{default:a(()=>[M("Cancel")]),_:1}),l(e(R),{type:"primary",onClick:Te},{default:a(()=>[M("Submit")]),_:1})]),_:1})]),default:a(()=>[l(e(be),{model:d.value,layout:"vertical"},{default:a(()=>[(s(!0),S(fe,null,Ee(o.table.getUnprotectedColumns(),c=>(s(),C(e(U),{key:c.id,label:c.name,required:!c.nullable},{default:a(()=>[d.value?(s(),C(e(W),{key:0,placeholder:c.type,value:d.value[c.name],disabled:d.value[c.name]===null,"onUpdate:value":E=>re(c.type,c.name)(E)},et({_:2},[c.nullable?{name:"addonAfter",fn:a(()=>[l(e(tt),{checked:d.value[c.name]===null,"onUpdate:checked":E=>d.value[c.name]=E?null:""},{default:a(()=>[M(" NULL ")]),_:2},1032,["checked","onUpdate:checked"])]),key:"0"}:void 0]),1032,["placeholder","value","disabled","onUpdate:value"])):O("",!0)]),_:2},1032,["label","required"]))),128))]),_:1},8,["model"])]),_:1},8,["open"]),o.table&&q.value.type==="creating"?(s(),C(sa,{key:0,open:"",table:t.table,onClose:B,onCancel:B,onCreated:h},null,8,["table"])):O("",!0),o.table&&q.value.type==="editing"?(s(),C(va,{key:1,column:q.value.column,open:"",table:o.table,onUpdated:h,onClose:B,onCancel:B},null,8,["column","table"])):O("",!0)])}}});const Aa={style:{"font-size":"20px"}},$a=ee({__name:"TableEditor",setup(f){const u=xe(),t=ie(),_=t.params.tableId,y=t.params.projectId,x=N(!1),b=()=>{var k;x.value=!1,(k=w.value)==null||k.table.save(),j()},{result:w,loading:i,refetch:j}=ge(()=>Promise.all([ye.get(y).then(async k=>{const L=await ct.get(k.organizationId);return{project:k,organization:L}}),X.get(y,_)]).then(([{project:k,organization:L},B])=>at({project:k,organization:L,table:B}))),m=I(()=>!i.value&&w.value?[{label:"My organizations",path:"/organizations"},{label:w.value.organization.name,path:`/organizations/${w.value.organization.id}`},{label:w.value.project.name,path:`/projects/${w.value.project.id}/tables`}]:void 0);function q(){u.push({name:"tables",params:{projectId:y}})}return(k,L)=>{const B=ze("router-link");return s(),C(nt,null,{navbar:a(()=>[l(e(vt),{style:{padding:"5px 25px"},onBack:q},{title:a(()=>[x.value?(s(),C(e(se),{key:1,align:"center",gap:"large"},{default:a(()=>[e(w)?(s(),C(e(W),{key:0,value:e(w).table.name,"onUpdate:value":L[1]||(L[1]=h=>e(w).table.name=h),class:"borderless-input"},null,8,["value"])):O("",!0),l(e(R),{onClick:b},{default:a(()=>[M("Save")]),_:1})]),_:1})):(s(),C(e(se),{key:0,align:"center",gap:"small"},{default:a(()=>{var h;return[A("span",Aa,Y((h=e(w))==null?void 0:h.table.name),1),l(e(pt),{size:"22",style:{cursor:"pointer"},onClick:L[0]||(L[0]=V=>x.value=!0)})]}),_:1}))]),breadcrumb:a(()=>[m.value?(s(),C(e(ft),{key:0},{default:a(()=>[(s(!0),S(fe,null,Ee(m.value,(h,V)=>(s(),C(e(mt),{key:V},{default:a(()=>[l(B,{to:h.path},{default:a(()=>[M(Y(h.label),1)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1})):O("",!0)]),_:1})]),content:a(()=>[e(w)?(s(),C(_a,{key:0,loading:e(i),table:e(w).table,onRefresh:L[2]||(L[2]=h=>e(j)())},null,8,["loading","table"])):O("",!0)]),_:1})}}});const ul=Ze($a,[["__scopeId","data-v-de962a93"]]);export{ul as default};
//# sourceMappingURL=TableEditor.9dc25ce0.js.map
