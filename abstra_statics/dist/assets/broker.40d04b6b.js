var he=Object.defineProperty;var fe=(u,e,r)=>e in u?he(u,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):u[e]=r;var l=(u,e,r)=>(fe(u,typeof e!="symbol"?e+"":e,r),r);import{a as x}from"./index.f7c9d8bb.js";import{e as pe,R as me,P as ve}from"./executeJs.bd844f45.js";import{L as ge}from"./CircularLoading.fd7c6289.js";import{W as ye}from"./WidgetsFrame.27568d20.js";import{d as R,a as we,b as c,et as y,c as b,ew as A,aD as be,x as D,r as E,w as oe,aJ as ke,u as z,t as ee,e as U,eC as J,J as te,K as _e,H as Ee,eQ as re,o as Se,N as Pe,ey as ne,f as q,eR as We,eS as Le,eT as Ce,bg as T,eB as V,eI as Ae,eU as H}from"./outputWidgets.ec044eb8.js";import{_ as Ie}from"./ActionButton.vue_vue_type_script_setup_true_lang.a4950b2a.js";import{r as Be,t as Fe}from"./icons.a554ebda.js";(function(){try{var u=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(u._sentryDebugIds=u._sentryDebugIds||{},u._sentryDebugIds[e]="ca4e1edc-8c47-438b-9492-01fd82f2c3f6",u._sentryDebugIdIdentifier="sentry-dbid-ca4e1edc-8c47-438b-9492-01fd82f2c3f6")}catch{}})();function P(u){return"key"in u&&"value"in u&&"errors"in u}class K{constructor(e,r){l(this,"endedByPage",!1);l(this,"reactivePollInterval",null);l(this,"seq",0);l(this,"programEnded",!1);l(this,"widgetError",()=>{this.newPageState({widgets:[{type:"error"}],actions:[],fullWidth:!1,steps:null})});l(this,"widgetEnd",()=>{this.endedByPage||this.newPageState({widgets:[{type:"end"}],actions:this.pageActionFactory.restartAction,fullWidth:!1,steps:null})});l(this,"sendUser",e=>{this.broker.send({type:"auth:saved-jwt",jwt:e.jwt})});l(this,"sendBrowserTryDisconnect",()=>{this.broker.send({type:"browser:try-disconnect"})});l(this,"newPageStateListener",()=>{});l(this,"updatePageStateListener",()=>{});l(this,"onReactivePollListener",()=>{});l(this,"onErrorListener",()=>{});l(this,"onExitListener",()=>{});l(this,"onStartAuthListener");l(this,"onEndAuthListener");l(this,"onBadAuthListener");this.broker=e,this.pageActionFactory=r}static create(e,r,i){const n=new K(e,r);return n.broker.onClose(()=>{if(n.programEnded)return;const s="Connection with service closed before program ended";n.widgetError(),n.error(s)}),n.broker.on("form",({widgets:s,actions:o,buttonText:f,endProgram:g,reactivePollingInterval:k,steps:I})=>{n.newPageState({widgets:s,actions:n.pageActionFactory.fromPageActionsDto(f?[f]:o!=null?o:[]),fullWidth:s.some(B=>"fullWidth"in B&&B.fullWidth),steps:I}),k&&(n.reactivePollInterval=setInterval(n.onReactivePollListener,k*1e3)),g&&(n.endedByPage=!0,n.broker.send({type:"form-response",payload:{},secrets:[],seq:++n.seq}))}),n.broker.on("execute-js:request",async s=>{const o=await pe(s);n.broker.send(o)}),n.broker.on("auth:require-info",s=>{n.newPageState({widgets:[],actions:[],fullWidth:!1,steps:null}),n.onStartAuthListener&&n.onStartAuthListener(s)}),n.broker.on("auth:valid-jwt",()=>{n.onEndAuthListener&&n.onEndAuthListener()}),n.broker.on("auth:invalid-jwt",()=>{console.warn("invalid jwt"),n.onBadAuthListener&&n.onBadAuthListener()}),n.broker.on("program:connection-error",s=>{n.widgetError(),n.error(s)}),n.broker.on("program:end",s=>{n.programEnded=!0,s.exitStatus!=="SUCCESS"||s.exception?(n.widgetError(),n.error(s)):(n.widgetEnd(),n.exit(s))}),n.broker.on("redirect",s=>{i.onRedirect(s.url,s.queryParams)}),n.broker.on("program:disconnect",s=>{n.exit(s)}),n.broker.on("not-enough-credits",()=>{n.error({error:"not-enough-credits"}),n.programEnded=!0}),n.broker.on("heartbeat",()=>{n.broker.resetHeartbeatCounter()}),n.broker.on("form-update",({widgets:s,validation:o,seq:f})=>{f===n.seq&&n.updatePageState({widgets:s,error:{message:o.message,status:o.status},fullWidth:s.some(g=>"fullWidth"in g&&g.fullWidth)})}),n}handleAction(e,r,i){this.reactivePollInterval&&clearInterval(this.reactivePollInterval);const n={};Object.entries(e).forEach(([s,o])=>{n[s]=o}),this.broker.send({type:"form-response",payload:n,action:r==null?void 0:r.name,secrets:i,seq:++this.seq})}sendUserEvent(e,r){const i={};Object.entries(e).forEach(([n,s])=>{i[n]=s}),this.broker.send({type:"user-event",payload:i,secrets:r,seq:++this.seq})}init(e){this.broker.resetState(),this.newPageState({widgets:[],actions:[],fullWidth:!1,steps:null}),this.broker.connect(e!=null?e:{})}newPageState(e){this.newPageStateListener(e)}updatePageState(e){this.updatePageStateListener(e)}listenToNewPageState(e){this.newPageStateListener=e}listenToPageStateUpdate(e){this.updatePageStateListener=e}onReactivePoll(e){this.onReactivePollListener=e}error(e){this.reactivePollInterval&&clearInterval(this.reactivePollInterval),this.onErrorListener(e)}onError(e){this.onErrorListener=e}exit(e){this.reactivePollInterval&&clearInterval(this.reactivePollInterval),this.onExitListener(e)}onExit(e){this.onExitListener=e}onStartAuth(e){this.onStartAuthListener=e}onEndAuth(e){this.onEndAuthListener=e}onBadAuth(e){this.onBadAuthListener=e}}class W{constructor(e,r){l(this,"element",null);this.name=e,this.isDefault=r}static fromDto(e){return typeof e=="string"?new W(e,!1):new W(e.name,e.is_default)}setElement(e){e instanceof HTMLElement&&(this.element=e)}get isFocused(){return this.element===document.activeElement}focusOnButton(){var e;(e=this.element)==null||e.focus()}addKeydownListener(e){var r;(r=this.element)==null||r.addEventListener("keydown",e)}}class G{constructor(e){this.form=e}static from(e){return new G(e)}get startAction(){var e;return[W.fromDto((e=this.form.startButtonText)!=null?e:"Start")]}get restartAction(){var r;const e=(r=this.form.restartButtonText)!=null?r:"Restart";return this.form.allowRestart?[W.fromDto(e)]:[]}fromPageActionsDto(e){return e.filter(r=>!!r).map(r=>W.fromDto(r))}}const xe={class:"outline-button"},Ue=R({__name:"OutlineButton",props:{iconPath:{},noShadow:{type:Boolean},status:{}},setup(u){return(e,r)=>{const i=we("icon");return c(),y("button",xe,[e.iconPath?(c(),b(i,{key:0,path:e.iconPath,fill:"#fff",class:"icon"},null,8,["path"])):A("",!0),be(e.$slots,"default",{},void 0,!0)])}}});const Re=D(Ue,[["__scopeId","data-v-d16448de"]]),De=R({__name:"FormAutoFill",props:{broker:{},form:{}},setup(u){const e=u,r=window.__runs||(window.__runs={previous:[],current:[]});e.broker.on("start",()=>{r.previous=r.current,r.current=[]});const i=E(null);function n(){for(const f in r.current){const g=r.previous[f],k=r.current[f];if(!g||g.type!==k.type||g.type=="form"&&!ee.exports.isEqual(g.widgets,k.widgets)||g.type=="form-response"&&!ee.exports.isEqual(g.payload,k.payload))return null}const o=r.previous[r.current.length];if((o==null?void 0:o.type)!=="form-response")return null;i.value=o}function s(){const o=i.value;o&&e.broker.send(o)}return e.broker.on("form",o=>{r.current.push(o),n()}),e.broker.on("form-response",o=>{r.current.push(o),i.value=null}),(o,f)=>i.value?(c(),b(Re,{key:0,"icon-path":z(Be),class:"form-auto-fill-btn",onClick:s},{default:oe(()=>[ke(" Repeat last answer ")]),_:1},8,["icon-path"])):A("",!0)}});const je=D(De,[["__scopeId","data-v-9590d96b"]]),$e={key:0,class:"hint"},Ne={class:"icon",viewBox:"0 0 24 24",style:{width:"20px",height:"20px"}},Oe=["d"],qe={class:"hint-content"},Te=R({__name:"WidgetHint",props:{hint:{}},setup(u){return(e,r)=>e.hint?(c(),y("div",$e,[(c(),y("svg",Ne,[U("path",{d:z(Fe)},null,8,Oe)])),U("div",qe,J(e.hint),1)])):A("",!0)}});const Ve=D(Te,[["__scopeId","data-v-419a518f"]]),He={key:0,class:"form-wrapper"},Me=["id"],Je={key:1,class:"loading-wrapper"},ze={key:2,class:"span-error"},Ke={class:"buttons"},Ge=R({__name:"FormRunner",props:{form:{},params:{},isPreview:{type:Boolean},enableAutoFocus:{type:Boolean},broker:{}},emits:["log","error","exit","navigate","logout","start","redirect"],setup(u,{expose:e,emit:r}){const i=u,n=[],s=E({}),o=E({}),f=E({}),g=(t,a)=>{n[a]=t},k=E(null),I=te(()=>G.from(i.form)),B=t=>r("navigate",t),j=()=>{h.value={widgets:[{type:"start"}],actions:I.value.startAction,fullWidth:!1,steps:null}};_e(()=>i.form,()=>{var t;((t=h.value.widgets[0])==null?void 0:t.type)=="start"&&j()});const w=Ee({user:null,authenticating:!1}),h=E({widgets:[],fullWidth:!1,actions:[],steps:null}),L=E("idle"),Q=te(()=>h.value.widgets.filter(t=>"secret"in t).reduce((t,a)=>"key"in a&&"secret"in a?[...t,{key:a.key,secret:a.secret}]:t,[]));$();function $(){w.user=x.getUser()}const ae=()=>{x.removeUser(),$(),r("logout")},v=K.create(i.broker,I.value,{onRedirect(t,a){r("redirect",t,a)}});v.onError(t=>{var a;if(r("error",t),L.value="error",t.error==="not-enough-credits"){(a=k.value)==null||a.open(),j();return}}),v.onExit(t=>{r("exit",t),L.value="over"}),v.onStartAuth(t=>{t.refresh?(x.removeUser(),$(),w.authenticating=!0):w.user?v.sendUser(w.user):w.authenticating=!0}),v.onEndAuth(()=>{w.authenticating=!1}),v.onBadAuth(()=>{x.removeUser(),w.user=null,w.authenticating=!0}),v.onReactivePoll(()=>{v.sendUserEvent(s.value,Q.value)});const ie=t=>{w.user=t,v.sendUser(t)};v.listenToNewPageState(t=>{h.value=t,re.init(i.enableAutoFocus,()=>N());const a={},p={};h.value.widgets.forEach(m=>{P(m)&&(a[m.key]=m.value,p[m.key]=m.errors)}),s.value=a,o.value=p,f.value={}}),v.listenToPageStateUpdate(t=>{h.value={...h.value,...t};const a={},p={};h.value.widgets.forEach(m=>{P(m)&&(a[m.key]=m.value,p[m.key]=m.errors)}),s.value=a,o.value=p});const X=t=>{var a;if(!(L.value!=="running"||i.isPreview||!((a=window.should_ask_before_leave)==null||a)))return v.sendBrowserTryDisconnect(),t.preventDefault(),t.returnValue="Are you sure?",""};Se(async()=>{window.addEventListener("beforeunload",X),j(),re.init(i.enableAutoFocus,t=>N(t)),i.form.autoStart&&O()}),Pe(()=>{i.broker.close(),window.removeEventListener("beforeunload",X)});const le=()=>{n.forEach(t=>{!t||!("setErrors"in t)||typeof t.setErrors!="function"||t.setErrors()})},N=async t=>{if(L.value!=="running")return O();le(),!(Object.values(f.value).some(p=>p.length>0)&&(t==null?void 0:t.name)!=="i18n_back_action")&&v.handleAction(s.value,t,Q.value)},O=async()=>{v.init(i.params),L.value="running",r("start")};function ue(t){var a;return P(t)&&(a=s.value[t.key])!=null?a:null}function Y(t){var C;if(!P(t))return[];const a=t.errors.map(d=>H.get(d,t)),m=((C=f.value[t.key])!=null?C:[]).map(d=>H.get(d,t));return[...a,...m]}function ce(t,a){if(!P(t))return;const p={...s.value};p[t.key]=a,s.value=p,v.sendUserEvent(s.value)}function de(t,a){if(!P(t))return;const p={...f.value};p[t.key]=a,f.value=p}return e({run:O}),(t,a)=>(c(),b(ye,{class:ne([{preview:t.isPreview},"runner"]),"main-color":t.form.mainColor,theme:t.form.theme,"font-family":t.form.fontFamily,runtime:"form"},{default:oe(()=>{var p,m,C;return[t.isPreview?(c(),b(je,{key:0,class:"auto-fill-btn",broker:t.broker,form:t.form,style:{"z-index":1}},null,8,["broker","form"])):A("",!0),q(me,{ref_key:"runtimeCommonsRef",ref:k,runtime:t.form,"full-width":h.value.fullWidth,"steps-info":h.value.steps,"is-preview":t.isPreview,"user-email":(p=w.user)==null?void 0:p.claims.email,type:"forms",onLogout:ae,onNavigate:B},null,8,["runtime","full-width","steps-info","is-preview","user-email"]),U("main",null,[w.authenticating?(c(),b(ve,{key:0,class:"form-auth",onDone:ie})):(c(),y("div",{key:1,class:ne(["form",{"full-width":h.value.fullWidth}])},[h.value.widgets.length>0?(c(),y("div",He,[h.value.widgets[0].type=="start"?(c(),b(We,{key:0,form:t.form},null,8,["form"])):h.value.widgets[0].type=="end"?(c(),b(Le,{key:1,"end-message":t.form.endMessage},null,8,["end-message"])):h.value.widgets[0].type=="error"?(c(),b(Ce,{key:2,"error-message":t.form.errorMessage},null,8,["error-message"])):(c(!0),y(T,{key:3},V(h.value.widgets,(d,F)=>{var Z;return c(),y("div",{id:d.type+F,key:(Z=d.key)!=null?Z:d.type+F,class:"widget"},[(c(),b(Ae(d.type),{ref_for:!0,ref:_=>g(_,F),value:ue(d),errors:Y(d),"user-props":d,runtime:"form","onUpdate:value":_=>ce(d,_),"onUpdate:errors":_=>de(d,_)},null,40,["value","errors","user-props","onUpdate:value","onUpdate:errors"])),q(Ve,{hint:"hint"in d?d.hint:null},null,8,["hint"]),(c(!0),y(T,null,V(Y(d),_=>(c(),y("span",{key:_,class:"span-error"},J(_),1))),128))],8,Me)}),128))])):(c(),y("div",Je,[q(ge)])),(m=h.value.error)!=null&&m.message?(c(),y("span",ze,J((C=h.value.error)==null?void 0:C.message),1)):A("",!0),U("div",Ke,[(c(!0),y(T,null,V(h.value.actions,d=>(c(),b(Ie,{key:d.name,"display-name":z(H).get(d.name),action:d,onClick:F=>N(d)},null,8,["display-name","action","onClick"]))),128))])],2))])]}),_:1},8,["class","main-color","theme","font-family"]))}});const ot=D(Ge,[["__scopeId","data-v-1e8d2bdc"]]),Qe=[WebSocket.CLOSING,WebSocket.CLOSED];function se(u,e){const r=u[e.type];if(!r){console.warn("no callback for",e.type);return}r.forEach(i=>i(e))}const S=class{constructor(e){l(this,"formPath",null);l(this,"ws",null);l(this,"callbacks",{"form-response":[],"execute-js:request":[],"execute-js:response":[],"form-update":[],start:[],"auth:info":[],"auth:saved-jwt":[],"auth:restart":[],"auth:validate-token":[],"auth:resend-token":[],heartbeat:[],"action-response":[],"user-event":[],"program:end":[],"program:disconnect":[],"program:connection-error":[],"files:changed":[],redirect:[],stderr:[],stdout:[],form:[],"not-enough-credits":[],"auth:require-info":[],"auth:expecting-token":[],"auth:token-expired":[],"auth:invalid-token":[],"auth:invalid-jwt":[],"auth:valid-token":[],"auth:valid-jwt":[],"browser:disconnect":[],"browser:try-disconnect":[]});l(this,"onCloseCallbacks",[]);l(this,"heartbeatCounter",0);l(this,"heartbeatInterval");l(this,"params",{});var r;"formPath"in e&&(this.formPath=(r=e.formPath)!=null?r:null)}static create(e){return S._instance&&S._instance.close(),S._instance=new S(e),S._instance}get url(){return`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}/_socket?formPath=${encodeURIComponent(this.formPath)}`}resetState(){this.close()}resetHeartbeatCounter(){this.heartbeatCounter=0}on(e,r){this.callbacks[e].push(r)}clearWSEvents(){!this.ws||(clearInterval(this.heartbeatInterval),this.ws.onclose=()=>{},this.ws.onerror=()=>{},this.ws.onmessage=()=>{})}async connect(e,r=1){if(!(r>3))return this.params=e!=null?e:this.params,new Promise(i=>{this.clearWSEvents(),this.ws=new WebSocket(this.url),this.ws.onopen=()=>{i(),this.resetHeartbeatCounter(),this.send({type:"start",params:this.params})};let n=!1;const s=()=>{n||(n=!0)};this.ws.onclose=o=>{if(o.code===1006||!o.wasClean)return s();clearInterval(this.heartbeatInterval),this.onCloseCallbacks.forEach(f=>f())},this.ws.onerror=()=>s(),this.ws.onmessage=o=>{const f=JSON.parse(o.data);se(this.callbacks,f)},this.heartbeatInterval=setInterval(()=>{if(!(!this.ws||this.ws.readyState!==this.ws.OPEN)){if(this.heartbeatCounter++,this.heartbeatCounter>3)return this.ws.onclose=()=>{},clearInterval(this.heartbeatInterval),s();this.send({type:"heartbeat"})}},2e3)}).catch(()=>{this.connect(this.params,r+1)})}onClose(e){this.onCloseCallbacks.push(e)}close(){if(!this.ws){console.warn("no websocket to close");return}this.clearWSEvents(),this.ws.close()}async send(e){if(!this.ws){console.warn("no websocket to send");return}Qe.includes(this.ws.readyState)&&await this.connect(),this.ws.send(JSON.stringify(e)),se(this.callbacks,e)}};let M=S;l(M,"_instance");export{ot as F,M as R};
//# sourceMappingURL=broker.40d04b6b.js.map
