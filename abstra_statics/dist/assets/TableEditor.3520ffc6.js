import{d as P,r as N,G as B,F as te,b as i,eu as D,f as t,w as a,a_ as q,aq as k,eD as R,ew as U,e as h,u as e,cA as ae,bU as x,cH as le,cF as L,eC as H,c as w,bN as j,eH as ee,ad as M,cE as ne,a as G,t as J,H as ce,eA as oe,eE as se,eF as re,eB as pe,eG as me}from"./outputWidgets.84fd06fb.js";import{p as ue,T as fe}from"./tables.4866706f.js";import{B as ve}from"./BaseLayout.f10be94e.js";import{a as Q}from"./asyncComputed.da204aa5.js";import{p as z}from"./popupNotifcation.23c0715f.js";import{A as W,a as F}from"./index.ff0154d3.js";import{A as ie}from"./index.6b6af4b4.js";import{F as X,A}from"./Base.67ffff63.js";import"./router.a59cab44.js";import{P as be}from"./project.ef664249.js";import"./index.0bfee40a.js";import{O as ye}from"./organization.4a0219c9.js";import{H as ge,w as _e,I as he}from"./icons.3869c437.js";import{L as Ce}from"./CircularLoading.af550530.js";import{T as ke,A as V}from"./TabPane.81ef5252.js";import{B as we,a as De,c as $e}from"./index.85c4f2b4.js";import"./record.f0008bb4.js";import"./pubsub.8883f68b.js";import"./gateway.82cdc40d.js";import"./isNumeric.75337b1e.js";import"./transButton.64565967.js";import"./Text.9dbcc31d.js";import"./Title.564982df.js";import"./index.a606b6d8.js";(function(){try{var y=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},v=new Error().stack;v&&(y._sentryDebugIds=y._sentryDebugIds||{},y._sentryDebugIds[v]="217781db-3c1c-4cfe-ba2d-c09c57861583",y._sentryDebugIdIdentifier="sentry-dbid-217781db-3c1c-4cfe-ba2d-c09c57861583")}catch{}})();const Se={class:"table-data",style:{width:"calc(100% - 80px)"}},Ie={key:1},Ue=["onClick"],Te=h("a",null,"Delete",-1),Ae=P({__name:"TableData",props:{table:{}},setup(y){var u;const v=y,s=N(1),o=N(5),S=B(()=>{var p,n;return{total:(n=(p=C.value)==null?void 0:p.total)!=null?n:0,current:s.value,pageSize:o.value,onChange:async(_,K)=>{s.value=_,o.value=K,await m()}}}),{result:C,loading:b,refetch:m}=Q(()=>v.table.select({},(s.value-1)*o.value,o.value)),f=B(()=>{var n;return[...(n=v.table)==null?void 0:n.getColumns().map(_=>({title:_.name,dataIndex:_.name})),{title:"Actions",key:"action",fixed:"right",width:100,align:"center"}]}),r=B(()=>{var p;return((p=C.value)==null?void 0:p.rows.map(n=>({key:n.id,...n})))||[]}),I=N(!1),c=N({}),g=()=>{I.value=!0},T=()=>{c.value={},I.value=!1};let E=te((u=v.table)==null?void 0:u.getUnprotectedColumns().reduce((p,n)=>({...p,[n.name]:""}),{}));async function $(){if(!(!v.table||!E))try{c.value.id?await v.table.updateRow(c.value.id,c.value):await v.table.insertRow(c.value),c.value={},m(),T()}catch(p){p instanceof Error&&z("Database error",p.message)}}const d=async p=>{if(!(!C.value||!C.value.rows.find(n=>n.id===p)))try{await v.table.deleteRow(p),m()}catch(n){n instanceof Error&&z("Database error",n.message)}},l=p=>{var n;c.value=ee.exports.pick(ee.exports.cloneDeep((n=r.value)==null?void 0:n.filter(_=>p===_.key)[0]),v.table.getColumns().map(_=>_.name)),g()};return(p,n)=>(i(),D("div",Se,[t(e(le),{columns:f.value,"data-source":r.value,pagination:S.value,bordered:"",loading:e(b),scroll:{x:2e3,y:720}},{bodyCell:a(({column:_,text:K,record:Z})=>[f.value.map(O=>O.title).includes(_.dataIndex)?(i(),D(q,{key:0},[k(R(K),1)],64)):U("",!0),_.key==="action"?(i(),D("div",Ie,[h("span",null,[h("a",{onClick:O=>l(Z.id)},"Edit",8,Ue)]),t(e(ie),{type:"vertical"}),t(e(ae),{title:"Sure to delete?",onConfirm:O=>d(Z.id)},{default:a(()=>[Te]),_:2},1032,["onConfirm"])])):U("",!0)]),footer:a(()=>[t(e(x),{type:"primary",onClick:g},{default:a(()=>[k("+ Add New Data")]),_:1})]),_:1},8,["columns","data-source","pagination","loading"]),t(e(W),{title:"Data",width:720,open:I.value,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:T},{extra:a(()=>[t(e(L),null,{default:a(()=>[t(e(x),{onClick:T},{default:a(()=>[k("Cancel")]),_:1}),t(e(x),{type:"primary",onClick:$},{default:a(()=>[k("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(X),{model:c.value,layout:"vertical"},{default:a(()=>[(i(!0),D(q,null,H(p.table.getUnprotectedColumns(),_=>(i(),w(e(A),{key:_.id,label:_.name},{default:a(()=>[c.value?(i(),w(e(j),{key:0,value:c.value[_.name],"onUpdate:value":K=>c.value[_.name]=K},null,8,["value","onUpdate:value"])):U("",!0)]),_:2},1032,["label"]))),128))]),_:1},8,["model"])]),_:1},8,["open"])]))}});const xe=P({__name:"NewColumn",props:{open:{type:Boolean},table:{}},emits:["created","cancel"],setup(y,{emit:v}){const s=y,o=N({name:"",type:"varchar",nullable:!0,unique:!1}),S=()=>{o.value={name:"",type:"varchar",nullable:!0,unique:!1}};function C(){v("cancel")}async function b(){if(!s.table||!o.value.name||!o.value.type)return;const{success:m,error:f}=await s.table.addColumn(o.value);m||z("Database error",f),S(),v("created")}return(m,f)=>(i(),w(e(W),{title:"New column",width:720,open:s.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:C},{extra:a(()=>[t(e(L),null,{default:a(()=>[t(e(x),{onClick:C},{default:a(()=>[k("Cancel")]),_:1}),t(e(x),{type:"primary",onClick:b},{default:a(()=>[k("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(X),{model:o.value,layout:"vertical"},{default:a(()=>[t(e(A),{key:"name",label:"Name"},{default:a(()=>[t(e(j),{value:o.value.name,"onUpdate:value":f[0]||(f[0]=r=>o.value.name=r)},null,8,["value"])]),_:1}),t(e(A),{key:"type",label:"Type"},{default:a(()=>[t(e(M),{value:o.value.type,"onUpdate:value":f[1]||(f[1]=r=>o.value.type=r),"default-active-first-option":""},{default:a(()=>[(i(!0),D(q,null,H(e(ue),r=>(i(),w(e(ne),{key:r,value:r},{default:a(()=>[k(R(r),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),t(e(A),{key:"nullable",label:"Nullable"},{default:a(()=>[t(e(F),{checked:o.value.nullable,"onUpdate:checked":f[2]||(f[2]=r=>o.value.nullable=r)},null,8,["checked"])]),_:1}),t(e(A),{key:"unique",label:"Unique"},{default:a(()=>[t(e(F),{checked:o.value.unique,"onUpdate:checked":f[3]||(f[3]=r=>o.value.unique=r)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"]))}}),Ee={class:"types-container"},Ne={class:"fullwidth-input"},Be={class:"fullwidth-input"},qe={class:"using-container"},Re={class:"fullwidth-input"},ze=P({__name:"UpdateColumn",props:{open:{type:Boolean},table:{},column:{}},emits:["updated","cancel"],setup(y,{emit:v}){const s=y,{result:o,loading:S}=Q(async()=>s.table.select({},10,0).then(({total:l})=>l));function C(){v("cancel")}const b=()=>o.value===0||S.value?!1:s.column.record.hasChangesDeep("type"),m=N({type:"default"});function f(l,u){return u==="varchar"||l==="int"&&u==="boolean"||l==="boolean"&&u==="int"}const r=()=>{I.value||(m.value={type:"user-defined",using:$.value,mandatory:!0})},I=B(()=>m.value.type==="default"&&f(s.column.record.initialState.type,s.column.type)),c=B(()=>!f(s.column.record.initialState.type,s.column.type));function g(l){l?m.value={type:"default"}:m.value={type:"user-defined",using:$.value,mandatory:!1}}function T(l){if(m.value.type==="default")throw new Error("Can't change using when using default casting");m.value.using=l!=null?l:""}const E=()=>c.value?!0:b()&&m.value.type==="user-defined",$=B(()=>`${s.column.record.initialState.name}::${s.column.type}`);async function d(){if(!s.column)return;let l=m.value.type==="default"?$.value:m.value.using;o.value===0&&(l=`${s.column.name}::text::${s.column.type}`);try{await s.column.update(l),v("updated")}catch(u){u instanceof Error&&z("Database error",u.message)}}return(l,u)=>{const p=G("icon");return i(),w(e(W),{title:"Edit column",width:720,open:s.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:C},{extra:a(()=>[t(e(L),null,{default:a(()=>[t(e(x),{onClick:C},{default:a(()=>[k("Cancel")]),_:1}),t(e(x),{type:"primary",onClick:d},{default:a(()=>[k("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(X),{model:l.column,layout:"vertical"},{default:a(()=>[t(e(A),{key:"name",label:"Name"},{default:a(()=>[t(e(j),{value:l.column.name,"onUpdate:value":u[0]||(u[0]=n=>l.column.name=n)},null,8,["value"])]),_:1}),h("div",Ee,[h("span",Ne,[t(e(A),{key:"type",label:"Current Type"},{default:a(()=>[t(e(M),{value:l.column.record.initialState.type,"onUpdate:value":u[1]||(u[1]=n=>l.column.record.initialState.type=n),"default-active-first-option":"",disabled:""},null,8,["value"])]),_:1})]),t(p,{class:"right-arrow",path:e(ge)},null,8,["path"]),h("span",Be,[t(e(A),{key:"new-type",label:"New Type"},{default:a(()=>[t(e(M),{value:l.column.type,"onUpdate:value":u[2]||(u[2]=n=>l.column.type=n),"default-active-first-option":"",onChange:u[3]||(u[3]=n=>r())},{default:a(()=>[(i(!0),D(q,null,H(e(ue),n=>(i(),w(e(ne),{key:n,value:n},{default:a(()=>[k(R(n),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})])]),h("div",qe,[b()?(i(),w(e(A),{key:"default-casting",label:"Use default casting"},{default:a(()=>[t(e(F),{checked:I.value,disabled:c.value,"onUpdate:checked":u[4]||(u[4]=n=>g(!!n))},null,8,["checked","disabled"])]),_:1})):U("",!0),h("span",Re,[b()?(i(),w(e(A),{key:"using",label:"Using"},{default:a(()=>[t(e(j),{value:m.value.type==="user-defined"?m.value.using:$.value,disabled:!E(),onInput:u[5]||(u[5]=n=>T(n.target.value))},null,8,["value","disabled"])]),_:1})):U("",!0)])]),t(e(A),{key:"nullable",label:"Nullable"},{default:a(()=>[t(e(F),{checked:l.column.nullable,"onUpdate:checked":u[6]||(u[6]=n=>l.column.nullable=n)},null,8,["checked"])]),_:1}),t(e(A),{key:"unique",label:"Unique"},{default:a(()=>[t(e(F),{checked:l.column.unique,"onUpdate:checked":u[7]||(u[7]=n=>l.column.unique=n)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])}}});const Pe=J(ze,[["__scopeId","data-v-7b958cc3"]]),de=y=>(se("data-v-1d368adf"),y=y(),re(),y),Ke={class:"table-settings"},Fe={key:0},Le=de(()=>h("span",null," protected ",-1)),je=[Le],He={key:1},Oe=["onClick"],Ve=de(()=>h("a",null,"Delete",-1)),Me=P({__name:"TableColumns",props:{table:{},loading:{type:Boolean}},emits:["refresh"],setup(y,{emit:v}){var $;const s=y,o=N(s.loading);ce(()=>s.loading,()=>{o.value=s.loading});const S=oe();($=s.table)==null||$.onUpdate(()=>{var d;S.replace({name:"tableEditor",params:{tableName:(d=s.table)==null?void 0:d.name}})});const b=[...[{title:"Name",dataIndex:"name",sorter:(d,l)=>d.name.localeCompare(l.name)},{title:"Type",dataIndex:"type",sorter:(d,l)=>d.type.localeCompare(l.type)},{title:"Default Value",dataIndex:"default",sorter:(d,l)=>{var u,p,n,_;return(_=(n=d.default)==null?void 0:n.localeCompare((p=(u=l.default)==null?void 0:u.toString())!=null?p:""))!=null?_:0}},{title:"Nullable",dataIndex:"nullable",sorter:(d,l)=>d.nullable.toString().localeCompare(l.nullable.toString())},{title:"Primary Key",dataIndex:"primaryKey",sorter:(d,l)=>d.primaryKey.toString().localeCompare(l.primaryKey.toString())}],{title:"Actions",key:"action"}],m=B(()=>{var d;return(d=s.table)==null?void 0:d.getColumns().map(l=>({name:l.name,type:l.type,default:l.default,nullable:l.nullable,primaryKey:l.primaryKey,id:l.id,unique:l.unique}))});function f(){c.value={type:"idle"}}function r(){f(),o.value=!0,setTimeout(()=>{v("refresh")},500)}function I(){c.value={type:"creating"}}const c=N({type:"idle"});function g(d){var l,u;(u=(l=s.table)==null?void 0:l.getColumn(d))==null||u.delete(),o.value=!0,setTimeout(()=>{v("refresh")},500)}const T=d=>{var l,u,p;return(p=(u=(l=s.table)==null?void 0:l.getColumn(d))==null?void 0:u.protected)!=null?p:!1},E=d=>{if(!s.table)throw new Error("Table not found");c.value={type:"editing",column:s.table.getColumn(d)}};return(d,l)=>(i(),D("div",Ke,[t(e(le),{columns:b,"data-source":m.value,bordered:"",loading:o.value,pagination:!1},{bodyCell:a(({column:u,text:p,record:n})=>[u.key!=="action"?(i(),D(q,{key:0},[k(R(p),1)],64)):(i(),D(q,{key:1},[T(n.id)?(i(),D("div",Fe,je)):(i(),D("div",He,[h("span",null,[h("a",{onClick:()=>E(n.id)},"Edit",8,Oe)]),t(e(ie),{type:"vertical"}),t(e(ae),{title:"Sure to delete?",onConfirm:_=>g(n.id)},{default:a(()=>[Ve]),_:2},1032,["onConfirm"])]))],64))]),footer:a(()=>[t(e(x),{type:"primary",onClick:I},{default:a(()=>[k("+ Add New Column")]),_:1})]),_:1},8,["data-source","loading"]),d.table&&c.value.type==="creating"?(i(),w(xe,{key:0,open:"",table:s.table,onClose:f,onCreated:r},null,8,["table"])):U("",!0),d.table&&c.value.type==="editing"?(i(),w(Pe,{key:1,column:c.value.column,open:"",table:d.table,onUpdated:r,onClose:f,onCancel:f},null,8,["column","table"])):U("",!0)]))}});const Ge=J(Me,[["__scopeId","data-v-1d368adf"]]),Y=y=>(se("data-v-06f57b7a"),y=y(),re(),y),Je={class:"table-settings"},Qe=Y(()=>h("h2",{class:"title"},"Table settings",-1)),We=Y(()=>h("div",{class:"subtitle"},"Edit table metadata",-1)),Xe={key:0,class:"table-presenter"},Ye={class:"table-property-item"},Ze={class:"property-item"},et={key:1},tt={class:"change-warning"},at={class:"section-title"},lt=Y(()=>h("div",{class:"section-body"}," Changing the table's name can possibly result in the break of running applications. ",-1)),nt={class:"table-name-value-input"},ot={key:0,class:"error"},st=P({__name:"TableSettings",props:{table:{}},emits:["refresh"],setup(y,{emit:v}){const s=y,o=te({error:"",editing:!1,loading:!1}),S=()=>o.editing=!0,C=()=>{s.table.resetChanges(),o.editing=!1,o.error=""},b=async()=>{o.error="",o.loading=!0;try{await m()}catch(r){r instanceof Error&&(z("Database error",r.message),o.error=r.message)}o.error||(o.editing=!1),o.loading=!1},m=async()=>{if(!s.table.name){o.error="Table name cannot be empty";return}try{await s.table.save(),v("refresh")}catch(r){r instanceof Error&&(z("Database error",r.message),o.error=r.message)}},f=r=>{s.table.name=r.target.value};return(r,I)=>{var g;const c=G("icon");return i(),D("div",Je,[Qe,We,o.editing?(i(),D("div",et,[h("div",tt,[h("div",at,[t(c,{path:e(_e),width:"12",height:"12",fill:"#D35249"},null,8,["path"]),k(" Be careful ")]),lt]),t(e(L),{direction:"vertical"},{default:a(()=>[h("div",nt,[t(e(j),{value:r.table.name,type:"text",onInput:f,onBlur:I[0]||(I[0]=T=>r.table.fixTraillingName())},null,8,["value"])]),o.error?(i(),D("div",ot,[t(c,{path:e(he),fill:"#D35249",width:"12",height:"12"},null,8,["path"]),k(" "+R(o.error),1)])):U("",!0),t(e(L),null,{default:a(()=>[t(e(x),{onClick:C},{default:a(()=>[k("Cancel")]),_:1}),t(e(x),{type:"primary",disabled:!r.table.hasChangesDeep("name"),onClick:b},{default:a(()=>[k(" Save Changes "),o.loading?(i(),w(Ce,{key:0,size:"16"})):U("",!0)]),_:1},8,["disabled"])]),_:1})]),_:1})])):(i(),D("div",Xe,[h("div",Ye,[h("div",Ze,"Name: "+R((g=r.table)==null?void 0:g.name),1)]),t(e(x),{onClick:S},{default:a(()=>[k("Edit Name")]),_:1})]))])}}});const rt=J(st,[["__scopeId","data-v-06f57b7a"]]),Et=P({__name:"TableEditor",setup(y){const v=oe(),s=pe(),o=s.params.tableId,S=s.params.projectId,C=N("data"),{result:b,loading:m,refetch:f}=Q(()=>Promise.all([be.get(S).then(async c=>{const g=await ye.get(c.organizationId);return{project:c,organization:g}}),fe.get(S,o)]).then(([{project:c,organization:g},T])=>me({project:c,organization:g,table:T}))),r=B(()=>!m.value&&b.value?[{label:"My organizations",path:"/organizations"},{label:b.value.organization.name,path:`/organizations/${b.value.organization.id}`},{label:b.value.project.name,path:`/projects/${b.value.project.id}/tables`}]:void 0);function I(){v.push({name:"tables",params:{projectId:S}})}return(c,g)=>{const T=G("router-link");return i(),w(ve,null,{navbar:a(()=>{var E;return[t(e($e),{title:(E=e(b))==null?void 0:E.table.name,style:{padding:"5px 10px"},onBack:I},{footer:a(()=>[t(e(ke),{"active-key":C.value,"onUpdate:activeKey":g[0]||(g[0]=$=>C.value=$)},{default:a(()=>[t(e(V),{key:"data",tab:"Data"}),t(e(V),{key:"columns",tab:"Columns"}),t(e(V),{key:"settings",tab:"Settings"})]),_:1},8,["active-key"])]),breadcrumb:a(()=>[r.value?(i(),w(e(we),{key:0},{default:a(()=>[(i(!0),D(q,null,H(r.value,($,d)=>(i(),w(e(De),{key:d},{default:a(()=>[t(T,{to:$.path},{default:a(()=>[k(R($.label),1)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1})):U("",!0)]),_:1},8,["title"])]}),content:a(()=>[e(b)&&C.value==="data"?(i(),w(Ae,{key:0,loading:e(m),table:e(b).table},null,8,["loading","table"])):U("",!0),e(b)&&C.value==="columns"?(i(),w(Ge,{key:1,table:e(b).table,loading:e(m),onRefresh:g[1]||(g[1]=E=>e(f)())},null,8,["table","loading"])):U("",!0),e(b)&&C.value==="settings"?(i(),w(rt,{key:2,table:e(b).table,loading:e(m),onRefresh:g[2]||(g[2]=E=>e(f)())},null,8,["table","loading"])):U("",!0)]),_:1})}}});export{Et as default};
//# sourceMappingURL=TableEditor.3520ffc6.js.map
