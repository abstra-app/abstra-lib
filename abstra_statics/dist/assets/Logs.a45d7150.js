var $=Object.defineProperty;var F=(d,e,i)=>e in d?$(d,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):d[e]=i;var p=(d,e,i)=>(F(d,typeof e!="symbol"?e+"":e,i),i);import{r as I,G as w,I as A,eM as N,d as V,eA as q,b as c,c as S,w as n,u as t,f as o,aq as f,ad as R,bf as B,cA as E,eu as m,eB as P,eD as h,e as T,aC as C,ev as G,ci as O,ew as k,bB as K}from"./outputWidgets.4014d4b4.js";import{a as L,A as x}from"./router.1c0eb438.js";import{a as M,b as H}from"./build.3c3d87e9.js";import"./index.8d5a23af.js";import{E as J,_ as Q}from"./ExecutionStatusIcon.vue_vue_type_script_setup_true_lang.1d849c0d.js";import{g as W}from"./datetime.09e8912b.js";import{R as X}from"./dayjs.b929674c.js";import{A as Y}from"./Title.03a6ebb6.js";import{A as _,F as Z}from"./Form.cd3b3101.js";import{A as tt,C as et}from"./CollapsePanel.188b9f16.js";import{A as y}from"./index.4f049bb1.js";import"./popupNotifcation.660ecbf7.js";import"./index.cf4c23b9.js";import"./record.6127802f.js";import"./pubsub.87c1781f.js";import"./LoadingOutlined.087c0a71.js";import"./index.db7340b2.js";import"./Text.fdda7b10.js";import"./hasIn.c8ca3e6f.js";(function(){try{var d=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(d._sentryDebugIds=d._sentryDebugIds||{},d._sentryDebugIds[e]="66372c4c-4504-4757-8e09-95a49ba692fc",d._sentryDebugIdIdentifier="sentry-dbid-66372c4c-4504-4757-8e09-95a49ba692fc")}catch{}})();class v{constructor(e,i,l){p(this,"_executionState",I({openedExecutionIds:[],loadingExecutions:!1,waitingDebounce:!1,executions:[]}));p(this,"_paginationState",w({currentPage:1,pageSize:10,totalCount:0}));p(this,"_filtersState",I({dateRange:void 0,selectedBuildId:void 0,runtimeId:void 0,buildOptions:[],runtimeOptions:[]}));p(this,"_executionsLogsState",w({}));p(this,"projectId");p(this,"handleFilterChange",()=>{this._executionState.value.waitingDebounce=!0,this._paginationState.currentPage=1,this.debouncedPageRefetch()});p(this,"debouncedPageRefetch",N.exports.debounce(async()=>{await this.fetchPage(),this.executionState.value.waitingDebounce=!1},500));p(this,"getLogsStateByExecution",e=>this._executionsLogsState&&this._executionsLogsState[e]);this.query=e,this.executionRepository=i,this.buildRepository=l,this._filtersState.value={...this._filtersState.value,...e},this.projectId=e.projectId}static setup(e,i,l){const u=new v(e,i,l);return u.fetchPage(),u.fetchOptions(),A(u._paginationState,()=>u.fetchPage(),{deep:!0}),A(u._filtersState,u.handleFilterChange,{deep:!0}),u}async fetchPage(){var l,u;this._executionState.value.loadingExecutions=!0;const{executions:e,totalCount:i}=await this.executionRepository.list({projectId:this.projectId,buildId:this.filtersState.selectedBuildId,limit:this._paginationState.pageSize,offset:(this._paginationState.currentPage-1)*this._paginationState.pageSize,stageId:this.filtersState.runtimeId,startDate:(l=this.filtersState.dateRange)==null?void 0:l[0].toISOString(),endDate:(u=this.filtersState.dateRange)==null?void 0:u[1].toISOString()});this._executionState.value.executions=e,this._paginationState.totalCount=i,this._executionState.value.loadingExecutions=!1}async fetchBuildOptions(){const e=await this.buildRepository.list(this.projectId);this._filtersState.value.buildOptions=e.map(i=>({label:`[${i.id.slice(0,8)}] ${i.createdAt.toLocaleString()} ${i.latest?"(Latest)":""}`,value:i.id}))}async fetchRuntimeOptions(){var i;const e=await M.get((i=this.filtersState.selectedBuildId)!=null?i:this.filtersState.buildOptions[0].value);this._filtersState.value.runtimeOptions=e==null?void 0:e.runtimes.map(l=>({label:`[${l.type}] ${l.title} (${l.id.slice(0,8)})`,value:l.id}))}async fetchOptions(){await this.fetchBuildOptions(),await this.fetchRuntimeOptions()}async handleOpenExecution(e){await Promise.all([e.map(async i=>{this._executionsLogsState[i]||(this._executionsLogsState[i]=await this.executionRepository.fetchLogs(this.projectId,i))})])}get filtersState(){return this._filtersState.value}get currentPage(){return this._paginationState.currentPage}set currentPage(e){this._paginationState.currentPage=e}get pageSize(){return this._paginationState.pageSize}set pageSize(e){this._paginationState.pageSize=e}get totalCount(){return this._paginationState.totalCount}get executionState(){return this._executionState}}const at={style:{width:"100px",height:"100%",display:"flex","align-items":"center","justify-content":"right",gap:"10px"}},it={key:0,style:{display:"flex",width:"100%","justify-content":"center"}},st={key:1,style:{"background-color":"#555","border-radius":"5px",padding:"10px",color:"#fff","font-family":"monospace","max-height":"600px",overflow:"auto"}},Rt=V({__name:"Logs",setup(d){const e=new J,i=new H,l=q(),u=l.params.projectId,z=l.query.runtimeId,D=l.query.executionId,j={runtimeId:z,projectId:u,executionId:D},s=v.setup(j,e,i);return(ot,r)=>(c(),S(t(E),{direction:"vertical"},{default:n(()=>[o(t(Y),null,{default:n(()=>[f("Logs")]),_:1}),o(t(Z),{layout:"vertical"},{default:n(()=>[o(t(L),{gutter:10},{default:n(()=>[o(t(x),{span:24},{default:n(()=>[o(t(_),{label:"Script"},{default:n(()=>[o(t(R),{value:t(s).filtersState.runtimeId,"onUpdate:value":r[0]||(r[0]=a=>t(s).filtersState.runtimeId=a),options:t(s).filtersState.runtimeOptions,placeholder:"All","allow-clear":""},null,8,["value","options"])]),_:1})]),_:1})]),_:1}),o(t(L),{gutter:10},{default:n(()=>[o(t(x),{span:12},{default:n(()=>[o(t(_),{label:"Date"},{default:n(()=>[o(t(X),{value:t(s).filtersState.dateRange,"onUpdate:value":r[1]||(r[1]=a=>t(s).filtersState.dateRange=a),style:{width:"100%"}},null,8,["value"])]),_:1})]),_:1}),o(t(x),{span:12},{default:n(()=>[o(t(_),{label:"Build"},{default:n(()=>[o(t(R),{value:t(s).filtersState.selectedBuildId,"onUpdate:value":r[2]||(r[2]=a=>t(s).filtersState.selectedBuildId=a),options:t(s).filtersState.buildOptions,"option-label":"label","option-value":"value",filter:!1,placeholder:"All","allow-clear":""},null,8,["value","options"])]),_:1})]),_:1})]),_:1})]),_:1}),t(s).executionState.value.loadingExecutions||t(s).executionState.value.waitingDebounce?(c(),S(t(B),{key:0,style:{width:"100%"}})):t(s).executionState.value.executions&&t(s).executionState.value.executions.length>0?(c(),S(t(E),{key:1,direction:"vertical",style:{width:"100%"}},{default:n(()=>[o(t(et),{"active-key":t(s).executionState.value.openedExecutionIds,"onUpdate:activeKey":r[3]||(r[3]=a=>t(s).executionState.value.openedExecutionIds=a),bordered:!1,style:{"background-color":"transparent"},onChange:r[4]||(r[4]=a=>t(s).handleOpenExecution(a))},{default:n(()=>[(c(!0),m(C,null,P(t(s).executionState.value.executions,a=>(c(),S(t(tt),{key:a.id,style:{"border-radius":"4px","margin-bottom":"10px",border:"0",overflow:"hidden","background-color":"#fff"}},{header:n(()=>[o(t(y),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:n(()=>[f(h(t(W)(a.createdAt)),1)]),_:2},1024),o(t(y),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:n(()=>[f(" Run ID: "+h(a.id.slice(0,8)),1)]),_:2},1024),o(t(y),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:n(()=>[f(" Build: "+h(a.buildId.slice(0,8)),1)]),_:2},1024),o(t(y),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:n(()=>{var g,b;return[f(h((b=(g=t(s).filtersState.runtimeOptions.find(U=>U.value===a.stageId))==null?void 0:g.label)!=null?b:a.stageId.slice(0,8)),1)]}),_:2},1024)]),extra:n(()=>[T("div",at,[f(h(a.status.charAt(0).toUpperCase()+a.status.slice(1))+" ",1),o(Q,{status:a.status},null,8,["status"])])]),default:n(()=>[t(s).getLogsStateByExecution(a.id)?t(s).getLogsStateByExecution(a.id).entries.length?(c(),m("div",st,[(c(!0),m(C,null,P(t(s).getLogsStateByExecution(a.id).entries,g=>(c(),m("p",{key:g.createdAt,style:G({margin:0,"white-space":"pre-wrap",color:g.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},h(g.payload.text.trim()),5))),128))])):t(s).getLogsStateByExecution(a.id).entries.length?k("",!0):(c(),S(t(O),{key:2})):(c(),m("div",it,[o(t(B))]))]),_:2},1024))),128))]),_:1},8,["active-key"]),o(t(K),{current:t(s).currentPage,"onUpdate:current":r[5]||(r[5]=a=>t(s).currentPage=a),"page-size":t(s).pageSize,"onUpdate:pageSize":r[6]||(r[6]=a=>t(s).pageSize=a),total:t(s).totalCount,"show-size-changer":""},null,8,["current","page-size","total"])]),_:1})):k("",!0),o(t(O))]),_:1}))}});export{Rt as default};
//# sourceMappingURL=Logs.a45d7150.js.map
