var u=Object.defineProperty;var p=(i,e,t)=>e in i?u(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var a=(i,e,t)=>(p(i,typeof e!="symbol"?e+"":e,t),t);import{C as o}from"./gateway.bca3ba41.js";import{l as v}from"./fetch.ab879caf.js";import{E as d}from"./record.40f9594e.js";import{E as g,f as y,es as f}from"./index.1da01ec4.js";import{G as w}from"./PhPencil.vue.0a6831d6.js";(function(){try{var i=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(i._sentryDebugIds=i._sentryDebugIds||{},i._sentryDebugIds[e]="3111ebc4-658b-453e-b2e2-ef4ae4a9df73",i._sentryDebugIdIdentifier="sentry-dbid-3111ebc4-658b-453e-b2e2-ef4ae4a9df73")}catch{}})();class r{constructor(e){a(this,"data");a(this,"deleted");a(this,"wasDeleted",e=>this.deleted.value.includes(e));a(this,"wasUpdated",e=>this.data.hasChangesDeep(e));a(this,"set",(e,t)=>{this.data.set(e,t),this.deleted.value=this.deleted.value.filter(s=>s!==e)});a(this,"get",e=>{if(!this.deleted.value.includes(e))return this.data.get(e)});a(this,"delete",e=>{this.deleted.value=[...this.deleted.value,e]});a(this,"values",()=>{const e={},t=Object.keys(this.data.changes).concat(Object.keys(this.data.initialState));for(const s of t)this.deleted.value.includes(s)||(e[s]=this.data.get(s));return e});a(this,"commit",()=>{this.data=d.from(this.values()),this.deleted.value=[]});this.data=d.from(e),this.deleted=g([])}static from(e){const t=e.reduce((s,{name:n,value:l})=>(s[n]=l,s),{});return new r(t)}get changes(){const e=this.deleted.value.map(t=>({name:t,change:"delete"}));for(const t of Object.keys(this.data.changes))if(!this.deleted.value.includes(t)){if(this.data.initialState[t]===void 0){e.push({name:t,value:this.data.get(t),change:"create"});continue}this.data.hasChangesDeep(t)&&e.push({name:t,value:this.data.get(t),change:"update"})}return e}}class b{constructor(){a(this,"urlPath","env-vars")}async list(e){return await o.get(`projects/${e}/${this.urlPath}`)}async update(e,t){await o.patch(`projects/${e}/${this.urlPath}`,t)}}const c=new b;class D{constructor(e){this.projectId=e}async get(){const e=await c.list(this.projectId);return r.from(e.map(t=>({...t,value:""})))}async update(e){await c.update(this.projectId,e)}}class U{constructor(e=v){this.fetch=e}async get(){const e=await this.fetch("/_editor/api/env-vars");if(!e.ok)throw new Error("Failed to list env vars");const t=await e.json();return r.from(t)}async update(e){await this.fetch("/_editor/api/env-vars",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}}class h{constructor(e,t,s,n){a(this,"envVarRepo");a(this,"envVars");a(this,"state",y({type:"idle"}));a(this,"mode");a(this,"fileOpener");a(this,"openEnvFile",async()=>{var e;await((e=this.fileOpener)==null?void 0:e.openFile(".env"))});a(this,"validate",e=>{const t=/^[A-Za-z_][A-Za-z0-9_]*$/,{key:s,value:n}=e;if(n.trim()!==n)throw new Error("Environment variable values cannot have leading or trailing whitespace.");if(!t.test(s))throw new Error(`Invalid key: \u2018${s}\u2019. A key must begin with a letter or an underscore, and may only include letters, numbers, and underscores.`)});a(this,"create",e=>{this.validate(e),this.envVars.set(e.key,e.value),this.state.value={type:"idle"}});a(this,"delete",e=>{this.envVars.delete(e),this.state.value={type:"idle"}});a(this,"startUpdating",e=>{this.state.value={type:"updating",name:e,value:this.envVars.get(e)||""}});a(this,"confirmUpdate",()=>{this.state.value.type==="updating"&&(this.envVars.set(this.state.value.name,this.state.value.value),this.state.value={type:"idle"})});a(this,"cancelUpdate",()=>{this.state.value={type:"idle"}});a(this,"pollingFunction",async()=>{if(!this.isLocalEditor)return;const e=await this.envVarRepo.get();Object.entries(e.values()).forEach(([t,s])=>{this.envVars.wasDeleted(t)||this.envVars.get(t)===void 0&&this.envVars.set(t,s)})});a(this,"columns",()=>[{title:"Key"},{title:"Value"},{title:""}]);a(this,"rows",()=>Object.entries(this.envVars.values()).map(([e,t])=>({key:e,cells:[{type:"text",text:e,contentType:this.wasUpdated(e)?"warning":"default"},{type:"text",text:this.isLocalEditor?t:"*********",contentType:this.wasUpdated(e)?"warning":"default"},{type:"actions",actions:[{icon:f,label:"Delete",onClick:()=>this.delete(e),dangerous:!0},{icon:w,label:"Update",onClick:()=>this.startUpdating(e)}]}]})));a(this,"save",async()=>{await this.envVarRepo.update(this.envVars.changes),this.envVars.commit()});a(this,"hasChanges",()=>this.envVars.changes.length>0);a(this,"table",()=>({columns:this.columns(),rows:this.rows()}));this.envVarRepo=e,this.envVars=t,this.mode=s,this.fileOpener=n}static async create(e,t,s){const n=await e.get();return new h(e,n,t,s)}get isLocalEditor(){return this.mode==="editor"}get saveMessage(){return this.isLocalEditor?"Save":"Save and Apply"}get creationFields(){return[{label:"Variable name",key:"key"},{label:"Variable value",key:"value",type:"multiline-text"}]}get isUpdating(){return this.state.value.type==="updating"}wasUpdated(e){return this.envVars.wasUpdated(e)}}export{D as C,U as E,h as a};
//# sourceMappingURL=controller.f79eb28b.js.map
