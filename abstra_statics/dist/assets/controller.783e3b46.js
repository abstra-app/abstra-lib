var F=Object.defineProperty;var C=(d,t,e)=>t in d?F(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var o=(d,t,e)=>(C(d,typeof t!="symbol"?t+"":t,e),e);import{B as i,cF as S,E as I,ej as c,g as b}from"./index.6d326114.js";import"./linters.993e3ea4.js";import{W as T}from"./workspaces.7e1beae4.js";import{M as $,d as E}from"./index.ee7c7b0a.js";import{u}from"./uuid.557af65e.js";import{v as D,n as V,a as A,b as W}from"./validations.48fc00e4.js";import{w as R}from"./metadata.6ff498e4.js";(function(){try{var d=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(d._sentryDebugIds=d._sentryDebugIds||{},d._sentryDebugIds[t]="1ba5f394-5629-43ea-94d2-9c4c02c36fdb",d._sentryDebugIdIdentifier="sentry-dbid-1ba5f394-5629-43ea-94d2-9c4c02c36fdb")}catch{}})();const _=i.object({type:i.enum(["forms","hooks"]),id:i.string(),title:i.string(),position:i.object({x:i.number(),y:i.number()}),props:i.object({path:i.string().nullable(),filename:i.string().nullable()})}),z=i.object({type:i.literal("scripts"),id:i.string(),title:i.string(),position:i.object({x:i.number(),y:i.number()}),props:i.object({filename:i.string().nullable()})}),L=i.object({type:i.literal("jobs"),id:i.string(),title:i.string(),position:i.object({x:i.number(),y:i.number()}),props:i.object({filename:i.string().nullable()})}),M=i.object({type:i.literal("agents"),id:i.string(),title:i.string(),position:i.object({x:i.number(),y:i.number()}),props:i.object({projectId:i.string().nullable(),clientStageId:i.string().nullable()})}),U=i.object({type:i.literal("clients"),id:i.string(),title:i.string(),position:i.object({x:i.number(),y:i.number()}),props:i.object({})}),q=i.union([z,_,M,U,L]),O=i.object({id:i.string(),type:i.literal("task"),sourceStageId:i.string(),targetStageId:i.string(),props:i.object({taskType:i.string().nullable()})}),x=i.object({stages:i.array(q),transitions:i.array(O)}),Y={"Content-Type":"application/json"};class G{async load(){const t=await fetch("/_editor/api/workflows");if(t.ok){const e=await t.json(),s=x.safeParse(e);if(s.success)return s.data;throw console.error(s.error.errors),new Error("Failed to parse initial data")}else throw new Error("Failed to fetch initial data")}async update(t){const e=await fetch("/_editor/api/workflows",{method:"PUT",headers:Y,body:JSON.stringify(t)});if(e.ok){const s=await e.json(),r=x.safeParse(s);if(r.success)return r.data;throw new Error("Failed to parse updated data:",s)}else throw new Error("Failed to update workflow")}}const ot=new G;function H(){return Math.random().toString(36).slice(2,9)}class g{constructor(t){this.changes=t}apply(t){return this.changes.reduce((e,s)=>s.apply(e),t)}reverse(){return new g(this.changes.map(t=>t.reverse()).reverse())}}class k{constructor(t){o(this,"removed");this.stageId=t,this.removed=null}apply(t){const e=t.stages.find(r=>r.id===this.stageId)||null;if(!e)throw new Error(`Stage ${this.stageId} not found`);const s=t.transitions.filter(r=>r.sourceStageId===this.stageId||r.targetStageId===this.stageId);return this.removed={stage:e,transitions:s},{stages:t.stages.filter(r=>r.id!==e.id),transitions:t.transitions.filter(r=>!s.find(n=>n.id===r.id))}}reverse(){if(!this.removed)throw new Error("Cannot reverse change that was not applied");const t=new P(this.removed.stage.type,this.removed.stage.title,this.removed.stage.position,this.removed.stage.id,this.removed.stage.props),e=this.removed.transitions.map(s=>new f(s.sourceStageId,s.targetStageId,s.type,s.id));return new g([t,...e])}}class P{constructor(t,e,s,r,n){o(this,"addedStage");this.stageType=t,this.nodeTitle=e,this.position=s,this.id=r,this.props=n,this.addedStage=null}assertStageDoesNotExist(t){if(t.stages.find(e=>e.id===this.id))throw new Error(`Stage ${this.id} already exists`)}assertValidStageType(){if(!R.stages.find(t=>t.typeName===this.stageType))throw new Error(`Invalid stage type ${this.stageType}`)}assertTransitionDoesNotExist(t){if(t.transitions.find(e=>e.sourceStageId===this.id||e.targetStageId===this.id))throw new Error("Stage already has transitions")}makePath(t){switch(this.stageType){case"forms":return`new-form-${t}`;case"hooks":return`new-hook-${t}`;default:return null}}makeFilename(t){switch(this.stageType){case"forms":return`form_${t}.py`;case"hooks":return`hook_${t}.py`;case"jobs":return`job_${t}.py`;case"scripts":return`tasklet_${t}.py`;default:return null}}apply(t){var s,r,n,a;const e=H();switch(this.assertStageDoesNotExist(t),this.assertValidStageType(),this.assertTransitionDoesNotExist(t),this.stageType){case"forms":case"hooks":{const h={path:this.makePath(e),filename:this.makeFilename(e),...this.props};this.addedStage={id:(s=this.id)!=null?s:u(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:h};break}case"jobs":case"scripts":{const h={filename:this.makeFilename(e),...this.props};this.addedStage={id:(r=this.id)!=null?r:u(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:h};break}case"agents":{this.addedStage={id:(n=this.id)!=null?n:u(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:{projectId:null,clientStageId:null}};break}case"clients":{this.addedStage={id:(a=this.id)!=null?a:u(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:{}};break}default:throw new Error(`Invalid stage type ${this.stageType}`)}if(!this.addedStage)throw new Error("Stage not created");return{transitions:t.transitions,stages:[...t.stages,this.addedStage]}}reverse(){if(!this.addedStage)throw new Error("Cannot reverse change that was not applied");return new k(this.addedStage.id)}}class B extends g{constructor(t){super(t.map(e=>new P(e.type,e.title,e.position,e.id)))}}class N{constructor(t){o(this,"removedTransition");this.transitionId=t,this.removedTransition=null}apply(t){const e=t.transitions.find(s=>s.id===this.transitionId);if(!e)throw new Error(`Transition ${this.transitionId} not found`);return this.removedTransition=e!=null?e:null,{stages:t.stages,transitions:t.transitions.filter(s=>s.id!==this.transitionId)}}reverse(){if(!this.removedTransition)throw new Error("Cannot reverse change that was not applied");return new f(this.removedTransition.sourceStageId,this.removedTransition.targetStageId,this.removedTransition.type,this.removedTransition.id)}}class f{constructor(t,e,s,r){o(this,"addedTransition");this.sourceStageId=t,this.targetStageId=e,this.transitionType=s,this.transitionId=r,this.addedTransition=null}assertSourceStageExists(t){if(!t.stages.find(e=>e.id===this.sourceStageId))throw new Error(`Stage ${this.sourceStageId} not found`)}assertTargetStageExists(t){if(!t.stages.find(e=>e.id===this.targetStageId))throw new Error(`Stage ${this.targetStageId} not found`)}assertTransitionDoesNotExist(t){if(t.transitions.find(e=>e.id===this.transitionId))throw new Error(`Transition ${this.transitionId} already exists`)}assertNotSelfTransition(){if(this.sourceStageId===this.targetStageId)throw new Error("Self transitions are not allowed")}assertNoDuplicatedTransitionStages(t){if(t.transitions.find(e=>e.sourceStageId===this.sourceStageId&&e.targetStageId===this.targetStageId))throw S.error({message:"Invalid transition",description:"Transition already exists"}),new Error("Transition already exists")}assertNoStageWithSameId(t){if(t.stages.find(e=>e.id===this.transitionId))throw new Error(`Stage with id ${this.transitionId} already exists`)}apply(t){return this.assertSourceStageExists(t),this.assertTargetStageExists(t),this.assertTransitionDoesNotExist(t),this.assertNotSelfTransition(),this.assertNoDuplicatedTransitionStages(t),this.assertNoStageWithSameId(t),this.addedTransition={id:this.transitionId,sourceStageId:this.sourceStageId,targetStageId:this.targetStageId,type:this.transitionType,props:{taskType:null}},{stages:t.stages,transitions:[...t.transitions,this.addedTransition]}}reverse(){if(!this.addedTransition)throw new Error("Cannot reverse change that was not applied");return new N(this.addedTransition.id)}}class J extends g{constructor(t){super(t.map(e=>new f(e.sourceStageId,e.targetStageId,e.type,e.id)))}}class w{constructor(t){o(this,"oldPositions");this.newPositions=t,this.oldPositions=null}assertStagesExists(t){this.newPositions.forEach(({id:e})=>{if(!t.stages.find(s=>s.id===e))throw new Error(`Stage ${e} not found`)})}assertIsNumber(){this.newPositions.forEach(({position:t})=>{if(Number.isNaN(t.x)||Number.isNaN(t.y)||!Number.isFinite(t.x)||!Number.isFinite(t.y))throw new Error("Position must be a number")})}apply(t){return this.assertIsNumber(),this.assertStagesExists(t),this.oldPositions=t.stages.map(s=>({id:s.id,position:s.position})),{stages:t.stages.map(s=>{var n,a;const r=(a=(n=this.newPositions.find(h=>h.id===s.id))==null?void 0:n.position)!=null?a:s.position;return{...s,position:{x:r.x,y:r.y}}}),transitions:t.transitions}}reverse(){if(!this.oldPositions)throw new Error("Cannot reverse change that was not applied");return new w(this.oldPositions)}}class m{constructor(t,e){o(this,"stageId");o(this,"newTitle");o(this,"oldTitle");this.stageId=t,this.newTitle=e,this.oldTitle=""}assertStageExists(t){if(!t.stages.find(e=>e.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}apply(t){return this.assertStageExists(t),this.oldTitle=t.stages.find(e=>e.id===this.stageId).title,{stages:t.stages.map(e=>e.id===this.stageId?{...e,title:this.newTitle}:e),transitions:t.transitions}}reverse(){return new m(this.stageId,this.oldTitle)}}class y{constructor(t,e){o(this,"stageId");o(this,"newProps");o(this,"oldProps");this.stageId=t,this.newProps=e}assertStageExists(t){if(!t.stages.find(e=>e.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}assertValidPath(){if(!("path"in this.newProps)||!this.newProps.path)return;const t=D(this.newProps.path);if(!t.valid){S.error({message:"Invalid path",description:t.reason});return}this.newProps.path=V(this.newProps.path)}assertValidFilename(){if(!("filename"in this.newProps)||!this.newProps.filename)return;const t=A(this.newProps.filename);if(!t.valid){S.error({message:"Invalid filename",description:t.reason});return}this.newProps.filename=W(this.newProps.filename)}apply(t){return this.assertStageExists(t),this.assertValidPath(),this.assertValidFilename(),this.oldProps=t.stages.find(e=>e.id===this.stageId).props,{stages:t.stages.map(e=>e.id===this.stageId?{...e,props:this.newProps}:e),transitions:t.transitions}}reverse(){return new y(this.stageId,this.oldProps)}}class v{constructor(t,e){o(this,"newProps");o(this,"transitionId");o(this,"oldProps");this.newProps=e,this.transitionId=t,this.oldProps=e}apply(t){return{transitions:t.transitions.map(e=>e.id===this.transitionId?(this.oldProps=e.props,{...e,props:this.newProps}):e),stages:t.stages}}reverse(){return new v(this.transitionId,this.oldProps)}}class X extends g{constructor(t,e){super([...e.map(s=>new N(s)),...t.map(s=>new k(s))])}}class K{constructor(t){o(this,"currentState");o(this,"serverState");o(this,"undoStack");o(this,"redoStack");this.undoStack=[],this.redoStack=[],this.currentState=I(Object.freeze(t)),this.serverState=I(Object.freeze(t))}apply(t){return this.currentState.value=t.apply(this.currentState.value),this.undoStack.push(t),this.redoStack=[],this.currentState.value}canUndo(){return this.undoStack.length>0}undo(){const t=this.undoStack.pop();if(t){const e=t.reverse();this.currentState.value=e.apply(this.currentState.value),this.redoStack.push(t)}return this.currentState.value}canRedo(){return this.redoStack.length>0}redo(){const t=this.redoStack.pop();return t&&(this.currentState.value=t.apply(this.currentState.value),this.undoStack.push(t)),this.currentState.value}getState(){return this.currentState.value}setServerState(t){this.serverState.value=t}getServerState(){return this.serverState.value}hasStageChanges(){return!c.exports.isEqual(this.currentState.value.stages,this.serverState.value.stages)}hasChanges(){const t={...this.currentState.value,stages:[...this.currentState.value.stages].sort((s,r)=>s.id.localeCompare(r.id)),transitions:[...this.currentState.value.transitions].sort((s,r)=>s.id.localeCompare(r.id))},e={...this.serverState.value,stages:[...this.serverState.value.stages].sort((s,r)=>s.id.localeCompare(r.id)),transitions:[...this.serverState.value.transitions].sort((s,r)=>s.id.localeCompare(r.id))};return!c.exports.isEqual(t,e)}stageHasChanges(t){const e=this.currentState.value.stages.find(r=>r.id===t),s=this.serverState.value.stages.find(r=>r.id===t);return!c.exports.isEqual(e,s)}stageHasNonPositionChanges(t){const e=this.currentState.value.stages.find(r=>r.id===t),s=this.serverState.value.stages.find(r=>r.id===t);return!c.exports.isEqual(c.exports.omit(e,"position"),c.exports.omit(s,"position"))}}const Q=2;class j{constructor(t,e,s){o(this,"api");o(this,"editable");o(this,"history");o(this,"vueFlowNodes");o(this,"vueFlowEdges");this.editable=s,this.api=t,this.history=new K(e),this.vueFlowNodes=b(()=>this.computeVueFlowNodes()),this.vueFlowEdges=b(()=>this.computeVueFlowEdges())}static async init(t,e){const s=await t.load();return new j(t,s,e)}async refetch(){const t=await this.api.load();this.history.setServerState(t),this.history.currentState.value=t}inflateYFactor(){return this.editable?1:Q}computeVueFlowNodes(){return this.history.getState().stages.map(e=>({id:e.id,type:e.type,data:e,position:{x:e.position.x,y:e.position.y*this.inflateYFactor()}}))}computeVueFlowEdges(){return this.history.getState().transitions.map(e=>({id:e.id,source:e.sourceStageId,target:e.targetStageId,type:"task",label:"task",markerEnd:{type:$.Arrow,width:24,height:24},data:e}))}getStage(t){var e;return(e=this.history.getState().stages.find(s=>s.id===t))!=null?e:null}getUnsavedFilenameStages(){const t=this.history.getState(),e=this.history.getServerState(),s=t.stages.map(a=>a.id),r=e.stages.map(a=>a.id),n=s.filter(a=>{if(!r.includes(a))return!0;const h=t.stages.find(p=>p.id===a),l=e.stages.find(p=>p.id===a);if(!h||!l)return!1;if("filename"in h.props&&"filename"in l.props)return h.props.filename!==l.props.filename});return t.stages.filter(a=>n.includes(a.id))}getUnsavedNewStages(){const t=this.history.getState(),e=this.history.getServerState(),s=t.stages.map(a=>a.id),r=e.stages.map(a=>a.id),n=s.filter(a=>!r.includes(a));return t.stages.filter(a=>n.includes(a.id))}updateStageTitle(t,e){this.history.apply(new m(t,e))}updateStageProps(t,e){this.history.apply(new y(t,e))}addStages(t){const e=t[0].type.slice(0,-1),s=e==="script"?"tasklet":e;return this.history.apply(new B(t.map(r=>{var n;return{...r,title:(n=r.title)!=null?n:`New ${s}`}}))),this.history.getState().stages.slice(-t.length)}connect(t){this.history.apply(new J(t))}move(t){this.history.apply(new w(t))}delete(t){const e=this.history.getState(),s=e.stages.filter(n=>t.includes(n.id)).map(n=>n.id),r=e.transitions.filter(n=>t.includes(n.id)).map(n=>n.id);this.history.apply(new X(s,r))}updateTransitionProps(t,e){this.history.apply(new v(t,e))}hasChanges(){return this.history.hasChanges()}edgeIsLonely(t){const e=this.history.getState(),s=e.transitions.find(a=>a.id===t);if(!s)return!0;const{sourceStageId:r,targetStageId:n}=s;for(const a of e.transitions)if(a.id!==t&&(a.sourceStageId===r&&a.targetStageId===n||a.sourceStageId===n&&a.targetStageId===r))return!1;return!0}async save(){const t=this.getUnsavedNewStages();if(this.history.hasChanges()){const e=await this.api.update(this.history.getState());this.history.setServerState(e)}t.forEach(async e=>{"filename"in e.props&&e.props.filename&&((await T.checkFile(e.props.filename)).exists||T.initFile(e.props.filename,e.type))})}autoLayout(t={}){if(!this.editable)return;const e=this.history.getState();if(e.stages.length===0)return;const{direction:s="LR",distanceX:r=200,distanceY:n=80}=t,a=new E.graphlib.Graph;a.setDefaultEdgeLabel(()=>({})),a.setGraph({rankdir:s,nodesep:r,ranksep:n});for(const l of e.stages)a.setNode(l.id,{width:250,height:50});for(const l of e.transitions)a.setEdge(l.sourceStageId,l.targetStageId);E.layout(a);const h=e.stages.map(l=>{const p=a.node(l.id);return{id:l.id,position:{x:p.x,y:p.y}}});this.move(h)}}export{G as E,j as W,H as g,ot as w};
//# sourceMappingURL=controller.783e3b46.js.map
