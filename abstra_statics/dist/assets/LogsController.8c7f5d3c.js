var B=Object.defineProperty;var L=(c,t,e)=>t in c?B(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var h=(c,t,e)=>(L(c,typeof t!="symbol"?t+"":t,e),e);import{d as E,at as Z,c as k,o as n,ac as u,ae as F,h as b,ed as $,e as m,a as A,b as p,aY as T,ej as M,ad as z,t as v,u as s,df as C,g as H,dj as D,_ as R,r as N,f,i as g,b0 as I,eh as q,d6 as W,cM as V,al as J,w as P,en as G}from"./jwt-decode.esm.b8674d26.js";import{t as Y}from"./ant-design.0e999224.js";import{c as j}from"./string.092aa8dc.js";import{I as S}from"./PhCopy.vue.f4d5cc07.js";import{A as Q}from"./index.ac64dbf6.js";import{A as U,C as X}from"./router.6210e65d.js";import{B as K}from"./build.6fd4292c.js";import"./tables.f13d2e4b.js";import{e as tt}from"./repository.0125c194.js";import{u as et}from"./polling.119f2f24.js";(function(){try{var c=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(c._sentryDebugIds=c._sentryDebugIds||{},c._sentryDebugIds[t]="025ca332-6d8b-435d-892e-85590829baff",c._sentryDebugIdIdentifier="sentry-dbid-025ca332-6d8b-435d-892e-85590829baff")}catch{}})();const at=["width","height","fill","transform"],it={key:0},st=m("path",{d:"M72,104a16,16,0,1,1,16,16A16,16,0,0,1,72,104Zm96,16a16,16,0,1,0-16-16A16,16,0,0,0,168,120Zm68-40V192a36,36,0,0,1-36,36H56a36,36,0,0,1-36-36V80A36,36,0,0,1,56,44h60V16a12,12,0,0,1,24,0V44h60A36,36,0,0,1,236,80Zm-24,0a12,12,0,0,0-12-12H56A12,12,0,0,0,44,80V192a12,12,0,0,0,12,12H200a12,12,0,0,0,12-12Zm-12,82a30,30,0,0,1-30,30H86a30,30,0,0,1,0-60h84A30,30,0,0,1,200,162Zm-80-6v12h16V156ZM86,168H96V156H86a6,6,0,0,0,0,12Zm90-6a6,6,0,0,0-6-6H160v12h10A6,6,0,0,0,176,162Z"},null,-1),ot=[st],nt={key:1},rt=m("path",{d:"M200,56H56A24,24,0,0,0,32,80V192a24,24,0,0,0,24,24H200a24,24,0,0,0,24-24V80A24,24,0,0,0,200,56ZM164,184H92a20,20,0,0,1,0-40h72a20,20,0,0,1,0,40Z",opacity:"0.2"},null,-1),lt=m("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Zm4,28H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24Z"},null,-1),ct=[rt,lt],dt={key:2},ut=m("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48ZM172,96a12,12,0,1,1-12,12A12,12,0,0,1,172,96ZM96,184H80a16,16,0,0,1,0-32H96ZM84,120a12,12,0,1,1,12-12A12,12,0,0,1,84,120Zm60,64H112V152h32Zm32,0H160V152h16a16,16,0,0,1,0,32Z"},null,-1),pt=[ut],ht={key:3},gt=m("path",{d:"M200,50H134V16a6,6,0,0,0-12,0V50H56A30,30,0,0,0,26,80V192a30,30,0,0,0,30,30H200a30,30,0,0,0,30-30V80A30,30,0,0,0,200,50Zm18,142a18,18,0,0,1-18,18H56a18,18,0,0,1-18-18V80A18,18,0,0,1,56,62H200a18,18,0,0,1,18,18ZM74,108a10,10,0,1,1,10,10A10,10,0,0,1,74,108Zm88,0a10,10,0,1,1,10,10A10,10,0,0,1,162,108Zm2,30H92a26,26,0,0,0,0,52h72a26,26,0,0,0,0-52Zm-22,12v28H114V150ZM78,164a14,14,0,0,1,14-14h10v28H92A14,14,0,0,1,78,164Zm86,14H154V150h10a14,14,0,0,1,0,28Z"},null,-1),ft=[gt],mt={key:4},yt=m("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16Zm-52-56H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Z"},null,-1),_t=[yt],xt={key:5},bt=m("path",{d:"M200,52H132V16a4,4,0,0,0-8,0V52H56A28,28,0,0,0,28,80V192a28,28,0,0,0,28,28H200a28,28,0,0,0,28-28V80A28,28,0,0,0,200,52Zm20,140a20,20,0,0,1-20,20H56a20,20,0,0,1-20-20V80A20,20,0,0,1,56,60H200a20,20,0,0,1,20,20ZM76,108a8,8,0,1,1,8,8A8,8,0,0,1,76,108Zm88,0a8,8,0,1,1,8,8A8,8,0,0,1,164,108Zm0,32H92a24,24,0,0,0,0,48h72a24,24,0,0,0,0-48Zm-20,8v32H112V148ZM76,164a16,16,0,0,1,16-16h12v32H92A16,16,0,0,1,76,164Zm88,16H152V148h12a16,16,0,0,1,0,32Z"},null,-1),At=[bt],vt={name:"PhRobot"},Ht=E({...vt,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(c){const t=c,e=Z("weight","regular"),i=Z("size","1em"),o=Z("color","currentColor"),r=Z("mirrored",!1),d=k(()=>{var l;return(l=t.weight)!=null?l:e}),y=k(()=>{var l;return(l=t.size)!=null?l:i}),_=k(()=>{var l;return(l=t.color)!=null?l:o}),a=k(()=>t.mirrored!==void 0?t.mirrored?"scale(-1, 1)":void 0:r?"scale(-1, 1)":void 0);return(l,x)=>(n(),u("svg",$({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:y.value,height:y.value,fill:_.value,transform:a.value},l.$attrs),[F(l.$slots,"default"),d.value==="bold"?(n(),u("g",it,ot)):d.value==="duotone"?(n(),u("g",nt,ct)):d.value==="fill"?(n(),u("g",dt,pt)):d.value==="light"?(n(),u("g",ht,ft)):d.value==="regular"?(n(),u("g",mt,_t)):d.value==="thin"?(n(),u("g",xt,At)):b("",!0)],16,at))}}),wt={key:0,class:"cli"},Zt={key:0},kt=E({__name:"LogContainer",props:{logs:{}},setup(c){return(t,e)=>(n(),A(s(D),{vertical:"",gap:"small"},{default:p(()=>[t.logs.entries.length?(n(),u("div",wt,[(n(!0),u(T,null,M(t.logs.entries,i=>(n(),u("p",{key:i.createdAt,style:z({margin:0,"white-space":"pre-wrap",color:i.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},[i.payload.text?(n(),u("span",Zt,v(i.payload.text.trim()),1)):b("",!0)],4))),128))])):(n(),A(s(C),{key:1,type:"secondary"},{default:p(()=>[H("Empty")]),_:1}))]),_:1}))}});const $t=R(kt,[["__scopeId","data-v-b7f04a41"]]),Vt={key:0},Ct=["onClick"],It=["onClick"],Pt=E({__name:"ExecutionContext",props:{data:{},showFixWithAi:{type:Boolean},isSmartChatIdle:{type:Boolean}},emits:["ask-ai"],setup(c,{emit:t}){const e=c,i=N(!1),o=a=>{if(a==="legacyThreadData")return g.translate("i18n_executioncontext_thread_data");const l=j(a);return l.replace(/([A-Z])/g," $1").trim(),l},r=a=>a==null?!0:Array.isArray(a)?a.length===0:typeof a=="object"?Object.keys(a).length===0:!1,d=a=>{typeof a=="object"&&a!==null&&"payload"in a?(navigator.clipboard.writeText(JSON.stringify(a.payload)),V.success({content:g.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),V.error({content:g.translate("i18n_executioncontext_no_payload")}))},y=a=>{i.value=!0,a.stopPropagation(),e.isSmartChatIdle!==!1&&(t("ask-ai"),setTimeout(()=>{i.value=!1},1e3))},_=a=>{typeof a=="object"?(navigator.clipboard.writeText(JSON.stringify(a)),V.success({content:g.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),V.error({content:g.translate("i18n_executioncontext_failed_copy_request")}))};return(a,l)=>(n(),A(s(X),{bordered:!1,style:{"background-color":"transparent",width:"100%"}},{default:p(()=>[f(s(U),{key:"execution-context"},{header:p(()=>[f(s(D),{justify:"space-between"},{default:p(()=>[f(s(C),null,{default:p(()=>[H(v(s(g).translate("i18n_executioncontext_header")),1)]),_:1}),f(s(I),{title:a.isSmartChatIdle?"":s(g).translate("i18n_executioncontext_wait_or_stop"),placement:"left"},{default:p(()=>[a.showFixWithAi?(n(),u("div",{key:0,class:q(["ask-to-ai",{disabled:!a.isSmartChatIdle||i.value}]),onClick:y},[H(v(s(g).translate("i18n_executioncontext_fix_with_ai"))+" ",1),f(s(Ht),{size:16})],2)):b("",!0)]),_:1},8,["title"])]),_:1})]),default:p(()=>[f(s(Q),{direction:"vertical",style:{"border-radius":"5px",padding:"10px",color:"#fff",width:"100%","font-family":"monospace","max-height":"600px",overflow:"auto",border:"1px solid #e8e8e8"}},{default:p(()=>[Object.keys(a.data).length?(n(!0),u(T,{key:1},M(Object.entries(a.data),([x,w])=>(n(),u("div",{key:x,class:"tree"},[x!=="legacyThreadData"||!r(w)?(n(),u("div",Vt,[f(s(C),{strong:""},{default:p(()=>[H(v(o(x)),1)]),_:2},1024),x==="request"?(n(),A(s(I),{key:0,title:s(g).translate("i18n_executioncontext_copy_request_tooltip")},{default:p(()=>[m("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:O=>_(w)},[f(s(S))],8,Ct)]),_:2},1032,["title"])):b("",!0),x==="triggerTask"?(n(),A(s(I),{key:1,title:s(g).translate("i18n_executioncontext_copy_payload_tooltip")},{default:p(()=>[m("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:O=>d(w)},[f(s(S))],8,It)]),_:2},1032,["title"])):b("",!0),f(s(W),{"tree-data":s(Y)(w),selectable:!1},null,8,["tree-data"])])):b("",!0)]))),128)):(n(),A(s(C),{key:0,type:"secondary"},{default:p(()=>[H(v(s(g).translate("i18n_executioncontext_empty")),1)]),_:1}))]),_:1})]),_:1})]),_:1}))}});const zt=R(Pt,[["__scopeId","data-v-f7630ec7"]]);class Nt{constructor(t){h(this,"state");h(this,"polling",et({task:()=>this.refetch(),interval:1e4}));h(this,"executionRepository");h(this,"buildRepository");h(this,"projectId");h(this,"pool");h(this,"onFilterChange");h(this,"handleFilterChange",()=>{this.state.currentPage.waitingDebounce=!0,this.state.pagination.currentIndex=1,this.debouncedPageRefetch(),this.onFilterChange&&this.onFilterChange(this.state.filters)});h(this,"debouncedPageRefetch",G.exports.debounce(async()=>{await this.fetchPage(),this.state.currentPage.waitingDebounce=!1},500));h(this,"fetchEmptyLogs",()=>{this.state.currentPage.openedExecutionIds.forEach(async t=>{this.state.currentPage.executionData[t]||await this.fetchExecutionDetails(t)})});const{executionRepository:e,buildRepository:i,projectId:o,filters:r={},pagination:d={},pool:y=!1,openedExecutionId:_,onFilterChange:a}=t;this.executionRepository=e,this.buildRepository=i,this.projectId=o,this.pool=y,this.onFilterChange=a,this.state=J({currentPage:{openedExecutionIds:_?[_]:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],executionData:{}},pagination:{currentIndex:1,pageSize:10,totalCount:0,...d},filters:{dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0,...r},filterOptions:{builds:[],stages:[],statuses:tt.map(l=>({label:j(l),value:l}))}}),P(()=>this.state.filters.buildId,()=>{this.fetchStageOptions()}),P(this.state.filters,()=>{this.state.currentPage.openedExecutionIds=[],this.handleFilterChange()}),P(this.state.pagination,()=>{this.state.currentPage.openedExecutionIds=[],this.fetchPage()})}async init(){await Promise.all([this.fetchPage(),this.fetchOptions()]),this.fetchEmptyLogs(),this.pool&&this.polling.startPolling()}teardown(){this.polling.endPolling()}async getNewestExecutionId(t){let e=this.state.currentPage.executions;return t&&(e=e.filter(o=>o.stageId===t)),e.length===0?null:e.reduce((o,r)=>o.createdAt>r.createdAt?o:r).id}async fetchPage(){var i,o,r,d;this.state.currentPage.loadingExecutions=!0;const{executions:t,totalCount:e}=await this.executionRepository.list({projectId:this.projectId,buildId:this.state.filters.buildId,status:this.state.filters.status,limit:this.state.pagination.pageSize,offset:(this.state.pagination.currentIndex-1)*this.state.pagination.pageSize,stageId:this.state.filters.stageId,startDate:(o=(i=this.state.filters.dateRange)==null?void 0:i[0])==null?void 0:o.toISOString(),endDate:(d=(r=this.state.filters.dateRange)==null?void 0:r[1])==null?void 0:d.toISOString(),search:this.state.filters.search});this.state.currentPage.loadingExecutions=!1,this.state.currentPage.executions=t,this.state.pagination.totalCount=e}async fetchBuildOptions(){if(!this.buildRepository)return;const e=(await this.buildRepository.list(this.projectId)).map(i=>({label:`[${i.id.slice(0,8)}] ${i.createdAt.toLocaleString()} ${i.latest?"(Latest)":""}`,value:i.id}));this.state.filterOptions.builds=e}async fetchStageOptions(){var i;if(!this.buildRepository){const r=(await this.executionRepository.fetchStages()).map(d=>({label:d.title,value:d.id}));this.state.filterOptions.stages=r!=null?r:[];return}const t=await K.get((i=this.state.filters.buildId)!=null?i:this.state.filterOptions.builds[0].value),e=t==null?void 0:t.runtimes.map(o=>({label:o.title,value:o.id}));this.state.filterOptions.stages=e!=null?e:[]}async fetchOptions(){await this.fetchBuildOptions(),await this.fetchStageOptions()}async fetchExecutionDetails(t){const[e,i,o]=await Promise.all([this.executionRepository.fetchLogs(this.projectId,t),this.executionRepository.fetchThreadData(this.projectId,t),this.executionRepository.getExecutionTasks(this.projectId,t)]);this.state.currentPage.executionData[t]={logs:e,threadData:i,tasks:{triggerTask:o.triggerTask?{type:o.triggerTask.type,payload:o.triggerTask.payload}:null,sentTasks:o.sentTasks.map(r=>({type:r.type,payload:r.payload}))}}}async refetch(){this.state.currentPage.openedExecutionIds.map(t=>this.fetchExecutionDetails(t))}}export{zt as E,$t as L,Nt as a};
//# sourceMappingURL=LogsController.8c7f5d3c.js.map
