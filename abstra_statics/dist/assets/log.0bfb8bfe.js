var re=Object.defineProperty;var ne=(s,e,t)=>e in s?re(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var n=(s,e,t)=>(ne(s,typeof e!="symbol"?e+"":e,t),t);import{b as c,eg as k,eh as ie,d as S,f as A,e as m,o as d,c as h,w as o,Y as z,eb as R,u as i,a as K,e9 as N,aS as W,bT as _,aG as g,ed as oe,cO as ee,S as j,a0 as E,dh as U,da as le,dc as ce,X as ue,ah as de,aW as te,ei as he,ct as pe,R as fe,cM as v,ej as ge,x as ye,O as me,E as _e}from"./index.f3c8f0bd.js";import{L as x,C as be,a as ve}from"./linters.d91dd72a.js";import{S as Ce}from"./workspaceStore.a9d10e56.js";import{A as L}from"./index.70f800f8.js";import{C as Se}from"./CloseCircleOutlined.6e638593.js";import{A as we}from"./index.6b72fb4c.js";import{W as Oe}from"./workspaces.172ba3d5.js";import{E as xe,u as Ae}from"./editor.60cc417b.js";import{p as Ie}from"./popupNotifcation.06d25674.js";import{F as ke}from"./PhArrowSquareOut.vue.14824ee3.js";import{_ as Pe}from"./DocsButton.vue_vue_type_script_setup_true_lang.b7cb4170.js";import{G as Te}from"./PhChats.vue.20068b9b.js";import{u as je}from"./polling.2e0e4e33.js";import{A as H}from"./ai.4bb90965.js";import{u as I}from"./uuid.f428292b.js";import{H as Ee}from"./PhCheckCircle.vue.d8dfe239.js";import{I as $e}from"./PhCopySimple.vue.f12f66d7.js";import{F as Ne,H as Le,J as De,S as Be}from"./scripts.7550ea3f.js";import{W as Fe,E as Ge}from"./controller.7d30accd.js";import{E as Me,a as Ve}from"./controller.3370b347.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[e]="3750c506-4bc7-4b4e-98cc-7a9f1513ca0b",s._sentryDebugIdIdentifier="sentry-dbid-3750c506-4bc7-4b4e-98cc-7a9f1513ca0b")}catch{}})();var ze={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M518.3 459a8 8 0 00-12.6 0l-112 141.7a7.98 7.98 0 006.3 12.9h73.9V856c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V613.7H624c6.7 0 10.4-7.7 6.3-12.9L518.3 459z"}},{tag:"path",attrs:{d:"M811.4 366.7C765.6 245.9 648.9 160 512.2 160S258.8 245.8 213 366.6C127.3 389.1 64 467.2 64 560c0 110.5 89.5 200 199.9 200H304c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8h-40.1c-33.7 0-65.4-13.4-89-37.7-23.5-24.2-36-56.8-34.9-90.6.9-26.4 9.9-51.2 26.2-72.1 16.7-21.3 40.1-36.8 66.1-43.7l37.9-9.9 13.9-36.6c8.6-22.8 20.6-44.1 35.7-63.4a245.6 245.6 0 0152.4-49.9c41.1-28.9 89.5-44.2 140-44.2s98.9 15.3 140 44.2c19.9 14 37.5 30.8 52.4 49.9 15.1 19.3 27.1 40.7 35.7 63.4l13.8 36.5 37.8 10C846.1 454.5 884 503.8 884 560c0 33.1-12.9 64.3-36.3 87.7a123.07 123.07 0 01-87.6 36.3H720c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h40.1C870.5 760 960 670.5 960 560c0-92.7-63.1-170.7-148.6-193.3z"}}]},name:"cloud-upload",theme:"outlined"};const Re=ze;var We={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0138.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"}}]},name:"github",theme:"filled"};const Ue=We;var He={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M865.3 244.7c-.3-.3-61.1 59.8-182.1 180.6l-84.9-84.9 180.9-180.9c-95.2-57.3-217.5-42.6-296.8 36.7A244.42 244.42 0 00419 432l1.8 6.7-283.5 283.4c-6.2 6.2-6.2 16.4 0 22.6l141.4 141.4c6.2 6.2 16.4 6.2 22.6 0l283.3-283.3 6.7 1.8c83.7 22.3 173.6-.9 236-63.3 79.4-79.3 94.1-201.6 38-296.6z"}}]},name:"tool",theme:"filled"};const Je=He;var qe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M464 720a48 48 0 1096 0 48 48 0 10-96 0zm16-304v184c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V416c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8zm475.7 440l-416-720c-6.2-10.7-16.9-16-27.7-16s-21.6 5.3-27.7 16l-416 720C56 877.4 71.4 904 96 904h832c24.6 0 40-26.6 27.7-48zm-783.5-27.9L512 239.9l339.8 588.2H172.2z"}}]},name:"warning",theme:"outlined"};const Ye=qe;function J(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?Object(arguments[e]):{},a=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(a=a.concat(Object.getOwnPropertySymbols(t).filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),a.forEach(function(r){Xe(s,r,t[r])})}return s}function Xe(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var D=function(e,t){var a=J({},e,t.attrs);return c(k,J({},a,{icon:Re}),null)};D.displayName="CloudUploadOutlined";D.inheritAttrs=!1;const $=D;function q(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?Object(arguments[e]):{},a=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(a=a.concat(Object.getOwnPropertySymbols(t).filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),a.forEach(function(r){Qe(s,r,t[r])})}return s}function Qe(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var B=function(e,t){var a=q({},e,t.attrs);return c(k,q({},a,{icon:Ue}),null)};B.displayName="GithubFilled";B.inheritAttrs=!1;const Ze=B;function Y(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?Object(arguments[e]):{},a=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(a=a.concat(Object.getOwnPropertySymbols(t).filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),a.forEach(function(r){Ke(s,r,t[r])})}return s}function Ke(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var F=function(e,t){var a=Y({},e,t.attrs);return c(k,Y({},a,{icon:ie}),null)};F.displayName="InfoCircleOutlined";F.inheritAttrs=!1;const et=F;function X(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?Object(arguments[e]):{},a=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(a=a.concat(Object.getOwnPropertySymbols(t).filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),a.forEach(function(r){tt(s,r,t[r])})}return s}function tt(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var G=function(e,t){var a=X({},e,t.attrs);return c(k,X({},a,{icon:Je}),null)};G.displayName="ToolFilled";G.inheritAttrs=!1;const st=G;function Q(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?Object(arguments[e]):{},a=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(a=a.concat(Object.getOwnPropertySymbols(t).filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),a.forEach(function(r){at(s,r,t[r])})}return s}function at(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var M=function(e,t){var a=Q({},e,t.attrs);return c(k,Q({},a,{icon:Ye}),null)};M.displayName="WarningOutlined";M.inheritAttrs=!1;const rt=M;class nt{async createTable(e,t){return await(await fetch("/_editor/api/tables/table",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,name:t})})).json()}async createColumn(e,t,a){return await(await fetch("/_editor/api/tables/column",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tableId:e,name:t,type:a})})).json()}}const Z=new nt;class se{static createTable(e,t){return Z.createTable(e,t)}static createColumn(e,t,a){return Z.createColumn(e,t,a)}}const it=S({__name:"Linter",emits:["issueFixed"],setup(s,{emit:e}){const t=A(()=>{var u,p;return(p=(u=x.asyncComputed.result.value)==null?void 0:u.flatMap(f=>f.issues))!=null?p:[]}),a=A(()=>{const u=t.value.map(p=>y(x.fromName(p.ruleName)));return u.includes("error")?"error":u.includes("warning")?"warning":"info"}),r=m(!1);async function l(u){r.value=!0;try{await u.fix(),e("issueFixed",u)}finally{r.value=!1}}function y(u){return u.type==="bug"?"warning":u.type==="security"?"error":"info"}return(u,p)=>t.value.length>0?(d(),h(i(ee),{key:0,placement:"bottomRight"},{content:o(()=>[c(i(L),{direction:"vertical",style:{"max-height":"300px",overflow:"auto"}},{default:o(()=>[(d(!0),z(W,null,R(t.value,(f,C)=>(d(),h(i(we),{key:C+f.ruleName,type:y(i(x).fromName(f.ruleName)),style:{width:"400px"},message:i(x).fromName(f.ruleName).label},{description:o(()=>[c(i(L),{direction:"vertical",style:{width:"100%"}},{default:o(()=>[K("div",null,N(f.label),1),(d(!0),z(W,null,R(f.fixes,b=>(d(),h(i(_),{key:b.name,loading:r.value,disabled:r.value,onClick:T=>l(b)},{icon:o(()=>[c(i(st))]),default:o(()=>[g(" "+N(b.label),1)]),_:2},1032,["loading","disabled","onClick"]))),128))]),_:2},1024)]),_:2},1032,["type","message"]))),128))]),_:1})]),default:o(()=>[c(i(_),{class:oe(["linter-btn",a.value])},{default:o(()=>[a.value==="info"?(d(),h(i(et),{key:0})):a.value==="error"?(d(),h(i(Se),{key:1})):(d(),h(i(rt),{key:2}))]),_:1},8,["class"])]),_:1})):j("",!0)}});const ot=E(it,[["__scopeId","data-v-47a27891"]]),lt=S({__name:"DeployButton",props:{isReadyToDeploy:{type:Boolean,required:!0},projectId:{type:String,required:!1}},setup(s){const e=s,t=m(!1),a=m(!1),r=m(!1);function l(){a.value=!1}async function y(){if(!!e.projectId){t.value=!0;try{await Oe.deploy(),window.open(u(),"_blank"),r.value=!0,setTimeout(()=>{r.value=!1},6e4)}catch(p){Ie("Deploy failed",String(p))}t.value=!1}}function u(){if(!!e.projectId)return`${xe.consoleUrl}/projects/${e.projectId}/builds`}return(p,f)=>s.isReadyToDeploy?(d(),h(i(ee),{key:0,open:a.value,"onUpdate:open":f[0]||(f[0]=C=>a.value=C),trigger:"click",title:"Deploy to Abstra Cloud"},{content:o(()=>[r.value?(d(),h(i(U),{key:0,class:"deploy-state-message",align:"middle"},{default:o(()=>[c(i(ce),null,{default:o(()=>[g(" Deploy started at "),c(i(le),{href:u(),target:"_blank"},{default:o(()=>[g("Abstra Cloud")]),_:1},8,["href"]),g(". ")]),_:1})]),_:1})):j("",!0),c(i(U),{class:"action-buttons",gap:"small"},{default:o(()=>[c(i(_),{onClick:l},{default:o(()=>[g("Close")]),_:1}),r.value?(d(),h(i(_),{key:0,class:"deploy-button",type:"primary",href:u(),target:"_blank"},{icon:o(()=>[c(i(ke),{color:"white",size:"20"})]),default:o(()=>[g(" Open Console ")]),_:1},8,["href"])):(d(),h(i(_),{key:1,type:"primary",loading:t.value,onClick:y},{icon:o(()=>[c(i($))]),default:o(()=>[g(" Deploy ")]),_:1},8,["loading"]))]),_:1})]),default:o(()=>[t.value?(d(),h(i(_),{key:0,disabled:""},{default:o(()=>[g("Deploying")]),_:1})):(d(),h(i(_),{key:1},{icon:o(()=>[c(i($))]),default:o(()=>[g(" Deploy ")]),_:1}))]),_:1},8,["open"])):(d(),h(i(_),{key:1,disabled:""},{icon:o(()=>[c(i($))]),default:o(()=>[g(" Deploy ")]),_:1}))}});const ct=E(lt,[["__scopeId","data-v-a2fa9262"]]),ut=S({__name:"GithubStars",setup(s){return(e,t)=>(d(),h(i(_),{href:"https://github.com/abstra-app/abstra-lib",target:"_blank",type:"text",size:"small"},{default:o(()=>[c(i(Ze)),g(" GitHub ")]),_:1}))}}),dt=S({__name:"IntercomButton",setup(s){return(e,t)=>(d(),h(i(_),{class:"intercom-launcher",target:"_blank",type:"text",size:"small",style:{display:"flex","align-items":"center",gap:"6px"}},{icon:o(()=>[c(i(Te),{size:18})]),default:o(()=>[g(" Support ")]),_:1}))}}),ht=S({__name:"NavbarControls",props:{showGithubStars:{type:Boolean},docsPath:{},editingModel:{}},setup(s){var C;const e=s,t=Ae(),a=(C=Ce.instance)==null?void 0:C.isStagingRelease,{result:r,refetch:l}=x.asyncComputed,{startPolling:y,endPolling:u}=je({task:l,interval:1e4});ue(()=>y()),de(()=>u());const p=A(()=>{var T,w;return((w=(T=r.value)==null?void 0:T.flatMap(O=>["error","security","bug"].includes(O.type)?O.issues:[]))!=null?w:[]).length>0}),f=A(()=>{var b;return p.value?"issues-found":(b=e.editingModel)!=null&&b.hasChanges()?"unsaved":a?"is-staging":"ready"});return(b,T)=>(d(),h(i(L),null,{default:o(()=>{var w;return[e.showGithubStars?(d(),h(ut,{key:0})):j("",!0),c(Pe,{path:e.docsPath},null,8,["path"]),c(dt),(w=b.editingModel)!=null&&w.hasChanges()?j("",!0):(d(),h(ot,{key:1})),c(i(pe),null,{default:o(()=>[c(i(te),null,he({default:o(()=>{var O;return[c(ct,{"is-ready-to-deploy":f.value==="ready","project-id":(O=i(t).cloudProject)==null?void 0:O.id},null,8,["is-ready-to-deploy","project-id"])]}),_:2},[f.value==="unsaved"?{name:"title",fn:o(()=>[g(" Save your project before deploying ")]),key:"0"}:f.value==="issues-found"?{name:"title",fn:o(()=>[g(" There are errors on your project. Please fix them before deploying. ")]),key:"1"}:f.value==="is-staging"?{name:"title",fn:o(()=>[g(" This is a staging release. You can't deploy it to Abstra Cloud. ")]),key:"2"}:void 0]),1024)]),_:1})]}),_:1}))}});const zt=E(ht,[["__scopeId","data-v-37a68802"]]),pt=S({__name:"CopyButton",props:{textToCopy:{}},setup(s){const e=s,t=m(!1),a=()=>{navigator.clipboard.writeText(e.textToCopy),t.value=!0,setTimeout(()=>t.value=!1,2e3)},r=A(()=>t.value?"Copied!":"Copy to clipboard");return(l,y)=>(d(),h(i(te),null,{title:o(()=>[g(N(r.value),1)]),default:o(()=>[K("div",{class:"copy-button",onClick:a},[t.value?(d(),h(i(Ee),{key:1,color:"#fff",size:"22"})):(d(),h(i($e),{key:0,color:"#fff",size:"22"}))])]),_:1}))}});const ft=E(pt,[["__scopeId","data-v-d0b7e86d"]]);class P{}class V{constructor(){n(this,"envVarController",null);n(this,"workflowController",fe(null))}static async create(){const e=new V;return await e.init(),e}async init(){this.envVarController=await Me.create(new Ve,"editor"),this.workflowController.value=await Fe.init(new Ge,!0)}async refetch(){await this.init()}}class gt extends P{constructor(t,a,r,l,y,u,p,f){super();n(this,"loading",!1);n(this,"disabled",!1);this.actionsController=t,this.label=a,this.id=r,this.title=l,this.type=y,this.filename=u,this.code=p,this.position=f}async execute(){this.loading=!0;let t=null;if(this.type==="form"?t=await Ne.create(this.title,this.filename,this.position,this.id):this.type==="hook"?t=await Le.create(this.title,this.filename,this.position,this.id):this.type==="job"?t=await De.create(this.title,this.filename,this.position,this.id):this.type==="tasklet"&&(t=await Be.create(this.title,this.filename,this.position,this.id)),!t)throw new Error("No matched stage type");t.codeContent=this.code,await t.save(),this.loading=!1,this.disabled=!0,v.success({message:`Created stage ${this.title} successfully`}),await this.actionsController.refetch()}}class yt extends P{constructor(t,a,r,l){super();n(this,"loading",!1);n(this,"disabled",!1);this.actionsController=t,this.label=a,this.sourceId=r,this.targetId=l}async execute(){if(this.loading=!0,!this.actionsController.workflowController.value)throw this.loading=!1,v.error({message:"Some error occurred, please try again"}),new Error("WorkflowController is not initialized");this.actionsController.workflowController.value.connect([{sourceStageId:this.sourceId,targetStageId:this.targetId,type:"task",id:I()}]),await this.actionsController.workflowController.value.save(),this.loading=!1,this.disabled=!0,v.success({message:"Created transition successfully"})}}class mt extends P{constructor(t,a,r,l){super();n(this,"loading",!1);n(this,"disabled",!1);this.actionsController=t,this.label=a,this.key=r,this.value=l}async execute(){if(this.loading=!0,!this.actionsController.envVarController)throw this.loading=!1,v.error({message:"Some error occurred, please try again"}),new Error("EnvVarController is not initialized");this.actionsController.envVarController.create({key:this.key,value:this.value}),await this.actionsController.envVarController.save(),this.loading=!1,this.disabled=!0,v.success({message:`Set env var ${this.key} successfully`})}}class _t extends P{constructor(t,a,r,l){super();n(this,"loading",!1);n(this,"disabled",!1);this.actionsController=t,this.label=a,this.id=r,this.name=l}async execute(){this.loading=!0,await se.createTable(this.id,this.name),this.loading=!1,this.disabled=!0,v.success({message:`Created table ${this.name} successfully`})}}class bt extends P{constructor(t,a,r,l,y){super();n(this,"loading",!1);n(this,"disabled",!1);this.actionsController=t,this.label=a,this.tableId=r,this.name=l,this.type=y}async execute(){this.loading=!0,await se.createColumn(this.tableId,this.name,this.type),this.loading=!1,this.disabled=!0,v.success({message:`Created column ${this.name} successfully`})}}const vt={"create-stage":(s,e)=>new gt(s,e.actionLabel,e.id,e.stageName,e.stageType,e.filename,e.code,[e.position.x,e.position.y]),"add-transition":(s,e)=>new yt(s,e.actionLabel,e.sourceStageId,e.targetStageId),"set-env-var":(s,e)=>new mt(s,e.actionLabel,e.key,e.value),"create-table":(s,e)=>new _t(s,e.actionLabel,e.tableId,e.tableName),"create-column":(s,e)=>new bt(s,e.actionLabel,e.tableId,e.columnName,e.columnType)};class Rt{constructor(e,t){n(this,"_langGraphThreadId");n(this,"_input");n(this,"_badgeState");n(this,"_smartChatState");n(this,"_logService");n(this,"_stageId");n(this,"_cachedFileContent",null);n(this,"_actions","");n(this,"_isLoadingActions",m(!1));n(this,"_parsedActions",m([]));n(this,"setupThread",async()=>{this._smartChatState.value="creating-thread",this._langGraphThreadId.value=`abstra-assistant-thread-${I()}`,this._smartChatState.value="idle"});n(this,"renderCopyButtons",()=>{document.querySelectorAll("pre").forEach(t=>{t.style.position="relative";const a=c(ft,{textToCopy:t.textContent});ge(a,t)})});n(this,"getLastExecutionError",()=>{let e="";for(let t=this._logService.logs.length-1;t>=0;t--){const a=this._logService.logs[t];if(a.type==="stderr"){e=a.log;break}}return e});n(this,"clearActions",()=>{this._parsedActions.value=[],this._actions=""});n(this,"getPreffixes",e=>{const t=[{role:"user",content:`If necessary to check, this is my current code:
${e||"No code found"}
. Otherwise, just IGNORE it.

`}],a=this.getLastExecutionError();return a.length&&t.push({role:"user",content:`If necessary to check, I got this error during execution:
${a}. Otherwise, just IGNORE it.`}),t});n(this,"buildMessages",(e,t)=>{const a=this.getPreffixes(e),r=[{role:"system",content:"The Python code and its possible errors during execution are sent by default, but it should be IGNORED if the main question is not about them."},...a,{role:"user",content:this._input.value}];return t&&r.push({role:"user",content:"The last answer was bad and you must regenerate it differently."}),r});n(this,"send",async(e,t=!1)=>{this._cachedFileContent=e,this._logService.log({type:"ai-input",log:this._input.value}),this._smartChatState.value="processing";const a=this.buildMessages(e,t);try{const r=I();let l="";const y=this.getLastExecutionError(),u=H.sendMessage(a,this._stageId,this._langGraphThreadId.value,e,y,this.isIdle.bind(this));for await(const p of u){if(this.isIdle())break;if(this._smartChatState.value==="processing"&&(this._smartChatState.value="answering"),this._actions.length>0){this._actions+=p;continue}if(p.includes("__start_action")){this._isLoadingActions.value=!0,this._actions+=p;continue}l+=p,this._logService.log({type:"ai-output",log:l},r)}this._input.value=""}catch(r){this._logService.log({type:"ai-output",log:"Sorry, there was an issue processing your request. Plese try again later."}),console.error(r),ye(r)}finally{if(this._isLoadingActions.value=!1,this._actions.length>0){this._actions=this._actions.replace("__start_action",""),this._actions=this._actions.replace("```json",""),this._actions=this._actions.replace("```",""),this._actions=this._actions.trim();const r=JSON.parse(this._actions);await this.processActions(r),this._actions=""}this._smartChatState.value="idle",this.renderCopyButtons()}});n(this,"cancel",()=>{this._smartChatState.value="idle"});n(this,"isProcessing",()=>this._smartChatState.value==="processing");n(this,"isAnswering",()=>this._smartChatState.value==="answering");n(this,"isIdle",()=>this._smartChatState.value==="idle");n(this,"isCreatingThread",()=>this._smartChatState.value==="creating-thread");n(this,"setSeen",()=>{this._badgeState.value={type:"seen"}});n(this,"setUnseen",e=>{this._badgeState.value={type:"unseen",count:this._badgeState.value.type==="unseen"?this._badgeState.value.count+1:1,severity:e.type==="stderr"?"error":"info"}});n(this,"setInput",e=>{e=e==null?void 0:e.trimEnd(),this._input.value=e||""});n(this,"regenerateLast",async()=>{for(let e=this._logService.logs.length-1;e>=0;e--){const t=this._logService.logs[e];if(t.type==="ai-input"){this.setInput(t.log);break}}await this.send(this._cachedFileContent,!0)});n(this,"fixJson",async(e,t)=>{this._logService.clear(),this._logService.log({type:"ai-input",log:`here is my json code:
      ${e}
      And I got this error:`}),this._logService.log({type:"stderr",log:t}),this.setSeen(),this.setInput("Can you fix this JSON?"),await this.send(null)});n(this,"vote",async(e,t)=>{const a=this._logService.logs[e],r=this._logService.logs[e-1],l=this._logService.logs.slice(0,e-1);await H.vote(t,r,a,l)});this._stageId=t,this._logService=e,this._langGraphThreadId=m(null),this._input=m(""),this._badgeState=m({type:"seen"}),this._smartChatState=m("idle")}init(){this.setupThread(),this.renderCopyButtons()}async processActions(e){const a=me.union([be,ve]).parse(e),r=await V.create();a.actions.forEach(l=>{if(l.action==="create-table"||l.action==="create-column"||l.action==="set-env-var"||l.action==="create-stage"||l.action==="add-transition"){const y=vt[l.action],u=y(r,l);this._parsedActions.value.push(u)}})}get actions(){return this._parsedActions}isLoadingActions(){return this._isLoadingActions.value}getVisibleActions(){return this._parsedActions.value}get badgeState(){return this._badgeState.value}get input(){return this._input.value}}class ae{constructor(){n(this,"logState",_e({log:[]}));n(this,"_listeners",{})}static create(){return new ae}get logs(){return this.logState.log}hasAiLogs(){return this.logs.some(e=>e.type==="ai-input"||e.type==="ai-output")}log(e,t){if(e.type!=="restart"&&e.log.trim()==="")return;const a=t?this.logs.find(r=>r.id===t):null;return a?(a.type==="stderr"&&e.type==="stderr"&&(e.log=a.log+`
`+e.log),Object.assign(a,e)):this.logs.push({...e,id:t||I()}),this.notifyListeners(e),t}clear(){this.logState.log=[]}listen(e){const t=I();return this._listeners[t]=e,t}unlisten(e){delete this._listeners[e]}notifyListeners(e){Object.values(this._listeners).forEach(t=>t(e))}}export{ae as L,zt as N,Rt as S};
//# sourceMappingURL=log.0bfb8bfe.js.map
