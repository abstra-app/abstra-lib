import{a as x}from"./router-Dy-EE0-5.js";import{a as q,j as N,c as A,k as T,f as m,l as V,e as z,m as b,n as W,V as G,r as u,i as k,b as B,w as U,u as M,g as K,t as Q,A as X,aK as Y,h as ee,cD as te,aJ as se,d as oe,s as j}from"./jwt-decode.esm-BT0CZMUi.js";import{P as ie}from"./record-Bo4Wk8Mz.js";import{u as S}from"./uuid-DIQx-id2.js";import{I as re}from"./PhCopySimple.vue-B7eE_yeB.js";(function(){try{var c=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(c._sentryDebugIds=c._sentryDebugIds||{},c._sentryDebugIds[e]="7c2dda03-af37-4f0f-9a21-af8059e0525a",c._sentryDebugIdIdentifier="sentry-dbid-7c2dda03-af37-4f0f-9a21-af8059e0525a")}catch{}})();const ae=["width","height","fill","transform"],ne={key:0},le=b("path",{d:"M176.49,95.51a12,12,0,0,1,0,17l-56,56a12,12,0,0,1-17,0l-24-24a12,12,0,1,1,17-17L112,143l47.51-47.52A12,12,0,0,1,176.49,95.51ZM236,128A108,108,0,1,1,128,20,108.12,108.12,0,0,1,236,128Zm-24,0a84,84,0,1,0-84,84A84.09,84.09,0,0,0,212,128Z"},null,-1),ce=[le],he={key:1},ue=b("path",{d:"M224,128a96,96,0,1,1-96-96A96,96,0,0,1,224,128Z",opacity:"0.2"},null,-1),de=b("path",{d:"M173.66,98.34a8,8,0,0,1,0,11.32l-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35A8,8,0,0,1,173.66,98.34ZM232,128A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"},null,-1),ge=[ue,de],pe={key:2},fe=b("path",{d:"M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm45.66,85.66-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35a8,8,0,0,1,11.32,11.32Z"},null,-1),ve=[fe],ye={key:3},_e=b("path",{d:"M172.24,99.76a6,6,0,0,1,0,8.48l-56,56a6,6,0,0,1-8.48,0l-24-24a6,6,0,0,1,8.48-8.48L112,151.51l51.76-51.75A6,6,0,0,1,172.24,99.76ZM230,128A102,102,0,1,1,128,26,102.12,102.12,0,0,1,230,128Zm-12,0a90,90,0,1,0-90,90A90.1,90.1,0,0,0,218,128Z"},null,-1),me=[_e],we={key:4},Se=b("path",{d:"M173.66,98.34a8,8,0,0,1,0,11.32l-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35A8,8,0,0,1,173.66,98.34ZM232,128A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"},null,-1),be=[Se],Ce={key:5},Te=b("path",{d:"M170.83,101.17a4,4,0,0,1,0,5.66l-56,56a4,4,0,0,1-5.66,0l-24-24a4,4,0,0,1,5.66-5.66L112,154.34l53.17-53.17A4,4,0,0,1,170.83,101.17ZM228,128A100,100,0,1,1,128,28,100.11,100.11,0,0,1,228,128Zm-8,0a92,92,0,1,0-92,92A92.1,92.1,0,0,0,220,128Z"},null,-1),Ae=[Te],Ie={name:"PhCheckCircle"},xe=q({...Ie,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(c){const e=c,t=N("weight","regular"),s=N("size","1em"),o=N("color","currentColor"),n=N("mirrored",!1),a=A(()=>e.weight??t),h=A(()=>e.size??s),d=A(()=>e.color??o),l=A(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:n?"scale(-1, 1)":void 0);return(p,f)=>(m(),T("svg",W({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:h.value,height:h.value,fill:d.value,transform:l.value},p.$attrs),[V(p.$slots,"default"),a.value==="bold"?(m(),T("g",ne,ce)):a.value==="duotone"?(m(),T("g",he,ge)):a.value==="fill"?(m(),T("g",pe,ve)):a.value==="light"?(m(),T("g",ye,me)):a.value==="regular"?(m(),T("g",we,be)):a.value==="thin"?(m(),T("g",Ce,Ae)):z("",!0)],16,ae))}});class R{logState=G({log:[]});_listeners={};static create(){return new R}get logs(){return this.logState.log}hasAiLogs(){return this.logs.some(e=>e.type==="ai-input"||e.type==="ai-output")}log(e,t){if(e.type!=="restart"&&e.type!=="ai-tool-approval"&&e.type!=="ai-tool-call-response"&&"log"in e&&e.log.trim()===""&&!(e.type==="ai-input"&&e.attachments&&e.attachments.length>0))return;const s=t?this.logs.find(o=>o.id===t):null;return s?(s.type==="stderr"&&e.type==="stderr"&&(e.log=s.log+`
`+e.log),Object.assign(s,e)):this.logs.push({...e,id:t||S()}),this.notifyListeners(e),t}clear(){this.logState.log=[]}listen(e){const t=S();return this._listeners[t]=e,t}unlisten(e){delete this._listeners[e]}notifyListeners(e){Object.values(this._listeners).forEach(t=>t(e))}getLastExecutionLogs=e=>{let t="";for(let s=this.logs.length-1;s>=0;s--){const o=this.logs[s];if(o.type!==e&&t.length>0)break;o.type===e&&(t=`${o.log}
${t}`)}return t}}class O{_badgeState;constructor(){this._badgeState=u({type:"seen"})}get badgeState(){return this._badgeState.value}isSeen(){return this._badgeState.value.type==="seen"}isUnseen(){return this._badgeState.value.type==="unseen"}getUnseenCount(){return this._badgeState.value.type==="unseen"?this._badgeState.value.count:0}getSeverity(){return this._badgeState.value.type==="unseen"?this._badgeState.value.severity:null}setSeen(){this._badgeState.value={type:"seen"}}setUnseen(e){const t=this._badgeState.value.type==="unseen"?this._badgeState.value.count:0,s=e.type==="stderr"?"error":"info";this._badgeState.value={type:"unseen",count:t+1,severity:s}}reset(){this.setSeen()}static create(){return new O}}class J{constructor(e,t){this.flag=e,this.acc=t,this.staging=""}staging}class Ne extends J{constructor(){super("___JSON_MODE___",[])}reduceChar(e){try{this.staging+=e;const t=JSON.parse(this.staging);return this.acc.push(t),this.staging="",t}catch{return}}reduce(e){const t=[];for(const s of e){const o=this.reduceChar(s);o!==void 0&&t.push(o)}return t}}class ke extends J{constructor(){super("___TEXT_MODE___","")}reduce(e){return this.staging+=e,this.acc=this.staging,e}}class E{mode;modes=[new ke,new Ne];staging="";chunkOnBuffer="";flagMap;flagPrefixes;constructor(){this.mode=this.modes[0],this.flagMap=new Map,this.flagPrefixes=new Set;for(const e of this.modes){this.flagMap.set(e.flag,e);for(let t=1;t<e.flag.length;t++)this.flagPrefixes.add(e.flag.slice(0,t))}}*reduce(e){for(const t of e){if(this.staging+=t,this.flagMap.has(this.staging)){this.mode=this.flagMap.get(this.staging),this.staging="";continue}if(!this.flagPrefixes.has(this.staging))for(;this.staging.length>0;){const s=this.staging[0];this.staging=this.staging.slice(1);const o=this.mode.reduce(s);if(o!==void 0&&(Array.isArray(o)?yield*o:yield o),this.flagPrefixes.has(this.staging))break}}}*reduceInChunks(e,t){let s="";for(const o of this.reduce(t))if(typeof o=="string")for(s+=o;s.length>=e;)yield s.slice(0,e),s=s.slice(e);else s.length>0&&(yield s,s=""),yield o;s.length>0&&(yield s)}}const F=300;class Ee{_baseUrl="/_editor/api/ai";_headers={"Content-Type":"application/json"};async*sendMessage(e,t,s,o,n,a){const h={conversationId:e,content:t,context:s,toolCallsApproval:n,browserTools:a},d=await fetch(`${this._baseUrl}/stream`,{method:"POST",headers:this._headers,body:JSON.stringify(h)});if(!d.ok)throw new Error("Failed to send message");const l=d.body?.getReader();if(!l)throw new Error("No response body");const p=new E;for(;!o();){const f=await l.read();if(f.done)break;for(const v of p.reduceInChunks(F,new TextDecoder().decode(f.value)))yield v}}async*sendBrowserToolResponses(e,t,s,o){const n={conversationId:e,content:[],context:s,browserToolResponses:t,browserTools:o},a=await fetch(`${this._baseUrl}/stream`,{method:"POST",headers:this._headers,body:JSON.stringify(n)});if(!a.ok)throw new Error("Failed to send browser tool responses");const h=a.body?.getReader();if(!h)throw new Error("No response body");const d=new E;for(;;){const l=await h.read();if(l.done)break;for(const p of d.reduceInChunks(F,new TextDecoder().decode(l.value)))yield p}}async deleteThread(e){if(!(await fetch(`${this._baseUrl}/thread/${e}`,{method:"DELETE",headers:this._headers})).ok)throw new Error("Failed to delete thread")}async abortStreaming(e){if(!(await fetch(`${this._baseUrl}/abort`,{method:"POST",headers:this._headers,body:JSON.stringify({langGraphThreadId:e})})).ok)throw new Error("Failed to abort streaming")}async getHistory(e,t){const s=await fetch(`${this._baseUrl}/history?limit=${e}&offset=${t}`,{method:"GET"});if(!s.ok)throw new Error("Failed to fetch history");return await s.json()}startConversation(){return new Promise((e,t)=>{fetch(`${this._baseUrl}/start-conversation`,{method:"POST",headers:this._headers}).then(s=>{if(!s.ok)throw new Error("Failed to start conversation");return s.json()}).then(s=>e(s)).catch(s=>t(s))})}}class Fe{projectId;baseUrl;constructor(e){this.projectId=e,this.baseUrl=`projects/${e}`}startConversation(){throw new Error("Method not implemented.")}async*sendMessage(e,t,s,o,n,a){const h={conversationId:e,content:t,context:s,toolCallsApproval:n,browserTools:a},l=(await x.postRaw(`${this.baseUrl}/messages`,h)).body?.getReader();if(!l)throw new Error("No response body");const p=new E;for(;!o();){const f=await l.read();if(f.done)break;for(const v of p.reduceInChunks(F,new TextDecoder().decode(f.value)))yield v}}async*sendBrowserToolResponses(e,t,s,o){const n={conversationId:e,content:[],context:s,browserToolResponses:t,browserTools:o},h=(await x.postRaw(`${this.baseUrl}/messages`,n)).body?.getReader();if(!h)throw new Error("No response body");const d=new E;for(;;){const l=await h.read();if(l.done)break;for(const p of d.reduceInChunks(F,new TextDecoder().decode(l.value)))yield p}}async abortStreaming(e){await x.post(`${this.baseUrl}/abort`,{langGraphThreadId:e})}async getHistory(e,t){const s={limit:`${e}`,offset:`${t}`};return await x.get(`${this.baseUrl}/history`,s)}async deleteThread(e){await x.delete(`${this.baseUrl}/conversation/${e}`)}}class Z{tools=new Map;register(e){this.tools.set(e.name,e)}get(e){return this.tools.get(e)}has(e){return this.tools.has(e)}getAll(){return Array.from(this.tools.values())}toDefinitions(){return this.getAll().map(({name:e,description:t,payloadSchema:s})=>({name:e,description:t,payloadSchema:s}))}async execute(e){const t=this.get(e.toolName);if(!t)throw new Error(`Browser tool not found: ${e.toolName}`);const s=await t.execute(e.args);return{toolCallId:e.toolCallId,response:s}}}const Be=q({__name:"CopyButton",props:{textToCopy:{}},setup(c){const e=c,t=u(!1),s=()=>{navigator.clipboard.writeText(e.textToCopy),t.value=!0,setTimeout(()=>t.value=!1,2e3)},o=A(()=>t.value?k.translate("i18n_copybutton_copied"):k.translate("i18n_copybutton_copy_to_clipboard"));return(n,a)=>(m(),B(M(X),null,{title:U(()=>[K(Q(o.value),1)]),default:U(()=>[b("div",{class:"copy-button",onClick:s},[t.value?(m(),B(M(xe),{key:1,color:"#fff",size:"22"})):(m(),B(M(re),{key:0,color:"#fff",size:"22"}))])]),_:1}))}}),Me=Y(Be,[["__scopeId","data-v-95878e02"]]);class ${_conversationId;_input;_attachments;_recentlyAccessedThreads;constructor(){this._conversationId=u(null),this._input=u(""),this._attachments=u([]),this._recentlyAccessedThreads=u([])}get conversationId(){return this._conversationId.value}get input(){return this._input.value}get attachments(){return this._attachments.value}get recentThreads(){return this._recentlyAccessedThreads.value}hasActiveConversation(){return this._conversationId.value!==null}setupThread(){const e=`abstra-assistant-thread-${S()}`;return this._conversationId.value=e,this._recentlyAccessedThreads.value.unshift({id:e,messages:[],createdAt:new Date().toISOString()}),e}setInput(e,t){this._input.value=e?.trimEnd()||"",this._attachments.value=t||[]}clearInput(){this._input.value="",this._attachments.value=[]}switchThread(e){this._conversationId.value=e;const t=this._recentlyAccessedThreads.value.findIndex(o=>o.id===e);if(t===-1)throw new Error(`Thread ${e} not found in recent threads`);const[s]=this._recentlyAccessedThreads.value.splice(t,1);this._recentlyAccessedThreads.value.unshift(s)}addThreadToRecents(e){const t=this._recentlyAccessedThreads.value.findIndex(s=>s.id===e.id);t!==-1&&this._recentlyAccessedThreads.value.splice(t,1),this._recentlyAccessedThreads.value.unshift(e),this._conversationId.value=e.id}removeThread(e){const t=this._recentlyAccessedThreads.value.findIndex(s=>s.id===e);t!==-1&&(this._recentlyAccessedThreads.value.splice(t,1),this._conversationId.value===e&&(this._recentlyAccessedThreads.value.length>0?this._conversationId.value=this._recentlyAccessedThreads.value[0].id:this._conversationId.value=null))}addMessageToCurrentThread(e){this._recentlyAccessedThreads.value=this._recentlyAccessedThreads.value.map(t=>(t.id===this._conversationId.value&&t.messages.unshift({role:"assistant",content:e,createdAt:new Date().toISOString()}),t))}getThreadById(e){return this._recentlyAccessedThreads.value.find(t=>t.id===e)||null}getCurrentThread(){return this._conversationId.value?this.getThreadById(this._conversationId.value):null}reset(){this._conversationId.value=null,this._input.value="",this._attachments.value=[],this._recentlyAccessedThreads.value=[]}static create(){return new $}}class L{_repository;_history;_isLoading;_pagination;constructor(e){this._repository=e,this._history=u([]),this._isLoading=u(!1),this._pagination=u({limit:10,offset:0,done:!1})}get history(){return this._history.value}get isLoading(){return this._isLoading.value}get hasMore(){return!this._pagination.value.done}async fetchHistory(){this._isLoading.value=!0;try{const e=await this._repository.getHistory(this._pagination.value.limit,this._pagination.value.offset);e.length<this._pagination.value.limit&&(this._pagination.value.done=!0),this._history.value=e}finally{this._isLoading.value=!1}}async loadMore(){this._isLoading.value=!0;try{this._pagination.value.offset+=this._pagination.value.limit;const e=await this._repository.getHistory(this._pagination.value.limit,this._pagination.value.offset);e.length<this._pagination.value.limit&&(this._pagination.value.done=!0),this._history.value=[...this._history.value,...e]}finally{this._isLoading.value=!1}}removeFromHistory(e){const t=this._history.value.findIndex(s=>s.id===e);t!==-1&&this._history.value.splice(t,1)}reset(){this._history.value=[],this._pagination.value={limit:10,offset:0,done:!1}}static create(e){return new L(e)}}class D{extractTextContent(e){return typeof e=="string"?e:Array.isArray(e)?e.filter(t=>t.type==="text"&&t.text).map(t=>t.text).join(`
`):""}extractAttachments(e){if(typeof e=="string"||!Array.isArray(e))return[];let t=0;return e.filter(s=>s.type==="image_url"&&s.image_url?.url).map(s=>{t++;const n=s.image_url.url.match(/^data:([^;]+);base64,(.+)$/);if(n){const[,a,h]=n,d=Math.ceil(h.length*3/4);let l=a.split("/")[1]||"jpg";return(!l||!a.startsWith("image/"))&&(l="jpg"),{fileName:`image_${t}.${l}`,fileContent:h,fileSize:d,mimeType:a}}return{fileName:`image_${t}.jpg`,fileContent:"",fileSize:0,mimeType:"image/jpeg"}})}buildMessageContent(e,t){const s=[];e.trim()&&s.push({type:"text",text:e.trim()});const o=t.map(n=>({type:"file",fileName:n.fileName,fileContent:n.fileContent}));return s.push(...o),s}static create(){return new D}}class H{_repository;_smartChatState;_logService;_hasError=u(null);_executingFormFile=u(null);_manualFormStop=u(!1);_browserToolRegistry=new Z;_pendingBrowserToolResponses=new Map;_badgeService;_messageService;_conversationService;_historyService;loadingAbort=u(!1);codeForApproval=u(null);_stopFormCallback;notifyOnToolCall=u(!0);notifyOnAiDone=u(!0);hasBeenAskedAboutNotifications=u(!1);showNotificationConsent=u(!1);_lastCompletionSummary=null;constructor(e,t,s){this._repository=e,this._logService=t,this._stopFormCallback=s,this._smartChatState=u("idle"),this._badgeService=O.create(),this._messageService=D.create(),this._conversationService=$.create(),this._historyService=L.create(e)}registerBrowserTools(e){for(const t of e)this._browserToolRegistry.register(t)}clearBrowserTools(){this._browserToolRegistry=new Z}getBrowserToolDefinitions(){return this._browserToolRegistry.toDefinitions()}init(){this.setupThread(),this.renderCopyButtons(),this.loadNotificationPreferences()}loadNotificationPreferences(){const e=localStorage.getItem("abstra_ai_notifications");if(e)try{const{tool:t,done:s,hasBeenAsked:o}=JSON.parse(e);this.notifyOnToolCall.value=t??!0,this.notifyOnAiDone.value=s??!0,this.hasBeenAskedAboutNotifications.value=o??!1}catch(t){console.error("Failed to load notification preferences",t),localStorage.removeItem("abstra_ai_notifications")}this.updateConsentPromptVisibility()}updateConsentPromptVisibility(){if(typeof Notification>"u"){this.showNotificationConsent.value=!1;return}const e=Notification.permission;if(e==="denied"){this.showNotificationConsent.value=!1,this.hasBeenAskedAboutNotifications.value=!0;return}if(e==="granted"){this.showNotificationConsent.value=!1;return}this.showNotificationConsent.value=!this.hasBeenAskedAboutNotifications.value}async acceptNotifications(){const e=await Notification.requestPermission();this.notifyOnToolCall.value=e==="granted",this.notifyOnAiDone.value=e==="granted",this.hasBeenAskedAboutNotifications.value=!0,this.showNotificationConsent.value=!1,this.saveNotificationPreferences()}declineNotifications(){this.notifyOnToolCall.value=!1,this.notifyOnAiDone.value=!1,this.hasBeenAskedAboutNotifications.value=!0,this.showNotificationConsent.value=!1,this.saveNotificationPreferences()}saveNotificationPreferences(){localStorage.setItem("abstra_ai_notifications",JSON.stringify({tool:this.notifyOnToolCall.value,done:this.notifyOnAiDone.value,hasBeenAsked:this.hasBeenAskedAboutNotifications.value}))}setupThread=async()=>{this._conversationService.setupThread()};fetchHistory=async()=>{await this._historyService.fetchHistory()};loadMoreHistory=async()=>{await this._historyService.loadMore()};setError=e=>{this._hasError.value=e};setExecutingFormFile=e=>{this._executingFormFile.value=e};get isManualFormStop(){return this._manualFormStop.value}get hasCodeForApproval(){return!!this.codeForApproval.value}clearManualFormStop=()=>{this._manualFormStop.value=!1};stopForm=()=>{if(this._stopFormCallback){this._manualFormStop.value=!0,this._stopFormCallback(),this._executingFormFile.value=null;for(const e of this._logService.logs)e.type==="ai-tool-approval"&&e.isFormRunning&&(e.isFormRunning=!1,e.executingFormFile=null)}};get hasError(){return this._hasError.value?.payload||null}_fillChat=e=>{this._logService.clear();for(const t of e)if(t.toolTitle)this._logService.log({type:"ai-tool-approval",toolCallId:t.toolCallId,description:t.toolTitle,args:{},disabled:!1,needsApproval:!1,loading:!1}),this._logService.log({type:"ai-tool-call-response",toolCallId:t.toolCallId,response:this._messageService.extractTextContent(t.content)});else{const s=this._messageService.extractAttachments(t.content);s.length>0&&t.role==="user"?this._logService.log({type:"ai-input",log:this._messageService.extractTextContent(t.content),attachments:s}):this._logService.log({type:t.role==="user"?"ai-input":"ai-output",log:this._messageService.extractTextContent(t.content)})}this.renderCopyButtons()};moveThreadFromHistoryToRecents=e=>{const t=this._historyService.history.find(s=>s.id===e);if(!t)throw new Error(`Thread ${e} not found`);this._conversationService.addThreadToRecents(t),this._fillChat(t.messages)};deleteThread=e=>{this._repository.deleteThread(e),this._conversationService.removeThread(e),this._historyService.removeFromHistory(e);const t=this._conversationService.getCurrentThread();t?this._fillChat(t.messages):this._logService.clear()};setCurrentThreadFromRecents=e=>{this._conversationService.switchThread(e);const t=this._conversationService.getCurrentThread();if(!t)throw new Error(`Thread ${e} not found`);this._fillChat(t.messages)};removeFromRecentlyAccessedThreads=e=>{this._conversationService.removeThread(e),this._logService.clear();const t=this._conversationService.getCurrentThread();t&&this._fillChat(t.messages)};renderCopyButtons=()=>{document.querySelectorAll("pre").forEach(t=>{t.style.position="relative";const s=ee(Me,{textToCopy:t.textContent});te(s,t)})};clearLogService=()=>{this._logService.clear()};send=async(e,t,s=0)=>{this._conversationService.hasActiveConversation()||await this.setupThread(),s===0&&this._logService.log({type:"ai-input",log:this._conversationService.input,attachments:this._conversationService.attachments}),this._smartChatState.value="processing";try{typeof Notification<"u"&&this.notifyOnToolCall.value&&Notification.permission!=="granted"&&Notification.requestPermission();const o=S(),n=this._conversationService.conversationId;if(!n)throw new Error("Conversation ID is not set");const a=this._messageService.buildMessageContent(this._conversationService.input,this._conversationService.attachments),h={currentEditorUrl:window.location.href,panesInfo:e||{}},d=this.getBrowserToolDefinitions(),l=this._repository.sendMessage(n,a,h,this.isIdle.bind(this),t,d.length>0?d:void 0);let p="",f=o,v="";for await(const I of l){if(this.isIdle())break;this._smartChatState.value==="processing"&&(this._smartChatState.value="answering");const i=I;if(typeof i=="string"){if(i.includes("abstra__trigger__retry"))throw new Error("AI service requested a retry");p+=i,v+=i,this._logService.log({type:"ai-output",log:v},f)}else if(i instanceof Object){if(i.type==="ai-tool-approval"){typeof Notification<"u"&&this.notifyOnToolCall.value&&Notification.permission==="granted"&&new Notification("Abstra AI",{body:k.translate("i18n_omnichatheader_permission_requested",null,i.title),silent:!1});const y=i.args?.file,_=!!(i.args?.replacements||i.args?.content)&&this._executingFormFile.value===y;if(this._logService.log({type:"ai-tool-approval",toolCallId:i.toolCallId,description:i.title,args:i.args,disabled:!1,needsApproval:!0,loading:!1,isFormRunning:_,executingFormFile:_?this._executingFormFile.value:void 0}),i.args?.file&&i.args?.replacements){let g=i.args.replacements;typeof g=="string"&&(g=JSON.parse(g)),this.codeForApproval.value={file:i.args.file,replacements:g.map(w=>({oldContext:w.old_context,newContext:w.new_context}))}}else i.args?.file&&i.args?.content&&(this.codeForApproval.value={file:i.args.file,code:i.args.content})}else if(i.type==="ai-tool-call")this._logService.log({type:"ai-tool-approval",toolCallId:i.toolCallId,description:i.title,args:i.args,disabled:!1,needsApproval:!1,loading:!1}),f=S(),v="";else if(i.type==="ai-tool-call-response")this._logService.log({type:"ai-tool-call-response",toolCallId:i.toolCallId,response:i.response});else if(i.type==="ai-completion-summary")this._lastCompletionSummary=i.summary;else if(i.type==="ai-browser-tool-call"){const y=i.toolName,r=i.toolCallId,_=i.args||{};this._logService.log({type:"ai-tool-approval",toolCallId:r,description:i.title||`Browser Tool: ${y}`,args:_,disabled:!1,needsApproval:!1,loading:!0});try{const g=await this._browserToolRegistry.execute({toolCallId:r,toolName:y,args:_});this._logService.log({type:"ai-tool-call-response",toolCallId:r,response:typeof g.response=="string"?g.response:JSON.stringify(g.response)}),this._pendingBrowserToolResponses.set(r,g.response)}catch(g){const w=g instanceof Error?g.message:"Browser tool execution failed";this._logService.log({type:"ai-tool-call-response",toolCallId:r,response:`Error: ${w}`}),this._pendingBrowserToolResponses.set(r,{error:w})}f=S(),v=""}}}for(;this._pendingBrowserToolResponses.size>0;){const I=Array.from(this._pendingBrowserToolResponses.entries()).map(([y,r])=>({toolCallId:y,response:r}));this._pendingBrowserToolResponses.clear();const i=this._repository.sendBrowserToolResponses(n,I,h,d.length>0?d:void 0);for await(const y of i){if(this.isIdle())break;const r=y;if(typeof r=="string")p+=r,v+=r,this._logService.log({type:"ai-output",log:v},f);else if(r instanceof Object){if(r.type==="ai-tool-call-response")this._logService.log({type:"ai-tool-call-response",toolCallId:r.toolCallId,response:r.response});else if(r.type==="ai-tool-call")this._logService.log({type:"ai-tool-approval",toolCallId:r.toolCallId,description:r.title,args:r.args,disabled:!1,needsApproval:!1,loading:!1}),f=S(),v="";else if(r.type==="ai-completion-summary")this._lastCompletionSummary=r.summary;else if(r.type==="ai-browser-tool-call"){const _=r.toolName,g=r.toolCallId,w=r.args||{};this._logService.log({type:"ai-tool-approval",toolCallId:g,description:r.title||`Browser Tool: ${_}`,args:w,disabled:!1,needsApproval:!1,loading:!0});try{const C=await this._browserToolRegistry.execute({toolCallId:g,toolName:_,args:w});this._logService.log({type:"ai-tool-call-response",toolCallId:g,response:typeof C.response=="string"?C.response:JSON.stringify(C.response)}),this._pendingBrowserToolResponses.set(g,C.response)}catch(C){const P=C instanceof Error?C.message:"Browser tool execution failed";this._logService.log({type:"ai-tool-call-response",toolCallId:g,response:`Error: ${P}`}),this._pendingBrowserToolResponses.set(g,{error:P})}f=S(),v=""}}}}this._conversationService.addMessageToCurrentThread(p),this._conversationService.clearInput(),this._smartChatState.value="idle",this.renderCopyButtons(),typeof Notification<"u"&&this.notifyOnAiDone.value&&Notification.permission==="granted"&&(new Notification("Abstra AI",{body:this._lastCompletionSummary||k.translate("i18n_omnichatheader_ai_finished"),silent:!1}),this._lastCompletionSummary=null)}catch(o){console.error(o),se(o),s>3?(this._logService.log({type:"ai-output",log:"Sorry, there was an issue processing your request. Please try again later."}),this._conversationService.clearInput(),this._smartChatState.value="idle",this.renderCopyButtons()):(this._logService.log({type:"ai-output",log:"We had some trouble, but we are already retrying your request..."}),await this.abort(),this._conversationService.setInput("There was an unexpected error, please try again. You must continue from where you stopped as if nothing happened."),this.send(e,t,s+1))}};get logService(){return this._logService}shouldRenderLoadMoreHistory(){return this._historyService.hasMore}get pastThreads(){return this._historyService.history.map(e=>{if(e.messages.length===0)return{threadId:e.id,title:"New thread"};{const t=this._messageService.extractTextContent(e.messages[0].content);return{threadId:e.id,title:t}}})}get recentlyAccessedThreads(){return this._conversationService.recentThreads.map(e=>{if(e.messages.length===0)return{threadId:e.id,title:"New thread"};{const t=this._messageService.extractTextContent(e.messages[0].content);return{threadId:e.id,title:t.slice(0,20)+"..."}}})}abort=async()=>{const e=this._conversationService.conversationId;if(!e)throw new Error("Conversation ID is not set");this.loadingAbort.value=!0,await this._repository.abortStreaming(e),this._smartChatState.value="idle",this.loadingAbort.value=!1};isLoadingHistory=()=>this._historyService.isLoading;isProcessing=()=>this._smartChatState.value==="processing";isAnswering=()=>this._smartChatState.value==="answering";isIdle=()=>this._smartChatState.value==="idle";setSeen=()=>{this._badgeService.setSeen()};setUnseen=e=>{this._badgeService.setUnseen(e)};setInput=(e,t)=>{this._conversationService.setInput(e,t)};regenerateLast=async()=>{for(let e=this._logService.logs.length-1;e>=0;e--){const t=this._logService.logs[e];if(t.type==="ai-input"){this.setInput(t.log);break}}await this.send()};isWaitingForToolApproval=()=>{const e=this._logService.logs[this._logService.logs.length-1];return e?.type==="ai-tool-approval"&&e.needsApproval};disableLastToolApprovalMessage=()=>{if(!this.isWaitingForToolApproval())return;const e=this._logService.logs[this._logService.logs.length-1];e.type==="ai-tool-approval"&&(e.disabled=!0)};get badgeState(){return this._badgeService.badgeState}get input(){return this._conversationService.input}fixJson=async(e,t)=>{this._logService.clear(),this._logService.log({type:"ai-input",log:`here is my json code:
      ${e}
      And I got this error:`}),this._logService.log({type:"stderr",log:t}),this.setSeen(),this.setInput("Can you fix this JSON?"),await this.send()};askAboutError=async(e,t)=>{this._logService.clear(),this.setInput(["Fix the following error based on my logs:",...e.entries.map(s=>s.payload.text),`My current code is: ${t||"No code provided"}`].join(`
`)),await this.send()};fixIssueWithAI=async(e,t)=>{this._logService.clear(),this.setInput(["Fix the following issue in my code:",e.label,t.label].join(`
`)),await this.send()}}const Pe=new ie,Ue=oe("omniChat",()=>{const c=u(!0),e=u(!1),t=R.create(),s=j(),o=j(),n=(y,r,_)=>{if(!o.value)if(y==="console"){if(!r)throw new Error("Project ID is required for console chat");s.value=new Fe(r),o.value=new H(s.value,t,_)}else s.value=new Ee,o.value=new H(s.value,t,_)},a=()=>{e.value=!0},h=()=>{e.value=!1},d=()=>{c.value=!0,a()},l=()=>{c.value=!1,h()},p=()=>{c.value?l():d()},f=y=>{o.value?.setError(y)},v=()=>{o.value?.setError(null)},I=()=>o.value?.isIdle()??!0,i=A(()=>o.value?.hasError??null);return{isOpen:c,isInputFocused:e,focusInput:a,blurInput:h,open:d,close:l,toggle:p,controller:A(()=>o.value),repository:s,init:n,setError:f,clearError:v,isIdle:I,hasError:i}});export{O as B,xe as H,R as L,Pe as o,Ue as u};
//# sourceMappingURL=omniChatStore-BHKyaQfK.js.map
