var q=Object.defineProperty;var H=(n,e,t)=>e in n?q(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var p=(n,e,t)=>(H(n,typeof e!="symbol"?e+"":e,t),t);import{d as defineComponent,eL as i18nProvider,F as computed,E as reactive,b as openBlock,et as createElementBlock,e as createBaseVNode,eB as toDisplayString,u as unref,bh as withDirectives,eM as vModelText,eN as withKeys,ev as createCommentVNode,eC as pushScopeId,eD as popScopeId,t as _export_sfc,ao as createTextVNode,o as onMounted,f as createVNode,eO as createStaticVNode,bo as Fragment,a as resolveComponent,c as createBlock,dm as renderSlot,r as ref,w as withCtx,eJ as lodash,G as watch,J as onUnmounted,ex as normalizeClass,eP as StartWidget,eQ as EndWidget,eR as ErrorWidget,eA as renderList,eS as resolveDynamicComponent}from"./outputWidgets.c7dcc302.js";import{i as isUrl}from"./url.8333e91c.js";import{S as Storage}from"./storage.ee8fed7f.js";import{P as PubSub}from"./pubsub.d9e0718d.js";import{o}from"./jwt-decode.esm.74bd4619.js";import{S as SetttingsProvider}from"./index.2aefedce.js";import{t as thinrefresh,g as magicWand,i as info}from"./icons.b61c445b.js";import{L as LoadingIndicator}from"./CircularLoading.83865111.js";import{P as PlayerNavbar}from"./PlayerNavbar.3a83bbbd.js";import{S as Steps,A as ActionButton}from"./ActionButton.697988ef.js";import{W as WidgetsFrame}from"./WidgetsFrame.21e39de2.js";import"./index.ba8fce12.js";import"./index.f230dddd.js";import{C as Card}from"./Card.318fde53.js";import{a as Typography}from"./Text.52e1267a.js";(function(){try{var n=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[e]="37f5efe7-1770-4256-9b5b-aebe396b6a70",n._sentryDebugIdIdentifier="sentry-dbid-37f5efe7-1770-4256-9b5b-aebe396b6a70")}catch{}})();const DEFAULT_MAIN_COLOR="#414a58",DEFAULT_FORM_FONT_FAMILY="DM Sans";function runnerDTOtoData(n){var e,t,l,r,a,i,c,u,f,y,b,$,S,k,_;return{id:n.id,path:n.path,theme:(e=n.workspace.theme)!=null?e:"#FFFFFF",brandName:(t=n.workspace.brand_name)!=null?t:null,title:n.title,isLocal:(l=n.is_local)!=null?l:!1,startMessage:(r=n.start_message)!=null?r:null,endMessage:(a=n.end_message)!=null?a:null,errorMessage:(i=n.error_message)!=null?i:null,timeoutMessage:(c=n.timeout_message)!=null?c:null,startButtonText:(u=n.start_button_text)!=null?u:null,restartButtonText:(f=n.restart_button_text)!=null?f:null,logoUrl:n.workspace.logo_url,mainColor:(y=n.workspace.main_color)!=null?y:DEFAULT_MAIN_COLOR,fontFamily:(b=n.workspace.font_family)!=null?b:DEFAULT_FORM_FONT_FAMILY,autoStart:($=n.auto_start)!=null?$:!1,allowRestart:n.allow_restart,welcomeTitle:(S=n.welcome_title)!=null?S:null,runtimeType:"form",sidebar:(_=(k=n.workspace)==null?void 0:k.sidebar)!=null?_:[]}}async function getExecutionResourceFromPath(n){const e=await fetch(`/_pages/${n}`);if(e.status==404)return null;if(!e.ok)throw new Error(await e.text());const{form:t}=await e.json();return{form:t&&runnerDTOtoData(t)}}async function getRuntimeType(n){const e=await getExecutionResourceFromPath(n);if(e!=null&&e.form)return"forms";throw new Error("Invalid runtime")}function normalizePath(n){return n.startsWith("/")?n.slice(1):n}async function redirect(n,e,t,l={},r){if(isUrl(t)){const a=new URLSearchParams(l),i=new URL(t);i.search=a.toString(),window.location.href=i.toString()}else{const a=t.replace(/\/$/,""),i=r!=null?r:await getRuntimeType(a);if(n==="player")e.push({path:"/"+normalizePath(a),query:l});else if(n==="editor"&&i==="forms")e.push({name:"formEditor",params:{formPath:normalizePath(a)},query:l});else if(n==="preview"&&i==="forms")e.push({name:"formPreview",params:{formPath:normalizePath(a)},query:l});else throw new Error("Invalid routing")}}const closingStates=[WebSocket.CLOSING,WebSocket.CLOSED];function notify(n,e){const t=n[e.type];if(!t){console.warn("no callback for",e.type);return}t.forEach(l=>l(e))}const E=class{constructor(e){p(this,"ws",null);p(this,"callbacks",{"form-response":[],"execute-js:request":[],"execute-js:response":[],"form-update":[],start:[],"auth:saved-jwt":[],heartbeat:[],"user-event":[],"program:end":[],"files:changed":[],redirect:[],stderr:[],stdout:[],form:[],"stage-run:lock-failed":[],"auth:require-info":[],"auth:invalid-jwt":[],"auth:valid-jwt":[],"browser:disconnect":[],"browser:try-disconnect":[]});p(this,"onCloseCallbacks",[]);p(this,"heartbeatCounter",0);p(this,"heartbeatInterval");p(this,"params",{});this.formId=e}static create(e){return E._instance&&E._instance.close(),E._instance=new E(e),E._instance}get url(){return`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}/_socket?id=${encodeURIComponent(this.formId)}`}isConnected(){return this.ws?this.ws&&this.ws.readyState===this.ws.OPEN:!1}resetState(){this.close()}resetHeartbeatCounter(){this.heartbeatCounter=0}on(e,t){this.callbacks[e].push(t)}clearWSEvents(){!this.ws||(clearInterval(this.heartbeatInterval),this.ws.onclose=()=>{},this.ws.onerror=()=>{},this.ws.onmessage=()=>{})}async connect(e,t=1){if(!(t>3))return this.params=e!=null?e:this.params,new Promise(l=>{this.clearWSEvents(),this.ws=new WebSocket(this.url),this.ws.onopen=()=>{l(),this.resetHeartbeatCounter(),this.send({type:"start",params:this.params})};let r=!1;const a=()=>{r||(r=!0)};this.ws.onclose=i=>{if(i.code===1006||!i.wasClean)return a();clearInterval(this.heartbeatInterval),this.onCloseCallbacks.forEach(c=>c())},this.ws.onerror=()=>a(),this.ws.onmessage=i=>{const c=JSON.parse(i.data);notify(this.callbacks,c)},this.heartbeatInterval=setInterval(()=>{if(!(!this.ws||this.ws.readyState!==this.ws.OPEN)){if(this.heartbeatCounter++,this.heartbeatCounter>3)return this.ws.onclose=()=>{},clearInterval(this.heartbeatInterval),a();this.send({type:"heartbeat"})}},2e3)}).catch(()=>{this.connect(this.params,t+1)})}onClose(e){this.onCloseCallbacks.push(e)}close(){if(!this.ws){console.warn("no websocket to close");return}this.clearWSEvents(),this.ws.close()}async send(e){if(!this.ws){console.warn("no websocket to send");return}closingStates.includes(this.ws.readyState)&&await this.connect(),this.ws.send(JSON.stringify(e)),notify(this.callbacks,e)}};let RemoteBroker=E;p(RemoteBroker,"_instance");const P=class{constructor(e=new PubSub){this.pubsub=e}saveJWT(e){Storage.set(P.key,e),this.notify()}notify(){const e=this.getUser();this.pubsub.publish("authenticated",e)}getJWT(){return Storage.get(P.key)}getUser(){const e=this.getJWT();if(e)try{const t=o(e);if(t.exp&&t.exp>Date.now()/1e3)return{jwt:e,claims:t}}catch{console.warn("Invalid JWT")}return null}removeUser(){this.pubsub.publish("authenticated",null),Storage.remove(P.key)}};let UserManager=P;p(UserManager,"key","abstra:auth:jwt");const userManager=new UserManager,_withScopeId$1=n=>(pushScopeId("data-v-6f44f486"),n=n(),popScopeId(),n),_hoisted_1$7={class:"auth-info"},_hoisted_2$6={class:"auth-header"},_hoisted_3$4={class:"auth-label"},_hoisted_4$4={class:"description"},_hoisted_5$3=["onKeyup"],_hoisted_6$2={key:0,class:"span-error"},_hoisted_7$2=_withScopeId$1(()=>createBaseVNode("div",{class:"spacer"},null,-1)),_sfc_main$9=defineComponent({__name:"AuthInfo",props:{invalid:{type:Boolean}},emits:["sendAuthInfo"],setup(n,{emit:e}){const t=n,l={description:i18nProvider.translate("i18n_local_auth_info_description"),button:i18nProvider.translate("i18n_local_auth_info_authenticate")},r={description:i18nProvider.translate("i18n_auth_info_description"),button:i18nProvider.translate("i18n_auth_info_send_code")},a=computed(()=>{var u;return(u=SetttingsProvider.instance)!=null&&u.isLocal?l:r}),i=reactive({email:""}),c=()=>{e("sendAuthInfo",i)};return(u,f)=>(openBlock(),createElementBlock("div",_hoisted_1$7,[createBaseVNode("div",_hoisted_2$6,[createBaseVNode("div",_hoisted_3$4,toDisplayString(unref(i18nProvider).translate("i18n_auth_validate_your_email")),1),createBaseVNode("div",_hoisted_4$4,toDisplayString(a.value.description),1)]),withDirectives(createBaseVNode("input",{"onUpdate:modelValue":f[0]||(f[0]=y=>i.email=y),type:"email",placeholder:"Email address",class:"input email-input",onKeyup:withKeys(c,["enter"])},null,40,_hoisted_5$3),[[vModelText,i.email]]),t.invalid?(openBlock(),createElementBlock("span",_hoisted_6$2,toDisplayString(unref(i18nProvider).translate("i18n_auth_info_invalid_email")),1)):createCommentVNode("",!0),_hoisted_7$2,createBaseVNode("button",{class:"next-button",onClick:c},toDisplayString(a.value.button),1)]))}}),AuthInfo_vue_vue_type_style_index_0_scoped_6f44f486_lang="",AuthInfo=_export_sfc(_sfc_main$9,[["__scopeId","data-v-6f44f486"]]),_withScopeId=n=>(pushScopeId("data-v-5cb011c0"),n=n(),popScopeId(),n),_hoisted_1$6={class:"auth-token"},_hoisted_2$5={class:"auth-label"},_hoisted_3$3=["onKeyup"],_hoisted_4$3={key:0,class:"span-error"},_hoisted_5$2={key:1,class:"span-error"},_hoisted_6$1=_withScopeId(()=>createBaseVNode("div",{class:"spacer"},null,-1)),_hoisted_7$1={class:"button-icon",viewBox:"0 0 24 24"},_hoisted_8$1=["d"],_hoisted_9$1={class:"footer"},_sfc_main$8=defineComponent({__name:"AuthToken",props:{email:{},invalid:{type:Boolean},expired:{type:Boolean}},emits:["sendToken","restartAuth","resendToken"],setup(n,{emit:e}){const t=reactive({token:""}),l=()=>{e("restartAuth")},r=()=>{e("resendToken")},a=()=>{e("sendToken",t.token)};return(i,c)=>(openBlock(),createElementBlock("div",_hoisted_1$6,[createBaseVNode("div",_hoisted_2$5,toDisplayString(unref(i18nProvider).translate("i18n_auth_token_label",{email:i.email})),1),withDirectives(createBaseVNode("input",{"onUpdate:modelValue":c[0]||(c[0]=u=>t.token=u),type:"text",placeholder:"Type your verification code",class:"input",onKeyup:withKeys(a,["enter"])},null,40,_hoisted_3$3),[[vModelText,t.token]]),i.expired?(openBlock(),createElementBlock("span",_hoisted_4$3,toDisplayString(unref(i18nProvider).translate("i18n_auth_token_expired")),1)):createCommentVNode("",!0),i.invalid?(openBlock(),createElementBlock("span",_hoisted_5$2,toDisplayString(unref(i18nProvider).translate("i18n_auth_token_invalid")),1)):createCommentVNode("",!0),_hoisted_6$1,createBaseVNode("button",{class:"next-button",onClick:a},toDisplayString(unref(i18nProvider).translate("i18n_auth_token_verify_email")),1),createBaseVNode("button",{class:"secondary-button back",onClick:l},[(openBlock(),createElementBlock("svg",_hoisted_7$1,[createBaseVNode("path",{d:unref(thinrefresh)},null,8,_hoisted_8$1)])),createTextVNode(" "+toDisplayString(unref(i18nProvider).translate("i18n_auth_token_try_again")),1)]),createBaseVNode("button",{class:"secondary-button back",onClick:r},toDisplayString(unref(i18nProvider).translate("i18n_auth_token_resend_email")),1),createBaseVNode("div",_hoisted_9$1,toDisplayString(unref(i18nProvider).translate("i18n_auth_token_footer_alternative_email")),1)]))}}),AuthToken_vue_vue_type_style_index_0_scoped_5cb011c0_lang="",AuthToken=_export_sfc(_sfc_main$8,[["__scopeId","data-v-5cb011c0"]]);class AuthnUserProvider{async authenticate(e){try{const t=await fetch("/_auth/authenticate",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({email:e})});if(!t.ok)throw new Error(await t.text());return null}catch(t){return t.message}}async verify(e,t){const l=await fetch("/_auth/verify",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({email:e,token:t})});if(!l.ok)return null;const r=await l.json();return userManager.saveJWT(r.jwt),userManager.getUser()}}const _hoisted_1$5={key:0,class:"form"},_hoisted_2$4={class:"form-wrapper"},_hoisted_3$2={class:"loading"},_hoisted_4$2={key:1,class:"form"},_hoisted_5$1={class:"form-wrapper"},_hoisted_6={class:"widget"},_hoisted_7={key:2,class:"form"},_hoisted_8={class:"form-wrapper"},_hoisted_9={class:"widget"},_hoisted_10={key:3,class:"form"},_hoisted_11={class:"form-wrapper"},_hoisted_12={class:"loading"},_sfc_main$7=defineComponent({__name:"Passwordless",emits:["done"],setup(n,{emit:e}){const t=reactive({stage:"collect-info",userProvider:null,invalid:!1,token:null,info:null});onMounted(()=>{t.userProvider=new AuthnUserProvider});const l=async c=>{if(!t.userProvider)return;t.info=c,t.stage="loading";const u=await t.userProvider.authenticate(c.email);t.invalid=!!u,u?t.stage="collect-info":t.stage="collect-token"},r=async c=>{var u;if(!(!t.userProvider||!((u=t.info)!=null&&u.email))){t.token=c,t.stage="loading";try{const f=await t.userProvider.verify(t.info.email,t.token);if(!f)throw new Error("no user");e("done",f),t.stage="done"}catch{t.invalid=!0,t.stage="collect-token"}}},a=()=>{t.info&&l(t.info)},i=()=>{t.stage="collect-info",t.info=null,t.token=null,t.invalid=!1};return(c,u)=>{var f,y;return t.userProvider?t.stage==="collect-info"?(openBlock(),createElementBlock("div",_hoisted_4$2,[createBaseVNode("div",_hoisted_5$1,[createBaseVNode("div",_hoisted_6,[createVNode(AuthInfo,{invalid:t.invalid,onSendAuthInfo:l},null,8,["invalid"])])])])):t.stage==="collect-token"?(openBlock(),createElementBlock("div",_hoisted_7,[createBaseVNode("div",_hoisted_8,[createBaseVNode("div",_hoisted_9,[createVNode(AuthToken,{invalid:t.invalid,email:(y=(f=t.info)==null?void 0:f.email)!=null?y:"",onSendToken:r,onResendToken:a,onRestartAuth:i},null,8,["invalid","email"])])])])):(openBlock(),createElementBlock("div",_hoisted_10,[createBaseVNode("div",_hoisted_11,[createBaseVNode("div",_hoisted_12,[createVNode(LoadingIndicator)])])])):(openBlock(),createElementBlock("div",_hoisted_1$5,[createBaseVNode("div",_hoisted_2$4,[createBaseVNode("div",_hoisted_3$2,[createVNode(LoadingIndicator)])])]))}}}),Passwordless_vue_vue_type_style_index_0_scoped_d468d037_lang="",Passwordless=_export_sfc(_sfc_main$7,[["__scopeId","data-v-d468d037"]]),_hoisted_1$4=["href"],_hoisted_2$3=createStaticVNode('<svg width="44" height="32" viewBox="0 0 256 256" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-91fa59aa><g clip-path="url(#clip0_405_116214)" data-v-91fa59aa><path d="M188.697 133.808L172.68 148.263C172.68 148.263 216.044 185.966 217.997 187.72C219.951 189.475 234.405 174.566 232.843 173.266C231.28 171.966 188.697 133.808 188.697 133.808Z" fill="#E36C7C" data-v-91fa59aa></path><path d="M188.697 133.808L172.68 148.263C172.68 148.263 216.044 185.966 217.997 187.72C219.951 189.475 234.405 174.566 232.843 173.266C231.28 171.966 188.697 133.808 188.697 133.808Z" fill="url(#paint0_linear_405_116214)" data-v-91fa59aa></path><path d="M218.387 91.2249L176.195 127.557L173.851 129.51C151.192 149.849 149.853 152.309 141.642 152.584L141.584 152.586C139.612 152.652 135.357 152.795 131.875 149.849C126.797 145.552 120.155 140.083 117.03 137.348C115.34 135.869 112.465 133.039 109.998 131.097C107.902 129.448 106.482 127.581 104.919 127.581C103.357 127.581 100.622 129.925 96.3246 133.832C92.0272 137.739 82.6511 146.333 82.6511 146.333L65.0712 161.569C65.0712 161.569 42.5857 180.688 36.7256 185.376C30.8656 190.064 16.5797 175.69 21.4895 171.703C21.9628 171.23 26.2429 167.755 29.7179 164.915C32.2165 162.84 34.2084 161.179 34.2084 161.179C34.9897 160.397 66.2433 133.051 66.2433 133.051L87.723 114.573C87.723 114.573 95.9339 106.094 105.701 106.094C108.826 106.094 112.83 106.485 126.015 118.205C129.531 121.33 131.485 122.542 135.782 126.409C137.345 127.816 139.852 130.316 140.861 130.316C141.882 130.316 143.986 128.363 145.549 127.023C145.549 127.023 195.897 84.4149 202.37 77.9421C207.839 72.4726 223.075 86.9273 218.387 91.2249Z" fill="url(#paint1_linear_405_116214)" data-v-91fa59aa></path><path d="M33.238 67.1372C31.2846 68.6564 23.9305 75.1737 22.2992 76.9039C19.3366 80.0417 21.3638 81.3905 25.6611 84.9065C29.9585 88.4225 57.8962 112.712 64.8542 118.963L79.9642 105.221L41.288 71.2331C36.5999 67.1372 35.1913 65.6179 33.238 67.1372Z" fill="url(#paint2_linear_405_116214)" data-v-91fa59aa></path></g><defs data-v-91fa59aa><linearGradient id="paint0_linear_405_116214" x1="172.68" y1="133.808" x2="183.059" y2="196.169" gradientUnits="userSpaceOnUse" data-v-91fa59aa><stop offset="0.114583" stop-color="#FF98A6" data-v-91fa59aa></stop><stop offset="1" stop-color="#E36C7C" data-v-91fa59aa></stop></linearGradient><linearGradient id="paint1_linear_405_116214" x1="219.271" y1="186.305" x2="206.115" y2="57.7298" gradientUnits="userSpaceOnUse" data-v-91fa59aa><stop stop-color="#E36C7C" data-v-91fa59aa></stop><stop offset="0.859375" stop-color="#FF98A6" data-v-91fa59aa></stop></linearGradient><linearGradient id="paint2_linear_405_116214" x1="20.8984" y1="66.56" x2="30.8589" y2="127.049" gradientUnits="userSpaceOnUse" data-v-91fa59aa><stop stop-color="#E36C7C" data-v-91fa59aa></stop><stop offset="0.859375" stop-color="#FF98A6" data-v-91fa59aa></stop></linearGradient><clipPath id="clip0_405_116214" data-v-91fa59aa><rect width="256" height="256" fill="white" data-v-91fa59aa></rect></clipPath></defs></svg><b data-v-91fa59aa>Abstra Cloud</b>',2),_sfc_main$6=defineComponent({__name:"Watermark",props:{runtime:{}},setup(n){var l;const e=window.location.hostname.split(".")[0],t=(l=SetttingsProvider.instance)==null?void 0:l.showWatermark;return(r,a)=>unref(t)?(openBlock(),createElementBlock("a",{key:0,href:`https://www.abstra.io/forms?utm_source=abstra_pages&utm_medium=badge&utm_campaign=${r.runtime.id}&origin_subdomain=${unref(e)}`,target:"_blank",class:"watermark"},[createTextVNode(toDisplayString(unref(i18nProvider).translate("i18n_watermark_text"))+" ",1),_hoisted_2$3],8,_hoisted_1$4)):createCommentVNode("",!0)}}),Watermark_vue_vue_type_style_index_0_scoped_91fa59aa_lang="",Watermark=_export_sfc(_sfc_main$6,[["__scopeId","data-v-91fa59aa"]]),_sfc_main$5=defineComponent({__name:"RuntimeCommons",props:{runtime:{},fullWidth:{type:Boolean},forceResponsivity:{},userEmail:{},stepsInfo:{}},emits:["navigate","logout"],setup(n,{expose:e,emit:t}){const l=r=>t("navigate",r);return e({open}),(r,a)=>(openBlock(),createElementBlock(Fragment,null,[createBaseVNode("header",null,[createVNode(PlayerNavbar,{runtime:r.runtime,"user-email":r.userEmail,"force-responsivity":r.forceResponsivity,onLogout:a[0]||(a[0]=i=>t("logout")),onNavigate:l},null,8,["runtime","user-email","force-responsivity"])]),createVNode(Steps,{class:"steps","steps-info":r.stepsInfo},null,8,["steps-info"]),createVNode(Watermark,{class:"watermark",runtime:r.runtime},null,8,["runtime"])],64))}}),RuntimeCommons_vue_vue_type_style_index_0_scoped_b9aa0bc8_lang="",RuntimeCommons=_export_sfc(_sfc_main$5,[["__scopeId","data-v-b9aa0bc8"]]);function isInputWidget(n){return"key"in n&&"value"in n&&"errors"in n}const _hoisted_1$3={key:0,class:"text"},_hoisted_2$2={key:1,class:"text"},_sfc_main$4=defineComponent({__name:"component",props:{status:{}},setup(n){return(e,t)=>e.status==="running"?(openBlock(),createElementBlock("div",_hoisted_1$3," This form is already being filled ")):(openBlock(),createElementBlock("div",_hoisted_2$2,"This form was already filled"))}}),executeCode=($context,code)=>{let evaluatedCode;try{evaluatedCode=eval(code)}catch(n){throw console.error(`[Error: execute_js]: ${n.message}, context: ${$context}`),n}return isSerializable(evaluatedCode)?evaluatedCode:null};async function executeJs(n){return{type:"execute-js:response",value:await executeCode(n.context,n.code)}}const isSerializable=n=>{try{return JSON.stringify(n),!0}catch{return!1}};class BrokerMessageHandler{constructor(e,t){p(this,"showEndWidget",!0);p(this,"reactivePollInterval",null);p(this,"seq",0);p(this,"programEnded",!1);p(this,"setErrorPageState",()=>{this.newPageState({widgets:[{type:"error"}],actions:[],fullWidth:!1,steps:null})});p(this,"setEndPageState",()=>{!this.showEndWidget||this.newPageState({widgets:[{type:"end"}],actions:this.pageActionFactory.restartAction,fullWidth:!1,steps:null})});p(this,"setLockFailedPageState",e=>{this.newPageState({widgets:[{type:"lock-failed",status:e}],actions:[],fullWidth:!1,steps:null})});p(this,"sendUser",e=>{this.broker.send({type:"auth:saved-jwt",jwt:e.jwt})});p(this,"sendBrowserTryDisconnect",()=>{this.broker.send({type:"browser:try-disconnect"})});p(this,"updatePageStateListener",()=>{});p(this,"newPageStateListener",()=>{});p(this,"onReactivePollListener",()=>{});p(this,"onErrorListener",()=>{});p(this,"onExitListener",()=>{});p(this,"onStartAuthListener");p(this,"onEndAuthListener");p(this,"onBadAuthListener");this.broker=e,this.pageActionFactory=t}static create(e,t,l){const r=new BrokerMessageHandler(e,t);return r.broker.onClose(()=>{r.programEnded||(r.setErrorPageState(),r.error("Connection with service closed before program ended"))}),r.broker.on("form",({widgets:a,actions:i,buttonText:c,endProgram:u,reactivePollingInterval:f,steps:y})=>{r.newPageState({widgets:a,actions:r.pageActionFactory.fromPageActionsDto(c?[c]:i!=null?i:[]),fullWidth:a.some(b=>"fullWidth"in b&&b.fullWidth),steps:y}),f&&(r.reactivePollInterval=setInterval(r.onReactivePollListener,f*1e3)),u&&(r.showEndWidget=!1,r.broker.send({type:"form-response",payload:{},secrets:[],seq:++r.seq}))}),r.broker.on("execute-js:request",async a=>{const i=await executeJs(a);r.broker.send(i)}),r.broker.on("auth:require-info",a=>{r.newPageState({widgets:[],actions:[],fullWidth:!1,steps:null}),r.onStartAuthListener&&r.onStartAuthListener(a)}),r.broker.on("auth:valid-jwt",()=>{r.onEndAuthListener&&r.onEndAuthListener()}),r.broker.on("auth:invalid-jwt",()=>{console.warn("invalid jwt"),r.onBadAuthListener&&r.onBadAuthListener()}),r.broker.on("program:end",a=>{if(r.programEnded=!0,a.exitStatus!=="SUCCESS"||a.exception){r.setErrorPageState(),r.error(a);return}r.setEndPageState(),r.exit(a)}),r.broker.on("stage-run:lock-failed",a=>{r.programEnded=!0,r.setLockFailedPageState(a.status)}),r.broker.on("redirect",a=>{l.onRedirect(a.url,a.queryParams)}),r.broker.on("heartbeat",()=>{r.broker.resetHeartbeatCounter()}),r.broker.on("form-update",({widgets:a,validation:i,seq:c})=>{c===r.seq&&r.updatePageState({widgets:a,error:{message:i.message,status:i.status},fullWidth:a.some(u=>"fullWidth"in u&&u.fullWidth)})}),r}handleAction(e,t,l){this.reactivePollInterval&&clearInterval(this.reactivePollInterval);const r={};Object.entries(e).forEach(([a,i])=>{r[a]=i}),this.broker.send({type:"form-response",payload:r,action:t==null?void 0:t.name,secrets:l,seq:++this.seq})}sendUserEvent(e,t){const l={};Object.entries(e).forEach(([r,a])=>{l[r]=a}),this.broker.send({type:"user-event",payload:l,secrets:t,seq:++this.seq})}init(e){this.broker.resetState(),this.newPageState({widgets:[],actions:[],fullWidth:!1,steps:null}),this.broker.connect(e!=null?e:{})}updatePageState(e){this.updatePageStateListener(e)}listenToPageStateUpdate(e){this.updatePageStateListener=e}onNewPageState(e){this.newPageStateListener=e}newPageState(e){this.newPageStateListener(e)}onReactivePoll(e){this.onReactivePollListener=e}error(e){this.reactivePollInterval&&clearInterval(this.reactivePollInterval),this.onErrorListener(e)}onError(e){this.onErrorListener=e}exit(e){this.reactivePollInterval&&clearInterval(this.reactivePollInterval),this.onExitListener(e)}onExit(e){this.onExitListener=e}onStartAuth(e){this.onStartAuthListener=e}onEndAuth(e){this.onEndAuthListener=e}onBadAuth(e){this.onBadAuthListener=e}}class PageAction{constructor(e,t){p(this,"element",null);this.name=e,this.isDefault=t}static fromDto(e){return typeof e=="string"?new PageAction(e,!1):new PageAction(e.name,e.is_default)}setElement(e){e instanceof HTMLElement&&(this.element=e)}get isFocused(){return this.element===document.activeElement}focusOnButton(){var e;(e=this.element)==null||e.focus()}addKeydownListener(e){var t;(t=this.element)==null||t.addEventListener("keydown",e)}}class PageActionsFactory{constructor(e){this.form=e}static from(e){return new PageActionsFactory(e)}get startAction(){return[PageAction.fromDto(this.form.startButtonText||"Start")]}get restartAction(){const e=this.form.restartButtonText||"Restart";return this.form.allowRestart?[PageAction.fromDto(e)]:[]}fromPageActionsDto(e){return e.filter(t=>!!t).map(t=>PageAction.fromDto(t))}}const _hoisted_1$2={class:"outline-button"},_sfc_main$3=defineComponent({__name:"OutlineButton",props:{iconPath:{},noShadow:{type:Boolean},status:{}},setup(n){return(e,t)=>{const l=resolveComponent("icon");return openBlock(),createElementBlock("button",_hoisted_1$2,[e.iconPath?(openBlock(),createBlock(l,{key:0,path:e.iconPath,fill:"#fff",class:"icon"},null,8,["path"])):createCommentVNode("",!0),renderSlot(e.$slots,"default",{},void 0,!0)])}}}),OutlineButton_vue_vue_type_style_index_0_scoped_56f62044_lang="",OutlineButton=_export_sfc(_sfc_main$3,[["__scopeId","data-v-56f62044"]]),_sfc_main$2=defineComponent({__name:"FormAutoFill",props:{broker:{},form:{}},setup(n){const e=n,t=window.__runs||(window.__runs={previous:[],current:[]});e.broker.on("start",()=>{t.previous=t.current,t.current=[]});const l=ref(null);function r(){for(const c in t.current){const u=t.previous[c],f=t.current[c];if(!u||u.type!==f.type||u.type=="form"&&!lodash.exports.isEqual(u.widgets,f.widgets)||u.type=="form-response"&&!lodash.exports.isEqual(u.payload,f.payload))return null}const i=t.previous[t.current.length];if((i==null?void 0:i.type)!=="form-response")return null;l.value=i}function a(){const i=l.value;i&&e.broker.send(i)}return e.broker.on("form",i=>{t.current.push(i),r()}),e.broker.on("form-response",i=>{t.current.push(i),l.value=null}),(i,c)=>l.value?(openBlock(),createBlock(OutlineButton,{key:0,"icon-path":unref(magicWand),class:"form-auto-fill-btn",onClick:a},{default:withCtx(()=>[createTextVNode(" Repeat last answer ")]),_:1},8,["icon-path"])):createCommentVNode("",!0)}}),FormAutoFill_vue_vue_type_style_index_0_scoped_e7cd5d42_lang="",FormAutoFill=_export_sfc(_sfc_main$2,[["__scopeId","data-v-e7cd5d42"]]),_hoisted_1$1={key:0,class:"hint"},_hoisted_2$1={class:"icon",viewBox:"0 0 24 24",style:{width:"20px",height:"20px"}},_hoisted_3$1=["d"],_hoisted_4$1={class:"hint-content"},_sfc_main$1=defineComponent({__name:"WidgetHint",props:{hint:{}},setup(n){return(e,t)=>e.hint?(openBlock(),createElementBlock("div",_hoisted_1$1,[(openBlock(),createElementBlock("svg",_hoisted_2$1,[createBaseVNode("path",{d:unref(info)},null,8,_hoisted_3$1)])),createBaseVNode("div",_hoisted_4$1,toDisplayString(e.hint),1)])):createCommentVNode("",!0)}}),WidgetHint_vue_vue_type_style_index_0_scoped_9a7a836d_lang="",WidgetHint=_export_sfc(_sfc_main$1,[["__scopeId","data-v-9a7a836d"]]),_hoisted_1={key:0,class:"form-wrapper"},_hoisted_2=["id"],_hoisted_3={key:5,class:"span-error"},_hoisted_4={key:1,class:"loading-wrapper"},_hoisted_5={class:"buttons"},_sfc_main=defineComponent({__name:"FormRunner",props:{form:{},params:{},isPreview:{type:Boolean},enableAutoFocus:{type:Boolean},broker:{},disabled:{type:Boolean}},emits:["log","error","exit","navigate","logout","start","redirect"],setup(n,{expose:e,emit:t}){const l=n,r=[],a=ref({}),i=ref({}),c=ref({}),u=ref(null),f=(s,d)=>{r[d]=s},y=ref(null),b=computed(()=>PageActionsFactory.from(l.form)),$=s=>t("navigate",s),S=()=>{_.value={widgets:[{type:"start"}],actions:b.value.startAction,fullWidth:!1,steps:null}};watch(()=>l.form,()=>{var s;((s=_.value.widgets[0])==null?void 0:s.type)=="start"&&S()});const k=reactive({user:null,authenticating:!1}),_=ref({widgets:[],fullWidth:!1,actions:[],steps:null}),C=ref("idle"),L=computed(()=>_.value.widgets.filter(s=>"secret"in s).reduce((s,d)=>"key"in d&&"secret"in d?[...s,{key:d.key,secret:d.secret}]:s,[]));x();function x(){k.user=userManager.getUser()}const T=()=>{userManager.removeUser(),x(),t("logout")},g=BrokerMessageHandler.create(l.broker,b.value,{onRedirect(s,d){t("redirect",s,d)}}),I=ref(null);g.onError(s=>{t("error",s),C.value="error"}),g.onExit(s=>{t("exit",s),C.value="over"}),g.onStartAuth(s=>{s.refresh?(userManager.removeUser(),x(),k.authenticating=!0):k.user?g.sendUser(k.user):k.authenticating=!0}),g.onEndAuth(()=>{k.authenticating=!1}),g.onBadAuth(()=>{userManager.removeUser(),k.user=null,k.authenticating=!0}),g.onReactivePoll(()=>{g.sendUserEvent(a.value,L.value)});const D=s=>{k.user=s,g.sendUser(s)};g.onNewPageState(s=>{u.value=null,_.value=s;const d={},m={};_.value.widgets.forEach(v=>{isInputWidget(v)&&(d[v.key]=v.value,m[v.key]=v.errors)}),a.value=d,i.value=m,c.value={},I.value&&(I.value.scrollTop=0)}),g.listenToPageStateUpdate(s=>{u.value=null,_.value={..._.value,...s};const d={},m={};_.value.widgets.forEach(v=>{isInputWidget(v)&&(d[v.key]=v.value,m[v.key]=v.errors)}),a.value=d,i.value=m});const V=s=>{var d;if(!(C.value!=="running"||l.isPreview||!((d=window.should_ask_before_leave)==null||d)))return g.sendBrowserTryDisconnect(),s.preventDefault(),s.returnValue="Are you sure?",""};onMounted(async()=>{window.addEventListener("beforeunload",V),S(),l.form.autoStart&&A()}),onUnmounted(()=>{l.broker.close(),window.removeEventListener("beforeunload",V)});const U=()=>{r.forEach(s=>{!s||!("setErrors"in s)||typeof s.setErrors!="function"||s.setErrors()})},F=computed(()=>{var s;return((s=_.value.error)==null?void 0:s.status)===!1}),R=s=>!Object.values(c.value).some(m=>m.length>0)&&!F.value?!1:s!=="i18n_back_action",M=async s=>{if(C.value!=="running")return A();U(),!(Object.values(c.value).some(m=>m.length>0)&&(s==null?void 0:s.name)!=="i18n_back_action")&&(g.handleAction(a.value,s,L.value),u.value=s!=null?s:null)},A=async()=>{g.init(l.params),C.value="running",t("start")},O=async()=>{S(),l.broker.close(),C.value="idle",t("exit",{})};function j(s){var d;return isInputWidget(s)&&(d=a.value[s.key])!=null?d:null}function W(s){var h;if(!isInputWidget(s))return[];const d=s.errors.map(w=>i18nProvider.translateIfFound(w,s)),v=((h=c.value[s.key])!=null?h:[]).map(w=>i18nProvider.translateIfFound(w,s));return[...d,...v]}function z(s,d){if(!isInputWidget(s))return;const m={...a.value};m[s.key]=d,a.value=m,g.sendUserEvent(a.value)}function J(s,d){if(!isInputWidget(s))return;const m={...c.value};m[s.key]=d,c.value=m}return e({run:A,exit:O,formState:C}),(s,d)=>(openBlock(),createBlock(WidgetsFrame,{class:normalizeClass([{preview:s.isPreview},"runner"]),"main-color":s.form.mainColor,theme:s.form.theme,"font-family":s.form.fontFamily,runtime:"form"},{default:withCtx(()=>{var m,v;return[s.disabled?(openBlock(),createBlock(unref(Card),{key:0,class:"unsaved-changes"},{default:withCtx(()=>[createVNode(unref(Typography),{style:{"font-size":"18px","font-weight":"500"}},{default:withCtx(()=>[createTextVNode("You have unsaved changes")]),_:1}),createVNode(unref(Typography),{style:{"margin-bottom":"18px"}},{default:withCtx(()=>[createTextVNode("Please save to run the preview")]),_:1})]),_:1})):createCommentVNode("",!0),s.isPreview?(openBlock(),createBlock(FormAutoFill,{key:1,class:"auto-fill-btn",broker:s.broker,form:s.form,style:{"z-index":1}},null,8,["broker","form"])):createCommentVNode("",!0),createVNode(RuntimeCommons,{ref_key:"runtimeCommonsRef",ref:y,runtime:s.form,"full-width":_.value.fullWidth,"steps-info":_.value.steps,"user-email":(m=k.user)==null?void 0:m.claims.email,onLogout:T,onNavigate:$},null,8,["runtime","full-width","steps-info","user-email"]),createBaseVNode("main",{ref_key:"mainContainer",ref:I,class:normalizeClass([{disabled:s.disabled}])},[k.authenticating?(openBlock(),createBlock(Passwordless,{key:0,class:"form-auth",onDone:D})):(openBlock(),createElementBlock("div",{key:1,class:normalizeClass(["form",{"full-width":_.value.fullWidth}])},[_.value.widgets.length>0?(openBlock(),createElementBlock("div",_hoisted_1,[_.value.widgets[0].type=="start"?(openBlock(),createBlock(StartWidget,{key:0,form:s.form},null,8,["form"])):_.value.widgets[0].type=="end"?(openBlock(),createBlock(EndWidget,{key:1,"end-message":s.form.endMessage},null,8,["end-message"])):_.value.widgets[0].type=="error"?(openBlock(),createBlock(ErrorWidget,{key:2,"error-message":s.form.errorMessage},null,8,["error-message"])):_.value.widgets[0].type=="lock-failed"?(openBlock(),createBlock(_sfc_main$4,{key:3,status:_.value.widgets[0].status},null,8,["status"])):(openBlock(!0),createElementBlock(Fragment,{key:4},renderList(_.value.widgets,(h,w)=>{var N;return openBlock(),createElementBlock("div",{id:h.type+w,key:(N=h.key)!=null?N:h.type+w,class:"widget"},[(openBlock(),createBlock(resolveDynamicComponent(h.type),{ref_for:!0,ref:B=>f(B,w),value:j(h),errors:W(h),"user-props":h,runtime:"form","onUpdate:value":B=>z(h,B),"onUpdate:errors":B=>J(h,B)},null,40,["value","errors","user-props","onUpdate:value","onUpdate:errors"])),createVNode(WidgetHint,{hint:"hint"in h?h.hint:null},null,8,["hint"]),(openBlock(!0),createElementBlock(Fragment,null,renderList(W(h),B=>(openBlock(),createElementBlock("span",{key:B,class:"span-error"},toDisplayString(B),1))),128))],8,_hoisted_2)}),128)),F.value?(openBlock(),createElementBlock("span",_hoisted_3,toDisplayString(((v=_.value.error)==null?void 0:v.message)||unref(i18nProvider).translateIfFound("i18n_generic_validation_error")),1)):createCommentVNode("",!0)])):(openBlock(),createElementBlock("div",_hoisted_4,[createVNode(LoadingIndicator)])),createBaseVNode("div",_hoisted_5,[(openBlock(!0),createElementBlock(Fragment,null,renderList(_.value.actions,h=>{var w;return openBlock(),createBlock(ActionButton,{key:h.name,disabled:R(h.name),loading:((w=u.value)==null?void 0:w.name)==h.name,"display-name":unref(i18nProvider).translateIfFound(h.name),action:h,onClick:N=>M(h)},null,8,["disabled","loading","display-name","action","onClick"])}),128))])],2))],2)]}),_:1},8,["class","main-color","theme","font-family"]))}}),FormRunner_vue_vue_type_style_index_0_scoped_478c314c_lang="",FormRunner=_export_sfc(_sfc_main,[["__scopeId","data-v-478c314c"]]);export{FormRunner as F,RemoteBroker as R,getExecutionResourceFromPath as g,redirect as r};
//# sourceMappingURL=FormRunner.ea2b0ffe.js.map
