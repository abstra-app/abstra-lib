var O=Object.defineProperty;var j=(o,e,t)=>e in o?O(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var d=(o,e,t)=>(j(o,typeof e!="symbol"?e+"":e,t),t);import{d as defineComponent,eN as i18nProvider,G as computed,F as reactive,b as openBlock,ev as createElementBlock,e as createBaseVNode,eD as toDisplayString,u as unref,bj as withDirectives,eO as vModelText,eP as withKeys,ex as createCommentVNode,eE as pushScopeId,eF as popScopeId,v as _export_sfc,aq as createTextVNode,o as onMounted,f as createVNode,eQ as createStaticVNode,bq as Fragment,a as resolveComponent,c as createBlock,ds as renderSlot,r as ref,w as withCtx,eK as lodash,H as watch,K as onUnmounted,ez as normalizeClass,eR as StartWidget,eS as EndWidget,eT as ErrorWidget,eC as renderList,eU as resolveDynamicComponent}from"./outputWidgets.7bf30641.js";import{i as isUrl}from"./url.fb476188.js";import{A as AuthnUserProvider,S as SetttingsProvider,b as userManager}from"./index.09993339.js";import{t as thinrefresh,d as magicWand,i as info}from"./icons.0dd46489.js";import{L as LoadingIndicator}from"./CircularLoading.9152615d.js";import{P as PlayerNavbar}from"./PlayerNavbar.20995956.js";import{S as Steps,_ as _sfc_main$a}from"./ActionButton.vue_vue_type_script_setup_true_lang.ecb52a16.js";import{W as WidgetsFrame}from"./WidgetsFrame.e2f36696.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[e]="0e2dbd68-5092-4747-9a25-0f8219b8f09e",o._sentryDebugIdIdentifier="sentry-dbid-0e2dbd68-5092-4747-9a25-0f8219b8f09e")}catch{}})();const DEFAULT_MAIN_COLOR="#414a58",DEFAULT_FORM_FONT_FAMILY="DM Sans";function runnerDTOtoData(o){var e,t,i,n,s,a,l,c,p,v,y,P,E,k,_;return{id:o.id,path:o.path,theme:(e=o.workspace.theme)!=null?e:"#FFFFFF",brandName:(t=o.workspace.brand_name)!=null?t:null,title:o.title,isLocal:(i=o.is_local)!=null?i:!1,startMessage:(n=o.start_message)!=null?n:null,endMessage:(s=o.end_message)!=null?s:null,errorMessage:(a=o.error_message)!=null?a:null,timeoutMessage:(l=o.timeout_message)!=null?l:null,startButtonText:(c=o.start_button_text)!=null?c:null,restartButtonText:(p=o.restart_button_text)!=null?p:null,logoUrl:o.workspace.logo_url,mainColor:(v=o.workspace.main_color)!=null?v:DEFAULT_MAIN_COLOR,fontFamily:(y=o.workspace.font_family)!=null?y:DEFAULT_FORM_FONT_FAMILY,autoStart:(P=o.auto_start)!=null?P:!1,allowRestart:o.allow_restart,welcomeTitle:(E=o.welcome_title)!=null?E:null,runtimeType:"form",sidebar:(_=(k=o.workspace)==null?void 0:k.sidebar)!=null?_:[]}}async function getExecutionResourceFromPath(o){const e=await fetch(`/_pages/${o}`);if(e.status==404)return null;if(!e.ok)throw new Error(await e.text());const{form:t}=await e.json();return{form:t&&runnerDTOtoData(t)}}async function getRuntimeType(o){const e=await getExecutionResourceFromPath(o);if(e!=null&&e.form)return"forms";throw new Error("Invalid runtime")}function normalizePath(o){return o.startsWith("/")?o.slice(1):o}async function redirect(o,e,t,i={},n){if(isUrl(t)){const s=new URLSearchParams(i),a=new URL(t);a.search=s.toString(),window.location.href=a.toString()}else{const s=t.replace(/\/$/,""),a=n!=null?n:await getRuntimeType(s);if(o==="player")e.push({path:"/"+normalizePath(s),query:i});else if(o==="editor"&&a==="forms")e.push({name:"formEditor",params:{formPath:normalizePath(s)},query:i});else if(o==="preview"&&a==="forms")e.push({name:"formPreview",params:{formPath:normalizePath(s)},query:i});else throw new Error("Invalid routing")}}const closingStates=[WebSocket.CLOSING,WebSocket.CLOSED];function notify(o,e){const t=o[e.type];if(!t){console.warn("no callback for",e.type);return}t.forEach(i=>i(e))}const b=class{constructor(e){d(this,"ws",null);d(this,"callbacks",{"form-response":[],"execute-js:request":[],"execute-js:response":[],"form-update":[],start:[],"auth:saved-jwt":[],heartbeat:[],"user-event":[],"program:end":[],"files:changed":[],redirect:[],stderr:[],stdout:[],form:[],"stage-run:lock-failed":[],"auth:require-info":[],"auth:invalid-jwt":[],"auth:valid-jwt":[],"browser:disconnect":[],"browser:try-disconnect":[]});d(this,"onCloseCallbacks",[]);d(this,"heartbeatCounter",0);d(this,"heartbeatInterval");d(this,"params",{});this.formId=e}static create(e){return b._instance&&b._instance.close(),b._instance=new b(e),b._instance}get url(){return`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}/_socket?id=${encodeURIComponent(this.formId)}`}isConnected(){return this.ws&&this.ws.readyState===this.ws.OPEN}resetState(){this.close()}resetHeartbeatCounter(){this.heartbeatCounter=0}on(e,t){this.callbacks[e].push(t)}clearWSEvents(){!this.ws||(clearInterval(this.heartbeatInterval),this.ws.onclose=()=>{},this.ws.onerror=()=>{},this.ws.onmessage=()=>{})}async connect(e,t=1){if(!(t>3))return this.params=e!=null?e:this.params,new Promise(i=>{this.clearWSEvents(),this.ws=new WebSocket(this.url),this.ws.onopen=()=>{i(),this.resetHeartbeatCounter(),this.send({type:"start",params:this.params})};let n=!1;const s=()=>{n||(n=!0)};this.ws.onclose=a=>{if(a.code===1006||!a.wasClean)return s();clearInterval(this.heartbeatInterval),this.onCloseCallbacks.forEach(l=>l())},this.ws.onerror=()=>s(),this.ws.onmessage=a=>{const l=JSON.parse(a.data);notify(this.callbacks,l)},this.heartbeatInterval=setInterval(()=>{if(!(!this.ws||this.ws.readyState!==this.ws.OPEN)){if(this.heartbeatCounter++,this.heartbeatCounter>3)return this.ws.onclose=()=>{},clearInterval(this.heartbeatInterval),s();this.send({type:"heartbeat"})}},2e3)}).catch(()=>{this.connect(this.params,t+1)})}onClose(e){this.onCloseCallbacks.push(e)}close(){if(!this.ws){console.warn("no websocket to close");return}this.clearWSEvents(),this.ws.close()}async send(e){if(!this.ws){console.warn("no websocket to send");return}closingStates.includes(this.ws.readyState)&&await this.connect(),this.ws.send(JSON.stringify(e)),notify(this.callbacks,e)}};let RemoteBroker=b;d(RemoteBroker,"_instance");const _withScopeId$1=o=>(pushScopeId("data-v-b4830c24"),o=o(),popScopeId(),o),_hoisted_1$7={class:"auth-info"},_hoisted_2$6={class:"auth-header"},_hoisted_3$4={class:"auth-label"},_hoisted_4$4={class:"description"},_hoisted_5$3=["onKeyup"],_hoisted_6$2={key:0,class:"span-error"},_hoisted_7$2=_withScopeId$1(()=>createBaseVNode("div",{class:"spacer"},null,-1)),_sfc_main$9=defineComponent({__name:"AuthInfo",props:{invalid:{type:Boolean},provider:{}},emits:["sendAuthInfo"],setup(o,{emit:e}){const t=o,i={description:i18nProvider.translate("i18n_local_auth_info_description"),button:i18nProvider.translate("i18n_local_auth_info_authenticate")},n={description:i18nProvider.translate("i18n_auth_info_description"),button:i18nProvider.translate("i18n_auth_info_send_code")},s=computed(()=>t.provider==="local"?i:n),a=reactive({email:""}),l=()=>{e("sendAuthInfo",a)};return(c,p)=>(openBlock(),createElementBlock("div",_hoisted_1$7,[createBaseVNode("div",_hoisted_2$6,[createBaseVNode("div",_hoisted_3$4,toDisplayString(unref(i18nProvider).translate("i18n_auth_validate_your_email")),1),createBaseVNode("div",_hoisted_4$4,toDisplayString(s.value.description),1)]),withDirectives(createBaseVNode("input",{"onUpdate:modelValue":p[0]||(p[0]=v=>a.email=v),type:"email",placeholder:"Email address",class:"input email-input",onKeyup:withKeys(l,["enter"])},null,40,_hoisted_5$3),[[vModelText,a.email]]),c.invalid?(openBlock(),createElementBlock("span",_hoisted_6$2,toDisplayString(unref(i18nProvider).translate("i18n_auth_info_invalid_email")),1)):createCommentVNode("",!0),_hoisted_7$2,createBaseVNode("button",{class:"next-button",onClick:l},toDisplayString(s.value.button),1)]))}}),AuthInfo_vue_vue_type_style_index_0_scoped_b4830c24_lang="",AuthInfo=_export_sfc(_sfc_main$9,[["__scopeId","data-v-b4830c24"]]),_withScopeId=o=>(pushScopeId("data-v-98843af4"),o=o(),popScopeId(),o),_hoisted_1$6={class:"auth-token"},_hoisted_2$5={class:"auth-label"},_hoisted_3$3=["onKeyup"],_hoisted_4$3={key:0,class:"span-error"},_hoisted_5$2={key:1,class:"span-error"},_hoisted_6$1=_withScopeId(()=>createBaseVNode("div",{class:"spacer"},null,-1)),_hoisted_7$1={class:"button-icon",viewBox:"0 0 24 24"},_hoisted_8$1=["d"],_hoisted_9$1={class:"footer"},_sfc_main$8=defineComponent({__name:"AuthToken",props:{email:{},invalid:{type:Boolean},expired:{type:Boolean},provider:{}},emits:["sendToken","restartAuth","resendToken"],setup(o,{emit:e}){const t=reactive({token:""}),i=()=>{e("restartAuth")},n=()=>{e("resendToken")},s=()=>{e("sendToken",t.token)};return(a,l)=>(openBlock(),createElementBlock("div",_hoisted_1$6,[createBaseVNode("div",_hoisted_2$5,toDisplayString(unref(i18nProvider).translate("i18n_auth_token_label",{email:a.email})),1),withDirectives(createBaseVNode("input",{"onUpdate:modelValue":l[0]||(l[0]=c=>t.token=c),type:"text",placeholder:"Type your verification code",class:"input",onKeyup:withKeys(s,["enter"])},null,40,_hoisted_3$3),[[vModelText,t.token]]),a.expired?(openBlock(),createElementBlock("span",_hoisted_4$3,toDisplayString(unref(i18nProvider).translate("i18n_auth_token_expired")),1)):createCommentVNode("",!0),a.invalid?(openBlock(),createElementBlock("span",_hoisted_5$2,toDisplayString(unref(i18nProvider).translate("i18n_auth_token_invalid")),1)):createCommentVNode("",!0),_hoisted_6$1,createBaseVNode("button",{class:"next-button",onClick:s},toDisplayString(unref(i18nProvider).translate("i18n_auth_token_verify_email")),1),createBaseVNode("button",{class:"secondary-button back",onClick:i},[(openBlock(),createElementBlock("svg",_hoisted_7$1,[createBaseVNode("path",{d:unref(thinrefresh)},null,8,_hoisted_8$1)])),createTextVNode(" "+toDisplayString(unref(i18nProvider).translate("i18n_auth_token_try_again")),1)]),createBaseVNode("button",{class:"secondary-button back",onClick:n},toDisplayString(unref(i18nProvider).translate("i18n_auth_token_resend_email")),1),createBaseVNode("div",_hoisted_9$1,toDisplayString(unref(i18nProvider).translate("i18n_auth_token_footer_alternative_email")),1)]))}}),AuthToken_vue_vue_type_style_index_0_scoped_98843af4_lang="",AuthToken=_export_sfc(_sfc_main$8,[["__scopeId","data-v-98843af4"]]),_hoisted_1$5={key:0,class:"form"},_hoisted_2$4={class:"form-wrapper"},_hoisted_3$2={class:"loading"},_hoisted_4$2={key:1,class:"form"},_hoisted_5$1={class:"form-wrapper"},_hoisted_6={class:"widget"},_hoisted_7={key:2,class:"form"},_hoisted_8={class:"form-wrapper"},_hoisted_9={class:"widget"},_hoisted_10={key:3,class:"form"},_hoisted_11={class:"form-wrapper"},_hoisted_12={class:"loading"},_sfc_main$7=defineComponent({__name:"Passwordless",emits:["done"],setup(o,{emit:e}){const t=reactive({stage:"collect-info",userProvider:null,invalid:!1,token:null,info:null});onMounted(()=>{t.userProvider=AuthnUserProvider.instance});const i=async l=>{const c=AuthnUserProvider.instance;if(!c)return;t.info=l,t.stage="loading";const p=await c.authenticate(l.email);t.invalid=!!p,p?t.stage="collect-info":t.stage="collect-token"},n=async l=>{var p;const c=AuthnUserProvider.instance;if(!(!c||!((p=t.info)!=null&&p.email))){t.token=l,t.stage="loading";try{const v=await c.verify(t.info.email,t.token);if(!v)throw new Error("no user");e("done",v),t.stage="done"}catch{t.invalid=!0,t.stage="collect-token"}}},s=()=>{t.info&&i(t.info)},a=()=>{t.stage="collect-info",t.info=null,t.token=null,t.invalid=!1};return(l,c)=>{var p,v;return t.userProvider?t.stage==="collect-info"?(openBlock(),createElementBlock("div",_hoisted_4$2,[createBaseVNode("div",_hoisted_5$1,[createBaseVNode("div",_hoisted_6,[createVNode(AuthInfo,{invalid:t.invalid,provider:t.userProvider.provider,onSendAuthInfo:i},null,8,["invalid","provider"])])])])):t.stage==="collect-token"?(openBlock(),createElementBlock("div",_hoisted_7,[createBaseVNode("div",_hoisted_8,[createBaseVNode("div",_hoisted_9,[createVNode(AuthToken,{invalid:t.invalid,email:(v=(p=t.info)==null?void 0:p.email)!=null?v:"",provider:t.userProvider.provider,onSendToken:n,onResendToken:s,onRestartAuth:a},null,8,["invalid","email","provider"])])])])):(openBlock(),createElementBlock("div",_hoisted_10,[createBaseVNode("div",_hoisted_11,[createBaseVNode("div",_hoisted_12,[createVNode(LoadingIndicator)])])])):(openBlock(),createElementBlock("div",_hoisted_1$5,[createBaseVNode("div",_hoisted_2$4,[createBaseVNode("div",_hoisted_3$2,[createVNode(LoadingIndicator)])])]))}}}),Passwordless_vue_vue_type_style_index_0_scoped_8daf4c27_lang="",Passwordless=_export_sfc(_sfc_main$7,[["__scopeId","data-v-8daf4c27"]]),_hoisted_1$4=["href"],_hoisted_2$3=createStaticVNode('<svg width="44" height="32" viewBox="0 0 256 256" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-91fa59aa><g clip-path="url(#clip0_405_116214)" data-v-91fa59aa><path d="M188.697 133.808L172.68 148.263C172.68 148.263 216.044 185.966 217.997 187.72C219.951 189.475 234.405 174.566 232.843 173.266C231.28 171.966 188.697 133.808 188.697 133.808Z" fill="#E36C7C" data-v-91fa59aa></path><path d="M188.697 133.808L172.68 148.263C172.68 148.263 216.044 185.966 217.997 187.72C219.951 189.475 234.405 174.566 232.843 173.266C231.28 171.966 188.697 133.808 188.697 133.808Z" fill="url(#paint0_linear_405_116214)" data-v-91fa59aa></path><path d="M218.387 91.2249L176.195 127.557L173.851 129.51C151.192 149.849 149.853 152.309 141.642 152.584L141.584 152.586C139.612 152.652 135.357 152.795 131.875 149.849C126.797 145.552 120.155 140.083 117.03 137.348C115.34 135.869 112.465 133.039 109.998 131.097C107.902 129.448 106.482 127.581 104.919 127.581C103.357 127.581 100.622 129.925 96.3246 133.832C92.0272 137.739 82.6511 146.333 82.6511 146.333L65.0712 161.569C65.0712 161.569 42.5857 180.688 36.7256 185.376C30.8656 190.064 16.5797 175.69 21.4895 171.703C21.9628 171.23 26.2429 167.755 29.7179 164.915C32.2165 162.84 34.2084 161.179 34.2084 161.179C34.9897 160.397 66.2433 133.051 66.2433 133.051L87.723 114.573C87.723 114.573 95.9339 106.094 105.701 106.094C108.826 106.094 112.83 106.485 126.015 118.205C129.531 121.33 131.485 122.542 135.782 126.409C137.345 127.816 139.852 130.316 140.861 130.316C141.882 130.316 143.986 128.363 145.549 127.023C145.549 127.023 195.897 84.4149 202.37 77.9421C207.839 72.4726 223.075 86.9273 218.387 91.2249Z" fill="url(#paint1_linear_405_116214)" data-v-91fa59aa></path><path d="M33.238 67.1372C31.2846 68.6564 23.9305 75.1737 22.2992 76.9039C19.3366 80.0417 21.3638 81.3905 25.6611 84.9065C29.9585 88.4225 57.8962 112.712 64.8542 118.963L79.9642 105.221L41.288 71.2331C36.5999 67.1372 35.1913 65.6179 33.238 67.1372Z" fill="url(#paint2_linear_405_116214)" data-v-91fa59aa></path></g><defs data-v-91fa59aa><linearGradient id="paint0_linear_405_116214" x1="172.68" y1="133.808" x2="183.059" y2="196.169" gradientUnits="userSpaceOnUse" data-v-91fa59aa><stop offset="0.114583" stop-color="#FF98A6" data-v-91fa59aa></stop><stop offset="1" stop-color="#E36C7C" data-v-91fa59aa></stop></linearGradient><linearGradient id="paint1_linear_405_116214" x1="219.271" y1="186.305" x2="206.115" y2="57.7298" gradientUnits="userSpaceOnUse" data-v-91fa59aa><stop stop-color="#E36C7C" data-v-91fa59aa></stop><stop offset="0.859375" stop-color="#FF98A6" data-v-91fa59aa></stop></linearGradient><linearGradient id="paint2_linear_405_116214" x1="20.8984" y1="66.56" x2="30.8589" y2="127.049" gradientUnits="userSpaceOnUse" data-v-91fa59aa><stop stop-color="#E36C7C" data-v-91fa59aa></stop><stop offset="0.859375" stop-color="#FF98A6" data-v-91fa59aa></stop></linearGradient><clipPath id="clip0_405_116214" data-v-91fa59aa><rect width="256" height="256" fill="white" data-v-91fa59aa></rect></clipPath></defs></svg><b data-v-91fa59aa>Abstra Cloud</b>',2),_sfc_main$6=defineComponent({__name:"Watermark",props:{runtime:{}},setup(o){var i;const e=window.location.hostname.split(".")[0],t=(i=SetttingsProvider.instance)==null?void 0:i.showWatermark;return(n,s)=>unref(t)?(openBlock(),createElementBlock("a",{key:0,href:`https://www.abstra.io/forms?utm_source=abstra_pages&utm_medium=badge&utm_campaign=${n.runtime.id}&origin_subdomain=${unref(e)}`,target:"_blank",class:"watermark"},[createTextVNode(toDisplayString(unref(i18nProvider).translate("i18n_watermark_text"))+" ",1),_hoisted_2$3],8,_hoisted_1$4)):createCommentVNode("",!0)}}),Watermark_vue_vue_type_style_index_0_scoped_91fa59aa_lang="",Watermark=_export_sfc(_sfc_main$6,[["__scopeId","data-v-91fa59aa"]]),_sfc_main$5=defineComponent({__name:"RuntimeCommons",props:{runtime:{},fullWidth:{type:Boolean},forceResponsivity:{},userEmail:{},stepsInfo:{}},emits:["navigate","logout"],setup(o,{expose:e,emit:t}){const i=n=>t("navigate",n);return e({open}),(n,s)=>(openBlock(),createElementBlock(Fragment,null,[createBaseVNode("header",null,[createVNode(PlayerNavbar,{runtime:n.runtime,"user-email":n.userEmail,"force-responsivity":n.forceResponsivity,onLogout:s[0]||(s[0]=a=>t("logout")),onNavigate:i},null,8,["runtime","user-email","force-responsivity"])]),createVNode(Steps,{class:"steps","steps-info":n.stepsInfo},null,8,["steps-info"]),createVNode(Watermark,{class:"watermark",runtime:n.runtime},null,8,["runtime"])],64))}}),RuntimeCommons_vue_vue_type_style_index_0_scoped_b9aa0bc8_lang="",RuntimeCommons=_export_sfc(_sfc_main$5,[["__scopeId","data-v-b9aa0bc8"]]);function isInputWidget(o){return"key"in o&&"value"in o&&"errors"in o}const _hoisted_1$3={key:0,class:"text"},_hoisted_2$2={key:1,class:"text"},_sfc_main$4=defineComponent({__name:"component",props:{status:{}},setup(o){return(e,t)=>e.status==="running"?(openBlock(),createElementBlock("div",_hoisted_1$3," This form is already being filled ")):(openBlock(),createElementBlock("div",_hoisted_2$2,"This form was already filled"))}}),executeCode=($context,code)=>{let evaluatedCode;try{evaluatedCode=eval(code)}catch(o){throw console.error(`[Error: execute_js]: ${o.message}, context: ${$context}`),o}return isSerializable(evaluatedCode)?evaluatedCode:null};async function executeJs(o){return{type:"execute-js:response",value:await executeCode(o.context,o.code)}}const isSerializable=o=>{try{return JSON.stringify(o),!0}catch{return!1}};class BrokerMessageHandler{constructor(e,t){d(this,"showEndWidget",!0);d(this,"reactivePollInterval",null);d(this,"seq",0);d(this,"programEnded",!1);d(this,"setErrorPageState",()=>{this.newPageState({widgets:[{type:"error"}],actions:[],fullWidth:!1,steps:null})});d(this,"setEndPageState",()=>{!this.showEndWidget||this.newPageState({widgets:[{type:"end"}],actions:this.pageActionFactory.restartAction,fullWidth:!1,steps:null})});d(this,"setLockFailedPageState",e=>{this.newPageState({widgets:[{type:"lock-failed",status:e}],actions:[],fullWidth:!1,steps:null})});d(this,"sendUser",e=>{this.broker.send({type:"auth:saved-jwt",jwt:e.jwt})});d(this,"sendBrowserTryDisconnect",()=>{this.broker.send({type:"browser:try-disconnect"})});d(this,"updatePageStateListener",()=>{});d(this,"newPageStateListener",()=>{});d(this,"onReactivePollListener",()=>{});d(this,"onErrorListener",()=>{});d(this,"onExitListener",()=>{});d(this,"onStartAuthListener");d(this,"onEndAuthListener");d(this,"onBadAuthListener");this.broker=e,this.pageActionFactory=t}static create(e,t,i){const n=new BrokerMessageHandler(e,t);return n.broker.onClose(()=>{n.programEnded||(n.setErrorPageState(),n.error("Connection with service closed before program ended"))}),n.broker.on("form",({widgets:s,actions:a,buttonText:l,endProgram:c,reactivePollingInterval:p,steps:v})=>{n.newPageState({widgets:s,actions:n.pageActionFactory.fromPageActionsDto(l?[l]:a!=null?a:[]),fullWidth:s.some(y=>"fullWidth"in y&&y.fullWidth),steps:v}),p&&(n.reactivePollInterval=setInterval(n.onReactivePollListener,p*1e3)),c&&(n.showEndWidget=!1,n.broker.send({type:"form-response",payload:{},secrets:[],seq:++n.seq}))}),n.broker.on("execute-js:request",async s=>{const a=await executeJs(s);n.broker.send(a)}),n.broker.on("auth:require-info",s=>{n.newPageState({widgets:[],actions:[],fullWidth:!1,steps:null}),n.onStartAuthListener&&n.onStartAuthListener(s)}),n.broker.on("auth:valid-jwt",()=>{n.onEndAuthListener&&n.onEndAuthListener()}),n.broker.on("auth:invalid-jwt",()=>{console.warn("invalid jwt"),n.onBadAuthListener&&n.onBadAuthListener()}),n.broker.on("program:end",s=>{if(n.programEnded=!0,s.exitStatus!=="SUCCESS"||s.exception){n.setErrorPageState(),n.error(s);return}n.setEndPageState(),n.exit(s)}),n.broker.on("stage-run:lock-failed",s=>{n.programEnded=!0,n.setLockFailedPageState(s.status)}),n.broker.on("redirect",s=>{i.onRedirect(s.url,s.queryParams)}),n.broker.on("heartbeat",()=>{n.broker.resetHeartbeatCounter()}),n.broker.on("form-update",({widgets:s,validation:a,seq:l})=>{l===n.seq&&n.updatePageState({widgets:s,error:{message:a.message,status:a.status},fullWidth:s.some(c=>"fullWidth"in c&&c.fullWidth)})}),n}handleAction(e,t,i){this.reactivePollInterval&&clearInterval(this.reactivePollInterval);const n={};Object.entries(e).forEach(([s,a])=>{n[s]=a}),this.broker.send({type:"form-response",payload:n,action:t==null?void 0:t.name,secrets:i,seq:++this.seq})}sendUserEvent(e,t){const i={};Object.entries(e).forEach(([n,s])=>{i[n]=s}),this.broker.send({type:"user-event",payload:i,secrets:t,seq:++this.seq})}init(e){this.broker.resetState(),this.newPageState({widgets:[],actions:[],fullWidth:!1,steps:null}),this.broker.connect(e!=null?e:{})}updatePageState(e){this.updatePageStateListener(e)}listenToPageStateUpdate(e){this.updatePageStateListener=e}onNewPageState(e){this.newPageStateListener=e}newPageState(e){this.newPageStateListener(e)}onReactivePoll(e){this.onReactivePollListener=e}error(e){this.reactivePollInterval&&clearInterval(this.reactivePollInterval),this.onErrorListener(e)}onError(e){this.onErrorListener=e}exit(e){this.reactivePollInterval&&clearInterval(this.reactivePollInterval),this.onExitListener(e)}onExit(e){this.onExitListener=e}onStartAuth(e){this.onStartAuthListener=e}onEndAuth(e){this.onEndAuthListener=e}onBadAuth(e){this.onBadAuthListener=e}}class PageAction{constructor(e,t){d(this,"element",null);this.name=e,this.isDefault=t}static fromDto(e){return typeof e=="string"?new PageAction(e,!1):new PageAction(e.name,e.is_default)}setElement(e){e instanceof HTMLElement&&(this.element=e)}get isFocused(){return this.element===document.activeElement}focusOnButton(){var e;(e=this.element)==null||e.focus()}addKeydownListener(e){var t;(t=this.element)==null||t.addEventListener("keydown",e)}}class PageActionsFactory{constructor(e){this.form=e}static from(e){return new PageActionsFactory(e)}get startAction(){return[PageAction.fromDto(this.form.startButtonText||"Start")]}get restartAction(){const e=this.form.restartButtonText||"Restart";return this.form.allowRestart?[PageAction.fromDto(e)]:[]}fromPageActionsDto(e){return e.filter(t=>!!t).map(t=>PageAction.fromDto(t))}}const _hoisted_1$2={class:"outline-button"},_sfc_main$3=defineComponent({__name:"OutlineButton",props:{iconPath:{},noShadow:{type:Boolean},status:{}},setup(o){return(e,t)=>{const i=resolveComponent("icon");return openBlock(),createElementBlock("button",_hoisted_1$2,[e.iconPath?(openBlock(),createBlock(i,{key:0,path:e.iconPath,fill:"#fff",class:"icon"},null,8,["path"])):createCommentVNode("",!0),renderSlot(e.$slots,"default",{},void 0,!0)])}}}),OutlineButton_vue_vue_type_style_index_0_scoped_56f62044_lang="",OutlineButton=_export_sfc(_sfc_main$3,[["__scopeId","data-v-56f62044"]]),_sfc_main$2=defineComponent({__name:"FormAutoFill",props:{broker:{},form:{}},setup(o){const e=o,t=window.__runs||(window.__runs={previous:[],current:[]});e.broker.on("start",()=>{t.previous=t.current,t.current=[]});const i=ref(null);function n(){for(const l in t.current){const c=t.previous[l],p=t.current[l];if(!c||c.type!==p.type||c.type=="form"&&!lodash.exports.isEqual(c.widgets,p.widgets)||c.type=="form-response"&&!lodash.exports.isEqual(c.payload,p.payload))return null}const a=t.previous[t.current.length];if((a==null?void 0:a.type)!=="form-response")return null;i.value=a}function s(){const a=i.value;a&&e.broker.send(a)}return e.broker.on("form",a=>{t.current.push(a),n()}),e.broker.on("form-response",a=>{t.current.push(a),i.value=null}),(a,l)=>i.value?(openBlock(),createBlock(OutlineButton,{key:0,"icon-path":unref(magicWand),class:"form-auto-fill-btn",onClick:s},{default:withCtx(()=>[createTextVNode(" Repeat last answer ")]),_:1},8,["icon-path"])):createCommentVNode("",!0)}}),FormAutoFill_vue_vue_type_style_index_0_scoped_e7cd5d42_lang="",FormAutoFill=_export_sfc(_sfc_main$2,[["__scopeId","data-v-e7cd5d42"]]),_hoisted_1$1={key:0,class:"hint"},_hoisted_2$1={class:"icon",viewBox:"0 0 24 24",style:{width:"20px",height:"20px"}},_hoisted_3$1=["d"],_hoisted_4$1={class:"hint-content"},_sfc_main$1=defineComponent({__name:"WidgetHint",props:{hint:{}},setup(o){return(e,t)=>e.hint?(openBlock(),createElementBlock("div",_hoisted_1$1,[(openBlock(),createElementBlock("svg",_hoisted_2$1,[createBaseVNode("path",{d:unref(info)},null,8,_hoisted_3$1)])),createBaseVNode("div",_hoisted_4$1,toDisplayString(e.hint),1)])):createCommentVNode("",!0)}}),WidgetHint_vue_vue_type_style_index_0_scoped_9a7a836d_lang="",WidgetHint=_export_sfc(_sfc_main$1,[["__scopeId","data-v-9a7a836d"]]),_hoisted_1={key:0,class:"form-wrapper"},_hoisted_2=["id"],_hoisted_3={key:1,class:"loading-wrapper"},_hoisted_4={key:2,class:"span-error"},_hoisted_5={class:"buttons"},_sfc_main=defineComponent({__name:"FormRunner",props:{form:{},params:{},isPreview:{type:Boolean},enableAutoFocus:{type:Boolean},broker:{}},emits:["log","error","exit","navigate","logout","start","redirect"],setup(o,{expose:e,emit:t}){const i=o,n=[],s=ref({}),a=ref({}),l=ref({}),c=ref(null),p=(r,u)=>{n[u]=r},v=ref(null),y=computed(()=>PageActionsFactory.from(i.form)),P=r=>t("navigate",r),E=()=>{_.value={widgets:[{type:"start"}],actions:y.value.startAction,fullWidth:!1,steps:null}};watch(()=>i.form,()=>{var r;((r=_.value.widgets[0])==null?void 0:r.type)=="start"&&E()});const k=reactive({user:null,authenticating:!1}),_=ref({widgets:[],fullWidth:!1,actions:[],steps:null}),C=ref("idle"),N=computed(()=>_.value.widgets.filter(r=>"secret"in r).reduce((r,u)=>"key"in u&&"secret"in u?[...r,{key:u.key,secret:u.secret}]:r,[]));$();function $(){k.user=userManager.getUser()}const V=()=>{userManager.removeUser(),$(),t("logout")},g=BrokerMessageHandler.create(i.broker,y.value,{onRedirect(r,u){t("redirect",r,u)}}),I=ref(null);g.onError(r=>{t("error",r),C.value="error"}),g.onExit(r=>{t("exit",r),C.value="over"}),g.onStartAuth(r=>{r.refresh?(userManager.removeUser(),$(),k.authenticating=!0):k.user?g.sendUser(k.user):k.authenticating=!0}),g.onEndAuth(()=>{k.authenticating=!1}),g.onBadAuth(()=>{userManager.removeUser(),k.user=null,k.authenticating=!0}),g.onReactivePoll(()=>{g.sendUserEvent(s.value,N.value)});const W=r=>{k.user=r,g.sendUser(r)};g.onNewPageState(r=>{c.value=null,_.value=r;const u={},h={};_.value.widgets.forEach(m=>{isInputWidget(m)&&(u[m.key]=m.value,h[m.key]=m.errors)}),s.value=u,a.value=h,l.value={},I.value&&(I.value.scrollTop=0)}),g.listenToPageStateUpdate(r=>{c.value=null,_.value={..._.value,...r};const u={},h={};_.value.widgets.forEach(m=>{isInputWidget(m)&&(u[m.key]=m.value,h[m.key]=m.errors)}),s.value=u,a.value=h});const L=r=>{var u;if(!(C.value!=="running"||i.isPreview||!((u=window.should_ask_before_leave)==null||u)))return g.sendBrowserTryDisconnect(),r.preventDefault(),r.returnValue="Are you sure?",""};onMounted(async()=>{window.addEventListener("beforeunload",L),E(),i.form.autoStart&&A()}),onUnmounted(()=>{i.broker.close(),window.removeEventListener("beforeunload",L)});const D=()=>{n.forEach(r=>{!r||!("setErrors"in r)||typeof r.setErrors!="function"||r.setErrors()})},R=async r=>{if(C.value!=="running")return A();D(),!(Object.values(l.value).some(h=>h.length>0)&&(r==null?void 0:r.name)!=="i18n_back_action")&&(g.handleAction(s.value,r,N.value),c.value=r!=null?r:null)},A=async()=>{g.init(i.params),C.value="running",t("start")};function T(r){var u;return isInputWidget(r)&&(u=s.value[r.key])!=null?u:null}function F(r){var S;if(!isInputWidget(r))return[];const u=r.errors.map(f=>i18nProvider.translateIfFound(f,r)),m=((S=l.value[r.key])!=null?S:[]).map(f=>i18nProvider.translateIfFound(f,r));return[...u,...m]}function U(r,u){if(!isInputWidget(r))return;const h={...s.value};h[r.key]=u,s.value=h,g.sendUserEvent(s.value)}function M(r,u){if(!isInputWidget(r))return;const h={...l.value};h[r.key]=u,l.value=h}return e({run:A}),(r,u)=>(openBlock(),createBlock(WidgetsFrame,{class:normalizeClass([{preview:r.isPreview},"runner"]),"main-color":r.form.mainColor,theme:r.form.theme,"font-family":r.form.fontFamily,runtime:"form"},{default:withCtx(()=>{var h,m,S;return[r.isPreview?(openBlock(),createBlock(FormAutoFill,{key:0,class:"auto-fill-btn",broker:r.broker,form:r.form,style:{"z-index":1}},null,8,["broker","form"])):createCommentVNode("",!0),createVNode(RuntimeCommons,{ref_key:"runtimeCommonsRef",ref:v,runtime:r.form,"full-width":_.value.fullWidth,"steps-info":_.value.steps,"user-email":(h=k.user)==null?void 0:h.claims.email,onLogout:V,onNavigate:P},null,8,["runtime","full-width","steps-info","user-email"]),createBaseVNode("main",{ref_key:"mainContainer",ref:I},[k.authenticating?(openBlock(),createBlock(Passwordless,{key:0,class:"form-auth",onDone:W})):(openBlock(),createElementBlock("div",{key:1,class:normalizeClass(["form",{"full-width":_.value.fullWidth}])},[_.value.widgets.length>0?(openBlock(),createElementBlock("div",_hoisted_1,[_.value.widgets[0].type=="start"?(openBlock(),createBlock(StartWidget,{key:0,form:r.form},null,8,["form"])):_.value.widgets[0].type=="end"?(openBlock(),createBlock(EndWidget,{key:1,"end-message":r.form.endMessage},null,8,["end-message"])):_.value.widgets[0].type=="error"?(openBlock(),createBlock(ErrorWidget,{key:2,"error-message":r.form.errorMessage},null,8,["error-message"])):_.value.widgets[0].type=="lock-failed"?(openBlock(),createBlock(_sfc_main$4,{key:3,status:_.value.widgets[0].status},null,8,["status"])):(openBlock(!0),createElementBlock(Fragment,{key:4},renderList(_.value.widgets,(f,B)=>{var x;return openBlock(),createElementBlock("div",{id:f.type+B,key:(x=f.key)!=null?x:f.type+B,class:"widget"},[(openBlock(),createBlock(resolveDynamicComponent(f.type),{ref_for:!0,ref:w=>p(w,B),value:T(f),errors:F(f),"user-props":f,runtime:"form","onUpdate:value":w=>U(f,w),"onUpdate:errors":w=>M(f,w)},null,40,["value","errors","user-props","onUpdate:value","onUpdate:errors"])),createVNode(WidgetHint,{hint:"hint"in f?f.hint:null},null,8,["hint"]),(openBlock(!0),createElementBlock(Fragment,null,renderList(F(f),w=>(openBlock(),createElementBlock("span",{key:w,class:"span-error"},toDisplayString(w),1))),128))],8,_hoisted_2)}),128))])):(openBlock(),createElementBlock("div",_hoisted_3,[createVNode(LoadingIndicator)])),(m=_.value.error)!=null&&m.message?(openBlock(),createElementBlock("span",_hoisted_4,toDisplayString((S=_.value.error)==null?void 0:S.message),1)):createCommentVNode("",!0),createBaseVNode("div",_hoisted_5,[(openBlock(!0),createElementBlock(Fragment,null,renderList(_.value.actions,f=>{var B;return openBlock(),createBlock(_sfc_main$a,{key:f.name,loading:((B=c.value)==null?void 0:B.name)==f.name,"display-name":unref(i18nProvider).translateIfFound(f.name),action:f,onClick:x=>R(f)},null,8,["loading","display-name","action","onClick"])}),128))])],2))],512)]}),_:1},8,["class","main-color","theme","font-family"]))}}),FormRunner_vue_vue_type_style_index_0_scoped_b9bb4ca0_lang="",FormRunner=_export_sfc(_sfc_main,[["__scopeId","data-v-b9bb4ca0"]]);export{FormRunner as F,RemoteBroker as R,getExecutionResourceFromPath as g,redirect as r};
//# sourceMappingURL=FormRunner.8c0d0f71.js.map
