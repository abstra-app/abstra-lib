import{f as r,eG as se,r as Y,H as z,F as _e,d as P,b as i,ev as S,w as n,aD as U,eC as L,eD as b,u as e,v as K,c as d,ar as v,cM as ve,cE as T,ex as C,bg as he,eJ as oe,e as B,eI as M,aH as re,cm as le,eE as be,eF as Se,eP as ke,bG as J,a as we,cD as ie,ae as ue,eA as Ae,J as Re,o as Ce,L as Ie,dk as Oe}from"./outputWidgets.e0c11cdd.js";import{a as ce}from"./asyncComputed.5ea7d449.js";import"./workspaces.210afb74.js";import{S as De}from"./scripts.b5322326.js";import"./envVars.dff29af4.js";import{A as $e,s as de}from"./api.176ff573.js";import{A as Pe}from"./contracts.generated.7f2e5ace.js";import{A as I}from"./index.daca4dc1.js";import{q as xe,r as Fe}from"./icons.befd8bc2.js";import{t as Ee}from"./ant-design.bf7020f5.js";import{A as H}from"./Text.e195aa2c.js";import"./index.42456f8c.js";import{A as G}from"./index.69d093e7.js";import{f as Te}from"./index.0755f89b.js";import{A as te}from"./Paragraph.a6af9ff9.js";import{A as q}from"./Title.aa774db6.js";import"./index.5ffff99d.js";import{T as Ue,A as Le}from"./Timeline.d14e9b56.js";import{A as pe,C as ge}from"./CollapsePanel.3f002351.js";import{A as Ne}from"./Link.9d387c9b.js";import{A as fe}from"./index.fb1a8321.js";import{A as Ve}from"./index.84bb6b91.js";import{E as je}from"./ExpandOutlined.1fd88c86.js";import{C as qe}from"./Card.e17c27c3.js";import{D as ze}from"./DownOutlined.f1789252.js";import{d as Be}from"./vuedraggable.umd.19cf4420.js";import"./index.5f56f017.js";import{F as He,A as Ke}from"./Form.428a6b36.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[t]="1306bcb9-123e-4522-83a1-16828a30036b",s._sentryDebugIdIdentifier="sentry-dbid-1306bcb9-123e-4522-83a1-16828a30036b")}catch{}})();var Me={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM641.7 520.8L442.3 677.6c-7.4 5.8-18.3.6-18.3-8.8V355.3c0-9.4 10.9-14.7 18.3-8.8l199.4 156.7a11.2 11.2 0 010 17.6z"}}]},name:"play-square",theme:"filled"};const Je=Me;var Ge={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M168 504.2c1-43.7 10-86.1 26.9-126 17.3-41 42.1-77.7 73.7-109.4S337 212.3 378 195c42.4-17.9 87.4-27 133.9-27s91.5 9.1 133.8 27A341.5 341.5 0 01755 268.8c9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47a8 8 0 003 14.1l175.7 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c0-6.7-7.7-10.5-12.9-6.3l-56.4 44.1C765.8 155.1 646.2 92 511.8 92 282.7 92 96.3 275.6 92 503.8a8 8 0 008 8.2h60c4.4 0 7.9-3.5 8-7.8zm756 7.8h-60c-4.4 0-7.9 3.5-8 7.8-1 43.7-10 86.1-26.9 126-17.3 41-42.1 77.8-73.7 109.4A342.45 342.45 0 01512.1 856a342.24 342.24 0 01-243.2-100.8c-9.9-9.9-19.2-20.4-27.8-31.4l60.2-47a8 8 0 00-3-14.1l-175.7-43c-5-1.2-9.9 2.6-9.9 7.7l-.7 181c0 6.7 7.7 10.5 12.9 6.3l56.4-44.1C258.2 868.9 377.8 932 512.2 932c229.2 0 415.5-183.7 419.8-411.8a8 8 0 00-8-8.2z"}}]},name:"sync",theme:"outlined"};const We=Ge;function ae(s){for(var t=1;t<arguments.length;t++){var o=arguments[t]!=null?Object(arguments[t]):{},l=Object.keys(o);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(o).filter(function(a){return Object.getOwnPropertyDescriptor(o,a).enumerable}))),l.forEach(function(a){Ye(s,a,o[a])})}return s}function Ye(s,t,o){return t in s?Object.defineProperty(s,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):s[t]=o,s}var Z=function(t,o){var l=ae({},t,o.attrs);return r(se,ae({},l,{icon:Je}),null)};Z.displayName="PlaySquareFilled";Z.inheritAttrs=!1;const Ze=Z;function ne(s){for(var t=1;t<arguments.length;t++){var o=arguments[t]!=null?Object(arguments[t]):{},l=Object.keys(o);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(o).filter(function(a){return Object.getOwnPropertyDescriptor(o,a).enumerable}))),l.forEach(function(a){Qe(s,a,o[a])})}return s}function Qe(s,t,o){return t in s?Object.defineProperty(s,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):s[t]=o,s}var Q=function(t,o){var l=ne({},t,o.attrs);return r(se,ne({},l,{icon:We}),null)};Q.displayName="SyncOutlined";Q.inheritAttrs=!1;const Xe=Q;function et(){const s=Y({state:"closed"});function t(){s.value={state:"closed"}}function o(){s.value={state:"visualizations"}}function l(u,m){s.value={state:"stage-run",stageRun:m}}const a=z(()=>"stageRun"in s.value?s.value.stageRun:null);return{closeDrawer:t,openVisualizationEditor:o,inspectStageRun:l,drawerState:s,selectedStageRunForDrawer:a}}const E="kanban-selected-stage-ids",N=10,tt=({kanbanRepository:s,storage:t,filterFactory:o,router:l})=>{const a=_e([]),u=ce(async()=>{try{const p=await s.getData({selection:a.value,filter:o()}),g=await t.get(E)||[];for(const f of p.not_found_stages)t.set(E,g.filter(_=>_!==f)),a.value=a.value.filter(_=>_.stage_id!==f);return p}catch{return a.value=[],await t.set(E,[]),{columns:[],next_stage_options:[]}}});function m(p){const g=p.selected_stage.id,f=a.value.find(_=>_.stage_id===g);return f!=null&&f.limit?f.limit<p.total_count:!1}async function c(p){var f;const g=a.value.find(_=>_.stage_id===p.selected_stage.id);g&&(g.limit=((f=g.limit)!=null?f:0)+N,await u.refetch())}async function y(p){const g=a.value.find(f=>f.stage_id===p);g&&g.limit&&g.limit>N&&(g.limit-=N,await u.refetch())}async function h(){const p=await t.get(E)||[];a.value=p.map(g=>({stage_id:g,limit:N,offset:0}))}async function O(p,g){p?a.value=[...a.value.slice(0,g),{stage_id:p.id,limit:N,offset:0},...a.value.slice(g+1)]:a.value=[...a.value.slice(0,g),...a.value.slice(g+1)],await t.set(E,a.value.map(f=>f.stage_id)),await u.refetch()}async function x(p){await O(p,a.value.length)}async function k(p){const g=a.value[p.moved.oldIndex];O(null,p.moved.oldIndex),a.value=[...a.value.slice(0,p.moved.newIndex),g,...a.value.slice(p.moved.newIndex)],await t.set(E,a.value.map(f=>f.stage_id)),await u.refetch()}let w=null;return{kanbanAsyncComputed:u,selection:a,increasePagination:c,hasPagination:m,seeLess:y,setStage:O,addStage:x,cardActionHandler:async(p,g)=>{const f=p.selected_stage,_=g.id;if(f.type==="script"){const R=await De.get(f.id);if(!R)return;await R.run(_)}if(f.type==="form"){const R=l.resolve({path:`/${f.path}`,query:_?{[$e]:_}:{}});window.open(R.href,_)}},setup:async()=>{await h(),u.refetch(),w=setInterval(()=>{u.refetch()},1e3)},tearDown:()=>{w&&clearInterval(w)},reorderStages:k}};function X(s){switch(s.status){case"waiting":return{color:"blue",text:"Waiting"};case"running":return{color:"processing",text:"Running"};case"finished":return{color:"success",text:"Success"};case"failed":return{color:"error",text:"Failed"};case"abandoned":return{color:"warning",text:"Abandoned"}}}const V="Show All",at=[V,...Pe];function nt(){const s=Y(V);return{filterStatus:s,filterFactory:()=>s.value==V?{}:{status:s.value},labelOption:l=>l==V?V:X({status:l}).text}}const st={key:0},ot={key:1,class:"terminal"},rt=P({__name:"ExecutionInspector",props:{logs:{}},setup(s){return(t,o)=>t.logs.length===0?(i(),S("span",st)):(i(),S("div",ot,[r(e(I),{vertical:""},{default:n(()=>[(i(!0),S(U,null,L(t.logs,l=>(i(),S("pre",{key:l.executionId,class:"log-text"},b(l.payload.text),1))),128))]),_:1})]))}});const lt=K(rt,[["__scopeId","data-v-4e71a195"]]),W=P({__name:"StageRunData",props:{data:{}},setup(s){return(t,o)=>(i(),d(e(T),{direction:"vertical",style:{overflow:"hidden"}},{default:n(()=>[(i(!0),S(U,null,L(t.data,l=>(i(),S("div",{key:l.key},[r(e(H),{strong:""},{default:n(()=>[v(b(l.key),1)]),_:2},1024),r(e(ve),{"tree-data":e(Ee)(l.value),selectable:!1},null,8,["tree-data"])]))),128))]),_:1}))}}),it=s=>(be("data-v-68c9e478"),s=s(),Se(),s),ut={key:1},ct={key:1},dt=it(()=>B("span",null,"[Deleted Stage]",-1)),pt=["onClick"],gt=P({__name:"StageRunInspector",props:{stageRun:{},kanbanRepository:{},stageRunRepository:{}},emits:["close"],setup(s,{emit:t}){const o=s;function l(c){return Object.entries(c).map(([y,h])=>({key:y,value:h,type:typeof h}))}const{result:a,loading:u}=ce(()=>{var c;return o.kanbanRepository.getLogs((c=o.stageRun)==null?void 0:c.id)}),m=(c,y)=>{var h;c.stopPropagation(),(h=o.stageRunRepository)==null||h.fork(y),t("close")};return(c,y)=>(i(),d(e(Ve),{open:"",title:"Thread details",size:"large",onClose:y[0]||(y[0]=h=>t("close"))},{extra:n(()=>[r(e(te),null,{default:n(()=>[r(e(G),{style:{"font-weight":"600"}},{default:n(()=>{var h;return[v(b(e(X)({status:(h=c.stageRun)==null?void 0:h.status}).text),1)]}),_:1}),v(" "+b(e(Te)(new Date(c.stageRun.created_at),{addSuffix:!0})),1)]),_:1})]),default:n(()=>{var h,O,x;return[(h=c.stageRun)!=null&&h.assignee?(i(),d(e(te),{key:0},{default:n(()=>{var k;return[v(" Assignee: "+b((k=c.stageRun)==null?void 0:k.assignee),1)]}),_:1})):C("",!0),((O=c.stageRun)==null?void 0:O.content)&&((x=c.stageRun)==null?void 0:x.content.length)>0?(i(),S("div",ut,[r(e(q),{level:4},{default:n(()=>[v("Current data")]),_:1}),r(W,{data:c.stageRun.content},null,8,["data"])])):C("",!0),r(e(q),{level:4,style:{"margin-bottom":"30px"}},{default:n(()=>[v(" Timeline ")]),_:1}),e(u)?(i(),d(e(he),{key:2})):e(a)?(i(),d(e(Ue),{key:3},{default:n(()=>[(i(!0),S(U,null,L(e(a),({stage:k,stage_run:w,logs:D})=>(i(),d(e(Le),{key:w.id},{default:n(()=>[r(e(ge),{ghost:"","expand-icon-position":"end"},{default:n(()=>[r(e(pe),{class:"panel"},oe({header:n(()=>[k?(i(),d(e(I),{key:0,align:"center",gap:15},{default:n(()=>[r(M,{path:e(de)(k.type)},null,8,["path"]),D.length?(i(),S("span",ct,b(k.title),1)):(i(),d(e(re),{key:0,placement:"right",title:"No logs"},{default:n(()=>[v(b(k.title),1)]),_:2},1024))]),_:2},1024)):(i(),d(e(I),{key:1,align:"center",gap:15},{default:n(()=>[r(M,{path:e(Fe)},null,8,["path"]),dt]),_:1}))]),default:n(()=>[l(w.data).length||D.length?(i(),d(e(I),{key:0,vertical:""},{default:n(()=>[l(w.data).length?(i(),d(e(I),{key:0,gap:0,vertical:""},{default:n(()=>[r(e(q),{level:5},{default:n(()=>[v(" Output data ")]),_:1}),r(W,{data:l(w.data)},null,8,["data"])]),_:2},1024)):C("",!0),D.length?(i(),d(e(I),{key:1,vertical:"",gap:0},{default:n(()=>[r(e(fe)),r(e(q),{level:5},{default:n(()=>[v(" Logs ")]),_:1}),r(lt,{logs:D},null,8,["logs"])]),_:2},1024)):C("",!0)]),_:2},1024)):(i(),d(e(le),{key:1,description:"No logs"}))]),_:2},[c.stageRunRepository&&k?{name:"extra",fn:n(()=>[B("span",{onClick:j=>m(j,w.id)},[r(e(I),{gap:"small"},{default:n(()=>[r(M,{path:e(xe),width:"22"},null,8,["path"]),r(e(Ne),null,{default:n(()=>[v("Fork")]),_:1})]),_:1})],8,pt)]),key:"0"}:void 0]),1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):C("",!0)]}),_:1}))}});const ft=K(gt,[["__scopeId","data-v-68c9e478"]]),mt=P({__name:"Card",props:{stage:{},card:{}},emits:["inspect","action"],setup(s){const t=s,o=z(()=>X({status:t.card.status}).text),l=z(()=>ke(new Date(String(t.card.updated_at))));return(a,u)=>{var m,c;return i(),d(e(qe),{size:"small",style:{width:"275px",cursor:"pointer"},"head-style":{"border-bottom":((m=a.card.content)==null?void 0:m.length)>0?"":"none"},"body-style":{display:((c=a.card.content)==null?void 0:c.length)>0?"block":"none"}},oe({title:n(()=>[r(e(G),null,{default:n(()=>[v(b(o.value)+" ",1),o.value==="Running"?(i(),d(e(Xe),{key:0,spin:!0,style:{"margin-left":"4px"}})):C("",!0)]),_:1})]),default:n(()=>[r(e(T),{direction:"vertical",style:{"max-height":"300px",width:"100%",overflow:"hidden"},onClick:u[0]||(u[0]=y=>a.$emit("inspect"))},{default:n(()=>[r(W,{data:a.card.content,disabled:!0},null,8,["data"]),a.card.assignee?(i(),d(e(G),{key:0},{default:n(()=>[v(b(a.card.assignee),1)]),_:1})):C("",!0)]),_:1})]),extra:n(()=>[r(e(I),{gap:"10"},{default:n(()=>[r(e(re),null,{title:n(()=>[v(b(a.card.updated_at),1)]),default:n(()=>[r(e(H),{type:"secondary",style:{"font-size":"12px"}},{default:n(()=>[v(b(l.value),1)]),_:1})]),_:1}),r(e(je),{onClick:u[2]||(u[2]=y=>a.$emit("inspect"))})]),_:1})]),_:2},[a.card.status==="waiting"?{name:"actions",fn:n(()=>[r(e(J),{onClick:u[1]||(u[1]=y=>a.$emit("action"))},{default:n(()=>[r(e(Ze)),v(" Continue this thread ")]),_:1})]),key:"0"}:void 0]),1032,["head-style","body-style"])}}}),me=P({__name:"ColumnHeader",props:{stageOptions:{},stage:{},stageCount:{}},emits:["stageUpdate"],setup(s,{emit:t}){const o=s,l=a=>{const u=o.stageOptions.find(m=>m.id===a);t("stageUpdate",u!=null?u:null)};return(a,u)=>{var c;const m=we("icon");return i(),d(e(ue),{style:{width:"275px"},"allow-clear":"",value:((c=a.stage)==null?void 0:c.id)||"","onUpdate:value":l},{suffixIcon:n(()=>[r(e(H),{type:"secondary",style:{"font-size":"small","margin-right":"2px"}},{default:n(()=>[v(b(a.stageCount),1)]),_:1}),r(e(fe),{type:"vertical"}),r(e(ze))]),default:n(()=>[(i(!0),S(U,null,L(a.stageOptions,y=>(i(),d(e(ie),{key:y.id,value:y.id},{default:n(()=>[r(e(I),{gap:"10",style:{"max-width":"200px"}},{default:n(()=>[r(m,{path:e(de)(y.type),style:{"flex-shrink":"0",width:"24px"}},null,8,["path"]),r(e(H),{ellipsis:"",content:y.title},null,8,["content"])]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])}}});class yt{constructor(t,o,l){this.router=t,this.column=o,this.kanbanRepository=l}get stage(){return this.column.selected_stage}get canStart(){return this.stage.can_be_started}get launchLink(){return!this.stage.can_be_started||this.stage.type!=="form"||!this.stage.path?null:this.router.resolve({path:`/${this.stage.path}`}).href}click(){if(this.launchLink)return window.open(this.launchLink,"_blank");if(this.stage.type==="job")return this.kanbanRepository.startJob(this.stage.id).catch(console.error)}}const _t=P({__name:"Column",props:{router:{},hasPagination:{type:Boolean},column:{},kanbanRepository:{}},emits:["increasePagination","cardAction","stageUpdate","cardInspection"],setup(s,{emit:t}){const o=s,l=z(()=>new yt(o.router,o.column,o.kanbanRepository));return(a,u)=>(i(),d(e(T),{direction:"vertical",class:"stage-column"},{default:n(()=>[r(me,{"stage-options":a.column.stages,stage:a.column.selected_stage,"stage-count":a.column.total_count,onStageUpdate:u[0]||(u[0]=m=>t("stageUpdate",m))},null,8,["stage-options","stage","stage-count"]),r(e(T),{direction:"vertical",style:{width:"100%"}},{default:n(()=>[a.column.stage_run_cards.length===0?(i(),d(e(le),{key:0})):C("",!0),(i(!0),S(U,null,L(a.column.stage_run_cards,m=>(i(),d(mt,{key:m.id,stage:a.column.selected_stage,card:m,onInspect:c=>t("cardInspection",m),onAction:c=>t("cardAction",m)},null,8,["stage","card","onInspect","onAction"]))),128)),a.hasPagination?(i(),d(e(J),{key:1,style:{width:"100%"},onClick:u[1]||(u[1]=m=>t("increasePagination"))},{default:n(()=>[v("See more")]),_:1})):C("",!0),l.value.canStart?(i(),d(e(J),{key:2,style:{width:"100%"},onClick:u[2]||(u[2]=()=>l.value.click())},{default:n(()=>[v(" Start new thread ")]),_:1})):C("",!0)]),_:1})]),_:1}))}});const vt=K(_t,[["__scopeId","data-v-7284c7e1"]]),ht=P({__name:"EmptyColumn",props:{stages:{}},emits:["stageUpdate"],setup(s,{emit:t}){const o=l=>{t("stageUpdate",l)};return(l,a)=>(i(),d(e(T),{direction:"vertical"},{default:n(()=>[r(me,{"stage-options":l.stages,onStageUpdate:o},null,8,["stage-options"])]),_:1}))}}),bt={style:{"padding-top":"20px"}},St={class:"stages-container"},kt={class:"stages-content"},wt=P({__name:"Kanban",props:{storage:{},kanbanRepository:{},stageRunRepository:{}},setup(s){const t=s,o=Ae(),{closeDrawer:l,inspectStageRun:a,drawerState:u,selectedStageRunForDrawer:m}=et(),{filterFactory:c,filterStatus:y,labelOption:h}=nt(),{kanbanAsyncComputed:O,setStage:x,addStage:k,setup:w,tearDown:D,cardActionHandler:j,increasePagination:ee,hasPagination:p,reorderStages:g}=tt({kanbanRepository:t.kanbanRepository,storage:t.storage,filterFactory:c,router:o}),f=Y([]);return Re(()=>{var _;return(_=O.result.value)==null?void 0:_.columns},_=>{_!==void 0&&(f.value=_)}),Ce(w),Ie(D),(_,R)=>(i(),S("div",bt,[r(e(I),{vertical:"",style:{height:"100%"}},{default:n(()=>[r(e(ge),{ghost:""},{default:n(()=>[r(e(pe),{header:"Filters"},{default:n(()=>[r(e(He),null,{default:n(()=>[r(e(Ke),{label:"Status"},{default:n(()=>[r(e(ue),{value:e(y),"onUpdate:value":R[0]||(R[0]=$=>Oe(y)?y.value=$:null),style:{width:"325px"}},{default:n(()=>[(i(!0),S(U,null,L(e(at),$=>(i(),d(e(ie),{key:$,value:$},{default:n(()=>[v(b(e(h)($)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),B("div",St,[B("div",kt,[r(e(T),{align:"start"},{default:n(()=>{var $;return[r(e(Be),{modelValue:f.value,"onUpdate:modelValue":R[1]||(R[1]=A=>f.value=A),class:"draggable","item-key":A=>A.selected_stage.id,"ghost-class":"ghost",onStart:e(D),onEnd:e(w),onChange:e(g)},{item:n(({element:A,index:ye})=>[(i(),d(e(vt),{key:A.selected_stage.id,column:A,router:e(o),"has-pagination":e(p)(A),"kanban-repository":t.kanbanRepository,class:"stages-content-column",onIncreasePagination:F=>e(ee)(A),onCardInspection:F=>e(a)(A,F),onCardAction:F=>e(j)(A,F),onStageUpdate:F=>e(x)(F,ye)},null,8,["column","router","has-pagination","kanban-repository","onIncreasePagination","onCardInspection","onCardAction","onStageUpdate"]))]),_:1},8,["modelValue","item-key","onStart","onEnd","onChange"]),r(e(ht),{stages:(($=e(O).result.value)==null?void 0:$.next_stage_options)||[],onStageUpdate:R[2]||(R[2]=A=>e(k)(A))},null,8,["stages"])]}),_:1})])])]),_:1}),e(u).state==="stage-run"&&e(m)?(i(),d(e(ft),{key:0,"kanban-repository":t.kanbanRepository,"stage-run":e(m),"stage-run-repository":t.stageRunRepository,onClose:e(l)},null,8,["kanban-repository","stage-run","stage-run-repository","onClose"])):C("",!0)]))}});const Qt=K(wt,[["__scopeId","data-v-e9bc25a1"]]);class Xt{constructor(t,o=localStorage){this.contextKey=t,this.storage=o}makeKey(t){return`${this.contextKey}:${t}`}async get(t){const o=this.storage.getItem(this.makeKey(t));return o?JSON.parse(o):null}async set(t,o){this.storage.setItem(this.makeKey(t),JSON.stringify(o))}}export{Qt as K,Xt as L};
//# sourceMappingURL=repository.a19a457d.js.map
