var ae=Object.defineProperty;var ie=(r,e,n)=>e in r?ae(r,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[e]=n;var u=(r,e,n)=>(ie(r,typeof e!="symbol"?e+"":e,n),n);import{d as L,b as f,c as y,x as E,z as T,N as U,D as P,q as C,a as le,t as w,B as ue,r as N,w as re,U as ce,V as $,a4 as de,K as F,a2 as he,v as Q,a5 as X,a6 as fe,a7 as pe,o as me,Y as ve,G as Z,e as R,F as ee,L as te,a8 as ge,a9 as ye}from"./registerWidgets.1f64062d.js";import{p as j}from"./passwordlessManager.f7bf4528.js";import{j as we,k as be}from"./icons.888e0741.js";import{_ as _e}from"./ActionButton.vue_vue_type_script_setup_true_lang.1528dfde.js";import{P as ke}from"./Passwordless.88ee3445.js";import{e as Ee,R as Pe}from"./executeJs.9d3c1254.js";import{W as Ie}from"./WidgetsFrame.444835bd.js";import{L as De}from"./CircularLoading.48f8280b.js";(function(){try{var r=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(r._sentryDebugIds=r._sentryDebugIds||{},r._sentryDebugIds[e]="8fd6ffd8-8a82-4b0a-aa7d-b76c70216c12",r._sentryDebugIdIdentifier="sentry-dbid-8fd6ffd8-8a82-4b0a-aa7d-b76c70216c12")}catch{}})();const xe={key:0,class:"hint"},Le={class:"icon",viewBox:"0 0 24 24",style:{width:"20px",height:"20px"}},Ce=["d"],Se={class:"hint-content"},Ae=L({__name:"WidgetHint",props:{hint:null},setup(r){return(e,n)=>r.hint?(f(),y("div",xe,[(f(),y("svg",Le,[E("path",{d:T(we)},null,8,Ce)])),E("div",Se,U(r.hint),1)])):P("",!0)}});const We=C(Ae,[["__scopeId","data-v-419a518f"]]),Be={class:"outline-button"},Fe=L({__name:"OutlineButton",props:{iconPath:null,noShadow:{type:Boolean},status:null},setup(r){return(e,n)=>{const t=le("icon");return f(),y("button",Be,[r.iconPath?(f(),w(t,{key:0,path:r.iconPath,fill:"#fff",class:"icon"},null,8,["path"])):P("",!0),ue(e.$slots,"default",{},void 0,!0)])}}});const Re=C(Fe,[["__scopeId","data-v-d16448de"]]),je=L({__name:"FormAutoFill",props:{broker:null,form:null},setup(r){const e=r,n=window.__runs||(window.__runs={previous:[],current:[]});e.broker.on("start",()=>{n.previous=n.current,n.current=[]});const t=N(null);function o(){for(const h in n.current){const c=n.previous[h],i=n.current[h];if(!c||c.type!==i.type||c.type=="form"&&!$.exports.isEqual(c.widgets,i.widgets)||c.type=="form-response"&&!$.exports.isEqual(c.payload,i.payload))return null}const a=n.previous[n.current.length];if((a==null?void 0:a.type)!=="form-response")return null;t.value=a}function d(){const a=t.value;a&&e.broker.send(a)}return e.broker.on("form",a=>{n.current.push(a),o()}),e.broker.on("form-response",a=>{n.current.push(a),t.value=null}),(a,h)=>t.value?(f(),w(Re,{key:0,"icon-path":T(be),class:"form-auto-fill-btn",onClick:d},{default:re(()=>[ce(" Repeat last answer ")]),_:1},8,["icon-path"])):P("",!0)}});const Oe=C(je,[["__scopeId","data-v-9590d96b"]]);class _{constructor(e,n){u(this,"element",null);this.name=e,this.isDefault=n}static fromDto(e){return typeof e=="string"?new _(e,!1):new _(e.name,e.is_default)}setElement(e){e instanceof HTMLElement&&(this.element=e)}get isFocused(){return this.element===document.activeElement}focusOnButton(){var e;(e=this.element)==null||e.focus()}addKeydownListener(e){var n;(n=this.element)==null||n.addEventListener("keydown",e)}}class H{constructor(e){this.form=e}static from(e){return new H(e)}get startAction(){var e;return[_.fromDto((e=this.form.startButtonText)!=null?e:"Start")]}get restartAction(){var n;const e=(n=this.form.restartButtonText)!=null?n:"Restart";return this.form.allowRestart?[_.fromDto(e)]:[]}fromPageActionsDto(e){return e.filter(n=>!!n).map(n=>_.fromDto(n))}}async function Ue(r){window.should_ask_before_leave=!1,window.location.href=r.url}const Ne={redirect:Ue,"execute-js":Ee};class V{constructor(e,n){u(this,"loading",!1);u(this,"endedByPage",!1);u(this,"reactivePollInterval",null);u(this,"programEnded",!1);u(this,"widgetError",()=>{this.newPageDefinition({widgets:[{type:"error"}],actions:[],fullWidth:!1,hasError:!1,steps:null})});u(this,"widgetEnd",()=>{this.endedByPage||this.newPageDefinition({widgets:[{type:"end"}],actions:this.pageActionFactory.restartAction,fullWidth:!1,hasError:!1,steps:null})});u(this,"sendUser",e=>{this.broker.send({type:"auth:saved-jwt",jwt:e.jwt}),this.broker.send({type:"metadata",payload:{authenticated_user:e.claims.email}})});u(this,"sendBrowserTryDisconnect",()=>{this.broker.send({type:"browser:try-disconnect"})});u(this,"newPageDefinitionListener",()=>{});u(this,"updatePageDefinitionListener",()=>{});u(this,"onReactivePollListener",()=>{});u(this,"onErrorListener",()=>{});u(this,"onExitListener",()=>{});u(this,"onStartAuthListener");u(this,"onEndAuthListener");u(this,"onBadAuthListener");this.broker=e,this.pageActionFactory=n}static create(e,n){const t=new V(e,n);return t.broker.onClose(()=>{if(t.programEnded)return;const o="Connection with service closed before program ended";t.widgetError(),t.error(o)}),t.broker.on("form",({widgets:o,actions:d,buttonText:a,endProgram:h,reactivePollingInterval:c,steps:i})=>{t.loading=!1,t.newPageDefinition({widgets:o,actions:t.pageActionFactory.fromPageActionsDto(a?[a]:d!=null?d:[]),fullWidth:o.some(v=>"fullWidth"in v&&v.fullWidth),hasError:!1,steps:i}),c&&(t.reactivePollInterval=setInterval(t.onReactivePollListener,c*1e3)),h&&(t.endedByPage=!0,t.broker.send({type:"form-response",payload:{},secrets:[]}))}),t.broker.on("action",async({action:o})=>{var h;let d=null,a;try{const{type:c}=o;d=(h=await Ne[c](o))!=null?h:null}catch(c){a=c.message}t.broker.send({type:"action-response",value:d,errorMessage:a})}),t.broker.on("auth:require-info",()=>{t.newPageDefinition({widgets:[],actions:[],fullWidth:!1,hasError:!1,steps:null}),t.onStartAuthListener&&t.onStartAuthListener()}),t.broker.on("auth:valid-jwt",()=>{t.onEndAuthListener&&t.onEndAuthListener()}),t.broker.on("auth:invalid-jwt",()=>{console.warn("invalid jwt"),t.onBadAuthListener&&t.onBadAuthListener()}),t.broker.on("program:connection-error",o=>{t.widgetError(),t.error(o)}),t.broker.on("program:end",o=>{t.programEnded=!0,o.exitCode||o.exception?(t.widgetError(),t.error(o)):(t.widgetEnd(),t.exit(o))}),t.broker.on("program:disconnect",o=>{t.exit(o)}),t.broker.on("not-enough-credits",()=>{t.error({error:"not-enough-credits"}),t.programEnded=!0}),t.broker.on("heartbeat",()=>{t.broker.resetHeartbeatCounter()}),t.broker.on("user-response-event",({widgets:o,validation:d})=>{t.updatePageDefinition({widgets:o,validation:{message:d.message,status:d.status},fullWidth:o.some(a=>"fullWidth"in a&&a.fullWidth)})}),t}next(e,n,t,o){if((de(Object.values(e))||!t)&&(n==null?void 0:n.name)!=="Back"){this.updatePageDefinition({hasError:!0});return}this.reactivePollInterval&&clearInterval(this.reactivePollInterval);const a={};Object.keys(e).forEach(h=>{a[h]=e[h].value}),this.loading=!0,this.broker.send({type:"form-response",payload:a,action:n==null?void 0:n.name,secrets:o}),this.newPageDefinition({widgets:[],fullWidth:!1,hasError:!1,actions:[],steps:null})}sendUserEvent(e,n){const t={};Object.keys(e).forEach(o=>{t[o]=e[o].value}),this.broker.send({type:"user-event",payload:t,secrets:n})}init(e){this.broker.resetState(),this.newPageDefinition({widgets:[],actions:[],fullWidth:!1,hasError:!1,steps:null}),this.broker.connect(e!=null?e:{})}newPageDefinition(e){this.newPageDefinitionListener(e)}updatePageDefinition(e){this.loading||this.updatePageDefinitionListener(e)}listenToNewPageDefinition(e){this.newPageDefinitionListener=e}listenToPageDefinitionUpdate(e){this.updatePageDefinitionListener=e}onReactivePoll(e){this.onReactivePollListener=e}error(e){this.reactivePollInterval&&clearInterval(this.reactivePollInterval),this.onErrorListener(e)}onError(e){this.onErrorListener=e}exit(e){this.reactivePollInterval&&clearInterval(this.reactivePollInterval),this.onExitListener(e)}onExit(e){this.onExitListener=e}onStartAuth(e){this.onStartAuthListener=e}onEndAuth(e){this.onEndAuthListener=e}onBadAuth(e){this.onBadAuthListener=e}}const $e={key:0,class:"form-wrapper"},Te=["id"],He={key:0,class:"span-error"},Ve={key:1,class:"loading-wrapper"},Me={class:"span-error"},qe={class:"buttons"},ze=L({__name:"FormRunner",props:{form:{type:Object,required:!0},params:Object,isPreview:Boolean,enableAutoFocus:{type:Boolean,required:!0},broker:{type:Object,required:!0}},emits:["log","error","exit","navigate","logout","start"],setup(r,{expose:e,emit:n}){const t=r,o=N(null),d=F(()=>H.from(t.form)),a=s=>n("navigate",s),h=()=>{i.value={widgets:[{type:"start"}],actions:d.value.startAction,fullWidth:!1,hasError:!1,steps:null}};he(()=>t.form,()=>{var s;((s=i.value.widgets[0])==null?void 0:s.type)=="start"&&h()});const c=Q({user:null,authenticating:!1}),i=N({widgets:[],fullWidth:!1,hasError:!1,actions:[],steps:null}),v=Q({responses:{},formState:"idle"}),S=F(()=>i.value.widgets.reduce((s,l)=>("key"in l&&(s[l.key]=v.responses[l.key]),s),{})),A=F(()=>i.value.widgets.filter(s=>"secret"in s).reduce((s,l)=>"key"in l&&"secret"in l?[...s,{key:l.key,secret:l.secret}]:s,[]));M();function M(){c.user=j.getUser()}const se=()=>{j.removeUser(),M(),n("logout")},p=V.create(t.broker,d.value);p.onError(s=>{var l;if(n("error",s),v.formState="error",s.error==="not-enough-credits"){(l=o.value)==null||l.open(),h();return}}),p.onExit(s=>{n("exit",s),v.formState="over"}),p.onStartAuth(()=>{c.user?p.sendUser(c.user):c.authenticating=!0}),p.onEndAuth(()=>{c.authenticating=!1}),p.onBadAuth(()=>{j.removeUser(),c.user=null,c.authenticating=!0}),p.onReactivePoll(()=>{p.sendUserEvent(S.value,A.value)});const oe=s=>{c.user=s,p.sendUser(s)};p.listenToNewPageDefinition(s=>{var l,g;i.value=s,X.init(t.enableAutoFocus,()=>I()),v.responses=fe((g=(l=i.value)==null?void 0:l.widgets)!=null?g:[])}),p.listenToPageDefinitionUpdate(s=>{var l,g;i.value={...i.value,...s},v.responses=pe((g=(l=i.value)==null?void 0:l.widgets)!=null?g:[],v.responses)});const q=s=>{var l;if(!(v.formState!=="running"||t.isPreview||!((l=window.should_ask_before_leave)==null||l)))return p.sendBrowserTryDisconnect(),s.preventDefault(),s.returnValue="Are you sure?",""};me(async()=>{window.addEventListener("beforeunload",q),h(),X.init(t.enableAutoFocus,s=>I(s)),t.form.autoStart&&W()}),ve(()=>{t.broker.close(),window.removeEventListener("beforeunload",q)});const I=s=>{var l,g;if(v.formState!=="running")return W();p.next(S.value,s,(g=(l=i.value.validation)==null?void 0:l.status)!=null?g:!0,A.value)},W=async()=>{p.init(t.params),v.formState="running",n("start")},D=s=>ye(s.type)?v.responses[s.key]:null;function z(s,l,g){if(p.sendUserEvent(S.value,g),l===i.value.widgets.length-1&&["multiple-choice-input","cards-input"].includes(i.value.widgets[l].type)&&i.value.actions.filter(x=>!!x).length===0&&s.value!==null&&(!$.exports.isArray(s.value)||s.value.length)){I();return}}return e({run:W}),(s,l)=>(f(),w(Ie,{class:Z([{preview:r.isPreview},"runner"]),"main-color":r.form.mainColor,theme:r.form.theme,"font-family":r.form.fontFamily,runtime:"form"},{default:re(()=>{var g,x;return[r.isPreview?(f(),w(Oe,{key:0,class:"auto-fill-btn",broker:r.broker,form:r.form,style:{"z-index":1}},null,8,["broker","form"])):P("",!0),R(Pe,{ref_key:"runtimeCommonsRef",ref:o,runtime:r.form,"full-width":i.value.fullWidth,"steps-info":i.value.steps,"is-preview":r.isPreview,"user-email":(g=c.user)==null?void 0:g.claims.email,type:"forms",onLogout:se,onNavigate:a},null,8,["runtime","full-width","steps-info","is-preview","user-email"]),E("main",null,[c.authenticating?(f(),w(ke,{key:1,class:"form-auth",onDone:oe})):(f(),y("div",{key:0,class:Z(["form",{"full-width":i.value.fullWidth}])},[i.value.widgets.length>0?(f(),y("div",$e,[(f(!0),y(ee,null,te(i.value.widgets,(m,k)=>{var J,G,K,Y;return f(),y("div",{id:m.type+k,key:(J=m.key)!=null?J:m.type+k,class:"widget"},[(f(),w(ge(m.type),{data:m,response:D(m),form:r.form,page:i.value,"has-error":((G=D(m))==null?void 0:G.isInvalid())&&i.value.hasError,runtime:"form",onChange:B=>z(B,k,T(A)),onSetInitialValue:B=>z(B,k)},null,40,["data","response","form","page","has-error","onChange","onSetInitialValue"])),R(We,{hint:"hint"in m?m.hint:null},null,8,["hint"]),((K=D(m))==null?void 0:K.isInvalid())&&i.value.hasError?(f(),y("span",He,U((Y=D(m))==null?void 0:Y.errorMessages().join(`
`)),1)):P("",!0)],8,Te)}),128))])):(f(),y("div",Ve,[R(De)])),E("span",Me,U((x=i.value.validation)==null?void 0:x.message),1),E("div",qe,[(f(!0),y(ee,null,te(i.value.actions,m=>(f(),w(_e,{key:m.name,action:m,onNext:k=>I(m)},null,8,["action","onNext"]))),128))])],2))])]}),_:1},8,["class","main-color","theme","font-family"]))}});const st=C(ze,[["__scopeId","data-v-468c1eb1"]]);function Je(r){return r.type==="form"&&r.payload?{...r,type:"form-response"}:r.type==="user-event"&&r.widgets?{...r,type:"user-response-event"}:r}const Ge=[WebSocket.CLOSING,WebSocket.CLOSED];function ne(r,e){const n=r[e.type];if(!n){console.warn("no callback for",e.type);return}n.forEach(t=>t(e))}const b=class{constructor(e){u(this,"formPath",null);u(this,"ws",null);u(this,"callbacks",{"form-response":[],"user-response-event":[],start:[],"auth:info":[],"auth:saved-jwt":[],"auth:restart":[],"auth:validate-token":[],"auth:resend-token":[],heartbeat:[],metadata:[],"executed-by":[],"action-response":[],"user-event":[],"program:end":[],"program:disconnect":[],"program:connection-error":[],stderr:[],stdout:[],form:[],action:[],"not-enough-credits":[],"auth:require-info":[],"auth:expecting-token":[],"auth:token-expired":[],"auth:invalid-token":[],"auth:invalid-jwt":[],"auth:valid-token":[],"auth:valid-jwt":[],"browser:disconnect":[],"browser:try-disconnect":[]});u(this,"onCloseCallbacks",[]);u(this,"heartbeatCounter",0);u(this,"heartbeatInterval");u(this,"params",{});var n;"formPath"in e&&(this.formPath=(n=e.formPath)!=null?n:null)}static create(e){return b._instance&&b._instance.close(),b._instance=new b(e),b._instance}get url(){return`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}/_socket?formPath=${encodeURIComponent(this.formPath)}`}resetState(){this.close()}resetHeartbeatCounter(){this.heartbeatCounter=0}on(e,n){this.callbacks[e].push(n)}clearWSEvents(){!this.ws||(clearInterval(this.heartbeatInterval),this.ws.onclose=()=>{},this.ws.onerror=()=>{},this.ws.onmessage=()=>{})}async connect(e,n=1){if(!(n>3))return this.params=e!=null?e:this.params,new Promise(t=>{this.clearWSEvents(),this.ws=new WebSocket(this.url),this.ws.onopen=()=>{t(),this.resetHeartbeatCounter(),this.send({type:"start",params:this.params})};let o=!1;const d=()=>{o||(o=!0)};this.ws.onclose=a=>{if(a.code===1006||!a.wasClean)return d();clearInterval(this.heartbeatInterval),this.onCloseCallbacks.forEach(h=>h())},this.ws.onerror=()=>d(),this.ws.onmessage=a=>{const h=JSON.parse(a.data);ne(this.callbacks,Je(h))},this.heartbeatInterval=setInterval(()=>{if(!(!this.ws||this.ws.readyState!==this.ws.OPEN)){if(this.heartbeatCounter++,this.heartbeatCounter>3)return this.ws.onclose=()=>{},clearInterval(this.heartbeatInterval),d();this.send({type:"heartbeat"})}},2e3)}).catch(()=>{this.connect(this.params,n+1)})}onClose(e){this.onCloseCallbacks.push(e)}close(){if(!this.ws){console.warn("no websocket to close");return}this.clearWSEvents(),this.ws.close()}async send(e){if(!this.ws){console.warn("no websocket to send");return}Ge.includes(this.ws.readyState)&&await this.connect(),this.ws.send(JSON.stringify(e)),ne(this.callbacks,e)}};let O=b;u(O,"_instance");export{st as F,O as R};
//# sourceMappingURL=broker.1f6a1a31.js.map
