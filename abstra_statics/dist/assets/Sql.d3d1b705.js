import{_ as K}from"./AbstraButton.vue_vue_type_script_setup_true_lang.e61b10a3.js";import{_ as te}from"./ScrollArea.vue_vue_type_script_setup_true_lang.598248bc.js";import{a0 as J,Z as q,r as S,w as se,d as ne,eH as ae,U as oe,ac as T,f as i,e as v,b as u,u as e,aY as j,eA as le,o as y,t as C,i as E,a as N,S as re,eB as F,h as B,dj as h,g as A,eV as ie,d0 as ue,d6 as ce,cC as de,M as me,cQ as G,_ as fe}from"./jwt-decode.esm.a71c2b53.js";import{G as pe}from"./PhClockCounterClockwise.vue.7ba66bf9.js";import{I as ye}from"./PhDatabase.vue.bcf95237.js";import{G as _e}from"./PhDownloadSimple.vue.7afaccb2.js";import{F as ge}from"./PhKey.vue.549de4b2.js";import{l as D,e as he}from"./toggleHighContrast.98531206.js";import{_ as ve}from"./TablesTabs.vue_vue_type_script_setup_true_lang.8fdfd732.js";import{A as Ce,C as qe}from"./router.1a302c1f.js";import{a as we}from"./project.48e47eec.js";import"./tables.6e54b3c6.js";import{u as be}from"./useTables.f7b02640.js";import{t as Ee}from"./ant-design.a851ece1.js";import"./Card.b7af1118.js";import"./index.922b04cc.js";import"./record.38533a9e.js";import"./string.02a8158f.js";(function(){try{var t=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},n=new Error().stack;n&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[n]="080fa617-434a-41b4-a602-98f928ae6a1d",t._sentryDebugIdIdentifier="sentry-dbid-080fa617-434a-41b4-a602-98f928ae6a1d")}catch{}})();const W=t=>{if(t==null)return"";const n=String(t);return n.includes(";")||n.includes(`
`)||n.includes('"')?`"${n.replace(/"/g,'""')}"`:n},$e=t=>{let n=t.columns.map(W).join(";")+`
`;t.rows.forEach(m=>{n+=m.map(W).join(";")+`
`});const a=document.createElement("a");a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(n),a.target="_blank",a.download=`${t.fileName}.csv`,a.click()},O=new J(q.array(q.object({projectId:q.string(),lastQuery:q.string()})),"lastQueries"),R=new J(q.array(q.object({id:q.string(),query:q.string(),timestamp:q.number(),projectId:q.string()})),"queryHistory");function ke(t,n){var $;const a=t.toUpperCase(),m=/\b(FROM|JOIN|UPDATE|INTO)\s+\w*$/i.test(a)||/\bDELETE\s+FROM\s+\w*$/i.test(a),s=/\b(SELECT|WHERE|ON|SET|AND|OR|BY)\s+[\w.]*$/i.test(a)||/\w+\.\w*$/.test(t),c=t.match(/(\w+)\.\w*$/),L=c&&($=n.find(I=>I.name.toUpperCase()===c[1].toUpperCase()))!=null?$:null,w=/\b(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP|FROM|WHERE|JOIN)\b/.test(a);return{textBeforeCursor:t,isTableContext:m,isColumnContext:s,specificTable:L,hasSqlKeyword:w}}function xe(t,n,a){const m=[];if(t.specificTable)t.specificTable.getColumns().forEach(s=>{m.push({label:s.name,kind:D.CompletionItemKind.Field,insertText:s.name,detail:`${s.type}`,documentation:`Column from ${t.specificTable.name}`,range:a})});else if(t.isTableContext)n.forEach(s=>{m.push({label:s.name,kind:D.CompletionItemKind.Class,insertText:s.name,detail:"Table",documentation:`${s.getColumns().length} columns`,range:a})});else if(t.isColumnContext)n.forEach(s=>{s.getColumns().forEach(c=>{m.push({label:`${s.name}.${c.name}`,kind:D.CompletionItemKind.Field,insertText:`${s.name}.${c.name}`,detail:`${c.type}`,documentation:`${s.name}.${c.name}`,range:a})})});else{if(!t.hasSqlKeyword)return[];n.forEach(s=>{m.push({label:s.name,kind:D.CompletionItemKind.Class,insertText:s.name,detail:"Table",range:a}),s.getColumns().forEach(c=>{m.push({label:`${s.name}.${c.name}`,kind:D.CompletionItemKind.Field,insertText:`${s.name}.${c.name}`,detail:`${c.type}`,range:a})})})}return m}function Te(t,n){const a=S(""),m=S([]),s=S([]),c=S(!1),L=()=>{const r=O.get();if(!r)O.set([{projectId:t,lastQuery:a.value}]);else{const o=r.findIndex(d=>d.projectId===t);o===-1?r.push({projectId:t,lastQuery:a.value}):r[o].lastQuery=a.value,O.set(r)}},w=()=>{var o;const r=O.get();return(o=r==null?void 0:r.find(d=>d.projectId===t))==null?void 0:o.lastQuery},$=r=>{if(!r.trim())return;const o=R.get()||[],d={id:`${Date.now()}-${Math.random()}`,query:r.trim(),timestamp:Date.now(),projectId:t},_=o.filter(x=>x.projectId===t),g=o.filter(x=>x.projectId!==t),k=[d,..._].slice(0,50);R.set([...k,...g])},I=()=>(R.get()||[]).filter(o=>o.projectId===t).sort((o,d)=>d.timestamp-o.timestamp),z=()=>{const o=(R.get()||[]).filter(d=>d.projectId!==t);R.set(o)},M=async()=>{c.value=!0;const r=await we.executeQuery(t,a.value,[]);if(L(),$(a.value),c.value=!1,!r)return{returns:{result:[],fields:[]},errors:[]};const{returns:o,errors:d}=r;return s.value=o.fields.map(_=>({title:_.name,key:_.name,dataIndex:_.name,ellipsis:!0})),m.value=o.result.map((_,g)=>{const k={key:`${g+1}`};return Object.entries(_).forEach(([x,U])=>{k[x]=U}),k}),{returns:o,errors:d}};let H=null;const P=()=>{!n.value||n.value.length===0||(H&&H.dispose(),H=D.registerCompletionItemProvider("sql",{provideCompletionItems:(r,o)=>{const d=r.getWordUntilPosition(o),_={startLineNumber:o.lineNumber,endLineNumber:o.lineNumber,startColumn:d.startColumn,endColumn:d.endColumn},g=r.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:o.lineNumber,endColumn:o.column}),k=ke(g,n.value);return{suggestions:xe(k,n.value,_)}}}))};return se(n,()=>{n.value&&n.value.length>0&&P()},{immediate:!0}),{sql:a,data:m,columns:s,loading:c,runSql:M,getLastQuery:w,setLastQuery:L,getHistory:I,clearHistory:z}}const Se={class:"sql-main-card"},Ie={class:"data-dictionary"},Ne={class:"dictionary-header"},Le=["onClick"],De={class:"column-name"},He={class:"column-type"},Qe={class:"sql-editor-container"},je={key:1,class:"history-list"},Ae=["onClick"],Re={class:"history-query"},Ke={class:"history-timestamp"},Oe=ne({__name:"Sql",setup(t){const n=le(),a=n.params.projectId,m=S(null);let s=null;const{tables:c,loading:L}=be(a),{sql:w,data:$,columns:I,loading:z,runSql:M,getLastQuery:H,setLastQuery:P,getHistory:r,clearHistory:o}=Te(a,c),d=S([]),_=S(!1),g=S([]),k=async()=>{const{errors:f}=await M();g.value=r();for(const p of f)G.error({message:E.translate("i18n_sql_execution_failed"),description:p});f.length||G.success({message:E.translate("i18n_sql_execution_succeeded")})},x=()=>{const f=I.value.map(Q=>Q.dataIndex),p=I.value.map(Q=>Q.title),l=$.value.map(Q=>f.map(ee=>Q[ee])),V=`data-${new Date().toISOString()}`;$e({fileName:V,columns:p,rows:l})},U=(f,p)=>{if(!s)return;const l=s.getSelection();if(!l)return;const b=`${f}.${p}`;s.executeEdits("",[{range:l,text:b}]),s.focus()},Y=f=>{s&&(s.setValue(f),w.value=f),_.value=!1},Z=()=>{o(),g.value=[]},X=ae.exports.debounce(P,1e3);return oe(()=>{g.value=r(),s=he.create(m.value,{language:"sql",value:w.value,fontFamily:"monospace",lineNumbers:"on",minimap:{enabled:!1},scrollbar:{vertical:"hidden",horizontal:"visible"},fontSize:14,scrollBeyondLastLine:!1,lineHeight:20,suggestOnTriggerCharacters:!0,quickSuggestions:{other:!0,comments:!1,strings:!1}}),s.onDidChangeModelContent(()=>{!s||(w.value=s.getValue(),X())});const f=n.query.filter;if(f&&typeof f=="string"&&f.trim())w.value=f,s.setValue(f);else{const p=H();p&&(w.value=p,s.setValue(p))}}),(f,p)=>(y(),T(j,null,[i(ve),v("div",Se,[i(e(h),{gap:"middle",style:{width:"100%",height:"100%"}},{default:u(()=>[v("div",Ie,[v("div",Ne,[i(e(ye),{size:16}),v("span",null,C(e(E).translate("i18n_sql_tables")),1)]),e(L)?(y(),N(e(re),{key:0,style:{width:"100%",padding:"20px"}})):(y(),N(e(qe),{key:1,activeKey:d.value,"onUpdate:activeKey":p[0]||(p[0]=l=>d.value=l),ghost:""},{default:u(()=>[(y(!0),T(j,null,F(e(c),l=>(y(),N(e(Ce),{key:l.id,header:l.name},{default:u(()=>[(y(!0),T(j,null,F(l.getColumns(),b=>(y(),T("div",{key:b.id,class:"column-item",onClick:V=>U(l.name,b.name)},[b.primaryKey?(y(),N(e(ge),{key:0,size:12,style:{color:"#faad14"}})):B("",!0),v("span",De,C(b.name),1),v("span",He,C(b.type),1)],8,Le))),128))]),_:2},1032,["header"]))),128))]),_:1},8,["activeKey"]))]),i(e(h),{vertical:"",style:{flex:"1"},gap:"middle"},{default:u(()=>[v("div",Qe,[v("div",{ref_key:"sqlEditor",ref:m,class:"sql-editor"},null,512),i(e(h),{justify:"flex-end",class:"bottom-controls",gap:"small",align:"center"},{default:u(()=>[i(e(h),{gap:"small"},{default:u(()=>[i(K,{size:"small",type:"text",onClick:p[1]||(p[1]=l=>_.value=!0)},{default:u(()=>[i(e(h),{gap:"4",align:"center"},{default:u(()=>[i(e(pe),{size:14}),A(" "+C(e(E).translate("i18n_sql_history")),1)]),_:1})]),_:1})]),_:1}),i(e(h),{gap:"small",align:"center"},{default:u(()=>[i(K,{size:"small",type:"primary",loading:e(z),onClick:k},{default:u(()=>[i(e(h),{gap:"4",align:"center"},{default:u(()=>[A(C(e(E).translate("i18n_sql_run"))+" ",1),i(e(ie),{size:12})]),_:1})]),_:1},8,["loading"])]),_:1})]),_:1})]),i(te,{"outer-style":{width:"100%",height:"calc(100% - 220px)"}},{default:u(()=>[i(e(ue),{scroll:{x:100},"data-source":e($),columns:e(I)},{bodyCell:u(({text:l})=>[typeof l=="object"&&l!==null?(y(),N(e(ce),{key:0,"tree-data":e(Ee)(l),style:{"overflow-x":"scroll"}},null,8,["tree-data"])):(y(),T(j,{key:1},[A(C(l),1)],64))]),_:1},8,["data-source","columns"])]),_:1}),e($).length?(y(),N(e(h),{key:0,justify:"end"},{default:u(()=>[i(K,{onClick:x},{default:u(()=>[i(e(h),{align:"center",gap:"small"},{default:u(()=>[A(C(e(E).translate("i18n_sql_export_to_csv"))+" ",1),i(e(_e))]),_:1})]),_:1})]),_:1})):B("",!0)]),_:1})]),_:1})]),i(e(me),{open:_.value,"onUpdate:open":p[2]||(p[2]=l=>_.value=l),title:e(E).translate("i18n_sql_query_history"),width:"800px",footer:null},{default:u(()=>[i(e(h),{vertical:"",gap:"middle"},{default:u(()=>[i(e(h),{justify:"end"},{default:u(()=>[i(K,{danger:"",size:"small",onClick:Z},{default:u(()=>[A(C(e(E).translate("i18n_sql_clear_history")),1)]),_:1})]),_:1}),g.value.length?(y(),T("div",je,[(y(!0),T(j,null,F(g.value,l=>(y(),T("div",{key:l.id,class:"history-item",onClick:b=>Y(l.query)},[v("div",Re,C(l.query),1),v("div",Ke,C(new Date(l.timestamp).toLocaleString()),1)],8,Ae))),128))])):(y(),N(e(de),{key:0,description:e(E).translate("i18n_sql_no_query_history")},null,8,["description"]))]),_:1})]),_:1},8,["open","title"])],64))}});const ot=fe(Oe,[["__scopeId","data-v-c8d06130"]]);export{ot as default};
//# sourceMappingURL=Sql.d3d1b705.js.map
