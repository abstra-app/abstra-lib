import{f as n,eG as ye,r as le,H as ie,F as he,d as B,b as s,ev as m,w as a,a$ as F,eC as O,eD as k,u as e,v as Y,c,cF as j,ar as y,cN as me,ex as v,bv as ve,eK as ue,e as J,eJ as q,b3 as ke,cn as ce,o as be,L as Se,a as we,ae as U,dm as Ae,cE as z,bV as ne}from"./outputWidgets.1b0059d5.js";import{a as de}from"./asyncComputed.caf7c9b8.js";import{A as Re,s as H}from"./api.f222d8a3.js";import{r as xe}from"./icons.78671e21.js";import{A as D}from"./index.3cfc2497.js";import{t as Ce}from"./ant-design.0066e09b.js";import{A as G}from"./Text.cd11eb70.js";import{A as pe}from"./index.477e5092.js";import{f as Ie}from"./index.ab2427e3.js";import{A as se}from"./Paragraph.c46c31e1.js";import"./index.c7060335.js";import{A as V}from"./Title.161bd13b.js";import"./index.ccafb30a.js";import{T as De,A as Pe}from"./Timeline.9e57b18a.js";import{A as fe,C as ge}from"./CollapsePanel.083b9368.js";import{A as Fe}from"./Link.65e69e81.js";import{A as Oe}from"./index.44592b52.js";import{A as Te}from"./index.bb9378ef.js";import{A as $e}from"./contracts.generated.12ef40b0.js";import"./workspaces.6b05134f.js";import{S as Ee}from"./scripts.f0c4ba5b.js";import"./envVars.ba948828.js";import{F as Ne,A as Le}from"./Form.a07961b6.js";import{E as Ke}from"./ExpandOutlined.139edec3.js";import{C as je}from"./Card.4c57e45a.js";import{l as _e}from"./index.2658e9ab.js";(function(){try{var r=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(r._sentryDebugIds=r._sentryDebugIds||{},r._sentryDebugIds[t]="9d9d5a27-3986-4f62-b2ce-f12ee83ffc33",r._sentryDebugIdIdentifier="sentry-dbid-9d9d5a27-3986-4f62-b2ce-f12ee83ffc33")}catch{}})();var Ve={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM641.7 520.8L442.3 677.6c-7.4 5.8-18.3.6-18.3-8.8V355.3c0-9.4 10.9-14.7 18.3-8.8l199.4 156.7a11.2 11.2 0 010 17.6z"}}]},name:"play-square",theme:"filled"};const qe=Ve;function re(r){for(var t=1;t<arguments.length;t++){var o=arguments[t]!=null?Object(arguments[t]):{},l=Object.keys(o);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(o).filter(function(g){return Object.getOwnPropertyDescriptor(o,g).enumerable}))),l.forEach(function(g){Be(r,g,o[g])})}return r}function Be(r,t,o){return t in r?Object.defineProperty(r,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):r[t]=o,r}var Z=function(t,o){var l=re({},t,o.attrs);return n(ye,re({},l,{icon:qe}),null)};Z.displayName="PlaySquareFilled";Z.inheritAttrs=!1;const oe=Z;function Q(r){switch(r.status){case"waiting":return{color:"blue",text:"Waiting"};case"running":return{color:"processing",text:"Running"};case"finished":return{color:"success",text:"Success"};case"failed":return{color:"error",text:"Failed"};case"abandoned":return{color:"warning",text:"Abandoned"}}}function Ue(){const r=le({state:"closed"});function t(){r.value={state:"closed"}}function o(){r.value={state:"visualizations"}}function l(T,b){r.value={state:"stage-run",stageRun:b}}const g=ie(()=>"stageRun"in r.value?r.value.stageRun:null);return{closeDrawer:t,openVisualizationEditor:o,inspectStageRun:l,drawerState:r,selectedStageRunForDrawer:g}}const M="kanban-selected-stage-ids",L=10;function ze({kanbanRepository:r,storage:t,filterFactory:o}){const l=he([]),g=de(async()=>{try{return await r.getData({selection:l.value,filter:o()})}catch{return l.value=[],await t.set(M,[]),{columns:[],next_stage_options:[]}}});function T(u){const i=u.selected_stage.id,f=l.value.find(w=>w.stage_id===i);return f!=null&&f.limit?f.limit<u.total_count:!1}async function b(u){var f;const i=l.value.find(w=>w.stage_id===u);i&&(i.limit=((f=i.limit)!=null?f:0)+L,await g.refetch())}async function p(u){const i=l.value.find(f=>f.stage_id===u);i&&i.limit&&i.limit>L&&(i.limit-=L,await g.refetch())}async function S(){const u=await t.get(M)||[];l.value=u.map(i=>({stage_id:i,limit:L,offset:0}))}async function h(u,i){u?l.value=[...l.value.slice(0,i),{stage_id:u,limit:L,offset:0}]:l.value=l.value.slice(0,i),await t.set(M,l.value.map(f=>f.stage_id)),await g.refetch()}function $(u,i){var A;const f=(A=u.stages)==null?void 0:A.find(E=>E.id===u.selected_stage.id);if((f==null?void 0:f.type)!=="form")return null;const w=(i==null?void 0:i.status)==="waiting"?{[Re]:i.id}:{};return{path:`/${f.path}`,query:w}}let P=null;const x=async()=>{await S(),g.refetch(),P=setInterval(()=>{g.refetch()},1e3)},C=()=>{P&&clearInterval(P)},I=ie(()=>{var i,f,w;const u=(f=(i=g.result.value)==null?void 0:i.columns)!=null?f:[];return(w=u[u.length-1])==null?void 0:w.selected_stage});return{kanbanAsyncComputed:g,selection:l,seeMore:b,hasPagination:T,seeLess:p,setNewSelectedStageId:h,launchLink:$,lastSelectedStage:I,setup:x,tearDown:C}}const Me={key:0},Je={key:1,class:"terminal"},He=B({__name:"ExecutionInspector",props:{logs:{}},setup(r){return(t,o)=>t.logs.length===0?(s(),m("span",Me)):(s(),m("div",Je,[n(e(D),{vertical:""},{default:a(()=>[(s(!0),m(F,null,O(t.logs,l=>(s(),m("pre",{key:l.executionId,class:"log-text"},k(l.payload.text),1))),128))]),_:1})]))}});const Ge=Y(He,[["__scopeId","data-v-032cbeba"]]),W=B({__name:"StageRunData",props:{data:{}},setup(r){return(t,o)=>(s(),c(e(j),{direction:"vertical",style:{"max-height":"200px","overflow-y":"hidden"}},{default:a(()=>[(s(!0),m(F,null,O(t.data,l=>(s(),c(e(j),{key:l.key},{default:a(()=>[n(e(G),{strong:""},{default:a(()=>[y(k(l.key),1)]),_:2},1024),n(e(me),{"tree-data":e(Ce)(l.value)},null,8,["tree-data"])]),_:2},1024))),128))]),_:1}))}}),We={key:1},Ye={key:1},Ze=["onClick"],Qe=B({__name:"StageRunInspector",props:{stageRun:{},kanbanRepository:{},stageRunRepository:{}},emits:["close"],setup(r,{emit:t}){const o=r;function l(p){return Object.entries(p).map(([S,h])=>({key:S,value:h,type:typeof h}))}const{result:g,loading:T}=de(()=>{var p;return o.kanbanRepository.getLogs((p=o.stageRun)==null?void 0:p.id)}),b=(p,S)=>{var h;p.stopPropagation(),(h=o.stageRunRepository)==null||h.fork(S),t("close")};return(p,S)=>(s(),c(e(Te),{open:"",title:"Thread details",size:"large",onClose:S[0]||(S[0]=h=>t("close"))},{extra:a(()=>[n(e(se),null,{default:a(()=>[n(e(pe),{style:{"font-weight":"600"}},{default:a(()=>{var h;return[y(k(e(Q)({status:(h=p.stageRun)==null?void 0:h.status}).text),1)]}),_:1}),y(" "+k(e(Ie)(new Date(p.stageRun.created_at),{addSuffix:!0})),1)]),_:1})]),default:a(()=>{var h,$,P;return[(h=p.stageRun)!=null&&h.assignee?(s(),c(e(se),{key:0},{default:a(()=>{var x;return[y(" Assignee: "+k((x=p.stageRun)==null?void 0:x.assignee),1)]}),_:1})):v("",!0),(($=p.stageRun)==null?void 0:$.content)&&((P=p.stageRun)==null?void 0:P.content.length)>0?(s(),m("div",We,[n(e(V),{level:4},{default:a(()=>[y("Current data")]),_:1}),n(W,{data:p.stageRun.content},null,8,["data"])])):v("",!0),n(e(V),{level:4,style:{"margin-bottom":"30px"}},{default:a(()=>[y(" Timeline ")]),_:1}),e(T)?(s(),c(e(ve),{key:2})):e(g)?(s(),c(e(De),{key:3},{default:a(()=>[(s(!0),m(F,null,O(e(g),({stage:x,stage_run:C,logs:I})=>(s(),c(e(Pe),{key:C.id},{default:a(()=>[n(e(ge),{ghost:"","expand-icon-position":"end"},{default:a(()=>[n(e(fe),{class:"panel",disabled:!I.length},ue({header:a(()=>[n(e(D),{align:"center",gap:15},{default:a(()=>[n(q,{path:e(H)(x.type)},null,8,["path"]),I.length?(s(),m("span",Ye,k(x.title),1)):(s(),c(e(ke),{key:0,placement:"right",title:"No logs"},{default:a(()=>[y(k(x.title),1)]),_:2},1024))]),_:2},1024)]),default:a(()=>[l(C.data).length||I.length?(s(),c(e(D),{key:0,vertical:""},{default:a(()=>[l(C.data).length?(s(),c(e(D),{key:0,gap:0,vertical:""},{default:a(()=>[n(e(V),{level:5},{default:a(()=>[y(" Input data ")]),_:1}),n(W,{data:l(C.data)},null,8,["data"])]),_:2},1024)):v("",!0),I.length?(s(),c(e(D),{key:1,vertical:"",gap:0},{default:a(()=>[n(e(Oe)),n(e(V),{level:5},{default:a(()=>[y(" Logs ")]),_:1}),n(Ge,{logs:I},null,8,["logs"])]),_:2},1024)):v("",!0)]),_:2},1024)):(s(),c(e(ce),{key:1,description:"No logs"}))]),_:2},[p.stageRunRepository?{name:"extra",fn:a(()=>[J("span",{onClick:u=>b(u,C.id)},[n(e(D),{gap:"small"},{default:a(()=>[n(q,{path:e(xe),width:"22"},null,8,["path"]),n(e(Fe),null,{default:a(()=>[y("Fork")]),_:1})]),_:1})],8,Ze)]),key:"0"}:void 0]),1032,["disabled"])]),_:2},1024)]),_:2},1024))),128))]),_:1})):v("",!0)]}),_:1}))}});const Xe=Y(Qe,[["__scopeId","data-v-82fa62ba"]]),K="Show All",et=[K,...$e];function tt(){const r=le(K);return{filterStatus:r,filterFactory:()=>r.value==K?{}:{status:r.value},labelOption:l=>l==K?K:Q({status:l}).text}}const at={style:{width:"100%",padding:"20px"}},nt={class:"stages-container"},st={class:"stages-content"},rt=["onClick"],ot=B({__name:"Kanban",props:{storage:{},kanbanRepository:{},stageRunRepository:{}},setup(r){const t=r,o=async(w,A,E)=>{w.stopPropagation();const R=await Ee.get(A);!R||await R.run(E)},{filterFactory:l,filterStatus:g,labelOption:T}=tt(),{kanbanAsyncComputed:b,launchLink:p,setNewSelectedStageId:S,lastSelectedStage:h,setup:$,tearDown:P,seeMore:x,hasPagination:C}=ze({kanbanRepository:t.kanbanRepository,storage:t.storage,filterFactory:l});be($),Se(P);const{closeDrawer:I,inspectStageRun:u,drawerState:i,selectedStageRunForDrawer:f}=Ue();return(w,A)=>{const E=we("router-link");return s(),m("div",at,[n(e(D),{vertical:"",style:{height:"100%"}},{default:a(()=>[n(e(ge),{ghost:""},{default:a(()=>[n(e(fe),{header:"Filters"},{default:a(()=>[n(e(Ne),null,{default:a(()=>[n(e(Le),{label:"Status"},{default:a(()=>[n(e(U),{value:e(g),"onUpdate:value":A[0]||(A[0]=R=>Ae(g)?g.value=R:null),style:{width:"300px"}},{default:a(()=>[(s(!0),m(F,null,O(e(et),R=>(s(),c(e(z),{key:R,value:R},{default:a(()=>[y(k(e(T)(R)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),J("div",nt,[J("div",st,[n(e(j),{align:"start"},{default:a(()=>{var R,X,ee;return[(s(!0),m(F,null,O((X=(R=e(b).result.value)==null?void 0:R.columns)!=null?X:[],(d,te)=>(s(),c(e(j),{key:te,direction:"vertical"},{default:a(()=>[n(e(U),{style:{width:"250px"},"allow-clear":"",value:d.selected_stage.id,"onUpdate:value":_=>e(S)(_,te)},{default:a(()=>[(s(!0),m(F,null,O(d.stages,_=>(s(),c(e(z),{key:_.id,value:_.id},{default:a(()=>[n(e(D),{gap:"5"},{default:a(()=>[n(q,{path:e(H)(_.type),style:{"flex-shrink":"0"}},null,8,["path"]),n(e(G),{ellipsis:""},{default:a(()=>[y(k(_.title),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"]),d.selected_stage.id?(s(),c(e(j),{key:0,direction:"vertical",style:{width:"100%"}},{default:a(()=>[(s(!0),m(F,null,O(d.stage_run_cards,_=>{var ae;return s(),c(e(je),{key:_.id,size:"small",style:{"max-width":"250px",cursor:"pointer"},"body-style":{display:((ae=_.content)==null?void 0:ae.length)>0?"block":"none"},onClick:N=>e(u)(d,_)},ue({title:a(()=>[n(e(pe),null,{default:a(()=>[y(k(e(Q)({status:_.status}).text),1)]),_:2},1024)]),default:a(()=>[n(W,{data:_.content},null,8,["data"]),y(" "+k(_.assignee),1)]),extra:a(()=>[n(e(Ke),{onClick:N=>e(u)(d,_)},null,8,["onClick"])]),_:2},[_.status==="waiting"?{name:"actions",fn:a(()=>[e(p)(d,_)?(s(),c(E,{key:0,to:e(p)(d,_),target:"_blank",onClick:A[1]||(A[1]=N=>N.stopPropagation())},{default:a(()=>[n(e(oe))]),_:2},1032,["to"])):v("",!0),d.selected_stage.type==="script"?(s(),m("span",{key:1,onClick:N=>o(N,d.selected_stage.id,_.id)},[n(e(oe))],8,rt)):v("",!0)]),key:"0"}:void 0]),1032,["body-style","onClick"])}),128)),d.stage_run_cards.length===0?(s(),c(e(ce),{key:0})):v("",!0),e(C)(d)?(s(),c(e(ne),{key:1,style:{width:"100%"},onClick:_=>e(x)(d.selected_stage.id)},{default:a(()=>[y("See more")]),_:2},1032,["onClick"])):v("",!0),d.selected_stage.can_be_started&&e(p)(d)!==null?(s(),c(E,{key:2,target:"_blank",to:e(p)(d)},{default:a(()=>[n(e(ne),{style:{width:"100%"}},{default:a(()=>[y(" Start ")]),_:1})]),_:2},1032,["to"])):v("",!0)]),_:2},1024)):v("",!0)]),_:2},1024))),128)),e(b).result.value&&e(b).result.value.next_stage_options.length>0?(s(),c(e(U),{key:(ee=e(h))==null?void 0:ee.id,style:{width:"100%","min-width":"200px"},"allow-clear":"","onUpdate:value":A[2]||(A[2]=d=>e(S)(d,e(b).result.value.columns.length))},{default:a(()=>[(s(!0),m(F,null,O(e(b).result.value.next_stage_options,d=>(s(),c(e(z),{key:d.id,value:d.id},{default:a(()=>[n(e(D),{gap:"middle"},{default:a(()=>[n(q,{path:e(H)(d.type)},null,8,["path"]),n(e(G),null,{default:a(()=>[y(k(d.title),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1})):v("",!0)]}),_:1})])])]),_:1}),e(i).state==="stage-run"&&e(f)?(s(),c(Xe,{key:0,"kanban-repository":t.kanbanRepository,"stage-run":e(f),"stage-run-repository":t.stageRunRepository,onClose:e(I)},null,8,["kanban-repository","stage-run","stage-run-repository","onClose"])):v("",!0)])}}});const Tt=Y(ot,[["__scopeId","data-v-2a074c8a"]]);class $t{constructor(t=_e){this.fetch=t}async getData(t){return(await this.fetch("/_editor/api/kanban",{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}})).json()}async getLogs(t){return(await this.fetch(`/_editor/api/kanban/logs/${t}`)).json()}}class Et{constructor(t,o=_e){this.authProvider=t,this.fetch=o}get headers(){return{"Content-Type":"application/json",...this.authProvider.authHeaders()}}async getData(t){return(await this.fetch("/_kanban/",{method:"POST",body:JSON.stringify(t),headers:this.headers})).json()}async getLogs(t){return(await this.fetch(`/_kanban/logs/${t}`,{headers:this.headers})).json()}}class Nt{constructor(t,o=localStorage){this.contextKey=t,this.storage=o}makeKey(t){return`${this.contextKey}:${t}`}async get(t){const o=this.storage.getItem(this.makeKey(t));return o?JSON.parse(o):null}async set(t,o){this.storage.setItem(this.makeKey(t),JSON.stringify(o))}}export{$t as E,Tt as K,Nt as L,Et as P};
//# sourceMappingURL=repository.9f700ad9.js.map
