var Dt=Object.defineProperty;var $t=(r,e,t)=>e in r?Dt(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var m=(r,e,t)=>($t(r,typeof e!="symbol"?e+"":e,t),t);import{i as D,w as j,a as Mt,s as Gt,b as q,c as k,e as me,f as oe,h as De,j as Ht,k as Bt,r as zt}from"./index.3719e3b6.js";import{r as T,d as z,b as S,eu as E,e as _,aq as ge,eG as ht,f as L,eD as $e,eE as Me,x as F,J as G,K as le,ar as Ge,eC as $,bg as ce,eB as de,ev as he,u as R,ew as W,H as ut,N as pt,a as _e,eO as Ut,ey as te,c as Q,a5 as He,t as H,o as gt,a2 as Ft,ex as jt,eX as Vt,eY as Zt,w as X,aJ as Jt,G as Kt,ez as Qt,eA as qt,eF as Yt}from"./outputWidgets.3f6d0550.js";import{B as Xt}from"./BaseLayout.18cbe6d3.js";import{D as es,m as ts}from"./DashPlayer.deef36bd.js";import{R as ss,S as rs,L as os}from"./SmartConsole.f95cdbd8.js";import{x as is,i as ns,y as Ie,z as Pe,A as as,B as ls,C as cs}from"./icons.51140278.js";import{a as ds}from"./asyncComputed.bd80460e.js";import{D as hs}from"./dashes.e5b250f4.js";import{W as us}from"./workspaces.3b4ce0c9.js";import{_ as ps}from"./LaunchButton.vue_vue_type_script_setup_true_lang.912acdd7.js";import{_ as gs}from"./SaveButton.vue_vue_type_script_setup_true_lang.1a93becf.js";import{_ as fs}from"./DocsButton.vue_vue_type_script_setup_true_lang.5cd072ac.js";import{d as vs,w as B,r as Be,i as Le,a as ms,v as ys,b as ft,p as Ye,c as ws}from"./geometryUtils.b244a3e3.js";import{k as Ss,s as Y,a as Xe,c as fe,m as _s}from"./keyboard.3c6325aa.js";import{u as Ee}from"./uuid.f20985fc.js";import{P as ze}from"./pubsub.0f07f3a4.js";import{c as Es}from"./index.18a73dee.js";import{A as et,T as bs}from"./TabPane.3fcb202a.js";import"./executeJs.9903c152.js";import"./index.d8e2f1bc.js";import"./CircularLoading.2945792d.js";import"./PlayerNavbar.cbedb682.js";import"./Steps.f8152f0d.js";import"./WidgetsFrame.1cd54435.js";import"./forms.a3b5b703.js";import"./activeRecord.4331371e.js";import"./hooks.16f451e3.js";import"./jobs.dcdde26a.js";import"./Title.d85134a2.js";import"./index.9fce520b.js";import"./url.980858d4.js";import"./ant-design.003e27e5.js";import"./index.dee2e461.js";(function(){try{var r=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(r._sentryDebugIds=r._sentryDebugIds||{},r._sentryDebugIds[e]="cb3a9657-8b58-46a5-a833-abc3e6b48465",r._sentryDebugIdIdentifier="sentry-dbid-cb3a9657-8b58-46a5-a833-abc3e6b48465")}catch{}})();const C={left:20,right:20,top:20,bottom:200};class Ue{constructor(e){m(this,"_state");m(this,"_projectedElement",null);m(this,"grid");this.grid=e,this._state=T({x:0,y:0,zoom:1})}get x(){return this._state.value.x}set x(e){if(Number.isNaN(e))throw new Error("x is NaN");this._state.value.x=e}get y(){return this._state.value.y}set y(e){if(Number.isNaN(e))throw new Error("y is NaN");this._state.value.y=e}static create(e){return new Ue(e)}setProjectedCanvas(e){this._projectedElement=e,this.fit()}get projectedElement(){if(!this._projectedElement)throw new Error("Camera has no projected element");return this._projectedElement}updateGrid(e){this.grid=e}get zoom(){return this._state.value.zoom}set zoom(e){if(e<=0)throw new Error("Zoom must be positive");this._state.value.zoom=e}fit(){if(!this.grid.width)throw new Error(`Grid width is ${this.grid.width}}`);if(!this.grid.height)throw new Error(`Grid height is ${this.grid.height}`);const e=this.canvasRect,t=Math.max(e.width-C.left-C.right,1),s=Math.max(e.height-C.top-C.bottom,1);this.zoom=1;const o=Math.min(t/this.grid.width,s/this.grid.height);this.zoomIn(o,{x:e.x+e.width/2,y:e.y+e.height/2,referential:"screen"}),this.x=t>this.grid.width*o?-(e.x+e.width/2-o*this.grid.width/2)/o:-(e.x+C.left)/o,this.y=s<this.grid.height*o?-(e.y+C.top)/o:-(e.y+e.height/2-o*this.grid.height/2)/o}screenPoint2world(e){return{x:e.x/this.zoom+this.x,y:e.y/this.zoom+this.y,referential:"world"}}worldPoint2screen(e){return{x:(e.x-this.x)*this.zoom,y:(e.y-this.y)*this.zoom,referential:"screen"}}screenDelta2world(e){return{dx:e.dx/this.zoom,dy:e.dy/this.zoom,referential:"world"}}worldDelta2screen(e){return{dx:e.dx*this.zoom,dy:e.dy*this.zoom,referential:"screen"}}screenRect2world(e){const t=this.screenPoint2world({x:e.x,y:e.y,referential:e.referential}),s=this.screenPoint2world({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:s.x-t.x,height:s.y-t.y,referential:t.referential}}worldRect2screen(e){const t=this.worldPoint2screen({x:e.x,y:e.y,referential:e.referential}),s=this.worldPoint2screen({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:s.x-t.x,height:s.y-t.y,referential:t.referential}}zoomIn(e,t){const s=this.screenPoint2world(t);this.zoom*=e;const o=this.worldPoint2screen(s),n=vs(t,o),i=this.screenDelta2world({dx:n.dx,dy:n.dy,referential:"screen"});this.x+=i.dx,this.y+=i.dy,this.correct()}translate(e,t=!0){this.x+=e.dx,this.y+=e.dy,t&&this.correct()}get canvasRect(){if(!this._projectedElement)throw new Error("No canvas element");const e=this._projectedElement.getBoundingClientRect();return{x:e.x,y:e.y,width:e.width,height:e.height,referential:"screen"}}correctZoom(){const e=this.canvasRect,t=Math.max(e.width-C.left-C.right,0),s=Math.max(e.height-C.top-C.bottom,0),o=Math.min(t/this.grid.width,s/this.grid.height);this.zoom<o&&(this.zoom=o)}correct(){this.correctZoom();const e=this.worldRect2screen({x:0,y:0,width:this.grid.width,height:this.grid.height,referential:"world"}),t=this.canvasRect,s=e.x>t.x+C.left,o=e.x+e.width<t.x+t.width-C.right,n=e.x+e.width/2-(t.x+t.width/2),i=e.width>t.width,l=e.height>t.height,c=e.y+e.height<t.y+t.height-C.bottom,a=e.y>t.y+C.top,u=e.y+e.height/2-(t.y+t.height/2),p=this.screenDelta2world({dx:i?o&&s?0:s?e.x-t.x-C.right:o?e.x+e.width-(t.x+t.width)+C.left:0:n,dy:l?c&&a?0:a?e.y-t.y-C.top:c?e.y+e.height-(t.y+t.height)+C.bottom:0:u,referential:"screen"});this.x+=p.dx,this.y+=p.dy}}const Is=r=>($e("data-v-fb3c93ab"),r=r(),Me(),r),Ps={class:"dash-settings"},Rs={class:"dash-property"},xs=Is(()=>_("label",{class:"property-label"},"Name",-1)),Ls=z({__name:"DashSettings",props:{dash:{}},setup(r){return(e,t)=>(S(),E("div",Ps,[_("div",Rs,[xs,ge(_("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>e.dash.title=s),class:"property-input",placeholder:"Enter a name"},null,512),[[ht,e.dash.title]])]),L(ss,{runtime:e.dash},null,8,["runtime"])]))}});const Os=F(Ls,[["__scopeId","data-v-fb3c93ab"]]),Ns={class:"zoom-bar"},As={class:"zoom-value"},Ts=z({__name:"ZoomBar",props:{camera:{}},emits:["hover","leave"],setup(r,{emit:e}){const t=r,s=T(!1),o=T(null),n=()=>{var a;(a=t.camera)==null||a.zoomIn(1.1,{x:document.body.offsetWidth/2,y:document.body.offsetHeight/2,referential:"screen"})},i=()=>{var a;(a=t.camera)==null||a.zoomIn(.9,{x:document.body.offsetWidth/2,y:document.body.offsetHeight/2,referential:"screen"})},l=G(()=>{var c,a;return`${Math.floor(((a=(c=t.camera)==null?void 0:c.zoom)!=null?a:1)*100)}%`});return le(()=>{var c;return(c=t.camera)==null?void 0:c.zoom},()=>{clearTimeout(o.value),s.value=!0,o.value=setTimeout(()=>s.value=!1,3e3)}),(c,a)=>ge((S(),E("div",{class:"zoom-bar-wrapper",onMouseover:a[0]||(a[0]=u=>e("hover")),onMouseleave:a[1]||(a[1]=u=>e("leave"))},[_("div",Ns,[_("span",{class:"zoom-control",onClick:i},"-"),_("span",As,$(l.value),1),_("span",{class:"zoom-control",onClick:n},"+")])],544)),[[Ge,c.camera&&s.value]])}});const Cs=F(Ts,[["__scopeId","data-v-f937a967"]]),tt={PandasDataFrame:"https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html",PlotlyFigure:"https://plotly.com/python-api-reference/generated/plotly.graph_objects.Figure.html","datetime.time":"https://docs.python.org/3/library/datetime.html#datetime.time","datetime.date":"https://docs.python.org/3/library/datetime.html#datetime.date","io.IOBase":"https://docs.python.org/3/library/io.html#io.IOBase","time.struct_time":"https://docs.python.org/3/library/time.html#time.struct_time"},ks="#E286A3",Ws="#EF9542",Ds="#B462DB",$s="#40B6D3",Ms="#6FB96E",Gs=[ks,Ws,Ds,$s,Ms];function st(r){let e=r;return Object.keys(tt).forEach(t=>{if(r.includes(t)){const s=tt[t];e=e.replace(t,`<a href="${s}" target="_blank">${t}</a>`)}}),e}const ie={},Hs=r=>e=>{if(ie[e])return ie[e];const t=Object.keys(ie).length%r.length;return ie[e]=r[t],r[t]},rt=Hs([...Gs]),Bs=()=>{Object.keys(ie).forEach(r=>delete ie[r])};class zs{constructor(){m(this,"globalEventListeners",[])}addGlobalEventListener(e,t){addEventListener(e,t),this.globalEventListeners.find(s=>s.evt===e)||this.globalEventListeners.push({evt:e,handler:t})}removeGlobalEventListeners(){this.globalEventListeners.forEach(({evt:e,handler:t})=>{removeEventListener(e,t)}),this.globalEventListeners=[]}}const Us={class:"param-types"},Fs=["innerHTML"],js={key:1,class:"prop-type"},Vs=["innerHTML"],Zs=z({__name:"ParamTypes",props:{param:{}},setup(r){return(e,t)=>(S(),E("div",Us,[e.param&&e.param.typeDescription?(S(!0),E(ce,{key:0},de(e.param.typeDescription,s=>(S(),E("div",{key:s,class:"prop-type"},[_("p",{class:"type",style:he({color:R(rt)(s)}),innerHTML:R(st)(s)},null,12,Fs)]))),128)):e.param&&e.param.typeName?(S(),E("div",js,[_("p",{class:"type",style:he({color:R(rt)(e.param.typeName)}),innerHTML:R(st)(e.param.typeName)},null,12,Vs)])):W("",!0)]))}});const ot=F(Zs,[["__scopeId","data-v-d6aed39d"]]),Js=["value","placeholder"],Ks=["value","placeholder"],Qs=z({__name:"PythonPropInputRaw",props:{hasError:{type:Boolean},placeholder:{},value:{},paramName:{},isCode:{type:Boolean},commit:{type:Function}},emits:["input","change","clearSuggestions"],setup(r,{emit:e}){const t=r,s=ut({isActive:!1,hasChanges:!1}),o=c=>{e("input",c),s.hasChanges=!0},n=()=>{s.isActive=!1,e("clearSuggestions")},i=c=>{c.preventDefault();const a=c.target,u=a.selectionStart,p=a.selectionEnd,d=a.value;a.value=d.substring(0,u)+"	"+d.substring(p),a.selectionStart=a.selectionEnd=u+1,a.dispatchEvent(new Event("input"))},l=c=>{t.commit(c),s.hasChanges=!1};return pt(()=>{s.hasChanges&&t.commit(t.value)}),(c,a)=>{var p,d;const u=_e("icon");return S(),E("div",{class:te(["input-container",{error:c.hasError}])},[L(u,{path:R(is),class:"icon",fill:c.hasError?"#D35249":s.isActive?"#3482E5":void 0},null,8,["path","fill"]),c.isCode?(S(),E("textarea",{key:0,value:c.value,class:"prop-input",placeholder:(p=c.placeholder)!=null?p:void 0,onInput:a[0]||(a[0]=h=>o(h.target.value)),onClick:a[1]||(a[1]=h=>s.isActive=!0),onBlur:n,onKeydown:a[2]||(a[2]=Ut(h=>i(h),["tab"])),onChange:a[3]||(a[3]=h=>l(h.target.value))},null,40,Js)):(S(),E("input",{key:1,value:c.value,class:"prop-input",placeholder:(d=c.placeholder)!=null?d:void 0,onInput:a[4]||(a[4]=h=>o(h.target.value)),onClick:a[5]||(a[5]=h=>s.isActive=!0),onBlur:n,onChange:a[6]||(a[6]=h=>l(h.target.value))},null,40,Ks))],2)}}});const qs=F(Qs,[["__scopeId","data-v-d30fa88e"]]),Ys={class:"suggestions"},Xs=["onMousedown"],er=z({__name:"PythonAutoCompleteSuggestions",props:{suggestions:{}},emits:["select"],setup(r,{emit:e}){return(t,s)=>ge((S(),E("div",Ys,[(S(!0),E(ce,null,de(t.suggestions,o=>(S(),E("div",{key:o,class:"suggestion",onMousedown:n=>e("select",o)},$(o),41,Xs))),128))],512)),[[Ge,t.suggestions.length]])}});const tr=F(er,[["__scopeId","data-v-afec000d"]]),sr={class:"python-wrapper"},rr=z({__name:"PythonPropInput",props:{hasError:{type:Boolean},placeholder:{},value:{},paramName:{},dashPlayerService:{},isCode:{type:Boolean},commit:{type:Function}},emits:["input"],setup(r,{emit:e}){const t=r,s=G(()=>t.dashPlayerService.suggestionsFor),o=G(()=>t.dashPlayerService.suggestions),n=a=>{l(t.paramName,a),e("input",a)},i=a=>{c(),e("input",a),t.commit(a)},l=async(a,u)=>{!u||t.dashPlayerService.getAutocompleteSuggestions(a,u)},c=async()=>{await He(),t.dashPlayerService.clearSuggestions()};return(a,u)=>(S(),E("div",sr,[L(qs,{value:a.value,commit:a.commit,"is-code":a.isCode,"param-name":a.paramName,"dash-player-service":a.dashPlayerService,onInput:n,onClearSuggestions:c},null,8,["value","commit","is-code","param-name","dash-player-service"]),s.value===a.paramName?(S(),Q(tr,{key:0,suggestions:o.value,onSelect:i},null,8,["suggestions"])):W("",!0)]))}});const Re=F(rr,[["__scopeId","data-v-63688ff1"]]),or={name:"If Block",description:"A block of elements that is only rendered depending on a condition",params:[{typeName:"Boolean",description:"The condition to check",argName:"condition",isKwarg:!1,default:null}],defaultEditProps:{condition:!0},thumbname:"IfBlock.svg"},ae={"if-block":or},J=r=>($e("data-v-718f02de"),r=r(),Me(),r),ir={class:"wrapper"},nr={class:"title"},ar={key:0,class:"widget-prop"},lr=J(()=>_("h2",null,"Error",-1)),cr=J(()=>_("p",{class:"section-description"},"Some errors were found while computing the widget.",-1)),dr=["textContent"],hr={key:1,class:"section"},ur=J(()=>_("h2",null,"VARIABLE",-1)),pr={key:0,class:"section-content"},gr={class:"widget-prop"},fr=J(()=>_("p",{class:"prop-label"},"Bind a variable",-1)),vr=J(()=>_("p",{class:"prop-description"},"Create a variable to be controlled by this widget.",-1)),mr={class:"input-container"},yr={key:0,class:"variable-error prop-error"},wr=J(()=>_("pre",null,"Variable not defined",-1)),Sr={key:1,class:"prop-error",textContent:"SyntaxError: This field must be a variable name"},_r=["textContent"],Er={key:2,class:"section"},br=J(()=>_("h2",null,"EVENTS",-1)),Ir={key:0,class:"section-content"},Pr=J(()=>_("p",{class:"section-description"}," Each event is a Python code that runs on specified situations ",-1)),Rr={class:"prop-label"},xr={class:"prop-description"},Lr={class:"section"},Or=J(()=>_("h2",null,"PROPERTIES",-1)),Nr={key:0,class:"section-content"},Ar=J(()=>_("p",{class:"section-description"}," Each property is a Python expression, make sure to use the correct syntax. ",-1)),Tr={class:"prop-label"},Cr={class:"prop-description"},kr=["textContent"],Wr=J(()=>_("div",{class:"feedback"},null,-1)),Dr=[Wr],it=402,$r=z({__name:"WidgetEditor",props:{selectedWidgetErrors:{},layoutModel:{},selectedWidgets:{},dashPlayerService:{}},emits:["close","create-variable"],setup(r,{emit:e}){const t=r,s=T(null);le(()=>t.selectedWidgetErrors,()=>{s.value=null});const o=w=>{g.openedSections.includes(w)?g.openedSections=g.openedSections.filter(b=>b!==w):g.openedSections.push(w)},n=w=>g.openedSections.includes(w),i=w=>D(w)?j[w.type].name:ae[w.type].name,l=G(()=>s.value===null?t.selectedWidgetErrors:s.value==="variable"?H.exports.omit(t.selectedWidgetErrors,"variable"):{...t.selectedWidgetErrors,props:H.exports.omit(t.selectedWidgetErrors.props,s.value)}),c=G(()=>a.value.type.includes("-input")&&a.value.type!=="click-input"),a=G(()=>t.selectedWidgets[0]),u=G(()=>{var P;if(!D(a.value))return;const b=((P=j[a.value.type].pythonAPI.params)!=null?P:[]).find(O=>O.argName==="initial_value");return b||null});function p(w){this.style.height="0",this.style.height=this.scrollHeight-24+"px"}const d=new zs,h=T(null),g=ut({isActive:!1,resizing:!1,width:it,openedSections:["properties","variable"]});gt(()=>{h.value&&(d.addGlobalEventListener("mouseup",()=>g.resizing=!1),d.addGlobalEventListener("mousemove",P=>v(P))),document.querySelectorAll(".widget-props-editor textarea").forEach(P=>{!P||(P.setAttribute("style","height:"+(P.scrollHeight-24)+"px;overflow-y:hidden;"),P.addEventListener("input",p,!1))})}),Ft(()=>{Bs(),d.removeGlobalEventListeners()});const v=w=>{g.resizing&&(g.width=Math.max(g.width-w.movementX,it))},y=G(()=>({width:`${g.width}px`})),f=w=>ae[w.type].params,I=G(()=>{const w=(O,U)=>O.argName===U.argName&&O.typeName===U.typeName,b=(O,U,x)=>x.findIndex(re=>w(O,re))===U,P=O=>!O.formOnly;return t.selectedWidgets.flatMap(O=>{var U;return D(O)?(U=j[O.type])==null?void 0:U.pythonAPI.params:f(O)}).filter(Boolean).filter(P).filter(b)}),K=G(()=>{const w=(P,O)=>P.key===O.key,b=(P,O,U)=>U.findIndex(x=>w(P,x))===O;return t.selectedWidgets.flatMap(P=>{var O;return D(P)?(O=j[P.type])==null?void 0:O.events:[]}).filter(Boolean).filter(b).filter(P=>P.key!=="change")}),Rt=w=>{t.layoutModel.updateVariable(w,a.value.id),s.value="variable"},xt=w=>b=>{t.layoutModel.updateProp({param:w,value:b},t.selectedWidgets.map(P=>P.id)),s.value=w.argName},Lt=w=>b=>{t.layoutModel.updateEvent({event:w,value:b},t.selectedWidgets.map(P=>P.id))},Ot=()=>{var w,b;return(b=(w=l.value.variable)==null?void 0:w.repr)==null?void 0:b.includes("SyntaxError")},Nt=()=>{var w,b;return(b=(w=l.value.variable)==null?void 0:w.repr)==null?void 0:b.includes("NameError")},At=w=>{!w||(t.dashPlayerService.sendVariableCreated(w),e("create-variable",w))},Tt=()=>{var w,b;return((w=l.value.widget)==null?void 0:w.repr)&&!Object.values((b=l.value.props)!=null?b:{}).some(P=>P.repr)},Ct=()=>{var w;return(w=l.value.widget)==null?void 0:w.repr},be=w=>{var b,P;return(P=(b=l.value.props)==null?void 0:b[w])==null?void 0:P.repr},kt=w=>H.exports.upperFirst(w.replace(/_/g," "));return(w,b)=>{var O,U;const P=_e("icon");return S(),E("div",{class:"widget-props-editor",style:he(y.value)},[_("div",ir,[_("div",nr,[_("h1",null,$(i(a.value)),1),L(P,{path:R(ns),fill:"#414A58",class:"close-icon",width:"16",height:"16",onClick:b[0]||(b[0]=x=>e("close"))},null,8,["path"])]),Tt()?(S(),E("div",ar,[lr,cr,_("pre",{class:"prop-error",textContent:$(Ct())},null,8,dr)])):W("",!0),c.value?(S(),E("div",hr,[_("div",{class:"section-header",onClick:b[1]||(b[1]=x=>o("variable"))},[L(P,{path:n("variable")?R(Ie):R(Pe),fill:"#414A58",class:"chevron-icon",width:"16",height:"16"},null,8,["path"]),ur]),n("variable")?(S(),E("div",pr,[_("div",gr,[fr,vr,_("div",mr,[L(Re,{placeholder:"variable_name","param-name":"variable","dash-player-service":w.dashPlayerService,value:(O=a.value.variable)!=null?O:"",commit:Rt,"is-code":!1,onInput:b[2]||(b[2]=x=>a.value.variable=x)},null,8,["dash-player-service","value"])]),Nt()&&a.value.variable?(S(),E("div",yr,[wr,_("button",{onClick:b[3]||(b[3]=x=>At(a.value.variable))}," Create ")])):Ot()?(S(),E("pre",Sr)):(U=l.value.variable)!=null&&U.repr?(S(),E("pre",{key:2,class:"prop-error",textContent:$(l.value.variable.repr)},null,8,_r)):W("",!0),L(ot,{param:u.value},null,8,["param"])])])):W("",!0)])):W("",!0),K.value.length?(S(),E("div",Er,[_("div",{class:"section-header",onClick:b[4]||(b[4]=x=>o("events"))},[L(P,{path:n("events")?R(Ie):R(Pe),fill:"#414A58",class:"chevron-icon",width:"16",height:"16"},null,8,["path"]),br]),n("events")?(S(),E("div",Ir,[Pr,(S(!0),E(ce,null,de(K.value,x=>(S(),E("div",{key:x.key,class:"widget-prop"},[_("label",Rr,"On "+$(x.key),1),_("p",xr,"Executed after "+$(x.key),1),L(Re,{"param-name":x.key,"dash-player-service":w.dashPlayerService,value:a.value.events[x.key],commit:Lt(x),"is-code":!0,onInput:re=>a.value.events[x.key]=re},null,8,["param-name","dash-player-service","value","commit","onInput"])]))),128))])):W("",!0)])):W("",!0),_("div",Lr,[_("div",{class:"section-header",onClick:b[5]||(b[5]=x=>o("properties"))},[L(P,{path:n("properties")?R(Ie):R(Pe),fill:"#414A58",class:"chevron-icon",width:"16",height:"16"},null,8,["path"]),Or]),n("properties")?(S(),E("div",Nr,[Ar,(S(!0),E(ce,null,de(I.value,x=>{var re;return S(),E("div",{key:x.argName,class:"widget-prop"},[_("p",Tr,$(kt(x.argName)),1),_("p",Cr,$(x.description),1),L(Re,{"has-error":!!be(x.argName),placeholder:(re=x.default)!=null?re:void 0,"param-name":x.argName,"dash-player-service":w.dashPlayerService,value:a.value.props[x.argName],commit:xt(x),"is-code":!0,onInput:Wt=>a.value.props[x.argName]=Wt},null,8,["has-error","placeholder","param-name","dash-player-service","value","commit","onInput"]),be(x.argName)?(S(),E("pre",{key:0,class:"prop-error",textContent:$(be(x.argName))},null,8,kr)):W("",!0),L(ot,{param:x},null,8,["param"])])}),128))])):W("",!0)])]),_("div",{ref_key:"handlerRef",ref:h,class:"handler",onMousedown:b[6]||(b[6]=jt(x=>g.resizing=!0,["stop"]))},Dr,544)],4)}}});const Mr=F($r,[["__scopeId","data-v-718f02de"]]),vt=r=>($e("data-v-0d595f79"),r=r(),Me(),r),Gr={class:"interact-menu"},Hr={class:"icon-container"},Br=vt(()=>_("span",{class:"edit"},"Edit [Shift + P]",-1)),zr={class:"icon-container"},Ur=vt(()=>_("span",null,"Interact [Shift + P]",-1)),Fr=z({__name:"InteractMenu",props:{isPreview:{type:Boolean}},emits:["changePreview"],setup(r,{emit:e}){return(t,s)=>{const o=_e("icon");return S(),E("div",Gr,[_("div",Hr,[L(o,{class:te(["icon",{active:!t.isPreview}]),path:R(as),fill:"#5A677A",onClick:s[0]||(s[0]=n=>e("changePreview",!1))},null,8,["class","path"]),Br]),_("div",zr,[L(o,{class:te(["icon",{active:t.isPreview}]),path:R(ls),fill:"#5A677A",onClick:s[1]||(s[1]=n=>e("changePreview",!0))},null,8,["class","path"]),Ur])])}}});const jr=F(Fr,[["__scopeId","data-v-0d595f79"]]),Vr={class:"header"},Zr={key:0},Jr={key:1},Kr={key:2,class:"state"},Qr={key:3,class:"state"},qr={key:4,class:"state"},Yr={key:5},Xr=z({__name:"RuntimeHeader",props:{dash:{},dashPlayerService:{}},setup(r){return(e,t)=>(S(),E("div",Vr,[e.dash.title?(S(),E("p",Zr,$(e.dash.title),1)):(S(),E("p",Jr,$(e.dash.path),1)),e.dashPlayerService.state.type==="RUNNING"?(S(),E("p",Kr,"\u{1F7E2} running")):e.dashPlayerService.state.type==="ERROR"?(S(),E("p",Qr,"\u274C error")):e.dashPlayerService.state.type==="AUTHENTICATING"?(S(),E("p",qr," \u{1F510} authenticating ")):e.dashPlayerService.state.type==="IDLE"?(S(),E("p",Yr,"\u23F3 loading")):W("",!0)]))}});const eo=F(Xr,[["__scopeId","data-v-eae88304"]]),to={key:0,class:"widget-metadata-card"},so=["src"],ro={class:"metadata-title"},oo={class:"metadata-description"},io={key:1,class:"collapsed-widget-metadata-card"},no=["src"],ao=z({__name:"WidgetMetadataCard",props:{metadata:{},collapsed:{type:Boolean}},setup(r){const e=window.__baseURL?`${window.__baseURL}/media`:"",t=o=>o in ae?`${e}/${ae[o].thumbname}`:`${e}/widget-thumbs/${Mt(o)}.svg`,s=window.__vscodeTheme===2?"dark":"light";return(o,n)=>o.collapsed?(S(),E("div",io,[_("img",{class:"metadata-thumbnail",src:t(o.metadata.type),style:he(R(s)==="dark"?{filter:"invert(1)"}:"")},null,12,no)])):(S(),E("div",to,[_("img",{class:"metadata-thumbnail",src:t(o.metadata.type),style:he(R(s)==="dark"?{filter:"invert(1)"}:"")},null,12,so),_("div",ro,$(o.metadata.name),1),_("div",oo,$(o.metadata.description),1)]))}});const lo=F(ao,[["__scopeId","data-v-2b654c57"]]),ve={"click-input":-1,"text-output":0,"number-input":1,"text-input":2,"link-output":3,"multiple-choice-input":4,"file-input":5,"email-input":6,"markdown-output":7,"dropdown-input":8,"date-input":9,"cards-input":10,"textarea-input":11,"list-input":12,"file-output":13,"html-output":14,"pandas-output":15,"checkbox-input":16,"cnpj-input":17,"code-input":18,"progress-output":19,"pandas-row-selection-input":20,"image-input":21,"password-input":22,"currency-input":23,"iframe-output":24,"checklist-input":25,"image-output":26,"nps-input":27,"phone-input":28},co=z({__name:"WidgetsMetadataList",emits:["dragstart","hover","leave"],setup(r,{emit:e}){const t=T(""),s=T(),o=T(!0),n=()=>{o.value=!1},i=()=>{o.value=!0,c()},l=async()=>{await He(),s.value&&s.value.focus()},c=()=>{t.value=""},a=Object.values(j).concat(Object.entries(ae).map(([d,h])=>({type:d,...h}))).reduce((d,h)=>h.formOnly?d:{...d,[h.type]:h},{}),u=G(()=>t.value?Object.values(a).map(d=>({widget:d,score:Gt(d,t.value.split(" "))})).filter(({score:d})=>d>0).sort(({score:d},{score:h})=>h-d).map(({widget:d})=>d):Object.values(a).sort((d,h)=>{const g=d.type,v=h.type;if(g in ve){if(!(v in ve))return-1}else return 1;return ve[g]-ve[v]}));function p(d,h){e("dragstart",d,h)}return(d,h)=>{const g=_e("icon");return S(),E("div",{class:"widgets-metadata",onMouseover:n,onMouseleave:i},[_("div",Vt({class:["search",{collapsed:o.value}]},Zt(o.value?{click:l}:{},!0)),[L(g,{path:R(cs),class:"search-icon"},null,8,["path"]),o.value?W("",!0):ge((S(),E("input",{key:0,ref_key:"searchInput",ref:s,"onUpdate:modelValue":h[0]||(h[0]=v=>t.value=v),type:"search",class:"widgets-metadata-filter",placeholder:"Find widgets"},null,512)),[[ht,t.value]])],16),_("div",{class:te(["widgets-metadata-list",{collapsed:o.value}])},[(S(!0),E(ce,null,de(u.value,v=>(S(),Q(lo,{key:v.type,metadata:v,draggable:!0,collapsed:o.value,onDragstart:y=>p(y,v.type)},{default:X(()=>[Jt($(v.type),1)]),_:2},1032,["metadata","collapsed","onDragstart"]))),128))],2)],32)}}});const ho=F(co,[["__scopeId","data-v-a17e6382"]]),uo={class:"dash-layout-editor"},po=z({__name:"DashLayoutEditor",props:{dash:{},params:{},dashEditorService:{},workspace:{}},emits:["navigate","create-variable","change-preview"],setup(r,{emit:e}){const t=r,s=T(null),o=T(null),n=(f,I)=>t.dashEditorService.metadataDragStart(f,I),i=f=>e("navigate",f),l=f=>e("create-variable",f),c=f=>e("change-preview",f);t.dashEditorService.pubsub.subscribe("change-preview",c);const a=()=>{t.dashEditorService.hoverZoomBar()},u=()=>{t.dashEditorService.leaveZoomBar()};le(t.dash.layout,()=>{t.dashEditorService.layoutModel.setLayout(t.dash.layout)}),t.dashEditorService.setupOnSave(),le(t.dashEditorService.layoutModel,()=>t.dashEditorService.setupOnSave());const p=G(()=>t.dashEditorService.getWidgetsWithErrors()),d=G(()=>t.dashEditorService.getSelectedWidgetErrors()),h=T(null),g=T(null),v=T(null),y=T(null);return gt(()=>{t.dashEditorService.selection.setLayoutModel(t.dashEditorService.layoutModel),v.value&&y.value&&g.value&&o.value&&s.value&&h.value&&t.dashEditorService.setup(v.value,y.value,g.value,o.value,s.value,h.value)}),pt(()=>{t.dashEditorService.tearDown()}),le(()=>t.dashEditorService.dashPlayerService.isAuthenticating(),f=>{f&&(t.dashEditorService.isPreview=!0)}),(f,I)=>(S(),E("div",uo,[ge(L(ho,{onDragstart:n},null,512),[[Ge,!f.dashEditorService.isPreview]]),_("div",{ref_key:"editor",ref:v,class:te(["editor"])},[_("div",{ref_key:"listeners",ref:y,class:"listeners",tabindex:"0"},[L(es,{ref_key:"player",ref:s,class:te(["player",{preview:f.dashEditorService.isPreview}]),style:{top:0,left:0,height:"unset"},"is-preview":!0,params:f.params,camera:f.dashEditorService.camera,"editing-mode":!f.dashEditorService.isPreview,"force-responsivity":"desktop","widgets-with-errors":p.value,"dash-player-service":f.dashEditorService.dashPlayerService,onNavigate:i},null,8,["class","params","camera","editing-mode","widgets-with-errors","dash-player-service"]),_("canvas",{ref_key:"canvas",ref:g,class:te(["layout-canvas",{hide:f.dashEditorService.isPreview}])},null,2)],512),L(eo,{ref_key:"runtimeHeader",ref:h,dash:f.dash,"dash-player-service":f.dashEditorService.dashPlayerService},null,8,["dash","dash-player-service"]),L(jr,{ref_key:"interactMenu",ref:o,class:"interact-menu","is-preview":f.dashEditorService.isPreview,onChangePreview:c},null,8,["is-preview"])],512),(f.dashEditorService.selection.selectedWidgetsIds.length>0||f.dashEditorService.selection.selectedSlottableId)&&!f.dashEditorService.isPreview&&f.dashEditorService.mouseState.state==="IDLE"?(S(),Q(Mr,{key:0,"selected-widget-errors":d.value,"layout-model":f.dashEditorService.layoutModel,"selected-widgets":f.dashEditorService.selection.selectedSlottable?[f.dashEditorService.selection.selectedSlottable]:f.dashEditorService.selection.selectedWidgets,"dash-player-service":f.dashEditorService.dashPlayerService,onClose:I[0]||(I[0]=K=>f.dashEditorService.selection.resetSelection()),onCreateVariable:l},null,8,["selected-widget-errors","layout-model","selected-widgets","dash-player-service"])):W("",!0),L(Cs,{camera:f.dashEditorService.camera,class:"zoom-bar",onHover:a,onLeave:u},null,8,["camera"])]))}});const go=F(po,[["__scopeId","data-v-c2191cda"]]),fo="rgba(0, 128, 233, 0.05)";class ue{constructor(e,t){m(this,"context");this.canvas=e,this.context=this.canvas.getContext("2d"),t.slottableRenderer.setContext(this.context)}static create(e,t){return new ue(e,t)}render({mouseState:e,dashEditorService:t,hoverState:s,resizeHandlerRects:o,widgetsInRectangularSelection:n,selectedWidgets:i,computedState:l,isPreview:c,calculatedPositions:a,selectedSlottable:u}){const p=t.camera,d=t.dashPlayerService.layoutGrid,h=t.dashPlayerService.calculatePositions();if(t.dashPlayerService.state.type==="RUNNING"){if(!p)throw new Error("No camera value yet");this.renderFrame(d,p),this.renderGrid(d,p,e),this.renderWidgetShadow(l,d,p,a.widgets),this.renderInvisibleWidgets(p,a,d,h),this.renderWidgetHoverBorders(s,e,p,d,a.widgets),this.renderSelectionHull(e,p,d,i,a.widgets),this.renderWidgetsSelectionBorders(e,i,p,d,a.widgets),this.renderRectangularSelection(e),this.renderRectangularSelectionHovers(e,n,p,d,a.widgets),this.renderResizeHandlers(e,o),c||(t.slottableRenderer.slottables=a.slottables,t.slottableRenderer.renderSlottables(u))}}renderFrame(e,t){const s={x:0,y:0,width:e.width,height:e.height+e.navbarLength,referential:"world"};this.context.fillStyle="transparent",this.context.shadowColor="rgba(0,0,0,0.1)",this.context.shadowBlur=15;const o=t.worldRect2screen(s);this.context.fillRect(o.x,o.y,o.width,o.height),this.context.clearRect(o.x,o.y,o.width,o.height)}getGridDots(e,t){var u;const s=[];if(!e)return[];const o=t.worldPoint2screen({y:0,x:0,referential:"world"}),n=(u=t.projectedElement)==null?void 0:u.getBoundingClientRect(),i=e.margin*t.zoom,l=e.gap*t.zoom,c=e.cellHeight*t.zoom,a=(n.y+n.height-o.y-i)/(c+l);for(const p in Array(e.columns+1).fill(null))for(const d in Array(Math.ceil(a+1)).fill(null))s.push(t.worldPoint2screen({x:e.margin+parseInt(p)*(e.cellWidth+e.gap),y:e.margin+parseInt(d)*(e.cellHeight+e.gap)+e.navbarLength,referential:"world"}));return s}renderGrid(e,t,s){if(s.state==="MOVING"||s.state==="RESIZING"||s.state==="SLOTTABLE_RESIZING"||s.state==="MOVING_SLOTTABLE"||s.state==="DRAGGING_SLOTTABLE"||s.state==="DRAGGING"){this.context.fillStyle="rgba(0,0,0,0.1)";for(const o of this.getGridDots(e,t))this.context.beginPath(),this.context.ellipse(o.x,o.y,2,2,0,0,2*Math.PI),this.context.fill()}}renderWidgetShadow(e,t,s,o){this.context.fillStyle="rgba(0, 0, 0, 0.1)";for(const n in o){if(!e.operations.some(c=>c.path.includes(n)))continue;const i=o[n],l=s.worldRect2screen(B(i.position,t));this.context.fillRect(l.x,l.y,l.width,l.height)}}renderInvisibleWidgets(e,t,s,o){const i=t.widgets;for(const l in i){if(l in o.widgets)continue;const c=i[l],a=B(c.position,s),u={x:a.x+5,y:a.y+5,width:a.width-2*5,height:a.height-2*5,referential:"world"},p=e.worldRect2screen(u);this.context.fillStyle="rgba(0, 0, 0, 0.1)",this.context.fillRect(p.x,p.y,p.width,p.height),this.context.fillStyle="black",this.context.font="15px sans-serif",this.context.textAlign="center",this.context.textBaseline="middle",this.context.fillText(j[c.type].name,p.x+p.width/2,p.y+p.height/2)}}renderWidgetHoverBorders(e,t,s,o,n){if(this.context.strokeStyle="#ababab",e.state==="HOVERING_WIDGET"&&t.state==="IDLE"){const i=n[e.widgetId];if(!i)return;const l=s.worldRect2screen(B(i.position,o));this.context.strokeRect(l.x,l.y,l.width,l.height)}else(t.state==="MOVING"||t.state==="RESIZING"||t.state==="DRAGGING"||t.state==="SELECTING")&&Object.keys(n).forEach(i=>{const l=n[i],c=s.worldRect2screen(B(l.position,o));this.context.strokeRect(c.x,c.y,c.width,c.height)})}renderWidgetsSelectionBorders(e,t,s,o,n){if(e.state==="IDLE"||e.state==="SELECTING"){this.context.strokeStyle="#3482E5",this.context.lineWidth=2;for(const i of t){const l=n[i],c=s.worldRect2screen(B(l.position,o));this.context.strokeRect(c.x,c.y,c.width,c.height)}}}renderRectangularSelection(e){if(this.context.fillStyle=fo,e.state==="SELECTING"){const t=Math.min(e.initialMousePos.x,e.mousePos.x),s=Math.min(e.initialMousePos.y,e.mousePos.y),o=Math.abs(e.initialMousePos.x-e.mousePos.x),n=Math.abs(e.initialMousePos.y-e.mousePos.y),i={x:t,y:s,width:o,height:n};this.context.fillRect(i.x,i.y,o,n)}}renderRectangularSelectionHovers(e,t,s,o,n){if(this.context.strokeStyle="#3482E5",e.state==="SELECTING")for(const i of t){const l=n[i],c=s.worldRect2screen(B(l.position,o));this.context.strokeRect(c.x,c.y,c.width,c.height)}}renderSelectionHull(e,t,s,o,n){const i=Be(Object.entries(n).filter(([c])=>o.has(c)).map(([c,a])=>B(a.position,s)).filter(c=>c!==null));if(e.state!=="IDLE"||!i)return;this.context.strokeStyle="#3482E5";const l=t.worldRect2screen(i);this.context.strokeRect(l.x,l.y,l.width,l.height)}static drawResizeHandler(e,t){e.fillStyle="white",e.strokeStyle="#3482E5",e.lineWidth=1,e.fillRect(t.x,t.y,t.width,t.height),e.strokeRect(t.x,t.y,t.width,t.height)}renderResizeHandlers(e,t){if(e.state!=="MOVING")for(const{rect:s}of t)ue.drawResizeHandler(this.context,s)}cursor(e,t){if(e.state==="MOVING")return"grabbing";if(e.state==="SELECTING")return"crosshair";if(e.state==="RESIZING")switch(e.side){case"bottom":case"top":return"ns-resize";case"left":case"right":return"ew-resize"}else{if(e.state==="START_PANNING")return"grab";if(e.state==="PANNING")return"grabbing";if(e.state==="JUST_CLICKED_TOGGLE")return"grabbing";if(t.state==="HOVERING_WIDGET")return"grab";if(t.state==="HOVERING_RESIZE_HANDLER")switch(t.side){case"bottom":case"top":return"ns-resize";case"left":case"right":return"ew-resize";case"top-left":case"bottom-right":return"nwse-resize";case"top-right":case"bottom-left":return"nesw-resize"}else return t.state==="HOVERING_TOGGLE"?"pointer":t.state==="HOVERING_SLOTTABLE_RESIZE_HANDLER"?"ns-resize":t.state==="HOVERING_SLOTTABLE_SELECTOR"?"pointer":"default"}}}const Oe=()=>document.body.classList.contains("vscode-dark"),Ne=window.__baseURL?`${window.__baseURL}/media`:"",vo=(r,e,t,s,o,n)=>{let i=[];return mt(e)||(n||(i=i.concat(So(r,t,s,o))),n&&(i=i.concat(mo(r,t,s,o)).concat(yo(r,t,s,o)))),i.concat(_o(r,t,s,e,o)).concat(bo(r,t,s,o))},mt=r=>{var e;return!((e=r.condition)==null||e)},mo=(r,e,t,s)=>{const{row:o,height:n}=r.position,{x:i,y:l,height:c,width:a}=e.getCell(0,o),u=n*c,p=a*e.columns,d={x:i,y:l,width:p,height:u,referential:"world"},h=3,g=2,v=t.worldRect2screen(d);return s.strokeStyle="#3482E5",s.lineWidth=g,s.strokeRect(v.x+h,v.y,v.width-2*h,v.height),[]},yo=(r,e,t,s)=>{const o=wo(r,e,t);return ue.drawResizeHandler(s,o),[{type:"resizer",position:o,elementId:r.id}]},wo=(r,e,t)=>{const{row:n,height:i}=r.position,{x:l,y:c,height:a,width:u}=e.getCell(0,n),p=i*a,d=u*e.columns,h=t.worldRect2screen({x:l,y:c,width:d,height:p,referential:"world"});return{x:h.x+h.width/2-20/2,y:h.y+h.height-6/2,width:20,height:6,referential:"screen"}},So=(r,e,t,s)=>{const{row:o,height:n}=r.position,{x:i,y:l,height:c,width:a}=e.getCell(0,o),u=n*c,p=a*e.columns,d={x:i,y:l,width:p,height:u,referential:"world"},h=4,g=3,v=2,y=t.worldRect2screen(d);return s.strokeStyle="rgb(39, 67, 255, 0.13)",s.lineWidth=v,s.beginPath(),s.roundRect(y.x+g,y.y,y.width-2*g,y.height,h),s.stroke(),[]},_o=(r,e,t,s,o)=>{const{row:n,height:i}=r.position,l=Eo(n,i,e,t),c=new Image(l.width,l.height);return c.src=mt(s)?`${Ne}/chevron-down-${Oe()?"dark":"light"}.svg`:`${Ne}/chevron-up-${Oe()?"dark":"light"}.svg`,c.style.viewBox=`0 0 ${l.width} ${l.height}`,o.drawImage(c,l.x,l.y,l.width,l.height),[{type:"toggle",position:l,elementId:r.id}]},Eo=(r,e,t,s)=>{const{y:o}=t.getCell(0,e),n=24,i=24,l={x:-30,y:o+t.cellHeight*r-i,width:n,height:i,referential:"world"};return s.worldRect2screen(l)},bo=(r,e,t,s)=>{const{row:o}=r.position,n=Io(o,e,t),i=new Image(n.width,n.height);return i.src=`${Ne}/drag-${Oe()?"dark":"light"}.svg`,s.drawImage(i,n.x,n.y,n.width,n.height),[{type:"selector",position:n,elementId:r.id}]},Io=(r,e,t)=>{const{y:s}=e.getCell(0,r),o={x:-30,y:s,width:24,height:24,referential:"world"};return t.worldRect2screen(o)},Po={"if-block":vo};class Fe{constructor(e,t){m(this,"context",null);m(this,"_slottables",[]);m(this,"selectableElements",[]);m(this,"getSlottableRenderedElement",(e,t)=>{var s;return(s=this.selectableElements.find(o=>o.elementId===e&&o.type===t))!=null?s:null});m(this,"getRenderedElementUnderCursor",(e,t)=>this._slottables.find(s=>{var n,i;const o=(i=(n=this.getSlottableRenderedElement(s.id,e))==null?void 0:n.position)!=null?i:null;return o?Le(t,o):!1})||null);m(this,"getSelectorUnderCursor",e=>this.getRenderedElementUnderCursor("selector",e));m(this,"getToggleUnderCursor",e=>this.getRenderedElementUnderCursor("toggle",e));m(this,"getResizerUnderCursor",e=>this.getRenderedElementUnderCursor("resizer",e));this.layoutGrid=e,this.camera=t}static create(e,t){return new Fe(e,t)}setContext(e){this.context=e}set slottables(e){if(!this.context)throw new Error("No context set yet");this._slottables=Object.values(e)}renderSlottables(e){if(this.selectableElements=[],this._slottables.length!==0)for(const t of this._slottables)this.selectableElements=this.selectableElements.concat(this.renderSlottable(t,e===t.id))}renderSlottable(e,t){return Po[e.type](e,e.props,this.layoutGrid,this.camera,this.context,t)}}const Ro=r=>e=>e[r],xo=r=>[...new Set(r)];class je{constructor(){m(this,"_selectedWidgetsIds");m(this,"_selectedSlottableId");m(this,"layoutModel");this.layoutModel=null,this._selectedSlottableId=T(null),this._selectedWidgetsIds=T([])}static create(){return new je}setLayoutModel(e){this.layoutModel=e}get selectedWidgetsIds(){return this._selectedWidgetsIds.value}set selectedWidgetsIds(e){e.length!==0&&this.resetSelection(),this._selectedWidgetsIds.value=xo(e)}get selectedWidgetId(){return this.selectedWidgetsIds[0]}get selectedWidget(){return this.layoutModel&&this.selectedWidgetId?this.layoutModel.getWidget(this.selectedWidgetId):null}get selectedWidgets(){return this.layoutModel?this.selectedWidgetsIds.map(e=>this.layoutModel.getWidget(e)):[]}addWidget(e){this.selectedWidgetsIds=[...this.selectedWidgetsIds,e]}addToSelectedWidgets(e){if(!this.layoutModel)return;const t=this.layoutModel.getWidgetOrSlottable(e);(!D(t)||this.selectedWidget&&!D(this.selectedWidget))&&this.clearWidgetSelection(),this.addWidget(e)}toggleWidgetSelection(e){this.selectedWidgetsIds.includes(e)?this.removeWidget(e):this.addWidget(e)}removeWidget(e){this.selectedWidgetsIds=this.selectedWidgetsIds.filter(t=>t!==e)}clearWidgetSelection(){this.selectedWidgetsIds=[]}selectAll(){!this.layoutModel||(this.selectedWidgetsIds=Object.keys(this.layoutModel.allWidgets))}get selectedSlottableId(){return this._selectedSlottableId.value}set selectedSlottableId(e){e&&this.resetSelection(),this._selectedSlottableId.value=e}get selectedSlottable(){return this.layoutModel&&this.selectedSlottableId?this.layoutModel.getSlottable(this.selectedSlottableId):null}has(e){return this.selectedWidgetsIds.includes(e)}resetSelection(){this.clearWidgetSelection(),this.selectedSlottableId=null}}const Lo=r=>e=>H.exports.uniq(r.map(Ro(e))).length===1,Oo=r=>r.some(e=>j[e.type].autoHeight);function No(r,e){const t=Lo(r),s=Oo(r),o=[],n=16,i=6;return t("colStart")&&o.push({rect:{x:e.x-i/2,y:e.y+e.height/2-n/2,width:i,height:n,referential:"screen"},side:"left"}),t("colEnd")&&o.push({rect:{x:e.x+e.width-i/2,y:e.y+e.height/2-n/2,width:i,height:n,referential:"screen"},side:"right"}),t("colStart")&&t("rowStart")&&!s&&o.push({rect:{x:e.x-i/2,y:e.y-i/2,width:i,height:i,referential:"screen"},side:"top-left"}),t("colEnd")&&t("rowStart")&&!s&&o.push({rect:{x:e.x+e.width-i/2,y:e.y-i/2,width:i,height:i,referential:"screen"},side:"top-right"}),t("colStart")&&t("rowEnd")&&!s&&o.push({rect:{x:e.x-i/2,y:e.y+e.height-i/2,width:i,height:i,referential:"screen"},side:"bottom-left"}),t("colEnd")&&t("rowEnd")&&!s&&o.push({rect:{x:e.x+e.width-i/2,y:e.y+e.height-i/2,width:i,height:i,referential:"screen"},side:"bottom-right"}),t("rowStart")&&!s&&o.push({rect:{x:e.x+e.width/2-n/2,y:e.y-i/2,width:n,height:i,referential:"screen"},side:"top"}),t("rowEnd")&&!s&&o.push({rect:{x:e.x+e.width/2-n/2,y:e.y+e.height-i/2,width:n,height:i,referential:"screen"},side:"bottom"}),o}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */var Ao=globalThis&&globalThis.__extends||function(){var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,o){s.__proto__=o}||function(s,o){for(var n in o)o.hasOwnProperty(n)&&(s[n]=o[n])},r(e,t)};return function(e,t){r(e,t);function s(){this.constructor=e}e.prototype=t===null?Object.create(t):(s.prototype=t.prototype,new s)}}(),To=Object.prototype.hasOwnProperty;function Ae(r,e){return To.call(r,e)}function Te(r){if(Array.isArray(r)){for(var e=new Array(r.length),t=0;t<e.length;t++)e[t]=""+t;return e}if(Object.keys)return Object.keys(r);var s=[];for(var o in r)Ae(r,o)&&s.push(o);return s}function M(r){switch(typeof r){case"object":return JSON.parse(JSON.stringify(r));case"undefined":return null;default:return r}}function Ce(r){for(var e=0,t=r.length,s;e<t;){if(s=r.charCodeAt(e),s>=48&&s<=57){e++;continue}return!1}return!0}function ee(r){return r.indexOf("/")===-1&&r.indexOf("~")===-1?r:r.replace(/~/g,"~0").replace(/\//g,"~1")}function yt(r){return r.replace(/~1/g,"/").replace(/~0/g,"~")}function ke(r){if(r===void 0)return!0;if(r){if(Array.isArray(r)){for(var e=0,t=r.length;e<t;e++)if(ke(r[e]))return!0}else if(typeof r=="object"){for(var s=Te(r),o=s.length,n=0;n<o;n++)if(ke(r[s[n]]))return!0}}return!1}function nt(r,e){var t=[r];for(var s in e){var o=typeof e[s]=="object"?JSON.stringify(e[s],null,2):e[s];typeof o<"u"&&t.push(s+": "+o)}return t.join(`
`)}var wt=function(r){Ao(e,r);function e(t,s,o,n,i){var l=this.constructor,c=r.call(this,nt(t,{name:s,index:o,operation:n,tree:i}))||this;return c.name=s,c.index=o,c.operation=n,c.tree=i,Object.setPrototypeOf(c,l.prototype),c.message=nt(t,{name:s,index:o,operation:n,tree:i}),c}return e}(Error),N=wt,Co=M,ne={add:function(r,e,t){return r[e]=this.value,{newDocument:t}},remove:function(r,e,t){var s=r[e];return delete r[e],{newDocument:t,removed:s}},replace:function(r,e,t){var s=r[e];return r[e]=this.value,{newDocument:t,removed:s}},move:function(r,e,t){var s=ye(t,this.path);s&&(s=M(s));var o=se(t,{op:"remove",path:this.from}).removed;return se(t,{op:"add",path:this.path,value:o}),{newDocument:t,removed:s}},copy:function(r,e,t){var s=ye(t,this.from);return se(t,{op:"add",path:this.path,value:M(s)}),{newDocument:t}},test:function(r,e,t){return{newDocument:t,test:pe(r[e],this.value)}},_get:function(r,e,t){return this.value=r[e],{newDocument:t}}},ko={add:function(r,e,t){return Ce(e)?r.splice(e,0,this.value):r[e]=this.value,{newDocument:t,index:e}},remove:function(r,e,t){var s=r.splice(e,1);return{newDocument:t,removed:s[0]}},replace:function(r,e,t){var s=r[e];return r[e]=this.value,{newDocument:t,removed:s}},move:ne.move,copy:ne.copy,test:ne.test,_get:ne._get};function ye(r,e){if(e=="")return r;var t={op:"_get",path:e};return se(r,t),t.value}function se(r,e,t,s,o,n){if(t===void 0&&(t=!1),s===void 0&&(s=!0),o===void 0&&(o=!0),n===void 0&&(n=0),t&&(typeof t=="function"?t(e,0,r,e.path):we(e,0)),e.path===""){var i={newDocument:r};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=r,i;if(e.op==="move"||e.op==="copy")return i.newDocument=ye(r,e.from),e.op==="move"&&(i.removed=r),i;if(e.op==="test"){if(i.test=pe(r,e.value),i.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",n,e,r);return i.newDocument=r,i}else{if(e.op==="remove")return i.removed=r,i.newDocument=null,i;if(e.op==="_get")return e.value=r,i;if(t)throw new N("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",n,e,r);return i}}else{s||(r=M(r));var l=e.path||"",c=l.split("/"),a=r,u=1,p=c.length,d=void 0,h=void 0,g=void 0;for(typeof t=="function"?g=t:g=we;;){if(h=c[u],h&&h.indexOf("~")!=-1&&(h=yt(h)),o&&(h=="__proto__"||h=="prototype"&&u>0&&c[u-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(a[h]===void 0?d=c.slice(0,u).join("/"):u==p-1&&(d=e.path),d!==void 0&&g(e,0,r,d)),u++,Array.isArray(a)){if(h==="-")h=a.length;else{if(t&&!Ce(h))throw new N("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",n,e,r);Ce(h)&&(h=~~h)}if(u>=p){if(t&&e.op==="add"&&h>a.length)throw new N("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",n,e,r);var i=ko[e.op].call(e,a,h,r);if(i.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",n,e,r);return i}}else if(u>=p){var i=ne[e.op].call(e,a,h,r);if(i.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",n,e,r);return i}if(a=a[h],t&&u<p&&(!a||typeof a!="object"))throw new N("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",n,e,r)}}}function A(r,e,t,s,o){if(s===void 0&&(s=!0),o===void 0&&(o=!0),t&&!Array.isArray(e))throw new N("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");s||(r=M(r));for(var n=new Array(e.length),i=0,l=e.length;i<l;i++)n[i]=se(r,e[i],t,!0,o,i),r=n[i].newDocument;return n.newDocument=r,n}function Wo(r,e,t){var s=se(r,e);if(s.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",t,e,r);return s.newDocument}function we(r,e,t,s){if(typeof r!="object"||r===null||Array.isArray(r))throw new N("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,r,t);if(ne[r.op]){if(typeof r.path!="string")throw new N("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,r,t);if(r.path.indexOf("/")!==0&&r.path.length>0)throw new N('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,r,t);if((r.op==="move"||r.op==="copy")&&typeof r.from!="string")throw new N("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,r,t);if((r.op==="add"||r.op==="replace"||r.op==="test")&&r.value===void 0)throw new N("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,r,t);if((r.op==="add"||r.op==="replace"||r.op==="test")&&ke(r.value))throw new N("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,r,t);if(t){if(r.op=="add"){var o=r.path.split("/").length,n=s.split("/").length;if(o!==n+1&&o!==n)throw new N("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,r,t)}else if(r.op==="replace"||r.op==="remove"||r.op==="_get"){if(r.path!==s)throw new N("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,r,t)}else if(r.op==="move"||r.op==="copy"){var i={op:"_get",path:r.from,value:void 0},l=St([i],t);if(l&&l.name==="OPERATION_PATH_UNRESOLVABLE")throw new N("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,r,t)}}}else throw new N("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,r,t)}function St(r,e,t){try{if(!Array.isArray(r))throw new N("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)A(M(e),M(r),t||!0);else{t=t||we;for(var s=0;s<r.length;s++)t(r[s],s,e,void 0)}}catch(o){if(o instanceof N)return o;throw o}}function pe(r,e){if(r===e)return!0;if(r&&e&&typeof r=="object"&&typeof e=="object"){var t=Array.isArray(r),s=Array.isArray(e),o,n,i;if(t&&s){if(n=r.length,n!=e.length)return!1;for(o=n;o--!==0;)if(!pe(r[o],e[o]))return!1;return!0}if(t!=s)return!1;var l=Object.keys(r);if(n=l.length,n!==Object.keys(e).length)return!1;for(o=n;o--!==0;)if(!e.hasOwnProperty(l[o]))return!1;for(o=n;o--!==0;)if(i=l[o],!pe(r[i],e[i]))return!1;return!0}return r!==r&&e!==e}const Do=Object.freeze(Object.defineProperty({__proto__:null,JsonPatchError:N,deepClone:Co,getValueByPointer:ye,applyOperation:se,applyPatch:A,applyReducer:Wo,validator:we,validate:St,_areEquals:pe},Symbol.toStringTag,{value:"Module"}));/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2021 Joachim Wester
 * MIT license
 */var Ve=new WeakMap,$o=function(){function r(e){this.observers=new Map,this.obj=e}return r}(),Mo=function(){function r(e,t){this.callback=e,this.observer=t}return r}();function Go(r){return Ve.get(r)}function Ho(r,e){return r.observers.get(e)}function Bo(r,e){r.observers.delete(e.callback)}function zo(r,e){e.unobserve()}function Uo(r,e){var t=[],s,o=Go(r);if(!o)o=new $o(r),Ve.set(r,o);else{var n=Ho(o,e);s=n&&n.observer}if(s)return s;if(s={},o.value=M(r),e){s.callback=e,s.next=null;var i=function(){We(s)},l=function(){clearTimeout(s.next),s.next=setTimeout(i)};typeof window<"u"&&(window.addEventListener("mouseup",l),window.addEventListener("keyup",l),window.addEventListener("mousedown",l),window.addEventListener("keydown",l),window.addEventListener("change",l))}return s.patches=t,s.object=r,s.unobserve=function(){We(s),clearTimeout(s.next),Bo(o,s),typeof window<"u"&&(window.removeEventListener("mouseup",l),window.removeEventListener("keyup",l),window.removeEventListener("mousedown",l),window.removeEventListener("keydown",l),window.removeEventListener("change",l))},o.observers.set(e,new Mo(e,s)),s}function We(r,e){e===void 0&&(e=!1);var t=Ve.get(r.object);Ze(t.value,r.object,r.patches,"",e),r.patches.length&&A(t.value,r.patches);var s=r.patches;return s.length>0&&(r.patches=[],r.callback&&r.callback(s)),s}function Ze(r,e,t,s,o){if(e!==r){typeof e.toJSON=="function"&&(e=e.toJSON());for(var n=Te(e),i=Te(r),l=!1,c=i.length-1;c>=0;c--){var a=i[c],u=r[a];if(Ae(e,a)&&!(e[a]===void 0&&u!==void 0&&Array.isArray(e)===!1)){var p=e[a];typeof u=="object"&&u!=null&&typeof p=="object"&&p!=null&&Array.isArray(u)===Array.isArray(p)?Ze(u,p,t,s+"/"+ee(a),o):u!==p&&(o&&t.push({op:"test",path:s+"/"+ee(a),value:M(u)}),t.push({op:"replace",path:s+"/"+ee(a),value:M(p)}))}else Array.isArray(r)===Array.isArray(e)?(o&&t.push({op:"test",path:s+"/"+ee(a),value:M(u)}),t.push({op:"remove",path:s+"/"+ee(a)}),l=!0):(o&&t.push({op:"test",path:s,value:r}),t.push({op:"replace",path:s,value:e}))}if(!(!l&&n.length==i.length))for(var c=0;c<n.length;c++){var a=n[c];!Ae(r,a)&&e[a]!==void 0&&t.push({op:"add",path:s+"/"+ee(a),value:M(e[a])})}}}function Fo(r,e,t){t===void 0&&(t=!1);var s=[];return Ze(r,e,s,"",t),s}const jo=Object.freeze(Object.defineProperty({__proto__:null,unobserve:zo,observe:Uo,generate:We,compare:Fo},Symbol.toStringTag,{value:"Module"}));Object.assign({},Do,jo,{JsonPatchError:wt,deepClone:M,escapePathComponent:ee,unescapePathComponent:yt});function Je(r,e,t){const{selectedWidgets:s,dashEditorService:o}=r,n=o.dashPlayerService.layoutGrid,i=[...s,...t||[]],l=Math.min(...i.map(d=>{var h,g;return(g=(h=q(d,e))==null?void 0:h.colStart)!=null?g:null}).filter(d=>d!==null)),c=Math.max(...i.map(d=>{var h,g;return(g=(h=q(d,e))==null?void 0:h.colEnd)!=null?g:null}).filter(d=>d!==null)),a=Math.min(...i.map(d=>{var h,g;return(g=(h=q(d,e))==null?void 0:h.rowStart)!=null?g:null}).filter(d=>d!==null)),u=c>n.columns-1?n.columns-1-c:l<0?-l:0,p=a<0?-a:0;return i.flatMap(d=>{const h=q(d,e);if(u===0&&p===0)return[];if(!h||!D(h))return[];const g=Z(V(d,k(e)),e);return[{op:"replace",path:`${g}/${d}/colStart`,backup:h,value:h.colStart+u},{op:"replace",path:`${g}/${d}/colEnd`,backup:h,value:h.colEnd+u},{op:"replace",path:`${g}/${d}/rowStart`,backup:h,value:h.rowStart+p},{op:"replace",path:`${g}/${d}/rowEnd`,backup:h,value:h.rowEnd+p}]})}const V=(r,e,t=null)=>{for(const s in e){const o=e[s];if(D(o)){if(s==r)return t}else{const n=V(r,o.slot,s);if(n)return n}}return null},Vo=(r,e)=>r.rowStart>=e.row&&r.rowStart<e.row+e.height,_t=(r,e)=>{var t;return(t=Object.keys(e.slottables).find(s=>Vo(r,e.slottables[s].position)))!=null?t:null},at=(r,e)=>{const t=k(e),s=(n,i,l)=>{for(const c in i){if(c==n)return l;const a=i[c];if(D(a))continue;const u=s(n,a.slot,`${l}/${c}/slot`);if(u)return u}return null},o=s(r,t,me(e));if(!o)throw new Error("Widget not found in layout");return o},Z=(r,e)=>r?`${me(e)}/${r}/slot`:me(e),Se=(r,e,t)=>{if(t){const o=e.slottables[t];return{...r,rowStart:r.rowStart-o.position.row,rowEnd:r.rowEnd-o.position.row}}const s=Object.values(e.slottables).reduce((o,n)=>o+(n.position.row<r.rowStart?n.position.height:0),0);return{...r,rowStart:r.rowStart-s,rowEnd:r.rowEnd-s}};function Zo(r){const{dashEditorService:e,mouseState:t,workingLayout:s,calculatedPositions:o}=r,n=e.dashPlayerService.layoutGrid;if(t.state!=="MOVING_SLOTTABLE")return[];const i=n.cellAt(t.mousePos.x,t.mousePos.y),l=[],c=t.slottableId,a=s.getSlottable(c);if(!a)throw new Error("Slottable not found");const u=It(bt(i,a.height),o,c);return l.push({op:"replace",path:`/slot/${c}/row`,backup:a.row,value:u.row}),l.push({op:"replace",path:`/slot/${c}/order`,backup:a.order,value:u.order}),l}function Jo(r,e){const{mouseState:t,selectedWidgets:s,calculatedPositions:o,workingLayout:n,dashEditorService:i}=r,l=i.dashPlayerService.layoutGrid;if(t.state!=="MOVING")return[];const c=l.cellAt(t.initialMousePos.x,t.initialMousePos.y),a=l.cellAt(t.mousePos.x,t.mousePos.y),u={deltaI:a.i-c.i,deltaJ:a.j-c.j},p=[];for(const d of s){const h=o.widgets[d],g={colStart:h.position.colStart+u.deltaI,colEnd:h.position.colEnd+u.deltaI,rowStart:h.position.rowStart+u.deltaJ,rowEnd:h.position.rowEnd+u.deltaJ},v=Z(V(d,k(n.layout)),n.layout),y=_t(g,o),f=Z(y,n.layout),I=oe(d,k(e));!I||!D(I)||(v===f?p.push({op:"replace",path:`${v}/${d}`,backup:I,value:{...I,...Se(g,o,y)}}):(p.push({op:"remove",path:`${v}/${d}`,backup:I}),p.push({op:"add",path:`${f}/${d}`,value:{...I,...Se(g,o,y)}})))}return p}function Ko(r,e,t,s){const o=[];for(const n of r.selectedWidgets){const i=Z(V(n,k(s)),s),l=q(n,s);!D(l)||(o.push({op:"replace",path:`${i}/${n}/colStart`,backup:l,value:l.colStart+e}),o.push({op:"replace",path:`${i}/${n}/colEnd`,backup:l,value:l.colEnd+e}),o.push({op:"replace",path:`${i}/${n}/rowStart`,backup:l,value:l.rowStart+t}),o.push({op:"replace",path:`${i}/${n}/rowEnd`,backup:l,value:l.rowEnd+t}))}return o}function Et(r,e,t,s){const{mouseState:o,dashEditorService:n}=r,i=n.dashPlayerService.layoutGrid,l=n.camera;if(!l)throw new Error("No camera value yet");if(o.state!=="RESIZING"&&o.state!=="SLOTTABLE_RESIZING")return null;const c=o.side,a=l.screenPoint2world(o.mousePos),u=c==="bottom"||c==="right"?"bottom-right":"top-left",p=i.snap(a,u),d=c.includes("left")?p.x:e.x,h=c.includes("top")?p.y:e.y,g=c.includes("right")?p.x:e.x+e.width,v=c.includes("bottom")?p.y:e.y+e.height,y=Math.abs(g-d),f=Math.abs(v-h);let I={x:Math.min(d,g),y:Math.min(h,v),width:y,height:f,referential:p.referential};return y<t&&(I={...I,width:t}),f<s&&(I={...I,height:s}),I}const Qo=({selectedWidgets:r,calculatedPositions:e,dashEditorService:t})=>{const s=t.dashPlayerService.layoutGrid;return Be(Object.entries(e.widgets).filter(([o])=>r.has(o)).map(([o,n])=>B(e.widgets[o].position,s)).filter(o=>o!==null))};function qo(r){const{mouseState:e,dashEditorService:t,calculatedPositions:s}=r,o=t.dashPlayerService.layoutGrid;if(e.state!=="SLOTTABLE_RESIZING")return[];const n=s.slottables[e.slottableId],i={colStart:0,rowStart:n.position.row,colEnd:o.columns,rowEnd:n.position.row+n.position.height},l=o.rectFromArea(i);if(!l)return[];const c=Et(r,l,o.width,o.cellHeight);if(!c)return[];const a=o.areaFromRect(c);return[{op:"replace",path:`/slot/${e.slottableId}/height`,backup:n.position.height,value:a.rowEnd-a.rowStart+1}]}function Yo(r){const{mouseState:e,selectedWidgets:t,dashEditorService:s,workingLayout:o,calculatedPositions:n}=r,i=s.dashPlayerService.layoutGrid;if(e.state!=="RESIZING")return[];const l=e.side,c=Qo(r);if(!c)return[];const a=Array.from(t).filter(d=>{const h=n.widgets[d];return ms(B(h.position,i),c,l)}),{minWidth:u,minHeight:p}=j[e.type].dashProperties;return a.flatMap(d=>{const h=n.widgets[d],g=B(h.position,i),v=Et(r,g,u,p);if(!v)return[];const y=V(d,k(o.layout)),f=Z(y,o.layout),I=i.areaFromRect(g),K=Se(i.areaFromRect(v),n,y);return[{op:"replace",path:`${f}/${d}/colStart`,backup:I.colStart,value:Math.max(K.colStart,0)},{op:"replace",path:`${f}/${d}/colEnd`,backup:I.colEnd,value:Math.min(K.colEnd,i.columns-1)},{op:"replace",path:`${f}/${d}/rowStart`,backup:I.rowStart,value:Math.max(K.rowStart,0)},{op:"replace",path:`${f}/${d}/rowEnd`,backup:I.rowEnd,value:K.rowEnd}]})}function Xo(r){const{mouseState:e,dashEditorService:t,calculatedPositions:s}=r,o=t.dashPlayerService.layoutGrid;if(e.state!=="DRAGGING")return{operations:[]};const n=Object.values(j[e.type].pythonAPI.params).reduce((g,v)=>(v.isKwarg||!v.dashesInitialValue||(g[v.argName]=v.dashesInitialValue),g),{}),{initialWidth:i,initialHeight:l}=j[e.type].dashProperties,c=o.areaFromRect({x:e.x,y:e.y,width:i,height:l,referential:"world"}),a=_t(c,s),u=Z(a,r.workingLayout.layout),p=Ee(),d={id:p,type:e.type,props:{...n},...Se(c,s,a),events:{}};return{operations:[{op:"add",path:`${u}/${p}`,value:d}],widgetId:p}}const bt=({j:r},e)=>({row:r,height:e,order:0}),ei=(r,e)=>Object.keys(r).reduce((t,s)=>(s===e||(t[s]=r[s]),t),{}),It=(r,e,t)=>{const s=t?{...e,slottables:ei(e.slottables,t)}:e,o=Math.max(Object.values(s.slottables).reduce((i,l)=>l.position.row>=r.row?i:l.position.row+l.position.height<=r.row?i-l.position.height:i-(r.row-l.position.row),r.row),0),n=ti(r,s);return{...r,row:o,order:n}},lt=(r,e,t)=>Object.values(e.slottables).filter(s=>s.id!==t).find(s=>r.row>=s.position.row+s.position.height/2&&r.row<=s.position.row+s.position.height),ct=(r,e,t)=>Object.values(e.slottables).filter(s=>s.id!==t).filter(s=>s.position.row+s.position.height/2>r.row&&s.position.row<=r.row+r.height).reduce((s,o)=>!s||o.position.order<s.position.order?o:s,null),ti=(r,e)=>{var u,p;const t=lt(r,e),s=ct(r,e),o=t?ct(t.position,e,t.id):null,n=s?lt(s.position,e,s.id):null,i=[t,n].reduce((d,h)=>d?h&&d.position.order>h.position.order?h:d:h,null),l=[s,o].reduce((d,h)=>d?h&&d.position.order<h.position.order?h:d:h,null);if(!i&&!l)return 0;const c=(u=i==null?void 0:i.position.order)!=null?u:l.position.order-2,a=(p=l==null?void 0:l.position.order)!=null?p:i.position.order+2;return(c+a)/2};function si(r){const{mouseState:e,dashEditorService:t,calculatedPositions:s}=r,o=t.dashPlayerService.layoutGrid;if(e.state!=="DRAGGING_SLOTTABLE")return{operations:[]};const n=o.cellAt(e.x,e.y),i=Ee(),l={id:i,type:e.type,props:{condition:"True"},slot:{},...It(bt(n,1),s)};return{operations:[{op:"add",path:`/slot/${i}`,value:l}],widgetId:i}}function ri(r,e){const{mouseState:t,selectedWidgets:s}=r;if(t.state!=="MOVING"||!t.duplicating)return[];const o=[];for(const n of s){const i=Z(V(n,k(e)),e),l=q(n,e);if(!l)continue;const c=Ee();o.push({op:"add",path:`${i}/${c}`,value:{...H.exports.cloneDeep(l),id:c}})}return o}function Pt(r,e,t){const s=r.selectedWidgets,o=s.keys().next().value,n=V(o,k(e)),i=n?De(n,e).slot:k(e),c=Object.keys(i).filter(p=>!s.has(p)&&!(t!=null&&t.some(d=>p==d))&&D(i[p])).sort((p,d)=>ys(oe(p,k(e)),oe(d,k(e)))),a=[...s,...t||[]].map(p=>oe(p,k(e))).filter(p=>p!=null),u=[];return c.forEach(p=>{const d=oe(p,k(e));if(!d||!D(d))return;let h=0,g={...d};const v=()=>a.some(y=>ft(g,y));for(;v();)h++,g={...d,rowStart:d.rowStart+h,rowEnd:d.rowEnd+h};if(h){const y=Z(n,e);u.push({op:"replace",path:`${y}/${p}/rowStart`,backup:d.rowStart,value:d.rowStart+h}),u.push({op:"replace",path:`${y}/${p}/rowEnd`,backup:d.rowEnd,value:d.rowEnd+h})}a.push(g)}),u}function oi(r,e,t,s){const o=r.selectedWidgets;if(!o.size)return[];const n=[...o],i=[];return n.some(c=>{const a=V(c,k(s)),u=a?De(a,s).slot:k(s),p=Object.keys(u).filter(h=>!o.has(h)&&D(u[h])),d=q(c,s);return p.some(h=>ft(d,u[h]))})&&o.forEach(c=>{const a=oe(c,k(s)),u=Z(V(c,k(s)),s);!a||!D(a)||(i.push({op:"replace",path:`${u}/${c}/rowStart`,backup:a.rowStart,value:a.rowStart-t}),i.push({op:"replace",path:`${u}/${c}/rowEnd`,backup:a.rowEnd,value:a.rowEnd-t}),i.push({op:"replace",path:`${u}/${c}/colStart`,backup:a.colStart,value:a.colStart-e}),i.push({op:"replace",path:`${u}/${c}/colEnd`,backup:a.colEnd,value:a.colEnd-e}))}),i}function ii(r,e){const t=[],s=[];for(const o of e){const n=Ee();t.push({op:"add",path:`/slot/${n}`,value:{...H.exports.cloneDeep(o),id:n}}),s.push(n)}return{operations:t,widgetsId:s}}function ni(r){const e=M(r.workingLayout.layout),t=ri(r,e);A(e,t);const s=Zo(r);A(e,s);const o=Jo(r,e);A(e,o);const n=Yo(r);A(e,n);const i=qo(r);A(e,i);const l=Xo(r);A(e,l.operations);const c=si(r);A(e,c.operations);const a=Je(r,e,l.widgetId?[l.widgetId]:[]);A(e,a);const u=Pt(r,e,l.widgetId?[l.widgetId]:[]);return A(e,u),{layout:e,operations:[...t,...o,...s,...n,...i,...l.operations,...a,...u,...c.operations]}}function ai(r,e,t){const s=r.workingLayout.layout,o=Ko(r,e,t,s);A(s,o);const n=oi(r,e,t,s);A(s,n);const i=Je(r,s);return A(s,i),[...o,...n,...i]}function li(r,e){const t=r.workingLayout.layout,s=ii(r,e);A(t,s.operations);const o=Je(r,t,s.widgetsId);A(t,o);const n=Pt(r,t,s.widgetsId);return A(t,n),[...s.operations,...o,...n]}const ci=()=>window.location.href.startsWith("vscode-webview://"),di=(r,e)=>{!ci()||window.vscode.postMessage({type:"usage-event",event:{type:r,payload:e}})},hi=async({operations:r,name:e})=>{di("widgets_updated",{checkpoint:e,operations:M(r)})};class Ke{constructor(e,t){m(this,"pubsub");m(this,"checkpointHistory",{undos:[],redos:[]});m(this,"_save",null);this.workingLayout=e,this.dashEditorService=t,this.pubsub=new ze}static create(e,t){return new Ke(e,t)}setWorkingLayout(e){this.workingLayout=e}undo(){if(this.dashEditorService.isPreview||!this.checkpointHistory.undos.length)return;const e=this.checkpointHistory.undos.pop();if(e)return A(this.workingLayout,e.operations),this.checkpointHistory.redos.push(xe(e)),e}redo(){if(this.dashEditorService.isPreview)return;const e=this.checkpointHistory.redos.pop();if(e)return A(this.workingLayout,e.operations),this.checkpointHistory.undos.push(xe(e)),e}execute(e){this.dashEditorService.isPreview||(A(this.workingLayout,e.operations),this.checkpointHistory.undos.push(xe(e)),this.checkpointHistory.redos=[],this.save(),this.pubsub.publish("updated"),hi(e))}onSave(e){this._save=e}save(){var e;(e=this._save)==null||e.call(this)}}const xe=r=>({selection:r.selection,name:`RE: ${r.name}`,operations:r.operations.slice().reverse().map(e=>ui(e))}),ui=r=>{switch(r.op){case"add":return{op:"remove",backup:r.value,path:r.path};case"remove":return{op:"add",path:r.path,value:r.backup};case"replace":return{op:"replace",backup:r.value,path:r.path,value:r.backup}}};class Qe{constructor(e,t){m(this,"operationQueue");m(this,"pubsub");this.layout=e,this.pubsub=new ze,this.operationQueue=Ke.create(e,t)}getRootSlot(){return k(this.layout)}getRootSlotPath(){return me(this.layout)}setLayout(e){this.operationQueue.setWorkingLayout(e)}static create(e,t){return new Qe(e,t)}getWidget(e){return q(e,this.layout)}getWidgetOrSlottable(e){const t=Ht(e,this.layout);if(!t)throw new Error(`Could not find widget or slottable with id ${e}`);return t}get widgets(){return this.getRootSlot()}get allWidgets(){const e=t=>Object.entries(t).reduce((s,[o,n])=>D(n)?{...s,[o]:n}:{...s,...e(n.slot)},{});return e(this.widgets)}getSlottable(e){return De(e,this.layout)}redo(){let e=this.operationQueue.redo();for(;e&&e.operations.length===0;)e=this.operationQueue.redo();return this.operationQueue.save(),e}undo(){let e=this.operationQueue.undo();for(;e&&e.operations.length===0;)e=this.operationQueue.undo();return this.operationQueue.save(),e}updateVariable(e,t){const s=this.getWidget(t);if(!D(s))return;const o=Z(V(t,this.getRootSlot()),this.layout);this.operationQueue.execute({name:"update variable",selection:new Set([t]),operations:[{op:"replace",backup:s.variable,value:e,path:`${o}/${t}/variable`}]})}updateProp({param:e,value:t},s){const o=i=>this.getWidgetOrSlottable(i).props,n=(i,l,c)=>{const a=at(i,this.layout);return[{op:"replace",backup:o(i)[l],value:c,path:`${a}/${i}/props/${l}`}]};this.operationQueue.execute({name:"update props",operations:s.flatMap(i=>n(i,e.argName,t)),selection:new Set(s)})}updateEvent({event:e,value:t},s){const o=i=>this.getWidget(i).events,n=(i,l,c)=>{const a=Z(V(i,this.getRootSlot()),this.layout);return[{op:"replace",backup:o(i)[l],value:c,path:`${a}/${i}/events/${l}`}]};this.operationQueue.execute({name:"update events",operations:s.flatMap(i=>n(i,e.key,t)),selection:new Set(s)})}delete(e){this.operationQueue.execute({name:"widgets deleted",operations:e.map(t=>{const s=at(t,this.layout);return{op:"remove",backup:this.getWidgetOrSlottable(t),path:`${s}/${t}`}}),selection:new Set(e)})}onSave(e){this.operationQueue.onSave(e)}updateVersion(){this.layout.version!=="0.2"&&this.operationQueue.execute({name:"Version updated",operations:[{op:"replace",backup:this.layout.version,value:"0.2",path:"/version"},{op:"add",value:this.layout.widgets,path:"/slot"},{op:"remove",path:"/widgets",backup:this.layout.widgets}],selection:new Set})}}const pi=r=>({type:"copyAndPaste",selectedWidgets:r});function gi(r,e){return r.setData("text/plain",JSON.stringify(pi(e))),!0}function fi(r,e,t){const s=r.getData("text/plain");try{const o=s&&JSON.parse(s);if(!(o&&"type"in o&&o.type==="copyAndPaste"&&"selectedWidgets"in o&&Array.isArray(o.selectedWidgets)))return!1;const i=li(e,o.selectedWidgets);return t.operationQueue.execute({name:"paste",operations:i,selection:e.selectedWidgets}),!0}catch{return!1}}class vi{constructor(e){m(this,"event");this.event=e}setData(e,t){var s;(s=this.event.clipboardData)==null||s.setData(e,t)}getData(e){var t,s;return(s=(t=this.event.clipboardData)==null?void 0:t.getData(e))!=null?s:null}getTransferItems(){var e,t;return Object.values((t=(e=this.event.clipboardData)==null?void 0:e.items)!=null?t:[]).map(yi)}}class mi{constructor(e){m(this,"item");this.item=e}get type(){return this.item.type}getAsString(){return new Promise(e=>this.item.getAsString(t=>e(t)))}getJSONValue(){return this.getAsString().then(e=>{try{return e?JSON.parse(e):null}catch{return null}})}getAsFile(){return this.item.getAsFile()}}function yi(r){return new mi(r)}function dt(r){return new vi(r)}function wi(r){var t;const e=(t=document.getSelection())==null?void 0:t.toString();return(r==null?void 0:r.selectionStart)!==void 0||!!e}class qe{constructor(e,t,s){m(this,"dash");m(this,"zoom");m(this,"prevSlot");m(this,"_collapsedSlottables");m(this,"_isPreview");m(this,"camera");m(this,"slottableRenderer");m(this,"selection");m(this,"dashPlayerService");m(this,"layoutModel");m(this,"workspace");m(this,"_mouseState");m(this,"_hoverState");m(this,"pubsub");m(this,"editor");m(this,"listener");m(this,"canvas");m(this,"interactMenu");m(this,"dashPlayer");m(this,"runtimeHeader");m(this,"canvasService");m(this,"computedState");m(this,"throttledWidgetsChangedSend",H.exports.throttle(()=>{H.exports.isEqual(this.dash.rootSlot,this.prevSlot)||(this.prevSlot=H.exports.cloneDeep(this.dash.rootSlot),this.dashPlayerService.sendWidgetsChanged(this.dash.rootSlot))},500));m(this,"startPanning",()=>{this.mouseState.state!=="PANNING"&&(this.mouseState.state="START_PANNING")});m(this,"onKeyDownEvents",e=>({escape:()=>this.escapeEvent(),backspace:()=>this.backspaceEvent(),delete:()=>this.backspaceEvent(),z:()=>this.undoEvent(e),arrowup:()=>this.arrowUpEvent(),arrowdown:()=>this.arrowDownEvent(),arrowleft:()=>this.arrowLeftEvent(),arrowright:()=>this.arrowRightEvent(),a:()=>this.selectAllEvent(e),p:()=>this.togglePreviewEvent(e),space:()=>this.startPanning()}));m(this,"resizeEventListener",e=>function(t){e.centerCanvasHandler(t)});m(this,"copyEventListener",e=>function(t){e.copyHandler(t)});m(this,"pasteEventListener",e=>function(t){e.pasteHandler(t)});m(this,"mousemoveEventListener",e=>function(t){e.mouseMoveHandler(t)});m(this,"mouseupEventListener",e=>function(t){e.mouseup(t)});m(this,"updateHoverStateOnResizeHandler",e=>{for(const t of this.getResizeHandlerRects())if(Le(e,t.rect)){this.hoverState={state:"HOVERING_RESIZE_HANDLER",side:t.side};return}});m(this,"updateHoverStateOnWidget",e=>{var o;if(this.dashPlayerService.state.type!=="RUNNING")return;const{widgets:t}=this.calculatePositions(),s=(o=Object.keys(t).find(n=>Le(this.camera.screenPoint2world(e),B(t[n].position,this.dashPlayerService.layoutGrid))))!=null?o:null;s?this.hoverState={state:"HOVERING_WIDGET",widgetId:s}:this.hoverState={state:"NONE"}});window.__dashEditorService=this,this.zoom={active:!1,hoverZoomBar:!1},this._isPreview=T(!1),this.dashPlayerService=e,this.dashPlayerService.layoutGrid.calculatePositions=()=>this.isPreview?this.dashPlayerService.calculatePositions():this.calculatePositions(),this.camera=Ue.create(this.dashPlayerService.layoutGrid),this.slottableRenderer=Fe.create(this.dashPlayerService.layoutGrid,this.camera),this._collapsedSlottables=Kt({}),this._mouseState={state:"IDLE"},this._hoverState={state:"NONE"},this.selection=je.create(),this.dash=t,this.workspace=s,this.pubsub=new ze,this.layoutModel=Qe.create(H.exports.cloneDeep(this.dash.layout),this),this.layoutModel.updateVersion(),this.prevSlot=H.exports.cloneDeep(Bt(this.getRootWidgets(),j))}overloadCollapsedSlottablesCondition(e){return Object.entries(e).reduce((t,[s,o])=>s in this.collapsedSlottables?{...t,[s]:{condition:!0}}:{...t,[s]:o},{})}get collapsedSlottables(){return this._collapsedSlottables.value}set collapsedSlottables(e){this._collapsedSlottables.value=e}get isPreview(){return this._isPreview.value}set isPreview(e){this._isPreview.value=e}get mouseState(){return this._mouseState}set mouseState(e){this._mouseState=e}get hoverState(){return this._hoverState}set hoverState(e){this._hoverState=e}getWidgetsWithErrors(){const e=this.dashPlayerService.state;return e?e.type!=="RUNNING"?[]:Object.keys(this.layoutModel.widgets).reduce((t,s)=>{var l,c,a;const o=(l=e.errors.props)==null?void 0:l[s],n=(c=e.errors.variables)==null?void 0:c[s],i=(a=e.errors.widgets)==null?void 0:a[s];return!o&&!n&&!i||!Object.keys({...o,...n,...i}).length?t:t?[...t,s]:[s]},[]):[]}getSelectedWidgetErrors(){var s,o,n,i,l,c;const e={},t=this.dashPlayerService.state;return!t||t.type!=="RUNNING"?e:{props:(o=t.errors.props)==null?void 0:o[(s=this.selection.selectedSlottableId)!=null?s:this.selection.selectedWidgetId],widget:(i=t.errors.widgets)==null?void 0:i[(n=this.selection.selectedSlottableId)!=null?n:this.selection.selectedWidgetId],variable:(c=t.errors.variables)==null?void 0:c[(l=this.selection.selectedSlottableId)!=null?l:this.selection.selectedWidgetId]}}setupOnSave(){this.layoutModel.onSave(async()=>{!this.workspace||(this.dash.layout=this.layoutModel.layout,this.dashPlayerService.updateDashData(this.dash.makeRunnerData(this.workspace)),this.throttledWidgetsChangedSend())})}hoverZoomBar(){this.zoom.hoverZoomBar=!0}leaveZoomBar(){this.zoom.hoverZoomBar=!1}getRootWidgets(){return Object.keys(this.dash.rootSlot).reduce((e,t)=>{const s=this.dash.rootSlot[t];return s.position&&(e[t]=s),e},{})}static create(e,t,s){return new qe(e,t,s)}async restart(){return this.dashPlayerService.start(),await this.dashPlayerService.wait("widgets-computed"),this.dashPlayerService.sendWidgetsChanged(this.dash.rootSlot),this.dashPlayerService.wait("widgets-computed")}metadataDragStart(e,t){if(!this.camera)return;const s=this.camera.screenPoint2world({x:e.pageX,y:e.pageY,referential:"screen"});this.selection.resetSelection(),t in ae?this.mouseState={state:"DRAGGING_SLOTTABLE",...s,type:t}:this.mouseState={state:"DRAGGING",...s,type:t}}fixPosition(e){if(!this.canvas)return;const{origin:t,element:s,ignoreZoom:o}=e;if(!this.camera||!s||!s.style)return;const n=this.camera.worldPoint2screen(t),i=this.canvas.getBoundingClientRect(),l=[`translate(${n.x-i.x}px, ${n.y-i.y}px)`,o?null:`scale(${this.camera.zoom})`].filter(c=>c).join(" ");Object.assign(s.style,{transform:l,transformOrigin:"top left"})}fixCanvasRectPosition(){var n,i,l,c,a,u,p,d,h,g;const e=this.camera.screenRect2world(this.camera.canvasRect),t=this.camera.screenDelta2world({dx:8,dy:8,referential:"screen"}),s=this.camera.screenRect2world({x:(n=this.interactMenu)==null?void 0:n.$el.getBoundingClientRect().x,y:(i=this.interactMenu)==null?void 0:i.$el.getBoundingClientRect().y,width:(l=this.interactMenu)==null?void 0:l.$el.getBoundingClientRect().width,height:(c=this.interactMenu)==null?void 0:c.$el.getBoundingClientRect().height,referential:"screen"});this.fixPosition({origin:{x:Math.min(this.dashPlayerService.layoutGrid.width+t.dx,e.x+e.width-s.width-t.dx),y:Math.max(e.y+t.dy,0),referential:"world"},element:(a=this.interactMenu)==null?void 0:a.$el,ignoreZoom:!0});const o=this.camera.screenRect2world({x:(u=this.runtimeHeader)==null?void 0:u.$el.getBoundingClientRect().x,y:(p=this.runtimeHeader)==null?void 0:p.$el.getBoundingClientRect().y,width:(d=this.runtimeHeader)==null?void 0:d.$el.getBoundingClientRect().width,height:(h=this.runtimeHeader)==null?void 0:h.$el.getBoundingClientRect().height,referential:"screen"});this.fixPosition({origin:{x:0,y:-o.height-t.dy,referential:"world"},element:(g=this.runtimeHeader)==null?void 0:g.$el,ignoreZoom:!0})}canvasMousedown(e){var o;if(!this.camera)return;const t={x:e.pageX,y:e.pageY,referential:"screen"};if(e.button==1||e.button==0&&Ss.isPressed("space")){this.mouseState={state:"PANNING",initialMousePos:t,mousePos:t};return}const s=this.camera.screenPoint2world(t);this.hoverState.state==="HOVERING_WIDGET"?this.mouseState={state:"JUST_CLICKED",pos:s,widgetId:this.hoverState.widgetId}:this.hoverState.state==="HOVERING_RESIZE_HANDLER"?this.mouseState={state:"RESIZING",side:this.hoverState.side,initialMousePos:t,mousePos:t,type:(o=this.selection.selectedWidget)==null?void 0:o.type}:this.hoverState.state==="HOVERING_TOGGLE"?this.mouseState={state:"JUST_CLICKED_TOGGLE",mousePos:t,slottable:this.hoverState.slottable}:this.hoverState.state==="HOVERING_SLOTTABLE_RESIZE_HANDLER"?this.mouseState={state:"SLOTTABLE_RESIZING",initialMousePos:t,mousePos:t,slottableId:this.hoverState.slottableId,side:"bottom"}:this.hoverState.state==="HOVERING_SLOTTABLE_SELECTOR"?this.mouseState={state:"JUST_CLICKED_SLOTTABLE_SELECTOR",slottableId:this.hoverState.slottableId,mousePos:t}:(Y(e)||this.selection.resetSelection(),this.mouseState={state:"SELECTING",initialMousePos:t,mousePos:t})}mouseMoveHandler(e){if(!this.camera)return;const t={x:e.pageX,y:e.pageY,referential:"screen"},s=this.camera.screenPoint2world(t);if(this.mouseState.state==="PANNING"){const o={dx:-e.movementX,dy:-e.movementY},n=this.camera.screenDelta2world({dx:o.dx,dy:o.dy,referential:"screen"});this.camera.translate(n),e.preventDefault(),e.stopPropagation();return}this.mouseState.state==="MOVING"&&(this.mouseState.mousePos=s,this.mouseState.duplicating=Xe(e)),this.mouseState.state==="MOVING_SLOTTABLE"&&(this.mouseState.mousePos=s),this.mouseState.state==="JUST_CLICKED"&&Ye(this.mouseState.pos,s)*this.camera.zoom>5&&(this.selection.has(this.mouseState.widgetId)||(Y(e)?this.selection.addToSelectedWidgets(this.mouseState.widgetId):(this.selection.resetSelection(),this.selection.addToSelectedWidgets(this.mouseState.widgetId))),this.mouseState={state:"MOVING",initialMousePos:this.mouseState.pos,mousePos:s,duplicating:Xe(e)}),this.mouseState.state==="JUST_CLICKED_SLOTTABLE_SELECTOR"&&Ye(this.mouseState.mousePos,s)*this.camera.zoom>5&&(this.mouseState={state:"MOVING_SLOTTABLE",initialMousePos:this.camera.screenPoint2world(this.mouseState.mousePos),mousePos:s,slottableId:this.mouseState.slottableId}),this.mouseState.state==="SELECTING"&&(this.mouseState.mousePos=t),this.mouseState.state==="RESIZING"&&(this.mouseState.mousePos=t),this.mouseState.state==="SLOTTABLE_RESIZING"&&(this.mouseState.mousePos=t),this.computeHoverState(t)}everySelectedWidgetInPreviewState(){const e=this.dashPlayerService.state;return e.type!=="RUNNING"?!1:this.selection.selectedWidgetsIds.every(t=>Object.keys(e.widgets).includes(t))}getRectangularHull(){const e=this.dashPlayerService.state;return e.type!=="RUNNING"?null:Be(Object.entries(e.widgets).filter(([t])=>this.selection.has(t)).map(([t,s])=>B(s.position,this.dashPlayerService.layoutGrid)))}selectionRect(){if(this.mouseState.state!=="SELECTING")return null;const{x:e,y:t}=this.mouseState.initialMousePos,{x:s,y:o}=this.mouseState.mousePos;return{x:Math.min(e,s),y:Math.min(t,o),width:Math.abs(e-s),height:Math.abs(t-o),referential:"screen"}}pasteHandler(e){fi(dt(e),this.getInput(),this.layoutModel)&&e.preventDefault()}renderScreenPositioning(){var s;if(!this.camera||!this.workspace||!this.canvas)return;this.fixPosition({origin:{x:0,y:0,referential:"world"},element:(s=this.dashPlayer)==null?void 0:s.$el}),this.fixCanvasRectPosition();const e=this.canvas.getContext("2d");if(!e)return;const t=this.canvas.getBoundingClientRect();this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,e.clearRect(0,0,this.canvas.width,this.canvas.height),e.translate(-t.x,-t.y)}renderComputeCursor(){var e,t;!this.canvas||(this.canvas.style.cursor=(t=(e=this.canvasService)==null?void 0:e.cursor(this.mouseState,this.hoverState))!=null?t:"default")}renderPreviewState(){var o,n;if(this.dashPlayerService.state.type!=="RUNNING")return;const e=this.getInput(),t=ni(e);(!H.exports.isEqual(t.operations,(o=this.computedState)==null?void 0:o.operations)||!H.exports.isEqual(t.layout,(n=this.computedState)==null?void 0:n.layout))&&(this.computedState=t),this.computedState&&this.canvasService&&this.canvasService.render({...e,computedState:this.computedState,isPreview:this.isPreview,calculatedPositions:this.calculatePositions(this.dash.makeRunnerData(this.workspace,this.computedState.layout).layout.slot)})}render(){try{this.renderScreenPositioning(),this.renderComputeCursor(),this.renderPreviewState()}catch(e){console.error(e)}finally{requestAnimationFrame(()=>this.render())}}onDragover(e){if(!this.camera)return;e.preventDefault();const t=this.camera.screenPoint2world({x:e.pageX,y:e.pageY,referential:"screen"});this.mouseState={...this.mouseState,...t}}canvasWheel(e){if(!this.camera)return;const t={x:e.pageX,y:e.pageY,referential:"screen"};if(fe(e)||_s(e))this.camera.zoomIn(Math.exp(-Math.sign(e.deltaY)*.05),t),e.preventDefault();else{const s=Y(e)?{dx:e.deltaY,dy:0}:{dx:e.deltaX,dy:e.deltaY},o=this.camera.screenDelta2world({dx:s.dx,dy:s.dy,referential:"screen"});this.camera.translate(o)}e.stopPropagation()}togglePreviewEvent(e){Y(e)&&this.pubsub.publish("change-preview",!this.isPreview)}resetEditingState(e){this.mouseState={state:"IDLE"},this.computeHoverState(e)}escapeEvent(){this.mouseState.state==="IDLE"&&this.selection.resetSelection(),this.resetEditingState({referential:"screen",x:0,y:0})}backspaceEvent(){this.selection.selectedSlottableId?this.layoutModel.delete([this.selection.selectedSlottableId]):this.layoutModel.delete(this.selection.selectedWidgetsIds),this.selection.resetSelection()}undoEvent(e){if(fe(e)&&Y(e)){e.preventDefault(),e.stopPropagation();const t=this.layoutModel.redo();if(t){if(t.operations.some(s=>s.op==="remove")){this.selection.resetSelection();return}this.selection.selectedWidgetsIds=[...Array.from(t.selection)]}return}else if(fe(e)){e.preventDefault(),e.stopPropagation();const t=this.layoutModel.undo();if(t){if(t.operations.some(s=>s.op==="remove")){this.selection.resetSelection();return}this.selection.selectedWidgetsIds=[...Array.from(t.selection)]}return}}selectAllEvent(e){fe(e)&&(e.preventDefault(),e.stopPropagation(),this.selection.selectAll())}move(e,t){const[s,o]={up:[0,-1],down:[0,1],left:[-1,0],right:[1,0]}[t],n=ai(e,s,o);this.layoutModel.operationQueue.execute({name:`move ${t}`,operations:n,selection:e.selectedWidgets})}arrowUpEvent(){this.move(this.getInput(),"up")}arrowDownEvent(){this.move(this.getInput(),"down")}arrowLeftEvent(){this.move(this.getInput(),"left")}arrowRightEvent(){this.move(this.getInput(),"right")}selectingOnMouseUp(e){Y(e)?this.widgetsInRectangularSelection().forEach(t=>{this.selection.toggleWidgetSelection(t)}):(this.selection.resetSelection(),this.widgetsInRectangularSelection().forEach(t=>{this.selection.addToSelectedWidgets(t)}))}toggleSlottable(e){this.collapsedSlottables={...this.collapsedSlottables,[e]:!this.collapsedSlottables[e]}}mouseup(e){var s;(s=this.computedState)!=null&&s.operations.length&&this.layoutModel.operationQueue.execute({name:"mouse up",operations:this.computedState.operations,selection:new Set(this.selection.selectedWidgetsIds)}),this.mouseState.state==="SELECTING"&&this.selectingOnMouseUp(e),this.mouseState.state==="JUST_CLICKED"&&(Y(e)?this.selection.toggleWidgetSelection(this.mouseState.widgetId):(this.selection.resetSelection(),this.selection.selectedSlottableId=null,this.selection.addToSelectedWidgets(this.mouseState.widgetId))),this.mouseState.state==="JUST_CLICKED_TOGGLE"&&this.toggleSlottable(this.mouseState.slottable),this.mouseState.state==="JUST_CLICKED_SLOTTABLE_SELECTOR"&&(this.selection.selectedSlottableId=this.mouseState.slottableId);const t={x:e.pageX,y:e.pageY,referential:"screen"};this.resetEditingState(t)}onKeydown(e){var t,s;(s=(t=this.onKeyDownEvents(e))[e.key.toLowerCase().trim()?e.key.toLowerCase():e.code.toLowerCase()])==null||s.call(t)}onKeyup(e){this.mouseState={state:"IDLE"}}copyHandler(e){wi(e==null?void 0:e.target)||gi(dt(e),this.selection.selectedWidgets)&&e.preventDefault()}centerCanvasHandler(e){var t;(t=this.camera)==null||t.correct()}addGlobalEventListeners(){addEventListener("resize",this.resizeEventListener(this)),addEventListener("copy",this.copyEventListener(this)),addEventListener("paste",this.pasteEventListener(this)),addEventListener("mousemove",this.mousemoveEventListener(this)),addEventListener("mouseup",this.mouseupEventListener(this))}removeGlobalEventListeners(){removeEventListener("resize",this.resizeEventListener(this)),removeEventListener("copy",this.copyEventListener(this)),removeEventListener("paste",this.pasteEventListener(this)),removeEventListener("mousemove",this.mousemoveEventListener(this)),removeEventListener("mouseup",this.mouseupEventListener(this))}async setup(e,t,s,o,n,i){var c,a;if(this.editor=e,this.listener=t,this.interactMenu=o,this.dashPlayer=n,this.runtimeHeader=i,this.canvas=s,this.camera.setProjectedCanvas(s),this.camera.correct(),t.addEventListener("wheel",u=>this.canvasWheel(u)),s.addEventListener("mousedown",u=>this.canvasMousedown(u)),s.addEventListener("drop",u=>this.mouseup(u)),s.addEventListener("dragover",u=>this.onDragover(u)),(c=s.parentElement)==null||c.addEventListener("keydown",u=>this.onKeydown(u)),(a=s.parentElement)==null||a.addEventListener("keyup",u=>this.onKeyup(u)),!s.getContext("2d"))throw new Error(`I can't get no context 2d ${s}`);this.canvasService=ue.create(s,this),this.addGlobalEventListeners(),He(()=>{this.camera.fit(),this.render()})}tearDown(){this.removeGlobalEventListeners()}widgetsInRectangularSelection(){if(!this.camera)throw new Error("No camera value yet");if(this.dashPlayerService.state.type!=="RUNNING")return new Set;const{widgets:e}=this.calculatePositions(),t=this.selectionRect();return t?new Set(Object.keys(e).filter(s=>ws(this.camera.worldRect2screen(B(e[s].position,this.dashPlayerService.layoutGrid)),t))):new Set}calculatePositions(e){return this.dashPlayerService.state.type!=="RUNNING"?{widgets:{},slottables:{}}:this.dashPlayerService.calculatePositions(this.overloadCollapsedSlottablesCondition(this.dashPlayerService.state.props),e)}getInput(){switch(this.dashPlayerService.state.type){case"AUTHENTICATING":case"RUNNING":return{mouseState:this.mouseState,dashEditorService:this,workingLayout:this.layoutModel,hoverState:this.hoverState,resizeHandlerRects:this.getResizeHandlerRects(),widgetsInRectangularSelection:this.widgetsInRectangularSelection(),selectedWidgets:new Set(this.selection.selectedWidgetsIds),dash:this.dash,calculatedPositions:this.calculatePositions(),selectedSlottable:this.selection.selectedSlottableId};default:throw new Error(`Invalid state ${JSON.stringify(this.dashPlayerService.state.type)} for getInput`)}}getResizeHandlerRects(){if(!this.camera)throw new Error("No camera value yet");const e=this.getRectangularHull();return!e||!this.everySelectedWidgetInPreviewState()?[]:No(this.selection.selectedWidgets,this.camera.worldRect2screen(e))}updateHoverStateOnToggle(e){const t=this.slottableRenderer.getToggleUnderCursor(e);t&&(this.hoverState={state:"HOVERING_TOGGLE",slottable:t.id})}updateHoverStateOnSlottableSelector(e){const t=this.slottableRenderer.getSelectorUnderCursor(e);t&&(this.hoverState={state:"HOVERING_SLOTTABLE_SELECTOR",slottableId:t.id})}updateHoverStateOnSlottableResizeHandler(e){const t=this.slottableRenderer.getResizerUnderCursor(e);t&&(this.hoverState={state:"HOVERING_SLOTTABLE_RESIZE_HANDLER",slottableId:t.id})}computeHoverState(e){!this.camera||(this.updateHoverStateOnWidget(e),this.updateHoverStateOnResizeHandler(e),this.updateHoverStateOnToggle(e),this.updateHoverStateOnSlottableSelector(e),this.updateHoverStateOnSlottableResizeHandler(e))}}const en=z({__name:"DashEditor",setup(r){const e=Qt(),t=qt(),s=T("test");function o(){e.push({name:"dashes"})}const n=({id:v,type:y})=>{y==="dash"?(e.push({name:"dashEditor",params:{dashId:v},query:t.query}),l()):e.push({name:"editor",params:{formId:v},query:t.query})},{result:i,refetch:l}=ds(()=>Promise.all([us.get(),hs.get(t.params.dashPath)]).then(([v,y])=>Yt({workspace:v,dash:y,...d(v,y)}))),c=v=>{i.value&&(i.value.dashEditorService.isPreview=v)},a=T(),u=v=>{var y;return(y=i.value)==null?void 0:y.dash.addVariableToCode(v)};function p(v,y){v.onRedirect(({url:f,queryParams:I})=>zt("editor",e,f,I)),v.on("eval-return",f=>{f.repr&&y.log({type:"eval-output",log:f.repr})}),v.on("eval-error",f=>{y.log({type:"eval-output",log:f.repr})}),v.on("stderr",f=>{y.log({type:"stderr",log:f.log})}),v.on("stdout",f=>{y.log({type:"stdout",log:f.log})}),v.on("widgets-computed",f=>{var I;(I=f.errors)!=null&&I.general&&y.log({type:"stderr",log:f.errors.general.repr})}),v.on("program-start-failed",f=>{var I;y.log({type:"stderr",log:(I=f.error)!=null?I:""})})}function d(v,y){const f=ts(y.makeRunnerData(v)),I=os.create(),K=qe.create(f,y,v);return p(f,I),{dashPlayerService:f,logService:I,dashEditorService:K}}function h(v){var y;(y=i.value)==null||y.dashPlayerService.sendEvalRequest(v)}const g=async()=>{!i.value||(i.value.dashEditorService.restart(),p(i.value.dashPlayerService,i.value.logService))};return(v,y)=>(S(),Q(Xt,{"full-canvas":s.value==="test"},{navbar:X(()=>[R(i)?(S(),Q(R(Es),{key:0,title:R(i).dash.title,style:{padding:"5px 10px"},onBack:o},{footer:X(()=>[L(R(bs),{"active-key":s.value,"onUpdate:activeKey":y[0]||(y[0]=f=>s.value=f)},{default:X(()=>[L(R(et),{key:"test",tab:"Test"}),L(R(et),{key:"settings",tab:"Settings"})]),_:1},8,["active-key"])]),extra:X(()=>[L(ps,{path:R(i).dash.path},null,8,["path"]),L(fs,{path:"dashes/overview"}),L(gs,{model:R(i).dash},null,8,["model"])]),_:1},8,["title"])):W("",!0)]),content:X(()=>[R(i)&&s.value==="test"?(S(),Q(go,{key:0,workspace:R(i).workspace,dash:R(i).dash,"dash-editor-service":R(i).dashEditorService,params:R(t).query,onNavigate:n,onChangePreview:c,onCreateVariable:u},null,8,["workspace","dash","dash-editor-service","params"])):W("",!0),R(i)&&s.value==="settings"?(S(),Q(Os,{key:1,dash:R(i).dash},null,8,["dash"])):W("",!0)]),footer:X(()=>[R(i)&&s.value==="test"?(S(),Q(rs,{key:0,ref_key:"smartConsole",ref:a,"log-service":R(i).logService,runtime:"dashes",onRestart:g,onEvalRequest:h},null,8,["log-service"])):W("",!0)]),_:1},8,["full-canvas"]))}});export{en as default};
//# sourceMappingURL=DashEditor.05dbf58f.js.map
