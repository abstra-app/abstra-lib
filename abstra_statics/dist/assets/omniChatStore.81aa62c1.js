var z=Object.defineProperty;var V=(a,e,t)=>e in a?z(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var r=(a,e,t)=>(V(a,typeof e!="symbol"?e+"":e,t),t);import{k as S}from"./router.ed823a0a.js";import{d as P,at as x,c as w,o as p,ac as m,ae as W,h as G,ew as Q,e as _,r as c,i as L,a as A,b as N,g as X,t as Y,u as T,b0 as K,_ as ee,f as te,f2 as se,Q as re,al as ie,v as oe,$ as O}from"./jwt-decode.esm.fbcfeaec.js";import{P as ae}from"./record.63a637c8.js";import{u as C}from"./uuid.ee81c117.js";import{I as ne}from"./PhCopySimple.vue.b62e6136.js";(function(){try{var a=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(a._sentryDebugIds=a._sentryDebugIds||{},a._sentryDebugIds[e]="9aa551de-5ccf-4753-9169-94cc9dc08021",a._sentryDebugIdIdentifier="sentry-dbid-9aa551de-5ccf-4753-9169-94cc9dc08021")}catch{}})();const le=["width","height","fill","transform"],ce={key:0},he=_("path",{d:"M176.49,95.51a12,12,0,0,1,0,17l-56,56a12,12,0,0,1-17,0l-24-24a12,12,0,1,1,17-17L112,143l47.51-47.52A12,12,0,0,1,176.49,95.51ZM236,128A108,108,0,1,1,128,20,108.12,108.12,0,0,1,236,128Zm-24,0a84,84,0,1,0-84,84A84.09,84.09,0,0,0,212,128Z"},null,-1),de=[he],ue={key:1},ge=_("path",{d:"M224,128a96,96,0,1,1-96-96A96,96,0,0,1,224,128Z",opacity:"0.2"},null,-1),fe=_("path",{d:"M173.66,98.34a8,8,0,0,1,0,11.32l-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35A8,8,0,0,1,173.66,98.34ZM232,128A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"},null,-1),pe=[ge,fe],ye={key:2},ve=_("path",{d:"M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm45.66,85.66-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35a8,8,0,0,1,11.32,11.32Z"},null,-1),_e=[ve],me={key:3},we=_("path",{d:"M172.24,99.76a6,6,0,0,1,0,8.48l-56,56a6,6,0,0,1-8.48,0l-24-24a6,6,0,0,1,8.48-8.48L112,151.51l51.76-51.75A6,6,0,0,1,172.24,99.76ZM230,128A102,102,0,1,1,128,26,102.12,102.12,0,0,1,230,128Zm-12,0a90,90,0,1,0-90,90A90.1,90.1,0,0,0,218,128Z"},null,-1),Ce=[we],be={key:4},Se=_("path",{d:"M173.66,98.34a8,8,0,0,1,0,11.32l-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35A8,8,0,0,1,173.66,98.34ZM232,128A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"},null,-1),xe=[Se],Ie={key:5},Ae=_("path",{d:"M170.83,101.17a4,4,0,0,1,0,5.66l-56,56a4,4,0,0,1-5.66,0l-24-24a4,4,0,0,1,5.66-5.66L112,154.34l53.17-53.17A4,4,0,0,1,170.83,101.17ZM228,128A100,100,0,1,1,128,28,100.11,100.11,0,0,1,228,128Zm-8,0a92,92,0,1,0-92,92A92.1,92.1,0,0,0,220,128Z"},null,-1),Te=[Ae],Ee={name:"PhCheckCircle"},Fe=P({...Ee,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(a){const e=a,t=x("weight","regular"),s=x("size","1em"),i=x("color","currentColor"),u=x("mirrored",!1),l=w(()=>{var n;return(n=e.weight)!=null?n:t}),h=w(()=>{var n;return(n=e.size)!=null?n:s}),d=w(()=>{var n;return(n=e.color)!=null?n:i}),g=w(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:u?"scale(-1, 1)":void 0);return(n,f)=>(p(),m("svg",Q({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:h.value,height:h.value,fill:d.value,transform:g.value},n.$attrs),[W(n.$slots,"default"),l.value==="bold"?(p(),m("g",ce,de)):l.value==="duotone"?(p(),m("g",ue,pe)):l.value==="fill"?(p(),m("g",ye,_e)):l.value==="light"?(p(),m("g",me,Ce)):l.value==="regular"?(p(),m("g",be,xe)):l.value==="thin"?(p(),m("g",Ie,Te)):G("",!0)],16,le))}});class Z{constructor(e,t){r(this,"staging");this.flag=e,this.acc=t,this.staging=""}}class Me extends Z{constructor(){super("___JSON_MODE___",[])}reduceChar(e){try{this.staging+=e;const t=JSON.parse(this.staging);return this.acc.push(t),this.staging="",t}catch{return}}reduce(e){const t=[];for(const s of e){const i=this.reduceChar(s);i!==void 0&&t.push(i)}return t}}class ke extends Z{constructor(){super("___TEXT_MODE___","")}reduce(e){return this.staging+=e,this.acc=this.staging,e}}class R{constructor(){r(this,"mode");r(this,"modes",[new ke,new Me]);r(this,"staging","");r(this,"chunkOnBuffer","");r(this,"flagMap");r(this,"flagPrefixes");this.mode=this.modes[0],this.flagMap=new Map,this.flagPrefixes=new Set;for(const e of this.modes){this.flagMap.set(e.flag,e);for(let t=1;t<e.flag.length;t++)this.flagPrefixes.add(e.flag.slice(0,t))}}*reduce(e){for(const t of e){if(this.staging+=t,this.flagMap.has(this.staging)){this.mode=this.flagMap.get(this.staging),this.staging="";continue}if(!this.flagPrefixes.has(this.staging))for(;this.staging.length>0;){const s=this.staging[0];this.staging=this.staging.slice(1);const i=this.mode.reduce(s);if(i!==void 0&&(Array.isArray(i)?yield*i:yield i),this.flagPrefixes.has(this.staging))break}}}*reduceInChunks(e,t){let s="";for(const i of this.reduce(t))if(typeof i=="string")for(s+=i;s.length>=e;)yield s.slice(0,e),s=s.slice(e);else s.length>0&&(yield s,s=""),yield i;s.length>0&&(yield s)}}const j=300;class $e{constructor(){r(this,"_baseUrl","/_editor/api/ai");r(this,"_headers",{"Content-Type":"application/json"})}async*sendMessage(e,t,s,i,u){var n;const l={conversationId:e,content:t,context:s,humanApproval:u},h=await fetch(`${this._baseUrl}/stream`,{method:"POST",headers:this._headers,body:JSON.stringify(l)});if(!h.ok)throw new Error("Failed to send message");const d=(n=h.body)==null?void 0:n.getReader();if(!d)throw new Error("No response body");const g=new R;for(;!i();){const f=await d.read();if(f.done)break;for(const y of g.reduceInChunks(j,new TextDecoder().decode(f.value)))yield y}}async deleteThread(e){if(!(await fetch(`${this._baseUrl}/thread/${e}`,{method:"DELETE",headers:this._headers})).ok)throw new Error("Failed to delete thread")}async abortStreaming(e){if(!(await fetch(`${this._baseUrl}/abort`,{method:"POST",headers:this._headers,body:JSON.stringify({langGraphThreadId:e})})).ok)throw new Error("Failed to abort streaming")}async getHistory(e,t){const s=await fetch(`${this._baseUrl}/history?limit=${e}&offset=${t}`,{method:"GET"});if(!s.ok)throw new Error("Failed to fetch history");return await s.json()}startConversation(){return new Promise((e,t)=>{fetch(`${this._baseUrl}/start-conversation`,{method:"POST",headers:this._headers}).then(s=>{if(!s.ok)throw new Error("Failed to start conversation");return s.json()}).then(s=>e(s)).catch(s=>t(s))})}}class He{constructor(e){r(this,"projectId");r(this,"baseUrl");this.projectId=e,this.baseUrl=`projects/${e}`}startConversation(){throw new Error("Method not implemented.")}async*sendMessage(e,t,s,i,u){var n;const l={conversationId:e,content:t,context:s,humanApproval:u},d=(n=(await S.postRaw(`${this.baseUrl}/messages`,l)).body)==null?void 0:n.getReader();if(!d)throw new Error("No response body");const g=new R;for(;!i();){const f=await d.read();if(f.done)break;for(const y of g.reduceInChunks(j,new TextDecoder().decode(f.value)))yield y}}async abortStreaming(e){await S.post(`${this.baseUrl}/abort`,{langGraphThreadId:e})}async getHistory(e,t){const s={limit:`${e}`,offset:`${t}`};return await S.get(`${this.baseUrl}/history`,s)}async deleteThread(e){await S.delete(`${this.baseUrl}/threads/${e}`)}}const Le=P({__name:"CopyButton",props:{textToCopy:{}},setup(a){const e=a,t=c(!1),s=()=>{navigator.clipboard.writeText(e.textToCopy),t.value=!0,setTimeout(()=>t.value=!1,2e3)},i=w(()=>t.value?L.translate("i18n_copybutton_copied"):L.translate("i18n_copybutton_copy_to_clipboard"));return(u,l)=>(p(),A(T(K),null,{title:N(()=>[X(Y(i.value),1)]),default:N(()=>[_("div",{class:"copy-button",onClick:s},[t.value?(p(),A(T(Fe),{key:1,color:"#fff",size:"22"})):(p(),A(T(ne),{key:0,color:"#fff",size:"22"}))])]),_:1}))}});const Ne=ee(Le,[["__scopeId","data-v-95878e02"]]);class B{constructor(e,t){r(this,"_repository");r(this,"conversationId");r(this,"_input");r(this,"_attachments");r(this,"_badgeState");r(this,"_smartChatState");r(this,"_logService");r(this,"_hasError",c(null));r(this,"_isLoadingHistory",c(!1));r(this,"_history",c([]));r(this,"_threadHistoryFetchInfo",c({limit:10,offset:0,done:!1}));r(this,"_executingFormFile",c(null));r(this,"_recentlyAccessedThreads",c([]));r(this,"loadingAbort",c(!1));r(this,"codeForApproval",c(null));r(this,"setupThread",async()=>{this.conversationId.value=`abstra-assistant-thread-${C()}`,this._recentlyAccessedThreads.value.unshift({id:this.conversationId.value,messages:[],createdAt:new Date().toISOString()})});r(this,"fetchHistory",async()=>{this._isLoadingHistory.value=!0;const e=await this._repository.getHistory(this._threadHistoryFetchInfo.value.limit,this._threadHistoryFetchInfo.value.offset);this._history.value=e,this._isLoadingHistory.value=!1});r(this,"loadMoreHistory",async()=>{this._isLoadingHistory.value=!0,this._threadHistoryFetchInfo.value.offset+=this._threadHistoryFetchInfo.value.limit;const e=await this._repository.getHistory(this._threadHistoryFetchInfo.value.limit,this._threadHistoryFetchInfo.value.offset);e.length<this._threadHistoryFetchInfo.value.limit&&(this._threadHistoryFetchInfo.value.done=!0);const t=[...this._history.value,...e];this._history.value=t,this._isLoadingHistory.value=!1});r(this,"setError",e=>{this._hasError.value=e});r(this,"setExecutingFormFile",e=>{this._executingFormFile.value=e});r(this,"_fillChat",e=>{this._logService.clear();for(const t of e)if(t.toolTitle)this._logService.log({type:"ai-tool-approval",toolCallId:t.toolCallId,description:t.toolTitle,args:{},disabled:!1,needsApproval:!1,loading:!1}),this._logService.log({type:"ai-tool-call-response",toolCallId:t.toolCallId,response:this.extractTextContent(t.content)});else{const s=this.extractAttachmentsFromContent(t.content);s.length>0&&t.role==="user"?this._logService.log({type:"ai-input",log:this.extractTextContent(t.content),attachments:s}):this._logService.log({type:t.role==="user"?"ai-input":"ai-output",log:this.extractTextContent(t.content)})}this.renderCopyButtons()});r(this,"moveThreadFromHistoryToRecents",e=>{this.conversationId.value=e;const t=this._history.value.find(i=>i.id===e);if(!t)throw new Error(`Thread ${e} not found`);const s=this._recentlyAccessedThreads.value.findIndex(i=>i.id===e);s!==-1&&this._recentlyAccessedThreads.value.splice(s,1),this._recentlyAccessedThreads.value.unshift(t),this._fillChat(t.messages)});r(this,"deleteThread",e=>{this._repository.deleteThread(e),this.removeFromRecentlyAccessedThreads(e);const t=this._history.value.findIndex(s=>s.id===e);t!==-1&&this._history.value.splice(t,1)});r(this,"setCurrentThreadFromRecents",e=>{this.conversationId.value=e;const t=this._recentlyAccessedThreads.value.findIndex(i=>i.id===e);if(t===-1)throw new Error(`Thread ${e} not found`);const[s]=this._recentlyAccessedThreads.value.splice(t,1);this._recentlyAccessedThreads.value.unshift(s),this._fillChat(s.messages)});r(this,"removeFromRecentlyAccessedThreads",e=>{const t=this._recentlyAccessedThreads.value.findIndex(s=>s.id===e);if(t===-1)throw new Error(`Thread ${e} not found`);if(this._recentlyAccessedThreads.value.splice(t,1),this._logService.clear(),this._recentlyAccessedThreads.value.length===0)this.conversationId.value=null;else{const s=this._recentlyAccessedThreads.value[0];this.conversationId.value=s.id,this._fillChat(s.messages)}});r(this,"renderCopyButtons",()=>{document.querySelectorAll("pre").forEach(t=>{t.style.position="relative";const s=te(Ne,{textToCopy:t.textContent});se(s,t)})});r(this,"clearLogService",()=>{this._logService.clear()});r(this,"extractTextContent",e=>typeof e=="string"?e:Array.isArray(e)?e.filter(t=>t.type==="text"&&t.text).map(t=>t.text).join(`
`):"");r(this,"extractAttachmentsFromContent",e=>{if(typeof e=="string"||!Array.isArray(e))return[];let t=0;return e.filter(s=>{var i;return s.type==="image_url"&&((i=s.image_url)==null?void 0:i.url)}).map(s=>{t++;const u=s.image_url.url.match(/^data:([^;]+);base64,(.+)$/);if(u){const[,l,h]=u,d=Math.ceil(h.length*3/4),g=l.split("/")[1]||"jpg";return{fileName:`image_${t}.${g}`,fileContent:h,fileSize:d,mimeType:l}}return{fileName:`image_${t}.jpg`,fileContent:"",fileSize:0,mimeType:"image/jpeg"}})});r(this,"send",async(e,t,s=0)=>{var i,u,l,h,d,g,n;this.conversationId.value||await this.setupThread(),s===0&&this._logService.log({type:"ai-input",log:this._input.value,attachments:this._attachments.value}),this._smartChatState.value="processing";try{const f=C(),y=this.conversationId.value;if(!y)throw new Error("Conversation ID is not set");const D=[{type:"text",text:this._input.value},...this._attachments.value.map(v=>({type:"file",fileName:v.fileName,fileContent:v.fileContent}))],U={currentEditorUrl:window.location.href,panesInfo:e||{}},q=this._repository.sendMessage(y,D,U,this.isIdle.bind(this),t);let F="",M=f,I="";for await(const v of q){if(this.isIdle())break;this._smartChatState.value==="processing"&&(this._smartChatState.value="answering");const o=v;if(typeof o=="string"){if(o.includes("abstra__trigger__retry"))throw new Error("AI service requested a retry");F+=o,I+=o,this._logService.log({type:"ai-output",log:I},M)}else if(o instanceof Object)if(o.type==="ai-tool-approval"){const J=(i=o.args)==null?void 0:i.file,k=!!(((u=o.args)==null?void 0:u.replacements)||((l=o.args)==null?void 0:l.content))&&this._executingFormFile.value===J,$=k?"This action can\u2019t be performed while the form is running":void 0;if(this._logService.log({type:"ai-tool-approval",toolCallId:o.toolCallId,description:o.title,args:o.args,disabled:k,needsApproval:!0,loading:!1,...$&&{message:$}}),((h=o.args)==null?void 0:h.file)&&((d=o.args)==null?void 0:d.replacements)){let b=o.args.replacements;typeof b=="string"&&(b=JSON.parse(b)),this.codeForApproval.value={file:o.args.file,replacements:b.map(H=>({oldContext:H.old_context,newContext:H.new_context}))}}else((g=o.args)==null?void 0:g.file)&&((n=o.args)==null?void 0:n.content)&&(this.codeForApproval.value={file:o.args.file,code:o.args.content})}else o.type==="ai-tool-call"?(this._logService.log({type:"ai-tool-approval",toolCallId:o.toolCallId,description:o.title,args:o.args,disabled:!1,needsApproval:!1,loading:!1}),M=C(),I=""):o.type==="ai-tool-call-response"&&this._logService.log({type:"ai-tool-call-response",toolCallId:o.toolCallId,response:o.response})}this._recentlyAccessedThreads.value=this._recentlyAccessedThreads.value.map(v=>(v.id===this.conversationId.value&&v.messages.unshift({role:"assistant",content:F,createdAt:new Date().toISOString()}),v)),this._input.value="",this._attachments.value=[],this._smartChatState.value="idle",this.renderCopyButtons()}catch(f){console.error(f),re(f),s>3?(this._logService.log({type:"ai-output",log:"Sorry, there was an issue processing your request. Please try again later."}),this._input.value="",this._smartChatState.value="idle",this.renderCopyButtons()):(this._logService.log({type:"ai-output",log:"We had some trouble, but we are already retrying your request..."}),await this.abort(),this._input.value="There was an unexpected error, please try again. You must continue from where you stopped as if nothing happened.",this.send(e,t,s+1))}});r(this,"abort",async()=>{if(!this.conversationId.value)throw new Error("Conversation ID is not set");this.loadingAbort.value=!0,await this._repository.abortStreaming(this.conversationId.value),this._smartChatState.value="idle",this.loadingAbort.value=!1});r(this,"isLoadingHistory",()=>this._isLoadingHistory.value);r(this,"isProcessing",()=>this._smartChatState.value==="processing");r(this,"isAnswering",()=>this._smartChatState.value==="answering");r(this,"isIdle",()=>this._smartChatState.value==="idle");r(this,"setSeen",()=>{this._badgeState.value={type:"seen"}});r(this,"setUnseen",e=>{this._badgeState.value={type:"unseen",count:this._badgeState.value.type==="unseen"?this._badgeState.value.count+1:1,severity:e.type==="stderr"?"error":"info"}});r(this,"setInput",(e,t)=>{e=e==null?void 0:e.trimEnd(),this._input.value=e||"",this._attachments.value=t||[]});r(this,"regenerateLast",async()=>{for(let e=this._logService.logs.length-1;e>=0;e--){const t=this._logService.logs[e];if(t.type==="ai-input"){this.setInput(t.log);break}}await this.send()});r(this,"fixJson",async(e,t)=>{this._logService.clear(),this._logService.log({type:"ai-input",log:`here is my json code:
      ${e}
      And I got this error:`}),this._logService.log({type:"stderr",log:t}),this.setSeen(),this.setInput("Can you fix this JSON?"),await this.send()});r(this,"askAboutError",async(e,t)=>{this._logService.clear(),this.setInput(["Fix the following error based on my logs:",...e.entries.map(s=>s.payload.text),`My current code is: ${t||"No code provided"}`].join(`
`)),await this.send()});r(this,"fixIssueWithAI",async(e,t)=>{this._logService.clear(),this.setInput(["Fix the following issue in my code:",e.label,t.label].join(`
`)),await this.send()});this._repository=e,this._logService=t,this.conversationId=c(null),this._input=c(""),this._attachments=c([]),this._badgeState=c({type:"seen"}),this._smartChatState=c("idle")}init(){this.setupThread(),this.renderCopyButtons()}get hasError(){var e;return((e=this._hasError.value)==null?void 0:e.payload)||null}get logService(){return this._logService}shouldRenderLoadMoreHistory(){return!this._threadHistoryFetchInfo.value.done}get pastThreads(){return this._history.value.map(e=>{if(e.messages.length===0)return{threadId:e.id,title:"New thread"};{const t=this.extractTextContent(e.messages[0].content);return{threadId:e.id,title:t.slice(0,20)+"..."}}})}get recentlyAccessedThreads(){return this._recentlyAccessedThreads.value.map(e=>{if(e.messages.length===0)return{threadId:e.id,title:"New thread"};{const t=this.extractTextContent(e.messages[0].content);return{threadId:e.id,title:t.slice(0,20)+"..."}}})}get badgeState(){return this._badgeState.value}get input(){return this._input.value}}class E{constructor(){r(this,"logState",ie({log:[]}));r(this,"_listeners",{});r(this,"getLastExecutionLogs",e=>{let t="";for(let s=this.logs.length-1;s>=0;s--){const i=this.logs[s];if(i.type!==e&&t.length>0)break;i.type===e&&(t=`${i.log}
${t}`)}return t})}static create(){return new E}get logs(){return this.logState.log}hasAiLogs(){return this.logs.some(e=>e.type==="ai-input"||e.type==="ai-output")}log(e,t){if(e.type!=="restart"&&e.type!=="ai-tool-approval"&&e.type!=="ai-tool-call-response"&&"log"in e&&e.log.trim()==="")return;const s=t?this.logs.find(i=>i.id===t):null;return s?(s.type==="stderr"&&e.type==="stderr"&&(e.log=s.log+`
`+e.log),Object.assign(s,e)):this.logs.push({...e,id:t||C()}),this.notifyListeners(e),t}clear(){this.logState.log=[]}listen(e){const t=C();return this._listeners[t]=e,t}unlisten(e){delete this._listeners[e]}notifyListeners(e){Object.values(this._listeners).forEach(t=>t(e))}}const Ue=new ae,qe=oe("omniChat",()=>{const a=c(!0),e=c(!1),t=E.create(),s=O(),i=O(),u=(f,y)=>{if(!i.value)if(f==="console"){if(!y)throw new Error("Project ID is required for console chat");s.value=new He(y),i.value=new B(s.value,t)}else s.value=new $e,i.value=new B(s.value,t)},l=()=>{e.value=!0},h=()=>{e.value=!1},d=()=>{a.value=!0,l()},g=()=>{a.value=!1,h()};return{isOpen:a,isInputFocused:e,focusInput:l,blurInput:h,open:d,close:g,toggle:()=>{a.value?g():d()},controller:w(()=>i.value),repository:s,init:u}});export{Fe as H,$e as L,B as S,E as a,Ue as o,qe as u};
//# sourceMappingURL=omniChatStore.81aa62c1.js.map
