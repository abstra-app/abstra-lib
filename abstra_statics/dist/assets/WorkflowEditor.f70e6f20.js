var ht=Object.defineProperty;var ft=(a,e,t)=>e in a?ht(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var T=(a,e,t)=>(ft(a,typeof e!="symbol"?e+"":e,t),t);import{d as V,D as K,f as C,o as n,Y as k,$ as B,S as x,e8 as ve,a as $,O as l,cM as Ie,R as Re,ej as U,b as p,w as g,u as i,aS as R,eb as de,c as I,dh as G,dc as se,aG as j,e9 as O,da as vt,ec as Y,cO as yt,bT as Ee,a0 as ne,e as N,g as ye,bB as _e,aW as Xe,ed as xe,Z as q,X as Ce,ah as Ae,bL as me,cz as fe,cy as We,cL as mt,ev as wt,aB as Se,eo as kt,d9 as _t,em as St,en as bt,eh as It,ew as $t,ex as Tt}from"./index.b1912cd6.js";import{M as Ue,u as X,P as Et,_ as xt,a as Ct,b as At,g as Ge,c as le,N as Pt,d as Dt,e as Ft,f as Nt,h as Mt}from"./vue-flow-minimap.1c86bf47.js";import{u as ge}from"./uuid.5eeab72a.js";import{a as Vt,c as qe,v as Je,n as Qe}from"./validations.7aa1cbcc.js";import{w as we,s as zt}from"./metadata.78a581e5.js";import{a as et}from"./asyncComputed.55706e46.js";import"./linters.02e8c798.js";import{W as he}from"./workspaces.c8528a57.js";import{U as Bt,G as Ht}from"./UnsavedChangesHandler.57809eb7.js";import{A as jt}from"./index.2ba7a434.js";import{A as $e}from"./index.8dc17d47.js";import{G as Lt}from"./PhArrowCounterClockwise.vue.b7a3b4a2.js";import{T as Ot}from"./TasksManager.f6d72a8a.js";import{A as Zt}from"./index.9258f83e.js";import{t as tt}from"./index.393e7e01.js";import{B as Rt}from"./Badge.8c8b498a.js";import{G as Ye}from"./PhArrowDown.vue.40b46abe.js";import"./string.b7533bb9.js";import"./PhRobot.vue.5626b28f.js";import"./PhWebhooksLogo.vue.891b608f.js";import"./workspaceStore.38d723a3.js";import"./url.98d5bbfc.js";import"./colorHelpers.4f5d4af1.js";import"./record.9480e33e.js";import"./ExclamationCircleOutlined.d9dc9a17.js";import"./tasksController.f7a083b5.js";import"./gateway.2415be42.js";import"./popupNotifcation.d7561fbe.js";import"./scripts.856960ec.js";import"./polling.8809e63f.js";import"./ant-design.513f612e.js";import"./PhArrowSquareOut.vue.e20a2e04.js";import"./AbstraButton.vue_vue_type_script_setup_true_lang.50d80dd4.js";import"./Card.892d3746.js";import"./TabPane.5164eeb1.js";import"./CollapsePanel.643a1701.js";import"./index.4d35294c.js";(function(){try{var a=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(a._sentryDebugIds=a._sentryDebugIds||{},a._sentryDebugIds[e]="86f513c4-81ba-4a66-b811-0afce81ea9b1",a._sentryDebugIdIdentifier="sentry-dbid-86f513c4-81ba-4a66-b811-0afce81ea9b1")}catch{}})();const Yt=["width","height","fill","transform"],Kt={key:0},Xt=$("path",{d:"M244,56v48a12,12,0,0,1-12,12H184a12,12,0,1,1,0-24H201.1l-19-17.38c-.13-.12-.26-.24-.38-.37A76,76,0,1,0,127,204h1a75.53,75.53,0,0,0,52.15-20.72,12,12,0,0,1,16.49,17.45A99.45,99.45,0,0,1,128,228h-1.37A100,100,0,1,1,198.51,57.06L220,76.72V56a12,12,0,0,1,24,0Z"},null,-1),Wt=[Xt],Ut={key:1},Gt=$("path",{d:"M216,128a88,88,0,1,1-88-88A88,88,0,0,1,216,128Z",opacity:"0.2"},null,-1),qt=$("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1,0-16H211.4L184.81,71.64l-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,0,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60L224,85.8V56a8,8,0,1,1,16,0Z"},null,-1),Jt=[Gt,qt],Qt={key:2},es=$("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1-5.66-13.66l17-17-10.55-9.65-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,1,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60l10.93,10L226.34,50.3A8,8,0,0,1,240,56Z"},null,-1),ts=[es],ss={key:3},as=$("path",{d:"M238,56v48a6,6,0,0,1-6,6H184a6,6,0,0,1,0-12h32.55l-30.38-27.8c-.06-.06-.12-.13-.19-.19a82,82,0,1,0-1.7,117.65,6,6,0,0,1,8.24,8.73A93.46,93.46,0,0,1,128,222h-1.28A94,94,0,1,1,194.37,61.4L226,90.35V56a6,6,0,1,1,12,0Z"},null,-1),os=[as],is={key:4},ns=$("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1,0-16H211.4L184.81,71.64l-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,0,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60L224,85.8V56a8,8,0,1,1,16,0Z"},null,-1),rs=[ns],ls={key:5},ds=$("path",{d:"M236,56v48a4,4,0,0,1-4,4H184a4,4,0,0,1,0-8h37.7L187.53,68.69l-.13-.12a84,84,0,1,0-1.75,120.51,4,4,0,0,1,5.5,5.82A91.43,91.43,0,0,1,128,220h-1.26A92,92,0,1,1,193,62.84l35,32.05V56a4,4,0,1,1,8,0Z"},null,-1),cs=[ds],us={name:"PhArrowClockwise"},ps=V({...us,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(a){const e=a,t=K("weight","regular"),s=K("size","1em"),o=K("color","currentColor"),r=K("mirrored",!1),c=C(()=>{var v;return(v=e.weight)!=null?v:t}),y=C(()=>{var v;return(v=e.size)!=null?v:s}),_=C(()=>{var v;return(v=e.color)!=null?v:o}),u=C(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:r?"scale(-1, 1)":void 0);return(v,m)=>(n(),k("svg",ve({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:y.value,height:y.value,fill:_.value,transform:u.value},v.$attrs),[B(v.$slots,"default"),c.value==="bold"?(n(),k("g",Kt,Wt)):c.value==="duotone"?(n(),k("g",Ut,Jt)):c.value==="fill"?(n(),k("g",Qt,ts)):c.value==="light"?(n(),k("g",ss,os)):c.value==="regular"?(n(),k("g",is,rs)):c.value==="thin"?(n(),k("g",ls,cs)):x("",!0)],16,Yt))}}),gs=["width","height","fill","transform"],hs={key:0},fs=$("path",{d:"M234.29,47.91A20,20,0,0,0,216,36H40A20,20,0,0,0,25.2,69.45l.12.14L92,140.75V216a20,20,0,0,0,31.1,16.64l32-21.33A20,20,0,0,0,164,194.66V140.75l66.67-71.16.12-.14A20,20,0,0,0,234.29,47.91Zm-91,79.89A12,12,0,0,0,140,136v56.52l-24,16V136a12,12,0,0,0-3.25-8.2L49.23,60H206.77Z"},null,-1),vs=[fs],ys={key:1},ms=$("path",{d:"M221.9,61.38,152,136v58.65a8,8,0,0,1-3.56,6.66l-32,21.33A8,8,0,0,1,104,216V136L34.1,61.38A8,8,0,0,1,40,48H216A8,8,0,0,1,221.9,61.38Z",opacity:"0.2"},null,-1),ws=$("path",{d:"M230.6,49.53A15.81,15.81,0,0,0,216,40H40A16,16,0,0,0,28.19,66.76l.08.09L96,139.17V216a16,16,0,0,0,24.87,13.32l32-21.34A16,16,0,0,0,160,194.66V139.17l67.74-72.32.08-.09A15.8,15.8,0,0,0,230.6,49.53ZM40,56h0Zm106.18,74.58A8,8,0,0,0,144,136v58.66L112,216V136a8,8,0,0,0-2.16-5.47L40,56H216Z"},null,-1),ks=[ms,ws],_s={key:2},Ss=$("path",{d:"M227.81,66.76l-.08.09L160,139.17v55.49A16,16,0,0,1,152.87,208l-32,21.34A16,16,0,0,1,96,216V139.17L28.27,66.85l-.08-.09A16,16,0,0,1,40,40H216a16,16,0,0,1,11.84,26.76Z"},null,-1),bs=[Ss],Is={key:3},$s=$("path",{d:"M228.77,50.34A13.8,13.8,0,0,0,216,42H40A14,14,0,0,0,29.67,65.42l.06.07L98,138.38V216a14,14,0,0,0,21.77,11.64l32-21.33A14,14,0,0,0,158,194.66V138.38l68.33-73A13.82,13.82,0,0,0,228.77,50.34Zm-11.26,6.94L147.62,131.9A6,6,0,0,0,146,136v58.66a2,2,0,0,1-.89,1.67l-32,21.33A2,2,0,0,1,110,216V136a6,6,0,0,0-1.62-4.1L38.53,57.32A2,2,0,0,1,40,54H216a1.9,1.9,0,0,1,1.83,1.19A1.86,1.86,0,0,1,217.51,57.28Z"},null,-1),Ts=[$s],Es={key:4},xs=$("path",{d:"M230.6,49.53A15.81,15.81,0,0,0,216,40H40A16,16,0,0,0,28.19,66.76l.08.09L96,139.17V216a16,16,0,0,0,24.87,13.32l32-21.34A16,16,0,0,0,160,194.66V139.17l67.74-72.32.08-.09A15.8,15.8,0,0,0,230.6,49.53ZM40,56h0Zm106.18,74.58A8,8,0,0,0,144,136v58.66L112,216V136a8,8,0,0,0-2.16-5.47L40,56H216Z"},null,-1),Cs=[xs],As={key:5},Ps=$("path",{d:"M227,51.15A11.85,11.85,0,0,0,216,44H40a12,12,0,0,0-8.88,20.07l.05.05L100,137.59V216a12,12,0,0,0,18.66,10l32-21.33a12,12,0,0,0,5.35-10V137.59l68.86-73.52A11.85,11.85,0,0,0,227,51.15Zm-8,7.5-69.9,74.62A4,4,0,0,0,148,136v58.65a4,4,0,0,1-1.78,3.33l-32,21.33A4,4,0,0,1,108,216V136a4,4,0,0,0-1.08-2.74L37.05,58.67A4,4,0,0,1,40,52H216a4,4,0,0,1,3,6.65Z"},null,-1),Ds=[Ps],Fs={name:"PhFunnel"},Ns=V({...Fs,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(a){const e=a,t=K("weight","regular"),s=K("size","1em"),o=K("color","currentColor"),r=K("mirrored",!1),c=C(()=>{var v;return(v=e.weight)!=null?v:t}),y=C(()=>{var v;return(v=e.size)!=null?v:s}),_=C(()=>{var v;return(v=e.color)!=null?v:o}),u=C(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:r?"scale(-1, 1)":void 0);return(v,m)=>(n(),k("svg",ve({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:y.value,height:y.value,fill:_.value,transform:u.value},v.$attrs),[B(v.$slots,"default"),c.value==="bold"?(n(),k("g",hs,vs)):c.value==="duotone"?(n(),k("g",ys,ks)):c.value==="fill"?(n(),k("g",_s,bs)):c.value==="light"?(n(),k("g",Is,Ts)):c.value==="regular"?(n(),k("g",Es,Cs)):c.value==="thin"?(n(),k("g",As,Ds)):x("",!0)],16,gs))}}),Ms=l.object({type:l.enum(["forms","hooks"]),id:l.string(),title:l.string(),position:l.object({x:l.number(),y:l.number()}),props:l.object({path:l.string().nullable(),filename:l.string().nullable()})}),Vs=l.object({type:l.literal("scripts"),id:l.string(),title:l.string(),position:l.object({x:l.number(),y:l.number()}),props:l.object({filename:l.string().nullable()})}),zs=l.object({type:l.literal("jobs"),id:l.string(),title:l.string(),position:l.object({x:l.number(),y:l.number()}),props:l.object({filename:l.string().nullable()})}),Bs=l.object({type:l.literal("agents"),id:l.string(),title:l.string(),position:l.object({x:l.number(),y:l.number()}),props:l.object({projectId:l.string().nullable(),clientStageId:l.string().nullable()})}),Hs=l.object({type:l.literal("clients"),id:l.string(),title:l.string(),position:l.object({x:l.number(),y:l.number()}),props:l.object({})}),js=l.union([Vs,Ms,Bs,Hs,zs]),Ls=l.object({id:l.string(),type:l.literal("task"),sourceStageId:l.string(),targetStageId:l.string(),props:l.object({taskType:l.string().nullable()})}),Ke=l.object({stages:l.array(js),transitions:l.array(Ls)}),Os={"Content-Type":"application/json"};class Zs{async load(){const e=await fetch("/_editor/api/workflows");if(e.ok){const t=await e.json(),s=Ke.safeParse(t);if(s.success)return s.data;throw console.error(s.error.errors),new Error("Failed to parse initial data")}else throw new Error("Failed to fetch initial data")}async update(e){const t=await fetch("/_editor/api/workflows",{method:"PUT",headers:Os,body:JSON.stringify(e)});if(t.ok){const s=await t.json(),o=Ke.safeParse(s);if(o.success)return o.data;throw new Error("Failed to parse updated data:",s)}else throw new Error("Failed to update workflow")}}const Rs=new Zs;function st(){return Math.random().toString(36).slice(2,9)}class re{constructor(e){this.changes=e}apply(e){return this.changes.reduce((t,s)=>s.apply(t),e)}reverse(){return new re(this.changes.map(e=>e.reverse()).reverse())}}class at{constructor(e){T(this,"removed");this.stageId=e,this.removed=null}apply(e){const t=e.stages.find(o=>o.id===this.stageId)||null;if(!t)throw new Error(`Stage ${this.stageId} not found`);const s=e.transitions.filter(o=>o.sourceStageId===this.stageId||o.targetStageId===this.stageId);return this.removed={stage:t,transitions:s},{stages:e.stages.filter(o=>o.id!==t.id),transitions:e.transitions.filter(o=>!s.find(r=>r.id===o.id))}}reverse(){if(!this.removed)throw new Error("Cannot reverse change that was not applied");const e=new ot(this.removed.stage.type,this.removed.stage.title,this.removed.stage.position,this.removed.stage.id,this.removed.stage.props),t=this.removed.transitions.map(s=>new Pe(s.sourceStageId,s.targetStageId,s.type,s.id));return new re([e,...t])}}class ot{constructor(e,t,s,o,r){T(this,"addedStage");this.stageType=e,this.nodeTitle=t,this.position=s,this.id=o,this.props=r,this.addedStage=null}assertStageDoesNotExist(e){if(e.stages.find(t=>t.id===this.id))throw new Error(`Stage ${this.id} already exists`)}assertValidStageType(){if(!we.stages.find(e=>e.typeName===this.stageType))throw new Error(`Invalid stage type ${this.stageType}`)}assertTransitionDoesNotExist(e){if(e.transitions.find(t=>t.sourceStageId===this.id||t.targetStageId===this.id))throw new Error("Stage already has transitions")}makePath(e){switch(this.stageType){case"forms":return`new-form-${e}`;case"hooks":return`new-hook-${e}`;default:return null}}makeFilename(e){switch(this.stageType){case"forms":return`new_form_${e}.py`;case"hooks":return`new_hook_${e}.py`;case"jobs":return`new_job_${e}.py`;case"scripts":return`new_script_${e}.py`;default:return null}}apply(e){var s,o,r,c;const t=st();switch(this.assertStageDoesNotExist(e),this.assertValidStageType(),this.assertTransitionDoesNotExist(e),this.stageType){case"forms":case"hooks":{const y={path:this.makePath(t),filename:this.makeFilename(t),...this.props};this.addedStage={id:(s=this.id)!=null?s:ge(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:y};break}case"jobs":case"scripts":{const y={filename:this.makeFilename(t),...this.props};this.addedStage={id:(o=this.id)!=null?o:ge(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:y};break}case"agents":{this.addedStage={id:(r=this.id)!=null?r:ge(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:{projectId:null,clientStageId:null}};break}case"clients":{this.addedStage={id:(c=this.id)!=null?c:ge(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:{}};break}default:throw new Error(`Invalid stage type ${this.stageType}`)}if(!this.addedStage)throw new Error("Stage not created");return{transitions:e.transitions,stages:[...e.stages,this.addedStage]}}reverse(){if(!this.addedStage)throw new Error("Cannot reverse change that was not applied");return new at(this.addedStage.id)}}class Ys extends re{constructor(e){super(e.map(t=>new ot(t.type,t.title,t.position,t.id)))}}class it{constructor(e){T(this,"removedTransition");this.transitionId=e,this.removedTransition=null}apply(e){const t=e.transitions.find(s=>s.id===this.transitionId);if(!t)throw new Error(`Transition ${this.transitionId} not found`);return this.removedTransition=t!=null?t:null,{stages:e.stages,transitions:e.transitions.filter(s=>s.id!==this.transitionId)}}reverse(){if(!this.removedTransition)throw new Error("Cannot reverse change that was not applied");return new Pe(this.removedTransition.sourceStageId,this.removedTransition.targetStageId,this.removedTransition.type,this.removedTransition.id)}}class Pe{constructor(e,t,s,o){T(this,"addedTransition");this.sourceStageId=e,this.targetStageId=t,this.transitionType=s,this.transitionId=o,this.addedTransition=null}assertSourceStageExists(e){if(!e.stages.find(t=>t.id===this.sourceStageId))throw new Error(`Stage ${this.sourceStageId} not found`)}assertTargetStageExists(e){if(!e.stages.find(t=>t.id===this.targetStageId))throw new Error(`Stage ${this.targetStageId} not found`)}assertTransitionDoesNotExist(e){if(e.transitions.find(t=>t.id===this.transitionId))throw new Error(`Transition ${this.transitionId} already exists`)}assertNotSelfTransition(){if(this.sourceStageId===this.targetStageId)throw new Error("Self transitions are not allowed")}assertNoDuplicatedTransitionStages(e){if(e.transitions.find(t=>t.sourceStageId===this.sourceStageId&&t.targetStageId===this.targetStageId))throw Ie.error({message:"Invalid transition",description:"Transition already exists"}),new Error("Transition already exists")}assertNoStageWithSameId(e){if(e.stages.find(t=>t.id===this.transitionId))throw new Error(`Stage with id ${this.transitionId} already exists`)}apply(e){return this.assertSourceStageExists(e),this.assertTargetStageExists(e),this.assertTransitionDoesNotExist(e),this.assertNotSelfTransition(),this.assertNoDuplicatedTransitionStages(e),this.assertNoStageWithSameId(e),this.addedTransition={id:this.transitionId,sourceStageId:this.sourceStageId,targetStageId:this.targetStageId,type:this.transitionType,props:{taskType:null}},{stages:e.stages,transitions:[...e.transitions,this.addedTransition]}}reverse(){if(!this.addedTransition)throw new Error("Cannot reverse change that was not applied");return new it(this.addedTransition.id)}}class Ks extends re{constructor(e){super(e.map(t=>new Pe(t.sourceStageId,t.targetStageId,t.type,t.id)))}}class De{constructor(e){T(this,"oldPositions");this.newPositions=e,this.oldPositions=null}assertStagesExists(e){this.newPositions.forEach(({id:t})=>{if(!e.stages.find(s=>s.id===t))throw new Error(`Stage ${t} not found`)})}assertIsNumber(){this.newPositions.forEach(({position:e})=>{if(Number.isNaN(e.x)||Number.isNaN(e.y)||!Number.isFinite(e.x)||!Number.isFinite(e.y))throw new Error("Position must be a number")})}apply(e){return this.assertIsNumber(),this.assertStagesExists(e),this.oldPositions=e.stages.map(s=>({id:s.id,position:s.position})),{stages:e.stages.map(s=>{var r,c;const o=(c=(r=this.newPositions.find(y=>y.id===s.id))==null?void 0:r.position)!=null?c:s.position;return{...s,position:{x:o.x,y:o.y}}}),transitions:e.transitions}}reverse(){if(!this.oldPositions)throw new Error("Cannot reverse change that was not applied");return new De(this.oldPositions)}}class Fe{constructor(e,t){T(this,"stageId");T(this,"newTitle");T(this,"oldTitle");this.stageId=e,this.newTitle=t,this.oldTitle=""}assertStageExists(e){if(!e.stages.find(t=>t.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}apply(e){return this.assertStageExists(e),this.oldTitle=e.stages.find(t=>t.id===this.stageId).title,{stages:e.stages.map(t=>t.id===this.stageId?{...t,title:this.newTitle}:t),transitions:e.transitions}}reverse(){return new Fe(this.stageId,this.oldTitle)}}class Ne{constructor(e,t){T(this,"stageId");T(this,"newProps");T(this,"oldProps");this.stageId=e,this.newProps=t}assertStageExists(e){if(!e.stages.find(t=>t.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}assertValidPath(){if(!("path"in this.newProps)||!this.newProps.path)return;const e=Vt(this.newProps.path);if(!e.valid){Ie.error({message:"Invalid path",description:e.reason});return}this.newProps.path=qe(this.newProps.path)}assertValidFilename(){if(!("filename"in this.newProps)||!this.newProps.filename)return;const e=Je(this.newProps.filename);if(!e.valid){Ie.error({message:"Invalid filename",description:e.reason});return}this.newProps.filename=Qe(this.newProps.filename)}apply(e){return this.assertStageExists(e),this.assertValidPath(),this.assertValidFilename(),this.oldProps=e.stages.find(t=>t.id===this.stageId).props,{stages:e.stages.map(t=>t.id===this.stageId?{...t,props:this.newProps}:t),transitions:e.transitions}}reverse(){return new Ne(this.stageId,this.oldProps)}}class Me{constructor(e,t){T(this,"newProps");T(this,"transitionId");T(this,"oldProps");this.newProps=t,this.transitionId=e,this.oldProps=t}apply(e){return{transitions:e.transitions.map(t=>t.id===this.transitionId?(this.oldProps=t.props,{...t,props:this.newProps}):t),stages:e.stages}}reverse(){return new Me(this.transitionId,this.oldProps)}}class Xs extends re{constructor(e,t){super([...t.map(s=>new it(s)),...e.map(s=>new at(s))])}}class Ws{constructor(e){T(this,"currentState");T(this,"serverState");T(this,"undoStack");T(this,"redoStack");this.undoStack=[],this.redoStack=[],this.currentState=Re(Object.freeze(e)),this.serverState=Re(Object.freeze(e))}apply(e){return this.currentState.value=e.apply(this.currentState.value),this.undoStack.push(e),this.redoStack=[],this.currentState.value}canUndo(){return this.undoStack.length>0}undo(){const e=this.undoStack.pop();if(e){const t=e.reverse();this.currentState.value=t.apply(this.currentState.value),this.redoStack.push(e)}return this.currentState.value}canRedo(){return this.redoStack.length>0}redo(){const e=this.redoStack.pop();return e&&(this.currentState.value=e.apply(this.currentState.value),this.undoStack.push(e)),this.currentState.value}getState(){return this.currentState.value}setServerState(e){this.serverState.value=e}getServerState(){return this.serverState.value}hasStageChanges(){return!U.exports.isEqual(this.currentState.value.stages,this.serverState.value.stages)}hasChanges(){const e={...this.currentState.value,stages:[...this.currentState.value.stages].sort((s,o)=>s.id.localeCompare(o.id)),transitions:[...this.currentState.value.transitions].sort((s,o)=>s.id.localeCompare(o.id))},t={...this.serverState.value,stages:[...this.serverState.value.stages].sort((s,o)=>s.id.localeCompare(o.id)),transitions:[...this.serverState.value.transitions].sort((s,o)=>s.id.localeCompare(o.id))};return!U.exports.isEqual(e,t)}stageHasChanges(e){const t=this.currentState.value.stages.find(o=>o.id===e),s=this.serverState.value.stages.find(o=>o.id===e);return!U.exports.isEqual(t,s)}stageHasNonPositionChanges(e){const t=this.currentState.value.stages.find(o=>o.id===e),s=this.serverState.value.stages.find(o=>o.id===e);return!U.exports.isEqual(U.exports.omit(t,"position"),U.exports.omit(s,"position"))}}const Us=2;class Ve{constructor(e,t,s){T(this,"api");T(this,"editable");T(this,"history");T(this,"vueFlowNodes");T(this,"vueFlowEdges");this.editable=s,this.api=e,this.history=new Ws(t),this.vueFlowNodes=C(()=>this.computeVueFlowNodes()),this.vueFlowEdges=C(()=>this.computeVueFlowEdges())}static async init(e,t){const s=await e.load();return new Ve(e,s,t)}inflateYFactor(){return this.editable?1:Us}computeVueFlowNodes(){return this.history.getState().stages.map(t=>({id:t.id,type:t.type,data:t,position:{x:t.position.x,y:t.position.y*this.inflateYFactor()}}))}computeVueFlowEdges(){return this.history.getState().transitions.map(t=>({id:t.id,source:t.sourceStageId,target:t.targetStageId,type:"task",label:"task",markerEnd:{type:Ue.Arrow,width:24,height:24},data:t}))}getStage(e){var t;return(t=this.history.getState().stages.find(s=>s.id===e))!=null?t:null}updateStageTitle(e,t){this.history.apply(new Fe(e,t))}updateStageProps(e,t){this.history.apply(new Ne(e,t))}addStages(e){const t=e[0].type.slice(0,-1),s=t==="script"?"tasklet":t;return this.history.apply(new Ys(e.map(o=>{var r;return{...o,title:(r=o.title)!=null?r:`New ${s}`}}))),this.history.getState().stages.slice(-e.length)}connect(e){this.history.apply(new Ks(e))}move(e){this.history.apply(new De(e))}delete(e){const t=this.history.getState(),s=t.stages.filter(r=>e.includes(r.id)).map(r=>r.id),o=t.transitions.filter(r=>e.includes(r.id)).map(r=>r.id);this.history.apply(new Xs(s,o))}updateTransitionProps(e,t){this.history.apply(new Me(e,t))}hasChanges(){return this.history.hasChanges()}async save(){if(this.history.hasChanges()){const e=await this.api.update(this.history.getState());this.history.setServerState(e)}}}class ze{static get isMac(){return navigator.userAgent.includes("Mac OS X")}static get buildPlatform(){return{}.CURRENT_PLATFORM||"web"}}const te=a=>ze.isMac?a.metaKey:a.ctrlKey,Gs=a=>a.altKey,nt=a=>a.shiftKey,be={alt:Gs,"arrow-up":a=>a.code==="ArrowUp","arrow-down":a=>a.code==="ArrowDown","arrow-left":a=>a.code==="ArrowLeft","arrow-right":a=>a.code==="ArrowRight",ctrl:te,delete:a=>ze.isMac?a.code==="Backspace":a.code==="Delete",enter:a=>a.code==="Enter",escape:a=>a.code==="Escape",shift:nt,space:a=>a.code==="Space",a:a=>a.code==="KeyA",b:a=>a.code==="KeyB",c:a=>a.code==="KeyC",d:a=>a.code==="KeyD",f:a=>a.code==="KeyF",g:a=>a.code==="KeyG",h:a=>a.code==="KeyH",k:a=>a.code==="KeyK",p:a=>a.code==="KeyP",v:a=>a.code==="KeyV",x:a=>a.code==="KeyX",z:a=>a.code==="KeyZ",0:a=>a.code==="Digit0","[":a=>a.code==="BracketLeft","]":a=>a.code==="BracketRight"};class qs{constructor(e){T(this,"pressedKeys");T(this,"evt");this.evt=e,this.pressedKeys={};const t=s=>o=>{Object.keys(be).forEach(r=>{be[r](o)&&this.setPressed(r,s)})};this.evt||(window.addEventListener("keydown",t(!0)),window.addEventListener("keyup",t(!1)))}setPressed(e,t){this.pressedKeys[e]=t}isPressed(e){var t;return this.evt?be[e](this.evt):(t=this.pressedKeys[e])!=null?t:!1}}new qs;const Js=["onDragstart"],Qs={style:{display:"flex","flex-direction":"column","max-width":"250px"}},ea=V({__name:"BottomToolbar",props:{controller:{}},emits:["drag-start"],setup(a,{emit:e}){return(t,s)=>(n(),k(R,null,[p(i(G),{class:"toolbar",align:"center"},{default:g(()=>[(n(!0),k(R,null,de(i(we).stages,o=>(n(),I(i(yt),{key:o.key,placement:"top"},{title:g(()=>[p(i(G),{gap:"small"},{default:g(()=>[p(i(se),null,{default:g(()=>[j(O(o.title),1)]),_:2},1024),p(i(se),{keyboard:""},{default:g(()=>[j(O(o.key),1)]),_:2},1024)]),_:2},1024)]),content:g(()=>[$("div",Qs,[p(i(se),null,{default:g(()=>[j(O(o.description),1)]),_:2},1024),o.beta?(n(),I(i($e),{key:0,type:"warning",class:"beta-alert"},{description:g(()=>[p(i(se),null,{default:g(()=>[j(" This is a beta feature, "),p(i(vt),{href:"https://abstra.io/docs/concepts/agents/",target:"_blank"},{default:g(()=>[j(" click here ")]),_:1}),j(" to learn more about it ")]),_:1})]),_:1})):x("",!0)])]),default:g(()=>[$("div",{draggable:!0,class:"toolbar__item",onDragstart:r=>e("drag-start",r.dataTransfer,o.typeName)},[(n(),I(Y(o.icon),{size:18}))],40,Js)]),_:2},1024))),128)),p(i(jt),{type:"vertical"}),p(i(Ee),{disabled:!t.controller.hasChanges(),onClick:s[0]||(s[0]=o=>t.controller.save())},{default:g(()=>[p(i(G),{align:"center",gap:"small"},{default:g(()=>[p(i(Ht),{size:16}),j(" Save ")]),_:1})]),_:1},8,["disabled"])]),_:1}),p(Bt,{"has-changes":t.controller.hasChanges()},null,8,["has-changes"])],64))}});const ta=ne(ea,[["__scopeId","data-v-8abfff78"]]);function rt(){let a;const e={draggedType:N(null),isDragOver:N(!1),isAdding:N(!1),isDragging:N(!1),mousePosition:N(null)},{draggedType:t,isDragOver:s,isDragging:o,isAdding:r}=e,c=b=>{a=b,document.addEventListener("mousemove",A)},{screenToFlowCoordinate:y}=X();ye(r,b=>{document.body.style.userSelect=b?"none":""});function _(b,M){r.value=!0,b?(b.setData("application/vueflow",M),b.effectAllowed="move",t.value=M,o.value=!0,document.addEventListener("drop",m)):(t.value=M,document.addEventListener("click",f))}function u(b){b.preventDefault(),t.value&&(s.value=!0,b.dataTransfer&&(b.dataTransfer.dropEffect="move"))}function v(){s.value=!1}function m(){r.value=!1,o.value=!1,s.value=!1,t.value=null,document.removeEventListener("drop",m)}function A(b){const M={x:b.pageX-200,y:b.pageY-80};e.mousePosition.value=M}function h(b){if(!t.value)throw new Error("No dragged type");return y({x:b.clientX-70,y:b.clientY-25})}function f(b){if(!a)return;if(!t.value)throw new Error("No dragged type");const M=h(b);a.addStages([{type:t.value,position:M}]),m()}function F(){document.removeEventListener("mousemove",A)}return{init:c,tearDown:F,draggedType:t,isDragOver:s,isAdding:r,isDragging:o,mousePosition:e.mousePosition,onDragStart:_,onDragLeave:v,onDragOver:u,onDrop:f}}const sa={name:"ControlButton",compatConfig:{MODE:3}},aa=(a,e)=>{const t=a.__vccOpts||a;for(const[s,o]of e)t[s]=o;return t},oa={class:"vue-flow__controls-button"};function ia(a,e,t,s,o,r){return n(),k("button",oa,[B(a.$slots,"default")])}const ie=aa(sa,[["render",ia]]),na={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32"},ra=$("path",{d:"M32 18.133H18.133V32h-4.266V18.133H0v-4.266h13.867V0h4.266v13.867H32z"},null,-1),la=[ra];function da(a,e){return n(),k("svg",na,la)}const ca={render:da},ua={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 5"},pa=$("path",{d:"M0 0h32v4.2H0z"},null,-1),ga=[pa];function ha(a,e){return n(),k("svg",ua,ga)}const fa={render:ha},va={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 30"},ya=$("path",{d:"M3.692 4.63c0-.53.4-.938.939-.938h5.215V0H4.708C2.13 0 0 2.054 0 4.63v5.216h3.692V4.631zM27.354 0h-5.2v3.692h5.17c.53 0 .984.4.984.939v5.215H32V4.631A4.624 4.624 0 0 0 27.354 0zm.954 24.83c0 .532-.4.94-.939.94h-5.215v3.768h5.215c2.577 0 4.631-2.13 4.631-4.707v-5.139h-3.692v5.139zm-23.677.94a.919.919 0 0 1-.939-.94v-5.138H0v5.139c0 2.577 2.13 4.707 4.708 4.707h5.138V25.77H4.631z"},null,-1),ma=[ya];function wa(a,e){return n(),k("svg",va,ma)}const ka={render:wa},_a={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},Sa=$("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0 8 0 4.571 3.429 4.571 7.619v3.048H3.048A3.056 3.056 0 0 0 0 13.714v15.238A3.056 3.056 0 0 0 3.048 32h18.285a3.056 3.056 0 0 0 3.048-3.048V13.714a3.056 3.056 0 0 0-3.048-3.047zM12.19 24.533a3.056 3.056 0 0 1-3.047-3.047 3.056 3.056 0 0 1 3.047-3.048 3.056 3.056 0 0 1 3.048 3.048 3.056 3.056 0 0 1-3.048 3.047zm4.724-13.866H7.467V7.619c0-2.59 2.133-4.724 4.723-4.724 2.591 0 4.724 2.133 4.724 4.724v3.048z"},null,-1),ba=[Sa];function Ia(a,e){return n(),k("svg",_a,ba)}const $a={render:Ia},Ta={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},Ea=$("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0c-4.114 1.828-1.37 2.133.305 2.438 1.676.305 4.42 2.59 4.42 5.181v3.048H3.047A3.056 3.056 0 0 0 0 13.714v15.238A3.056 3.056 0 0 0 3.048 32h18.285a3.056 3.056 0 0 0 3.048-3.048V13.714a3.056 3.056 0 0 0-3.048-3.047zM12.19 24.533a3.056 3.056 0 0 1-3.047-3.047 3.056 3.056 0 0 1 3.047-3.048 3.056 3.056 0 0 1 3.048 3.048 3.056 3.056 0 0 1-3.048 3.047z"},null,-1),xa=[Ea];function Ca(a,e){return n(),k("svg",Ta,xa)}const Aa={render:Ca},Pa={name:"Controls",compatConfig:{MODE:3}},Da=V({...Pa,props:{showZoom:{type:Boolean,default:!0},showFitView:{type:Boolean,default:!0},showInteractive:{type:Boolean,default:!0},fitViewParams:{},position:{default:()=>Et.BottomLeft}},emits:["zoomIn","zoomOut","fitView","interactionChange"],setup(a,{emit:e}){const{nodesDraggable:t,nodesConnectable:s,elementsSelectable:o,setInteractive:r,zoomIn:c,zoomOut:y,fitView:_,viewport:u,minZoom:v,maxZoom:m}=X(),A=_e(()=>t.value||s.value||o.value),h=_e(()=>u.value.zoom<=v.value),f=_e(()=>u.value.zoom>=m.value);function F(){c(),e("zoomIn")}function b(){y(),e("zoomOut")}function M(){_(a.fitViewParams),e("fitView")}function H(){r(!A.value),e("interactionChange",!A.value)}return(E,Z)=>(n(),I(i(xt),{class:"vue-flow__controls",position:E.position},{default:g(()=>[B(E.$slots,"top"),E.showZoom?(n(),k(R,{key:0},[B(E.$slots,"control-zoom-in",{},()=>[p(ie,{class:"vue-flow__controls-zoomin",disabled:f.value,onClick:F},{default:g(()=>[B(E.$slots,"icon-zoom-in",{},()=>[(n(),I(Y(i(ca))))])]),_:3},8,["disabled"])]),B(E.$slots,"control-zoom-out",{},()=>[p(ie,{class:"vue-flow__controls-zoomout",disabled:h.value,onClick:b},{default:g(()=>[B(E.$slots,"icon-zoom-out",{},()=>[(n(),I(Y(i(fa))))])]),_:3},8,["disabled"])])],64)):x("",!0),E.showFitView?B(E.$slots,"control-fit-view",{key:1},()=>[p(ie,{class:"vue-flow__controls-fitview",onClick:M},{default:g(()=>[B(E.$slots,"icon-fit-view",{},()=>[(n(),I(Y(i(ka))))])]),_:3})]):x("",!0),E.showInteractive?B(E.$slots,"control-interactive",{key:2},()=>[E.showInteractive?(n(),I(ie,{key:0,class:"vue-flow__controls-interactive",onClick:H},{default:g(()=>[A.value?B(E.$slots,"icon-unlock",{key:0},()=>[(n(),I(Y(i(Aa))))]):x("",!0),A.value?x("",!0):B(E.$slots,"icon-lock",{key:1},()=>[(n(),I(Y(i($a))))])]),_:3})):x("",!0)]):x("",!0),B(E.$slots,"default")]),_:3},8,["position"]))}}),Fa=V({__name:"ControlButtons",props:{workflow:{}},setup(a){return(e,t)=>(n(),I(i(Da),{position:"top-left","show-interactive":!1},{default:g(()=>[p(i(ie),{title:"Undo",disabled:!e.workflow.history.canUndo(),onClick:t[0]||(t[0]=s=>e.workflow.history.undo())},{default:g(()=>[p(i(Lt))]),_:1},8,["disabled"]),p(i(ie),{title:"Redo",disabled:!e.workflow.history.canRedo(),onClick:t[1]||(t[1]=s=>e.workflow.history.redo())},{default:g(()=>[p(i(ps))]),_:1},8,["disabled"])]),_:1}))}});class Na{constructor(e,t){T(this,"dx");T(this,"dy");this.dx=t.x-e.x,this.dy=t.y-e.y}get x(){return this.dx}get y(){return this.dy}get length(){return Math.sqrt(this.dx*this.dx+this.dy*this.dy)}get m(){return this.dy/this.dx}}function Ma(a,e,t=0){const{x:s,y:o}=e.center,{width:r,height:c}=e,y=new Na(a,e.center),_=t*(y.x/y.length),u=t*(y.y/y.length),v=c/r;let m,A;if(Math.abs(y.m)>Math.abs(v)){const h=c/2*(1/y.m);m=s-(y.y>0?h:-h),A=o+(y.y>0?-c/2:c/2)}else{const h=r/2*y.m;m=s+(y.x>0?-r/2:r/2),A=o-(y.x>0?h:-h)}return{x:m+_,y:A+u}}const Va=(a,e=0,t=0)=>{const s=Math.atan2(a.ty-a.sy,a.tx-a.sx),o=e*Math.sin(s),r=e*Math.cos(s),c=t*Math.cos(s),y=t*Math.sin(s);return{sourceX:a.sx-o+c,sourceY:a.sy+r+y,targetX:a.tx-o-c,targetY:a.ty+r-y}};function Te(a,e,t=0){const s={x:a.computedPosition.x+a.dimensions.width/2,y:a.computedPosition.y+a.dimensions.height/2},r={center:{x:e.computedPosition.x+e.dimensions.width/2,y:e.computedPosition.y+e.dimensions.height/2},width:e.dimensions.width,height:e.dimensions.height};return Ma(s,r,t)}function lt(a,e){const t=Te(a,e,-10),s=Te(e,a,-10);return{sx:s.x,sy:s.y,tx:t.x,ty:t.y}}const za=V({__name:"TaskMenu",props:{isConnecting:{type:Boolean},isEditing:{type:Boolean},menuOptions:{}},setup(a){return(e,t)=>(n(),I(i(G),{vertical:"",gap:"small",style:q({marginBottom:`-${16*e.menuOptions.length}%`})},{default:g(()=>[(n(!0),k(R,null,de(e.menuOptions,s=>(n(),I(i(Xe),{key:s.label,title:s.tooltip,placement:"right"},{default:g(()=>[p(i(Ee),{class:xe([{"warning-button":s.warning}]),disabled:s.disabled,style:q({backgroundColor:s.disabled?"#f5f5f5":void 0}),onClick:o=>s.click(o)},{default:g(()=>[p(i(G),{gap:"small",style:{width:"100%"},justify:"space-between",align:"center"},{default:g(()=>[j(O(s.label)+" ",1),s.key?(n(),I(i(se),{key:0,keyboard:"",disabled:s.disabled},{default:g(()=>[j(O(s.key),1)]),_:2},1032,["disabled"])):x("",!0)]),_:2},1024)]),_:2},1032,["class","disabled","style","onClick"])]),_:2},1032,["title"]))),128))]),_:1},8,["style"]))}});const Ba=V({__name:"TaskEdge",props:{id:{},sourceNode:{},targetNode:{},source:{},target:{},type:{},label:{type:[String,Object,Function]},style:{},selected:{type:Boolean},sourcePosition:{},targetPosition:{},sourceHandleId:{},targetHandleId:{},animated:{type:Boolean},updatable:{type:Boolean},markerStart:{},markerEnd:{},curvature:{},interactionWidth:{},data:{},events:{},labelStyle:{},labelShowBg:{type:Boolean},labelBgStyle:{},labelBgPadding:{},labelBgBorderRadius:{},sourceX:{},sourceY:{},targetX:{},targetY:{},controller:{}},setup(a){const e=a,t=[{label:"Edit task type",key:"T",click:()=>o.value="editing"},{label:"Delete",key:"Del",click:()=>A(e.data.id)}],s=N(e.data.props.taskType||""),o=N("idle"),r=()=>{o.value!=="idle"&&(s.value!==e.data.props.taskType&&e.controller.updateTransitionProps(e.data.id,{taskType:s.value}),o.value="idle")},{onEdgeClick:c,onPaneClick:y,getSelectedEdges:_}=X();c(h=>{h.edge.id===e.id&&o.value==="idle"&&(o.value="selected")}),y(()=>r());const u=C(()=>lt(e.sourceNode,e.targetNode)),v=C(()=>Ge(Va(u.value))),m=h=>{!_.value.map(f=>f.id).includes(e.data.id)||(h.key==="Enter"&&r(),(h.key==="t"||h.key==="T")&&(o.value="editing"))},{removeEdges:A}=X();return Ce(()=>window.addEventListener("keydown",m)),Ae(()=>window.removeEventListener("keydown",m)),(h,f)=>(n(),k(R,null,[p(i(Ct),{path:v.value[0],"marker-end":h.markerEnd},null,8,["path","marker-end"]),p(i(At),null,{default:g(()=>[o.value==="idle"?(n(),k("div",{key:0,style:q({transform:`translate(-50%, -50%) translate(${v.value[1]}px,${v.value[2]}px)`}),class:"nodrag nopan edge-label"},[e.data.props.taskType?(n(),I(i(se),{key:1},{default:g(()=>[j(O(e.data.props.taskType),1)]),_:1})):(n(),I(i(Ns),{key:0,size:16}))],4)):o.value==="selected"?(n(),k("div",{key:1,style:q({transform:`translate(-50%, -120%) translate(${v.value[1]}px,${v.value[2]}px)`}),class:"nodrag nopan edge-input-container"},[p(za,{"is-connecting":!0,"is-editing":!0,"menu-options":t})],4)):o.value==="editing"?(n(),k("div",{key:2,style:q({transform:`translate(-50%, -50%) translate(${v.value[1]}px,${v.value[2]}px)`}),class:"nodrag nopan edge-input-container"},[p(i(me),{value:s.value,"onUpdate:value":f[0]||(f[0]=F=>s.value=F),placeholder:"Task type"},null,8,["value"])],4)):x("",!0)]),_:1})],64))}});const Ha=ne(Ba,[["__scopeId","data-v-48e71e28"]]),ja={key:0},La=$("defs",null,[$("marker",{id:"arrowhead",markerWidth:"8",markerHeight:"8",refX:"0",refY:"4",orient:"auto",markerUnits:"strokeWidth"},[$("path",{d:"M0,0 L8,4 L0,8",fill:"none",stroke:"#222","stroke-width":"1"})])],-1),Oa=["d"],Za=V({__name:"LineFloating",props:{targetX:{},targetY:{},sourcePosition:{},targetPosition:{},sourceNode:{}},setup(a){const e=a,t=N(!0),{onNodeMouseEnter:s,onNodeMouseLeave:o}=X();s(_=>{_.node.id===e.sourceNode.id&&(t.value=!1)}),o(_=>{_.node.id===e.sourceNode.id&&(t.value=!0)});const r=C(()=>({id:"connection-target",computedPosition:{x:e.targetX,y:e.targetY},dimensions:{width:1,height:1}})),c=C(()=>lt(e.sourceNode,r.value)),y=C(()=>Ge({sourceX:c.value.sx,sourceY:c.value.sy,targetX:c.value.tx,targetY:c.value.ty}));return(_,u)=>t.value?(n(),k("g",ja,[La,$("path",{fill:"none",stroke:"#222","stroke-width":1,class:"animated",d:y.value[0],"marker-end":"url(#arrowhead)"},null,8,Oa)])):x("",!0)}}),Ra=V({__name:"CreateStageFile",props:{filename:{},creatingFileStatus:{},fileExists:{type:Boolean}},emits:["create-file","cancel","update-filename"],setup(a,{emit:e}){const t=a,s=C(()=>{const o=Je(t.filename);return o.valid?t.fileExists?{valid:!0,help:"This file already exists, stage will point to it."}:{valid:!0,help:"File doesn't exist yet. It will be created."}:o});return(o,r)=>(n(),I(i(mt),{open:o.creatingFileStatus==="prompting"||o.creatingFileStatus==="creating",closable:!1,"confirm-loading":o.creatingFileStatus==="creating",onOk:r[1]||(r[1]=c=>e("create-file",o.filename)),onCancel:r[2]||(r[2]=c=>e("cancel"))},{default:g(()=>[p(i(We),{layout:"vertical",disabled:o.creatingFileStatus=="creating"},{default:g(()=>[p(i(fe),{label:"You're creating a new file. What should it be called?","validate-status":s.value.valid?"success":"error",help:s.value.valid?s.value.help:s.value.reason},{default:g(()=>[p(i(me),{value:o.filename,onChange:r[0]||(r[0]=c=>e("update-filename",c.target.value||""))},null,8,["value"])]),_:1},8,["validate-status","help"])]),_:1},8,["disabled"])]),_:1},8,["open","confirm-loading"]))}}),Ya={name:"NodeToolbar",compatConfig:{MODE:3},inheritAttrs:!1},Ka=V({...Ya,props:{nodeId:null,isVisible:{type:Boolean},position:{default:le.Top},offset:{default:10},align:{default:"center"}},setup(a){const e=a,t=K(Pt,null),{viewportRef:s,viewport:o,getSelectedNodes:r,findNode:c}=X();function y(h,f,F,b,M){let H=.5;M==="start"?H=0:M==="end"&&(H=1);let E=[(h.x+h.width*H)*f.zoom+f.x,h.y*f.zoom+f.y-b],Z=[-100*H,-100];switch(F){case le.Right:E=[(h.x+h.width)*f.zoom+f.x+b,(h.y+h.height*H)*f.zoom+f.y],Z=[0,-100*H];break;case le.Bottom:E[1]=(h.y+h.height)*f.zoom+f.y+b,Z[1]=0;break;case le.Left:E=[h.x*f.zoom+f.x-b,(h.y+h.height*H)*f.zoom+f.y],Z=[-100,-100*H];break}return`translate(${E[0]}px, ${E[1]}px) translate(${Z[0]}%, ${Z[1]}%)`}const _=C(()=>(Array.isArray(e.nodeId)?e.nodeId:[e.nodeId||t||""]).reduce((h,f)=>{const F=c(f);return F&&h.push(F),h},[])),u=C(()=>typeof e.isVisible=="boolean"?e.isVisible:_.value.length===1&&_.value[0].selected&&r.value.length===1),v=C(()=>Dt(_.value)),m=C(()=>Math.max(..._.value.map(h=>(h.computedPosition.z||1)+1))),A=C(()=>({position:"absolute",transform:y(v.value,o.value,e.position,e.offset,e.align),zIndex:m.value}));return(h,f)=>(n(),I(wt,{to:i(s),disabled:!i(s)},[i(u)&&i(_).length?(n(),k("div",ve({key:0},h.$attrs,{style:i(A),class:"vue-flow__node-toolbar"}),[B(h.$slots,"default")],16)):x("",!0)],8,["to","disabled"]))}}),Xa=V({__name:"NodeMenu",props:{isConnecting:{type:Boolean},isEditing:{type:Boolean},menuOptions:{}},setup(a){return(e,t)=>(n(),I(i(Ka),{"is-visible":e.isConnecting||e.isEditing?!1:void 0,position:i(le).Right},{default:g(()=>[p(i(G),{vertical:"",gap:"small",style:q({marginBottom:`-${16*e.menuOptions.length}%`})},{default:g(()=>[(n(!0),k(R,null,de(e.menuOptions,s=>(n(),I(i(Xe),{key:s.label,title:s.tooltip,placement:"right"},{default:g(()=>[p(i(Ee),{class:xe([{"warning-button":s.warning}]),disabled:s.disabled,style:q({backgroundColor:s.disabled?"#f5f5f5":void 0}),onClick:o=>s.click(o)},{default:g(()=>[p(i(G),{gap:"small",style:{width:"100%"},justify:"space-between",align:"center"},{default:g(()=>[j(O(s.label)+" ",1),s.key?(n(),I(i(se),{key:0,keyboard:"",disabled:s.disabled},{default:g(()=>[j(O(s.key),1)]),_:2},1032,["disabled"])):x("",!0)]),_:2},1024)]),_:2},1032,["class","disabled","style","onClick"])]),_:2},1032,["title"]))),128))]),_:1},8,["style"])]),_:1},8,["is-visible","position"]))}});const Wa=V({__name:"AgentItems",props:{stageProps:{}},emits:["update:stage-props"],setup(a,{emit:e}){const t=a,s=N(!1),o=l.object({title:l.string(),clientStageId:l.string().uuid(),inputSchemas:l.any(),outputSchemas:l.any()});ye(()=>t.stageProps.projectId,()=>{s.value=!0,v()});const r=l.array(o),{result:c,loading:y,refetch:_,error:u}=et(async()=>{const f=t.stageProps.projectId;if(!f)return[];const b=await(await fetch(`/_editor/api/services/roles/client/entrypoints/${f}`)).json();return r.parse(b)}),v=U.exports.debounce(()=>{s.value=!1,_()},500),m=C(()=>y.value||!c.value?[]:c.value.map(f=>({label:f.title,value:f.clientStageId})));function A(f){e("update:stage-props",{...t.stageProps,projectId:f})}function h(f){const F=String(f);!c.value||e("update:stage-props",{...t.stageProps,clientStageId:F})}return(f,F)=>(n(),k(R,null,[p(i(fe),{label:"Project ID"},{default:g(()=>{var b;return[p(i(me),{value:(b=f.stageProps.projectId)!=null?b:"",placeholder:"Project ID",autofocus:"","onUpdate:value":A},null,8,["value"])]}),_:1}),p(i(fe),{label:"Client entrypoint"},{default:g(()=>{var b;return[s.value||i(y)?(n(),I(i(Se),{key:0,disabled:"",loading:""})):i(u)?(n(),I(i($e),{key:1,type:"error",message:"Invalid project id"})):f.stageProps.projectId?i(c).length===0?(n(),I(i($e),{key:3,type:"warning",message:"The project has no entrypoints"})):(n(),I(i(Se),{key:4,options:m.value,value:(b=f.stageProps.clientStageId)!=null?b:void 0,"onUpdate:value":h},null,8,["options","value"])):(n(),I(i(Se),{key:2,disabled:""}))]}),_:1})],64))}}),Ua=V({__name:"StageNode",props:{stage:{},node:{},initialFileCheck:{type:Boolean},controller:{}},setup(a){var Ze;const e=a,{useToken:t}=tt,{token:s}=t(),o=s.value.colorText,r=[{label:"Add transition",key:"T",click:d=>He(d)},{label:"Rename",key:"R",click:()=>L.value=!0},{label:"Go to editor",key:"Enter",click:()=>Be()},{label:"Tasks",key:"M",click:()=>y.value=!0},{label:"Delete",key:"Del",click:()=>P(e.stage)}],c=C(()=>{let d=[...r];return _.value||d.unshift({label:"Create missing file",warning:!0,click:()=>M()}),e.controller.hasChanges()&&(d=d.map(S=>S.label==="Go to editor"?{...S,disabled:!0,tooltip:"Save it to allow editing"}:S)),(e.stage.type==="agents"||e.stage.type==="clients")&&(d=d.filter(S=>!["Create missing file","Go to editor","Tasks"].includes(S.label))),d}),y=N(!1),_=N(e.initialFileCheck);ye(()=>e.initialFileCheck,d=>{_.value=d});const u=d=>{h.value=d,A()},v=d=>{e.controller.updateStageProps(e.stage.id,d)},m=()=>{var d;f.value="idle",(e.stage.type==="forms"||e.stage.type==="jobs"||e.stage.type==="hooks"||e.stage.type==="scripts")&&(h.value=(d=e.stage.props.filename)!=null?d:"",A())},A=U.exports.debounce(async()=>{const d=h.value;if(!d){_.value=!0;return}he.checkFile(d).then(S=>{_.value=S.exists})},500),h=N((e.stage.type==="forms"||e.stage.type==="hooks"||e.stage.type==="scripts"||e.stage.type==="jobs")&&(Ze=e.stage.props.filename)!=null?Ze:""),f=N("idle"),F=async()=>{f.value="creating",await he.initFile(h.value,e.stage.type),_.value=!0;const d=await he.checkFile(h.value);if(_.value=d.exists,f.value="idle",e.stage.type==="forms"||e.stage.type==="hooks")e.controller.updateStageProps(e.stage.id,{path:e.stage.props.path,filename:h.value});else if(e.stage.type==="scripts"||e.stage.type==="jobs")e.controller.updateStageProps(e.stage.id,{filename:h.value});else throw new Error(`Invalid stage type: ${e.stage.type}`)},b=C(()=>["forms","hooks","scripts","jobs"].includes(e.stage.type)?!_.value:e.stage.type==="agents"?!e.stage.props.clientStageId||!e.stage.props.projectId:!1),M=()=>{f.value="prompting"},{startConnection:H,updateConnection:E,onNodeClick:Z,addEdges:ce,endConnection:w,removeNodes:P,onPaneClick:D,getSelectedNodes:J,flowToScreenCoordinate:W,onNodeMouseEnter:ue,onNodeMouseLeave:pe,getNodes:ct,onNodesChange:ut,applyNodeChanges:pt}=X(),gt=kt(),Q=N(!1),L=N(!1),ee=N(e.stage.title),ke=N(!1);ut(async d=>{var z;const S=[];for(const ae of d)ae.type==="remove"?L.value||((z=e.controller)==null||z.delete([ae.id]),S.push(ae)):S.push(ae);pt(S)});const Be=()=>{const d=e.stage.type==="scripts"?"tasklet":e.stage.type.slice(0,-1);gt.push({path:`/_editor/${d}/${e.stage.id}`})},He=(d,S=!0)=>{H({nodeId:e.stage.id,type:"source",handleId:e.stage.id},{x:S?d.pageX-180:d.pageX-90,y:S?d.pageY-50:d.pageY-20}),document.addEventListener("mousemove",je),Q.value=!0},je=d=>{Q.value&&!ke.value&&E({x:d.pageX-180,y:d.pageY-52})};Z(d=>{if(d.node.id===e.stage.id&&A(),Q.value&&d.node.id!==e.stage.id){const S={sourceStageId:e.stage.id,targetStageId:d.node.id,type:"task",id:st(),props:{taskType:null}};try{e.controller.connect([S]),document.removeEventListener("mousemove",je),ce({id:S.id,source:e.stage.id,target:d.node.id,type:"task",markerEnd:{type:Ue.Arrow,width:24,height:24},data:S}),w(),Q.value=!1}catch(z){console.error(z)}}}),ue(d=>{if(Q.value&&d.node.id!==e.stage.id){ke.value=!0;const S=ct.value.find(ae=>ae.id===e.stage.id);if(!S)return;const z=Te(S,d.node,-10);E(W({x:z.x-180,y:z.y-52}))}}),pe(()=>{ke.value=!1});const Le=()=>{if(!_.value){const d=Qe(ee.value+".py");h.value=d;let S={filename:d,path:null};if(["forms","hooks"].includes(e.stage.type)){const z=qe(ee.value);S={...S,path:z}}e.controller.updateStageProps(e.stage.id,S)}};D(()=>{L.value=!1,e.stage.title!==ee.value&&(e.controller.updateStageTitle(e.stage.id,ee.value),Le()),Q.value=!1,w()});const Oe=d=>{if(!!J.value.map(S=>S.id).includes(e.stage.id)&&f.value==="idle"){if(d.key==="Enter")if(L.value)L.value=!1,e.controller.updateStageTitle(e.stage.id,ee.value),Le();else{if(e.controller.hasChanges()||e.stage.type==="agents"||e.stage.type==="clients")return;Be()}if(!L.value){if(d.key==="t"||d.key==="T"){const S=W(e.stage.position);He({pageX:S.x,pageY:S.y},!1)}(d.key==="r"||d.key==="R")&&(L.value=!0),(d.key==="m"||d.key==="M")&&(y.value=!0)}}};return Ce(()=>{window.addEventListener("keydown",Oe)}),Ae(()=>{window.removeEventListener("keydown",Oe)}),(d,S)=>(n(),k(R,null,[p(Xa,{"is-connecting":Q.value,"is-editing":L.value,"menu-options":c.value},null,8,["is-connecting","is-editing","menu-options"]),$("div",{class:"stage",onDblclick:S[1]||(S[1]=z=>L.value=!0)},[p(i(G),{vertical:L.value,class:"point",gap:"small",align:"center",style:{padding:"4px 0"}},{default:g(()=>[(n(),I(Y(i(zt)(d.stage.type)),{size:18,color:i(o)},null,8,["color"])),L.value?(n(),I(i(We),{key:1,layout:"vertical"},{default:g(()=>[p(i(fe),{label:"Title"},{default:g(()=>[p(i(me),{value:ee.value,"onUpdate:value":S[0]||(S[0]=z=>ee.value=z),class:"nodrag nopan",autofocus:""},null,8,["value"])]),_:1}),d.stage.type==="agents"?(n(),I(Wa,{key:0,"stage-props":d.stage.props,"onUpdate:stageProps":v},null,8,["stage-props"])):x("",!0)]),_:1})):(n(),I(i(_t),{key:0,class:"title"},{default:g(()=>[j(O(d.stage.title),1)]),_:1}))]),_:1},8,["vertical"])],32),b.value?(n(),I(i(Rt),{key:0,count:"!",color:"gold",style:{position:"absolute",top:"-4px",right:"-4px","z-index":"1"}})):x("",!0),f.value==="prompting"||f.value==="creating"?(n(),I(Ra,{key:1,filename:h.value,"file-exists":_.value,"creating-file-status":f.value,onCreateFile:F,onCancel:m,onUpdateFilename:u},null,8,["filename","file-exists","creating-file-status"])):x("",!0),p(i(Zt),{visible:y.value,"onUpdate:visible":S[2]||(S[2]=z=>y.value=z),title:"Tasks",width:"500",onClose:S[3]||(S[3]=z=>y.value=!1)},{default:g(()=>[p(Ot,{"stage-id":d.stage.id},null,8,["stage-id"])]),_:1},8,["visible"])],64))}});const oe=ne(Ua,[["__scopeId","data-v-7c8c886c"]]),dt=a=>(St("data-v-f4278104"),a=a(),bt(),a),Ga={class:"empty-hint"},qa={key:0,class:"drag-hint"},Ja=dt(()=>$("div",{class:"title"},"Start here",-1)),Qa={key:1,class:"drop-hint"},eo=dt(()=>$("div",{class:"title"},"Drop here",-1)),to={key:2,class:"stages-hint"},so={class:"header"},ao={class:"title"},oo={class:"description"},io=V({__name:"EmptyHint",props:{showDragHint:{type:Boolean}},setup(a){return(e,t)=>(n(),k("div",Ga,[e.showDragHint?(n(),k("div",qa,[Ja,p(i(Ye),{size:32,class:"arrow"})])):x("",!0),e.showDragHint?x("",!0):(n(),k("div",Qa,[eo,p(i(Ye),{size:32,class:"arrow"})])),e.showDragHint?(n(),k("div",to,[(n(!0),k(R,null,de(i(we).stages,s=>(n(),k("div",{key:s.key,class:"stage-hint"},[$("div",so,[(n(),I(Y(s.icon))),$("span",ao,O(s.title),1)]),$("div",oo,O(s.description),1)]))),128))])):x("",!0)]))}});const no=ne(io,[["__scopeId","data-v-f4278104"]]),ro=V({__name:"Workflow",props:{workflow:{},editable:{type:Boolean},showDragHint:{type:Boolean},checkFileStatus:{type:Boolean},initialFileCheckStatus:{}},setup(a){const e=a;It(u=>({ecafe25e:i(c),"3094d9cc":i(r)}));const t=rt(),{useToken:s}=tt,{token:o}=s(),r=o.value.colorPrimaryBorder,c=o.value.colorBgElevated,{onInit:y}=X();y(u=>{u.fitView()});const _=u=>{var v;return!e.checkFileStatus||!e.initialFileCheckStatus?!0:u&&(v=e.initialFileCheckStatus[u])!=null?v:!1};return(u,v)=>u.workflow?(n(),I(i(Ft),{key:0,nodes:u.workflow.vueFlowNodes.value,edges:u.workflow.vueFlowEdges.value,"max-zoom":1.25,class:"vue-flow-root","select-nodes-on-drag":!1,"zoom-on-double-click":!1,multi:"","multi-selection-key-code":"Shift","nodes-draggable":u.editable,"pan-on-scroll":i(ze).isMac,"elements-selectable":u.editable,"snap-to-grid":"","apply-default":!1,onDragover:i(t).onDragOver,onDragleave:i(t).onDragLeave},{"connection-line":g(m=>[p(Za,$t(Tt(m)),null,16)]),"edge-task":g(m=>[p(Ha,ve(m,{controller:u.workflow}),null,16,["controller"])]),"node-forms":g(m=>[p(oe,{stage:m.data,node:m,controller:u.workflow,"initial-file-check":_(m.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-hooks":g(m=>[p(oe,{stage:m.data,node:m,controller:u.workflow,"initial-file-check":_(m.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-scripts":g(m=>[p(oe,{stage:m.data,node:m,controller:u.workflow,"initial-file-check":_(m.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-jobs":g(m=>[p(oe,{stage:m.data,node:m,controller:u.workflow,"initial-file-check":_(m.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-agents":g(m=>[p(oe,{stage:m.data,node:m,controller:u.workflow,"initial-file-check":!0},null,8,["stage","node","controller"])]),"node-clients":g(m=>[p(oe,{stage:m.data,node:m,controller:u.workflow,"initial-file-check":!0},null,8,["stage","node","controller"])]),default:g(()=>[p(i(Nt)),u.editable&&!u.workflow.vueFlowNodes.value.length?(n(),I(no,{key:0,"show-drag-hint":u.showDragHint},null,8,["show-drag-hint"])):x("",!0),p(i(Mt),{pannable:"",zoomable:""}),u.editable?(n(),I(Fa,{key:1,workflow:u.workflow},null,8,["workflow"])):x("",!0)]),_:1},8,["nodes","edges","nodes-draggable","pan-on-scroll","elements-selectable","onDragover","onDragleave"])):x("",!0)}});const lo=ne(ro,[["__scopeId","data-v-d709f269"]]),co=V({__name:"WorkflowEditor",setup(a){const{init:e,tearDown:t,onDragStart:s,onDrop:o,isDragging:r,isAdding:c,draggedType:y,mousePosition:_}=rt(),{result:u}=et(async()=>await Ve.init(Rs,!0)),v=N(null),m=async()=>{if(!u.value)return;const w=u.value.vueFlowNodes.value.map(P=>{var D,J,W,ue,pe;return((D=P.data)==null?void 0:D.type)==="forms"||((J=P.data)==null?void 0:J.type)==="hooks"||((W=P.data)==null?void 0:W.type)==="scripts"||((ue=P.data)==null?void 0:ue.type)==="jobs"?(pe=P.data)==null?void 0:pe.props.filename:null});v.value=await he.checkFiles(w.filter(P=>typeof P=="string"))};ye(()=>u.value,()=>{u.value&&(e(u.value),m())});const{onNodeDragStop:A,onEdgesChange:h,getSelectedElements:f,getNodes:F,addSelectedNodes:b,zoomIn:M,fitView:H,zoomOut:E,applyEdgeChanges:Z}=X();A(w=>{var P;(P=u.value)==null||P.move(w.nodes.map(D=>({id:D.id,position:D.position})))}),h(w=>{var P;for(const D of w)D.type==="remove"&&((P=u.value)==null||P.delete([D.id]));Z(w)});const ce=w=>{var P,D;!u.value||((w.key==="z"||w.key==="Z")&&te(w)&&(nt(w)?u.value.history.redo():(P=u.value)==null||P.history.undo(),w.preventDefault()),te(w)&&(w.key==="s"||w.key==="S")&&((D=u.value)==null||D.save(),w.preventDefault()),!f.value.length&&(w.key==="f"||w.key==="F"?s(null,"forms"):w.key==="h"||w.key==="H"?s(null,"hooks"):w.key==="j"||w.key==="J"?s(null,"jobs"):w.key==="o"||w.key==="O"?s(null,"scripts"):(w.key==="a"||w.key==="A")&&te(w)?(b(F.value),w.preventDefault()):w.key==="0"&&te(w)?(H(),w.preventDefault()):(w.key==="="||w.key==="+")&&te(w)?(w.preventDefault(),M()):w.key==="-"&&te(w)&&(w.preventDefault(),E())))};return Ce(()=>{window.addEventListener("keydown",ce)}),Ae(()=>{window.removeEventListener("keydown",ce),t()}),(w,P)=>i(u)?(n(),k("div",{key:0,class:xe(["workflow-container",{dragging:i(c)}]),onDrop:P[0]||(P[0]=(...D)=>i(o)&&i(o)(...D))},[p(lo,{workflow:i(u),editable:"","show-drag-hint":!i(c),"check-file-status":!0,"initial-file-check-status":v.value},null,8,["workflow","show-drag-hint","initial-file-check-status"]),p(ta,{controller:i(u),onDragStart:i(s)},null,8,["controller","onDragStart"]),(n(!0),k(R,null,de(i(we).stages,D=>{var J,W;return n(),k("div",{key:D.key},[i(c)&&!i(r)&&D.typeName===i(y)?(n(),k("div",{key:0,class:"dragging-node",style:q({left:`${(J=i(_))==null?void 0:J.x}px`,top:`${(W=i(_))==null?void 0:W.y}px`,position:"absolute",cursor:i(c)?"grabbing":"grab"})},[(n(),I(Y(D.icon),{size:18}))],4)):x("",!0)])}),128))],34)):x("",!0)}});const Uo=ne(co,[["__scopeId","data-v-5f802ac0"]]);export{Uo as default};
//# sourceMappingURL=WorkflowEditor.f70e6f20.js.map
