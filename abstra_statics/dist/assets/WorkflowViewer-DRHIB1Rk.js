import{_ as at}from"./AbstraButton.vue_vue_type_script_setup_true_lang-Dq3DXwJ9.js";import{_ as xt,F as zt,I as Pt,O as Zt,a as Bt}from"./CreateTaskModal.vue_vue_type_script_setup_true_lang-DoWmXArV.js";import{a as Q,i as st,c as j,b as P,e as p,f as Et,g as E,h as w,m as Nt,M as Tt,j as e,p as T,u as t,w as a,S as z,U as m,ak as R,K as Dt,aN as ht,v as B,W as Vt,bh as yt,aQ as ot,ae as v,bc as Ct,b_ as Ht,ac as It,ad as Mt,bC as ct,co as Ft,E as vt,R as dt,be as Wt,bf as U,bd as Yt,bo as K,d as Xt,r as x,H as _t,Y as Gt,D as Ot,b6 as qt,aj as ut,b2 as Jt,q as Ut,t as Rt}from"./jwt-decode.esm-1gs-8_h3.js";import{F as Kt}from"./PhArrowSquareOut.vue-BiUtxXpD.js";import{I as kt}from"./PhCopy.vue-D-rUefql.js";import{G as Qt}from"./PhPencilSimple.vue-CLjH2Tu0.js";import{_ as te}from"./vue-flow-background-T8QXuSMf.js";import{d as pt,e as ee,h as ae,u as se,M as oe,f as ne}from"./vue-flow-core-5MsU6dAE.js";import{C as gt}from"./router-C_tsfSD6.js";import{B as bt,b as le,a as ie}from"./build-ksevQkJ3.js";import{a as jt,P as re}from"./project-D_OwxSFr.js";import"./tables-BudTDH2J.js";import{G as ce}from"./PhArrowCounterClockwise.vue--44PcQLN.js";import{I as de}from"./PhCopySimple.vue-CmqzMvbB.js";import{G as ue}from"./PhDotsThreeVertical.vue-QnDyJ0rN.js";import{a as pe,I as ge,G as fe,F as me}from"./PhWebhooksLogo.vue-Dz7snvvf.js";import{g as we}from"./datetime-l4vT4AM7.js";import{u as ve}from"./polling-udg4tzyA.js";import{T as he}from"./taskCreator-BLXWlmfp.js";import{C as ft}from"./index-Vv1yeb9o.js";import"./LoadingOutlined-C8SWXcV-.js";import"./ts.worker-D-fjlzeb.js";import"./record-BP70KSyn.js";import"./string-8EALfe0d.js";(function(){try{var c=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},s=new Error().stack;s&&(c._sentryDebugIds=c._sentryDebugIds||{},c._sentryDebugIds[s]="8aaefe1e-cb3c-429b-84cc-020d67b11519",c._sentryDebugIdIdentifier="sentry-dbid-8aaefe1e-cb3c-429b-84cc-020d67b11519")}catch{}})();const ye=["width","height","fill","transform"],_e={key:0},ke=w("path",{d:"M227.85,46.89a20,20,0,0,0-18.74-18.74c-13.13-.77-46.65.42-74.48,28.24L131,60H74.36a19.83,19.83,0,0,0-14.14,5.86L25.87,100.19a20,20,0,0,0,11.35,33.95l37.14,5.18,42.32,42.32,5.19,37.18A19.88,19.88,0,0,0,135.34,235a20.13,20.13,0,0,0,6.37,1,19.9,19.9,0,0,0,14.1-5.87l34.34-34.35A19.85,19.85,0,0,0,196,181.64V125l3.6-3.59C227.43,93.54,228.62,60,227.85,46.89ZM76,84h31L75.75,115.28l-27.23-3.8ZM151.6,73.37A72.27,72.27,0,0,1,204,52a72.17,72.17,0,0,1-21.38,52.41L128,159,97,128ZM172,180l-27.49,27.49-3.8-27.23L172,149Zm-72,22c-8.71,11.85-26.19,26-60,26a12,12,0,0,1-12-12c0-33.84,14.12-51.32,26-60A12,12,0,1,1,68.18,175.3C62.3,179.63,55.51,187.8,53,203c15.21-2.51,23.37-9.3,27.7-15.18A12,12,0,1,1,100,202Z"},null,-1),be=[ke],Se={key:1},Te=w("path",{d:"M184,120v61.65a8,8,0,0,1-2.34,5.65l-34.35,34.35a8,8,0,0,1-13.57-4.53L128,176ZM136,72H74.35a8,8,0,0,0-5.65,2.34L34.35,108.69a8,8,0,0,0,4.53,13.57L80,128ZM40,216c37.65,0,50.69-19.69,54.56-28.18L68.18,161.44C59.69,165.31,40,178.35,40,216Z",opacity:"0.2"},null,-1),Ce=w("path",{d:"M223.85,47.12a16,16,0,0,0-15-15c-12.58-.75-44.73.4-71.41,27.07L132.69,64H74.36A15.91,15.91,0,0,0,63,68.68L28.7,103a16,16,0,0,0,9.07,27.16l38.47,5.37,44.21,44.21,5.37,38.49a15.94,15.94,0,0,0,10.78,12.92,16.11,16.11,0,0,0,5.1.83A15.91,15.91,0,0,0,153,227.3L187.32,193A15.91,15.91,0,0,0,192,181.64V123.31l4.77-4.77C223.45,91.86,224.6,59.71,223.85,47.12ZM74.36,80h42.33L77.16,119.52,40,114.34Zm74.41-9.45a76.65,76.65,0,0,1,59.11-22.47,76.46,76.46,0,0,1-22.42,59.16L128,164.68,91.32,128ZM176,181.64,141.67,216l-5.19-37.17L176,139.31Zm-74.16,9.5C97.34,201,82.29,224,40,224a8,8,0,0,1-8-8c0-42.29,23-57.34,32.86-61.85a8,8,0,0,1,6.64,14.56c-6.43,2.93-20.62,12.36-23.12,38.91,26.55-2.5,36-16.69,38.91-23.12a8,8,0,1,1,14.56,6.64Z"},null,-1),Ie=[Te,Ce],Me={key:2},je=w("path",{d:"M101.85,191.14C97.34,201,82.29,224,40,224a8,8,0,0,1-8-8c0-42.29,23-57.34,32.86-61.85a8,8,0,0,1,6.64,14.56c-6.43,2.93-20.62,12.36-23.12,38.91,26.55-2.5,36-16.69,38.91-23.12a8,8,0,1,1,14.56,6.64Zm122-144a16,16,0,0,0-15-15c-12.58-.75-44.73.4-71.4,27.07h0L88,108.7A8,8,0,0,1,76.67,97.39l26.56-26.57A4,4,0,0,0,100.41,64H74.35A15.9,15.9,0,0,0,63,68.68L28.7,103a16,16,0,0,0,9.07,27.16l38.47,5.37,44.21,44.21,5.37,38.49a15.94,15.94,0,0,0,10.78,12.92,16.11,16.11,0,0,0,5.1.83A15.91,15.91,0,0,0,153,227.3L187.32,193A16,16,0,0,0,192,181.65V155.59a4,4,0,0,0-6.83-2.82l-26.57,26.56a8,8,0,0,1-11.71-.42,8.2,8.2,0,0,1,.6-11.1l49.27-49.27h0C223.45,91.86,224.6,59.71,223.85,47.12Z"},null,-1),Ae=[je],$e={key:3},Le=w("path",{d:"M221.86,47.24a14,14,0,0,0-13.11-13.1c-12.31-.73-43.77.39-69.88,26.5L133.52,66H74.35a13.9,13.9,0,0,0-9.89,4.1L30.11,104.44a14,14,0,0,0,7.94,23.76l39.13,5.46,45.16,45.16L127.8,218a14,14,0,0,0,23.76,7.92l34.35-34.35a13.91,13.91,0,0,0,4.1-9.89V122.48l5.35-5.35h0C221.46,91,222.59,59.56,221.86,47.24ZM38.11,115a2,2,0,0,1,.49-2L72.94,78.58A2,2,0,0,1,74.35,78h47.17L77.87,121.64l-38.14-5.32A1.93,1.93,0,0,1,38.11,115ZM178,181.65a2,2,0,0,1-.59,1.41L143.08,217.4a2,2,0,0,1-3.4-1.11l-5.32-38.16L178,134.48Zm8.87-73h0L128,167.51,88.49,128l58.87-58.88a78.47,78.47,0,0,1,60.69-23A2,2,0,0,1,209.88,48,78.47,78.47,0,0,1,186.88,108.64ZM100,190.31C95.68,199.84,81.13,222,40,222a6,6,0,0,1-6-6c0-41.13,22.16-55.68,31.69-60a6,6,0,1,1,5,10.92c-7,3.17-22.53,13.52-24.47,42.91,29.39-1.94,39.74-17.52,42.91-24.47a6,6,0,1,1,10.92,5Z"},null,-1),xe=[Le],ze={key:4},Pe=w("path",{d:"M223.85,47.12a16,16,0,0,0-15-15c-12.58-.75-44.73.4-71.41,27.07L132.69,64H74.36A15.91,15.91,0,0,0,63,68.68L28.7,103a16,16,0,0,0,9.07,27.16l38.47,5.37,44.21,44.21,5.37,38.49a15.94,15.94,0,0,0,10.78,12.92,16.11,16.11,0,0,0,5.1.83A15.91,15.91,0,0,0,153,227.3L187.32,193A15.91,15.91,0,0,0,192,181.64V123.31l4.77-4.77C223.45,91.86,224.6,59.71,223.85,47.12ZM74.36,80h42.33L77.16,119.52,40,114.34Zm74.41-9.45a76.65,76.65,0,0,1,59.11-22.47,76.46,76.46,0,0,1-22.42,59.16L128,164.68,91.32,128ZM176,181.64,141.67,216l-5.19-37.17L176,139.31Zm-74.16,9.5C97.34,201,82.29,224,40,224a8,8,0,0,1-8-8c0-42.29,23-57.34,32.86-61.85a8,8,0,0,1,6.64,14.56c-6.43,2.93-20.62,12.36-23.12,38.91,26.55-2.5,36-16.69,38.91-23.12a8,8,0,1,1,14.56,6.64Z"},null,-1),Ze=[Pe],Be={key:5},Ee=w("path",{d:"M219.86,47.36a12,12,0,0,0-11.22-11.22c-12-.71-42.82.38-68.35,25.91L134.35,68h-60a11.9,11.9,0,0,0-8.48,3.52L31.52,105.85a12,12,0,0,0,6.81,20.37l39.79,5.55,46.11,46.11,5.55,39.81a12,12,0,0,0,20.37,6.79l34.34-34.35a11.9,11.9,0,0,0,3.52-8.48v-60l5.94-5.94C219.48,90.18,220.57,59.41,219.86,47.36ZM36.21,115.6a3.94,3.94,0,0,1,1-4.09L71.53,77.17A4,4,0,0,1,74.35,76h52L78.58,123.76,39.44,118.3A3.94,3.94,0,0,1,36.21,115.6ZM180,181.65a4,4,0,0,1-1.17,2.83l-34.35,34.34a4,4,0,0,1-6.79-2.25l-5.46-39.15L180,129.65Zm-52-11.31L85.66,128l60.28-60.29c23.24-23.24,51.25-24.23,62.22-23.58a3.93,3.93,0,0,1,3.71,3.71c.65,11-.35,39-23.58,62.22ZM98.21,189.48C94,198.66,80,220,40,220a4,4,0,0,1-4-4c0-40,21.34-54,30.52-58.21a4,4,0,0,1,3.32,7.28c-7.46,3.41-24.43,14.66-25.76,46.85,32.19-1.33,43.44-18.3,46.85-25.76a4,4,0,1,1,7.28,3.32Z"},null,-1),Ne=[Ee],De={name:"PhRocketLaunch"},Ve=Q({...De,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(c){const s=c,r=st("weight","regular"),k=st("size","1em"),b=st("color","currentColor"),n=st("mirrored",!1),l=j(()=>s.weight??r),u=j(()=>s.size??k),y=j(()=>s.color??b),g=j(()=>s.mirrored!==void 0?s.mirrored?"scale(-1, 1)":void 0:n?"scale(-1, 1)":void 0);return(C,S)=>(p(),P("svg",Nt({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:u.value,height:u.value,fill:y.value,transform:g.value},C.$attrs),[Et(C.$slots,"default"),l.value==="bold"?(p(),P("g",_e,be)):l.value==="duotone"?(p(),P("g",Se,Ie)):l.value==="fill"?(p(),P("g",Me,Ae)):l.value==="light"?(p(),P("g",$e,xe)):l.value==="regular"?(p(),P("g",ze,Ze)):l.value==="thin"?(p(),P("g",Be,Ne)):E("",!0)],16,ye))}}),He=Q({__name:"WorkflowEdge",props:{id:{},sourceNode:{},targetNode:{},source:{},target:{},type:{},label:{type:[String,Object,Function]},style:{},selected:{type:Boolean},sourcePosition:{},targetPosition:{},sourceHandleId:{},targetHandleId:{},animated:{type:Boolean},updatable:{type:Boolean},markerStart:{},markerEnd:{},curvature:{},interactionWidth:{},data:{},events:{},labelStyle:{},labelShowBg:{type:Boolean},labelBgStyle:{},labelBgPadding:{},labelBgBorderRadius:{},sourceX:{},sourceY:{},targetX:{},targetY:{}},setup(c){const s=c;function r(n,l,u=0){const y=l.center.x-n.center.x,g=l.center.y-n.center.y,C=Math.sqrt(y*y+g*g);if(C===0)return{sourceX:n.center.x,sourceY:n.center.y,targetX:l.center.x,targetY:l.center.y};const S=y/C,I=g/C,$=n.width/2,f=n.height/2;let M=n.center.x,A=n.center.y;Math.abs(S)*f>Math.abs(I)*$?(M=n.center.x+(S>0?$:-$),A=n.center.y+I*$/Math.abs(S)):(M=n.center.x+S*f/Math.abs(I),A=n.center.y+(I>0?f:-f));const h=l.width/2,N=l.height/2;let Z=l.center.x,L=l.center.y;return Math.abs(S)*N>Math.abs(I)*h?(Z=l.center.x-(S>0?h:-h),L=l.center.y-I*h/Math.abs(S)):(Z=l.center.x-S*N/Math.abs(I),L=l.center.y-(I>0?N:-N)),M+=S*u,A+=I*u,Z-=S*u,L-=I*u,{sourceX:M,sourceY:A,targetX:Z,targetY:L}}function k(n,l){const y={center:{x:n.computedPosition.x+n.dimensions.width/2,y:n.computedPosition.y+n.dimensions.height/2},width:n.dimensions.width,height:n.dimensions.height},C={center:{x:l.computedPosition.x+l.dimensions.width/2,y:l.computedPosition.y+l.dimensions.height/2},width:l.dimensions.width,height:l.dimensions.height};return r(y,C,10)}const b=j(()=>{if(!s.sourceNode||!s.targetNode)return pt({sourceX:0,sourceY:0,targetX:0,targetY:0});if(!s.sourceNode.dimensions.width||!s.targetNode.dimensions.width||!s.sourceNode.dimensions.height||!s.targetNode.dimensions.height)return pt({sourceX:0,sourceY:0,targetX:0,targetY:0});const n=k(s.sourceNode,s.targetNode);return pt(n)});return(n,l)=>(p(),P(Tt,null,[e(t(ee),{path:b.value[0],"marker-end":s.markerEnd},null,8,["path","marker-end"]),s.data?.props?.taskType?(p(),T(t(ae),{key:0},{default:a(()=>[w("div",{style:Dt({transform:`translate(-50%, -50%) translate(${b.value[1]}px,${b.value[2]}px)`}),class:"nodrag nopan edge-label"},[e(t(R),null,{default:a(()=>[z(m(s.data.props.taskType),1)]),_:1})],4)]),_:1})):E("",!0)],64))}}),Fe=ht(He,[["__scopeId","data-v-8f1859d4"]]),We=Q({__name:"WorkflowStageExecutions",props:{stageId:{},projectId:{},statistics:{}},setup(c){const s=c,r=u=>{if(!u.createdAt||!u.updatedAt)return 0;const y=new Date(u.createdAt).getTime(),g=new Date(u.updatedAt).getTime();return Math.round((g-y)/1e3)},k=j(()=>s.statistics?Math.round(s.statistics.completedTasks/s.statistics.totalTasks*100):0),b=j(()=>{const u=k.value;return u===100?"#52c41a":u>=50?"#1890ff":"#faad14"}),n=u=>we(u,{weekday:void 0}),l=u=>{if(u<60)return`${Math.round(u)}s`;const y=Math.floor(u/60);if(y<60)return`${y}m`;const g=Math.floor(y/60);return g<24?`${g}h`:`${Math.floor(g/24)}d`};return(u,y)=>(p(),T(t(B),{vertical:"",size:4,style:{width:"100%"}},{default:a(()=>[c.statistics.lastExecutions&&c.statistics.lastExecutions.length>0?(p(),T(t(B),{key:0,size:4,gap:4},{default:a(()=>[(p(!0),P(Tt,null,Vt(c.statistics.lastExecutions,g=>(p(),T(t(yt),{key:g.id,to:{name:"logs",params:{projectId:c.projectId},query:{executionId:g.id}}},{default:a(()=>[e(t(Ct),{title:n(new Date(g.createdAt))},{content:a(()=>[e(t(B),{vertical:"",size:4},{default:a(()=>[e(t(ot),null,{default:a(()=>[z(m(t(v).translate("i18n_workflowviewer_status"))+": "+m(g.status),1)]),_:2},1024),g.updatedAt&&g.updatedAt!==g.createdAt?(p(),T(t(ot),{key:0},{default:a(()=>[z(m(t(v).translate("i18n_workflowviewer_duration"))+": "+m(r(g))+"s ",1)]),_:2},1024)):E("",!0),e(t(ot),null,{default:a(()=>[z(m(t(v).translate("i18n_workflowviewer_version"))+": "+m(g.buildId.slice(0,6)),1)]),_:2},1024)]),_:2},1024)]),default:a(()=>[e(xt,{status:g.status},null,8,["status"])]),_:2},1032,["title"])]),_:2},1032,["to"]))),128))]),_:1})):E("",!0),c.statistics.totalTasks>0?(p(),T(t(yt),{key:1,to:{name:"tasks",params:{projectId:c.projectId},query:{stage:c.stageId,status:"pending"}}},{default:a(()=>[e(t(B),{vertical:"",size:2},{default:a(()=>[e(t(Ht),{"show-info":!1,percent:k.value,"stroke-color":b.value,size:"small"},null,8,["percent","stroke-color"]),e(t(B),{vertical:"",size:0},{default:a(()=>[c.statistics.pendingTasks>0&&c.statistics.averageCompletionSeconds?(p(),T(t(ot),{key:0,type:"secondary",style:{fontSize:"11px"}},{default:a(()=>[z(m(t(v).translate("i18n_workflowviewer_pending_tasks").replace("{count}",c.statistics.pendingTasks.toString()))+" ("+m(l(c.statistics.averageCompletionSeconds))+" "+m(t(v).translate("i18n_workflowviewer_average"))+") ",1)]),_:1})):E("",!0)]),_:1})]),_:1})]),_:1},8,["to"])):E("",!0)]),_:1}))}}),Ye={class:"stage-content"},Xe={class:"stage-title"},Ge={class:"action-item"},Oe={class:"action-item"},qe={class:"action-item"},Je={class:"action-item"},Ue={class:"action-warning"},Re={key:1,class:"action-item"},St="3.18.0",Ke=Q({__name:"WorkflowStageNode",props:{stage:{},statistics:{},isDisabled:{type:Boolean},project:{},buildSpec:{}},emits:["toggle-stage-enabled-state","run-tasklet"],setup(c,{emit:s}){const r=c,k=It(),b=Mt(),n=k.params.projectId,l=new jt,u=j(()=>({forms:me,hooks:fe,scripts:ge,jobs:pe})[r.stage.type]),y=()=>{b.push({name:"logs",params:{projectId:n},query:{stageId:r.stage.id}})},g=j(()=>r.stage.type==="forms"||r.stage.type==="hooks"),C=()=>{if(!r.stage.path)return;const L=r.stage.type==="forms"?`/${r.stage.path}`:`/_hooks/${r.stage.path}`,V=r.project?.getUrl(L);V&&(navigator.clipboard.writeText(V),K.success(v.translate("i18n_workflowviewer_copied_url")))},S=(L,V)=>{const[O,Y,lt]=L.split(".").map(Number),[tt,H,X]=V.split(".").map(Number);return O>tt?!0:O<tt?!1:Y>H?!0:Y<H?!1:lt>=X},I=j(()=>r.isDisabled?ct:Ft),$=j(()=>r.isDisabled?v.translate("i18n_workflowviewer_enable_stage"):v.translate("i18n_workflowviewer_disable_stage")),f=j(()=>!S(r.buildSpec?.abstraVersion||"0.0.0",St)),M=j(()=>f.value?v.translate("i18n_workflowviewer_disable_stages_warning").replace("{version}",St):""),A=s,h=()=>{f.value||A("toggle-stage-enabled-state",r.stage.id)},N=async()=>{try{await l.runJob(n,r.stage.id),K.success(v.translate("i18n_workflowviewer_job_run_success"))}catch(L){K.error(v.translate("i18n_workflowviewer_job_run_error")),console.error("Failed to run job:",L)}},Z=async()=>{A("run-tasklet",r.stage.id)};return(L,V)=>(p(),P("div",{class:vt(["stage-node",{disabled:c.isDisabled}])},[w("div",Ye,[(p(),T(dt(u.value),{size:18,class:"stage-icon"})),w("div",Xe,m(c.stage.title),1),e(t(Yt),{trigger:["click"]},{overlay:a(()=>[e(t(Wt),null,{default:a(()=>[c.stage.type==="jobs"?(p(),T(t(U),{key:0,onClick:N},{default:a(()=>[w("div",Ge,[e(t(ct),{size:16}),w("span",null,m(t(v).translate("i18n_workflowviewer_run_job")),1)])]),_:1})):E("",!0),c.stage.type==="scripts"?(p(),T(t(U),{key:1,onClick:Z},{default:a(()=>[w("div",Oe,[e(t(ct),{size:16}),w("span",null,m(t(v).translate("i18n_workflowviewer_run_tasklet")),1)])]),_:1})):E("",!0),e(t(U),{onClick:y},{default:a(()=>[w("div",qe,[e(t(ce),{size:16}),w("span",null,m(t(v).translate("i18n_workflowviewer_view_logs")),1)])]),_:1}),g.value?(p(),T(t(U),{key:2,onClick:C},{default:a(()=>[w("div",Je,[e(t(de),{size:16}),w("span",null,m(t(v).translate("i18n_workflowviewer_copy_url")),1)])]),_:1})):E("",!0),e(t(U),{onClick:h},{default:a(()=>[f.value?(p(),T(t(Ct),{key:0,placement:"left"},{content:a(()=>[w("div",Ue,[e(t(R),null,{default:a(()=>[z(m(M.value),1)]),_:1})])]),default:a(()=>[w("div",{class:vt(["action-item",{disabled:f.value}])},[(p(),T(dt(I.value),{size:16})),w("span",null,m($.value),1)],2)]),_:1})):(p(),P("div",Re,[(p(),T(dt(I.value),{size:16})),w("span",null,m($.value),1)]))]),_:1})]),_:1})]),default:a(()=>[e(t(ue),{style:{cursor:"pointer"},size:20,class:"actions-menu"})]),_:1})]),c.statistics?(p(),T(We,{key:0,"stage-id":c.stage.id,"project-id":t(n),statistics:c.statistics,style:{"margin-top":"8px"}},null,8,["stage-id","project-id","statistics"])):E("",!0)],2))}}),nt=ht(Ke,[["__scopeId","data-v-a0832856"]]);class Qe{async list(s){return gt.get(`projects/${s}/disabled-stages`)}async disableStage({projectId:s,stageId:r}){return gt.patch(`projects/${s}/disabled-stages/${r}`,{enable:!1})}async enableStage({projectId:s,stageId:r}){return gt.patch(`projects/${s}/disabled-stages/${r}`,{enable:!0})}}const mt=new Qe;class G{constructor(s){this.dto=s,this.id=s}id;static async list(s){return(await mt.list(s)).map(k=>new G(k))}static async disableStage({projectId:s,stageId:r}){return mt.disableStage({projectId:s,stageId:r})}static async enableStage({projectId:s,stageId:r}){return mt.enableStage({projectId:s,stageId:r})}}const ta=Xt("workflow",()=>{const c=x([]),s=x(null),r=x(!1);let k=null,b=null,n=null,l=[];async function u(){if(!b||!n){console.warn("Cannot load data: no project context set");return}r.value=!0;try{const f=await n.getWorkflowStatistics(b),M=new Set(l),A=new Map(f.filter(h=>M.has(h.stageId)).map(h=>[h.stageId,h]));c.value=l.map(h=>A.has(h)?A.get(h):{stageId:h,lastExecutions:[],pendingTasks:0,lockedTasks:0,completedTasks:0,averageCompletionSeconds:void 0,totalTasks:0}),await S()}catch(f){console.error("Failed to load workflow data:",f)}finally{r.value=!1}}function y(f,M,A){if(k&&k.endPolling(),n=f,b=M,l=A,A.length>0){const h=ve({task:u,interval:15e3});k=h,u(),h.startPolling()}}function g(){k&&(k.endPolling(),k=null)}function C(){g(),c.value=[],s.value=null,r.value=!1,b=null,n=null,l=[]}async function S(){if(!b){console.warn("Cannot refetch disabled stages: no project context set");return}s.value=await G.list(b)}async function I(f){s.value?.some(M=>M.id===f)?(s.value=s.value.filter(M=>M.id!==f),await G.enableStage({projectId:b,stageId:f})):(s.value=[...s.value||[],new G(f)],await G.disableStage({projectId:b,stageId:f})),await S()}const $=j(()=>f=>c.value.find(M=>M.stageId===f)||null);return{statistics:c,disabledStages:s,loading:r,getStatisticsForStage:$,initializePolling:y,stopPolling:g,resetStore:C,refetch:u,toggleStageEnabledState:I}}),ea={class:"flow-container"},aa={class:"code-container"},sa={class:"code-container"},oa={key:0,class:"edit-button-text"},wt="#ea576a",na=Q({__name:"WorkflowViewer",setup(c){const{onInit:s}=se(),r=new le,k=It(),b=Mt(),n=k.params.projectId,l=k.query.buildId,u=x(!0),y=x(null),g=x(!0),C=x(!1),S=()=>{b.push({name:"web-editor",params:{projectId:n}})},I=async d=>{try{await navigator.clipboard.writeText(d)}catch(o){console.error("Failed to copy:",o)}};s(d=>{g.value&&(d.fitView(),g.value=!1)});const $=x([]),f=x([]),M=j(()=>$.value.map(d=>d.id)),A=new jt,h=ta(),N=j(()=>h.statistics),Z=x();_t(M,d=>{h.initializePolling(A,n,d)},{immediate:!0}),Gt(()=>{h.stopPolling()});const L=x(!1),V=j(()=>$.value.length>0&&L.value),O=d=>$.value.map(o=>({id:o.id,type:o.type,data:{stage:o,statistics:d.find(i=>i.stageId===o.id)||null},position:{x:o.position.x,y:o.position.y*1.5}})),Y=x(O(N.value));_t(()=>N.value,()=>{Y.value=O(N.value)});const lt=j(()=>{const d=new Set(Y.value.map(o=>o.id));return f.value.filter(o=>{const i=d.has(o.sourceStageId),_=d.has(o.targetStageId);return i&&_}).map(o=>({id:o.id,source:o.sourceStageId,target:o.targetStageId,type:"task",data:{id:o.id,props:{taskType:o.taskType}},markerEnd:{type:oe.Arrow,width:24,height:24}}))});function tt(d){const o=[],i=[],_=["jobs","hooks","forms","scripts"];for(const W of _){const Lt=d[W]||[];for(const D of Lt){o.push({id:D.id,type:W,title:D.title,position:{x:D.workflow_position[0],y:D.workflow_position[1]},file:D.file,path:D.path,schedule:D.schedule});for(const rt of D.transitions||[])i.push({id:rt.id,sourceStageId:D.id,targetStageId:rt.target_id,taskType:rt.task_type})}}const F=new Set(o.map(W=>W.id)),J=i.filter(W=>F.has(W.sourceStageId)&&F.has(W.targetStageId));$.value=o,f.value=J,L.value=!0}const H=x();Ot(async()=>{try{u.value=!0,Z.value=await re.get(n);let d;if(l){const F=(await bt.list(n)).find(J=>J.id===l);if(!F){y.value="Build not found";return}d=F}else{const F=(await bt.list(n)).find(J=>J.latest);if(!F){y.value="No builds found for this project";return}d=F}const o=await r.get(d.id);if(!o||!o.abstraJson){y.value="No workflow data available for this build";return}const i=JSON.parse(o.abstraJson);tt(i),H.value=ie.fromDTO(n,d.id,i.version,{forms:i.forms?.map(_=>({id:_.id,path:_.path,title:_.title}))||[],hooks:i.hooks?.map(_=>({id:_.id,path:_.path,title:_.title}))||[],jobs:i.jobs?.map(_=>({id:_.id,schedule:_.schedule,title:_.title}))||[],scripts:i.scripts?.map(_=>({id:_.id,title:_.title}))||[],components:i.components?.map(_=>({id:_.id,title:_.title}))||[]})}catch(d){y.value=d instanceof Error?d.message:"Failed to load workflow",console.error(d)}finally{u.value=!1}});const X=d=>h.disabledStages?.some(o=>o.id===d)??!1,et=d=>{h.toggleStageEnabledState(d)},it=x(void 0),q=he({api:{createTask:async(d,o,i)=>(await A.runTasklet(n,o,d,i),{id:"temp",type:d,payload:i,status:"pending",targetStageId:o,created:{at:new Date().toISOString(),byExecutionId:null,byStageId:null},locked:null,completed:null,targetStageTitle:"unknown",targetStageType:"script",sourceStageTitle:null,sourceStageType:null}),getAllTasks:async()=>({tasks:[],totalCount:0}),getStageTasks:async()=>({tasks:[],totalCount:0}),getSentStageTasks:async()=>({tasks:[],totalCount:0}),updateTaskStatus:async()=>{},clearAllTasks:async()=>{}},fetchTasks:async()=>{}}),At=d=>{it.value=d,q.startCreatingTask()},$t=async()=>{if(it.value)try{await q.createTask(it.value),K.success(v.translate("i18n_workflowviewer_tasklet_run_success"))}catch(d){K.error(v.translate("i18n_workflowviewer_tasklet_run_error")),console.error("Failed to run tasklet:",d)}};return(d,o)=>(p(),P("div",ea,[u.value?(p(),T(t(B),{key:0,style:{width:"100%",height:"100%"},justify:"center",align:"center"},{default:a(()=>[e(t(qt),{size:"large"})]),_:1})):V.value?(p(),T(t(ne),{key:`workflow-${$.value.length}-${f.value.length}`,nodes:Y.value,edges:lt.value,"default-viewport":{zoom:1.5},"fit-view-on-init":"","min-zoom":.1,"max-zoom":1.25,"pan-on-scroll":t(Zt).isMac,"snap-to-grid":""},{"edge-task":a(i=>[e(Fe,Ut(Rt(i)),null,16)]),"node-forms":a(i=>[e(nt,{stage:i.data.stage,statistics:i.data.statistics,project:Z.value,"build-spec":H.value,"is-disabled":X(i.data.stage.id),onToggleStageEnabledState:et},null,8,["stage","statistics","project","build-spec","is-disabled"])]),"node-hooks":a(i=>[e(nt,{stage:i.data.stage,statistics:i.data.statistics,project:Z.value,"build-spec":H.value,"is-disabled":X(i.data.stage.id),onToggleStageEnabledState:et},null,8,["stage","statistics","project","build-spec","is-disabled"])]),"node-scripts":a(i=>[e(nt,{stage:i.data.stage,statistics:i.data.statistics,project:Z.value,"build-spec":H.value,"is-disabled":X(i.data.stage.id),onToggleStageEnabledState:et,onRunTasklet:At},null,8,["stage","statistics","project","build-spec","is-disabled"])]),"node-jobs":a(i=>[e(nt,{stage:i.data.stage,statistics:i.data.statistics,project:Z.value,"build-spec":H.value,"is-disabled":X(i.data.stage.id),onToggleStageEnabledState:et},null,8,["stage","statistics","project","build-spec","is-disabled"])]),default:a(()=>[e(t(te),{"pattern-color":"#aaa",gap:16})]),_:1},8,["nodes","edges","pan-on-scroll"])):(p(),T(t(ft),{key:1,class:"empty-state-card"},{default:a(()=>[e(t(B),{vertical:"",gap:24,align:"center"},{default:a(()=>[e(t(Ve),{size:64,color:wt}),e(t(B),{vertical:"",gap:8,align:"center"},{default:a(()=>[e(t(ut),{level:3},{default:a(()=>[z(m(t(v).translate("i18n_workflowviewer_getting_started")),1)]),_:1}),e(t(R),{type:"secondary",style:{"text-align":"center"}},{default:a(()=>[z(m(t(v).translate("i18n_workflowviewer_no_workflow_description")),1)]),_:1})]),_:1}),e(t(B),{gap:16,wrap:"wrap",justify:"center"},{default:a(()=>[e(t(ft),{class:"option-card"},{default:a(()=>[e(t(B),{vertical:"",gap:12},{default:a(()=>[e(t(zt),{size:32,color:wt}),e(t(ut),{level:5},{default:a(()=>[z(m(t(v).translate("i18n_workflowviewer_option_cli")),1)]),_:1}),e(t(R),{type:"secondary",style:{"font-size":"13px"}},{default:a(()=>[z(m(t(v).translate("i18n_workflowviewer_cli_description")),1)]),_:1}),e(t(B),{vertical:"",gap:8},{default:a(()=>[w("div",aa,[o[4]||(o[4]=w("code",{class:"install-code"},"pip install abstra",-1)),e(at,{type:"text",size:"small",onClick:o[0]||(o[0]=i=>I("pip install abstra"))},{default:a(()=>[e(t(kt),{size:16})]),_:1})]),w("div",sa,[o[5]||(o[5]=w("code",{class:"install-code"},"abstra editor .",-1)),e(at,{type:"text",size:"small",onClick:o[1]||(o[1]=i=>I("abstra editor ."))},{default:a(()=>[e(t(kt),{size:16})]),_:1})])]),_:1})]),_:1})]),_:1}),e(t(ft),{class:"option-card"},{default:a(()=>[e(t(B),{vertical:"",gap:12},{default:a(()=>[e(t(Pt),{size:32,color:wt}),e(t(ut),{level:5},{default:a(()=>[z(m(t(v).translate("i18n_workflowviewer_option_online")),1)]),_:1}),e(t(R),{type:"secondary",style:{"font-size":"13px"}},{default:a(()=>[z(m(t(v).translate("i18n_workflowviewer_online_description")),1)]),_:1}),e(at,{type:"primary",onClick:S},{default:a(()=>[z(m(t(v).translate("i18n_workflowviewer_open_editor")),1)]),_:1})]),_:1})]),_:1})]),_:1}),e(t(Jt),{href:"https://www.abstra.io/docs",target:"_blank"},{default:a(()=>[z(m(t(v).translate("i18n_workflowviewer_view_docs"))+" ",1),e(t(Kt),{size:14,style:{"margin-left":"4px"}})]),_:1})]),_:1})]),_:1})),!u.value&&V.value?(p(),T(at,{key:3,class:vt(["edit-button",{expanded:C.value}]),type:"primary",size:"large",onClick:S,onMouseenter:o[2]||(o[2]=i=>C.value=!0),onMouseleave:o[3]||(o[3]=i=>C.value=!1)},{default:a(()=>[e(t(Qt),{size:24}),C.value?(p(),P("span",oa,m(t(v).translate("i18n_workflowviewer_edit_online")),1)):E("",!0)]),_:1},8,["class"])):E("",!0),e(Bt,{"creating-task-state":t(q).creatingTaskState.value,"is-payload-valid":t(q).isPayloadValid.value,onCreate:$t,onCancel:t(q).cancelCreatingTask},null,8,["creating-task-state","is-payload-valid","onCancel"])]))}}),La=ht(na,[["__scopeId","data-v-3b33d091"]]);export{La as default};
//# sourceMappingURL=WorkflowViewer-DRHIB1Rk.js.map
