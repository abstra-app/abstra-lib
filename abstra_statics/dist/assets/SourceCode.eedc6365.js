var re=Object.defineProperty;var de=(o,e,t)=>e in o?re(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var p=(o,e,t)=>(de(o,typeof e!="symbol"?e+"":e,t),t);import{E as b,d as ce,e3 as ue,f as P,h as he,g as fe,J as pe,a8 as ge,am as me,o as v,K as W,c as A,w as l,b as u,u as r,bE as ve,aP as H,az as g,eb as U,F as y,cs as _e,da as R,bM as L,a as G,ec as Q,Q as Ce}from"./index.79dc3613.js";import"./linters.a2a3c525.js";import{W as ye}from"./workspaces.9b8d8b61.js";import{a as Y}from"./asyncComputed.3aa6bfc4.js";import{u as we}from"./polling.29f699a6.js";import{b as Ee,a as Me}from"./validations.6a3e760f.js";import{G as be}from"./PhFolder.vue.2b499f0c.js";import{l as V,R as X,e as S,M as O}from"./toggleHighContrast.65c85e05.js";import{A as ke}from"./index.745c1115.js";import{C as Ie}from"./Card.b1519b39.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[e]="2e63fac6-1f69-490c-a082-22668950be87",o._sentryDebugIdIdentifier="sentry-dbid-2e63fac6-1f69-490c-a082-22668950be87")}catch{}})();class K{static async getAutocomplete(e){try{return await(await fetch("/_editor/api/pysa/autocomplete",{headers:{"content-type":"application/json"},body:JSON.stringify(e),method:"POST"})).json()}catch{return[]}}static async getHelp(e){try{return await(await fetch("/_editor/api/pysa/help",{headers:{"content-type":"application/json"},body:JSON.stringify(e),method:"POST"})).json()}catch{return[]}}static async getLint(e){try{return await(await fetch("/_editor/api/pysa/lint",{headers:{"content-type":"application/json"},body:JSON.stringify(e),method:"POST"})).json()}catch{return[]}}}let T={};function De(o){return o in T?"\n\n```python\n"+o+" = "+T[o]+"\n```":""}function Oe(o){switch(o){case"error":return O.Error;case"warning":return O.Warning;case"info":return O.Info;case"hint":return O.Hint;default:return O.Error}}V.registerHoverProvider("python",{async provideHover(o,e){const t=o.getWordAtPosition(e);return t?{contents:(await K.getHelp({code:o.getValue(),line:e.lineNumber,column:e.column})).map(d=>({value:d.docstring+De(d.name)})),range:new X(e.lineNumber,t.startColumn,e.lineNumber,t.endColumn)}:null}});V.registerCompletionItemProvider("python",{async provideCompletionItems(o,e){const t=await K.getAutocomplete({code:o.getValue(),line:e.lineNumber,column:e.column-1}),i=o.getWordUntilPosition(e);return{suggestions:t.map(d=>({label:d.name,kind:V.CompletionItemKind.Function,documentation:d.documentation,insertText:d.name,insertTextRules:V.CompletionItemInsertTextRule.InsertAsSnippet,range:{startLineNumber:e.lineNumber,endLineNumber:e.lineNumber,startColumn:i.startColumn,endColumn:i.endColumn}}))}}});const q=o=>{o.getLanguageId()==="python"&&K.getLint({code:o.getValue(),line:0,column:0}).then(e=>{S.setModelMarkers(o,o.getLanguageId(),e.map(t=>({startLineNumber:t.line,startColumn:t.column,endLineNumber:t.until_line,endColumn:t.until_column,message:t.message,severity:Oe(t.severity)})))})},Se=(o,e,t={})=>{var E;const i=S.create(o,{language:t.language||"python",value:e,minimap:{enabled:!1},readOnly:(E=t.readOnly)!=null?E:!1,contextmenu:!t.readOnly,automaticLayout:!t.readOnly,tabSize:4,fixedOverflowWidgets:!0,theme:t.theme?t.theme:"vs",fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:t.readOnly?0:5,scrollBeyondLastLine:!t.readOnly,renderLineHighlight:t.readOnly?"none":"all",scrollbar:{useShadows:!1,alwaysConsumeMouseWheel:!1}}),d=i.getContribution("editor.contrib.messageController");i.onDidAttemptReadOnlyEdit(()=>{d.showMessage("Cannot edit during preview execution",i.getPosition())});const _=i.createDecorationsCollection([]),x=(h,M)=>{_.set(h.map(c=>({range:new X(c.lineno,1,c.lineno,1),options:{isWholeLine:!0,className:M}}))),T=h.reduce((c,I)=>({...c,...I.locals}),{})},N=(h,M)=>c=>{const I=c.filter(B=>B.filename.endsWith(M));x(I,h)},w=()=>{_.clear(),T={}},k=h=>{i.updateOptions({readOnly:h})};return q(i.getModel()),i.onDidChangeModelContent(()=>{q(i.getModel())}),{editor:i,highlight:N,clearHighlights:w,setReadOnly:k}},xe=(o,e,t)=>{const i=S.createModel(e),d=S.createModel(t),_=S.createDiffEditor(o,{minimap:{enabled:!1},readOnly:!0,contextmenu:!1,automaticLayout:!0,renderWhitespace:"none",guides:{indentation:!1},fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:0,scrollBeyondLastLine:!1,renderLineHighlight:"none"});return _.setModel({original:i,modified:d}),{diffEditor:_}};class Ne{constructor(e,t,i="python"){p(this,"_script");p(this,"_localEditorCode");p(this,"_monacoEditor");p(this,"_diffEditor");p(this,"_viewMode");p(this,"_alertMessage");p(this,"_conflictingChanges");p(this,"_hasOutdatedCode");p(this,"_language");this._localEditorCode=e,this._script=t,this._monacoEditor=null,this._diffEditor=null,this._viewMode=b("editor"),this._alertMessage=b(""),this._conflictingChanges=b(!1),this._hasOutdatedCode=b(!1),this._language=b(i)}get alertMessage(){return this._alertMessage.value}set alertMessage(e){this._alertMessage.value=e}get conflictingChanges(){return this._conflictingChanges.value}set conflictingChanges(e){this._conflictingChanges.value=e}get viewMode(){return this._viewMode.value}set viewMode(e){this._viewMode.value=e}get abstraIDECode(){return this._script.codeContent}get localEditorCode(){return this._localEditorCode}set localEditorCode(e){this._localEditorCode=e}set monacoEditor(e){this._monacoEditor=e}set diffEditor(e){this._diffEditor=e}finishPreview(){var e;this._viewMode.value="editor",this._script.codeContent=this._localEditorCode,this._hasOutdatedCode.value&&((e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._hasOutdatedCode.value=!1),this._script.updateInitialState("code_content",this._localEditorCode),this.alertMessage=""}updateCodeWhileEditing(e){var d;const t=e!==this._localEditorCode;if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1;return}const i=!this._script.hasChanges("code_content");if(i){(d=this._monacoEditor)==null||d.setValue(e),this._script.codeContent=e,this._script.updateInitialState("code_content",e);return}if(!i&&t){this.alertMessage="You have conflicting changes with your local editor code",this.conflictingChanges=!0;return}}updateCodeWhileDiff(e){var t,i;if(e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1,this.viewMode="editor",this._localEditorCode=e;return}if(e!==this._localEditorCode){(i=(t=this._diffEditor)==null?void 0:t.getModel())==null||i.modified.setValue(e),this._localEditorCode=e;return}}updateCodeWhilePreview(e){if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="";return}this._hasOutdatedCode.value=!0,this.alertMessage="The changes on your code will be shown after the preview stops running"}updateCode(e){switch(this._viewMode.value){case"editor":return this.updateCodeWhileEditing(e);case"diff":return this.updateCodeWhileDiff(e);case"preview":return this.updateCodeWhilePreview(e)}}keepAbstraIDECode(){var e;(e=this._monacoEditor)==null||e.setValue(this._script.codeContent),this._script.save("code_content"),this._script.updateInitialState("code_content",this._script.codeContent),this._localEditorCode=this._script.codeContent,this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}keepLocalEditor(){var e;(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}}const Fe={class:"source-code-container"},Pe={class:"code-container"},We={key:0,class:"not-found-container"},Ae=ce({__name:"SourceCode",props:{script:{},workspace:{},language:{},hideHeader:{type:Boolean}},emits:["update-file"],setup(o,{expose:e,emit:t}){const i=o,d=ue(),_=()=>{s.value.viewMode="diff",le()},x=P(null),N=P(null);let w,k,E,h;const{result:M}=Y(()=>fetch("/_editor/api/workspace/root").then(a=>a.text())),c=P(i.script.file);he(()=>i.script.file,()=>c.value=i.script.file);const{result:I,refetch:B}=Y(()=>ye.checkFile(c.value)),Z=()=>{D.value.valid?t("update-file",Ee(c.value)):t("update-file",c.value),B()},D=fe(()=>{var n;const a=Me(c.value);return a.valid?((n=I.value)==null?void 0:n.exists)&&i.script.hasChanges("file")?{valid:!0,help:"This file already exists"}:i.script.hasChanges("file")?{valid:!0,help:"The original file will be renamed"}:a:a}),ee=()=>{d.push({name:"sourceCode"})},F=P(!1),s=b(null),te=async()=>{var n;if(!i.script.file)return;const a=await i.workspace.readFile(i.script.file);if(a===null){F.value=!0;return}F.value=!1,(n=s.value)==null||n.updateCode(a)},{startPolling:ie,endPolling:oe}=we({task:te});pe(()=>{se(),ie()}),ge(()=>{oe()});const ae=()=>{h(!0),s.value.viewMode="preview"},ne=(a,n)=>{if(n)return E("error-line",i.script.file)(a);E("executing-line",i.script.file)(a)},se=async()=>{await me(),i.workspace.readFile(i.script.file).then(a=>{const n=a!=null?a:"";i.script.codeContent=n,i.script.updateInitialState("code_content",n),s.value=new Ne(n,i.script,i.language);const f=Se(x.value,n,{language:i.language});k=f.clearHighlights,E=f.highlight,h=f.setReadOnly,w=f.editor,f.editor.onDidChangeModelContent(()=>{k()}),s.value.monacoEditor=w,w.onDidChangeModelContent(()=>{i.script.codeContent=w.getValue()})})},le=async()=>{const a=await i.workspace.readFile(i.script.file);if(!a)return;const n=i.script.codeContent,f=xe(N.value,n,a);s.value.diffEditor=f.diffEditor},j=()=>{var a;k(),h(!1),(a=s.value)==null||a.finishPreview()};return e({startPreviewMode:ae,setHighlight:ne,restartEditor:j,updateLocalEditorCode:a=>{s.value.localEditorCode=a,j()}}),(a,n)=>{var f,z,$,J;return v(),W("div",Fe,[a.hideHeader?y("",!0):(v(),A(r(R),{key:0,gap:"8",style:{width:"100%"}},{default:l(()=>[u(r(_e),{"validate-status":D.value.valid?"success":"error",help:D.value.valid?D.value.help:D.value.reason,class:"file-input"},{default:l(()=>[u(r(ve),{value:c.value,"onUpdate:value":n[0]||(n[0]=C=>c.value=C),autocomplete:"off",onChange:Z},{addonBefore:l(()=>[r(M)?(v(),W("span",{key:0,class:"clickable",onClick:ee},[u(r(H),{placement:"bottomLeft","overlay-style":{maxWidth:"none"}},{title:l(()=>[g(U(r(M)),1)]),default:l(()=>[u(r(be),{size:"22"})]),_:1})])):y("",!0)]),_:1},8,["value"])]),_:1},8,["validate-status","help"])]),_:1})),!a.hideHeader&&!!((f=s.value)!=null&&f.alertMessage)?(v(),A(r(ke),{key:1,type:"warning","show-icon":""},{message:l(()=>{var C;return[g(U((C=s.value)==null?void 0:C.alertMessage),1)]}),action:l(()=>[s.value.conflictingChanges&&s.value.viewMode!=="diff"?(v(),A(r(R),{key:0,gap:"small"},{default:l(()=>[u(r(L),{type:"primary",onClick:_},{default:l(()=>[g("Compare")]),_:1}),u(r(H),null,{title:l(()=>[g("Keep the local editor version")]),default:l(()=>[u(r(L),{onClick:n[1]||(n[1]=C=>{var m;return(m=s.value)==null?void 0:m.keepLocalEditor()})},{default:l(()=>[g("Discard")]),_:1})]),_:1})]),_:1})):y("",!0),s.value.conflictingChanges&&s.value.viewMode==="diff"?(v(),A(r(R),{key:1,gap:"small"},{default:l(()=>[u(r(H),null,{title:l(()=>[g("Keep your current changes")]),default:l(()=>[u(r(L),{onClick:n[2]||(n[2]=C=>{var m;return(m=s.value)==null?void 0:m.keepAbstraIDECode()})},{default:l(()=>[g("Keep left")]),_:1})]),_:1}),u(r(H),null,{title:l(()=>[g("Keep the local editor version")]),default:l(()=>[u(r(L),{onClick:n[3]||(n[3]=C=>{var m;return(m=s.value)==null?void 0:m.keepLocalEditor()})},{default:l(()=>[g("Keep right")]),_:1})]),_:1})]),_:1})):y("",!0)]),_:1})):y("",!0),G("div",Pe,[F.value?(v(),W("div",We,[u(r(Ie),null,{title:l(()=>[g("File not found")]),_:1})])):y("",!0),G("div",{id:"code",ref_key:"codeComponent",ref:x,class:Q(["monaco-element",{hide:((z=s.value)==null?void 0:z.viewMode)==="diff",blur:F.value}])},null,2),(($=s.value)==null?void 0:$.viewMode)==="diff"?(v(),W("div",{key:1,id:"code",ref_key:"codeDiffComponent",ref:N,class:Q(["monaco-element",{hide:((J=s.value)==null?void 0:J.viewMode)!=="diff"}])},null,2)):y("",!0)])])}}});const Ge=Ce(Ae,[["__scopeId","data-v-108be37b"]]);export{Ge as S};
//# sourceMappingURL=SourceCode.eedc6365.js.map
