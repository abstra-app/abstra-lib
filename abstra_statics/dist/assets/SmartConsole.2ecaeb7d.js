var ve=Object.defineProperty;var fe=(s,e,t)=>e in s?ve(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var A=(s,e,t)=>(fe(s,typeof e!="symbol"?e+"":e,t),t);import{a as J}from"./asyncComputed.06133f02.js";import{F as ge}from"./forms.53add417.js";import{D as me}from"./dashes.2219b4f6.js";import{H as ye}from"./hooks.4a40d405.js";import{J as K}from"./jobs.4e6199e9.js";import{W as _e}from"./workspaces.4a7fbc34.js";import{d as U,G as ee,H as j,ey as we,a as te,b as d,et as v,f as u,w as S,aI as N,u as i,c as se,bV as V,ev as T,e as r,eB as P,bf as ne,v as F,r as h,S as q,ex as D,eC as ae,eD as oe,ez as Ce,J as be,a4 as ke,o as Se,L as Ie,I as x,eu as Ee,eA as xe,eO as Te,eP as Re}from"./outputWidgets.045188bd.js";import{A as $e}from"./activeRecord.0c38eaa0.js";import{n as Ae,e as De,s as G,o as Y,p as Q,q as je}from"./icons.5c1b068e.js";import{c as Pe,A as X}from"./Title.68794b00.js";import{A as Le}from"./index.9fe41369.js";import{u as B}from"./uuid.beef1d59.js";import{l as Oe}from"./DocsButton.vue_vue_type_script_setup_true_lang.00692ab2.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[e]="fa46cefc-9f7e-481c-94f2-b49f18697c0c",s._sentryDebugIdIdentifier="sentry-dbid-fa46cefc-9f7e-481c-94f2-b49f18697c0c")}catch{}})();class Me{async list(){return await(await fetch("/_editor/api/scripts")).json()}async create(){return await(await fetch("/_editor/api/scripts",{method:"POST",headers:{"Content-Type":"application/json"}})).json()}async get(e){return await(await fetch(`/_editor/api/scripts/${e}`)).json()}async update(e,t){return await(await fetch(`/_editor/api/scripts/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()}async delete(e){await fetch(`/_editor/api/scripts/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json"}})}async test(e){return(await fetch(`/_editor/api/scripts/${e}/test`,{method:"POST",headers:{"Content-Type":"application/json"}})).json()}}const I=new Me;class R{constructor(e){A(this,"record");this.record=$e.create(I,e,"path")}static async list(){return(await I.list()).map(t=>new R(t))}static async create(){const e=await I.create();return new R(e)}static async get(e){const t=await I.get(e);return new R(t)}async delete(){await I.delete(this.path)}async duplicate(){return this}async save(){await this.record.save()}onUpdate(e){this.record.pubsub.subscribe("update",e)}hasChanges(e){return this.record.hasChanges(e)}get schedule(){return this.record.get("schedule")}set schedule(e){this.record.set("schedule",e)}get title(){return this.record.get("title")}set title(e){this.record.set("title",e)}get file(){return this.record.get("file")}set file(e){this.record.set("file",e)}get path(){return this.record.get("path")}set path(e){this.record.set("path",e)}async test(){return I.test(this.path)}get routeName(){return"script"}get position(){const[e,t]=this.record.get("workflow_position");return{x:e,y:t,referential:"world"}}get isInitial(){return!1}}const Ne={class:"file-path"},Be={key:1},Ue=U({__name:"RuntimeCommonSettings",props:{runtime:{}},setup(s){const e=s,t=ee({pathError:null}),{result:n}=J(()=>_e.get()),l=()=>{!n.value||!e.runtime.file||n.value.openFile(e.runtime.file)},f=j(()=>{var a;return(a=e.runtime.file)!=null&&a.endsWith(".py")?e.runtime.hasChanges("file")?"The original file will be renamed after saving":null:"It should be a .py file"}),c=()=>{!n.value||!b.value||n.value.openFile(".")},C=we(),{result:b}=J(()=>fetch("/_editor/api/workspace/root-path").then(a=>a.text()));return e.runtime.onUpdate(a=>{if(e.runtime instanceof K||!a||!("path"in a)||!(a!=null&&a.path))return;const _=[{runtime:ge,basePath:"form"},{runtime:ye,basePath:"hook"},{runtime:me,basePath:"dash"}].find(g=>e.runtime instanceof g.runtime);if(!_)throw new Error(`Unknown runtime type ${e.runtime}`);C.push({path:`/_editor/${_.basePath}/${encodeURIComponent(a.path)}`})}),(a,p)=>{const _=te("icon");return d(),v(ne,null,[u(i(Pe),{level:3},{default:S(()=>[N("Common")]),_:1}),a.runtime instanceof i(K)||a.runtime instanceof i(R)?T("",!0):(d(),se(i(X),{key:0,label:"Path"},{default:S(()=>[u(i(V),{value:a.runtime.path,"onUpdate:value":p[0]||(p[0]=g=>a.runtime.path=g),type:"text"},null,8,["value"])]),_:1})),u(i(Le),null,{default:S(()=>[u(i(X),{label:"source code",help:f.value},{default:S(()=>[u(i(V),{value:a.runtime.file,"onUpdate:value":p[3]||(p[3]=g=>a.runtime.file=g),type:"text"},{addonBefore:S(()=>[i(b)?(d(),v("span",{key:0,class:"clickable",onClick:p[1]||(p[1]=g=>c())},[u(_,{class:"clickable",path:i(Ae)},null,8,["path"]),r("p",Ne,P(i(b)),1)])):T("",!0)]),addonAfter:S(()=>[r("span",{class:"clickable",onClick:p[2]||(p[2]=g=>l())},[u(_,{class:"clickable",path:i(De)},null,8,["path"]),N(" Open file ")])]),_:1},8,["value"])]),_:1},8,["help"])]),_:1}),t.pathError?(d(),v("div",Be,P(t.pathError),1)):T("",!0)],64)}}});const Ct=F(Ue,[["__scopeId","data-v-24ce428d"]]);class re{constructor(){A(this,"logState",ee({log:[]}));A(this,"_listeners",{})}static create(){return new re}get logs(){return this.logState.log}log(e,t){if(e.type!=="restart"&&e.log.trim()==="")return;const n=t?this.logs.find(l=>l.id===t):null;return n?Object.assign(n,e):this.logs.push({...e,id:t||B()}),this.notifyListeners(e),t}clear(){this.logState.log=[]}listen(e){const t=B();return this._listeners[t]=e,t}unlisten(e){delete this._listeners[e]}notifyListeners(e){Object.values(this._listeners).forEach(t=>t(e))}}class Fe{static async*sendMessage(e,t){var f;const l=(f=(await fetch("/_editor/api/ai/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e,runtime:t})})).body)==null?void 0:f.getReader();if(!l)throw new Error("No response body");for(;;){const c=await l.read();if(c.done)break;yield new TextDecoder().decode(c.value)}}}const ze=s=>(ae("data-v-59ca7295"),s=s(),oe(),s),He=ze(()=>r("div",{class:"text"}," Changes were made in your code. Click Restart to refresh the preview window. ",-1)),Z="ignoreCodeChangesWarning",We=U({__name:"ChangesWarning",props:{hasChanges:{type:Boolean}},setup(s){var f;const e=s,t=h((f=q.get(Z))!=null?f:!1),n=j(()=>e.hasChanges&&!t.value),l=()=>{q.set(Z,!0),t.value=!0};return(c,C)=>(d(),v("div",{class:D(["changes-warning",{visible:n.value}])},[He,r("div",{class:"no-more-alert",onClick:l},"Do not show again")],2))}});const Je=F(We,[["__scopeId","data-v-59ca7295"]]),Ke=s=>(ae("data-v-440200c2"),s=s(),oe(),s),Ve={class:"smart-console"},qe={class:"header"},Ge={class:"left"},Ye={class:"right"},Qe={class:"changes-container"},Xe=["unseen-severity"],Ze={class:"cli"},et={class:"left"},tt=Ke(()=>r("div",{class:"entry ai-output"}," Hello there! I'm both an output console and AI assistant. You can ask me anything. ",-1)),st={key:1,class:"local-entry"},nt={class:"input"},at=["pointer-events","onKeydown"],ot={class:"right"},rt=U({__name:"SmartConsole",props:{inputEnabled:{type:Boolean},formCode:{},runtime:{},logService:{}},emits:["eval-request","clear-terminal","restart","enter"],setup(s,{emit:e}){const t=s,n=h(""),l=h(null),f=Ce(),c=h({type:"seen"}),C=h(!1),b=h(!1),a=()=>{t.logService.clear(),e("restart")},p=()=>{E.value=E.value==="assistant"?"debugger":"assistant"};function _(o){switch(o.type){case"ai-input":return{role:"user",content:o.log};case"ai-output":return{role:"assistant",content:o.log};case"stderr":case"stdout":return{role:"user",content:o.log};case"restart":return{role:"user",content:"-- new session --"};case"files-changed":return{role:"user",content:"-- files changed --"};default:throw new Error(`Unknown log type: ${o.type}`)}}const g=j(()=>t.logService.logs.some(o=>o.type==="files-changed"));function ie(){w.value=!w.value,w.value&&(c.value={type:"seen"})}be(f,()=>{t.logService.clear(),e("clear-terminal")});const $=h(null),E=h("assistant"),le=async o=>{var y;if(o.preventDefault(),n.value=((y=$.value)==null?void 0:y.innerText)||"",o.shiftKey){document.execCommand("insertLineBreak");return}$.value&&($.value.innerText=""),E.value==="assistant"?await ce():await ue()},ce=async()=>{var y;if(e("enter",n.value),t.logService.log({type:"ai-input",log:n.value}),n.value="",!b.value){t.logService.log({type:"stderr",log:"Please login to use the AI assistant."});return}C.value=!0;const o={role:"user",content:(y=t.formCode)!=null?y:""};try{const k=B();let m="";const O=Fe.sendMessage([o,...t.logService.logs.map(M=>_(M)),{role:"user",content:n.value}],t.runtime);for await(const M of O)m+=M,t.logService.log({type:"ai-output",log:m},k)}catch(k){t.logService.log({type:"ai-output",log:"Sorry, I don't know how to answer that."}),console.error(k),Re(k)}finally{C.value=!1}},ue=async()=>{n.value&&(t.logService.log({type:"eval-input",log:`>>> ${n.value}`}),e("eval-request",n.value),n.value="")},de=()=>{t.logService.clear()};t.logService.listen(async o=>{w.value||(c.value={type:"unseen",count:c.value.type==="unseen"?c.value.count+1:1,severity:o.type==="stderr"?"error":"info"}),o.type!=="restart"&&(await ke(),l.value&&(l.value.scrollTop=l.value.scrollHeight))});const w=h(!1),z=h(400),pe=j(()=>({height:`${z.value}px`})),L=h(!1),he=()=>L.value=!0,H=o=>{!L.value||(z.value=document.body.clientHeight-o.clientY)},W=()=>L.value=!1;return Se(()=>{document.addEventListener("mousemove",H),document.addEventListener("mouseup",W),Oe.get().then(o=>b.value=!!o)}),Ie(()=>{document.removeEventListener("mousemove",H),document.removeEventListener("mouseup",W)}),(o,y)=>{const k=te("Markdown");return d(),v("div",Ve,[r("div",qe,[r("div",Ge,[u(x,{path:E.value==="assistant"?i(G):i(Y)},null,8,["path"]),N(" Smart Console ")]),r("div",Ye,[r("div",Qe,[u(Je,{"has-changes":g.value},null,8,["has-changes"]),r("button",{class:"header-button",onClick:a},"Restart")]),r("div",{class:"toggle-button",onClick:ie},[u(x,{class:D(["icon",{open:w.value}]),path:i(Q),fill:"#fff"},null,8,["class","path"]),c.value.type==="unseen"?(d(),v("div",{key:0,class:"unseen-count","unseen-severity":c.value.severity},P(c.value.count),9,Xe)):T("",!0)])])]),w.value?(d(),v("div",{key:0,class:"terminal",style:Ee(pe.value)},[r("div",{class:"resize-handler",onMousedown:he},null,32),r("div",Ze,[r("div",et,[r("div",{ref_key:"entriesContainer",ref:l,class:"entries"},[tt,(d(!0),v(ne,null,xe(t.logService.logs,(m,O)=>(d(),v("div",{key:O,class:D([m.type,"entry"])},[m.type==="ai-output"?(d(),se(k,{key:0,source:m.log},null,8,["source"])):(d(),v("div",st,P(m.type==="restart"?"-- restarted --":m.log),1))],2))),128))],512),r("div",nt,[u(x,{class:D(["icon",{open:w.value}]),path:i(Q)},null,8,["class","path"]),r("div",{ref_key:"inputRef",ref:$,class:"input-text",contenteditable:"","pointer-events":C.value?"none":"auto",placeholder:"Ask AI anything",onKeydown:Te(le,["enter"])},null,40,at)])]),r("div",ot,[r("div",{class:"icons",onClick:de},[u(x,{class:"icon",path:i(je)},null,8,["path"])]),r("div",null,[u(x,{class:"icon clickable",path:E.value==="assistant"?i(G):i(Y),onClick:y[0]||(y[0]=m=>p())},null,8,["path"])])])])],4)):T("",!0)])}}});const bt=F(rt,[["__scopeId","data-v-440200c2"]]);export{re as L,Ct as R,bt as S,R as a};
//# sourceMappingURL=SmartConsole.2ecaeb7d.js.map
