var be=Object.defineProperty;var Ee=(o,e,s)=>e in o?be(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var S=(o,e,s)=>(Ee(o,typeof e!="symbol"?e+"":e,s),s);import{u as te}from"./uuid.9378b107.js";import{F as he,d as K,r as m,S as ie,G as Q,b as p,ev as k,e as d,ez as P,eE as fe,eF as ve,v as Z,eB as Se,H as se,a3 as ge,o as _e,K as me,a as ye,f as h,u as i,I as N,aq as C,eD as z,ex as M,ew as Me,bq as oe,eC as Ie,c as W,eP as xe,eV as De,eI as Fe,w as u,bH as Ce,E as G,bO as j,br as ee}from"./outputWidgets.ed48fa42.js";import{k as re,l as le,n as ce,o as Oe,q as Re,u as Ae}from"./icons.92b5bc38.js";import{l as Be}from"./NavbarControls.c7e6bede.js";import{H as We,J as $e}from"./jobs.003a7c8c.js";import{S as He}from"./scripts.42390c66.js";import{n as Pe,v as Te,a as Le}from"./validations.96d1c6c4.js";import{A as we}from"./FormItem.c1c36356.js";import{W as Ne}from"./workspaces.96d00a8d.js";import{a as ue}from"./asyncComputed.bb2b1403.js";import{l as ze,e as J,R as Ke}from"./toggleHighContrast.b28efbf2.js";import{A as de}from"./index.73ce74ba.js";import{A as Ve}from"./index.76f0a29a.js";import{C as qe}from"./Card.b7ee28eb.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[e]="3078a4ec-83a7-4311-aa25-c78ad0cdc87b",o._sentryDebugIdIdentifier="sentry-dbid-3078a4ec-83a7-4311-aa25-c78ad0cdc87b")}catch{}})();class ke{constructor(){S(this,"logState",he({log:[]}));S(this,"_listeners",{})}static create(){return new ke}get logs(){return this.logState.log}log(e,s){if(e.type!=="restart"&&e.log.trim()==="")return;const t=s?this.logs.find(r=>r.id===s):null;return t?Object.assign(t,e):this.logs.push({...e,id:s||te()}),this.notifyListeners(e),s}clear(){this.logState.log=[]}listen(e){const s=te();return this._listeners[s]=e,s}unlisten(e){delete this._listeners[e]}notifyListeners(e){Object.values(this._listeners).forEach(s=>s(e))}}class Ue{static async*sendMessage(e,s){var f;const r=(f=(await fetch("/_editor/api/ai/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e,runtime:s})})).body)==null?void 0:f.getReader();if(!r)throw new Error("No response body");for(;;){const _=await r.read();if(_.done)break;yield new TextDecoder().decode(_.value)}}}const Ye=o=>(fe("data-v-59ca7295"),o=o(),ve(),o),je=Ye(()=>d("div",{class:"text"}," Changes were made in your code. Click Restart to refresh the preview window. ",-1)),pe="ignoreCodeChangesWarning",Ge=K({__name:"ChangesWarning",props:{hasChanges:{type:Boolean}},setup(o){var f;const e=o,s=m((f=ie.get(pe))!=null?f:!1),t=Q(()=>e.hasChanges&&!s.value),r=()=>{ie.set(pe,!0),s.value=!0};return(_,F)=>(p(),k("div",{class:P(["changes-warning",{visible:t.value}])},[je,d("div",{class:"no-more-alert",onClick:r},"Do not show again")],2))}});const Je=Z(Ge,[["__scopeId","data-v-59ca7295"]]),Qe=o=>(fe("data-v-9d2d7cb6"),o=o(),ve(),o),Xe={class:"smart-console"},Ze={class:"header"},et={class:"left"},tt={class:"right"},st={class:"changes-container"},ot=["unseen-severity"],nt={class:"cli"},at={class:"left"},it=Qe(()=>d("div",{class:"entry ai-output"}," Hello there! I'm both an output console and AI assistant. You can ask me anything. ",-1)),rt={key:1,class:"local-entry"},lt={class:"input"},ct=["pointer-events","onKeydown"],ut={class:"right"},dt=K({__name:"SmartConsole",props:{inputEnabled:{type:Boolean},formCode:{},runtime:{},logService:{}},emits:["eval-request","clear-terminal","restart","enter"],setup(o,{emit:e}){const s=o,t=m(""),r=m(null),f=Se(),_=m({type:"seen"}),F=m(!1),O=m(!1),A=()=>{b.value=b.value==="assistant"?"debugger":"assistant"};function R(c){switch(c.type){case"ai-input":return{role:"user",content:c.log};case"ai-output":return{role:"assistant",content:c.log};case"stderr":case"stdout":return{role:"user",content:c.log};case"restart":return{role:"user",content:"-- new session --"};case"files-changed":return{role:"user",content:"-- files changed --"};default:throw new Error(`Unknown log type: ${c.type}`)}}const y=Q(()=>s.logService.logs.some(c=>c.type==="files-changed"));function I(){w.value=!w.value,w.value&&(_.value={type:"seen"})}se(f,()=>{s.logService.clear(),e("clear-terminal")});const v=m(null),b=m("assistant"),T=async c=>{var n;if(c.preventDefault(),t.value=((n=v.value)==null?void 0:n.innerText)||"",c.shiftKey){document.execCommand("insertLineBreak");return}v.value&&(v.value.innerText=""),b.value==="assistant"?await $():await E()},$=async()=>{var n;if(e("enter",t.value),s.logService.log({type:"ai-input",log:t.value}),t.value="",!O.value){s.logService.log({type:"stderr",log:"Please login to use the AI assistant."});return}F.value=!0;const c={role:"user",content:(n=s.formCode)!=null?n:""};try{const a=te();let g="";const x=Ue.sendMessage([c,...s.logService.logs.map(D=>R(D)),{role:"user",content:t.value}],s.runtime);for await(const D of x)g+=D,s.logService.log({type:"ai-output",log:g},a)}catch(a){s.logService.log({type:"ai-output",log:"Sorry, I don't know how to answer that."}),console.error(a),De(a)}finally{F.value=!1}},E=async()=>{t.value&&(s.logService.log({type:"eval-input",log:`>>> ${t.value}`}),e("eval-request",t.value),t.value="")},L=()=>{s.logService.clear()};s.logService.listen(async c=>{w.value||(_.value={type:"unseen",count:_.value.type==="unseen"?_.value.count+1:1,severity:c.type==="stderr"?"error":"info"}),c.type!=="restart"&&(await ge(),r.value&&(r.value.scrollTop=r.value.scrollHeight))});const w=m(!1),V=m(400),l=Q(()=>({height:`${V.value}px`})),H=m(!1),q=()=>H.value=!0,U=c=>{!H.value||(V.value=document.body.clientHeight-c.clientY)},Y=()=>H.value=!1;return _e(()=>{document.addEventListener("mousemove",U),document.addEventListener("mouseup",Y),Be.get().then(c=>{O.value=!!c.logged})}),me(()=>{document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",Y)}),(c,n)=>{const a=ye("Markdown");return p(),k("div",Xe,[d("div",Ze,[d("div",et,[h(N,{path:b.value==="assistant"?i(re):i(le)},null,8,["path"]),C(" Smart Console ")]),d("div",tt,[d("div",st,[h(Je,{"has-changes":y.value},null,8,["has-changes"])]),d("div",{class:"toggle-button",onClick:I},[h(N,{class:P(["icon",{open:w.value}]),path:i(ce),fill:"#fff"},null,8,["class","path"]),_.value.type==="unseen"?(p(),k("div",{key:0,class:"unseen-count","unseen-severity":_.value.severity},z(_.value.count),9,ot)):M("",!0)])])]),w.value?(p(),k("div",{key:0,class:"terminal",style:Me(l.value)},[d("div",{class:"resize-handler",onMousedown:q},null,32),d("div",nt,[d("div",at,[d("div",{ref_key:"entriesContainer",ref:r,class:"entries"},[it,(p(!0),k(oe,null,Ie(s.logService.logs,(g,x)=>(p(),k("div",{key:x,class:P([g.type,"entry"])},[g.type==="ai-output"?(p(),W(a,{key:0,source:g.log},null,8,["source"])):(p(),k("div",rt,z(g.type==="restart"?"-- restarted --":g.log),1))],2))),128))],512),d("div",lt,[h(N,{class:P(["icon",{open:w.value}]),path:i(ce)},null,8,["class","path"]),d("div",{ref_key:"inputRef",ref:v,class:"input-text",contenteditable:"","pointer-events":F.value?"none":"auto",placeholder:"Ask AI anything",onKeydown:xe(T,["enter"])},null,40,ct)])]),d("div",ut,[d("div",{class:"icons",onClick:L},[h(N,{class:"icon",path:i(Oe)},null,8,["path"])]),d("div",null,[h(N,{class:"icon clickable",path:b.value==="assistant"?i(re):i(le),onClick:n[0]||(n[0]=g=>A())},null,8,["path"])])])])],4)):M("",!0)])}}});const $t=Z(dt,[["__scopeId","data-v-9d2d7cb6"]]),pt=K({__name:"PathInput",props:{runtime:{}},setup(o){const e=o,s=()=>{const t=Pe(e.runtime.path);t&&t!==e.runtime.path&&(e.runtime.path=t)};return(t,r)=>(p(),W(i(Ce),{value:t.runtime.path,"onUpdate:value":r[0]||(r[0]=f=>t.runtime.path=f),type:"text",onBlur:s},Fe({_:2},[t.runtime instanceof i(We)?{name:"addonBefore",fn:u(()=>[C(" https://[your-subdomain].abstra.app/_hooks/ ")]),key:"0"}:{name:"addonBefore",fn:u(()=>[C(" https://[your-subdomain].abstra.app/ ")]),key:"1"}]),1032,["value"]))}}),ht={key:1},ft=K({__name:"RuntimeCommonSettings",props:{runtime:{}},setup(o){const e=he({pathError:null});return(s,t)=>(p(),k(oe,null,[s.runtime instanceof i($e)||s.runtime instanceof i(He)?M("",!0):(p(),W(i(we),{key:0,label:"URL path"},{default:u(()=>[h(pt,{runtime:s.runtime},null,8,["runtime"])]),_:1})),e.pathError?(p(),k("div",ht,z(e.pathError),1)):M("",!0)],64))}});const Ht=Z(ft,[["__scopeId","data-v-60a397e0"]]);let X={};function vt(o){return o in X?"\n\n```python\n"+o+" = "+X[o]+"\n```":""}ze.registerHoverProvider("python",{provideHover:function(o,e){const s=o.getWordAtPosition(e);if(!!s)return{contents:[{value:vt(s.word)}]}}});const gt=(o,e,s={})=>{var R;const t=J.create(o,{language:"python",value:e,minimap:{enabled:!1},readOnly:(R=s.readOnly)!=null?R:!1,contextmenu:!s.readOnly,automaticLayout:!s.readOnly,tabSize:4,fixedOverflowWidgets:!0,theme:s.theme?s.theme:"vs",fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:s.readOnly?0:5,scrollBeyondLastLine:!s.readOnly,renderLineHighlight:s.readOnly?"none":"all",scrollbar:{useShadows:!1,alwaysConsumeMouseWheel:!1}}),r=t.getContribution("editor.contrib.messageController");t.onDidAttemptReadOnlyEdit(()=>{r.showMessage("Cannot edit during preview execution",t.getPosition())});const f=t.createDecorationsCollection([]),_=(y,I)=>{f.set(y.map(v=>({range:new Ke(v.lineno,1,v.lineno,1),options:{isWholeLine:!0,className:I}}))),X=y.reduce((v,b)=>({...v,...b.locals}),{})};return{editor:t,highlight:(y,I)=>v=>{var $,E;const T=((E=($=v.debug)==null?void 0:$.stack)!=null?E:[]).filter(L=>L.filename.endsWith(I));_(T,y)},clearHighlights:()=>{f.clear(),X={}},setReadOnly:y=>{t.updateOptions({readOnly:y})}}},_t=(o,e,s)=>{const t=J.createModel(e),r=J.createModel(s),f=J.createDiffEditor(o,{minimap:{enabled:!1},readOnly:!0,contextmenu:!1,automaticLayout:!0,renderWhitespace:"none",guides:{indentation:!1},fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:0,scrollBeyondLastLine:!1,renderLineHighlight:"none"});return f.setModel({original:t,modified:r}),{diffEditor:f}};class mt{constructor(e,s){S(this,"_script");S(this,"_localEditorCode");S(this,"_monacoEditor");S(this,"_diffEditor");S(this,"_viewMode");S(this,"_alertMessage");S(this,"_conflictingChanges");this._localEditorCode=e,this._script=s,this._monacoEditor=null,this._diffEditor=null,this._viewMode=G("editor"),this._alertMessage=G(""),this._conflictingChanges=G(!1)}get alertMessage(){return this._alertMessage.value}set alertMessage(e){this._alertMessage.value=e}get conflictingChanges(){return this._conflictingChanges.value}set conflictingChanges(e){this._conflictingChanges.value=e}get viewMode(){return this._viewMode.value}set viewMode(e){this._viewMode.value=e}get abstraIDECode(){return this._script.codeContent}get localEditorCode(){return this._localEditorCode}set monacoEditor(e){this._monacoEditor=e}set diffEditor(e){this._diffEditor=e}finishPreview(){var e;this._viewMode.value="editor",this._script.codeContent=this._localEditorCode,(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.save("code_content"),this._script.updateInitialState("code_content",this._localEditorCode),this.alertMessage=""}updateCodeWhileEditing(e){var r;const s=e!==this._localEditorCode;if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1;return}const t=!this._script.hasChanges("code_content");if(t){(r=this._monacoEditor)==null||r.setValue(e),this._script.codeContent=e,this._script.updateInitialState("code_content",e);return}if(!t&&s){this.alertMessage="You have conflicting changes with your local editor code",this.conflictingChanges=!0;return}}updateCodeWhileDiff(e){var s,t;if(e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1,this.viewMode="editor",this._localEditorCode=e;return}if(e!==this._localEditorCode){(t=(s=this._diffEditor)==null?void 0:s.getModel())==null||t.modified.setValue(e),this._localEditorCode=e;return}}updateCodeWhilePreview(e){if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="";return}this.alertMessage="The changes on your code will be shown after the preview stops running"}updateCode(e){switch(this._viewMode.value){case"editor":return this.updateCodeWhileEditing(e);case"diff":return this.updateCodeWhileDiff(e);case"preview":return this.updateCodeWhilePreview(e)}}keepAbstraIDECode(){var e;(e=this._monacoEditor)==null||e.setValue(this._script.codeContent),this._script.save("code_content"),this._script.updateInitialState("code_content",this._script.codeContent),this._localEditorCode=this._script.codeContent,this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}keepLocalEditor(){var e;(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}}const yt={class:"container"},Ct=K({__name:"SourceCode",props:{script:{},workspace:{},broker:{}},emits:["update-file"],setup(o,{expose:e,emit:s}){const t=o,r=()=>{!t.script.file||t.workspace.openFile(t.script.file)},f=()=>{l.value.viewMode="diff",Y()},_=m(null),F=m(null);let O,A,R,y;const{result:I}=ue(()=>fetch("/_editor/api/workspace/root").then(n=>n.text())),v=m(t.script.file);se(()=>t.script.file,()=>v.value=t.script.file);const{result:b,refetch:T}=ue(()=>Ne.checkFile(v.value)),$=()=>{E.value.valid?s("update-file",Le(v.value)):s("update-file",v.value),T()},E=Q(()=>{var a;const n=Te(v.value);return n.valid?((a=b.value)==null?void 0:a.exists)&&t.script.hasChanges("file")?{valid:!0,help:"This file already exists"}:t.script.hasChanges("file")?{valid:!0,help:"The original file will be renamed"}:n:n}),L=()=>{!t.workspace||!I.value||t.workspace.openFile(".")},w=m(!1),V=async()=>{var a;if(!t.script.file)return;const n=await t.workspace.readFile(t.script.file);if(n===null){w.value=!0;return}w.value=!1,(a=l.value)==null||a.updateCode(n)},l=G(null);let H;_e(()=>{U(),H=setInterval(V,1e3)}),me(()=>{clearInterval(H)}),se(()=>t.broker,()=>{A(),q()});const q=()=>{var n,a,g;(n=t.broker)==null||n.on("start",()=>{y(!0),l.value.viewMode="preview"}),(a=t.broker)==null||a.on("form",R("executing-line",t.script.file)),(g=t.broker)==null||g.on("program:end",x=>{var D;(D=l.value)==null||D.finishPreview(),y(!1),x.exception?R("error-line",t.script.file)(x):A()})},U=async()=>{await ge(),t.workspace.readFile(t.script.file).then(n=>{if(n===null)return;t.script.codeContent=n,t.script.updateInitialState("code_content",n),l.value=new mt(n,t.script);const a=gt(_.value,n);A=a.clearHighlights,R=a.highlight,y=a.setReadOnly,q(),O=a.editor,l.value.monacoEditor=O,O.onDidChangeModelContent(()=>{t.script.codeContent=O.getValue()})})},Y=async()=>{const n=await t.workspace.readFile(t.script.file);if(!n)return;const a=t.script.codeContent,g=_t(F.value,a,n);l.value.diffEditor=g.diffEditor};return e({restartEditor:()=>{var n;A(),y(!1),(n=l.value)==null||n.finishPreview()}}),(n,a)=>{var x,D,ne,ae;const g=ye("icon");return p(),k(oe,null,[h(i(we),{"validate-status":E.value.valid?"success":"error",help:E.value.valid?E.value.help:E.value.reason},{default:u(()=>[h(i(Ce),{value:n.script.file,"onUpdate:value":a[0]||(a[0]=B=>n.script.file=B),onBlur:$},{addonBefore:u(()=>[i(I)?(p(),k("span",{key:0,class:"clickable",onClick:L},[h(g,{path:i(Re)},null,8,["path"]),d("span",null,z(i(I)),1)])):M("",!0)]),addonAfter:u(()=>[d("span",{class:"clickable",onClick:r},[C(" Open in editor "),h(g,{path:i(Ae),width:"22"},null,8,["path"])])]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),(x=l.value)!=null&&x.alertMessage?(p(),W(i(Ve),{key:0,type:"warning","show-icon":""},{message:u(()=>{var B;return[C(z((B=l.value)==null?void 0:B.alertMessage),1)]}),action:u(()=>[l.value.conflictingChanges&&l.value.viewMode!=="diff"?(p(),W(i(de),{key:0,gap:"small"},{default:u(()=>[h(i(j),{type:"primary",onClick:f},{default:u(()=>[C("Compare")]),_:1}),h(i(ee),null,{title:u(()=>[C("Keep the local editor version")]),default:u(()=>[h(i(j),{onClick:a[1]||(a[1]=B=>l.value.keepLocalEditor())},{default:u(()=>[C("Discard")]),_:1})]),_:1})]),_:1})):M("",!0),l.value.conflictingChanges&&l.value.viewMode==="diff"?(p(),W(i(de),{key:1,gap:"small"},{default:u(()=>[h(i(ee),null,{title:u(()=>[C("Keep your current changes")]),default:u(()=>[h(i(j),{onClick:a[2]||(a[2]=B=>l.value.keepAbstraIDECode())},{default:u(()=>[C("Keep left")]),_:1})]),_:1}),h(i(ee),null,{title:u(()=>[C("Keep the local editor version")]),default:u(()=>[h(i(j),{onClick:a[3]||(a[3]=B=>l.value.keepLocalEditor())},{default:u(()=>[C("Keep right")]),_:1})]),_:1})]),_:1})):M("",!0)]),_:1})):M("",!0),d("div",yt,[d("div",{id:"code",ref_key:"codeComponent",ref:_,class:P(["code-container",{hide:((D=l.value)==null?void 0:D.viewMode)==="diff",blur:w.value}])},null,2),w.value?(p(),W(i(qe),{key:0,class:"not-found-popup"},{title:u(()=>[C("File not found")]),_:1})):M("",!0)]),((ne=l.value)==null?void 0:ne.viewMode)==="diff"?(p(),k("div",{key:1,id:"code",ref_key:"codeDiffComponent",ref:F,class:P(["code-container",{hide:((ae=l.value)==null?void 0:ae.viewMode)!=="diff"}])},null,2)):M("",!0)],64)}}});const Pt=Z(Ct,[["__scopeId","data-v-975dd1bf"]]);export{ke as L,Ht as R,Pt as S,$t as a};
//# sourceMappingURL=SourceCode.608adc0a.js.map
