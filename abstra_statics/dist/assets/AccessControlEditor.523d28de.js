var I=Object.defineProperty;var T=(i,e,s)=>e in i?I(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s;var S=(i,e,s)=>(T(i,typeof e!="symbol"?e+"":e,s),s);import{C as x}from"./ContentLayout.7a54d457.js";import{l as B}from"./fetch.196cd5ed.js";import{E as D}from"./record.7cb5a1b7.js";import{d as C,a0 as V,y,b as n,eV as m,dy as E,eX as k,e_ as $,e as _,c as b,w as l,f as u,u as o,bF as N,am as v,f2 as P,cG as U,f4 as R,ay as H,ah as O,f3 as L,aC as z,cS as F,cE as G,cD as Z,cY as w,cV as W,cW as Y,cT as J,cU as X,dw as K}from"./outputWidgets.4146fe55.js";import{E as Q}from"./repository.fa9b4828.js";import{a as q}from"./asyncComputed.905ef636.js";import"./workspaces.b9f42c06.js";import{l as A}from"./editor.283ab711.js";import{S as ee}from"./SaveButton.3be6d11f.js";import{I as te}from"./PhGlobe.vue.c2783d36.js";import{A as se}from"./index.82dd18f4.js";import{P as oe}from"./PlusOutlined.44447af8.js";import{i as re}from"./metadata.9d02b937.js";import{A as ae}from"./index.4490cc25.js";import{A as le}from"./index.e935ab4c.js";import"./pubsub.93b3ca03.js";import"./gateway.70ae421b.js";import"./popupNotifcation.a0c2264e.js";import"./runnerData.a85d252e.js";import"./url.4814cfa2.js";import"./index.4f76cce5.js";import"./UnsavedChangesHandler.37e848b2.js";import"./ExclamationCircleOutlined.a2289dc2.js";import"./Modal.1c34dbf6.js";import"./PlusOutlined.cf52d035.js";import"./PhCheckCircle.vue.e77cdb1d.js";import"./PhKanban.vue.c6d58121.js";import"./PhScroll.vue.94f944fc.js";import"./PhWebhooksLogo.vue.77148bb9.js";(function(){try{var i=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(i._sentryDebugIds=i._sentryDebugIds||{},i._sentryDebugIds[e]="72db3390-e132-4972-b79b-2fc3fa000d79",i._sentryDebugIdIdentifier="sentry-dbid-72db3390-e132-4972-b79b-2fc3fa000d79")}catch{}})();const ne=["width","height","fill","transform"],ie={key:0},ce=_("path",{d:"M208,76H180V56A52,52,0,0,0,76,56V76H48A20,20,0,0,0,28,96V208a20,20,0,0,0,20,20H208a20,20,0,0,0,20-20V96A20,20,0,0,0,208,76ZM100,56a28,28,0,0,1,56,0V76H100ZM204,204H52V100H204Z"},null,-1),ue=[ce],de={key:1},pe=_("path",{d:"M216,96V208a8,8,0,0,1-8,8H48a8,8,0,0,1-8-8V96a8,8,0,0,1,8-8H208A8,8,0,0,1,216,96Z",opacity:"0.2"},null,-1),he=_("path",{d:"M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80ZM96,56a32,32,0,0,1,64,0V80H96ZM208,208H48V96H208V208Z"},null,-1),ge=[pe,he],fe={key:2},me=_("path",{d:"M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80ZM96,56a32,32,0,0,1,64,0V80H96Z"},null,-1),ye=[me],ve={key:3},be=_("path",{d:"M208,82H174V56a46,46,0,0,0-92,0V82H48A14,14,0,0,0,34,96V208a14,14,0,0,0,14,14H208a14,14,0,0,0,14-14V96A14,14,0,0,0,208,82ZM94,56a34,34,0,0,1,68,0V82H94ZM210,208a2,2,0,0,1-2,2H48a2,2,0,0,1-2-2V96a2,2,0,0,1,2-2H208a2,2,0,0,1,2,2Z"},null,-1),Ce=[be],_e={key:4},we=_("path",{d:"M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80ZM96,56a32,32,0,0,1,64,0V80H96ZM208,208H48V96H208V208Z"},null,-1),Ve=[we],Ae={key:5},He=_("path",{d:"M208,84H172V56a44,44,0,0,0-88,0V84H48A12,12,0,0,0,36,96V208a12,12,0,0,0,12,12H208a12,12,0,0,0,12-12V96A12,12,0,0,0,208,84ZM92,56a36,36,0,0,1,72,0V84H92ZM212,208a4,4,0,0,1-4,4H48a4,4,0,0,1-4-4V96a4,4,0,0,1,4-4H208a4,4,0,0,1,4,4Z"},null,-1),ke=[He],Pe={name:"PhLockSimple"},Re=C({...Pe,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(i){const e=i,s=V("weight","regular"),p=V("size","1em"),g=V("color","currentColor"),f=V("mirrored",!1),r=y(()=>{var t;return(t=e.weight)!=null?t:s}),c=y(()=>{var t;return(t=e.size)!=null?t:p}),h=y(()=>{var t;return(t=e.color)!=null?t:g}),a=y(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:f?"scale(-1, 1)":void 0);return(t,d)=>(n(),m("svg",$({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:c.value,height:c.value,fill:h.value,transform:a.value},t.$attrs),[E(t.$slots,"default"),r.value==="bold"?(n(),m("g",ie,ue)):r.value==="duotone"?(n(),m("g",de,ge)):r.value==="fill"?(n(),m("g",fe,ye)):r.value==="light"?(n(),m("g",ve,Ce)):r.value==="regular"?(n(),m("g",_e,Ve)):r.value==="thin"?(n(),m("g",Ae,ke)):k("",!0)],16,ne))}});class M{constructor(e){S(this,"record");this.record=D.from(e)}get id(){return this.record.get("id")}get type(){return this.record.get("type")}get title(){return this.record.get("title")}get isPublic(){return this.record.get("is_public")}set isPublic(e){e&&this.record.set("required_roles",[]),this.record.set("is_public",e)}get requiredRoles(){return this.record.get("required_roles")}set requiredRoles(e){e.length!==0&&this.record.set("is_public",!1),this.record.set("required_roles",e)}makePublic(){this.isPublic=!0}makeProtected(){this.isPublic=!1,this.requiredRoles=[]}require(e){e.length!==0&&(this.isPublic=!1),this.requiredRoles=e}get visibility(){return this.isPublic?"public":"private"}hasChanges(){return this.record.hasChanges("is_public")||this.record.hasChangesDeep("required_roles")}get changes(){return this.record.changes}get initialState(){return this.record.initialState}toUpdateDTO(){return{id:this.id,is_public:this.isPublic,required_roles:this.requiredRoles}}commit(){this.record.commit()}static from(e){return new M(e)}}class Me{constructor(e=B){this.fetch=e}async list(){return(await(await this.fetch("/_editor/api/access-control",{method:"GET",headers:{"Content-Type":"application/json"}})).json()).map(M.from)}async update(e){const s=e.reduce((g,f)=>(f.hasChanges()&&g.push({id:f.id,...f.changes}),g),[]);return await(await fetch("/_editor/api/access-control",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json()}}const Se=C({__name:"RoleSelector",props:{value:{},roleOptions:{},disabled:{type:Boolean}},emits:["update:value"],setup(i,{emit:e}){const s=i,p=()=>{var h,a;if(!((h=A.asyncComputed.result.value)!=null&&h.logged))return;const c=(a=A.asyncComputed.result.value)==null?void 0:a.info.projectId;window.open(`https://cloud.abstra.io/projects/${c}/access-control?selected-panel=roles`,"__roles")},g=c=>{e("update:value",c)},f=y(()=>s.disabled?"":"All users listed in the cloud"),r=C({props:{vnodes:{type:Object,required:!0}},render(){return this.vnodes}});return(c,h)=>(n(),b(o(O),{value:c.value,mode:"multiple",placeholder:f.value,disabled:c.disabled,"onUpdate:value":g},{dropdownRender:l(({menuNode:a})=>{var t;return[u(o(r),{vnodes:a},null,8,["vnodes"]),u(o(se),{style:{margin:"4px 0"}}),(t=o(A).asyncComputed.result.value)!=null&&t.logged?(n(),b(o(N),{key:0,type:"default",style:{width:"100%"},onClick:p},{icon:l(()=>[u(o(oe))]),default:l(()=>[v(" Create a new role ")]),_:1})):k("",!0)]}),default:l(()=>[(n(!0),m(H,null,P(c.roleOptions,a=>(n(),b(o(U),{key:a,value:a},{default:l(()=>[v(R(a),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder","disabled"]))}}),Ze=C({__name:"AccessControlItem",props:{accessControl:{},roles:{}},emits:["update:access-control"],setup(i,{emit:e}){const s=i,p=y(()=>s.roles.map(r=>r.name)),g=r=>{r?s.accessControl.makePublic():s.accessControl.makeProtected(),e("update:access-control",s.accessControl)},f=r=>{s.accessControl.require(r),r.length!==0&&(s.accessControl.isPublic=!1),e("update:access-control",s.accessControl)};return(r,c)=>(n(),b(o(w),{justify:"space-between",align:"center",gap:"small"},{default:l(()=>[(n(),b(L(o(re)(r.accessControl.type)),{style:{"flex-shrink":"0",width:"22px",height:"18px"}})),u(o(F),{style:{width:"300px","text-overflow":"ellipsis",overflow:"hidden","white-space":"nowrap"}},{default:l(()=>[u(o(z),{title:r.accessControl.title,placement:"left",open:r.accessControl.title.length>36?void 0:!1},{default:l(()=>[v(R(r.accessControl.title),1)]),_:1},8,["title","open"])]),_:1}),u(o(w),{gap:"large",align:"center"},{default:l(()=>[u(Se,{disabled:r.accessControl.visibility==="public",style:{width:"320px"},value:r.accessControl.requiredRoles||[],"role-options":p.value||[],"onUpdate:value":c[0]||(c[0]=h=>f(h))},null,8,["disabled","value","role-options"]),u(o(G),{value:r.accessControl.visibility},{default:l(()=>[u(o(Z),{value:"public",onChange:c[1]||(c[1]=h=>g(!0))},{default:l(()=>[u(o(w),{align:"center",gap:"small"},{default:l(()=>[v(" Public "),u(o(te),{size:14})]),_:1})]),_:1}),u(o(Z),{value:"private",onChange:c[2]||(c[2]=h=>g(!1))},{default:l(()=>[u(o(w),{align:"center",gap:"small"},{default:l(()=>[v(" Private "),u(o(Re),{size:14})]),_:1})]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}))}}),qe=C({__name:"DanglingRolesAlert",props:{danglingRoles:{}},setup(i){return(e,s)=>(n(),b(o(le),{type:"warning","show-icon":"",closable:"",style:{margin:"5px"}},{description:l(()=>[u(o(W),null,{default:l(()=>[v("The following roles are not defined in the Cloud Console:")]),_:1}),(n(!0),m(H,null,P(e.danglingRoles,p=>(n(),b(o(ae),{key:p,style:{margin:"2px"},color:"red"},{default:l(()=>[v(R(p),1)]),_:2},1024))),128))]),_:1}))}}),je=C({__name:"View",props:{accessControls:{},roles:{},loading:{type:Boolean}},emits:["update:access-controls","save"],setup(i,{emit:e}){const s=i,p=a=>{const t=s.accessControls.findIndex(d=>d.id===a.id);t!==-1&&(s.accessControls[t]=a,e("update:access-controls",[...s.accessControls]))},g=y(()=>{var a;return((a=s.accessControls)==null?void 0:a.filter(t=>t.hasChanges()))||[]}),f=y(()=>g.value.length>0),c={save:async()=>{e("save")},hasChanges:()=>f.value},h=y(()=>{const a=[...new Set(s.accessControls.flatMap(d=>d.requiredRoles)||[])],t=s.roles.map(d=>d.name)||[];return(a==null?void 0:a.filter(d=>!t.includes(d)))||[]});return(a,t)=>(n(),m(H,null,[!a.loading&&h.value.length>0?(n(),b(qe,{key:0,"dangling-roles":h.value},null,8,["dangling-roles"])):k("",!0),u(ee,{model:c}),u(o(w),{vertical:"",gap:"small",style:{"margin-top":"10px"}},{default:l(()=>[(n(!0),m(H,null,P(a.accessControls,d=>(n(),b(o(w),{key:d.id},{default:l(()=>[u(Ze,{"access-control":d,roles:a.roles,"onUpdate:accessControl":p},null,8,["access-control","roles"])]),_:2},1024))),128))]),_:1})],64))}}),ut=C({__name:"AccessControlEditor",setup(i){const e=new Me,s=y(()=>{const t=A.asyncComputed.result.value,d=t!=null&&t.logged?t==null?void 0:t.info.projectId:"";return d?`https://cloud.abstra.io/projects/${d}/access-control?selected-panel=users`:""}),{result:p,refetch:g}=q(async()=>await e.list()),f=y(()=>{var t;return((t=p.value)==null?void 0:t.filter(d=>d.hasChanges()))||[]}),r=async()=>{await e.update(f.value),await g()},c=new Q,{result:h,loading:a}=q(()=>c.list(100,0));return(t,d)=>(n(),b(x,null,{default:l(()=>[u(o(Y),null,{default:l(()=>[v("Access Control")]),_:1}),u(o(X),null,{default:l(()=>[v(" Configure the security level of your application. You can define which pages are accessible to "),u(o(J),{href:s.value,target:"_users"},{default:l(()=>[v("signed-in users")]),_:1},8,["href"]),v(", which pages are accessible to users with specific roles, and which pages are accessible to everyone. ")]),_:1}),o(p)?(n(),b(je,{key:0,"access-controls":o(p),"onUpdate:accessControls":d[0]||(d[0]=j=>K(p)?p.value=j:null),roles:o(h)||[],loading:o(a),onSave:r},null,8,["access-controls","roles","loading"])):k("",!0)]),_:1}))}});export{ut as default};
//# sourceMappingURL=AccessControlEditor.523d28de.js.map
