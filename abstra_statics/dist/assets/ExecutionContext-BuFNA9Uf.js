import{C as T}from"./router-4Ozurcur.js";import{a as U,i as $,c as P,b as h,e as u,f as ut,g as b,h as A,m as dt,d as gt,r as C,P as M,a9 as ft,H as N,p as S,u as d,v as F,w,M as G,W as at,K as pt,U as z,c0 as ht,ak as W,S as L,aN as ot,j as _,A as q,ae as v,E as mt,bB as yt,bo as O}from"./jwt-decode.esm-__p21E41.js";import{a as xt}from"./build-CIPyM5Tj.js";import{c as nt}from"./string-BrI17bt_.js";import"./tables-CoT-R-se.js";import{u as vt}from"./polling-DG7KoHoZ.js";import{t as wt}from"./ant-design-DWOJ1CpG.js";import{I as et}from"./PhCopy.vue-C05RxQRF.js";import{S as bt}from"./index-B-9LDV4d.js";(function(){try{var n=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[t]="ffbb2c05-33e0-458d-a4a1-418957873810",n._sentryDebugIdIdentifier="sentry-dbid-ffbb2c05-33e0-458d-a4a1-418957873810")}catch{}})();const At=["width","height","fill","transform"],_t={key:0},kt=A("path",{d:"M72,104a16,16,0,1,1,16,16A16,16,0,0,1,72,104Zm96,16a16,16,0,1,0-16-16A16,16,0,0,0,168,120Zm68-40V192a36,36,0,0,1-36,36H56a36,36,0,0,1-36-36V80A36,36,0,0,1,56,44h60V16a12,12,0,0,1,24,0V44h60A36,36,0,0,1,236,80Zm-24,0a12,12,0,0,0-12-12H56A12,12,0,0,0,44,80V192a12,12,0,0,0,12,12H200a12,12,0,0,0,12-12Zm-12,82a30,30,0,0,1-30,30H86a30,30,0,0,1,0-60h84A30,30,0,0,1,200,162Zm-80-6v12h16V156ZM86,168H96V156H86a6,6,0,0,0,0,12Zm90-6a6,6,0,0,0-6-6H160v12h10A6,6,0,0,0,176,162Z"},null,-1),Ht=[kt],St={key:1},Zt=A("path",{d:"M200,56H56A24,24,0,0,0,32,80V192a24,24,0,0,0,24,24H200a24,24,0,0,0,24-24V80A24,24,0,0,0,200,56ZM164,184H92a20,20,0,0,1,0-40h72a20,20,0,0,1,0,40Z",opacity:"0.2"},null,-1),Et=A("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Zm4,28H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24Z"},null,-1),Ct=[Zt,Et],Vt={key:2},It=A("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48ZM172,96a12,12,0,1,1-12,12A12,12,0,0,1,172,96ZM96,184H80a16,16,0,0,1,0-32H96ZM84,120a12,12,0,1,1,12-12A12,12,0,0,1,84,120Zm60,64H112V152h32Zm32,0H160V152h16a16,16,0,0,1,0,32Z"},null,-1),Pt=[It],Dt={key:3},jt=A("path",{d:"M200,50H134V16a6,6,0,0,0-12,0V50H56A30,30,0,0,0,26,80V192a30,30,0,0,0,30,30H200a30,30,0,0,0,30-30V80A30,30,0,0,0,200,50Zm18,142a18,18,0,0,1-18,18H56a18,18,0,0,1-18-18V80A18,18,0,0,1,56,62H200a18,18,0,0,1,18,18ZM74,108a10,10,0,1,1,10,10A10,10,0,0,1,74,108Zm88,0a10,10,0,1,1,10,10A10,10,0,0,1,162,108Zm2,30H92a26,26,0,0,0,0,52h72a26,26,0,0,0,0-52Zm-22,12v28H114V150ZM78,164a14,14,0,0,1,14-14h10v28H92A14,14,0,0,1,78,164Zm86,14H154V150h10a14,14,0,0,1,0,28Z"},null,-1),Tt=[jt],$t={key:4},Mt=A("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16Zm-52-56H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Z"},null,-1),Ot=[Mt],zt={key:5},Lt=A("path",{d:"M200,52H132V16a4,4,0,0,0-8,0V52H56A28,28,0,0,0,28,80V192a28,28,0,0,0,28,28H200a28,28,0,0,0,28-28V80A28,28,0,0,0,200,52Zm20,140a20,20,0,0,1-20,20H56a20,20,0,0,1-20-20V80A20,20,0,0,1,56,60H200a20,20,0,0,1,20,20ZM76,108a8,8,0,1,1,8,8A8,8,0,0,1,76,108Zm88,0a8,8,0,1,1,8,8A8,8,0,0,1,164,108Zm0,32H92a24,24,0,0,0,0,48h72a24,24,0,0,0,0-48Zm-20,8v32H112V148ZM76,164a16,16,0,0,1,16-16h12v32H92A16,16,0,0,1,76,164Zm88,16H152V148h12a16,16,0,0,1,0,32Z"},null,-1),Rt=[Lt],Bt={name:"PhRobot"},Nt=U({...Bt,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(n){const t=n,a=$("weight","regular"),s=$("size","1em"),i=$("color","currentColor"),o=$("mirrored",!1),l=P(()=>t.weight??a),r=P(()=>t.size??s),m=P(()=>t.color??i),k=P(()=>t.mirrored!==void 0?t.mirrored?"scale(-1, 1)":void 0:o?"scale(-1, 1)":void 0);return(c,Z)=>(u(),h("svg",dt({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:r.value,height:r.value,fill:m.value,transform:k.value},c.$attrs),[ut(c.$slots,"default"),l.value==="bold"?(u(),h("g",_t,Ht)):l.value==="duotone"?(u(),h("g",St,Ct)):l.value==="fill"?(u(),h("g",Vt,Pt)):l.value==="light"?(u(),h("g",Dt,Tt)):l.value==="regular"?(u(),h("g",$t,Ot)):l.value==="thin"?(u(),h("g",zt,Rt)):b("",!0)],16,At))}}),qt=["running","lock-failed","failed","finished","abandoned"];class R{constructor(t){this.dto=t}static from(t){return new R(t)}get entries(){return this.dto.sort((t,a)=>t.sequence-a.sequence).filter(t=>t.event!=="form-message")}}class B{constructor(t){this.dto=t}static from(t){return new B(t)}get id(){return this.dto.id}get shortId(){return this.dto.id.slice(0,8)}get createdAt(){return new Date(this.dto.createdAt)}get updatedAt(){return new Date(this.dto.updatedAt)}get status(){return this.dto.status}get context(){return this.dto.context}get buildId(){return this.dto.buildId??""}get stageId(){return this.dto.stageId}get duration_seconds(){return`${(this.updatedAt.getTime()-this.createdAt.getTime())/1e3} s`}get stageRunId(){return this.dto.stageRunId}get projectId(){return this.dto.projectId}}class le{async list({projectId:t,...a}){const s={...a,offset:a.offset?.toString(),limit:a.limit?.toString()};Object.keys(s).forEach(o=>s[o]===void 0&&delete s[o]);const i=await T.get(`projects/${t}/executions`,s);return{executions:i.executions.map(o=>B.from(o)),totalCount:i.totalCount}}async fetchLogs(t,a,s){const i={};s?.limit!==void 0&&(i.limit=s.limit.toString()),s?.offset!==void 0&&(i.offset=s.offset.toString());const o=Object.keys(i).length>0?`?${new URLSearchParams(i).toString()}`:"",l=await T.get(`projects/${t}/executions/${a}/logs${o}`);return{logs:R.from(l.logs),totalCount:l.totalCount}}async fetchThreadData(t,a){return(await T.get(`projects/${t}/executions/${a}/thread-data`)).response}async get(t,a){const{executions:s}=await this.list({projectId:t,limit:1,search:a}),i=s.find(o=>o.id===a);if(i)return i;throw new Error(`Execution ${a} not found`)}async getExecutionTasks(t,a){return await T.get(`projects/${t}/executions/${a}/tasks`)}async fetchStages(){throw new Error("Method not implemented.")}async clear(){throw new Error("Method not implemented.")}}class ce{async list(t){const a={...t,offset:t.offset?.toString(),limit:t.limit?.toString()};Object.keys(a).forEach(r=>a[r]===void 0&&delete a[r]);const s=Object.fromEntries(Object.entries(a??{}).filter(([,r])=>r!=null)),i=Object.keys(s).length>0?`?${new URLSearchParams(s).toString()}`:"",l=await(await fetch(`/_editor/api/executions${i}`)).json();return{executions:l.executions.map(r=>B.from(r)),totalCount:l.totalCount}}async fetchLogs(t,a,s){const o=await(await fetch(`/_editor/api/logs/${a}`)).json();return{logs:R.from(o),totalCount:o.length}}async fetchThreadData(){return{}}async get(t,a){const{executions:s}=await this.list({limit:1,search:a}),i=s.find(o=>o.id===a);if(i)return i;throw new Error(`Execution ${a} not found`)}async getExecutionTasks(t,a){return await(await fetch(`/_editor/api/executions/${a}/tasks`)).json()}async fetchStages(){return await(await fetch("/_editor/api/executions/stages")).json()}async clear(){await fetch("/_editor/api/executions/clear",{method:"DELETE"})}}const D=300,ue=gt("logs",()=>{const n=C(null),t=C(null),a=C(""),s=C(!1),i=C(),o=M({openedExecutionIds:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],executionData:{}}),l=M({currentIndex:1,pageSize:10,totalCount:0}),r=M({dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0}),m=M({builds:[],stages:[],statuses:qt.map(e=>({label:nt(e),value:e}))}),k=vt({task:()=>X(),interval:1e4}),c=async e=>{n.value=e.executionRepository,t.value=e.buildRepository,a.value=e.projectId,s.value=e.pool??!1,i.value=e.onFilterChange,Object.assign(r,e.filters||{}),Object.assign(l,e.pagination||{}),e.openedExecutionId&&(o.openedExecutionIds=[e.openedExecutionId]),await Promise.all([x(),J()]),Q(),s.value&&k.startPolling()},Z=()=>{k.endPolling()},x=async()=>{if(n.value){o.loadingExecutions=!0;try{const{executions:e,totalCount:f}=await n.value.list({projectId:a.value,buildId:r.buildId,status:r.status,limit:l.pageSize,offset:(l.currentIndex-1)*l.pageSize,stageId:r.stageId,startDate:r.dateRange?.[0]?.toISOString(),endDate:r.dateRange?.[1]?.toISOString(),search:r.search});o.executions=e,l.totalCount=f}finally{o.loadingExecutions=!1}}},H=async()=>{if(!t.value){m.builds=[];return}const f=(await t.value.list(a.value)).map(g=>({label:`[${g.id.slice(0,8)}] ${g.createdAt.toLocaleString()} ${g.latest?"(Latest)":""}`,value:g.id}));m.builds=f},V=async()=>{if(!n.value)return;if(!t.value){const y=(await n.value.fetchStages()).map(E=>({label:E.title,value:E.id}));m.stages=y??[];return}const e=r.buildId??(m.builds.length>0?m.builds[0].value:void 0);if(!e){console.warn("No buildId available for fetching stage options"),m.stages=[];return}const g=(await xt.get(e))?.runtimes.map(p=>({label:p.title,value:p.id}));m.stages=g??[]},J=async()=>{try{await H(),await V()}catch(e){console.error("Error fetching options:",e)}},I=async(e,f)=>{if(!n.value)return;const g=o.executionData[e],p=f||{limit:D,offset:0},[y,E,j]=await Promise.all([n.value.fetchLogs(a.value,e,p),n.value.fetchThreadData(a.value,e),n.value.getExecutionTasks(a.value,e)]),ct={currentIndex:1,pageSize:D,totalCount:y.totalCount,loading:!1};o.executionData[e]={logs:y.logs,threadData:E,tasks:{triggerTask:j.triggerTask?{type:j.triggerTask.type,payload:j.triggerTask.payload}:null,sentTasks:j.sentTasks.map(tt=>({type:tt.type,payload:tt.payload}))},logsPagination:g?.logsPagination||ct},o.executionData[e].logsPagination&&(o.executionData[e].logsPagination.totalCount=y.totalCount,o.executionData[e].logsPagination.loading=!1)},Q=()=>{o.openedExecutionIds.forEach(async e=>{o.executionData[e]||await I(e,{limit:D,offset:0})})},X=async()=>{o.openedExecutionIds.map(e=>{const f=o.executions.find(p=>p.id===e);if(!f||f.status!=="running")return;const g=o.executionData[e];if(g?.logsPagination){const{currentIndex:p,pageSize:y}=g.logsPagination,E=(p-1)*y;return I(e,{limit:y,offset:E})}else return I(e,{limit:D,offset:0})})},Y=()=>{o.waitingDebounce=!0,l.currentIndex=1,st(),i.value&&i.value(r)},st=ft.debounce(async()=>{await x(),o.waitingDebounce=!1},500),it=async e=>{let f=o.executions;return e&&(f=f.filter(p=>p.stageId===e)),f.length===0?null:f.reduce((p,y)=>p.createdAt>y.createdAt?p:y).id},K=async(e,f)=>{const g=o.executionData[e];if(!g?.logsPagination)return;const{pageSize:p}=g.logsPagination;g.logsPagination.loading=!0,g.logsPagination.currentIndex=f;const y=(f-1)*p;await I(e,{limit:p,offset:y})},rt=(e,f)=>{const g=o.executionData[e];g?.logsPagination&&(g.logsPagination.pageSize=f,g.logsPagination.currentIndex=1,K(e,1))},lt=async()=>{n.value&&(await n.value.clear(),await x())};return N(()=>r.buildId,()=>{V()}),N(r,()=>{o.openedExecutionIds=[],Y()}),N([()=>l.currentIndex,()=>l.pageSize],()=>{o.openedExecutionIds=[],x()}),{state:P(()=>({currentPage:o,pagination:l,filters:r,filterOptions:m})),currentPage:o,pagination:l,filters:r,filterOptions:m,init:c,teardown:Z,fetchPage:x,fetchBuildOptions:H,fetchStageOptions:V,fetchOptions:J,fetchExecutionDetails:I,fetchEmptyLogs:Q,refetch:X,handleFilterChange:Y,getNewestExecutionId:it,fetchExecutionLogsPage:K,setExecutionLogsPageSize:rt,clear:lt,polling:k}}),Ft={key:0,class:"cli"},Gt={key:0},Wt=U({__name:"LogContainer",props:{logs:{},pagination:{}},emits:["page-change"],setup(n){return(t,a)=>(u(),S(d(F),{vertical:"",gap:"small"},{default:w(()=>[n.logs.entries.length?(u(),h("div",Ft,[(u(!0),h(G,null,at(n.logs.entries,s=>(u(),h("p",{key:s.createdAt,style:pt({margin:0,"white-space":"pre-wrap",color:s.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},[s.payload.text?(u(),h("span",Gt,z(s.payload.text.trim()),1)):b("",!0)],4))),128))])):b("",!0),n.pagination?(u(),S(d(F),{key:1,vertical:"",gap:"small",align:"end"},{default:w(()=>[n.pagination.totalCount>d(D)?(u(),S(d(ht),{key:0,current:n.pagination.currentIndex,"page-size":n.pagination.pageSize,total:n.pagination.totalCount,"show-size-changer":!1,"show-quick-jumper":!1,size:"small",onChange:a[0]||(a[0]=s=>t.$emit("page-change",s))},null,8,["current","page-size","total"])):b("",!0)]),_:1})):n.logs.entries.length?b("",!0):(u(),S(d(W),{key:2,type:"secondary"},{default:w(()=>[...a[1]||(a[1]=[L("Empty",-1)])]),_:1}))]),_:1}))}}),de=ot(Wt,[["__scopeId","data-v-ee1d10cd"]]),Ut={key:0},Jt=["onClick"],Qt=["onClick"],Xt=U({__name:"ExecutionContext",props:{data:{},showFixWithAi:{type:Boolean},isSmartChatIdle:{type:Boolean}},emits:["ask-ai"],setup(n,{emit:t}){const a=n,s=t,i=C(!1),o=c=>{if(c==="legacyThreadData")return v.translate("i18n_executioncontext_thread_data");const Z=nt(c);return Z.replace(/([A-Z])/g," $1").trim(),Z},l=c=>c==null?!0:Array.isArray(c)?c.length===0:typeof c=="object"?Object.keys(c).length===0:!1,r=c=>{typeof c=="object"&&c!==null&&"payload"in c?(navigator.clipboard.writeText(JSON.stringify(c.payload)),O.success({content:v.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),O.error({content:v.translate("i18n_executioncontext_no_payload")}))},m=c=>{i.value=!0,c.stopPropagation(),a.isSmartChatIdle!==!1&&(s("ask-ai"),setTimeout(()=>{i.value=!1},1e3))},k=c=>{typeof c=="object"?(navigator.clipboard.writeText(JSON.stringify(c)),O.success({content:v.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),O.error({content:v.translate("i18n_executioncontext_failed_copy_request")}))};return(c,Z)=>(u(),h(G,null,[_(d(F),{justify:"end"},{default:w(()=>[_(d(q),{title:n.isSmartChatIdle?"":d(v).translate("i18n_executioncontext_wait_or_stop"),placement:"left"},{default:w(()=>[n.showFixWithAi?(u(),h("div",{key:0,class:mt(["ask-to-ai",{disabled:!n.isSmartChatIdle||i.value}]),onClick:m},[L(z(d(v).translate("i18n_executioncontext_fix_with_ai"))+" ",1),_(d(Nt),{size:16})],2)):b("",!0)]),_:1},8,["title"])]),_:1}),_(d(bt),{direction:"vertical",style:{"border-radius":"5px",padding:"10px",color:"#fff",width:"100%","font-family":"monospace","max-height":"600px",overflow:"auto",border:"1px solid #e8e8e8"}},{default:w(()=>[Object.keys(n.data).length?(u(!0),h(G,{key:1},at(Object.entries(n.data),([x,H])=>(u(),h("div",{key:x,class:"tree"},[x!=="legacyThreadData"||!l(H)?(u(),h("div",Ut,[_(d(W),{strong:""},{default:w(()=>[L(z(o(x)),1)]),_:2},1024),x==="request"?(u(),S(d(q),{key:0,title:d(v).translate("i18n_executioncontext_copy_request_tooltip")},{default:w(()=>[A("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:V=>k(H)},[_(d(et))],8,Jt)]),_:2},1032,["title"])):b("",!0),x==="triggerTask"?(u(),S(d(q),{key:1,title:d(v).translate("i18n_executioncontext_copy_payload_tooltip")},{default:w(()=>[A("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:V=>r(H)},[_(d(et))],8,Qt)]),_:2},1032,["title"])):b("",!0),_(d(yt),{"tree-data":d(wt)(H),selectable:!1},null,8,["tree-data"])])):b("",!0)]))),128)):(u(),S(d(W),{key:0,type:"secondary"},{default:w(()=>[L(z(d(v).translate("i18n_executioncontext_empty")),1)]),_:1}))]),_:1})],64))}}),ge=ot(Xt,[["__scopeId","data-v-629427b0"]]);export{ge as E,de as L,le as R,ce as a,ue as u};
//# sourceMappingURL=ExecutionContext-BuFNA9Uf.js.map
