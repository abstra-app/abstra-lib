import{d as j,r as N,G as q,F as te,a as O,b as u,et as D,f as t,w as a,b8 as R,aA as k,eB as z,ev as A,e as g,u as e,cA as ae,bZ as E,cG as ne,eA as V,c as w,eF as ee,bS as L,ad as Q,cE as le,t as Z,H as pe,ey as oe,eC as se,eD as ue,ez as me,eE as fe}from"./outputWidgets.9d44d9f3.js";import{B as ve}from"./BaseLayout.d36a8dac.js";import{p as ie,T as be}from"./tables.1fb855d6.js";import{a as re}from"./asyncComputed.99132b68.js";import{p as P}from"./popupNotifcation.de41eb39.js";import{A as de}from"./index.eaa93dcb.js";import{A as K}from"./index.a18b3bba.js";import{F as J}from"./Form.97529076.js";import{A as T}from"./Title.2f009ad9.js";import{A as W}from"./index.d1e2f9a9.js";import"./router.b1f71dc3.js";import"./columns.9f935597.js";import{A as F}from"./index.2266a3cb.js";import{Q as ye,w as _e,R as ge}from"./icons.6774e95a.js";import{L as he}from"./CircularLoading.24757374.js";import{P as ke}from"./project.e28f99fa.js";import{O as Ce}from"./organization.330782d9.js";import{T as we,A as H}from"./TabPane.4f8de0bb.js";import{B as De,a as $e,c as Ie}from"./index.6923ee77.js";import"./gateway.aff02c91.js";import"./activeRecord.cde63aa9.js";import"./pubsub.36fbfdaf.js";import"./string.75c8cdd4.js";import"./transButton.41dbfda3.js";import"./isNumeric.75337b1e.js";import"./Text.0ad03b29.js";import"./index.a9ce4fb3.js";import"./index.cf4c23b9.js";(function(){try{var f=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},m=new Error().stack;m&&(f._sentryDebugIds=f._sentryDebugIds||{},f._sentryDebugIds[m]="fdbb0186-682f-43fa-8272-e0f48f2db623",f._sentryDebugIdIdentifier="sentry-dbid-fdbb0186-682f-43fa-8272-e0f48f2db623")}catch{}})();const Ae={class:"table-data",style:{width:"calc(100% - 80px)"}},Se={key:1},Te=["onClick"],Ue=g("a",null,"Delete",-1),Ee=j({__name:"TableData",props:{table:{}},setup(f){var d;const m=f,o=N(1),n=N(5),$=q(()=>{var b,y;return{total:(y=(b=c.value)==null?void 0:b.total)!=null?y:0,current:o.value,pageSize:n.value,onChange:async(U,B)=>{o.value=U,n.value=B,await C()}}}),{result:c,loading:v,refetch:C}=re(()=>m.table.select({},n.value,o.value*n.value)),p=q(()=>{var y;return[...(y=m.table)==null?void 0:y.getColumns().map(U=>({title:U.name,dataIndex:U.name})),{title:"Actions",key:"action",fixed:"right",width:100,align:"center"}]}),s=q(()=>{var b;return((b=c.value)==null?void 0:b.rows.map(y=>({key:y.id,...y})))||[]}),S=N(!1),r=N({}),_=()=>{S.value=!0},I=()=>{r.value={},S.value=!1};let x=te((d=m.table)==null?void 0:d.getUnprotectedColumns().reduce((b,y)=>({...b,[y.name]:""}),{}));async function i(){if(!(!m.table||!x))try{r.value.id?await m.table.updateRow(r.value.id,r.value):await m.table.insertRow(r.value),r.value={},C(),I()}catch(b){b instanceof Error&&P("Database error",b.message)}}const l=async b=>{if(!(!c.value||!c.value.rows.find(y=>y.id===b)))try{await m.table.deleteRow(b),C()}catch(y){y instanceof Error&&P("Database error",y.message)}},h=b=>{var y;r.value=ee.exports.pick(ee.exports.cloneDeep((y=s.value)==null?void 0:y.filter(U=>b===U.key)[0]),m.table.getColumns().map(U=>U.name)),_()};return(b,y)=>{const U=O("ant-input");return u(),D("div",Ae,[t(e(ne),{columns:p.value,"data-source":s.value,pagination:$.value,bordered:"",loading:e(v),scroll:{x:2e3,y:720}},{bodyCell:a(({column:B,text:M,record:Y})=>[p.value.map(G=>G.title).includes(B.dataIndex)?(u(),D(R,{key:0},[k(z(M),1)],64)):A("",!0),B.key==="action"?(u(),D("div",Se,[g("span",null,[g("a",{onClick:G=>h(Y.id)},"Edit",8,Te)]),t(e(de),{type:"vertical"}),t(e(ae),{title:"Sure to delete?",onConfirm:G=>l(Y.id)},{default:a(()=>[Ue]),_:2},1032,["onConfirm"])])):A("",!0)]),footer:a(()=>[t(e(E),{type:"primary",onClick:_},{default:a(()=>[k("+ Add New Data")]),_:1})]),_:1},8,["columns","data-source","pagination","loading"]),t(e(W),{title:"Data",width:720,open:S.value,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:I},{extra:a(()=>[t(e(K),null,{default:a(()=>[t(e(E),{onClick:I},{default:a(()=>[k("Cancel")]),_:1}),t(e(E),{type:"primary",onClick:i},{default:a(()=>[k("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(J),{model:r.value,layout:"vertical"},{default:a(()=>[(u(!0),D(R,null,V(b.table.getUnprotectedColumns(),B=>(u(),w(e(T),{key:B.id,label:B.name},{default:a(()=>[r.value?(u(),w(U,{key:0,value:r.value[B.name],"onUpdate:value":M=>r.value[B.name]=M},null,8,["value","onUpdate:value"])):A("",!0)]),_:2},1032,["label"]))),128))]),_:1},8,["model"])]),_:1},8,["open"])])}}});const xe=j({__name:"NewColumn",props:{open:{type:Boolean},table:{}},emits:["created","cancel"],setup(f,{emit:m}){const o=f,n=N({name:"",type:"varchar",nullable:!0,unique:!1}),$=()=>{n.value={name:"",type:"varchar",nullable:!0,unique:!1}};function c(){m("cancel")}async function v(){if(!o.table||!n.value.name||!n.value.type)return;const{success:C,error:p}=await o.table.addColumn(n.value);C||P("Database error",p),$(),m("created")}return(C,p)=>(u(),w(e(W),{title:"New column",width:720,open:o.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:c},{extra:a(()=>[t(e(K),null,{default:a(()=>[t(e(E),{onClick:c},{default:a(()=>[k("Cancel")]),_:1}),t(e(E),{type:"primary",onClick:v},{default:a(()=>[k("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(J),{model:n.value,layout:"vertical"},{default:a(()=>[t(e(T),{key:"name",label:"Name"},{default:a(()=>[t(e(L),{value:n.value.name,"onUpdate:value":p[0]||(p[0]=s=>n.value.name=s)},null,8,["value"])]),_:1}),t(e(T),{key:"type",label:"Type"},{default:a(()=>[t(e(Q),{value:n.value.type,"onUpdate:value":p[1]||(p[1]=s=>n.value.type=s),"default-active-first-option":""},{default:a(()=>[(u(!0),D(R,null,V(e(ie),s=>(u(),w(e(le),{key:s,value:s},{default:a(()=>[k(z(s),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),t(e(T),{key:"nullable",label:"Nullable"},{default:a(()=>[t(e(F),{checked:n.value.nullable,"onUpdate:checked":p[2]||(p[2]=s=>n.value.nullable=s)},null,8,["checked"])]),_:1}),t(e(T),{key:"unique",label:"Unique"},{default:a(()=>[t(e(F),{checked:n.value.unique,"onUpdate:checked":p[3]||(p[3]=s=>n.value.unique=s)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"]))}}),Be={class:"types-container"},Ne={class:"fullwidth-input"},qe={class:"fullwidth-input"},Re={class:"using-container"},ze={class:"fullwidth-input"},Pe=j({__name:"UpdateColumn",props:{open:{type:Boolean},table:{},column:{}},emits:["updated","cancel"],setup(f,{emit:m}){const o=f;function n(){m("cancel")}const $=()=>o.column.record.hasChangesDeep("type"),c=N({type:"default"});function v(i,l){return l==="varchar"||i==="int"&&l==="boolean"||i==="boolean"&&l==="int"}const C=()=>{s.value&&(c.value={type:"user-defined",using:I.value,mandatory:!0})},p=q(()=>c.value.type==="default"&&v(o.column.record.initialState.type,o.column.type)),s=q(()=>!v(o.column.record.initialState.type,o.column.type));function S(i){i?c.value={type:"default"}:c.value={type:"user-defined",using:I.value,mandatory:!1}}function r(i){if(c.value.type==="default")throw new Error("Can't change using when using default casting");c.value.using=i!=null?i:""}const _=()=>s.value?!0:$()&&c.value.type==="user-defined",I=q(()=>`${o.column.record.initialState.name}::${o.column.type}`);async function x(){if(!o.column)return;const i=c.value.type==="default"?I.value:c.value.using;try{await o.column.update(i),m("updated")}catch(l){l instanceof Error&&P("Database error",l.message)}}return(i,l)=>{const h=O("icon");return u(),w(e(W),{title:"Edit column",width:720,open:o.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:n},{extra:a(()=>[t(e(K),null,{default:a(()=>[t(e(E),{onClick:n},{default:a(()=>[k("Cancel")]),_:1}),t(e(E),{type:"primary",onClick:x},{default:a(()=>[k("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(J),{model:i.column,layout:"vertical"},{default:a(()=>[t(e(T),{key:"name",label:"Name"},{default:a(()=>[t(e(L),{value:i.column.name,"onUpdate:value":l[0]||(l[0]=d=>i.column.name=d)},null,8,["value"])]),_:1}),g("div",Be,[g("span",Ne,[t(e(T),{key:"type",label:"Current Type"},{default:a(()=>[t(e(Q),{value:i.column.record.initialState.type,"onUpdate:value":l[1]||(l[1]=d=>i.column.record.initialState.type=d),"default-active-first-option":"",disabled:""},null,8,["value"])]),_:1})]),t(h,{class:"right-arrow",path:e(ye)},null,8,["path"]),g("span",qe,[t(e(T),{key:"new-type",label:"New Type"},{default:a(()=>[t(e(Q),{value:i.column.type,"onUpdate:value":l[2]||(l[2]=d=>i.column.type=d),"default-active-first-option":"",onChange:l[3]||(l[3]=d=>C())},{default:a(()=>[(u(!0),D(R,null,V(e(ie),d=>(u(),w(e(le),{key:d,value:d},{default:a(()=>[k(z(d),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})])]),g("div",Re,[$()?(u(),w(e(T),{key:"default-casting",label:"Use default casting"},{default:a(()=>[t(e(F),{checked:p.value,disabled:s.value,"onUpdate:checked":l[4]||(l[4]=d=>S(!!d))},null,8,["checked","disabled"])]),_:1})):A("",!0),g("span",ze,[$()?(u(),w(e(T),{key:"using",label:"Using"},{default:a(()=>[t(e(L),{value:c.value.type==="user-defined"?c.value.using:I.value,disabled:!_(),onInput:l[5]||(l[5]=d=>r(d.target.value))},null,8,["value","disabled"])]),_:1})):A("",!0)])]),t(e(T),{key:"nullable",label:"Nullable"},{default:a(()=>[t(e(F),{checked:i.column.nullable,"onUpdate:checked":l[6]||(l[6]=d=>i.column.nullable=d)},null,8,["checked"])]),_:1}),t(e(T),{key:"unique",label:"Unique"},{default:a(()=>[t(e(F),{checked:i.column.unique,"onUpdate:checked":l[7]||(l[7]=d=>i.column.unique=d)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])}}});const je=Z(Pe,[["__scopeId","data-v-e474c12f"]]),ce=f=>(se("data-v-4f8ba920"),f=f(),ue(),f),Fe={class:"table-settings"},Ke={key:0},Le=ce(()=>g("span",null," protected ",-1)),Oe=[Le],Ve={key:1},Me=["onClick"],Ge=ce(()=>g("a",null,"Delete",-1)),He=j({__name:"TableColumns",props:{table:{},loading:{type:Boolean}},emits:["refresh"],setup(f,{emit:m}){var i;const o=f,n=N(o.loading);pe(()=>o.loading,()=>{n.value=o.loading});const $=oe();(i=o.table)==null||i.onUpdate(()=>{var l;$.replace({name:"tableEditor",params:{tableName:(l=o.table)==null?void 0:l.name}})});const v=[...[{title:"Name",dataIndex:"name"},{title:"Type",dataIndex:"type"},{title:"Default Value",dataIndex:"default"},{title:"Nullable",dataIndex:"nullable"},{title:"Primary Key",dataIndex:"primaryKey"}],{title:"Actions",key:"action"}],C=q(()=>{var l;return(l=o.table)==null?void 0:l.getColumns().map(h=>({name:h.name,type:h.type,default:h.default,nullable:h.nullable,primaryKey:h.primaryKey,id:h.id,unique:h.unique}))});function p(){r.value={type:"idle"}}function s(){p(),n.value=!0,setTimeout(()=>{m("refresh")},500)}function S(){r.value={type:"creating"}}const r=N({type:"idle"});function _(l){var h,d;(d=(h=o.table)==null?void 0:h.getColumn(l))==null||d.delete(),n.value=!0,setTimeout(()=>{m("refresh")},500)}const I=l=>{var h,d,b;return(b=(d=(h=o.table)==null?void 0:h.getColumn(l))==null?void 0:d.protected)!=null?b:!1},x=l=>{if(!o.table)throw new Error("Table not found");r.value={type:"editing",column:o.table.getColumn(l)}};return(l,h)=>(u(),D("div",Fe,[t(e(ne),{columns:v,"data-source":C.value,bordered:"",loading:n.value,pagination:!1},{bodyCell:a(({column:d,text:b,record:y})=>[d.key!=="action"?(u(),D(R,{key:0},[k(z(b),1)],64)):(u(),D(R,{key:1},[I(y.id)?(u(),D("div",Ke,Oe)):(u(),D("div",Ve,[g("span",null,[g("a",{onClick:()=>x(y.id)},"Edit",8,Me)]),t(e(de),{type:"vertical"}),t(e(ae),{title:"Sure to delete?",onConfirm:U=>_(y.id)},{default:a(()=>[Ge]),_:2},1032,["onConfirm"])]))],64))]),footer:a(()=>[t(e(E),{type:"primary",onClick:S},{default:a(()=>[k("+ Add New Column")]),_:1})]),_:1},8,["data-source","loading"]),l.table&&r.value.type==="creating"?(u(),w(xe,{key:0,open:"",table:o.table,onClose:p,onCreated:s},null,8,["table"])):A("",!0),l.table&&r.value.type==="editing"?(u(),w(je,{key:1,column:r.value.column,open:"",table:l.table,onUpdated:s,onClose:p,onCancel:p},null,8,["column","table"])):A("",!0)]))}});const Qe=Z(He,[["__scopeId","data-v-4f8ba920"]]),X=f=>(se("data-v-06f57b7a"),f=f(),ue(),f),Ze={class:"table-settings"},Je=X(()=>g("h2",{class:"title"},"Table settings",-1)),We=X(()=>g("div",{class:"subtitle"},"Edit table metadata",-1)),Xe={key:0,class:"table-presenter"},Ye={class:"table-property-item"},et={class:"property-item"},tt={key:1},at={class:"change-warning"},nt={class:"section-title"},lt=X(()=>g("div",{class:"section-body"}," Changing the table's name can possibly result in the break of running applications. ",-1)),ot={class:"table-name-value-input"},st={key:0,class:"error"},ut=j({__name:"TableSettings",props:{table:{}},emits:["refresh"],setup(f,{emit:m}){const o=f,n=te({error:"",editing:!1,loading:!1}),$=()=>n.editing=!0,c=()=>{o.table.resetChanges(),n.editing=!1,n.error=""},v=async()=>{n.error="",n.loading=!0;try{await C()}catch(s){s instanceof Error&&(P("Database error",s.message),n.error=s.message)}n.error||(n.editing=!1),n.loading=!1},C=async()=>{if(!o.table.name){n.error="Table name cannot be empty";return}try{await o.table.save(),m("refresh")}catch(s){s instanceof Error&&(P("Database error",s.message),n.error=s.message)}},p=s=>{o.table.name=s.target.value};return(s,S)=>{var _;const r=O("icon");return u(),D("div",Ze,[Je,We,n.editing?(u(),D("div",tt,[g("div",at,[g("div",nt,[t(r,{path:e(_e),width:"12",height:"12",fill:"#D35249"},null,8,["path"]),k(" Be careful ")]),lt]),t(e(K),{direction:"vertical"},{default:a(()=>[g("div",ot,[t(e(L),{value:s.table.name,type:"text",onInput:p,onBlur:S[0]||(S[0]=I=>s.table.fixTraillingName())},null,8,["value"])]),n.error?(u(),D("div",st,[t(r,{path:e(ge),fill:"#D35249",width:"12",height:"12"},null,8,["path"]),k(" "+z(n.error),1)])):A("",!0),t(e(K),null,{default:a(()=>[t(e(E),{onClick:c},{default:a(()=>[k("Cancel")]),_:1}),t(e(E),{type:"primary",disabled:!s.table.hasChangesDeep("name"),onClick:v},{default:a(()=>[k(" Save Changes "),n.loading?(u(),w(he,{key:0,size:"16"})):A("",!0)]),_:1},8,["disabled"])]),_:1})]),_:1})])):(u(),D("div",Xe,[g("div",Ye,[g("div",et,"Name: "+z((_=s.table)==null?void 0:_.name),1)]),t(e(E),{onClick:$},{default:a(()=>[k("Edit Name")]),_:1})]))])}}});const it=Z(ut,[["__scopeId","data-v-06f57b7a"]]),zt=j({__name:"TableEditor",setup(f){const m=oe(),o=me(),n=o.params.tableId,$=o.params.projectId,c=N("data"),{result:v,loading:C,refetch:p}=re(()=>Promise.all([ke.get($).then(async r=>{const _=await Ce.get(r.organizationId);return{project:r,organization:_}}),be.get($,n)]).then(([{project:r,organization:_},I])=>fe({project:r,organization:_,table:I}))),s=q(()=>!C.value&&v.value?[{label:"My organizations",path:"/organizations"},{label:v.value.organization.name,path:`/organizations/${v.value.organization.id}`},{label:v.value.project.name,path:`/projects/${v.value.project.id}/tables`}]:void 0);function S(){m.push({name:"tables",params:{projectId:$}})}return(r,_)=>{const I=O("router-link");return u(),w(ve,null,{navbar:a(()=>{var x;return[t(e(Ie),{title:(x=e(v))==null?void 0:x.table.name,style:{padding:"5px 10px"},onBack:S},{footer:a(()=>[t(e(we),{"active-key":c.value,"onUpdate:activeKey":_[0]||(_[0]=i=>c.value=i)},{default:a(()=>[t(e(H),{key:"data",tab:"Data"}),t(e(H),{key:"columns",tab:"Columns"}),t(e(H),{key:"settings",tab:"Settings"})]),_:1},8,["active-key"])]),breadcrumb:a(()=>[s.value?(u(),w(e(De),{key:0},{default:a(()=>[(u(!0),D(R,null,V(s.value,(i,l)=>(u(),w(e($e),{key:l},{default:a(()=>[t(I,{to:i.path},{default:a(()=>[k(z(i.label),1)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1})):A("",!0)]),_:1},8,["title"])]}),content:a(()=>[e(v)&&c.value==="data"?(u(),w(Ee,{key:0,loading:e(C),table:e(v).table},null,8,["loading","table"])):A("",!0),e(v)&&c.value==="columns"?(u(),w(Qe,{key:1,table:e(v).table,loading:e(C),onRefresh:_[1]||(_[1]=x=>e(p)())},null,8,["table","loading"])):A("",!0),e(v)&&c.value==="settings"?(u(),w(it,{key:2,table:e(v).table,loading:e(C),onRefresh:_[2]||(_[2]=x=>e(p)())},null,8,["table","loading"])):A("",!0)]),_:1})}}});export{zt as default};
//# sourceMappingURL=TableEditor.51db5ddb.js.map
