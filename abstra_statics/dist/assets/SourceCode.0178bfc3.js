var Se=Object.defineProperty;var Me=(o,e,s)=>e in o?Se(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var S=(o,e,s)=>(Me(o,typeof e!="symbol"?e+"":e,s),s);import{u as se}from"./uuid.12af096b.js";import{G as fe,d as N,r as _,S as ie,H as Q,b as f,ev as w,e as p,ez as H,eE as ve,eF as ge,v as Z,eB as Ie,J as _e,a4 as me,o as ye,L as Ce,a as we,f as h,u as i,I as L,ar as g,eD as T,ex as M,ew as xe,aD as oe,eC as De,c as R,f2 as Ae,f4 as Fe,eJ as Oe,w as r,bz as Ee,F as Y,aH as U,bG as j}from"./outputWidgets.25dce6ef.js";import{D as le,E as re,F as ce,i as Re,G as We,H as Be}from"./icons.7960dc02.js";import{W as He}from"./workspaces.7774725f.js";import{l as ue}from"./NavbarControls.45b1a844.js";import"./envVars.bcc2bdd3.js";import{H as $e,J as Pe}from"./jobs.a9172a26.js";import{S as Le}from"./scripts.2ed23d77.js";import{d as Te,v as Ne,e as ze}from"./validations.6c8b31ec.js";import{A as ke}from"./Form.3655a4e5.js";import{a as de}from"./asyncComputed.a16c4c65.js";import{l as Ke,e as q,R as Ve}from"./toggleHighContrast.6a46de1e.js";import{A as pe}from"./index.fc4c597e.js";import{A as Je}from"./index.85d40d30.js";import{C as Ge}from"./Card.fb8671a8.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[e]="92b6af97-7562-4165-abe1-b99ba116aec6",o._sentryDebugIdIdentifier="sentry-dbid-92b6af97-7562-4165-abe1-b99ba116aec6")}catch{}})();class be{constructor(){S(this,"logState",fe({log:[]}));S(this,"_listeners",{})}static create(){return new be}get logs(){return this.logState.log}log(e,s){if(e.type!=="restart"&&e.log.trim()==="")return;const t=s?this.logs.find(l=>l.id===s):null;return t?Object.assign(t,e):this.logs.push({...e,id:s||se()}),this.notifyListeners(e),s}clear(){this.logState.log=[]}listen(e){const s=se();return this._listeners[s]=e,s}unlisten(e){delete this._listeners[e]}notifyListeners(e){Object.values(this._listeners).forEach(s=>s(e))}}class Ue{static async*sendMessage(e,s){var d;const l=(d=(await fetch("/_editor/api/ai/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e,runtime:s})})).body)==null?void 0:d.getReader();if(!l)throw new Error("No response body");for(;;){const b=await l.read();if(b.done)break;yield new TextDecoder().decode(b.value)}}}const je=o=>(ve("data-v-59ca7295"),o=o(),ge(),o),Ye=je(()=>p("div",{class:"text"}," Changes were made in your code. Click Restart to refresh the preview window. ",-1)),he="ignoreCodeChangesWarning",qe=N({__name:"ChangesWarning",props:{hasChanges:{type:Boolean}},setup(o){var d;const e=o,s=_((d=ie.get(he))!=null?d:!1),t=Q(()=>e.hasChanges&&!s.value),l=()=>{ie.set(he,!0),s.value=!0};return(b,m)=>(f(),w("div",{class:H(["changes-warning",{visible:t.value}])},[Ye,p("div",{class:"no-more-alert",onClick:l},"Do not show again")],2))}});const Qe=Z(qe,[["__scopeId","data-v-59ca7295"]]),Xe=o=>(ve("data-v-668f6420"),o=o(),ge(),o),Ze={class:"smart-console"},et={class:"header"},tt={class:"left"},st={class:"right"},ot={class:"changes-container"},nt=["unseen-severity"],at={class:"cli"},it={class:"left"},lt=Xe(()=>p("div",{class:"entry ai-output"}," Hello there! I'm both an output console and AI assistant. You can ask me anything. ",-1)),rt={key:1,class:"local-entry"},ct={class:"input"},ut=["pointer-events","onKeydown"],dt={class:"right"},pt=N({__name:"SmartConsole",props:{inputEnabled:{type:Boolean},formCode:{},runtime:{},logService:{}},emits:["eval-request","clear-terminal","enter"],setup(o,{expose:e,emit:s}){const t=o,l=_(""),d=_(null),b=Ie(),m=_({type:"seen"}),I=_(!1),$=()=>{E.value=E.value==="assistant"?"debugger":"assistant"};function A(c){switch(c.type){case"ai-input":return{role:"user",content:c.log};case"ai-output":return{role:"assistant",content:c.log};case"stderr":case"stdout":return{role:"user",content:c.log};case"restart":return{role:"user",content:"-- new session --"};case"files-changed":return{role:"user",content:"-- files changed --"};default:throw new Error(`Unknown log type: ${c.type}`)}}const C=Q(()=>t.logService.logs.some(c=>c.type==="files-changed"));function x(){y.value=!y.value,y.value&&(m.value={type:"seen"})}_e(b,()=>{t.logService.clear(),s("clear-terminal")});const v=_(null),E=_("assistant"),P=async c=>{var k;if(c.preventDefault(),l.value=((k=v.value)==null?void 0:k.innerText)||"",c.shiftKey){document.execCommand("insertLineBreak");return}v.value&&(v.value.innerText=""),E.value==="assistant"?await z():await F()},z=async()=>{var k,a;if(!((k=ue.asyncComputed.result.value)!=null&&k.logged))throw t.logService.log({type:"ai-output",log:"Please login to use the AI assistant."}),new Error("Please login to use the AI assistant.");if(s("enter",l.value),t.logService.log({type:"ai-input",log:l.value}),l.value="",!ue.asyncComputed.result){t.logService.log({type:"stderr",log:"Please login to use the AI assistant."});return}I.value=!0;const c={role:"user",content:(a=t.formCode)!=null?a:""};try{const n=se();let D="";const G=Ue.sendMessage([c,...t.logService.logs.map(B=>A(B)),{role:"user",content:l.value}],t.runtime);for await(const B of G)D+=B,t.logService.log({type:"ai-output",log:D},n)}catch(n){t.logService.log({type:"ai-output",log:"Sorry, I don't know how to answer that."}),console.error(n),Fe(n)}finally{I.value=!1}};e({fixJson:async(c,k)=>{t.logService.clear(),t.logService.log({type:"ai-input",log:`here is my json code:
      ${c}
      And I got this error:`}),t.logService.log({type:"stderr",log:k}),y.value=!0,m.value={type:"seen"},l.value="Can you fix this JSON?",await z()}});const F=async()=>{l.value&&(t.logService.log({type:"eval-input",log:`>>> ${l.value}`}),s("eval-request",l.value),l.value="")},ee=()=>{t.logService.clear()};t.logService.listen(async c=>{y.value||(m.value={type:"unseen",count:m.value.type==="unseen"?m.value.count+1:1,severity:c.type==="stderr"?"error":"info"}),c.type!=="restart"&&(await me(),d.value&&(d.value.scrollTop=d.value.scrollHeight))});const y=_(!1),K=_(400),u=Q(()=>({height:`${K.value}px`})),W=_(!1),te=()=>W.value=!0,V=c=>{!W.value||(K.value=document.body.clientHeight-c.clientY)},J=()=>W.value=!1;return ye(()=>{document.addEventListener("mousemove",V),document.addEventListener("mouseup",J)}),Ce(()=>{document.removeEventListener("mousemove",V),document.removeEventListener("mouseup",J)}),(c,k)=>{const a=we("Markdown");return f(),w("div",Ze,[p("div",et,[p("div",tt,[h(L,{path:E.value==="assistant"?i(le):i(re)},null,8,["path"]),g(" Smart Console ")]),p("div",st,[p("div",ot,[h(Qe,{"has-changes":C.value},null,8,["has-changes"])]),p("div",{class:"toggle-button",onClick:x},[h(L,{class:H(["icon",{open:y.value}]),path:i(ce),fill:"#fff"},null,8,["class","path"]),m.value.type==="unseen"?(f(),w("div",{key:0,class:"unseen-count","unseen-severity":m.value.severity},T(m.value.count),9,nt)):M("",!0)])])]),y.value?(f(),w("div",{key:0,class:"terminal",style:xe(u.value)},[p("div",{class:"resize-handler",onMousedown:te},null,32),p("div",at,[p("div",it,[p("div",{ref_key:"entriesContainer",ref:d,class:"entries"},[lt,(f(!0),w(oe,null,De(t.logService.logs,(n,D)=>(f(),w("div",{key:D,class:H([n.type,"entry"])},[n.type==="ai-output"?(f(),R(a,{key:0,source:n.log},null,8,["source"])):(f(),w("div",rt,T(n.type==="restart"?"-- restarted --":n.log),1))],2))),128))],512),p("div",ct,[h(L,{class:H(["icon",{open:y.value}]),path:i(ce)},null,8,["class","path"]),p("div",{ref_key:"inputRef",ref:v,class:"input-text",contenteditable:"","pointer-events":I.value?"none":"auto",placeholder:"Ask AI anything",onKeydown:Ae(P,["enter"])},null,40,ut)])]),p("div",dt,[p("div",{class:"icons",onClick:ee},[h(L,{class:"icon",path:i(Re)},null,8,["path"])]),p("div",null,[h(L,{class:"icon clickable",path:E.value==="assistant"?i(le):i(re),onClick:k[0]||(k[0]=n=>$())},null,8,["path"])])])])],4)):M("",!0)])}}});const Pt=Z(pt,[["__scopeId","data-v-668f6420"]]),ht=N({__name:"PathInput",props:{runtime:{}},setup(o){const e=o,s=()=>{const t=Te(e.runtime.path);t&&t!==e.runtime.path&&(e.runtime.path=t)};return(t,l)=>(f(),R(i(Ee),{value:t.runtime.path,"onUpdate:value":l[0]||(l[0]=d=>t.runtime.path=d),type:"text",onBlur:s},Oe({_:2},[t.runtime instanceof i($e)?{name:"addonBefore",fn:r(()=>[g(" https://[your-subdomain].abstra.app/_hooks/ ")]),key:"0"}:{name:"addonBefore",fn:r(()=>[g(" https://[your-subdomain].abstra.app/ ")]),key:"1"}]),1032,["value"]))}}),ft={key:1},vt=N({__name:"RuntimeCommonSettings",props:{runtime:{}},setup(o){const e=fe({pathError:null});return(s,t)=>(f(),w(oe,null,[s.runtime instanceof i(Pe)||s.runtime instanceof i(Le)?M("",!0):(f(),R(i(ke),{key:0,label:"URL path"},{default:r(()=>[h(ht,{runtime:s.runtime},null,8,["runtime"])]),_:1})),e.pathError?(f(),w("div",ft,T(e.pathError),1)):M("",!0)],64))}});const Lt=Z(vt,[["__scopeId","data-v-60a397e0"]]);let X={};function gt(o){return o in X?"\n\n```python\n"+o+" = "+X[o]+"\n```":""}Ke.registerHoverProvider("python",{provideHover:function(o,e){const s=o.getWordAtPosition(e);if(!!s)return{contents:[{value:gt(s.word)}]}}});const _t=(o,e,s={})=>{var A;const t=q.create(o,{language:"python",value:e,minimap:{enabled:!1},readOnly:(A=s.readOnly)!=null?A:!1,contextmenu:!s.readOnly,automaticLayout:!s.readOnly,tabSize:4,fixedOverflowWidgets:!0,theme:s.theme?s.theme:"vs",fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:s.readOnly?0:5,scrollBeyondLastLine:!s.readOnly,renderLineHighlight:s.readOnly?"none":"all",scrollbar:{useShadows:!1,alwaysConsumeMouseWheel:!1}}),l=t.getContribution("editor.contrib.messageController");t.onDidAttemptReadOnlyEdit(()=>{l.showMessage("Cannot edit during preview execution",t.getPosition())});const d=t.createDecorationsCollection([]),b=(C,x)=>{d.set(C.map(v=>({range:new Ve(v.lineno,1,v.lineno,1),options:{isWholeLine:!0,className:x}}))),X=C.reduce((v,E)=>({...v,...E.locals}),{})};return{editor:t,highlight:(C,x)=>v=>{const E=v.filter(P=>P.filename.endsWith(x));b(E,C)},clearHighlights:()=>{d.clear(),X={}},setReadOnly:C=>{t.updateOptions({readOnly:C})}}},mt=(o,e,s)=>{const t=q.createModel(e),l=q.createModel(s),d=q.createDiffEditor(o,{minimap:{enabled:!1},readOnly:!0,contextmenu:!1,automaticLayout:!0,renderWhitespace:"none",guides:{indentation:!1},fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:0,scrollBeyondLastLine:!1,renderLineHighlight:"none"});return d.setModel({original:t,modified:l}),{diffEditor:d}};class yt{constructor(e,s){S(this,"_script");S(this,"_localEditorCode");S(this,"_monacoEditor");S(this,"_diffEditor");S(this,"_viewMode");S(this,"_alertMessage");S(this,"_conflictingChanges");this._localEditorCode=e,this._script=s,this._monacoEditor=null,this._diffEditor=null,this._viewMode=Y("editor"),this._alertMessage=Y(""),this._conflictingChanges=Y(!1)}get alertMessage(){return this._alertMessage.value}set alertMessage(e){this._alertMessage.value=e}get conflictingChanges(){return this._conflictingChanges.value}set conflictingChanges(e){this._conflictingChanges.value=e}get viewMode(){return this._viewMode.value}set viewMode(e){this._viewMode.value=e}get abstraIDECode(){return this._script.codeContent}get localEditorCode(){return this._localEditorCode}set monacoEditor(e){this._monacoEditor=e}set diffEditor(e){this._diffEditor=e}finishPreview(){var e;this._viewMode.value="editor",this._script.codeContent=this._localEditorCode,(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.alertMessage=""}updateCodeWhileEditing(e){var l;const s=e!==this._localEditorCode;if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1;return}const t=!this._script.hasChanges("code_content");if(t){(l=this._monacoEditor)==null||l.setValue(e),this._script.codeContent=e,this._script.updateInitialState("code_content",e);return}if(!t&&s){this.alertMessage="You have conflicting changes with your local editor code",this.conflictingChanges=!0;return}}updateCodeWhileDiff(e){var s,t;if(e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1,this.viewMode="editor",this._localEditorCode=e;return}if(e!==this._localEditorCode){(t=(s=this._diffEditor)==null?void 0:s.getModel())==null||t.modified.setValue(e),this._localEditorCode=e;return}}updateCodeWhilePreview(e){if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="";return}this.alertMessage="The changes on your code will be shown after the preview stops running"}updateCode(e){switch(this._viewMode.value){case"editor":return this.updateCodeWhileEditing(e);case"diff":return this.updateCodeWhileDiff(e);case"preview":return this.updateCodeWhilePreview(e)}}keepAbstraIDECode(){var e;(e=this._monacoEditor)==null||e.setValue(this._script.codeContent),this._script.save("code_content"),this._script.updateInitialState("code_content",this._script.codeContent),this._localEditorCode=this._script.codeContent,this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}keepLocalEditor(){var e;(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}}const Ct={class:"container"},wt=N({__name:"SourceCode",props:{script:{},workspace:{}},emits:["update-file"],setup(o,{expose:e,emit:s}){const t=o,l=()=>{!t.script.file||t.workspace.openFile(t.script.file)},d=()=>{u.value.viewMode="diff",c()},b=_(null),m=_(null);let I,$,A,C;const{result:x}=de(()=>fetch("/_editor/api/workspace/root").then(a=>a.text())),v=_(t.script.file);_e(()=>t.script.file,()=>v.value=t.script.file);const{result:E,refetch:P}=de(()=>He.checkFile(v.value)),z=()=>{F.value.valid?s("update-file",ze(v.value)):s("update-file",v.value),P()},F=Q(()=>{var n;const a=Ne(v.value);return a.valid?((n=E.value)==null?void 0:n.exists)&&t.script.hasChanges("file")?{valid:!0,help:"This file already exists"}:t.script.hasChanges("file")?{valid:!0,help:"The original file will be renamed"}:a:a}),ee=()=>{!t.workspace||!x.value||t.workspace.openFile(".")},y=_(!1),K=async()=>{var n;if(!t.script.file)return;const a=await t.workspace.readFile(t.script.file);if(a===null){y.value=!0;return}y.value=!1,(n=u.value)==null||n.updateCode(a)},u=Y(null);let W;ye(()=>{J(),W=setInterval(K,1e3)}),Ce(()=>{clearInterval(W)});const te=()=>{C(!0),u.value.viewMode="preview"},V=(a,n)=>{if(n)return A("error-line",t.script.file)(a);A("executing-line",t.script.file)(a)},J=async()=>{await me(),t.workspace.readFile(t.script.file).then(a=>{if(a===null)return;t.script.codeContent=a,t.script.updateInitialState("code_content",a),u.value=new yt(a,t.script);const n=_t(b.value,a);$=n.clearHighlights,A=n.highlight,C=n.setReadOnly,I=n.editor,u.value.monacoEditor=I,I.onDidChangeModelContent(()=>{t.script.codeContent=I.getValue()})})},c=async()=>{const a=await t.workspace.readFile(t.script.file);if(!a)return;const n=t.script.codeContent,D=mt(m.value,n,a);u.value.diffEditor=D.diffEditor};return e({startPreviewMode:te,setHighlight:V,restartEditor:()=>{var a;$(),C(!1),(a=u.value)==null||a.finishPreview()}}),(a,n)=>{var G,B,ne,ae;const D=we("icon");return f(),w(oe,null,[h(i(ke),{"validate-status":F.value.valid?"success":"error",help:F.value.valid?F.value.help:F.value.reason},{default:r(()=>[h(i(Ee),{value:a.script.file,"onUpdate:value":n[0]||(n[0]=O=>a.script.file=O),onBlur:z},{addonBefore:r(()=>[i(x)?(f(),w("span",{key:0,class:"clickable",onClick:ee},[h(i(U),{placement:"bottomLeft","overlay-style":{maxWidth:"none"}},{title:r(()=>[g(T(i(x)),1)]),default:r(()=>[h(D,{path:i(We)},null,8,["path"])]),_:1})])):M("",!0)]),addonAfter:r(()=>[p("span",{class:"clickable",onClick:l},[g(" Open in editor "),h(D,{path:i(Be),width:"22"},null,8,["path"])])]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),(G=u.value)!=null&&G.alertMessage?(f(),R(i(Je),{key:0,type:"warning","show-icon":""},{message:r(()=>{var O;return[g(T((O=u.value)==null?void 0:O.alertMessage),1)]}),action:r(()=>[u.value.conflictingChanges&&u.value.viewMode!=="diff"?(f(),R(i(pe),{key:0,gap:"small"},{default:r(()=>[h(i(j),{type:"primary",onClick:d},{default:r(()=>[g("Compare")]),_:1}),h(i(U),null,{title:r(()=>[g("Keep the local editor version")]),default:r(()=>[h(i(j),{onClick:n[1]||(n[1]=O=>u.value.keepLocalEditor())},{default:r(()=>[g("Discard")]),_:1})]),_:1})]),_:1})):M("",!0),u.value.conflictingChanges&&u.value.viewMode==="diff"?(f(),R(i(pe),{key:1,gap:"small"},{default:r(()=>[h(i(U),null,{title:r(()=>[g("Keep your current changes")]),default:r(()=>[h(i(j),{onClick:n[2]||(n[2]=O=>u.value.keepAbstraIDECode())},{default:r(()=>[g("Keep left")]),_:1})]),_:1}),h(i(U),null,{title:r(()=>[g("Keep the local editor version")]),default:r(()=>[h(i(j),{onClick:n[3]||(n[3]=O=>u.value.keepLocalEditor())},{default:r(()=>[g("Keep right")]),_:1})]),_:1})]),_:1})):M("",!0)]),_:1})):M("",!0),p("div",Ct,[p("div",{id:"code",ref_key:"codeComponent",ref:b,class:H(["code-container",{hide:((B=u.value)==null?void 0:B.viewMode)==="diff",blur:y.value}])},null,2),y.value?(f(),R(i(Ge),{key:0,class:"not-found-popup"},{title:r(()=>[g("File not found")]),_:1})):M("",!0)]),((ne=u.value)==null?void 0:ne.viewMode)==="diff"?(f(),w("div",{key:1,id:"code",ref_key:"codeDiffComponent",ref:m,class:H(["code-container",{hide:((ae=u.value)==null?void 0:ae.viewMode)!=="diff"}])},null,2)):M("",!0)],64)}}});const Tt=Z(wt,[["__scopeId","data-v-26ce8cc2"]]);export{be as L,Lt as R,Tt as S,Pt as a};
//# sourceMappingURL=SourceCode.0178bfc3.js.map
