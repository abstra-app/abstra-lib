import{d as H,H as M,r as A,G as Z,a as i,b as r,er as y,f as t,w as a,bu as q,b0 as C,eA as P,eu as U,e as d,u,ez as X,c as R,q as W,J as ee,ex as te,eB as ae,eC as ne,v as oe,ey as de,eD as ce}from"./registerWidgets.9a15db03.js";import{B as pe}from"./BaseLayout.e127bb5c.js";import{T as me}from"./tables.0f7956e8.js";import{a as le}from"./asyncComputed.678d15aa.js";import{p as j}from"./popupNotifcation.f65c2710.js";import{n as _e}from"./index.286e7381.js";import{L as be}from"./CircularLoading.3e616c9a.js";import{w as fe,P as ve}from"./icons.c0d476d8.js";import{P as ye}from"./project.c3f78d43.js";import"./gateway.b159c969.js";import{O as ge}from"./organization.4c213c82.js";import"./index.16e3b6ad.js";import{T as he,a as Q}from"./index.e22fbae7.js";import{B as ke,a as Ce,c as we}from"./index.ddc4eafa.js";import"./activeRecord.9096561d.js";import"./pubsub.67e7aa16.js";import"./passwordlessManager.5c569f60.js";import"./storage.72b476f8.js";import"./FormItem.54e743df.js";import"./transButton.4d7b6647.js";import"./index.795b8226.js";(function(){try{var c=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},m=new Error().stack;m&&(c._sentryDebugIds=c._sentryDebugIds||{},c._sentryDebugIds[m]="047f833a-19db-44f6-8980-ae36ae2aae4d",c._sentryDebugIdIdentifier="sentry-dbid-047f833a-19db-44f6-8980-ae36ae2aae4d")}catch{}})();const De={class:"table-data"},xe={key:1},Ie=["onClick"],Te=d("a",null,"Delete",-1),$e=H({__name:"TableData",props:{table:{}},setup(c){var x;const m=c,{result:s,loading:l,refetch:E}=le(()=>m.table.select()),w=M(()=>{var b;return[...(b=m.table)==null?void 0:b.getColumns().map($=>({title:$.name,dataIndex:$.name})),{title:"Actions",key:"action",fixed:"right",width:100,align:"center"}]}),_=M(()=>{var p;return((p=s.value)==null?void 0:p.map(b=>({key:b.id,...b})))||[]}),D=A(!1),e=A({}),N=()=>{D.value=!0},I=()=>{e.value={},D.value=!1};let g=Z((x=m.table)==null?void 0:x.getUnprotectedColumns().reduce((p,b)=>({...p,[b.name]:""}),{}));async function o(){if(!(!m.table||!g))try{if(e.value.id){await m.table.updateRow(e.value.id,e.value);return}else await m.table.insertRow(e.value);e.value={},E(),I()}catch(p){p instanceof Error&&j("Database error",p.message)}}const h=async p=>{if(!(!s.value||!s.value.find(b=>b.id===p)))try{await m.table.deleteRow(p),E()}catch(b){b instanceof Error&&j("Database error",b.message)}},T=p=>{var b;e.value=W.exports.pick(W.exports.cloneDeep((b=_.value)==null?void 0:b.filter($=>p===$.key)[0]),m.table.getColumns().map($=>$.name)),N()};return(p,b)=>{const $=i("a-divider"),f=i("a-popconfirm"),n=i("a-button"),v=i("a-table"),B=i("a-input"),K=i("a-form-item"),F=i("a-form"),G=i("a-space"),z=i("a-drawer");return r(),y("div",De,[t(v,{columns:w.value,"data-source":_.value,bordered:"",loading:u(l),scroll:{x:2e3,y:720}},{bodyCell:a(({column:S,text:L,record:O})=>[w.value.map(V=>V.title).includes(S.dataIndex)?(r(),y(q,{key:0},[C(P(L),1)],64)):U("",!0),S.key==="action"?(r(),y("div",xe,[d("span",null,[d("a",{onClick:V=>T(O.id)},"Edit",8,Ie)]),t($,{type:"vertical"}),t(f,{title:"Sure to delete?",onConfirm:V=>h(O.id)},{default:a(()=>[Te]),_:2},1032,["onConfirm"])])):U("",!0)]),footer:a(()=>[t(n,{type:"primary",onClick:N},{default:a(()=>[C("+ Add New Data")]),_:1})]),_:1},8,["columns","data-source","loading"]),t(z,{title:"Data",width:720,open:D.value,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:I},{extra:a(()=>[t(G,null,{default:a(()=>[t(n,{onClick:I},{default:a(()=>[C("Cancel")]),_:1}),t(n,{type:"primary",onClick:o},{default:a(()=>[C("Submit")]),_:1})]),_:1})]),default:a(()=>[t(F,{model:e.value,layout:"vertical"},{default:a(()=>[(r(!0),y(q,null,X(p.table.getUnprotectedColumns(),S=>(r(),R(K,{key:S.id,label:S.name},{default:a(()=>[e.value?(r(),R(B,{key:0,value:e.value[S.name],"onUpdate:value":L=>e.value[S.name]=L},null,8,["value","onUpdate:value"])):U("",!0)]),_:2},1032,["label"]))),128))]),_:1},8,["model"])]),_:1},8,["open"])])}}});const se=c=>(ae("data-v-0e9ed4de"),c=c(),ne(),c),Ee={class:"table-settings"},Be={key:0},Ne=se(()=>d("span",null," protected ",-1)),Se=[Ne],Re={key:1},Ue=["onClick"],ze=se(()=>d("a",null,"Delete",-1)),Ae=H({__name:"TableColumns",props:{table:{},loading:{type:Boolean}},emits:["refresh"],setup(c,{emit:m}){var $;const s=c,l=A(s.loading);ee(()=>s.loading,()=>{l.value=s.loading});const E=["varchar","int","boolean","json","date","timestamp","uuid"],w=te();($=s.table)==null||$.onUpdate(()=>{var f;w.replace({name:"tableEditor",params:{tableName:(f=s.table)==null?void 0:f.name}})});const D=[...[{title:"Name",dataIndex:"name"},{title:"Type",dataIndex:"type"},{title:"Default Value",dataIndex:"default"},{title:"Nullable",dataIndex:"nullable"},{title:"Primary Key",dataIndex:"primaryKey"}],{title:"Actions",key:"action"}],e=A({name:"",type:"",nullable:!0,unique:!1}),N=()=>{e.value={name:"",type:"",nullable:!0,unique:!1}},I=M(()=>{var f;return(f=s.table)==null?void 0:f.getColumns().map(n=>({name:n.name,type:n.type,default:n.default,nullable:n.nullable,primaryKey:n.primaryKey,id:n.id,unique:n.unique}))}),g=A(!1),o=()=>{g.value=!0},h=()=>{g.value=!1};function T(f){var n,v;(v=(n=s.table)==null?void 0:n.getColumn(f))==null||v.delete(),l.value=!0,setTimeout(()=>{m("refresh")},2e3)}async function x(){var f;if(!!s.table&&!(!e.value.name||!e.value.type)){if(e.value.id){const n=(f=s.table)==null?void 0:f.getColumn(e.value.id);if(!n)return;const{success:v,error:B}=await n.update(e.value);v||j("Database error",B)}else{const{success:n,error:v}=await s.table.addColumn(e.value);n||j("Database error",v)}N(),l.value=!0,h(),setTimeout(()=>{m("refresh")},2e3)}}const p=f=>{var n,v,B;return(B=(v=(n=s.table)==null?void 0:n.getColumn(f))==null?void 0:v.protected)!=null?B:!1},b=f=>{var v;const n=W.exports.cloneDeep((v=I.value)==null?void 0:v.filter(B=>B.id===f));!n||(e.value=n[0],o())};return(f,n)=>{const v=i("a-divider"),B=i("a-popconfirm"),K=i("a-button"),F=i("a-table"),G=i("a-input"),z=i("a-form-item"),S=i("a-select-option"),L=i("a-select"),O=i("a-switch"),V=i("a-form"),re=i("a-space"),ie=i("a-drawer");return r(),y("div",Ee,[t(F,{columns:D,"data-source":I.value,bordered:"",loading:l.value,pagination:!1},{bodyCell:a(({column:k,text:ue,record:J})=>[k.key!=="action"?(r(),y(q,{key:0},[C(P(ue),1)],64)):(r(),y(q,{key:1},[p(J.id)?(r(),y("div",Be,Se)):(r(),y("div",Re,[d("span",null,[d("a",{onClick:()=>b(J.id)},"Edit",8,Ue)]),t(v,{type:"vertical"}),t(B,{title:"Sure to delete?",onConfirm:tt=>T(J.id)},{default:a(()=>[ze]),_:2},1032,["onConfirm"])]))],64))]),footer:a(()=>[t(K,{type:"primary",onClick:o},{default:a(()=>[C("+ Add New Column")]),_:1})]),_:1},8,["data-source","loading"]),t(ie,{title:"Column",width:720,open:g.value,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:h},{extra:a(()=>[t(re,null,{default:a(()=>[t(K,{onClick:h},{default:a(()=>[C("Cancel")]),_:1}),t(K,{type:"primary",onClick:x},{default:a(()=>[C("Submit")]),_:1})]),_:1})]),default:a(()=>[t(V,{model:e.value,layout:"vertical"},{default:a(()=>[t(z,{key:"name",label:"Name"},{default:a(()=>[t(G,{value:e.value.name,"onUpdate:value":n[0]||(n[0]=k=>e.value.name=k)},null,8,["value"])]),_:1}),t(z,{key:"type",label:"Type"},{default:a(()=>[t(L,{value:e.value.type,"onUpdate:value":n[1]||(n[1]=k=>e.value.type=k),"default-active-first-option":""},{default:a(()=>[(r(),y(q,null,X(E,k=>t(S,{key:k,value:k},{default:a(()=>[C(P(k),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1}),t(z,{key:"nullable",label:"Nullable"},{default:a(()=>[t(O,{checked:e.value.nullable,"onUpdate:checked":n[2]||(n[2]=k=>e.value.nullable=k)},null,8,["checked"])]),_:1}),t(z,{key:"unique",label:"Unique"},{default:a(()=>[t(O,{checked:e.value.unique,"onUpdate:checked":n[3]||(n[3]=k=>e.value.unique=k)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])])}}});const qe=oe(Ae,[["__scopeId","data-v-0e9ed4de"]]),Y=c=>(ae("data-v-e6bea20b"),c=c(),ne(),c),Pe={class:"table-settings"},je=Y(()=>d("h2",{class:"title"},"Table settings",-1)),Ke=Y(()=>d("div",{class:"subtitle"},"Edit table metadata",-1)),Le={key:0,class:"table-presenter"},Oe={class:"table-property-item"},Ve={class:"property-item"},Me={key:1},He={class:"change-warning"},Fe={class:"section-title"},Ge=Y(()=>d("div",{class:"section-body"}," Changing the table's name can possibly result in the break of running applications. ",-1)),Je={class:"input-section"},Qe={class:"table-name-value-input"},We=["value"],Xe={key:0,class:"error"},Ye={class:"option-buttons"},Ze=H({__name:"TableSettings",props:{table:{}},emits:["refresh"],setup(c,{emit:m}){var I,g;const s=c,l=Z({name:(g=(I=s.table)==null?void 0:I.name)!=null?g:"",error:"",editing:!1,loading:!1}),E=()=>l.editing=!0,w=()=>{e(),l.editing=!1,l.error=""},_=async()=>{l.error="",l.loading=!0;try{await D()}catch(o){o instanceof Error&&(j("Database error",o.message),l.error=o.message)}l.error||(l.editing=!1),l.loading=!1},D=async()=>{if(!(!s.table||s.table.name===l.name)){if(!l.name){l.error="Table name cannot be empty";return}s.table.name=l.name;try{await s.table.save(),m("refresh")}catch(o){o instanceof Error&&(j("Database error",o.message),l.error=o.message)}}},e=()=>{var o,h;return l.name=(h=(o=s.table)==null?void 0:o.name)!=null?h:""},N=o=>{l.name=_e(o.target.value,{replacement:"-",lower:!0,strict:!0})};return ee(()=>{var o;return(o=s.table)==null?void 0:o.name},()=>e()),(o,h)=>{var x;const T=i("icon");return r(),y("div",Pe,[je,Ke,l.editing?(r(),y("div",Me,[d("div",He,[d("div",Fe,[t(T,{path:u(fe),width:"12",height:"12",fill:"#D35249"},null,8,["path"]),C(" Be careful ")]),Ge]),d("div",Je,[d("div",Qe,[d("input",{value:l.name,type:"text",onInput:N},null,40,We)]),l.error?(r(),y("div",Xe,[t(T,{path:u(ve),fill:"#D35249",width:"12",height:"12"},null,8,["path"]),C(" "+P(l.error),1)])):U("",!0),d("div",Ye,[d("button",{class:"cancel-button",onClick:w},"Cancel"),d("button",{class:"save-button",onClick:_},[C(" Save Changes "),l.loading?(r(),R(be,{key:0,size:"16"})):U("",!0)])])])])):(r(),y("div",Le,[d("div",Oe,[d("div",Ve,"Name: "+P((x=o.table)==null?void 0:x.name),1)]),d("button",{onClick:E},"Edit Name")]))])}}});const et=oe(Ze,[["__scopeId","data-v-e6bea20b"]]),wt=H({__name:"TableEditor",setup(c){const m=te(),s=de(),l=s.params.tableId,E=s.params.projectId,w=A("data"),{result:_,loading:D,refetch:e}=le(()=>Promise.all([ye.get(E).then(async g=>{const o=await ge.get(g.organizationId);return{project:g,organization:o}}),me.get(E,l)]).then(([{project:g,organization:o},h])=>ce({project:g,organization:o,table:h}))),N=M(()=>!D.value&&_.value?[{label:"My organizations",path:"/organizations"},{label:_.value.organization.name,path:`/organizations/${_.value.organization.id}`},{label:_.value.project.name,path:`/projects/${_.value.project.id}/tables`}]:void 0);function I(){m.push({name:"tables",params:{projectId:E}})}return(g,o)=>{const h=i("router-link");return r(),R(pe,null,{navbar:a(()=>{var T;return[t(u(we),{title:(T=u(_))==null?void 0:T.table.name,onBack:I},{footer:a(()=>[t(u(he),{"active-key":w.value,"onUpdate:activeKey":o[0]||(o[0]=x=>w.value=x)},{default:a(()=>[t(u(Q),{key:"data",tab:"Data"}),t(u(Q),{key:"columns",tab:"Columns"}),t(u(Q),{key:"settings",tab:"Settings"})]),_:1},8,["active-key"])]),breadcrumb:a(()=>[N.value?(r(),R(u(ke),{key:0},{default:a(()=>[(r(!0),y(q,null,X(N.value,(x,p)=>(r(),R(u(Ce),{key:p},{default:a(()=>[t(h,{to:x.path},{default:a(()=>[C(P(x.label),1)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1})):U("",!0)]),_:1},8,["title"])]}),content:a(()=>[u(_)&&w.value==="data"?(r(),R($e,{key:0,loading:u(D),table:u(_).table},null,8,["loading","table"])):U("",!0),u(_)&&w.value==="columns"?(r(),R(qe,{key:1,table:u(_).table,loading:u(D),onRefresh:o[1]||(o[1]=T=>u(e)())},null,8,["table","loading"])):U("",!0),u(_)&&w.value==="settings"?(r(),R(et,{key:2,table:u(_).table,loading:u(D),onRefresh:o[2]||(o[2]=T=>u(e)())},null,8,["table","loading"])):U("",!0)]),_:1})}}});export{wt as default};
//# sourceMappingURL=TableEditor.6135cd9b.js.map
