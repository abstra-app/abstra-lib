import{a as V}from"./router-FiPGiJmO.js";import{l as x}from"./fetch-BFpwSRe7.js";import{E as k}from"./record-oSECIlP2.js";import{s as U,r as T,aM as A,a as j,N as I,H as D,a0 as R,k as S,f as c,b as u,e as h,u as a,i as d,b9 as $,w as n,g as p,t as m,h as y,ab as F,ba as O,b5 as P,T as B,bc as L,Q as M}from"./jwt-decode.esm-pmJTfMF_.js";import{S as _}from"./SaveButton-ncb-jlMZ.js";import{C as N}from"./CrudView-jnBeQU2j.js";import{a as G}from"./asyncComputed-jy8qYMJr.js";import{o as f}from"./omniChatStore-BvQIlOaN.js";import{G as W}from"./PhPencil.vue-DX1CFD9V.js";import{u as z}from"./useCodebaseEvents-BFfiCyCe.js";import{A as H}from"./index-CiXFfdSn.js";(function(){try{var i=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(i._sentryDebugIds=i._sentryDebugIds||{},i._sentryDebugIds[e]="54c60093-cef8-4bbe-9ff8-b63b85c31c7d",i._sentryDebugIdIdentifier="sentry-dbid-54c60093-cef8-4bbe-9ff8-b63b85c31c7d")}catch{}})();class g{data;deleted;constructor(e){this.data=k.from(e),this.deleted=U([])}wasDeleted=e=>this.deleted.value.includes(e);wasUpdated=e=>this.data.hasChanges(e);set=(e,t)=>{this.data.set(e,t),this.deleted.value=this.deleted.value.filter(s=>s!==e)};get=e=>{if(!this.deleted.value.includes(e))return this.data.get(e)};delete=e=>{this.deleted.value=[...this.deleted.value,e]};values=()=>{const e={},t=Object.keys(this.data.changes).concat(Object.keys(this.data.initialState));for(const s of t)this.deleted.value.includes(s)||(e[s]=this.data.get(s));return e};static from(e){const t=e.reduce((s,{name:o,value:v})=>(s[o]=v,s),{});return new g(t)}get changes(){const e=this.deleted.value.map(t=>({name:t,change:"delete"}));for(const t of Object.keys(this.data.changes))if(!this.deleted.value.includes(t)){if(this.data.initialState[t]===void 0){e.push({name:t,value:this.data.get(t),change:"create"});continue}this.data.hasChanges(t)&&e.push({name:t,value:this.data.get(t),change:"update"})}return e}commit=()=>{this.data=k.from(this.values()),this.deleted.value=[]}}class Z{urlPath="env-vars";async list(e){return await V.get(`projects/${e}/${this.urlPath}`)}async update(e,t){await V.patch(`projects/${e}/${this.urlPath}`,t)}}const E=new Z;class ne{constructor(e){this.projectId=e}async get(){const e=await E.list(this.projectId);return g.from(e.map(t=>({...t,value:""})))}async update(e){await E.update(this.projectId,e)}}class re{constructor(e=x){this.fetch=e}async get(){const e=await this.fetch("/_editor/api/env-vars");if(!e.ok)throw new Error("Failed to list env vars");const t=await e.json();return g.from(t)}async update(e){await this.fetch("/_editor/api/env-vars",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}}class b{envVarRepo;envVars;state=T({type:"idle"});mode;constructor(e,t,s){this.envVarRepo=e,this.envVars=t,this.mode=s}static async create(e,t){const s=await e.get();return new b(e,s,t)}get isLocalEditor(){return this.mode==="editor"}get saveMessage(){return this.isLocalEditor?"Save":"Save and Apply"}get creationFields(){return[{label:"Variable name",key:"key"},{label:"Variable value",key:"value",type:"multiline-text"}]}validate=e=>{const t=/^[A-Za-z_][A-Za-z0-9_]*$/,{key:s,value:o}=e;if(o.trim()!==o)throw new Error("Environment variable values cannot have leading or trailing whitespace.");if(!t.test(s))throw new Error(`Invalid key: ‘${s}’. A key must begin with a letter or an underscore, and may only include letters, numbers, and underscores.`)};create=e=>{this.validate(e),this.envVars.set(e.key,e.value),this.state.value={type:"idle"}};delete=e=>{this.envVars.delete(e),this.state.value={type:"idle"}};get isUpdating(){return this.state.value.type==="updating"}startUpdating=e=>{this.state.value={type:"updating",name:e,value:this.envVars.get(e)||""}};confirmUpdate=()=>{this.state.value.type==="updating"&&(this.envVars.set(this.state.value.name,this.state.value.value),this.state.value={type:"idle"})};cancelUpdate=()=>{this.state.value={type:"idle"}};refetch=async()=>{if(!this.isLocalEditor)return;const e=await this.envVarRepo.get();Object.entries(e.values()).forEach(([t,s])=>{this.envVars.wasDeleted(t)||this.envVars.get(t)===void 0&&this.envVars.set(t,s)})};wasUpdated(e){return this.envVars.wasUpdated(e)}columns=()=>[{title:"Key"},{title:"Value"},{title:""}];rows=()=>Object.entries(this.envVars.values()).map(([e])=>({key:e,cells:[{type:"text",text:e,contentType:this.wasUpdated(e)?"warning":"default"},{type:"text",text:"*********",contentType:this.wasUpdated(e)?"warning":"default"},{type:"actions",actions:[{icon:A,label:"Delete",onClick:()=>this.delete(e),dangerous:!0},{icon:W,label:"Update",onClick:()=>this.startUpdating(e)}]}]}));save=async()=>{await this.envVarRepo.update(this.envVars.changes),this.envVars.commit()};hasChanges=()=>this.envVars.changes.length>0;table=()=>({columns:this.columns(),rows:this.rows()})}const oe=j({__name:"View",props:{envVarRepository:{},mode:{},hideTitle:{type:Boolean}},setup(i){const e=i,{result:t,loading:s,refetch:o}=G(async()=>await b.create(e.envVarRepository,e.mode)),v=z();I(v.lastEvent,async l=>{l&&l.filepath&&l.filepath.endsWith(".env")&&await t.value?.refetch()});const C={columns:[],rows:[]};return D(()=>{const l=f.subscribe("envVarCreated",()=>{o()}),r=f.subscribe("envVarEdited",()=>{o()});R(()=>{f.unsubscribe(l),f.unsubscribe(r)})}),(l,r)=>(c(),S(M,null,[a(t)?(c(),u(N,{key:0,"entity-name":a(d).translate("i18n_envvarsview_entity_name"),loading:a(s),title:e.hideTitle?"":a(d).translate("i18n_envvarsview_title"),description:e.hideTitle?"":a(d).translate("i18n_envvarsview_description"),"empty-title":a(d).translate("i18n_envvarsview_empty_title"),table:a(t).table()||C,"create-button-text":a(d).translate("i18n_envvarsview_create_button"),create:a(t).create,fields:a(t).creationFields||[],live:a(t).isLocalEditor},$({_:2},[a(t)?.isLocalEditor?{name:"secondary",fn:n(()=>[i.mode=="editor"?(c(),u(_,{key:0,model:a(t),disabled:!a(t).hasChanges()},{"with-changes":n(()=>[p(m(a(t).saveMessage),1)]),_:1},8,["model","disabled"])):h("",!0)]),key:"0"}:void 0,a(t)?.isLocalEditor?{name:"extra",fn:n(()=>[y(a(H),{"show-icon":"",style:{"margin-top":"20px"}},{message:n(()=>[p(m(a(d).translate("i18n_envvarsview_local_helper_message")),1)]),_:1})]),key:"1"}:void 0,a(t)?{name:"more",fn:n(()=>[i.mode=="console"?(c(),u(_,{key:0,model:a(t),disabled:!a(t).hasChanges()},{"with-changes":n(()=>[p(m(a(t).saveMessage),1)]),_:1},8,["model","disabled"])):h("",!0)]),key:"2"}:void 0]),1032,["entity-name","loading","title","description","empty-title","table","create-button-text","create","fields","live"])):h("",!0),a(t)?(c(),u(a(F),{key:1,open:a(t).isUpdating,title:a(d).translate("i18n_envvarsview_update_modal_title"),onCancel:r[1]||(r[1]=w=>a(t)?.cancelUpdate()),onOk:r[2]||(r[2]=()=>a(t)?.confirmUpdate())},{default:n(()=>[a(t).state.value.type==="updating"?(c(),u(a(O),{key:0,layout:"vertical"},{default:n(()=>[y(a(P),null,{default:n(()=>[y(a(B),null,{default:n(()=>[p(m(a(t).state.value.name),1)]),_:1}),y(a(L),{value:a(t).state.value.value,"onUpdate:value":r[0]||(r[0]=w=>a(t).state.value.value=w)},null,8,["value"])]),_:1})]),_:1})):h("",!0)]),_:1},8,["open","title"])):h("",!0)],64))}});export{ne as C,re as E,oe as _};
//# sourceMappingURL=View.vue_vue_type_script_setup_true_lang-D6JnjMQ3.js.map
