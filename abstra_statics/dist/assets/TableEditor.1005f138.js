import{d as K,r as z,G as q,F as ne,b as s,eu as T,f as t,w as a,b6 as O,az as $,eC as P,ew as D,e as C,u as e,cB as oe,bX as L,cI as ue,cG as V,eB as Q,c as h,bQ as R,eJ as H,a as G,ad as X,cF as se,bx as re,t as Y,H as ve,ez as ie,eD as de,eE as ce,eA as ye,eI as be}from"./outputWidgets.a177f9c3.js";import{p as pe,T as ge}from"./tables.7456eafd.js";import{B as _e}from"./BaseLayout.2b9dd6eb.js";import{a as Z}from"./asyncComputed.acb737a7.js";import{p as F}from"./popupNotifcation.e75e8fad.js";import{A as fe}from"./index.a0bf1021.js";import{F as ee,A as x}from"./Form.17a59008.js";import{A as te}from"./index.24dd2413.js";import"./router.c47a87c6.js";import{P as he}from"./project.8ccdb31c.js";import"./index.049a6d97.js";import{O as ke}from"./organization.6bdb9285.js";import{H as Ce,I as we,J as De,K as $e,L as Se,w as Ie,M as Ue}from"./icons.7303f3f1.js";import{A as M}from"./index.235eebe4.js";import{L as Te}from"./CircularLoading.9e53dbff.js";import{T as xe,A as W}from"./TabPane.17d9b922.js";import{B as Ae,a as Be,c as Ee}from"./index.9cafe5c9.js";import"./record.56549bf6.js";import"./pubsub.a5b7cb2c.js";import"./gateway.c17828e8.js";import"./index.f5af42aa.js";import"./Title.cb335585.js";(function(){try{var g=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},b=new Error().stack;b&&(g._sentryDebugIds=g._sentryDebugIds||{},g._sentryDebugIds[b]="b924a1aa-fd7f-4f99-a9a5-e3cdd54f4058",g._sentryDebugIdIdentifier="sentry-dbid-b924a1aa-fd7f-4f99-a9a5-e3cdd54f4058")}catch{}})();const ze={class:"table-data",style:{width:"calc(100% - 80px)"}},Ne={key:1},Le=["onClick"],qe=C("a",null,"Delete",-1),Re=K({__name:"TableData",props:{table:{}},setup(g){var o,d;const b=g,n=z(1),l=z(10),_=q(()=>{var m,u;return{total:(u=(m=w.value)==null?void 0:m.total)!=null?u:0,current:n.value,pageSize:l.value,totalBoundaryShowSizeChanger:10,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:async(B,j)=>{n.value=B,l.value=j,await S()}}}),{result:w,loading:c,refetch:S}=Z(()=>b.table.select({},(n.value-1)*l.value,l.value)),I=(o=b.table)==null?void 0:o.getColumns().map(m=>({title:m.name,dataIndex:m.name,resizable:!0,minWidth:100,ellipsis:!1})),f=z([...I,{title:"Actions",key:"action",fixed:"right",width:150,align:"center"}]);function y(m,u){u.width=m}const r=q(()=>{var m;return((m=w.value)==null?void 0:m.rows.map(u=>({key:u.id,...u})))||[]}),v=z(!1),i=z({}),E=()=>{v.value=!0},A=()=>{i.value={},v.value=!1};let p=ne((d=b.table)==null?void 0:d.getUnprotectedColumns().reduce((m,u)=>({...m,[u.name]:""}),{}));async function k(){if(!(!b.table||!p))try{i.value.id?await b.table.updateRow(i.value.id,i.value):await b.table.insertRow(i.value),i.value={},S(),A()}catch(m){m instanceof Error&&F("Database error",m.message)}}const U=async m=>{if(!(!w.value||!w.value.rows.find(u=>u.id===m)))try{await b.table.deleteRow(m),S()}catch(u){u instanceof Error&&F("Database error",u.message)}},N=m=>{var u;i.value=H.exports.pick(H.exports.cloneDeep((u=r.value)==null?void 0:u.filter(B=>m===B.key)[0]),b.table.getColumns().map(B=>B.name)),E()};return(m,u)=>(s(),T("div",ze,[t(e(ue),{columns:f.value,"data-source":r.value,pagination:_.value,bordered:"",loading:e(c),scroll:{x:2e3,y:720},size:"small",onResizeColumn:y},{bodyCell:a(({column:B,text:j,record:le})=>[f.value.map(J=>J.title).includes(B.dataIndex)?(s(),T(O,{key:0},[$(P(j),1)],64)):D("",!0),B.key==="action"?(s(),T("div",Ne,[C("span",null,[C("a",{onClick:J=>N(le.id)},"Edit",8,Le)]),t(e(fe),{type:"vertical"}),t(e(oe),{title:"Sure to delete?",onConfirm:J=>U(le.id)},{default:a(()=>[qe]),_:2},1032,["onConfirm"])])):D("",!0)]),footer:a(()=>[t(e(L),{type:"primary",onClick:E},{default:a(()=>[$("+ Add New Data")]),_:1})]),_:1},8,["columns","data-source","pagination","loading"]),t(e(te),{title:"Data",width:720,open:v.value,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:A},{extra:a(()=>[t(e(V),null,{default:a(()=>[t(e(L),{onClick:A},{default:a(()=>[$("Cancel")]),_:1}),t(e(L),{type:"primary",onClick:k},{default:a(()=>[$("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(ee),{model:i.value,layout:"vertical"},{default:a(()=>[(s(!0),T(O,null,Q(m.table.getUnprotectedColumns(),B=>(s(),h(e(x),{key:B.id,label:B.name},{default:a(()=>[i.value?(s(),h(e(R),{key:0,value:i.value[B.name],"onUpdate:value":j=>i.value[B.name]=j},null,8,["value","onUpdate:value"])):D("",!0)]),_:2},1032,["label"]))),128))]),_:1},8,["model"])]),_:1},8,["open"])]))}});const Oe=K({__name:"NewColumn",props:{open:{type:Boolean},table:{}},emits:["created","cancel"],setup(g,{emit:b}){const n=g,l=z({name:"",type:"varchar",default:"''",nullable:!0,unique:!1}),_=z({error:"success",message:"",fakeLoading:!1}),w=()=>{_.value.fakeLoading=!0,c()},c=H.exports.debounce(async()=>{var r;const y=`select (${l.value.default})::${l.value.type} `;(r=n.table)==null||r.executeQuery(y,[]).then(v=>{_.value.error=v.errors.length>0?"error":"success",_.value.message=v.errors[0]||"",_.value.fakeLoading=!1})},500),S=()=>{l.value={name:"",type:"varchar",default:"''",nullable:!0,unique:!1}};function I(){b("cancel")}async function f(){if(!!n.table&&!(!l.value.name||!l.value.type))try{await n.table.addColumn(l.value),S(),b("created")}catch(y){y instanceof Error&&F("Database error",y.message)}}return(y,r)=>{const v=G("icon");return s(),h(e(te),{title:"New column",width:720,open:n.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:I},{extra:a(()=>[t(e(V),null,{default:a(()=>[t(e(L),{onClick:I},{default:a(()=>[$("Cancel")]),_:1}),t(e(L),{type:"primary",onClick:f},{default:a(()=>[$("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(ee),{model:l.value,layout:"vertical"},{default:a(()=>[t(e(x),{key:"name",label:"Name",required:!0},{default:a(()=>[t(e(R),{value:l.value.name,"onUpdate:value":r[0]||(r[0]=i=>l.value.name=i)},null,8,["value"])]),_:1}),t(e(x),{key:"type",label:"Type",required:!0},{default:a(()=>[t(e(X),{value:l.value.type,"onUpdate:value":r[1]||(r[1]=i=>l.value.type=i),"default-active-first-option":"",onChange:w},{default:a(()=>[(s(!0),T(O,null,Q(e(pe),i=>(s(),h(e(se),{key:i,value:i},{default:a(()=>[$(P(i),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),t(e(x),{key:"default-value",label:"Default value","validate-status":_.value.error,help:_.value.message},{default:a(()=>[t(e(R),{value:l.value.default,"onUpdate:value":r[2]||(r[2]=i=>l.value.default=i),onInput:w},{suffix:a(()=>[_.value.fakeLoading?(s(),h(e(re),{key:0})):D("",!0),!_.value.fakeLoading&&_.value.error==="success"?(s(),h(v,{key:1,path:e(Ce)},null,8,["path"])):D("",!0),!_.value.fakeLoading&&_.value.error==="error"?(s(),h(v,{key:2,path:e(we)},null,8,["path"])):D("",!0)]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),t(e(x),{key:"nullable",label:"Nullable"},{default:a(()=>[t(e(M),{checked:l.value.nullable,"onUpdate:checked":r[3]||(r[3]=i=>l.value.nullable=i)},null,8,["checked"])]),_:1}),t(e(x),{key:"unique",label:"Unique"},{default:a(()=>[t(e(M),{checked:l.value.unique,"onUpdate:checked":r[4]||(r[4]=i=>l.value.unique=i)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])}}}),Pe={class:"types-container"},Fe={class:"fullwidth-input"},Ke={class:"fullwidth-input"},je={class:"using-container"},Me={class:"fullwidth-input"},Ve=K({__name:"UpdateColumn",props:{open:{type:Boolean},table:{},column:{}},emits:["updated","cancel"],setup(g,{emit:b}){const n=g,{result:l,loading:_}=Z(async()=>n.table.select({},10,0).then(({total:o})=>o));function w(){b("cancel")}const c=z({error:"success",message:"",fakeLoading:!1}),S=()=>{c.value.fakeLoading=!0,I()},I=H.exports.debounce(async()=>{var d;const o=`select (${n.column.default})::${n.column.type} `;(d=n.table)==null||d.executeQuery(o,[]).then(m=>{c.value.error=m.errors.length>0?"error":"success",c.value.message=m.errors[0]||"",c.value.fakeLoading=!1})},500),f=()=>l.value===0||_.value?!1:n.column.record.hasChangesDeep("type"),y=z({type:"default"});function r(o,d){return d==="varchar"||o==="int"&&d==="boolean"||o==="boolean"&&d==="int"}const v=()=>{S(),i.value||(y.value={type:"user-defined",using:U.value,mandatory:!0})},i=q(()=>y.value.type==="default"&&r(n.column.record.initialState.type,n.column.type)),E=q(()=>!r(n.column.record.initialState.type,n.column.type));function A(o){o?y.value={type:"default"}:y.value={type:"user-defined",using:U.value,mandatory:!1}}function p(o){if(y.value.type==="default")throw new Error("Can't change using when using default casting");y.value.using=o!=null?o:""}const k=()=>E.value?!0:f()&&y.value.type==="user-defined",U=q(()=>`${n.column.record.initialState.name}::${n.column.type}`);async function N(){if(!n.column)return;let o=y.value.type==="default"?U.value:y.value.using;l.value===0&&(o=`${n.column.name}::text::${n.column.type}`);try{await n.column.update(o),b("updated")}catch(d){d instanceof Error&&F("Database error",d.message)}}return(o,d)=>{const m=G("icon");return s(),h(e(te),{title:"Edit column",width:720,open:n.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:w},{extra:a(()=>[t(e(V),null,{default:a(()=>[t(e(L),{onClick:w},{default:a(()=>[$("Cancel")]),_:1}),t(e(L),{type:"primary",onClick:N},{default:a(()=>[$("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(ee),{model:o.column,layout:"vertical"},{default:a(()=>[t(e(x),{key:"name",label:"Name"},{default:a(()=>[t(e(R),{value:o.column.name,"onUpdate:value":d[0]||(d[0]=u=>o.column.name=u)},null,8,["value"])]),_:1}),C("div",Pe,[C("span",Fe,[t(e(x),{key:"type",label:"Current Type"},{default:a(()=>[t(e(X),{value:o.column.record.initialState.type,"onUpdate:value":d[1]||(d[1]=u=>o.column.record.initialState.type=u),"default-active-first-option":"",disabled:""},null,8,["value"])]),_:1})]),t(m,{class:"right-arrow",path:e(De)},null,8,["path"]),C("span",Ke,[t(e(x),{key:"new-type",label:"New Type"},{default:a(()=>[t(e(X),{value:o.column.type,"onUpdate:value":d[2]||(d[2]=u=>o.column.type=u),"default-active-first-option":"",onChange:d[3]||(d[3]=u=>v())},{default:a(()=>[(s(!0),T(O,null,Q(e(pe),u=>(s(),h(e(se),{key:u,value:u},{default:a(()=>[$(P(u),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})])]),t(e(x),{key:"default-value",label:"Default value","validate-status":c.value.error,help:c.value.message},{default:a(()=>[t(e(R),{value:o.column.default,"onUpdate:value":d[4]||(d[4]=u=>o.column.default=u),onInput:S},{suffix:a(()=>[c.value.fakeLoading?(s(),h(e(re),{key:0,size:"small"})):D("",!0),!c.value.fakeLoading&&c.value.error==="success"?(s(),h(m,{key:1,path:e($e),width:"18",height:"18"},null,8,["path"])):D("",!0),!c.value.fakeLoading&&c.value.error==="error"?(s(),h(m,{key:2,path:e(Se),width:"18",height:"18"},null,8,["path"])):D("",!0)]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),C("div",je,[f()?(s(),h(e(x),{key:"default-casting",label:"Use default casting"},{default:a(()=>[t(e(M),{checked:i.value,disabled:E.value,"onUpdate:checked":d[5]||(d[5]=u=>A(!!u))},null,8,["checked","disabled"])]),_:1})):D("",!0),C("span",Me,[f()?(s(),h(e(x),{key:"using",label:"Using"},{default:a(()=>[t(e(R),{value:y.value.type==="user-defined"?y.value.using:U.value,disabled:!k(),onInput:d[6]||(d[6]=u=>p(u.target.value))},null,8,["value","disabled"])]),_:1})):D("",!0)])]),t(e(x),{key:"nullable",label:"Nullable"},{default:a(()=>[t(e(M),{checked:o.column.nullable,"onUpdate:checked":d[7]||(d[7]=u=>o.column.nullable=u)},null,8,["checked"])]),_:1}),t(e(x),{key:"unique",label:"Unique"},{default:a(()=>[t(e(M),{checked:o.column.unique,"onUpdate:checked":d[8]||(d[8]=u=>o.column.unique=u)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])}}});const He=Y(Ve,[["__scopeId","data-v-ed537625"]]),me=g=>(de("data-v-fbf27701"),g=g(),ce(),g),Qe={class:"table-settings"},Ge={key:0},Je=me(()=>C("span",null," protected ",-1)),We=[Je],Xe={key:1},Ye=["onClick"],Ze=me(()=>C("a",null,"Delete",-1)),et=K({__name:"TableColumns",props:{table:{},loading:{type:Boolean}},emits:["refresh"],setup(g,{emit:b}){var A;const n=g,l=z(n.loading);ve(()=>n.loading,()=>{l.value=n.loading});const _=ie();(A=n.table)==null||A.onUpdate(()=>{var p;_.replace({name:"tableEditor",params:{tableName:(p=n.table)==null?void 0:p.name}})});const c=[...[{title:"Name",dataIndex:"name",sorter:(p,k)=>p.name.localeCompare(k.name)},{title:"Type",dataIndex:"type",sorter:(p,k)=>p.type.localeCompare(k.type)},{title:"Default Value",dataIndex:"default",sorter:(p,k)=>{var U,N,o,d;return(d=(o=p.default)==null?void 0:o.localeCompare((N=(U=k.default)==null?void 0:U.toString())!=null?N:""))!=null?d:0}},{title:"Nullable",dataIndex:"nullable",sorter:(p,k)=>p.nullable.toString().localeCompare(k.nullable.toString())},{title:"Primary Key",dataIndex:"primaryKey",sorter:(p,k)=>p.primaryKey.toString().localeCompare(k.primaryKey.toString())}],{title:"Actions",key:"action"}],S=q(()=>{var p;return(p=n.table)==null?void 0:p.getColumns()});function I(){r.value={type:"idle"}}function f(){I(),l.value=!0,setTimeout(()=>{b("refresh")},500)}function y(){r.value={type:"creating"}}const r=z({type:"idle"});function v(p){var k,U;(U=(k=n.table)==null?void 0:k.getColumn(p))==null||U.delete(),l.value=!0,setTimeout(()=>{b("refresh")},500)}const i=p=>{var k,U,N;return(N=(U=(k=n.table)==null?void 0:k.getColumn(p))==null?void 0:U.protected)!=null?N:!1},E=p=>{if(!n.table)throw new Error("Table not found");r.value={type:"editing",column:n.table.getColumn(p)}};return(p,k)=>(s(),T("div",Qe,[t(e(ue),{columns:c,"data-source":S.value,bordered:"",loading:l.value,pagination:!1},{bodyCell:a(({column:U,text:N,record:o})=>[U.key!=="action"?(s(),T(O,{key:0},[$(P(N),1)],64)):(s(),T(O,{key:1},[i(o.id)?(s(),T("div",Ge,We)):(s(),T("div",Xe,[C("span",null,[C("a",{onClick:()=>E(o.id)},"Edit",8,Ye)]),t(e(fe),{type:"vertical"}),t(e(oe),{title:"Sure to delete?",onConfirm:d=>v(o.id)},{default:a(()=>[Ze]),_:2},1032,["onConfirm"])]))],64))]),footer:a(()=>[t(e(L),{type:"primary",onClick:y},{default:a(()=>[$("+ Add New Column")]),_:1})]),_:1},8,["data-source","loading"]),p.table&&r.value.type==="creating"?(s(),h(Oe,{key:0,open:"",table:n.table,onClose:I,onCancel:I,onCreated:f},null,8,["table"])):D("",!0),p.table&&r.value.type==="editing"?(s(),h(He,{key:1,column:r.value.column,open:"",table:p.table,onUpdated:f,onClose:I,onCancel:I},null,8,["column","table"])):D("",!0)]))}});const tt=Y(et,[["__scopeId","data-v-fbf27701"]]),ae=g=>(de("data-v-06f57b7a"),g=g(),ce(),g),at={class:"table-settings"},lt=ae(()=>C("h2",{class:"title"},"Table settings",-1)),nt=ae(()=>C("div",{class:"subtitle"},"Edit table metadata",-1)),ot={key:0,class:"table-presenter"},ut={class:"table-property-item"},st={class:"property-item"},rt={key:1},it={class:"change-warning"},dt={class:"section-title"},ct=ae(()=>C("div",{class:"section-body"}," Changing the table's name can possibly result in the break of running applications. ",-1)),pt={class:"table-name-value-input"},ft={key:0,class:"error"},mt=K({__name:"TableSettings",props:{table:{}},emits:["refresh"],setup(g,{emit:b}){const n=g,l=ne({error:"",editing:!1,loading:!1}),_=()=>l.editing=!0,w=()=>{n.table.resetChanges(),l.editing=!1,l.error=""},c=async()=>{l.error="",l.loading=!0;try{await S()}catch(f){f instanceof Error&&(F("Database error",f.message),l.error=f.message)}l.error||(l.editing=!1),l.loading=!1},S=async()=>{if(!n.table.name){l.error="Table name cannot be empty";return}try{await n.table.save(),b("refresh")}catch(f){f instanceof Error&&(F("Database error",f.message),l.error=f.message)}},I=f=>{n.table.name=f.target.value};return(f,y)=>{var v;const r=G("icon");return s(),T("div",at,[lt,nt,l.editing?(s(),T("div",rt,[C("div",it,[C("div",dt,[t(r,{path:e(Ie),width:"12",height:"12",fill:"#D35249"},null,8,["path"]),$(" Be careful ")]),ct]),t(e(V),{direction:"vertical"},{default:a(()=>[C("div",pt,[t(e(R),{value:f.table.name,type:"text",onInput:I,onBlur:y[0]||(y[0]=i=>f.table.fixTraillingName())},null,8,["value"])]),l.error?(s(),T("div",ft,[t(r,{path:e(Ue),fill:"#D35249",width:"12",height:"12"},null,8,["path"]),$(" "+P(l.error),1)])):D("",!0),t(e(V),null,{default:a(()=>[t(e(L),{onClick:w},{default:a(()=>[$("Cancel")]),_:1}),t(e(L),{type:"primary",disabled:!f.table.hasChangesDeep("name"),onClick:c},{default:a(()=>[$(" Save Changes "),l.loading?(s(),h(Te,{key:0,size:"16"})):D("",!0)]),_:1},8,["disabled"])]),_:1})]),_:1})])):(s(),T("div",ot,[C("div",ut,[C("div",st,"Name: "+P((v=f.table)==null?void 0:v.name),1)]),t(e(L),{onClick:_},{default:a(()=>[$("Edit Name")]),_:1})]))])}}});const vt=Y(mt,[["__scopeId","data-v-06f57b7a"]]),Rt=K({__name:"TableEditor",setup(g){const b=ie(),n=ye(),l=n.params.tableId,_=n.params.projectId,w=z("data"),{result:c,loading:S,refetch:I}=Z(()=>Promise.all([he.get(_).then(async r=>{const v=await ke.get(r.organizationId);return{project:r,organization:v}}),ge.get(_,l)]).then(([{project:r,organization:v},i])=>be({project:r,organization:v,table:i}))),f=q(()=>!S.value&&c.value?[{label:"My organizations",path:"/organizations"},{label:c.value.organization.name,path:`/organizations/${c.value.organization.id}`},{label:c.value.project.name,path:`/projects/${c.value.project.id}/tables`}]:void 0);function y(){b.push({name:"tables",params:{projectId:_}})}return(r,v)=>{const i=G("router-link");return s(),h(_e,null,{navbar:a(()=>{var E;return[t(e(Ee),{title:(E=e(c))==null?void 0:E.table.name,style:{padding:"5px 10px"},onBack:y},{footer:a(()=>[t(e(xe),{"active-key":w.value,"onUpdate:activeKey":v[0]||(v[0]=A=>w.value=A)},{default:a(()=>[t(e(W),{key:"data",tab:"Data"}),t(e(W),{key:"columns",tab:"Columns"}),t(e(W),{key:"settings",tab:"Settings"})]),_:1},8,["active-key"])]),breadcrumb:a(()=>[f.value?(s(),h(e(Ae),{key:0},{default:a(()=>[(s(!0),T(O,null,Q(f.value,(A,p)=>(s(),h(e(Be),{key:p},{default:a(()=>[t(i,{to:A.path},{default:a(()=>[$(P(A.label),1)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1})):D("",!0)]),_:1},8,["title"])]}),content:a(()=>[e(c)&&w.value==="data"?(s(),h(Re,{key:0,loading:e(S),table:e(c).table},null,8,["loading","table"])):D("",!0),e(c)&&w.value==="columns"?(s(),h(tt,{key:1,table:e(c).table,loading:e(S),onRefresh:v[1]||(v[1]=E=>e(I)())},null,8,["table","loading"])):D("",!0),e(c)&&w.value==="settings"?(s(),h(vt,{key:2,table:e(c).table,loading:e(S),onRefresh:v[2]||(v[2]=E=>e(I)())},null,8,["table","loading"])):D("",!0)]),_:1})}}});export{Rt as default};
//# sourceMappingURL=TableEditor.1005f138.js.map
