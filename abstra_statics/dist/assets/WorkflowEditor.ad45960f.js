var Mt=Object.defineProperty;var $t=(a,e,t)=>e in a?Mt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var c=(a,e,t)=>($t(a,typeof e!="symbol"?e+"":e,t),t);import{_ as Dt}from"./SaveButton.vue_vue_type_script_setup_true_lang.ab554b59.js";import{W as Ae}from"./workspaces.8d43ecb9.js";import{L as bt}from"./LoadingContainer.37ee70ce.js";import{d as U,a0 as z,y as S,b as d,eV as y,dy as Re,eX as k,e_ as ze,e as T,c as x,w as g,eW as we,u as l,ay as J,bd as re,f,am as _,cV as P,bf as At,E as te,fc as Ht,f7 as Rt,r as K,D as W,o as pt,R as zt,O as Vt,cY as Y,f3 as Q,bx as oe,f4 as b,aC as Ft,cH as Te,bF as Lt,eZ as le,f2 as de,cG as Ot,ah as Gt,x as ce,e$ as Kt,f0 as Bt,cz as X,cB as Ut}from"./outputWidgets.b2b061b0.js";import{v as mt,a as ft,n as Ie,b as Zt,c as Wt,d as jt,e as Jt}from"./validations.9e0c677e.js";import{F as dt}from"./PhArrowSquareOut.vue.40e36064.js";import{s as Ne,w as B}from"./metadata.a8600bb4.js";import"./index.96cd801a.js";import{A as ct}from"./index.036b0867.js";import{A as ut,F as qt}from"./Form.23c83df3.js";import{C as Ce}from"./Card.96452527.js";import{B as Yt}from"./Badge.e8820c22.js";import{M as Qt}from"./Modal.efa7d4c5.js";import{W as Xt}from"./api.6eb22480.js";import{u as es}from"./uuid.cb4b30c3.js";import{a as ts}from"./asyncComputed.1796ada2.js";import{U as ss}from"./UnsavedChangesHandler.e3c6de81.js";import{A as is}from"./index.8c9a1ec3.js";import"./runnerData.21e159c0.js";import"./url.35c2be06.js";import"./record.dda5b97a.js";import"./pubsub.e372caf5.js";import"./string.c9070e4b.js";import"./PhCheckCircle.vue.491c6201.js";import"./PhKanban.vue.92984ea8.js";import"./PhScroll.vue.6e0bde3c.js";import"./PhWebhooksLogo.vue.87e4d328.js";import"./hasIn.88026ffe.js";import"./TabPane.411d2692.js";import"./PlusOutlined.cf52d035.js";import"./isNumeric.75337b1e.js";import"./ExclamationCircleOutlined.a9073a3a.js";(function(){try{var a=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(a._sentryDebugIds=a._sentryDebugIds||{},a._sentryDebugIds[e]="a5a84ed3-689a-4f3f-b8f7-00d1c4932afc",a._sentryDebugIdIdentifier="sentry-dbid-a5a84ed3-689a-4f3f-b8f7-00d1c4932afc")}catch{}})();const as=["width","height","fill","transform"],ns={key:0},rs=T("path",{d:"M208.49,152.49l-72,72a12,12,0,0,1-17,0l-72-72a12,12,0,0,1,17-17L116,187V40a12,12,0,0,1,24,0V187l51.51-51.52a12,12,0,0,1,17,17Z"},null,-1),os=[rs],ls={key:1},ds=T("path",{d:"M200,144l-72,72L56,144Z",opacity:"0.2"},null,-1),cs=T("path",{d:"M207.39,140.94A8,8,0,0,0,200,136H136V40a8,8,0,0,0-16,0v96H56a8,8,0,0,0-5.66,13.66l72,72a8,8,0,0,0,11.32,0l72-72A8,8,0,0,0,207.39,140.94ZM128,204.69,75.31,152H180.69Z"},null,-1),us=[ds,cs],hs={key:2},gs=T("path",{d:"M205.66,149.66l-72,72a8,8,0,0,1-11.32,0l-72-72A8,8,0,0,1,56,136h64V40a8,8,0,0,1,16,0v96h64a8,8,0,0,1,5.66,13.66Z"},null,-1),ps=[gs],ms={key:3},fs=T("path",{d:"M204.24,148.24l-72,72a6,6,0,0,1-8.48,0l-72-72a6,6,0,0,1,8.48-8.48L122,201.51V40a6,6,0,0,1,12,0V201.51l61.76-61.75a6,6,0,0,1,8.48,8.48Z"},null,-1),ys=[fs],vs={key:4},Ss=T("path",{d:"M205.66,149.66l-72,72a8,8,0,0,1-11.32,0l-72-72a8,8,0,0,1,11.32-11.32L120,196.69V40a8,8,0,0,1,16,0V196.69l58.34-58.35a8,8,0,0,1,11.32,11.32Z"},null,-1),ws=[Ss],Ts={key:5},Is=T("path",{d:"M202.83,146.83l-72,72a4,4,0,0,1-5.66,0l-72-72a4,4,0,0,1,5.66-5.66L124,206.34V40a4,4,0,0,1,8,0V206.34l65.17-65.17a4,4,0,0,1,5.66,5.66Z"},null,-1),xs=[Is],_s={name:"PhArrowDown"},ht=U({..._s,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(a){const e=a,t=z("weight","regular"),s=z("size","1em"),i=z("color","currentColor"),n=z("mirrored",!1),r=S(()=>{var u;return(u=e.weight)!=null?u:t}),o=S(()=>{var u;return(u=e.size)!=null?u:s}),v=S(()=>{var u;return(u=e.color)!=null?u:i}),w=S(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:n?"scale(-1, 1)":void 0);return(u,h)=>(d(),y("svg",ze({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:o.value,height:o.value,fill:v.value,transform:w.value},u.$attrs),[Re(u.$slots,"default"),r.value==="bold"?(d(),y("g",ns,os)):r.value==="duotone"?(d(),y("g",ls,us)):r.value==="fill"?(d(),y("g",hs,ps)):r.value==="light"?(d(),y("g",ms,ys)):r.value==="regular"?(d(),y("g",vs,ws)):r.value==="thin"?(d(),y("g",Ts,xs)):k("",!0)],16,as))}}),ks=["width","height","fill","transform"],Ps={key:0},Es=T("path",{d:"M236,144a68.07,68.07,0,0,1-68,68H80a12,12,0,0,1,0-24h88a44,44,0,0,0,0-88H61l27.52,27.51a12,12,0,0,1-17,17l-48-48a12,12,0,0,1,0-17l48-48a12,12,0,1,1,17,17L61,76H168A68.08,68.08,0,0,1,236,144Z"},null,-1),Ns=[Es],Cs={key:1},Ms=T("path",{d:"M80,40v96L32,88Z",opacity:"0.2"},null,-1),$s=T("path",{d:"M168,80H88V40a8,8,0,0,0-13.66-5.66l-48,48a8,8,0,0,0,0,11.32l48,48A8,8,0,0,0,88,136V96h80a48,48,0,0,1,0,96H80a8,8,0,0,0,0,16h88a64,64,0,0,0,0-128ZM72,116.69,43.31,88,72,59.31Z"},null,-1),Ds=[Ms,$s],bs={key:2},As=T("path",{d:"M232,144a64.07,64.07,0,0,1-64,64H80a8,8,0,0,1,0-16h88a48,48,0,0,0,0-96H88v40a8,8,0,0,1-13.66,5.66l-48-48a8,8,0,0,1,0-11.32l48-48A8,8,0,0,1,88,40V80h80A64.07,64.07,0,0,1,232,144Z"},null,-1),Hs=[As],Rs={key:3},zs=T("path",{d:"M230,144a62.07,62.07,0,0,1-62,62H80a6,6,0,0,1,0-12h88a50,50,0,0,0,0-100H46.49l37.75,37.76a6,6,0,1,1-8.48,8.48l-48-48a6,6,0,0,1,0-8.48l48-48a6,6,0,0,1,8.48,8.48L46.49,82H168A62.07,62.07,0,0,1,230,144Z"},null,-1),Vs=[zs],Fs={key:4},Ls=T("path",{d:"M232,144a64.07,64.07,0,0,1-64,64H80a8,8,0,0,1,0-16h88a48,48,0,0,0,0-96H51.31l34.35,34.34a8,8,0,0,1-11.32,11.32l-48-48a8,8,0,0,1,0-11.32l48-48A8,8,0,0,1,85.66,45.66L51.31,80H168A64.07,64.07,0,0,1,232,144Z"},null,-1),Os=[Ls],Gs={key:5},Ks=T("path",{d:"M228,144a60.07,60.07,0,0,1-60,60H80a4,4,0,0,1,0-8h88a52,52,0,0,0,0-104H41.66l41.17,41.17a4,4,0,0,1-5.66,5.66l-48-48a4,4,0,0,1,0-5.66l48-48a4,4,0,0,1,5.66,5.66L41.66,84H168A60.07,60.07,0,0,1,228,144Z"},null,-1),Bs=[Ks],Us={name:"PhArrowUUpLeft"},Zs=U({...Us,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(a){const e=a,t=z("weight","regular"),s=z("size","1em"),i=z("color","currentColor"),n=z("mirrored",!1),r=S(()=>{var u;return(u=e.weight)!=null?u:t}),o=S(()=>{var u;return(u=e.size)!=null?u:s}),v=S(()=>{var u;return(u=e.color)!=null?u:i}),w=S(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:n?"scale(-1, 1)":void 0);return(u,h)=>(d(),y("svg",ze({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:o.value,height:o.value,fill:v.value,transform:w.value},u.$attrs),[Re(u.$slots,"default"),r.value==="bold"?(d(),y("g",Ps,Ns)):r.value==="duotone"?(d(),y("g",Cs,Ds)):r.value==="fill"?(d(),y("g",bs,Hs)):r.value==="light"?(d(),y("g",Rs,Vs)):r.value==="regular"?(d(),y("g",Fs,Os)):r.value==="thin"?(d(),y("g",Gs,Bs)):k("",!0)],16,ks))}}),Ws=["width","height","fill","transform"],js={key:0},Js=T("path",{d:"M167.51,127.51,195,100H88a44,44,0,0,0,0,88h88a12,12,0,0,1,0,24H88A68,68,0,0,1,88,76H195L167.51,48.49a12,12,0,1,1,17-17l48,48a12,12,0,0,1,0,17l-48,48a12,12,0,0,1-17-17Z"},null,-1),qs=[Js],Ys={key:1},Qs=T("path",{d:"M224,88l-48,48V40Z",opacity:"0.2"},null,-1),Xs=T("path",{d:"M172.94,143.39a8,8,0,0,0,8.72-1.73l48-48a8,8,0,0,0,0-11.32l-48-48A8,8,0,0,0,168,40V80H88a64,64,0,0,0,0,128h88a8,8,0,0,0,0-16H88a48,48,0,0,1,0-96h80v40A8,8,0,0,0,172.94,143.39ZM184,59.31,212.69,88,184,116.69Z"},null,-1),ei=[Qs,Xs],ti={key:2},si=T("path",{d:"M168,136V96H88a48,48,0,0,0,0,96h88a8,8,0,0,1,0,16H88A64,64,0,0,1,88,80h80V40a8,8,0,0,1,13.66-5.66l48,48a8,8,0,0,1,0,11.32l-48,48A8,8,0,0,1,168,136Z"},null,-1),ii=[si],ai={key:3},ni=T("path",{d:"M171.76,131.76,209.51,94H88a50,50,0,0,0,0,100h88a6,6,0,0,1,0,12H88A62,62,0,0,1,88,82H209.51L171.76,44.24a6,6,0,0,1,8.48-8.48l48,48a6,6,0,0,1,0,8.48l-48,48a6,6,0,0,1-8.48-8.48Z"},null,-1),ri=[ni],oi={key:4},li=T("path",{d:"M170.34,130.34,204.69,96H88a48,48,0,0,0,0,96h88a8,8,0,0,1,0,16H88A64,64,0,0,1,88,80H204.69L170.34,45.66a8,8,0,0,1,11.32-11.32l48,48a8,8,0,0,1,0,11.32l-48,48a8,8,0,0,1-11.32-11.32Z"},null,-1),di=[li],ci={key:5},ui=T("path",{d:"M173.17,133.17,214.34,92H88a52,52,0,0,0,0,104h88a4,4,0,0,1,0,8H88A60,60,0,0,1,88,84H214.34L173.17,42.83a4,4,0,0,1,5.66-5.66l48,48a4,4,0,0,1,0,5.66l-48,48a4,4,0,0,1-5.66-5.66Z"},null,-1),hi=[ui],gi={name:"PhArrowUUpRight"},pi=U({...gi,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(a){const e=a,t=z("weight","regular"),s=z("size","1em"),i=z("color","currentColor"),n=z("mirrored",!1),r=S(()=>{var u;return(u=e.weight)!=null?u:t}),o=S(()=>{var u;return(u=e.size)!=null?u:s}),v=S(()=>{var u;return(u=e.color)!=null?u:i}),w=S(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:n?"scale(-1, 1)":void 0);return(u,h)=>(d(),y("svg",ze({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:o.value,height:o.value,fill:v.value,transform:w.value},u.$attrs),[Re(u.$slots,"default"),r.value==="bold"?(d(),y("g",js,qs)):r.value==="duotone"?(d(),y("g",Ys,ei)):r.value==="fill"?(d(),y("g",ti,ii)):r.value==="light"?(d(),y("g",ai,ri)):r.value==="regular"?(d(),y("g",oi,di)):r.value==="thin"?(d(),y("g",ci,hi)):k("",!0)],16,Ws))}});function yt(a,e,t,s={}){a.strokeStyle=s.color||"black",a.lineWidth=t/3,a.lineJoin="round",a.lineCap="round";const i=Math.atan2(e.p2.y-e.p1.y,e.p2.x-e.p1.x);a.beginPath(),a.moveTo(e.p1.x,e.p1.y),a.lineTo(e.p2.x,e.p2.y),a.moveTo(e.p2.x-t*Math.cos(i-Math.PI/6),e.p2.y-t*Math.sin(i-Math.PI/6)),a.lineTo(e.p2.x,e.p2.y),a.lineTo(e.p2.x-t*Math.cos(i+Math.PI/6),e.p2.y-t*Math.sin(i+Math.PI/6)),a.stroke()}function mi(a){return vi(a.p1,a.p2)}function O(a,e){return{dx:e.x-a.x,dy:e.y-a.y,referential:a.referential}}function ee(a,e){return{referential:a.referential,x:a.x+e.dx,y:a.y+e.dy}}function fi(a,e){return{referential:a.referential,dx:a.dx*e,dy:a.dy*e}}function ue(a,e,t){const{x:s,y:i,width:n,height:r}=t,{dx:o,dy:v}=e,{x:w,y:u}=a,h=(s-w)/o,m=(s+n-w)/o,N=(i-u)/v,H=(i+r-u)/v,L=Math.max(Math.min(h,m),Math.min(N,H));return{x:w+L*o,y:u+L*v,referential:a.referential}}function yi(a,e){const t=He(a),s=He(e),i=ue(s,O(s,t),a),n=ue(t,O(t,s),e);return{p1:i,p2:n}}function He(a){return{x:a.x+a.width/2,y:a.y+a.height/2,referential:a.referential}}const ve=a=>a.reduce((e,t)=>{const s=e?Math.min(e.x,t.x):t.x,i=e?Math.min(e.y,t.y):t.y,n=e?Math.max(e.x+e.width,t.x+t.width):t.x+t.width,r=e?Math.max(e.y+e.height,t.y+t.height):t.y+t.height;return{x:s,y:i,width:n-s,height:r-i,referential:t.referential}},null);function vi(a,e){return Math.sqrt((a.x-e.x)**2+(a.y-e.y)**2)}function vt(a,e){const{p1:t,p2:s}=a,i=Math.atan2(s.y-t.y,s.x-t.x),n=e*Math.sin(i),o={dx:e*Math.cos(i),dy:n,referential:t.referential},v=ee(t,o),w=ee(s,fi(o,-1));return{p1:v,p2:w}}function gt(a,e){return{referential:a.referential,x:a.x-e,y:a.y-e,width:a.width+2*e,height:a.height+2*e}}const St="#ababab",Ve="#e55b70",Se=15,Fe=10;function xe(a,e){const t=a.getStageRect(e.id);return t?{x:t.x+t.width/2,y:t.y+t.height/2,referential:"screen"}:a.camera.worldPoint2screen({...e.position,referential:"world"})}function he(a,e){const t=a.getStageRect(e.id);if(t)return t;{const s=xe(a,e);return{x:s.x-100/2,y:s.y-100/2,width:100,height:100,referential:"screen"}}}function wt(a,e){const t=a.model.getStage(e.sourceStageId),s=a.model.getStage(e.targetStageId);if(!t)throw new Error(`Source node ${e.sourceStageId} not found`);if(!s)throw new Error(`Target node ${e.targetStageId} not found`);const i=xe(a,t),n=xe(a,s),r=ue(i,O(i,n),he(a,s));return{p1:ue(r,O(r,i),he(a,t)),p2:r}}function Si(a,e){const t=a.model.getTransition(e);if(!t)throw new Error(`Transition ${e} not found`);const s=wt(a,t);return{x:Math.min(s.p1.x,s.p2.x),y:Math.min(s.p1.y,s.p2.y),width:Math.abs(s.p1.x-s.p2.x),height:Math.abs(s.p1.y-s.p2.y),referential:"screen"}}function wi(a,e){const t=a.selection.has(e),s=Fe*a.camera.zoom,i=a.model.getStage(e.sourceStageId),n=a.model.getStage(e.targetStageId);if(!i)throw new Error(`Source node ${e.sourceStageId} not found`);if(!n)throw new Error(`Target node ${e.targetStageId} not found`);const r=gt(he(a,i),Se*a.camera.zoom),o=gt(he(a,n),Se*a.camera.zoom),v=yi(r,o);mi(v)<Se*a.camera.zoom||yt(a.ctx,v,s,{color:t?Ve:St})}function Ti(a){for(const e of a.selection.selectedStages())if(a.mouseState.snappedTarget)Tt(a,{id:"",sourceStageId:e.id,targetStageId:a.mouseState.snappedTarget.id,props:{conditionValue:null}});else{const t=xe(a,e),s=ue(a.mouseState.mousePos,O(a.mouseState.mousePos,t),he(a,e)),i=a.mouseState.mousePos,r=vt({p1:s,p2:i},Se*a.camera.zoom);yt(a.ctx,r,Fe*a.camera.zoom,{color:St})}}function Tt(a,e){const t=a.model.getStage(e.sourceStageId),s=a.model.getStage(e.targetStageId);if(!t)throw new Error(`Source node ${e.sourceStageId} not found`);if(!s)throw new Error(`Target node ${e.targetStageId} not found`);wi(a,e);const i=a.getTransitionRect(e.id);i&&a.ctx.clearRect(i.x,i.y,i.width,i.height)}function It(a,e){const t=wt(a,e),s=vt(t,Fe*a.camera.zoom*Math.sin(Math.PI/6));return{x:(t.p1.x+s.p2.x)/2,y:(t.p1.y+s.p2.y)/2,referential:"screen"}}function Ii(a,e){var i;const t=a.model.getStage(e.sourceStageId);if(!t)throw new Error(`Source node ${e.sourceStageId} not found`);const s=t.type;if(!s.includes("conditions")&&!s.includes("iterators"))throw new Error("Source node is not a flow controller");return(i=t.props)==null?void 0:i.variableName}function xi(a,e){var i;const t=a.model.getStage(e.sourceStageId);if(!t)throw new Error(`Source node ${e.sourceStageId} not found`);const s=t.type;if(!s.includes("conditions")&&!s.includes("iterators"))throw new Error("Source node is not a flow controller");return(i=t.props)==null?void 0:i.itemName}const _i={class:"menu-item"},ki={class:"menu-item"},Pi={class:"menu-item"},Ei={class:"menu-item"},Ni={class:"menu-item"},Ci=U({__name:"selection",props:{gui:{}},emits:["add-transition","duplicate-stages","revert-transitions","edit-stage","edit-transition","delete"],setup(a,{emit:e}){const t=a,s=S(()=>t.gui.selection.selectedIds().length===t.gui.selection.selectedStages().length),i=S(()=>t.gui.selection.selectedIds().length===t.gui.selection.selectedTransitions().length),n=S(()=>t.gui.selection.selectedIds().length>1||t.gui.selection.selectedIds().length===1&&t.gui.selection.selectedTransitions().length>0),r=S(()=>t.gui.selection.selectedIds().length===1),o=S(()=>t.gui.selection.selectedTransitions().some(R=>R.type.includes("iterators"))),v=S(()=>t.gui.selection.selectedIds().length>0&&t.gui.mouseState.showMenu);function w(){const E=t.gui.selection.selectedStages(),R=E.map(M=>t.gui.getStageRect(M.id)),I=t.gui.selection.selectedTransitions();return(I.length>1||E.length>0)&&R.push(...I.map(M=>Si(t.gui,M.id))),ve(R)}const u=S(()=>{const E=w();if(!E)if(i.value&&r.value){const I=t.gui.selection.selectedTransitions()[0],M=It(t.gui,I);return{menu:{transform:`translate(${M.x+50}px, ${M.y-10}px) scale(${t.gui.camera.zoom}) `,transformOrigin:"top left"},hull:{}}}else return{menu:{display:"none"},hull:{display:"none"}};const R={x:E.x+E.width+10,y:E.y,referential:"screen"};return{menu:{transform:`translate(${R.x}px, ${R.y}px)`,transformOrigin:"top left"},hull:{position:"absolute",top:`${E.y}px`,left:`${E.x}px`,width:`${E.width}px`,height:`${E.height}px`,pointerEvents:"none",border:`1px dashed ${Ve}`,boxSizing:"border-box"}}}),h=()=>e("add-transition"),m=()=>{s.value?e("edit-stage"):i.value&&e("edit-transition")},N=()=>e("duplicate-stages"),H=()=>e("delete"),L=()=>e("revert-transitions");return(E,R)=>(d(),y(J,null,[v.value?(d(),x(l(At),{key:0,class:"selection-menu",style:we(u.value.menu)},{default:g(()=>[s.value?(d(),x(l(re),{key:0,onClick:h},{default:g(()=>[T("div",_i,[f(l(P),null,{default:g(()=>[_("Add transition")]),_:1}),f(l(P),{keyboard:""},{default:g(()=>[_("T")]),_:1})])]),_:1})):k("",!0),r.value&&!o.value?(d(),x(l(re),{key:1,onClick:m},{default:g(()=>[T("div",ki,[f(l(P),null,{default:g(()=>[_("Edit")]),_:1}),f(l(P),{keyboard:""},{default:g(()=>[_("Enter")]),_:1})])]),_:1})):k("",!0),s.value?(d(),x(l(re),{key:2,onClick:N},{default:g(()=>[T("div",Pi,[f(l(P),null,{default:g(()=>[_("Duplicate")]),_:1}),f(l(P),{keyboard:""},{default:g(()=>[_("D")]),_:1})])]),_:1})):k("",!0),f(l(re),{onClick:H},{default:g(()=>[T("div",Ei,[f(l(P),null,{default:g(()=>[_("Delete")]),_:1}),f(l(P),{keyboard:""},{default:g(()=>[_("Del")]),_:1})])]),_:1}),i.value?(d(),x(l(re),{key:3,onClick:L},{default:g(()=>[T("div",Ni,[f(l(P),null,{default:g(()=>[_("Revert")]),_:1}),f(l(P),{keyboard:""},{default:g(()=>[_("R")]),_:1})])]),_:1})):k("",!0)]),_:1},8,["style"])):k("",!0),n.value?(d(),y("div",{key:1,class:"selection-hull",style:we(u.value.hull)},null,4)):k("",!0)],64))}});const Mi=te(Ci,[["__scopeId","data-v-e90ee0e9"]]),fe=12;function _e(a){return{x:Math.round(a.x/fe)*fe,y:Math.round(a.y/fe)*fe,referential:"world"}}function $i(a,e){const t=a.camera.screenPoint2world(e),s=_e(t);return a.camera.worldPoint2screen(s)}function Di(a,e){const t={...e.position,referential:"world"},s=a.camera.worldPoint2screen(t);return a.selection.has(e)?$i(a,ee(s,O(a.mouseState.initialMousePos,a.mouseState.mousePos))):s}const bi={key:1,class:"title-text"},Ai={key:0},Hi={key:1},Ri={key:0,style:{"margin-top":"8px"}},zi={style:{width:"24px",height:"24px"}},Vi={style:{width:"24px",height:"24px"}},Fi=U({__name:"stage",props:{stage:{},gui:{},workspace:{}},emits:["change"],setup(a,{emit:e}){var rt,ot,lt;const t=a;Ht(p=>({d647f878:l(Ve)}));const s=Rt();function i(p){return p.type!=="conditions"&&p.type!=="iterators"}const n=()=>{const p=s.resolve({path:`/_editor/${t.stage.type.slice(0,-1)}/${t.stage.id}`});window.open(p.href,"_blank")},r=K(!0),o=W.exports.debounce(async p=>{Ae.checkFile(p).then(C=>{r.value=C.exists})},500),v=S(()=>{const p=mt(A.value);return p.valid?r.value?{valid:!0,help:"This file already exists, stage will point to it."}:{valid:!0,help:"File doesn't exist yet. It will be created."}:p}),w=K("idle"),u=async()=>{if(w.value="creating",t.stage.type==="conditions"||t.stage.type==="iterators")return;e("change","filename",A.value),await t.workspace.initFile(A.value,t.stage.type),r.value=!0;const p=await Ae.checkFile(A.value);r.value=p.exists,w.value="idle"},h=p=>{p!==void 0&&e("change","title",p)},m=()=>{const p=Ie(G.value);G.value=p,I(p)},N=()=>{const p=Ie(pe.value);pe.value=p,M(p)},H=S(()=>{if(t.stage.type!=="conditions"&&t.stage.type!=="iterators")return{validateStatus:"success",help:""};const p=ft(G.value);return p.valid?{validateStatus:"success",help:""}:{validateStatus:"error",help:p.reason}}),L=S(()=>H.value.validateStatus==="error"),E=S(()=>!r.value),R=S(()=>{if(L.value)return"red";if(E.value)return"gold"}),I=p=>{!p||e("change","variableName",p)},M=p=>{!p||e("change","itemName",p)},Z=K(t.stage.title),A=K((rt=t.stage.props.filename)!=null?rt:""),G=K((ot=t.stage.props.variableName)!=null?ot:""),pe=K((lt=t.stage.props.itemName)!=null?lt:""),Pt=S(()=>t.gui.selection.has(t.stage)),me=S(()=>{var p;return t.gui.mouseState.state==="STAGE_QUICK_EDIT"&&((p=t.gui.mouseState.stage)==null?void 0:p.id)===t.stage.id}),Ee=S(()=>t.stage.type==="conditions"||t.stage.type==="iterators"),Et=S(()=>{const p=Di(t.gui,t.stage);return{transform:`translate(${p.x}px, ${p.y}px) scale(${t.gui.camera.zoom}) translate(-50%, -50%)`,transformOrigin:"top left"}}),Nt=()=>{t.stage.type==="conditions"||t.stage.type==="iterators"||o(A.value)};let nt;pt(()=>{nt=setInterval(Nt,1e3)}),zt(()=>{clearInterval(nt)}),Vt(()=>t.stage.props.filename,()=>{e("change","filename",A.value)});const Ct=()=>{w.value="prompting",A.value=Zt(Z.value),e("change","filename",A.value)};return(p,C)=>(d(),y("div",{class:le(["stage-card",{selected:Pt.value,editing:me.value}]),style:we(Et.value),tabindex:"0"},[me.value?(d(),x(l(Ce),{key:0,class:le(["card","editing",{bodyLess:!Ee.value&&r.value}])},{title:g(()=>[f(l(Y),{justify:"space-between",align:"center"},{default:g(()=>[f(l(Y),{align:"center"},{default:g(()=>[f(l(Y),null,{default:g(()=>[(d(),x(Q(l(Ne)(p.stage.type))))]),_:1}),i(p.stage)?(d(),x(l(oe),{key:0,value:Z.value,"onUpdate:value":C[0]||(C[0]=D=>Z.value=D),bordered:!1,class:"title-input",onInput:C[1]||(C[1]=D=>h(D.target.value))},null,8,["value"])):(d(),y("span",bi,b(p.stage.title),1))]),_:1}),Ee.value?k("",!0):(d(),x(l(Ft),{key:0},{title:g(()=>[p.gui.model.stageHasNonPositionChanges(p.stage.id)?(d(),y("span",Hi,"Save to allow edit in "+b(p.stage.type)+" editor",1)):(d(),y("span",Ai," Edit more in "+b(p.stage.type)+" editor ",1))]),default:g(()=>[p.gui.model.stageHasNonPositionChanges(p.stage.id)?(d(),x(l(dt),{key:1,style:{opacity:"0.5",cursor:"default"}})):(d(),x(l(dt),{key:0,onClick:n}))]),_:1}))]),_:1})]),default:g(()=>[Ee.value?(d(),x(l(Te),{key:0,direction:"vertical",size:4,style:{width:"100%"}},{default:g(()=>[f(l(ut),{"validate-status":H.value.validateStatus},{default:g(()=>[f(l(P),null,{default:g(()=>[_("Variable name")]),_:1}),f(l(oe),{value:G.value,"onUpdate:value":C[2]||(C[2]=D=>G.value=D),onChange:C[3]||(C[3]=D=>I(D.target.value)),onBlur:m},null,8,["value"]),p.stage.type==="iterators"?(d(),y("div",Ri,[f(l(P),null,{default:g(()=>[_("Item name")]),_:1}),f(l(oe),{value:pe.value,"onUpdate:value":C[4]||(C[4]=D=>pe.value=D),onChange:C[5]||(C[5]=D=>M(D.target.value)),onBlur:N},null,8,["value"])])):k("",!0),H.value.validateStatus==="error"?(d(),x(l(ct),{key:1,type:"error","show-icon":"",message:H.value.help,style:{"margin-top":"10px"}},null,8,["message"])):k("",!0)]),_:1},8,["validate-status"])]),_:1})):k("",!0),r.value?k("",!0):(d(),x(l(ct),{key:1,type:"warning","show-icon":""},{message:g(()=>[f(l(P),null,{default:g(()=>[_(" Python file is missing. ")]),_:1})]),action:g(()=>[f(l(Lt),{size:"small",onClick:Ct},{default:g(()=>[_("Create")]),_:1})]),_:1}))]),_:1},8,["class"])):k("",!0),!me.value&&(L.value||E.value)?(d(),x(l(Yt),{key:1,count:"!",color:R.value},{default:g(()=>[f(l(Ce),{class:"card",style:{"max-width":"300px"}},{default:g(()=>[f(l(Y),{align:"center",gap:"small"},{default:g(()=>[T("span",zi,[(d(),x(Q(l(Ne)(p.stage.type)),{size:"22"}))]),f(l(P),{content:p.stage.title,ellipsis:!0,style:{width:"100%"}},null,8,["content"])]),_:1})]),_:1})]),_:1},8,["color"])):k("",!0),!me.value&&!L.value&&!E.value?(d(),x(l(Ce),{key:2,class:"card"},{default:g(()=>[f(l(Y),{align:"center",gap:"small"},{default:g(()=>[T("span",Vi,[(d(),x(Q(l(Ne)(p.stage.type)),{size:"22"}))]),f(l(P),{content:p.stage.title,ellipsis:!0,style:{width:"100%"}},null,8,["content"])]),_:1})]),_:1})):k("",!0),f(l(Qt),{open:w.value==="prompting"||w.value==="creating",closable:!1,"confirm-loading":w.value==="creating",onOk:u,onCancel:C[7]||(C[7]=D=>w.value="idle")},{default:g(()=>[f(l(qt),{layout:"vertical",disabled:w.value=="creating"},{default:g(()=>[f(l(ut),{label:"You're creating a new file. What should it be called?","validate-status":v.value.valid?"success":"error",help:v.value.valid?v.value.help:v.value.reason},{default:g(()=>[f(l(oe),{value:A.value,"onUpdate:value":C[6]||(C[6]=D=>A.value=D)},null,8,["value"])]),_:1},8,["validate-status","help"])]),_:1},8,["disabled"])]),_:1},8,["open","confirm-loading"])],6))}});const Li=te(Fi,[["__scopeId","data-v-efc42549"]]),Oi={key:2},Gi={key:3},Ki={key:4,style:{"line-height":"80%"}},Bi=U({__name:"transition",props:{transition:{},gui:{}},emits:["change"],setup(a,{emit:e}){const t=a,s=I=>{e("change","type",String(I))},i=I=>{!I||e("change","conditionValue",I)},n=t.gui.model.getStage(t.transition.sourceStageId);if(!n)throw new Error(`No source stage found for transition ${t.transition.id}`);const r=B.stages.find(I=>I.typeName===n.type),o=S(()=>{const I=r==null?void 0:r.transitions.find(M=>M.typeName===t.transition.type);if(!I)throw new Error(`No metadata found for transition ${t.transition.type}`);return I.title}),v=S(()=>!H.value&&!N.value?"":Ii(t.gui,t.transition)),w=S(()=>{var I;return N.value&&((I=t.transition.props)==null?void 0:I.conditionValue)||""}),u=S(()=>H.value?xi(t.gui,t.transition):""),h=S(()=>{var I;return t.gui.mouseState.state!=="CHANGING_TRANSITION_TYPE"?!1:((I=t.gui.mouseState.transition)==null?void 0:I.id)===t.transition.id}),m=S(()=>{var I;return t.gui.mouseState.state!=="TRANSITION_QUICK_EDIT"?!1:((I=t.gui.mouseState.transition)==null?void 0:I.id)===t.transition.id}),N=S(()=>t.transition.type.includes("conditions")),H=S(()=>t.transition.type.includes("iterators")),L=S(()=>t.gui.selection.has(t.transition)),E=S(()=>{var I,M;return t.gui.mouseState.state!=="CHANGING_TRANSITION_TYPE"?"":(M=t.gui.mouseState.transitionDraft.type)!=null?M:(I=t.gui.mouseState.transition)==null?void 0:I.type}),R=S(()=>{const I=It(t.gui,t.transition);return{transform:`translate(${I.x}px, ${I.y}px) scale(${t.gui.camera.zoom}) translate(-50%, -50%)`,transformOrigin:"top left",padding:m.value?"6px":"0"}});return(I,M)=>(d(),y("div",{class:le(["transition-card",{selected:L.value}]),style:we(R.value),tabindex:"0"},[h.value?(d(),x(l(Te),{key:0,class:"editing"},{default:g(()=>[f(l(Gt),{class:"selector","default-value":E.value,"onUpdate:value":s},{default:g(()=>{var Z,A;return[(d(!0),y(J,null,de((A=(Z=l(r))==null?void 0:Z.transitions)!=null?A:[],G=>(d(),x(l(Ot),{key:G.typeName},{default:g(()=>[(d(),x(Q(G.icon))),_(" "+b(G.title),1)]),_:2},1024))),128))]}),_:1},8,["default-value"])]),_:1})):m.value&&N.value?(d(),x(l(Te),{key:1,class:"editing"},{default:g(()=>[f(l(oe),{style:{width:"200px"},"default-value":w.value,onChange:M[0]||(M[0]=Z=>i(Z.target.value))},{addonBefore:g(()=>[_("= ")]),_:1},8,["default-value"])]),_:1})):N.value?(d(),y("span",Oi,[f(l(P),{code:""},{default:g(()=>[_(b(v.value),1)]),_:1}),_(" = "+b(w.value),1)])):H.value?(d(),y("span",Gi,[_(" for "),f(l(P),{code:""},{default:g(()=>[_(b(u.value),1)]),_:1}),_(" in "),f(l(P),{code:""},{default:g(()=>[_(b(v.value),1)]),_:1})])):(d(),y("span",Ki,b(o.value),1))],6))}});const Ui=te(Bi,[["__scopeId","data-v-25b85ae7"]]);class Le{static get isMac(){return navigator.userAgent.includes("Mac OS X")}static get buildPlatform(){return{}.CURRENT_PLATFORM||"web"}}const Me=a=>Le.isMac&&a.ctrlKey,j=a=>Le.isMac?a.metaKey:a.ctrlKey,Zi=a=>a.altKey,F=a=>a.shiftKey,$e={alt:Zi,"arrow-up":a=>a.code==="ArrowUp","arrow-down":a=>a.code==="ArrowDown","arrow-left":a=>a.code==="ArrowLeft","arrow-right":a=>a.code==="ArrowRight",ctrl:j,delete:a=>Le.isMac?a.code==="Backspace":a.code==="Delete",enter:a=>a.code==="Enter",escape:a=>a.code==="Escape",shift:F,space:a=>a.code==="Space",a:a=>a.code==="KeyA",b:a=>a.code==="KeyB",c:a=>a.code==="KeyC",d:a=>a.code==="KeyD",f:a=>a.code==="KeyF",g:a=>a.code==="KeyG",h:a=>a.code==="KeyH",k:a=>a.code==="KeyK",p:a=>a.code==="KeyP",v:a=>a.code==="KeyV",x:a=>a.code==="KeyX",z:a=>a.code==="KeyZ",0:a=>a.code==="Digit0","[":a=>a.code==="BracketLeft","]":a=>a.code==="BracketRight"};class Wi{constructor(e){c(this,"pressedKeys");c(this,"evt");this.evt=e,this.pressedKeys={};const t=s=>i=>{Object.keys($e).forEach(n=>{$e[n](i)&&this.setPressed(n,s)})};this.evt||(window.addEventListener("keydown",t(!0)),window.addEventListener("keyup",t(!1)))}setPressed(e,t){this.pressedKeys[e]=t}isPressed(e){var t;return this.evt?$e[e](this.evt):(t=this.pressedKeys[e])!=null?t:!1}}new Wi;class ji{constructor(e){c(this,"selected");this.model=e,this.selected=ce([])}deselect(e){this.selected.value=this.selected.value.filter(t=>t.type==="stage"?!e.includes(t.stage.id):!e.includes(t.transition.id))}select(e,t=!1){t||(this.selected.value=[]),e.forEach(s=>{const i=this.model.getStage(s);i&&(this.selected.value=[...this.selected.value,{type:"stage",stage:i}]);const n=this.model.getTransition(s);if(n&&(this.selected.value=[...this.selected.value,{type:"transition",transition:n}]),!i&&!n)throw new Error(`Could not find stage or transition with id ${s}`)})}clear(){this.selected.value=[]}selectedStages(){return this.selected.value.map(e=>e.type==="stage"?this.model.getStage(e.stage.id):null).filter(Boolean)}selectedTransitions(){return this.selected.value.map(e=>e.type==="transition"?this.model.getTransition(e.transition.id):null).filter(Boolean)}selectedIds(){return this.selected.value.map(e=>e.type==="stage"?e.stage.id:e.transition.id)}has(e){return this.selected.value.some(t=>t.type==="stage"?t.stage.id===e.id:t.transition.id===e.id)}isEmpty(){return this.selected.value.length===0}selectAllStages(){this.select(this.model.getState().stages.map(e=>e.id))}}const ye={left:100,right:100,top:100,bottom:100},De=1,be=.5;class Oe{constructor(e){c(this,"_state");c(this,"projectedElement");this._state=K({x:0,y:0,zoom:1}),this.projectedElement=e}get x(){return this._state.value.x}set x(e){if(Number.isNaN(e))throw new Error("x is NaN");this._state.value.x=e}get y(){return this._state.value.y}set y(e){if(Number.isNaN(e))throw new Error("y is NaN");this._state.value.y=e}static create(e){return new Oe(e)}get zoom(){return this._state.value.zoom}set zoom(e){if(e<=0)throw new Error("Zoom must be positive");this._state.value.zoom=e}fit(e){const t={x:e.x+e.width/2,y:e.y+e.height/2,referential:"world"},s=this.screenRect2world(this.canvasRect);this.x=t.x-s.width/2,this.y=t.y-s.height/2;const i=this.canvasRect.width-ye.left-ye.right,n=this.canvasRect.height-ye.top-ye.bottom,r=Math.min(i/e.width,n/e.height)/this.zoom;this.zoomIn(Math.min(De/this.zoom,Math.max(be/this.zoom,r)),this.worldPoint2screen(t))}screenPoint2world(e){return{x:e.x/this.zoom+this.x,y:e.y/this.zoom+this.y,referential:"world"}}worldPoint2screen(e){return{x:(e.x-this.x)*this.zoom,y:(e.y-this.y)*this.zoom,referential:"screen"}}screenDelta2world(e){return{dx:e.dx/this.zoom,dy:e.dy/this.zoom,referential:"world"}}worldDelta2screen(e){return{dx:e.dx*this.zoom,dy:e.dy*this.zoom,referential:"screen"}}screenRect2world(e){const t=this.screenPoint2world({x:e.x,y:e.y,referential:e.referential}),s=this.screenPoint2world({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:s.x-t.x,height:s.y-t.y,referential:t.referential}}worldRect2screen(e){const t=this.worldPoint2screen({x:e.x,y:e.y,referential:e.referential}),s=this.worldPoint2screen({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:s.x-t.x,height:s.y-t.y,referential:t.referential}}zoomIn(e,t){const s=this.screenPoint2world(t);this.zoom*e>De?this.zoom=De:this.zoom*e<be?this.zoom=be:this.zoom*=e;const i=this.worldPoint2screen(s),n=O(t,i),r=this.screenDelta2world({dx:n.dx,dy:n.dy,referential:"screen"});this.x+=r.dx,this.y+=r.dy}translate(e){this.x+=e.dx,this.y+=e.dy}get canvasRect(){if(!this.projectedElement)throw new Error("No canvas element");const e=this.projectedElement.getBoundingClientRect();return{x:e.x,y:e.y,width:e.width,height:e.height,referential:"screen"}}}class V{constructor(e,t,s,i,n){c(this,"state");c(this,"mousePos");c(this,"initialMousePos");c(this,"camera");c(this,"selection");c(this,"model");c(this,"stage",null);c(this,"transition",null);c(this,"stageDraft",{});c(this,"transitionDraft",{});c(this,"pivot");c(this,"editing",!1);c(this,"snappedTarget",null);c(this,"showMenu",!1);this.state=e,this.mousePos=t,this.initialMousePos=t,this.camera=s,this.selection=i,this.model=n}computeCursorStyle(){return"grab"}onMouseMove(e){return this}onMouseUp(){return this}onDragover(e){return this}onDrop(e){return this}onMouseDown(e,t,s,i){return this}onHoverEnter(e,t){return this}onHoverLeave(){return this}saveChanges(){return this}setStageDraft(e,t){}setTransitionDraft(e,t){}}const Ji="PANNING";class se extends V{constructor(t,s,i,n,r){super(Ji,t,i,n,r);c(this,"initialMousePos");this.initialMousePos=s}static create(t,s,i,n,r){return new se(t,s,i,n,r)}computeCursorStyle(){return"grabbing"}onMouseMove(t){const s=O(t,this.mousePos),i=this.camera.screenDelta2world(s);return this.camera.translate(i),this.mousePos=t,this}onMouseUp(){return $.create(this.mousePos,this.camera,this.selection,this.model)}onMouseDown(t){return this.initialMousePos=t,this.mousePos=t,this.selection.clear(),this}}const qi="MOVING";class ge extends V{constructor(t,s,i,n,r,o){super(qi,t,n,r,o);c(this,"initialMousePos");c(this,"duplicating");this.initialMousePos=s,this.duplicating=i,this.pivot=r.selectedStages().length===1?r.selectedStages()[0]:void 0}static create(t,s,i,n,r,o){return new ge(t,s,i,n,r,o)}computeCursorStyle(){return"move"}onMouseMove(t){return ge.create(t,this.initialMousePos,this.duplicating,this.camera,this.selection,this.model)}onMouseUp(){const t=this.camera.screenPoint2world(this.initialMousePos),s=this.camera.screenPoint2world(this.mousePos),i=O(t,s);return this.duplicating?(this.model.move(this.selection.selectedStages().map(n=>({id:n.id,position:ee({...n.position,referential:"world"},i)}))),$.create(this.mousePos,this.camera,this.selection,this.model)):(this.model.move(this.selection.selectedStages().map(n=>({id:n.id,position:_e(ee({...n.position,referential:"world"},i))}))),this.pivot?ae.create(this.mousePos,this.pivot,this.camera,this.selection,this.model):$.create(this.mousePos,this.camera,this.selection,this.model))}onMouseDown(t,s,i,n){return this.duplicating?this:(this.selection.clear(),se.create(t,this.initialMousePos,this.camera,this.selection,this.model))}getScreenPos(t){const s={...t.position,referential:"world"},i=this.camera.worldPoint2screen(s),n=ee(i,O(this.initialMousePos,this.mousePos)),r=this.camera.screenPoint2world(n),o=_e(r);return this.camera.worldPoint2screen(o)}}const Yi="JUST_CLICKED_STAGE";class ie extends V{constructor(t,s,i,n,r){super(Yi,t,i,n,r);c(this,"stage");this.stage=s}static create(t,s,i,n,r){return new ie(t,s,i,n,r)}computeCursorStyle(){return"default"}onMouseMove(t){return ge.create(t,this.mousePos,!1,this.camera,this.selection,this.model)}onMouseUp(){return ae.create(this.mousePos,this.stage,this.camera,this.selection,this.model)}}const Qi="HOVERING_STAGE";class ae extends V{constructor(t,s,i,n,r){super(Qi,t,i,n,r);c(this,"stage");this.stage=s,this.showMenu=!0}static create(t,s,i,n,r){return new ae(t,s,i,n,r)}computeCursorStyle(){return"pointer"}onMouseDown(t,s,i){return this.selection.has(i)||this.selection.select([i.id],F(s)),s.button!==0?this:ie.create(t,i,this.camera,this.selection,this.model)}onHoverLeave(){return $.create(this.mousePos,this.camera,this.selection,this.model)}}const Xi="JUST_CLICKED_TRANSITION";class ne extends V{constructor(t,s,i,n,r){super(Xi,t,i,n,r);c(this,"transition");this.transition=s}static create(t,s,i,n,r){return new ne(t,s,i,n,r)}computeCursorStyle(){return"default"}onMouseUp(){return ke.create(this.mousePos,this.transition,this.camera,this.selection,this.model)}}const ea="HOVERING_TRANSITION";class ke extends V{constructor(t,s,i,n,r){super(ea,t,i,n,r);c(this,"initialMousePos");c(this,"transition");this.transition=s,this.initialMousePos=t,this.showMenu=!0}static create(t,s,i,n,r){return new ke(t,s,i,n,r)}computeCursorStyle(){return"pointer"}onMouseDown(t,s,i,n){return n?(this.selection.select([n.id],F(s)),ne.create(t,n,this.camera,this.selection,this.model)):(this.selection.clear(),se.create(t,t,this.camera,this.selection,this.model))}onHoverLeave(){return $.create(this.mousePos,this.camera,this.selection,this.model)}}const ta="IDLE";class $ extends V{constructor(e,t,s,i){super(ta,e,t,s,i),this.showMenu=!0}static create(e,t,s,i){return new $(e,t,s,i)}onMouseDown(e){return this.selection.clear(),se.create(e,e,this.camera,this.selection,this.model)}onHoverEnter(e,t){return e?ae.create(this.mousePos,e,this.camera,this.selection,this.model):t?ke.create(this.mousePos,t,this.camera,this.selection,this.model):this}}const sa="ADDING_STAGES";class Ge extends V{constructor(t,s,i,n,r){super(sa,t,i,n,r);c(this,"stages");c(this,"keepAdding",t=>{this.mousePos=t,this.stages=this.stages.map(s=>({...s,position:_e(this.camera.screenPoint2world(t))}))});c(this,"finishAdding",t=>{this.keepAdding(t);const s=this.model.addStages(this.stages);this.selection.select(s.map(i=>i.id))});this.stages=s}static create(t,s,i,n,r){return new Ge(t,s,i,n,r)}computeCursorStyle(){return"grab"}onMouseMove(t){return this.keepAdding(t),this}onDragover(t){return this.keepAdding(t),this}onDrop(t){return this.finishAdding(t),$.create(this.mousePos,this.camera,this.selection,this.model)}onMouseDown(t){return this.finishAdding(t),$.create(this.mousePos,this.camera,this.selection,this.model)}}const ia="ADDING_TRANSITION";class Ke extends V{constructor(t,s,i,n,r,o){super(ia,t,n,r,o);c(this,"initialMousePos");c(this,"snappedTarget");this.initialMousePos=s,this.snappedTarget=i}static create(t,s,i,n,r,o){return new Ke(t,s,i,n,r,o)}computeCursorStyle(){return"crosshair"}onMouseMove(t){return this.mousePos=t,this}onMouseDown(t,s,i){if(i){const n=this.snappedTarget;if(!n)return this;const r=this.selection.selectedStages().map(o=>({sourceStageId:o.id,targetStageId:n.id}));return this.model.addTransitions(r),this.selection.select([n.id]),ae.create(t,i,this.camera,this.selection,this.model)}return this.selection.clear(),se.create(t,t,this.camera,this.selection,this.model)}onHoverEnter(t){return t&&(this.snappedTarget=t),this}onHoverLeave(){return this.snappedTarget=null,this}}const aa="CHANGING_TRANSITION_TYPE";class Be extends V{constructor(t,s,i,n,r){super(aa,t,i,n,r);c(this,"initialMousePos");c(this,"transition");this.transition=s,this.initialMousePos=t,this.editing=!0}static create(t,s,i,n,r){return new Be(t,s,i,n,r)}onMouseDown(t,s,i,n){return n&&this.transition.id===n.id?this:(this.saveChanges(),i?(this.selection.select([i.id],F(s)),ie.create(t,i,this.camera,this.selection,this.model)):n?(this.selection.select([n.id],F(s)),ne.create(t,n,this.camera,this.selection,this.model)):(this.selection.clear(),$.create(this.mousePos,this.camera,this.selection,this.model)))}saveChanges(){return this.transitionDraft.type&&this.model.updateTransitionType(this.transition.id,this.transitionDraft.type),$.create(this.mousePos,this.camera,this.selection,this.model)}setTransitionDraft(t,s){this.transitionDraft={...this.transitionDraft,[t]:s}}}const na="STAGE_QUICK_EDIT";class Ue extends V{constructor(t,s,i,n,r){super(na,t,i,n,r);c(this,"initialMousePos");c(this,"stage");this.stage=s,this.initialMousePos=t,this.editing=!0}static create(t,s,i,n,r){return new Ue(t,s,i,n,r)}onMouseDown(t,s,i,n){return i&&this.stage.id===i.id?this:(this.saveChanges(),i?(this.selection.select([i.id],F(s)),ie.create(t,i,this.camera,this.selection,this.model)):n?(this.selection.select([n.id],F(s)),ne.create(t,n,this.camera,this.selection,this.model)):(this.selection.clear(),$.create(this.mousePos,this.camera,this.selection,this.model)))}saveChanges(){return this.stageDraft.title&&this.model.updateStageTitle(this.stage.id,this.stageDraft.title),this.stageDraft.props&&this.model.updateStageProps(this.stage.id,{...this.stage.props,...this.stageDraft.props}),$.create(this.mousePos,this.camera,this.selection,this.model)}setStageDraft(t,s){if(t==="title"){this.stageDraft={...this.stageDraft,title:s};return}let i=s;(t==="variableName"||t==="itemName")&&(i=Ie(s)),this.stageDraft={...this.stageDraft,props:{...this.stageDraft.props,[t]:i}}}}const ra="TRANSITION_QUICK_EDIT";class Ze extends V{constructor(t,s,i,n,r){super(ra,t,i,n,r);c(this,"initialMousePos");c(this,"transition");this.transition=s,this.initialMousePos=t,this.editing=!0}static create(t,s,i,n,r){return new Ze(t,s,i,n,r)}onMouseDown(t,s,i,n){return n&&this.transition.id===n.id?this:(this.saveChanges(),i?(this.selection.select([i.id],F(s)),ie.create(t,i,this.camera,this.selection,this.model)):n?(this.selection.select([n.id],F(s)),ne.create(t,n,this.camera,this.selection,this.model)):(this.selection.clear(),$.create(this.mousePos,this.camera,this.selection,this.model)))}saveChanges(){return this.transitionDraft.conditionValue&&this.model.updateTransitionProps(this.transition.id,{conditionValue:this.transitionDraft.conditionValue}),$.create(this.mousePos,this.camera,this.selection,this.model)}setTransitionDraft(t,s){this.transitionDraft={...this.transitionDraft,[t]:s}}}class We{constructor(e,t){c(this,"_mouseState");c(this,"selection");c(this,"canvas");c(this,"ctx");c(this,"camera");c(this,"model");this.canvas=e,this.model=t,this.selection=new ji(t),this.camera=Oe.create(e),this._mouseState=ce($.create({x:0,y:0,referential:"screen"},this.camera,this.selection,this.model));const s=e.getContext("2d");if(!s)throw new Error("Unable to get canvas context");this.ctx=s}static create(e,t){const s=new We(e,t);return s.init(),s}get mouseState(){return this._mouseState.value}set mouseState(e){this._mouseState.value=e,this.canvas.style.cursor=e.computeCursorStyle()}goToIdle(){this.mouseState=$.create(this.mouseState.mousePos,this.camera,this.selection,this.model)}fixSize(){const{width:e,height:t}=this.canvas.getBoundingClientRect();this.canvas.width=e*devicePixelRatio,this.canvas.height=t*devicePixelRatio,this.ctx.scale(devicePixelRatio,devicePixelRatio)}setUpGlobalKeyDown(){let e=null;addEventListener("mousemove",t=>e=t),window.addEventListener("keydown",t=>{if(!!e&&!this.mouseState.editing)if(t.key==="t"||t.key==="T")this.selection.selectedStages().length&&this.startAddingTransition();else if(t.key==="f"||t.key==="F")this.dragstart("forms",e);else if(t.key==="h"||t.key==="H")this.dragstart("hooks",e);else if(t.key==="j"||t.key==="J")this.dragstart("jobs",e);else if(t.key==="c"||t.key==="C")this.dragstart("conditions",e);else if(t.key==="i"||t.key==="I")this.dragstart("iterators",e);else if(t.key==="s"||t.key==="S"){if(j(t))return;this.dragstart("scripts",e)}else(t.key==="z"||t.key==="Z")&&j(t)?(F(t)?this.model.history.redo():this.model.history.undo(),t.preventDefault()):(t.key==="a"||t.key==="A")&&j(t)?(this.selection.selectAllStages(),t.preventDefault()):(t.key==="Delete"||t.key==="Backspace")&&this.deleteSelection()})}setupMousemove(){const e=t=>{const s=this.getScreenPointerFromEvent(t);this.mouseState=this.mouseState.onMouseMove(s)};addEventListener("mousemove",e)}setupMouseup(){const e=()=>{this.mouseState=this.mouseState.onMouseUp()};addEventListener("mouseup",e)}setupDragover(){const e=t=>{t.preventDefault();const s=this.getScreenPointerFromEvent(t);this.mouseState=this.mouseState.onDragover(s)};this.canvas.addEventListener("dragover",e)}setupDrop(){const e=t=>{t.stopPropagation();const s=this.getScreenPointerFromEvent(t);this.mouseState=this.mouseState.onDrop(s)};this.canvas.addEventListener("drop",e)}setupWheel(){var t;const e=s=>{if(!this.camera)return;const i=this.getScreenPointerFromEvent(s);if(j(s)||Me(s))this.computeZoomIn(i,s.deltaY>0?.9:1.1),s.preventDefault();else{const n=F(s)?{dx:s.deltaY,dy:0}:{dx:s.deltaX,dy:s.deltaY},r=this.camera.screenDelta2world({dx:n.dx,dy:n.dy,referential:"screen"});this.camera.translate(r)}s.stopPropagation()};(t=this.canvas.parentElement)==null||t.addEventListener("wheel",e)}setupMousedown(){const e=t=>{const s=this.getScreenPointerFromEvent(t);this.mouseState=this.mouseState.onMouseDown(s,t)};this.canvas.addEventListener("mousedown",e)}computeZoomIn(e,t){this.camera.zoomIn(t,e)}startEditingSelection(){if(this.selection.selectedStages().length!==1)return;const e=this.selection.selectedStages()[0];this.startEditingStage(e)}duplicateSelection(){const e=this.model.duplicateStages([...this.selection.selectedStages()]),t=He(ve(e.stages.map(i=>({x:i.position.x,y:i.position.y,width:1,height:1,referential:"world"})))),s=this.camera.worldPoint2screen(t);return this.mouseState=ge.create(this.mouseState.mousePos,s,!0,this.camera,this.selection,this.model),e}duplicateThenSelect(){const t=this.duplicateSelection().stages.map(s=>s.id);this.selection.select(t)}getScreenPointerFromEvent(e){const t=this.canvas.getBoundingClientRect();return{x:e.pageX-t.x,y:e.pageY-t.y,referential:"screen"}}async deleteSelection(){this.model.delete(this.selection.selectedIds()),this.clearSelection(),this.goToIdle()}startHoveringStage(e){this.mouseState=this.mouseState.onHoverEnter(e)}stageMouseDown(e,t){const s=this.getScreenPointerFromEvent(e);this.mouseState=this.mouseState.onMouseDown(s,e,t)}finishHoveringStage(){this.mouseState=this.mouseState.onHoverLeave()}startEditingStage(e){this.mouseState=Ue.create(this.mouseState.mousePos,e,this.camera,this.selection,this.model)}startChangingTransitionSelection(){if(this.selection.selectedTransitions().length!==1)return;const e=this.selection.selectedTransitions()[0];this.startChangingTransition(e)}computeChangeStage(e,t){this.mouseState.setStageDraft(e,t)}computeKeyDownStage(e){if(e.key==="Enter"&&this.mouseState.state==="STAGE_QUICK_EDIT"){this.mouseState=this.mouseState.saveChanges();return}this.mouseState.editing||(e.key==="t"||e.key==="T"?this.startAddingTransition():e.key==="Enter"?this.selection.selectedStages().length===1&&this.startEditingStage(this.selection.selectedStages()[0]):e.key==="d"||e.key==="D"?this.duplicateThenSelect():e.key==="Delete"||e.key==="Backspace"?this.deleteSelection():(e.key==="a"||e.key==="A")&&(j(e)||Me(e))?(this.selection.select(this.model.getState().stages.map(t=>t.id)),e.preventDefault()):e.key==="Escape"&&(this.clearSelection(),this.goToIdle()))}transitionMouseDown(e,t){this.mouseState=this.mouseState.onMouseDown(this.getScreenPointerFromEvent(e),e,void 0,t)}startHoveringTransition(e){this.mouseState=this.mouseState.onHoverEnter(void 0,e)}finishHoveringTransition(){this.mouseState=this.mouseState.onHoverLeave()}computeChangeTransition(e,t){this.mouseState.setTransitionDraft(e,t)}startAddingTransition(){this.mouseState=Ke.create(this.mouseState.mousePos,this.mouseState.mousePos,null,this.camera,this.selection,this.model)}revertTransitions(){this.selection.selectedTransitions().forEach(t=>this.model.revertTransition(t.id))}startChangingTransition(e){this.mouseState=this.mouseState.saveChanges();const t=this.model.getStage(e.sourceStageId);(t==null?void 0:t.type)!=="iterators"&&((t==null?void 0:t.type)==="conditions"?this.mouseState=Ze.create(this.mouseState.mousePos,e,this.camera,this.selection,this.model):this.mouseState=Be.create(this.mouseState.mousePos,e,this.camera,this.selection,this.model))}computeKeyDownTransition(e){if(e.key==="Enter"&&this.mouseState.state==="TRANSITION_QUICK_EDIT"||this.mouseState.state==="CHANGING_TRANSITION_TYPE"){this.mouseState=this.mouseState.saveChanges();return}e.key==="Enter"?this.selection.selectedTransitions().length===1&&this.startChangingTransition(this.selection.selectedTransitions()[0]):e.key==="Delete"||e.key==="Backspace"?this.deleteSelection():e.key==="a"&&(j(e)||Me(e))?(this.selection.select(this.model.getState().stages.map(t=>t.id)),e.preventDefault()):e.key==="r"||e.key==="R"?this.revertTransitions():e.key==="Escape"&&(this.clearSelection(),this.goToIdle())}getStageRect(e){var n,r,o,v;this.mouseState,this.camera.x,this.camera.y,this.camera.zoom;const t=(n=this.canvas.parentElement)==null?void 0:n.querySelector(`.items-container [data-type="stage"][data-id="${e}"]`),s=(r=t==null?void 0:t.getBoundingClientRect)==null?void 0:r.call(t),i=(v=(o=t==null?void 0:t.parentElement)==null?void 0:o.getBoundingClientRect)==null?void 0:v.call(o);return!i||!s?null:{x:s.x-i.x,y:s.y-i.y,width:s.width,height:s.height,referential:"screen"}}getTransitionRect(e){var n,r,o,v;const t=(n=this.canvas.parentElement)==null?void 0:n.querySelector(`.items-container [data-type="transition"][data-id="${e}"]`),s=(r=t==null?void 0:t.getBoundingClientRect)==null?void 0:r.call(t),i=(v=(o=t==null?void 0:t.parentElement)==null?void 0:o.getBoundingClientRect)==null?void 0:v.call(o);return!i||!s?null:{x:s.x-i.x,y:s.y-i.y,width:s.width,height:s.height,referential:"screen"}}renderAddTransition(){this.mouseState.state==="ADDING_TRANSITION"&&Ti(this)}debug(){this.ctx.fillText(`mouseState: ${JSON.stringify(this.mouseState,null,2)}`,10,10),this.ctx.fillText(`stageDraft: ${JSON.stringify(this.mouseState.stageDraft,null,2)}`,10,30),this.ctx.fillText(`selection: ${JSON.stringify(this.selection.selectedIds(),null,2)}`,10,50),this.ctx.fillText(`zoom: ${this.camera.zoom}`,10,90),this.ctx.fillText(`stage: ${JSON.stringify(this.mouseState.stage,null,2)}`,10,110),this.ctx.fillText(`transition: ${JSON.stringify(this.mouseState.transition,null,2)}`,10,130);const e=50,t=this.model.getState().stages.map(i=>({height:2*e,referential:"world",width:2*e,x:i.position.x-e,y:i.position.y-e})),s=ve(t);!s||this.ctx.fillText(`hull: ${JSON.stringify(s,null,2)}`,10,70)}renderTransitions(){this.model.getState().transitions.forEach(e=>{Tt(this,e)})}render(){try{this.fixSize(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderTransitions(),this.renderAddTransition()}finally{requestAnimationFrame(()=>this.render())}}fitCamera(){const t=this.model.getState().stages.map(i=>({height:100,referential:"world",width:100,x:i.position.x-50,y:i.position.y-50})),s=ve(t);!s||this.camera.fit(s)}init(){this.setUpGlobalKeyDown(),this.setupMousemove(),this.setupDragover(),this.setupMousedown(),this.setupDrop(),this.setupMouseup(),this.setupWheel(),this.render(),this.fitCamera()}clearSelection(){this.selection.clear()}dragstart(e,t){const s=this.getScreenPointerFromEvent(t);this.clearSelection();const i=[{type:e,position:this.camera.screenPoint2world(s)}];this.mouseState=Ge.create(s,i,this.camera,this.selection,this.model)}}const xt=a=>(Kt("data-v-1acf9439"),a=a(),Bt(),a),oa={class:"empty-hint"},la={key:0,class:"drag-hint"},da=xt(()=>T("div",{class:"title"},"Start here",-1)),ca={key:1,class:"drop-hint"},ua=xt(()=>T("div",{class:"title"},"Drop here",-1)),ha={key:2,class:"stages-hint"},ga={class:"header"},pa={class:"title"},ma={class:"description"},fa=U({__name:"EmptyHint",props:{gui:{}},setup(a){const e=a,t=S(()=>e.gui.model.getState().stages.length===0&&e.gui.mouseState.state!=="ADDING_NEW_STAGES"),s=S(()=>e.gui.model.getState().stages.length===0&&e.gui.mouseState.state==="ADDING_NEW_STAGES");return(i,n)=>(d(),y("div",oa,[t.value?(d(),y("div",la,[da,f(l(ht),{size:32,class:"arrow"})])):k("",!0),s.value?(d(),y("div",ca,[ua,f(l(ht),{size:32,class:"arrow"})])):k("",!0),t.value?(d(),y("div",ha,[(d(!0),y(J,null,de(l(B).stages,r=>(d(),y("div",{key:r.key,class:"stage-hint"},[T("div",ga,[(d(),x(Q(r.icon))),T("span",pa,b(r.title),1)]),T("div",ma,b(r.description),1)]))),128))])):k("",!0)]))}});const ya=te(fa,[["__scopeId","data-v-1acf9439"]]),va={class:"canvas-container"},Sa={key:0,class:"items-container"},wa=U({__name:"CanvasGui",props:{model:{},workspace:{}},setup(a,{expose:e}){const t=a,s=K(null),i=ce(null);e({gui:i}),pt(()=>{if(!s.value)throw new Error("canvas is null");i.value=We.create(s.value,t.model)});const n=S(()=>t.model.getState());return(r,o)=>{var v,w;return d(),y("div",va,[f(l(Zs),{size:20,class:le(["icon undo",{disabled:!((v=i.value)!=null&&v.model.history.canUndo())}]),onClick:o[0]||(o[0]=u=>{var h;return(h=i.value)==null?void 0:h.model.history.undo()})},null,8,["class"]),f(l(pi),{size:20,class:le(["icon redo",{disabled:!((w=i.value)!=null&&w.model.history.canRedo())}]),onClick:o[1]||(o[1]=u=>{var h;return(h=i.value)==null?void 0:h.model.history.redo()})},null,8,["class"]),T("canvas",{ref_key:"canvas",ref:s,class:"workflow-canvas",tabindex:"0"},null,512),i.value?(d(),y("div",Sa,[(d(!0),y(J,null,de(n.value.stages,u=>(d(),x(Li,{key:u.id,gui:i.value,workspace:r.workspace,"data-type":"stage","data-id":u.id,stage:u,onChange:o[2]||(o[2]=(h,m)=>{var N;return(N=i.value)==null?void 0:N.computeChangeStage(h,m)}),onMousedown:h=>{var m;return(m=i.value)==null?void 0:m.stageMouseDown(h,u)},onMouseenter:h=>{var m;return(m=i.value)==null?void 0:m.startHoveringStage(u)},onMouseleave:o[3]||(o[3]=h=>{var m;return(m=i.value)==null?void 0:m.finishHoveringStage()}),onKeydown:o[4]||(o[4]=h=>{var m;return(m=i.value)==null?void 0:m.computeKeyDownStage(h)}),onDblclick:h=>{var m;return(m=i.value)==null?void 0:m.startEditingStage(u)}},null,8,["gui","workspace","data-id","stage","onMousedown","onMouseenter","onDblclick"]))),128)),(d(!0),y(J,null,de(n.value.transitions,u=>(d(),x(Ui,{key:u.id,gui:i.value,"data-type":"transition","data-id":u.id,transition:u,onChange:o[5]||(o[5]=(h,m)=>{var N;return(N=i.value)==null?void 0:N.computeChangeTransition(h,m)}),onMousedown:h=>{var m;return(m=i.value)==null?void 0:m.transitionMouseDown(h,u)},onMouseenter:h=>{var m;return(m=i.value)==null?void 0:m.startHoveringTransition(u)},onMouseleave:o[6]||(o[6]=h=>{var m;return(m=i.value)==null?void 0:m.finishHoveringTransition()}),onDblclick:h=>{var m;return(m=i.value)==null?void 0:m.startChangingTransition(u)},onKeydown:o[7]||(o[7]=h=>{var m;return(m=i.value)==null?void 0:m.computeKeyDownTransition(h)})},null,8,["gui","data-id","transition","onMousedown","onMouseenter","onDblclick"]))),128)),f(Mi,{gui:i.value,onAddTransition:o[8]||(o[8]=u=>{var h;return(h=i.value)==null?void 0:h.startAddingTransition()}),onEditStage:o[9]||(o[9]=u=>{var h;return(h=i.value)==null?void 0:h.startEditingSelection()}),onEditTransition:o[10]||(o[10]=u=>{var h;return(h=i.value)==null?void 0:h.startChangingTransitionSelection()}),onRevertTransitions:o[11]||(o[11]=u=>{var h;return(h=i.value)==null?void 0:h.revertTransitions()}),onDuplicateStages:o[12]||(o[12]=u=>{var h;return(h=i.value)==null?void 0:h.duplicateThenSelect()}),onDelete:o[13]||(o[13]=u=>{var h;return(h=i.value)==null?void 0:h.deleteSelection()})},null,8,["gui"])])):k("",!0),i.value&&n.value.stages.length===0?(d(),x(ya,{key:1,gui:i.value},null,8,["gui"])):k("",!0)])}}});const Ta=te(wa,[["__scopeId","data-v-2189c148"]]);function je(){return Math.random().toString(36).slice(2,9)}class q{constructor(e){this.changes=e}apply(e){return this.changes.reduce((t,s)=>s.apply(t),e)}reverse(){return new q(this.changes.map(e=>e.reverse()).reverse())}}class _t{constructor(e){c(this,"removed");this.stageId=e,this.removed=null}apply(e){const t=e.stages.find(i=>i.id===this.stageId)||null;if(!t)throw new Error(`Stage ${this.stageId} not found`);const s=e.transitions.filter(i=>i.sourceStageId===this.stageId||i.targetStageId===this.stageId);return this.removed={stage:t,transitions:s},{stages:e.stages.filter(i=>i.id!==t.id),transitions:e.transitions.filter(i=>!s.find(n=>n.id===i.id))}}reverse(){if(!this.removed)throw new Error("Cannot reverse change that was not applied");const e=new Je(this.removed.stage.type,this.removed.stage.title,this.removed.stage.position,this.removed.stage.id,this.removed.stage.props),t=this.removed.transitions.map(s=>new Pe(s.sourceStageId,s.targetStageId,s.type,s.id));return new q([e,...t])}}class Je{constructor(e,t,s,i,n){c(this,"addedStage");this.stageType=e,this.nodeTitle=t,this.position=s,this.id=i,this.props=n,this.addedStage=null}assertStageDoesNotExist(e){if(e.stages.find(t=>t.id===this.id))throw new Error(`Stage ${this.id} already exists`)}assertValidStageType(){if(!B.stages.find(e=>e.typeName===this.stageType))throw new Error(`Invalid stage type ${this.stageType}`)}assertTransitionDoesNotExist(e){if(e.transitions.find(t=>t.sourceStageId===this.id||t.targetStageId===this.id))throw new Error("Stage already has transitions")}makePath(e){switch(this.stageType){case"forms":return`new-form-${e}`;case"hooks":return`new-hook-${e}`;default:return null}}makeFilename(e){switch(this.stageType){case"forms":return`new_form_${e}.py`;case"hooks":return`new_hook_${e}.py`;case"jobs":return`new_job_${e}.py`;case"scripts":return`new_script_${e}.py`;default:return null}}makeVariableName(){switch(this.stageType){case"conditions":return"my_condition";case"iterators":return"my_list";default:return null}}makeItemName(){switch(this.stageType){case"iterators":return"item";default:return null}}apply(e){var i,n,r;const t=je(),s=(i=this.props)!=null?i:{path:this.makePath(t),filename:this.makeFilename(t),variableName:this.makeVariableName(),itemName:this.makeItemName()};return this.nodeTitle=(n=this.makeVariableName())!=null?n:this.nodeTitle,this.assertStageDoesNotExist(e),this.assertValidStageType(),this.assertTransitionDoesNotExist(e),this.addedStage={id:(r=this.id)!=null?r:es(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:s},{transitions:e.transitions,stages:[...e.stages,this.addedStage]}}reverse(){if(!this.addedStage)throw new Error("Cannot reverse change that was not applied");return new _t(this.addedStage.id)}}class Ia extends q{constructor(e){super(e.map(t=>new Je(t.type,t.title,t.position,t.id)))}}class qe{constructor(e,t){c(this,"oldTitle");this.stageId=e,this.newTitle=t,this.oldTitle=""}apply(e){const t=e.stages.find(s=>s.id===this.stageId);if(!t)throw new Error(`Stage ${this.stageId} not found`);return this.oldTitle=t.title,{stages:e.stages.map(s=>s.id===this.stageId?{...s,title:this.newTitle}:s),transitions:e.transitions}}reverse(){return new qe(this.stageId,this.oldTitle)}}class kt{constructor(e){c(this,"removedTransition");this.transitionId=e,this.removedTransition=null}apply(e){const t=e.transitions.find(s=>s.id===this.transitionId);if(!t)throw new Error(`Transition ${this.transitionId} not found`);return this.removedTransition=t!=null?t:null,{stages:e.stages,transitions:e.transitions.filter(s=>s.id!==this.transitionId)}}reverse(){if(!this.removedTransition)throw new Error("Cannot reverse change that was not applied");return new Pe(this.removedTransition.sourceStageId,this.removedTransition.targetStageId,this.removedTransition.type,this.removedTransition.id)}}class Pe{constructor(e,t,s,i){c(this,"addedTransition");this.sourceStageId=e,this.targetStageId=t,this.transitionType=s,this.transitionId=i,this.addedTransition=null}assertSourceStageExists(e){if(!e.stages.find(t=>t.id===this.sourceStageId))throw new Error(`Stage ${this.sourceStageId} not found`)}assertTargetStageExists(e){if(!e.stages.find(t=>t.id===this.targetStageId))throw new Error(`Stage ${this.targetStageId} not found`)}assertTransitionDoesNotExist(e){if(e.transitions.find(t=>t.id===this.transitionId))throw new Error(`Transition ${this.transitionId} already exists`)}assertNotSelfTransition(){if(this.sourceStageId===this.targetStageId)throw new Error("Self transitions are not allowed")}assertNoDuplicatedTransitionStages(e){if(e.transitions.find(t=>t.sourceStageId===this.sourceStageId&&t.targetStageId===this.targetStageId))throw X.error({message:"Invalid transition",description:"Transition already exists"}),new Error("Transition already exists")}assertValidTransitionType(e){const t=e.stages.find(n=>n.id===this.sourceStageId);if(!B.stages.find(n=>n.typeName===t.type).transitions.map(n=>n.typeName).includes(this.transitionType))throw new Error(`Invalid transition type ${this.transitionType}`)}assertNotStartingOnlyTargetStage(e){const t=e.stages.find(i=>i.id===this.targetStageId);if(B.stages.find(i=>i.typeName===t.type).startingOnly)throw X.error({message:"Invalid transition",description:"Cannot transition to starting-only stage"}),new Error("Cannot transition to starting-only stage")}assertNoStageWithSameId(e){if(e.stages.find(t=>t.id===this.transitionId))throw new Error(`Stage with id ${this.transitionId} already exists`)}apply(e){var t;return this.assertSourceStageExists(e),this.assertTargetStageExists(e),this.assertTransitionDoesNotExist(e),this.assertNotSelfTransition(),this.assertNoDuplicatedTransitionStages(e),this.assertValidTransitionType(e),this.assertNotStartingOnlyTargetStage(e),this.assertNoStageWithSameId(e),this.addedTransition={id:(t=this.transitionId)!=null?t:je(),sourceStageId:this.sourceStageId,targetStageId:this.targetStageId,type:this.transitionType,props:{conditionValue:null}},{stages:e.stages,transitions:[...e.transitions,this.addedTransition]}}reverse(){if(!this.addedTransition)throw new Error("Cannot reverse change that was not applied");return new kt(this.addedTransition.id)}}class Ye{constructor(e){c(this,"transitionId");this.transitionId=e}assertValidTransitionType(e){const t=e.transitions.find(r=>r.id===this.transitionId),s=e.stages.find(r=>r.id===t.targetStageId);if(!B.stages.find(r=>r.typeName===s.type).transitions.map(r=>r.typeName).includes(t.type))throw X.error({message:"Error reverting",description:"This revert leads to some invalid transition"}),new Error("Invalid transition type")}apply(e){if(this.assertValidTransitionType(e),!e.transitions.find(s=>s.id===this.transitionId))throw new Error(`Transition ${this.transitionId} not found`);return{stages:e.stages,transitions:e.transitions.map(s=>s.id===this.transitionId?{...s,sourceStageId:s.targetStageId,targetStageId:s.sourceStageId}:s)}}reverse(){return new Ye(this.transitionId)}}class xa extends q{constructor(e){super(e.map(t=>new Pe(t.sourceStageId,t.targetStageId,t.type,t.id)))}}class Qe{constructor(e){c(this,"oldPositions");this.newPositions=e,this.oldPositions=null}assertStagesExists(e){this.newPositions.forEach(({id:t})=>{if(!e.stages.find(s=>s.id===t))throw new Error(`Stage ${t} not found`)})}assertIsNumber(){this.newPositions.forEach(({position:e})=>{if(Number.isNaN(e.x)||Number.isNaN(e.y)||!Number.isFinite(e.x)||!Number.isFinite(e.y))throw new Error("Position must be a number")})}apply(e){return this.assertIsNumber(),this.assertStagesExists(e),this.oldPositions=e.stages.map(s=>({id:s.id,position:s.position})),{stages:e.stages.map(s=>{var n,r;const i=(r=(n=this.newPositions.find(o=>o.id===s.id))==null?void 0:n.position)!=null?r:s.position;return{...s,position:{x:i.x,y:i.y}}}),transitions:e.transitions}}reverse(){if(!this.oldPositions)throw new Error("Cannot reverse change that was not applied");return new Qe(this.oldPositions)}}class Xe{constructor(e,t){c(this,"stageId");c(this,"newTitle");c(this,"oldTitle");this.stageId=e,this.newTitle=t,this.oldTitle=""}assertStageExists(e){if(!e.stages.find(t=>t.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}apply(e){return this.assertStageExists(e),this.oldTitle=e.stages.find(t=>t.id===this.stageId).title,{stages:e.stages.map(t=>t.id===this.stageId?{...t,title:this.newTitle}:t),transitions:e.transitions}}reverse(){return new Xe(this.stageId,this.oldTitle)}}class et{constructor(e,t){c(this,"stageId");c(this,"newProps");c(this,"oldProps");this.stageId=e,this.newProps=t,this.oldProps={path:null,filename:null,variableName:null,itemName:null}}assertStageExists(e){if(!e.stages.find(t=>t.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}assertValidVariableName(){if(!this.newProps.variableName)return;const e=this.newProps.variableName,t=ft(e);if(!t.valid){X.error({message:"Invalid variable name",description:t.reason});return}this.newProps.variableName=Ie(e)}assertValidPath(){if(!this.newProps.path)return;const e=Wt(this.newProps.path);if(!e.valid){X.error({message:"Invalid path",description:e.reason});return}this.newProps.path=jt(this.newProps.path)}assertValidFilename(){if(!this.newProps.filename)return;const e=mt(this.newProps.filename);if(!e.valid){X.error({message:"Invalid filename",description:e.reason});return}this.newProps.filename=Jt(this.newProps.filename)}apply(e){return this.assertStageExists(e),this.assertValidVariableName(),this.assertValidPath(),this.assertValidFilename(),this.oldProps=e.stages.find(t=>t.id===this.stageId).props,{stages:e.stages.map(t=>{var s;return t.id===this.stageId?{...t,title:(s=this.newProps.variableName)!=null?s:t.title,props:this.newProps}:t}),transitions:e.transitions}}reverse(){return new et(this.stageId,this.oldProps)}}class tt{constructor(e,t){c(this,"newType");c(this,"transitionId");c(this,"oldType");this.newType=t,this.transitionId=e,this.oldType=t}apply(e){return{transitions:e.transitions.map(t=>t.id===this.transitionId?(this.oldType=t.type,{...t,type:this.newType}):t),stages:e.stages}}reverse(){return new tt(this.transitionId,this.oldType)}}class st{constructor(e,t){c(this,"newProps");c(this,"transitionId");c(this,"oldProps");this.newProps=t,this.transitionId=e,this.oldProps=t}apply(e){return{transitions:e.transitions.map(t=>t.id===this.transitionId?(this.oldProps=t.props,{...t,props:this.newProps}):t),stages:e.stages}}reverse(){return new st(this.transitionId,this.oldProps)}}class _a{constructor(e){c(this,"change");this.duplicatedStages=e,this.change=null}assertStagesExists(e){this.duplicatedStages.forEach(t=>{if(!e.stages.find(s=>s.id===t.id))throw new Error(`Stage ${t.id} not found`)})}apply(e){this.assertStagesExists(e);const t=this.duplicatedStages.map(je),s=this.duplicatedStages.map((r,o)=>new Je(r.type,`${r.title} - Copy`,{x:r.position.x,y:r.position.y},t[o])),n=e.transitions.filter(r=>{const o=this.duplicatedStages.find(w=>w.id===r.sourceStageId),v=this.duplicatedStages.find(w=>w.id===r.targetStageId);return o&&v}).map(r=>{const o=t[this.duplicatedStages.findIndex(w=>w.id===r.sourceStageId)],v=t[this.duplicatedStages.findIndex(w=>w.id===r.targetStageId)];return new Pe(o,v,r.type)});return this.change=new q([...s,...n]),this.change.apply(e)}reverse(){if(!this.change)throw new Error("Cannot reverse change that was not applied");return this.change.reverse()}}class ka extends q{constructor(e,t){super([...t.map(s=>new kt(s)),...e.map(s=>new _t(s))])}}class it{constructor(e,t){c(this,"oldTransitionState");this.transitionId=e,this.newType=t,this.oldTransitionState=null}assertTransitionExists(e){if(!e.transitions.find(t=>t.id===this.transitionId))throw new Error(`Transition ${this.transitionId} not found`)}assertValidTransitionType(e){const t=e.transitions.find(r=>r.id===this.transitionId),s=e.stages.find(r=>r.id===t.sourceStageId);if(!B.stages.find(r=>r.typeName===s.type).transitions.map(r=>r.typeName).includes(this.newType))throw new Error(`Invalid transition type ${this.newType}`)}apply(e){this.assertTransitionExists(e),this.assertValidTransitionType(e);const t=e.transitions.find(s=>s.id===this.transitionId);return this.oldTransitionState=t,{stages:e.stages,transitions:e.transitions.map(s=>s.id===this.transitionId?{...s,type:this.newType}:s)}}reverse(){if(!this.oldTransitionState)throw new Error("Cannot reverse change that was not applied");return new it(this.transitionId,this.oldTransitionState.type)}}class Pa{constructor(e){c(this,"currentState");c(this,"serverState");c(this,"undoStack");c(this,"redoStack");this.undoStack=[],this.redoStack=[],this.currentState=ce(Object.freeze(e)),this.serverState=ce(Object.freeze(e))}apply(e){return this.currentState.value=e.apply(this.currentState.value),this.undoStack.push(e),this.redoStack=[],this.currentState.value}canUndo(){return this.undoStack.length>0}undo(){const e=this.undoStack.pop();if(e){const t=e.reverse();this.currentState.value=t.apply(this.currentState.value),this.redoStack.push(e)}return this.currentState.value}canRedo(){return this.redoStack.length>0}redo(){const e=this.redoStack.pop();return e&&(this.currentState.value=e.apply(this.currentState.value),this.undoStack.push(e)),this.currentState.value}getState(){return this.currentState.value}setServerState(e){this.serverState.value=e}getServerState(){return this.serverState.value}hasStageChanges(){return!W.exports.isEqual(this.currentState.value.stages,this.serverState.value.stages)}hasChanges(){const e={...this.currentState.value,stages:[...this.currentState.value.stages].sort((s,i)=>s.id.localeCompare(i.id)),transitions:[...this.currentState.value.transitions].sort((s,i)=>s.id.localeCompare(i.id))},t={...this.serverState.value,stages:[...this.serverState.value.stages].sort((s,i)=>s.id.localeCompare(i.id)),transitions:[...this.serverState.value.transitions].sort((s,i)=>s.id.localeCompare(i.id))};return!W.exports.isEqual(e,t)}stageHasChanges(e){const t=this.currentState.value.stages.find(i=>i.id===e),s=this.serverState.value.stages.find(i=>i.id===e);return!W.exports.isEqual(t,s)}stageHasNonPositionChanges(e){const t=this.currentState.value.stages.find(i=>i.id===e),s=this.serverState.value.stages.find(i=>i.id===e);return!W.exports.isEqual(W.exports.omit(t,"position"),W.exports.omit(s,"position"))}}class at{constructor(e,t){c(this,"api");c(this,"history");this.api=e,this.history=new Pa(t)}static async create(){const e=new Xt,t=await e.load();return new at(e,t)}move(e){this.history.apply(new Qe(e))}revertTransition(e){this.history.apply(new Ye(e))}delete(e){const t=this.history.getState(),s=t.stages.filter(n=>e.includes(n.id)).map(n=>n.id),i=t.transitions.filter(n=>e.includes(n.id)).map(n=>n.id);this.history.apply(new ka(s,i))}addStages(e){return this.history.apply(new Ia(e.map(t=>{var s;return{...t,title:(s=t.title)!=null?s:`New ${t.type.slice(0,-1)}`}}))),this.history.getState().stages.slice(-e.length)}updateStageTitle(e,t){this.history.apply(new Xe(e,t))}updateStageProps(e,t){this.history.apply(new et(e,t))}updateTransitionType(e,t){this.history.apply(new tt(e,t))}updateTransitionProps(e,t){this.history.apply(new st(e,t))}duplicateStages(e){const t=this.history.getState(),s=this.history.apply(new _a(e));return{stages:s.stages.filter(i=>!t.stages.find(n=>n.id===i.id)),transitions:s.transitions.filter(i=>!t.transitions.find(n=>n.id===i.id))}}ensureTransitionWithType(e){var r;const t=this.getStage(e.sourceStageId);if(!t)throw new Error(`Source stage ${e.sourceStageId} not found`);const s=t.type,i=B.stages.find(o=>o.typeName===s),n=i==null?void 0:i.transitions[0].typeName;if(!n)throw new Error(`No default transition type for ${s}`);return{sourceStageId:e.sourceStageId,targetStageId:e.targetStageId,type:(r=e.type)!=null?r:n}}addTransitions(e){this.history.apply(new xa(e.map(t=>this.ensureTransitionWithType(t))))}changeTransitionType(e,t){const s=new it(e,t);this.history.apply(s)}renameStage(e,t){const s=new qe(e,t);this.history.apply(s)}async reload(){const e=await this.api.load();return this.history.setServerState(e),e}hasChanges(){return this.history.hasChanges()}stageHasChanges(e){return this.history.stageHasChanges(e)}stageHasNonPositionChanges(e){return this.history.stageHasNonPositionChanges(e)}async hasBackendChanges(){const e=await this.api.load(),t=this.history.getServerState(),s={...t,stages:[...t.stages].sort((n,r)=>n.id.localeCompare(r.id)),transitions:[...t.transitions].sort((n,r)=>n.id.localeCompare(r.id))},i={...e,stages:[...e.stages].sort((n,r)=>n.id.localeCompare(r.id)),transitions:[...e.transitions].sort((n,r)=>n.id.localeCompare(r.id))};return!W.exports.isEqual(i,s)}async save(){if(this.history.hasChanges()){const e=await this.api.update(this.history.getState());this.history.setServerState(e)}}async forceSave(){const e=await this.api.update(this.history.getState());this.history.setServerState(e)}getStage(e){var t;return(t=this.history.getState().stages.find(s=>s.id===e))!=null?t:null}getTransition(e){var t;return(t=this.history.getState().transitions.find(s=>s.id===e))!=null?t:null}getState(){return this.history.getState()}}const Ea={key:1,class:"workflow-editor"},Na={class:"workflow-toolbar"},Ca=["onDragstart"],Ma=U({__name:"WorkflowEditor",setup(a){const e=K(null),t=S(()=>{var r;return(r=e.value)==null?void 0:r.gui}),{result:s,loading:i}=ts(()=>Promise.all([Ae.get(),at.create()]).then(([r,o])=>({workspace:r,workflow:o}))),n=(r,o)=>{var v,w;(v=o.dataTransfer)==null||v.setData("type",r),(w=t.value)==null||w.dragstart(r,o)};return(r,o)=>{var v,w,u;return d(),y(J,null,[l(i)?(d(),x(bt,{key:0})):(d(),y("div",Ea,[((v=l(s))==null?void 0:v.workflow)&&((w=l(s))==null?void 0:w.workspace)?(d(),x(Ta,{key:0,ref_key:"canvasGui",ref:e,model:l(s).workflow,workspace:l(s).workspace},null,8,["model","workspace"])):k("",!0),f(l(Y),null,{default:g(()=>{var h;return[T("div",Na,[(d(!0),y(J,null,de(l(B).stages,m=>(d(),x(l(Ut),{key:m.typeName,placement:"top"},{title:g(()=>[f(l(Te),null,{default:g(()=>[f(l(P),null,{default:g(()=>[_(b(m.title),1)]),_:2},1024),f(l(P),{keyboard:""},{default:g(()=>[_(b(m.key),1)]),_:2},1024)]),_:2},1024)]),content:g(()=>[_(b(m.description),1)]),default:g(()=>[T("span",{draggable:"true",onDragstart:N=>n(m.typeName,N)},[(d(),x(Q(m.icon),{width:"18",height:"18",class:"toolbar-item"}))],40,Ca)]),_:2},1024))),128)),f(l(is),{type:"vertical"}),(h=l(s))!=null&&h.workflow?(d(),x(Dt,{key:0,model:l(s).workflow,disabled:void 0,type:"primary"},null,8,["model"])):k("",!0)])]}),_:1})])),f(ss,{"has-changes":(u=l(s))==null?void 0:u.workflow.hasChanges()},null,8,["has-changes"])],64)}}});const un=te(Ma,[["__scopeId","data-v-5f9a6808"]]);export{un as default};
//# sourceMappingURL=WorkflowEditor.ad45960f.js.map
