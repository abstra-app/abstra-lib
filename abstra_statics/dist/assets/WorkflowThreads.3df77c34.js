import{F as q,K as M,E as J,L as R}from"./repository.9bdf867d.js";import{a as U}from"./asyncComputed.ecb54415.js";import{F as $}from"./forms.e78e3f95.js";import{H,J as P,S as Q}from"./scripts.c63019d9.js";import"./workspaces.b7ad1312.js";import{r as S,d as V,eM as W,H as G,b as C,eu as j,f as T,w as k,u as e,c as I,ew as E,bx as X,eQ as Y,bE as Z,aq as N,e as tt,eD as F,eC as et,cC as at}from"./outputWidgets.6d35c6b1.js";import"./envVars.f2c7a5c2.js";import{s as ot}from"./metadata.1591b8c2.js";import{L as nt}from"./LoadingOutlined.9a42901b.js";import{A as L}from"./index.955dc47e.js";import{l as rt}from"./fetch.d55331d2.js";import{A as st}from"./index.38a3c827.js";import"./api.daed91b8.js";import"./index.cf4c23b9.js";import"./ant-design.6caec7a8.js";import"./index.ac766c2c.js";import"./Modal.a9dc860f.js";import"./Text.3b2ffaec.js";import"./index.818a07a0.js";import"./index.a09f38e7.js";import"./Paragraph.a1d4de5f.js";import"./index.fa46d640.js";import"./Link.6a962cb3.js";import"./Title.c1aa2d66.js";import"./index.310ca5a3.js";import"./CollapsePanel.b6fc360d.js";import"./index.8e12a908.js";import"./index.9fc13659.js";import"./isNumeric.75337b1e.js";import"./ExpandOutlined.2ce9532c.js";import"./Card.3a07c675.js";import"./index.0eab68a8.js";import"./TabPane.d8e98a9c.js";import"./hasIn.7146681e.js";import"./vuedraggable.umd.f50226b3.js";import"./index.d6c0d4e4.js";import"./Form.1eab882d.js";import"./record.dd1c9786.js";import"./pubsub.cebd46a9.js";import"./runnerData.820ed550.js";import"./url.f81eaded.js";import"./PhCheckCircle.vue.5aa89193.js";import"./PhScroll.vue.1f9c87c1.js";import"./PhWebhooksLogo.vue.42952557.js";(function(){try{var a=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(a._sentryDebugIds=a._sentryDebugIds||{},a._sentryDebugIds[t]="cd7c8210-d1c4-44c6-9cc2-92d3cf737726",a._sentryDebugIdIdentifier="sentry-dbid-cd7c8210-d1c4-44c6-9cc2-92d3cf737726")}catch{}})();const O=[{title:"Thread",dataIndex:"thread"},{title:"Stage",dataIndex:"stage"},{title:"Status",dataIndex:"status"},{title:"Updated at",dataIndex:"updated_at"}],lt=({kanbanRepository:a})=>{const t=q(),o=S(0),l=S(1),v=S(10),b=async()=>await Promise.all([$.list(),H.list(),P.list(),Q.list()]).then(([c,u,g,h])=>[...c,...u,...g,...h].map(s=>({title:s.title,id:s.id,type:s.type,can_be_started:!!(s.type==="job"||s.type==="form"&&s.isInitial),path:s.type==="form"?s.path:void 0}))),K=async()=>{var d,p;const c=await b(),u=await a.getData({filter:{},limit:1e3,offset:0}),g=(d=u.stage_run_cards)==null?void 0:d.map(n=>n.content.map(m=>m.key)).flat(),h=Array.from(new Set(g)),A=[...O.map(n=>n.title),...h],_=(p=u.stage_run_cards)==null?void 0:p.map(n=>{var r,f;const m=c.find(y=>y.id===n.stage);return[n.id,(r=m==null?void 0:m.title)!=null?r:"",n.status,(f=n.updated_at)!=null?f:"",...h.map(y=>{const x=n.content.find(D=>D.key===y);return x?JSON.stringify(x.value):""})]}),w=new Date;return{columns:A,rows:_!=null?_:[],fileName:`therads-${w.toISOString()}`}};return{tableAsyncComputed:U(async()=>{var c,u,g,h;try{const s=await b();t.limit.value=v.value*l.value,t.offset.value=(l.value-1)*v.value;const A=t.requestDataFactory(),_=await a.getData(A);o.value=_.total_count;const w=(u=(c=_.stage_run_cards)==null?void 0:c.map(r=>r.content.map(f=>f.key)).flat())!=null?u:[],d=Array.from(new Set(w)),p=(h=(g=_.stage_run_cards)==null?void 0:g.reduce((r,f)=>{const y=s.find(D=>D.id===f.stage);let x={};for(const D of d){const z=f.content.find(B=>B.key===D);x={...x,[D]:z?z.value:null,status:f.status,thread:f.id,updated_at:f.updated_at,stage:y==null?void 0:y.title}}return r==null||r.push({type:y==null?void 0:y.type,...x}),r},[]))!=null?h:[],n=[];for(const r of O)n.push({title:r.title,dataIndex:r.dataIndex});const m=[];for(const r of d)m.push({title:r,dataIndex:r.toLowerCase()});return n.push({title:"Data",children:m}),{tableColumns:n,tableRows:p}}catch{return{tableColumns:[],tableRows:[]}}}),totalCount:o,current:l,pageSize:v,filterController:t,getDataAsCsv:K}},it=a=>{let t=a.columns.join(",")+`
`;a.rows.forEach(l=>{t+=l.join(","),t+=`
`});const o=document.createElement("a");o.href="data:text/csv;charset=utf-8,"+encodeURIComponent(t),o.target="_blank",o.download=`${a.fileName}.csv`,o.click()},ct={style:{padding:"20px"}},ut={style:{"text-align":"center",margin:"0"}},dt=V({__name:"TableView",props:{kanbanRepository:{}},setup(a){const t=a,o=S(""),l=S(!1),v=S(!1),b=()=>{l.value=!0,h.filterSearch.value=o.value,K()},K=W.exports.debounce(()=>{i.refetch(),l.value=!1},500),{tableAsyncComputed:i,totalCount:c,current:u,pageSize:g,filterController:h,getDataAsCsv:s}=lt({kanbanRepository:t.kanbanRepository}),A=G(()=>({total:c.value,current:u.value,pageSize:g.value,totalBoundaryShowSizeChanger:10,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:async(w,d)=>{u.value=w,g.value=d,await i.refetch()}})),_=async()=>{if(v.value=!0,!i.result.value)return;const w=await s();it(w),v.value=!1};return(w,d)=>(C(),j("div",ct,[T(e(L),{justify:"space-between",style:{"margin-bottom":"12px"}},{default:k(()=>[T(e(X),{value:o.value,"onUpdate:value":[d[0]||(d[0]=p=>o.value=p),b],placeholder:"Search data or status",style:{width:"400px"},"allow-clear":""},{prefix:k(()=>[T(e(Y))]),suffix:k(()=>[l.value?(C(),I(e(nt),{key:0})):E("",!0)]),_:1},8,["value"]),T(e(Z),{loading:v.value,onClick:_},{default:k(()=>[N("Export to CSV")]),_:1},8,["loading"])]),_:1}),e(i).result.value?(C(),I(e(at),{key:0,columns:e(i).result.value.tableColumns,"data-source":e(i).result.value.tableRows,loading:l.value,pagination:A.value,scroll:{x:2400,y:700},bordered:"",size:"middle"},{headerCell:k(({column:p})=>[tt("p",ut,F(p.title),1)]),bodyCell:k(({column:p,text:n,record:m})=>[p.dataIndex==="stage"?(C(),I(e(L),{key:0,gap:"small"},{default:k(()=>[(C(),I(et(e(ot)(m.type)),{size:"20"})),N(" "+F(n),1)]),_:2},1024)):E("",!0)]),_:1},8,["columns","data-source","loading","pagination"])):E("",!0)]))}});class pt{constructor(t=rt){this.fetch=t}async fork(t){return(await this.fetch("/_editor/api/stage_runs/fork",{method:"POST",body:JSON.stringify({stage_run_id:t}),headers:{"Content-Type":"application/json"}})).json()}}const mt={style:{padding:"20px"}},ne=V({__name:"WorkflowThreads",setup(a){const t=new J,o=new pt,l=new R("kanban"),v=["Kanban","Table view"],b=S("Kanban");return(K,i)=>(C(),j("div",mt,[T(e(st),{value:b.value,"onUpdate:value":i[0]||(i[0]=c=>b.value=c),options:v,style:{"margin-bottom":"16px"}},null,8,["value"]),b.value==="Kanban"?(C(),I(M,{key:0,"kanban-repository":e(t),storage:e(l),"stage-run-repository":e(o)},null,8,["kanban-repository","storage","stage-run-repository"])):E("",!0),b.value==="Table view"?(C(),I(dt,{key:1,"kanban-repository":e(t)},null,8,["kanban-repository"])):E("",!0)]))}});export{ne as default};
//# sourceMappingURL=WorkflowThreads.3df77c34.js.map
