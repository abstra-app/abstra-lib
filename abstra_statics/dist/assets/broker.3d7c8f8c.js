var he=Object.defineProperty;var fe=(l,e,t)=>e in l?he(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var u=(l,e,t)=>(fe(l,typeof e!="symbol"?e+"":e,t),t);import{p as O}from"./passwordlessManager.794d3db6.js";import{P as pe}from"./Passwordless.af9fa329.js";import{e as ve,R as ge}from"./executeJs.977da00c.js";import{L as Ee}from"./CircularLoading.eebf6e84.js";import{W as xe}from"./WidgetsFrame.2536274d.js";import{d as B,a as be,b as c,c as g,u as x,eu as D,c2 as ye,t as T,r as k,eq as ie,bh as we,bu as H,p as re,er as I,eA as M,F as te,G as ke,E as Fe,eM as ne,o as Ce,J as Pe,ew as oe,e as q,eN as Se,eO as De,eP as Le,bw as U,ez as $,eG as Ae}from"./registerWidgets.59747b32.js";import{_ as We}from"./ActionButton.vue_vue_type_script_setup_true_lang.a3a0153d.js";import{i as Ie,j as Be}from"./icons.8e518be5.js";(function(){try{var l=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(l._sentryDebugIds=l._sentryDebugIds||{},l._sentryDebugIds[e]="f39f0988-b6c2-4e75-af7d-9f6231e9216e",l._sentryDebugIdIdentifier="sentry-dbid-f39f0988-b6c2-4e75-af7d-9f6231e9216e")}catch{}})();function w(l){return"key"in l&&"value"in l&&"errors"in l}class z{constructor(e,t){u(this,"endedByPage",!1);u(this,"reactivePollInterval",null);u(this,"seq",0);u(this,"programEnded",!1);u(this,"widgetError",()=>{this.newPageState({widgets:[{type:"error"}],actions:[],fullWidth:!1,steps:null})});u(this,"widgetEnd",()=>{this.endedByPage||this.newPageState({widgets:[{type:"end"}],actions:this.pageActionFactory.restartAction,fullWidth:!1,steps:null})});u(this,"sendUser",e=>{this.broker.send({type:"auth:saved-jwt",jwt:e.jwt})});u(this,"sendBrowserTryDisconnect",()=>{this.broker.send({type:"browser:try-disconnect"})});u(this,"newPageStateListener",()=>{});u(this,"updatePageStateListener",()=>{});u(this,"onReactivePollListener",()=>{});u(this,"onErrorListener",()=>{});u(this,"onExitListener",()=>{});u(this,"onStartAuthListener");u(this,"onEndAuthListener");u(this,"onBadAuthListener");this.broker=e,this.pageActionFactory=t}static create(e,t,s){const n=new z(e,t);return n.broker.onClose(()=>{if(n.programEnded)return;const o="Connection with service closed before program ended";n.widgetError(),n.error(o)}),n.broker.on("form",({widgets:o,actions:a,buttonText:_,endProgram:v,reactivePollingInterval:b,steps:L})=>{n.newPageState({widgets:o,actions:n.pageActionFactory.fromPageActionsDto(_?[_]:a!=null?a:[]),fullWidth:o.some(A=>"fullWidth"in A&&A.fullWidth),steps:L}),b&&(n.reactivePollInterval=setInterval(n.onReactivePollListener,b*1e3)),v&&(n.endedByPage=!0,n.broker.send({type:"form-response",payload:{},secrets:[],seq:++n.seq}))}),n.broker.on("execute-js:request",async o=>{const a=await ve(o);n.broker.send(a)}),n.broker.on("auth:require-info",()=>{n.newPageState({widgets:[],actions:[],fullWidth:!1,steps:null}),n.onStartAuthListener&&n.onStartAuthListener()}),n.broker.on("auth:valid-jwt",()=>{n.onEndAuthListener&&n.onEndAuthListener()}),n.broker.on("auth:invalid-jwt",()=>{console.warn("invalid jwt"),n.onBadAuthListener&&n.onBadAuthListener()}),n.broker.on("program:connection-error",o=>{n.widgetError(),n.error(o)}),n.broker.on("program:end",o=>{n.programEnded=!0,o.exitCode||o.exception?(n.widgetError(),n.error(o)):(n.widgetEnd(),n.exit(o))}),n.broker.on("redirect",o=>{s.onRedirect(o.url,o.queryParams)}),n.broker.on("program:disconnect",o=>{n.exit(o)}),n.broker.on("not-enough-credits",()=>{n.error({error:"not-enough-credits"}),n.programEnded=!0}),n.broker.on("heartbeat",()=>{n.broker.resetHeartbeatCounter()}),n.broker.on("form-update",({widgets:o,validation:a,seq:_})=>{_===n.seq&&n.updatePageState({widgets:o,error:{message:a.message,status:a.status},fullWidth:o.some(v=>"fullWidth"in v&&v.fullWidth)})}),n}handleAction(e,t,s){this.reactivePollInterval&&clearInterval(this.reactivePollInterval);const n={};Object.entries(e).forEach(([o,a])=>{n[o]=a}),this.broker.send({type:"form-response",payload:n,action:t==null?void 0:t.name,secrets:s,seq:++this.seq})}sendUserEvent(e,t){const s={};Object.entries(e).forEach(([n,o])=>{s[n]=o}),this.broker.send({type:"user-event",payload:s,secrets:t,seq:++this.seq})}init(e){this.broker.resetState(),this.newPageState({widgets:[],actions:[],fullWidth:!1,steps:null}),this.broker.connect(e!=null?e:{})}newPageState(e){this.newPageStateListener(e)}updatePageState(e){this.updatePageStateListener(e)}listenToNewPageState(e){this.newPageStateListener=e}listenToPageStateUpdate(e){this.updatePageStateListener=e}onReactivePoll(e){this.onReactivePollListener=e}error(e){this.reactivePollInterval&&clearInterval(this.reactivePollInterval),this.onErrorListener(e)}onError(e){this.onErrorListener=e}exit(e){this.reactivePollInterval&&clearInterval(this.reactivePollInterval),this.onExitListener(e)}onExit(e){this.onExitListener=e}onStartAuth(e){this.onStartAuthListener=e}onEndAuth(e){this.onEndAuthListener=e}onBadAuth(e){this.onBadAuthListener=e}}class P{constructor(e,t){u(this,"element",null);this.name=e,this.isDefault=t}static fromDto(e){return typeof e=="string"?new P(e,!1):new P(e.name,e.is_default)}setElement(e){e instanceof HTMLElement&&(this.element=e)}get isFocused(){return this.element===document.activeElement}focusOnButton(){var e;(e=this.element)==null||e.focus()}addKeydownListener(e){var t;(t=this.element)==null||t.addEventListener("keydown",e)}}class G{constructor(e){this.form=e}static from(e){return new G(e)}get startAction(){var e;return[P.fromDto((e=this.form.startButtonText)!=null?e:"Start")]}get restartAction(){var t;const e=(t=this.form.restartButtonText)!=null?t:"Restart";return this.form.allowRestart?[P.fromDto(e)]:[]}fromPageActionsDto(e){return e.filter(t=>!!t).map(t=>P.fromDto(t))}}const Te={class:"outline-button"},Re=B({__name:"OutlineButton",props:{iconPath:{},noShadow:{type:Boolean},status:{}},setup(l){return(e,t)=>{const s=be("icon");return c(),g("button",Te,[e.iconPath?(c(),x(s,{key:0,path:e.iconPath,fill:"#fff",class:"icon"},null,8,["path"])):D("",!0),ye(e.$slots,"default",{},void 0,!0)])}}});const je=T(Re,[["__scopeId","data-v-d16448de"]]),Ne=B({__name:"FormAutoFill",props:{broker:{},form:{}},setup(l){const e=l,t=window.__runs||(window.__runs={previous:[],current:[]});e.broker.on("start",()=>{t.previous=t.current,t.current=[]});const s=k(null);function n(){for(const _ in t.current){const v=t.previous[_],b=t.current[_];if(!v||v.type!==b.type||v.type=="form"&&!re.exports.isEqual(v.widgets,b.widgets)||v.type=="form-response"&&!re.exports.isEqual(v.payload,b.payload))return null}const a=t.previous[t.current.length];if((a==null?void 0:a.type)!=="form-response")return null;s.value=a}function o(){const a=s.value;a&&e.broker.send(a)}return e.broker.on("form",a=>{t.current.push(a),n()}),e.broker.on("form-response",a=>{t.current.push(a),s.value=null}),(a,_)=>s.value?(c(),x(je,{key:0,"icon-path":H(Ie),class:"form-auto-fill-btn",onClick:o},{default:ie(()=>[we(" Repeat last answer ")]),_:1},8,["icon-path"])):D("",!0)}});const Oe=T(Ne,[["__scopeId","data-v-9590d96b"]]),qe={key:0,class:"hint"},Ue={class:"icon",viewBox:"0 0 24 24",style:{width:"20px",height:"20px"}},$e=["d"],Ve={class:"hint-content"},Je=B({__name:"WidgetHint",props:{hint:{}},setup(l){return(e,t)=>e.hint?(c(),g("div",qe,[(c(),g("svg",Ue,[I("path",{d:H(Be)},null,8,$e)])),I("div",Ve,M(e.hint),1)])):D("",!0)}});const Me=T(Je,[["__scopeId","data-v-419a518f"]]),V={en:{i18n_error_invalid_email:"This email is invalid.",i18n_error_required_field:"This field is required.",i18n_error_invalid_cnpj:"This CNPJ is invalid.",i18n_error_invalid_cpf:"This CPF is invalid.",i18n_error_invalid_phone_number:"This phone number is invalid.",i18n_error_min_list:"The minimum number of items is {min}.",i18n_error_max_list:"The maximum number of items is {max}.",i18n_error_min_number:"The minimum value is {min}.",i18n_error_max_number:"The maximum value is {max}.",i18n_error_max_amount:"The maximum amount is {max} {currency}.",i18n_error_min_amount:"The minimum amount is .",i18n_back_action:"Back",i18n_next_action:"Next"},pt:{i18n_error_required_field:"Este campo \xE9 obrigat\xF3rio.",i18n_error_invalid_email:"Este email \xE9 inv\xE1lido.",i18n_error_invalid_cnpj:"Este CNPJ \xE9 inv\xE1lido.",i18n_error_invalid_cpf:"Este CPF \xE9 inv\xE1lido.",i18n_error_invalid_phone_number:"Este n\xFAmero de telefone \xE9 inv\xE1lido.",i18n_error_min_list:"O n\xFAmero m\xEDnimo de itens \xE9 {min}.",i18n_error_max_list:"O n\xFAmero m\xE1ximo de itens \xE9 {max}.",i18n_error_min_number:"O valor m\xEDnimo \xE9 {min}.",i18n_error_max_number:"O valor m\xE1ximo \xE9 {max}.",i18n_error_max_amount:"O valor m\xE1ximo \xE9 {max} {currency}.",i18n_error_min_amount:"O valor m\xEDnimo \xE9 {min} {currency}.",i18n_back_action:"Voltar",i18n_next_action:"Pr\xF3ximo"},es:{i18n_error_required_field:"Este campo es obligatorio.",i18n_error_invalid_email:"Este email es inv\xE1lido.",i18n_error_invalid_cnpj:"Este CNPJ es inv\xE1lido.",i18n_error_invalid_cpf:"Este CPF es inv\xE1lido.",i18n_error_invalid_phone_number:"Este n\xFAmero de tel\xE9fono es inv\xE1lido.",i18n_error_min_list:"El n\xFAmero m\xEDnimo de \xEDtems es {min}.",i18n_error_max_list:"El n\xFAmero m\xE1ximo de \xEDtems es {max}.",i18n_error_min_number:"El valor m\xEDnimo es {min}.",i18n_error_max_number:"El valor m\xE1ximo es {max}.",i18n_error_max_amount:"El valor m\xE1ximo es {max} {currency}.",i18n_error_min_amount:"El valor m\xEDnimo es {min} {currency}.",i18n_back_action:"Volver",i18n_next_action:"Siguiente"},de:{i18n_error_required_field:"Dieses Feld ist erforderlich.",i18n_error_invalid_email:"Diese E-Mail ist ung\xFCltig.",i18n_error_invalid_cnpj:"Diese CNPJ ist ung\xFCltig.",i18n_error_invalid_cpf:"Diese CPF ist ung\xFCltig.",i18n_error_invalid_phone_number:"Diese Telefonnummer ist ung\xFCltig.",i18n_error_min_list:"Die Mindestanzahl an Elementen betr\xE4gt {min}.",i18n_error_max_list:"Die maximale Anzahl an Elementen betr\xE4gt {max}.",i18n_error_min_number:"Der Mindestwert betr\xE4gt {min}.",i18n_error_max_number:"Der maximale Wert betr\xE4gt {max}.",i18n_error_max_amount:"Der maximale Betrag betr\xE4gt {max} {currency}.",i18n_error_min_amount:"Der minimale Betrag betr\xE4gt {min} {currency}.",i18n_back_action:"Zur\xFCck",i18n_next_action:"N\xE4chster"},fr:{i18n_error_required_field:"Ce champ est obligatoire.",i18n_error_invalid_email:"Cet email est invalide.",i18n_error_invalid_cnpj:"Ce CNPJ est invalide.",i18n_error_invalid_cpf:"Ce CPF est invalide.",i18n_error_invalid_phone_number:"Ce num\xE9ro de t\xE9l\xE9phone est invalide.",i18n_error_min_list:"Le nombre minimum d'\xE9l\xE9ments est {min}.",i18n_error_max_list:"Le nombre maximum d'\xE9l\xE9ments est {max}.",i18n_error_min_number:"La valeur minimale est {min}.",i18n_error_max_number:"La valeur maximale est {max}.",i18n_error_max_amount:"Le montant maximum est {max} {currency}.",i18n_error_min_amount:"Le montant minimum est {min} {currency}.",i18n_back_action:"Retour",i18n_next_action:"Suivant"},hi:{i18n_error_required_field:"\u092F\u0939 \u092B\u093C\u0940\u0932\u094D\u0921 \u0906\u0935\u0936\u094D\u092F\u0915 \u0939\u0948\u0964",i18n_error_invalid_email:"\u092F\u0939 \u0908\u092E\u0947\u0932 \u0905\u092E\u093E\u0928\u094D\u092F \u0939\u0948\u0964",i18n_error_invalid_cnpj:"\u092F\u0939 CNPJ \u0905\u092E\u093E\u0928\u094D\u092F \u0939\u0948\u0964",i18n_error_invalid_cpf:"\u092F\u0939 CPF \u0905\u092E\u093E\u0928\u094D\u092F \u0939\u0948\u0964",i18n_error_invalid_phone_number:"\u092F\u0939 \u092B\u093C\u094B\u0928 \u0928\u0902\u092C\u0930 \u0905\u092E\u093E\u0928\u094D\u092F \u0939\u0948\u0964",i18n_error_min_list:"\u0906\u0907\u091F\u092E\u094B\u0902 \u0915\u0940 \u0928\u094D\u092F\u0942\u0928\u0924\u092E \u0938\u0902\u0916\u094D\u092F\u093E {min} \u0939\u0948\u0964",i18n_error_max_list:"\u0906\u0907\u091F\u092E\u094B\u0902 \u0915\u0940 \u0905\u0927\u093F\u0915\u0924\u092E \u0938\u0902\u0916\u094D\u092F\u093E {max} \u0939\u0948\u0964",i18n_error_min_number:"\u0928\u094D\u092F\u0942\u0928\u0924\u092E \u092E\u0942\u0932\u094D\u092F {min} \u0939\u0948\u0964",i18n_error_max_number:"\u0905\u0927\u093F\u0915\u0924\u092E \u092E\u0942\u0932\u094D\u092F {max} \u0939\u0948\u0964",i18n_error_max_amount:"\u0905\u0927\u093F\u0915\u0924\u092E \u0930\u093E\u0936\u093F {max} {currency} \u0939\u0948\u0964",i18n_error_min_amount:"\u0928\u094D\u092F\u0942\u0928\u0924\u092E \u0930\u093E\u0936\u093F {min} {currency} \u0939\u0948\u0964",i18n_back_action:"\u0935\u093E\u092A\u0938",i18n_next_action:"\u0905\u0917\u0932\u093E"}},He="en";class C{static getBrowserLocale(){return navigator.language.split(/[-_]/)[0]}static getStringsDict(e){return e in V?e:He}static getRaw(e,t){const s=C.getStringsDict(t);return e in V[s]?V[s][e]:e}static getInterpolated(e,t,s){const n=C.getRaw(e,t);return s?n.replace(/{(\w+)}/g,(o,a)=>s[a]):n}static get(e,t){const s=C.getBrowserLocale();return C.getInterpolated(e,s,t)}}const ze={key:0,class:"form-wrapper"},Ge=["id"],Ke={key:1,class:"loading-wrapper"},Ze={key:2,class:"span-error"},Qe={class:"buttons"},Xe=B({__name:"FormRunner",props:{form:{},params:{},isPreview:{type:Boolean},enableAutoFocus:{type:Boolean},broker:{}},emits:["log","error","exit","navigate","logout","start","redirect"],setup(l,{expose:e,emit:t}){const s=l,n=[],o=k({}),a=k({}),_=k({}),v=(r,i)=>{n[i]=r},b=k(null),L=te(()=>G.from(s.form)),A=r=>t("navigate",r),R=()=>{m.value={widgets:[{type:"start"}],actions:L.value.startAction,fullWidth:!1,steps:null}};ke(()=>s.form,()=>{var r;((r=m.value.widgets[0])==null?void 0:r.type)=="start"&&R()});const E=Fe({user:null,authenticating:!1}),m=k({widgets:[],fullWidth:!1,actions:[],steps:null}),S=k("idle"),K=te(()=>m.value.widgets.filter(r=>"secret"in r).reduce((r,i)=>"key"in i&&"secret"in i?[...r,{key:i.key,secret:i.secret}]:r,[]));Z();function Z(){E.user=O.getUser()}const ae=()=>{O.removeUser(),Z(),t("logout")},f=z.create(s.broker,L.value,{onRedirect(r,i){t("redirect",r,i)}});f.onError(r=>{var i;if(t("error",r),S.value="error",r.error==="not-enough-credits"){(i=b.value)==null||i.open(),R();return}}),f.onExit(r=>{t("exit",r),S.value="over"}),f.onStartAuth(()=>{E.user?f.sendUser(E.user):E.authenticating=!0}),f.onEndAuth(()=>{E.authenticating=!1}),f.onBadAuth(()=>{O.removeUser(),E.user=null,E.authenticating=!0}),f.onReactivePoll(()=>{f.sendUserEvent(o.value,K.value)});const ue=r=>{E.user=r,f.sendUser(r)};f.listenToNewPageState(r=>{m.value=r,ne.init(s.enableAutoFocus,()=>j());const i={},d={};m.value.widgets.forEach(p=>{w(p)&&(i[p.key]=p.value,d[p.key]=p.errors)}),o.value=i,a.value=d,_.value={}}),f.listenToPageStateUpdate(r=>{m.value={...m.value,...r};const i={},d={};m.value.widgets.forEach(p=>{w(p)&&(i[p.key]=p.value,d[p.key]=p.errors)}),o.value=i,a.value=d});const Q=r=>{var i;if(!(S.value!=="running"||s.isPreview||!((i=window.should_ask_before_leave)==null||i)))return f.sendBrowserTryDisconnect(),r.preventDefault(),r.returnValue="Are you sure?",""};Ce(async()=>{window.addEventListener("beforeunload",Q),R(),ne.init(s.enableAutoFocus,r=>j(r)),s.form.autoStart&&N()}),Pe(()=>{s.broker.close(),window.removeEventListener("beforeunload",Q)});const le=()=>{n.forEach(r=>{!r||!("setErrors"in r)||typeof r.setErrors!="function"||r.setErrors()})},j=async r=>{if(S.value!=="running")return N();le(),!(Object.values(_.value).some(d=>d.length>0)&&(r==null?void 0:r.name)!=="i18n_back_action")&&f.handleAction(o.value,r,K.value)},N=async()=>{f.init(s.params),S.value="running",t("start")};function ce(r){var i;return w(r)&&(i=o.value[r.key])!=null?i:null}function me(r){return w(r)?r.errors.map(i=>C.get(i,r)):[]}function X(r){var d;if(!w(r))return[];const i=me(r);return[...i!=null?i:[],...(d=_.value[r.key])!=null?d:[]]}function de(r,i){if(!w(r))return;const d={...o.value};d[r.key]=i,o.value=d,f.sendUserEvent(o.value)}function _e(r,i){if(!w(r))return;const d={..._.value};d[r.key]=i,_.value=d}return e({run:N}),(r,i)=>(c(),x(xe,{class:oe([{preview:r.isPreview},"runner"]),"main-color":r.form.mainColor,theme:r.form.theme,"font-family":r.form.fontFamily,runtime:"form"},{default:ie(()=>{var d,p,Y;return[r.isPreview?(c(),x(Oe,{key:0,class:"auto-fill-btn",broker:r.broker,form:r.form,style:{"z-index":1}},null,8,["broker","form"])):D("",!0),q(ge,{ref_key:"runtimeCommonsRef",ref:b,runtime:r.form,"full-width":m.value.fullWidth,"steps-info":m.value.steps,"is-preview":r.isPreview,"user-email":(d=E.user)==null?void 0:d.claims.email,type:"forms",onLogout:ae,onNavigate:A},null,8,["runtime","full-width","steps-info","is-preview","user-email"]),I("main",null,[E.authenticating?(c(),x(pe,{key:0,class:"form-auth",onDone:ue})):(c(),g("div",{key:1,class:oe(["form",{"full-width":m.value.fullWidth}])},[m.value.widgets.length>0?(c(),g("div",ze,[m.value.widgets[0].type=="start"?(c(),x(Se,{key:0,form:r.form},null,8,["form"])):m.value.widgets[0].type=="end"?(c(),x(De,{key:1,"end-message":r.form.endMessage},null,8,["end-message"])):m.value.widgets[0].type=="error"?(c(),x(Le,{key:2,"error-message":r.form.errorMessage},null,8,["error-message"])):(c(!0),g(U,{key:3},$(m.value.widgets,(h,W)=>{var ee;return c(),g("div",{id:h.type+W,key:(ee=h.key)!=null?ee:h.type+W,class:"widget"},[(c(),x(Ae(h.type),{ref_for:!0,ref:y=>v(y,W),value:ce(h),errors:X(h),"user-props":h,runtime:"form","onUpdate:value":y=>de(h,y),"onUpdate:errors":y=>_e(h,y)},null,40,["value","errors","user-props","onUpdate:value","onUpdate:errors"])),q(Me,{hint:"hint"in h?h.hint:null},null,8,["hint"]),(c(!0),g(U,null,$(X(h),y=>(c(),g("span",{key:y,class:"span-error"},M(y),1))),128))],8,Ge)}),128))])):(c(),g("div",Ke,[q(Ee)])),(p=m.value.error)!=null&&p.message?(c(),g("span",Ze,M((Y=m.value.error)==null?void 0:Y.message),1)):D("",!0),I("div",Qe,[(c(!0),g(U,null,$(m.value.actions,h=>(c(),x(We,{key:h.name,"display-name":H(C).get(h.name),action:h,onClick:W=>j(h)},null,8,["display-name","action","onClick"]))),128))])],2))])]}),_:1},8,["class","main-color","theme","font-family"]))}});const lr=T(Xe,[["__scopeId","data-v-823d313e"]]),Ye=[WebSocket.CLOSING,WebSocket.CLOSED];function se(l,e){const t=l[e.type];if(!t){console.warn("no callback for",e.type);return}t.forEach(s=>s(e))}const F=class{constructor(e){u(this,"formPath",null);u(this,"ws",null);u(this,"callbacks",{"form-response":[],"execute-js:request":[],"execute-js:response":[],"form-update":[],start:[],"auth:info":[],"auth:saved-jwt":[],"auth:restart":[],"auth:validate-token":[],"auth:resend-token":[],heartbeat:[],"action-response":[],"user-event":[],"program:end":[],"program:disconnect":[],"program:connection-error":[],"files:changed":[],redirect:[],stderr:[],stdout:[],form:[],"not-enough-credits":[],"auth:require-info":[],"auth:expecting-token":[],"auth:token-expired":[],"auth:invalid-token":[],"auth:invalid-jwt":[],"auth:valid-token":[],"auth:valid-jwt":[],"browser:disconnect":[],"browser:try-disconnect":[]});u(this,"onCloseCallbacks",[]);u(this,"heartbeatCounter",0);u(this,"heartbeatInterval");u(this,"params",{});var t;"formPath"in e&&(this.formPath=(t=e.formPath)!=null?t:null)}static create(e){return F._instance&&F._instance.close(),F._instance=new F(e),F._instance}get url(){return`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}/_socket?formPath=${encodeURIComponent(this.formPath)}`}resetState(){this.close()}resetHeartbeatCounter(){this.heartbeatCounter=0}on(e,t){this.callbacks[e].push(t)}clearWSEvents(){!this.ws||(clearInterval(this.heartbeatInterval),this.ws.onclose=()=>{},this.ws.onerror=()=>{},this.ws.onmessage=()=>{})}async connect(e,t=1){if(!(t>3))return this.params=e!=null?e:this.params,new Promise(s=>{this.clearWSEvents(),this.ws=new WebSocket(this.url),this.ws.onopen=()=>{s(),this.resetHeartbeatCounter(),this.send({type:"start",params:this.params})};let n=!1;const o=()=>{n||(n=!0)};this.ws.onclose=a=>{if(a.code===1006||!a.wasClean)return o();clearInterval(this.heartbeatInterval),this.onCloseCallbacks.forEach(_=>_())},this.ws.onerror=()=>o(),this.ws.onmessage=a=>{const _=JSON.parse(a.data);se(this.callbacks,_)},this.heartbeatInterval=setInterval(()=>{if(!(!this.ws||this.ws.readyState!==this.ws.OPEN)){if(this.heartbeatCounter++,this.heartbeatCounter>3)return this.ws.onclose=()=>{},clearInterval(this.heartbeatInterval),o();this.send({type:"heartbeat"})}},2e3)}).catch(()=>{this.connect(this.params,t+1)})}onClose(e){this.onCloseCallbacks.push(e)}close(){if(!this.ws){console.warn("no websocket to close");return}this.clearWSEvents(),this.ws.close()}async send(e){if(!this.ws){console.warn("no websocket to send");return}Ye.includes(this.ws.readyState)&&await this.connect(),this.ws.send(JSON.stringify(e)),se(this.callbacks,e)}};let J=F;u(J,"_instance");export{lr as F,J as R};
//# sourceMappingURL=broker.3d7c8f8c.js.map
