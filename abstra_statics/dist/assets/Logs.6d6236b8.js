var U=Object.defineProperty;var $=(d,e,i)=>e in d?U(d,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):d[e]=i;var c=(d,e,i)=>($(d,typeof e!="symbol"?e+"":e,i),i);import{r as I,E as w,G as A,eJ as F,d as T,ez as N,a as V,b as p,c as h,w as n,u as t,f as s,ao as g,ab as R,be as B,cA as E,et as m,eA as k,eB as S,bo as P,eu as G,ci as C,ev as L,bJ as J}from"./outputWidgets.9da14cab.js";import{a as O,A as b}from"./router.b309f614.js";import"./jwt-decode.esm.74bd4619.js";import{a as q,b as K}from"./build.652ff3aa.js";import"./index.e946ab79.js";import{E as H,_ as M}from"./ExecutionStatusIcon.vue_vue_type_script_setup_true_lang.ca5f4009.js";import{g as Q}from"./datetime.24e6a5e5.js";import{R as W}from"./dayjs.00103e04.js";import{a as X}from"./Title.9ff83db3.js";import{A as Y}from"./index.a5f40c59.js";import{A as _}from"./FormItem.747cadfe.js";import{F as Z}from"./Form.0999ca96.js";import{A as tt,C as et}from"./CollapsePanel.309d4326.js";import{A as y}from"./index.db3165b9.js";import"./storage.52539cc4.js";import"./index.0bfdc579.js";import"./index.cf4c23b9.js";import"./record.6cb31dd5.js";import"./pubsub.20ca981d.js";import"./CheckCircleFilled.553aecf8.js";import"./index.a6bc94f7.js";import"./Text.a55300b7.js";import"./hasIn.ed16d98d.js";(function(){try{var d=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(d._sentryDebugIds=d._sentryDebugIds||{},d._sentryDebugIds[e]="bdb2fddd-b708-4eb2-b429-32aa3b0f6287",d._sentryDebugIdIdentifier="sentry-dbid-bdb2fddd-b708-4eb2-b429-32aa3b0f6287")}catch{}})();class v{constructor(e,i,r){c(this,"_executionState",I({openedExecutionIds:[],loadingExecutions:!1,waitingDebounce:!1,executions:[]}));c(this,"_paginationState",w({currentPage:1,pageSize:10,totalCount:0}));c(this,"_filtersState",I({dateRange:void 0,selectedBuildId:void 0,runtimeId:void 0,buildOptions:[],runtimeOptions:[]}));c(this,"_executionsLogsState",w({}));c(this,"projectId");c(this,"handleFilterChange",()=>{this._executionState.value.waitingDebounce=!0,this._paginationState.currentPage=1,this.debouncedPageRefetch()});c(this,"debouncedPageRefetch",F.exports.debounce(async()=>{await this.fetchPage(),this.executionState.value.waitingDebounce=!1},500));c(this,"getLogsStateByExecution",e=>this._executionsLogsState&&this._executionsLogsState[e]);this.query=e,this.executionRepository=i,this.buildRepository=r,this._filtersState.value={...this._filtersState.value,...e},this.projectId=e.projectId}static setup(e,i,r){const u=new v(e,i,r);return u.fetchPage(),u.fetchOptions(),A(u._paginationState,()=>u.fetchPage(),{deep:!0}),A(u._filtersState,u.handleFilterChange,{deep:!0}),u}async fetchPage(){var r,u;this._executionState.value.loadingExecutions=!0;const{executions:e,totalCount:i}=await this.executionRepository.list({projectId:this.projectId,buildId:this.filtersState.selectedBuildId,limit:this._paginationState.pageSize,offset:(this._paginationState.currentPage-1)*this._paginationState.pageSize,stageId:this.filtersState.runtimeId,startDate:(r=this.filtersState.dateRange)==null?void 0:r[0].toISOString(),endDate:(u=this.filtersState.dateRange)==null?void 0:u[1].toISOString()});this._executionState.value.executions=e,this._paginationState.totalCount=i,this._executionState.value.loadingExecutions=!1}async fetchBuildOptions(){const e=await this.buildRepository.list(this.projectId);this._filtersState.value.buildOptions=e.map(i=>({label:`[${i.id.slice(0,8)}] ${i.createdAt.toLocaleString()} ${i.latest?"(Latest)":""}`,value:i.id}))}async fetchRuntimeOptions(){var i;const e=await q.get((i=this.filtersState.selectedBuildId)!=null?i:this.filtersState.buildOptions[0].value);this._filtersState.value.runtimeOptions=e==null?void 0:e.runtimes.map(r=>({label:`[${r.type}] ${r.title} (${r.id.slice(0,8)})`,value:r.id}))}async fetchOptions(){await this.fetchBuildOptions(),await this.fetchRuntimeOptions()}async handleOpenExecution(e){await Promise.all([e.map(async i=>{this._executionsLogsState[i]||(this._executionsLogsState[i]=await this.executionRepository.fetchLogs(this.projectId,i))})])}get filtersState(){return this._filtersState.value}get currentPage(){return this._paginationState.currentPage}set currentPage(e){this._paginationState.currentPage=e}get pageSize(){return this._paginationState.pageSize}set pageSize(e){this._paginationState.pageSize=e}get totalCount(){return this._paginationState.totalCount}get executionState(){return this._executionState}}const at={key:0,style:{display:"flex",width:"100%","justify-content":"center"}},it={key:1,style:{"background-color":"#555","border-radius":"5px",padding:"10px",color:"#fff","font-family":"monospace"}},Pt=T({__name:"Logs",setup(d){const e=new H,i=new K,r=N(),u=r.params.projectId,z={runtimeId:r.query.runtimeId,projectId:u},o=v.setup(z,e,i);return(st,l)=>{const D=V("router-link");return p(),h(t(E),{direction:"vertical"},{default:n(()=>[s(t(X),null,{default:n(()=>[g("Logs")]),_:1}),s(t(Y),{message:"Logs from versions of Abstra prior to 1.27.0 are not displayed here. Use legacy logs instead.",type:"info","show-icon":""},{action:n(()=>[s(D,{to:{name:"legacy-logs"}},{default:n(()=>[g("Go to legacy logs")]),_:1})]),_:1}),s(t(Z),{layout:"vertical"},{default:n(()=>[s(t(O),{gutter:10},{default:n(()=>[s(t(b),{span:24},{default:n(()=>[s(t(_),{label:"Script"},{default:n(()=>[s(t(R),{value:t(o).filtersState.runtimeId,"onUpdate:value":l[0]||(l[0]=a=>t(o).filtersState.runtimeId=a),options:t(o).filtersState.runtimeOptions,placeholder:"All","allow-clear":""},null,8,["value","options"])]),_:1})]),_:1})]),_:1}),s(t(O),{gutter:10},{default:n(()=>[s(t(b),{span:12},{default:n(()=>[s(t(_),{label:"Date"},{default:n(()=>[s(t(W),{value:t(o).filtersState.dateRange,"onUpdate:value":l[1]||(l[1]=a=>t(o).filtersState.dateRange=a),style:{width:"100%"}},null,8,["value"])]),_:1})]),_:1}),s(t(b),{span:12},{default:n(()=>[s(t(_),{label:"Build"},{default:n(()=>[s(t(R),{value:t(o).filtersState.selectedBuildId,"onUpdate:value":l[2]||(l[2]=a=>t(o).filtersState.selectedBuildId=a),options:t(o).filtersState.buildOptions,"option-label":"label","option-value":"value",filter:!1,placeholder:"All","allow-clear":""},null,8,["value","options"])]),_:1})]),_:1})]),_:1})]),_:1}),t(o).executionState.value.loadingExecutions||t(o).executionState.value.waitingDebounce?(p(),h(t(B),{key:0,style:{width:"100%"}})):t(o).executionState.value.executions&&t(o).executionState.value.executions.length>0?(p(),h(t(E),{key:1,direction:"vertical",style:{width:"100%"}},{default:n(()=>[s(t(et),{"active-key":t(o).executionState.value.openedExecutionIds,"onUpdate:activeKey":l[3]||(l[3]=a=>t(o).executionState.value.openedExecutionIds=a),bordered:!1,style:{"background-color":"transparent"},onChange:l[4]||(l[4]=a=>t(o).handleOpenExecution(a))},{default:n(()=>[(p(!0),m(P,null,k(t(o).executionState.value.executions,a=>(p(),h(t(tt),{key:a.id,style:{"border-radius":"4px","margin-bottom":"10px",border:"0",overflow:"hidden","background-color":"#fff"}},{header:n(()=>[s(t(y),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:n(()=>[g(S(t(Q)(a.createdAt)),1)]),_:2},1024),s(t(y),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:n(()=>[g(" Run ID: "+S(a.id.slice(-8)),1)]),_:2},1024),s(t(y),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:n(()=>[g(" Build: "+S(a.buildId.slice(-8)),1)]),_:2},1024),s(t(y),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:n(()=>{var f,x;return[g(S((x=(f=t(o).filtersState.runtimeOptions.find(j=>j.value===a.stageId))==null?void 0:f.label)!=null?x:a.stageId.slice(-8)),1)]}),_:2},1024)]),extra:n(()=>[g(S(a.status.charAt(0).toUpperCase()+a.status.slice(1))+" ",1),s(M,{status:a.status},null,8,["status"])]),default:n(()=>[t(o).getLogsStateByExecution(a.id)?t(o).getLogsStateByExecution(a.id).entries.length?(p(),m("div",it,[(p(!0),m(P,null,k(t(o).getLogsStateByExecution(a.id).entries,f=>(p(),m("p",{key:f.createdAt,style:G({margin:0,"white-space":"pre-wrap",color:f.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},S(f.payload.text.trim()),5))),128))])):t(o).getLogsStateByExecution(a.id).entries.length?L("",!0):(p(),h(t(C),{key:2})):(p(),m("div",at,[s(t(B))]))]),_:2},1024))),128))]),_:1},8,["active-key"]),s(t(J),{current:t(o).currentPage,"onUpdate:current":l[5]||(l[5]=a=>t(o).currentPage=a),"page-size":t(o).pageSize,"onUpdate:pageSize":l[6]||(l[6]=a=>t(o).pageSize=a),total:t(o).totalCount,"show-size-changer":""},null,8,["current","page-size","total"])]),_:1})):L("",!0),s(t(C))]),_:1})}}});export{Pt as default};
//# sourceMappingURL=Logs.6d6236b8.js.map
