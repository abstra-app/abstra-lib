var Dt=Object.defineProperty;var $t=(r,e,t)=>e in r?Dt(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var m=(r,e,t)=>($t(r,typeof e!="symbol"?e+"":e,t),t);import{i as W,w as V,a as Mt,s as Gt,b as Q,c as C,e as me,f as oe,h as De,j as Ht,k as Bt,r as zt}from"./index.977cda87.js";import{T as Ut,_ as Ft,a as Ye}from"./UnsavedChangesHandler.vue_vue_type_script_setup_true_lang.7699558a.js";import{r as k,d as z,b as S,d2 as E,e as _,ak as ge,eE as ht,f as x,eB as $e,eC as Me,v as U,H as G,J as le,al as Ge,eA as D,bu as ce,ez as de,et as he,u as R,eu as $,G as ut,L as pt,a as _e,eQ as jt,ew as te,c as ee,a3 as He,q as H,o as gt,a0 as Vt,ev as Zt,eT as Jt,eU as Kt,w as Y,b0 as Qt,F as qt,ex as Yt,ey as Xt,cy as es,eD as ts}from"./registerWidgets.d6e66474.js";import{D as ss,m as rs}from"./DashPlayer.f7dd7935.js";import{R as os,S as is,L as ns}from"./SmartConsole.85b38544.js";import{L as as}from"./CircularLoading.2744e4b0.js";import{u as ls,g as cs,v as Ie,x as Pe,y as ds,z as hs,A as us}from"./icons.4be6cb33.js";import{a as ps}from"./asyncComputed.5c362931.js";import{D as gs}from"./dashes.811e4dd5.js";import{W as fs}from"./workspaces.5e4a741d.js";import{B as vs}from"./BackButton.000dfb31.js";import{_ as ms}from"./SaveButton.vue_vue_type_script_setup_true_lang.ed344e02.js";import{_ as ys}from"./PreviewButton.vue_vue_type_script_setup_true_lang.4845dbf5.js";import{_ as ws}from"./DocsButton.vue_vue_type_script_setup_true_lang.3de0e9fb.js";import{d as Ss,w as B,r as Be,i as xe,a as _s,v as Es,b as ft,p as Xe,c as bs}from"./geometryUtils.8b61511d.js";import{k as Is,s as q,a as et,c as fe,m as Ps}from"./keyboard.005700d5.js";import{u as Ee}from"./uuid.baa8712a.js";import{P as ze}from"./pubsub.9e806cff.js";import"./executeJs.45861195.js";import"./PlayerNavbar.6876b287.js";import"./Steps.28b1fe2b.js";import"./Modal.87772a38.js";import"./passwordlessManager.a2051844.js";import"./storage.d7eb729a.js";import"./Passwordless.83f13a8c.js";import"./WidgetsFrame.b0e7227e.js";import"./forms.2e38c299.js";import"./activeRecord.1009e596.js";import"./hooks.a4b6e8df.js";import"./jobs.b7c93ebe.js";import"./index.55d44a5a.js";import"./Title.dd14f24f.js";import"./transButton.63ba82b1.js";import"./lottie.b059da2e.js";(function(){try{var r=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(r._sentryDebugIds=r._sentryDebugIds||{},r._sentryDebugIds[e]="ba89fa3f-b955-4133-aced-ca6781aa88c6",r._sentryDebugIdIdentifier="sentry-dbid-ba89fa3f-b955-4133-aced-ca6781aa88c6")}catch{}})();const T={left:20,right:20,top:20,bottom:200};class Ue{constructor(e){m(this,"_state");m(this,"_projectedElement",null);m(this,"grid");this.grid=e,this._state=k({x:0,y:0,zoom:1})}get x(){return this._state.value.x}set x(e){if(Number.isNaN(e))throw new Error("x is NaN");this._state.value.x=e}get y(){return this._state.value.y}set y(e){if(Number.isNaN(e))throw new Error("y is NaN");this._state.value.y=e}static create(e){return new Ue(e)}setProjectedCanvas(e){this._projectedElement=e,this.fit()}get projectedElement(){if(!this._projectedElement)throw new Error("Camera has no projected element");return this._projectedElement}updateGrid(e){this.grid=e}get zoom(){return this._state.value.zoom}set zoom(e){if(e<=0)throw new Error("Zoom must be positive");this._state.value.zoom=e}fit(){if(!this.grid.width)throw new Error(`Grid width is ${this.grid.width}}`);if(!this.grid.height)throw new Error(`Grid height is ${this.grid.height}`);const e=this.canvasRect,t=Math.max(e.width-T.left-T.right,1),s=Math.max(e.height-T.top-T.bottom,1);this.zoom=1;const o=Math.min(t/this.grid.width,s/this.grid.height);this.zoomIn(o,{x:e.x+e.width/2,y:e.y+e.height/2,referential:"screen"}),this.x=t>this.grid.width*o?-(e.x+e.width/2-o*this.grid.width/2)/o:-(e.x+T.left)/o,this.y=s<this.grid.height*o?-(e.y+T.top)/o:-(e.y+e.height/2-o*this.grid.height/2)/o}screenPoint2world(e){return{x:e.x/this.zoom+this.x,y:e.y/this.zoom+this.y,referential:"world"}}worldPoint2screen(e){return{x:(e.x-this.x)*this.zoom,y:(e.y-this.y)*this.zoom,referential:"screen"}}screenDelta2world(e){return{dx:e.dx/this.zoom,dy:e.dy/this.zoom,referential:"world"}}worldDelta2screen(e){return{dx:e.dx*this.zoom,dy:e.dy*this.zoom,referential:"screen"}}screenRect2world(e){const t=this.screenPoint2world({x:e.x,y:e.y,referential:e.referential}),s=this.screenPoint2world({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:s.x-t.x,height:s.y-t.y,referential:t.referential}}worldRect2screen(e){const t=this.worldPoint2screen({x:e.x,y:e.y,referential:e.referential}),s=this.worldPoint2screen({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:s.x-t.x,height:s.y-t.y,referential:t.referential}}zoomIn(e,t){const s=this.screenPoint2world(t);this.zoom*=e;const o=this.worldPoint2screen(s),i=Ss(t,o),n=this.screenDelta2world({dx:i.dx,dy:i.dy,referential:"screen"});this.x+=n.dx,this.y+=n.dy,this.correct()}translate(e,t=!0){this.x+=e.dx,this.y+=e.dy,t&&this.correct()}get canvasRect(){if(!this._projectedElement)throw new Error("No canvas element");const e=this._projectedElement.getBoundingClientRect();return{x:e.x,y:e.y,width:e.width,height:e.height,referential:"screen"}}correctZoom(){const e=this.canvasRect,t=Math.max(e.width-T.left-T.right,0),s=Math.max(e.height-T.top-T.bottom,0),o=Math.min(t/this.grid.width,s/this.grid.height);this.zoom<o&&(this.zoom=o)}correct(){this.correctZoom();const e=this.worldRect2screen({x:0,y:0,width:this.grid.width,height:this.grid.height,referential:"world"}),t=this.canvasRect,s=e.x>t.x+T.left,o=e.x+e.width<t.x+t.width-T.right,i=e.x+e.width/2-(t.x+t.width/2),n=e.width>t.width,l=e.height>t.height,c=e.y+e.height<t.y+t.height-T.bottom,a=e.y>t.y+T.top,u=e.y+e.height/2-(t.y+t.height/2),p=this.screenDelta2world({dx:n?o&&s?0:s?e.x-t.x-T.right:o?e.x+e.width-(t.x+t.width)+T.left:0:i,dy:l?c&&a?0:a?e.y-t.y-T.top:c?e.y+e.height-(t.y+t.height)+T.bottom:0:u,referential:"screen"});this.x+=p.dx,this.y+=p.dy}}const Rs=r=>($e("data-v-fb3c93ab"),r=r(),Me(),r),Ls={class:"dash-settings"},xs={class:"dash-property"},Os=Rs(()=>_("label",{class:"property-label"},"Name",-1)),Ns=z({__name:"DashSettings",props:{dash:{}},setup(r){return(e,t)=>(S(),E("div",Ls,[_("div",xs,[Os,ge(_("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>e.dash.title=s),class:"property-input",placeholder:"Enter a name"},null,512),[[ht,e.dash.title]])]),x(os,{runtime:e.dash},null,8,["runtime"])]))}});const As=U(Ns,[["__scopeId","data-v-fb3c93ab"]]),Ts={class:"zoom-bar"},Cs={class:"zoom-value"},ks=z({__name:"ZoomBar",props:{camera:{}},emits:["hover","leave"],setup(r,{emit:e}){const t=r,s=k(!1),o=k(null),i=()=>{var a;(a=t.camera)==null||a.zoomIn(1.1,{x:document.body.offsetWidth/2,y:document.body.offsetHeight/2,referential:"screen"})},n=()=>{var a;(a=t.camera)==null||a.zoomIn(.9,{x:document.body.offsetWidth/2,y:document.body.offsetHeight/2,referential:"screen"})},l=G(()=>{var c,a;return`${Math.floor(((a=(c=t.camera)==null?void 0:c.zoom)!=null?a:1)*100)}%`});return le(()=>{var c;return(c=t.camera)==null?void 0:c.zoom},()=>{clearTimeout(o.value),s.value=!0,o.value=setTimeout(()=>s.value=!1,3e3)}),(c,a)=>ge((S(),E("div",{class:"zoom-bar-wrapper",onMouseover:a[0]||(a[0]=u=>e("hover")),onMouseleave:a[1]||(a[1]=u=>e("leave"))},[_("div",Ts,[_("span",{class:"zoom-control",onClick:n},"-"),_("span",Cs,D(l.value),1),_("span",{class:"zoom-control",onClick:i},"+")])],544)),[[Ge,c.camera&&s.value]])}});const Ws=U(ks,[["__scopeId","data-v-f937a967"]]),tt={PandasDataFrame:"https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html",PlotlyFigure:"https://plotly.com/python-api-reference/generated/plotly.graph_objects.Figure.html","datetime.time":"https://docs.python.org/3/library/datetime.html#datetime.time","datetime.date":"https://docs.python.org/3/library/datetime.html#datetime.date","io.IOBase":"https://docs.python.org/3/library/io.html#io.IOBase","time.struct_time":"https://docs.python.org/3/library/time.html#time.struct_time"},Ds="#E286A3",$s="#EF9542",Ms="#B462DB",Gs="#40B6D3",Hs="#6FB96E",Bs=[Ds,$s,Ms,Gs,Hs];function st(r){let e=r;return Object.keys(tt).forEach(t=>{if(r.includes(t)){const s=tt[t];e=e.replace(t,`<a href="${s}" target="_blank">${t}</a>`)}}),e}const ie={},zs=r=>e=>{if(ie[e])return ie[e];const t=Object.keys(ie).length%r.length;return ie[e]=r[t],r[t]},rt=zs([...Bs]),Us=()=>{Object.keys(ie).forEach(r=>delete ie[r])};class Fs{constructor(){m(this,"globalEventListeners",[])}addGlobalEventListener(e,t){addEventListener(e,t),this.globalEventListeners.find(s=>s.evt===e)||this.globalEventListeners.push({evt:e,handler:t})}removeGlobalEventListeners(){this.globalEventListeners.forEach(({evt:e,handler:t})=>{removeEventListener(e,t)}),this.globalEventListeners=[]}}const js={class:"param-types"},Vs=["innerHTML"],Zs={key:1,class:"prop-type"},Js=["innerHTML"],Ks=z({__name:"ParamTypes",props:{param:{}},setup(r){return(e,t)=>(S(),E("div",js,[e.param&&e.param.typeDescription?(S(!0),E(ce,{key:0},de(e.param.typeDescription,s=>(S(),E("div",{key:s,class:"prop-type"},[_("p",{class:"type",style:he({color:R(rt)(s)}),innerHTML:R(st)(s)},null,12,Vs)]))),128)):e.param&&e.param.typeName?(S(),E("div",Zs,[_("p",{class:"type",style:he({color:R(rt)(e.param.typeName)}),innerHTML:R(st)(e.param.typeName)},null,12,Js)])):$("",!0)]))}});const ot=U(Ks,[["__scopeId","data-v-d6aed39d"]]),Qs=["value","placeholder"],qs=["value","placeholder"],Ys=z({__name:"PythonPropInputRaw",props:{hasError:{type:Boolean},placeholder:{},value:{},paramName:{},isCode:{type:Boolean},commit:{type:Function}},emits:["input","change","clearSuggestions"],setup(r,{emit:e}){const t=r,s=ut({isActive:!1,hasChanges:!1}),o=c=>{e("input",c),s.hasChanges=!0},i=()=>{s.isActive=!1,e("clearSuggestions")},n=c=>{c.preventDefault();const a=c.target,u=a.selectionStart,p=a.selectionEnd,d=a.value;a.value=d.substring(0,u)+"	"+d.substring(p),a.selectionStart=a.selectionEnd=u+1,a.dispatchEvent(new Event("input"))},l=c=>{t.commit(c),s.hasChanges=!1};return pt(()=>{s.hasChanges&&t.commit(t.value)}),(c,a)=>{var p,d;const u=_e("icon");return S(),E("div",{class:te(["input-container",{error:c.hasError}])},[x(u,{path:R(ls),class:"icon",fill:c.hasError?"#D35249":s.isActive?"#3482E5":void 0},null,8,["path","fill"]),c.isCode?(S(),E("textarea",{key:0,value:c.value,class:"prop-input",placeholder:(p=c.placeholder)!=null?p:void 0,onInput:a[0]||(a[0]=h=>o(h.target.value)),onClick:a[1]||(a[1]=h=>s.isActive=!0),onBlur:i,onKeydown:a[2]||(a[2]=jt(h=>n(h),["tab"])),onChange:a[3]||(a[3]=h=>l(h.target.value))},null,40,Qs)):(S(),E("input",{key:1,value:c.value,class:"prop-input",placeholder:(d=c.placeholder)!=null?d:void 0,onInput:a[4]||(a[4]=h=>o(h.target.value)),onClick:a[5]||(a[5]=h=>s.isActive=!0),onBlur:i,onChange:a[6]||(a[6]=h=>l(h.target.value))},null,40,qs))],2)}}});const Xs=U(Ys,[["__scopeId","data-v-d30fa88e"]]),er={class:"suggestions"},tr=["onMousedown"],sr=z({__name:"PythonAutoCompleteSuggestions",props:{suggestions:{}},emits:["select"],setup(r,{emit:e}){return(t,s)=>ge((S(),E("div",er,[(S(!0),E(ce,null,de(t.suggestions,o=>(S(),E("div",{key:o,class:"suggestion",onMousedown:i=>e("select",o)},D(o),41,tr))),128))],512)),[[Ge,t.suggestions.length]])}});const rr=U(sr,[["__scopeId","data-v-afec000d"]]),or={class:"python-wrapper"},ir=z({__name:"PythonPropInput",props:{hasError:{type:Boolean},placeholder:{},value:{},paramName:{},dashPlayerService:{},isCode:{type:Boolean},commit:{type:Function}},emits:["input"],setup(r,{emit:e}){const t=r,s=G(()=>t.dashPlayerService.suggestionsFor),o=G(()=>t.dashPlayerService.suggestions),i=a=>{l(t.paramName,a),e("input",a)},n=a=>{c(),e("input",a),t.commit(a)},l=async(a,u)=>{!u||t.dashPlayerService.getAutocompleteSuggestions(a,u)},c=async()=>{await He(),t.dashPlayerService.clearSuggestions()};return(a,u)=>(S(),E("div",or,[x(Xs,{value:a.value,commit:a.commit,"is-code":a.isCode,"param-name":a.paramName,"dash-player-service":a.dashPlayerService,onInput:i,onClearSuggestions:c},null,8,["value","commit","is-code","param-name","dash-player-service"]),s.value===a.paramName?(S(),ee(rr,{key:0,suggestions:o.value,onSelect:n},null,8,["suggestions"])):$("",!0)]))}});const Re=U(ir,[["__scopeId","data-v-63688ff1"]]),nr={name:"If Block",description:"A block of elements that is only rendered depending on a condition",params:[{typeName:"Boolean",description:"The condition to check",argName:"condition",isKwarg:!1,default:null}],defaultEditProps:{condition:!0},thumbname:"IfBlock.svg"},ae={"if-block":nr},K=r=>($e("data-v-718f02de"),r=r(),Me(),r),ar={class:"wrapper"},lr={class:"title"},cr={key:0,class:"widget-prop"},dr=K(()=>_("h2",null,"Error",-1)),hr=K(()=>_("p",{class:"section-description"},"Some errors were found while computing the widget.",-1)),ur=["textContent"],pr={key:1,class:"section"},gr=K(()=>_("h2",null,"VARIABLE",-1)),fr={key:0,class:"section-content"},vr={class:"widget-prop"},mr=K(()=>_("p",{class:"prop-label"},"Bind a variable",-1)),yr=K(()=>_("p",{class:"prop-description"},"Create a variable to be controlled by this widget.",-1)),wr={class:"input-container"},Sr={key:0,class:"variable-error prop-error"},_r=K(()=>_("pre",null,"Variable not defined",-1)),Er={key:1,class:"prop-error",textContent:"SyntaxError: This field must be a variable name"},br=["textContent"],Ir={key:2,class:"section"},Pr=K(()=>_("h2",null,"EVENTS",-1)),Rr={key:0,class:"section-content"},Lr=K(()=>_("p",{class:"section-description"}," Each event is a Python code that runs on specified situations ",-1)),xr={class:"prop-label"},Or={class:"prop-description"},Nr={class:"section"},Ar=K(()=>_("h2",null,"PROPERTIES",-1)),Tr={key:0,class:"section-content"},Cr=K(()=>_("p",{class:"section-description"}," Each property is a Python expression, make sure to use the correct syntax. ",-1)),kr={class:"prop-label"},Wr={class:"prop-description"},Dr=["textContent"],$r=K(()=>_("div",{class:"feedback"},null,-1)),Mr=[$r],it=402,Gr=z({__name:"WidgetEditor",props:{selectedWidgetErrors:{},layoutModel:{},selectedWidgets:{},dashPlayerService:{}},emits:["close","create-variable"],setup(r,{emit:e}){const t=r,s=k(null);le(()=>t.selectedWidgetErrors,()=>{s.value=null});const o=y=>{g.openedSections.includes(y)?g.openedSections=g.openedSections.filter(b=>b!==y):g.openedSections.push(y)},i=y=>g.openedSections.includes(y),n=y=>W(y)?V[y.type].name:ae[y.type].name,l=G(()=>s.value===null?t.selectedWidgetErrors:s.value==="variable"?H.exports.omit(t.selectedWidgetErrors,"variable"):{...t.selectedWidgetErrors,props:H.exports.omit(t.selectedWidgetErrors.props,s.value)}),c=G(()=>a.value.type.includes("-input")&&a.value.type!=="click-input"),a=G(()=>t.selectedWidgets[0]),u=G(()=>{var I;if(!W(a.value))return;const b=((I=V[a.value.type].pythonAPI.params)!=null?I:[]).find(O=>O.argName==="initial_value");return b||null});function p(y){this.style.height="0",this.style.height=this.scrollHeight-24+"px"}const d=new Fs,h=k(null),g=ut({isActive:!1,resizing:!1,width:it,openedSections:["properties","variable"]});gt(()=>{h.value&&(d.addGlobalEventListener("mouseup",()=>g.resizing=!1),d.addGlobalEventListener("mousemove",I=>f(I))),document.querySelectorAll(".widget-props-editor textarea").forEach(I=>{!I||(I.setAttribute("style","height:"+(I.scrollHeight-24)+"px;overflow-y:hidden;"),I.addEventListener("input",p,!1))})}),Vt(()=>{Us(),d.removeGlobalEventListeners()});const f=y=>{g.resizing&&(g.width=Math.max(g.width-y.movementX,it))},w=G(()=>({width:`${g.width}px`})),v=y=>ae[y.type].params,L=G(()=>{const y=(O,F)=>O.argName===F.argName&&O.typeName===F.typeName,b=(O,F,P)=>P.findIndex(re=>y(O,re))===F,I=O=>!O.formOnly;return t.selectedWidgets.flatMap(O=>{var F;return W(O)?(F=V[O.type])==null?void 0:F.pythonAPI.params:v(O)}).filter(Boolean).filter(I).filter(b)}),j=G(()=>{const y=(I,O)=>I.key===O.key,b=(I,O,F)=>F.findIndex(P=>y(I,P))===O;return t.selectedWidgets.flatMap(I=>{var O;return W(I)?(O=V[I.type])==null?void 0:O.events:[]}).filter(Boolean).filter(b).filter(I=>I.key!=="change")}),Rt=y=>{t.layoutModel.updateVariable(y,a.value.id),s.value="variable"},Lt=y=>b=>{t.layoutModel.updateProp({param:y,value:b},t.selectedWidgets.map(I=>I.id)),s.value=y.argName},xt=y=>b=>{t.layoutModel.updateEvent({event:y,value:b},t.selectedWidgets.map(I=>I.id))},Ot=()=>{var y,b;return(b=(y=l.value.variable)==null?void 0:y.repr)==null?void 0:b.includes("SyntaxError")},Nt=()=>{var y,b;return(b=(y=l.value.variable)==null?void 0:y.repr)==null?void 0:b.includes("NameError")},At=y=>{!y||(t.dashPlayerService.sendVariableCreated(y),e("create-variable",y))},Tt=()=>{var y,b;return((y=l.value.widget)==null?void 0:y.repr)&&!Object.values((b=l.value.props)!=null?b:{}).some(I=>I.repr)},Ct=()=>{var y;return(y=l.value.widget)==null?void 0:y.repr},be=y=>{var b,I;return(I=(b=l.value.props)==null?void 0:b[y])==null?void 0:I.repr},kt=y=>H.exports.upperFirst(y.replace(/_/g," "));return(y,b)=>{var O,F;const I=_e("icon");return S(),E("div",{class:"widget-props-editor",style:he(w.value)},[_("div",ar,[_("div",lr,[_("h1",null,D(n(a.value)),1),x(I,{path:R(cs),fill:"#414A58",class:"close-icon",width:"16",height:"16",onClick:b[0]||(b[0]=P=>e("close"))},null,8,["path"])]),Tt()?(S(),E("div",cr,[dr,hr,_("pre",{class:"prop-error",textContent:D(Ct())},null,8,ur)])):$("",!0),c.value?(S(),E("div",pr,[_("div",{class:"section-header",onClick:b[1]||(b[1]=P=>o("variable"))},[x(I,{path:i("variable")?R(Ie):R(Pe),fill:"#414A58",class:"chevron-icon",width:"16",height:"16"},null,8,["path"]),gr]),i("variable")?(S(),E("div",fr,[_("div",vr,[mr,yr,_("div",wr,[x(Re,{placeholder:"variable_name","param-name":"variable","dash-player-service":y.dashPlayerService,value:(O=a.value.variable)!=null?O:"",commit:Rt,"is-code":!1,onInput:b[2]||(b[2]=P=>a.value.variable=P)},null,8,["dash-player-service","value"])]),Nt()&&a.value.variable?(S(),E("div",Sr,[_r,_("button",{onClick:b[3]||(b[3]=P=>At(a.value.variable))}," Create ")])):Ot()?(S(),E("pre",Er)):(F=l.value.variable)!=null&&F.repr?(S(),E("pre",{key:2,class:"prop-error",textContent:D(l.value.variable.repr)},null,8,br)):$("",!0),x(ot,{param:u.value},null,8,["param"])])])):$("",!0)])):$("",!0),j.value.length?(S(),E("div",Ir,[_("div",{class:"section-header",onClick:b[4]||(b[4]=P=>o("events"))},[x(I,{path:i("events")?R(Ie):R(Pe),fill:"#414A58",class:"chevron-icon",width:"16",height:"16"},null,8,["path"]),Pr]),i("events")?(S(),E("div",Rr,[Lr,(S(!0),E(ce,null,de(j.value,P=>(S(),E("div",{key:P.key,class:"widget-prop"},[_("label",xr,"On "+D(P.key),1),_("p",Or,"Executed after "+D(P.key),1),x(Re,{"param-name":P.key,"dash-player-service":y.dashPlayerService,value:a.value.events[P.key],commit:xt(P),"is-code":!0,onInput:re=>a.value.events[P.key]=re},null,8,["param-name","dash-player-service","value","commit","onInput"])]))),128))])):$("",!0)])):$("",!0),_("div",Nr,[_("div",{class:"section-header",onClick:b[5]||(b[5]=P=>o("properties"))},[x(I,{path:i("properties")?R(Ie):R(Pe),fill:"#414A58",class:"chevron-icon",width:"16",height:"16"},null,8,["path"]),Ar]),i("properties")?(S(),E("div",Tr,[Cr,(S(!0),E(ce,null,de(L.value,P=>{var re;return S(),E("div",{key:P.argName,class:"widget-prop"},[_("p",kr,D(kt(P.argName)),1),_("p",Wr,D(P.description),1),x(Re,{"has-error":!!be(P.argName),placeholder:(re=P.default)!=null?re:void 0,"param-name":P.argName,"dash-player-service":y.dashPlayerService,value:a.value.props[P.argName],commit:Lt(P),"is-code":!0,onInput:Wt=>a.value.props[P.argName]=Wt},null,8,["has-error","placeholder","param-name","dash-player-service","value","commit","onInput"]),be(P.argName)?(S(),E("pre",{key:0,class:"prop-error",textContent:D(be(P.argName))},null,8,Dr)):$("",!0),x(ot,{param:P},null,8,["param"])])}),128))])):$("",!0)])]),_("div",{ref_key:"handlerRef",ref:h,class:"handler",onMousedown:b[6]||(b[6]=Zt(P=>g.resizing=!0,["stop"]))},Mr,544)],4)}}});const Hr=U(Gr,[["__scopeId","data-v-718f02de"]]),vt=r=>($e("data-v-0d595f79"),r=r(),Me(),r),Br={class:"interact-menu"},zr={class:"icon-container"},Ur=vt(()=>_("span",{class:"edit"},"Edit [Shift + P]",-1)),Fr={class:"icon-container"},jr=vt(()=>_("span",null,"Interact [Shift + P]",-1)),Vr=z({__name:"InteractMenu",props:{isPreview:{type:Boolean}},emits:["changePreview"],setup(r,{emit:e}){return(t,s)=>{const o=_e("icon");return S(),E("div",Br,[_("div",zr,[x(o,{class:te(["icon",{active:!t.isPreview}]),path:R(ds),fill:"#5A677A",onClick:s[0]||(s[0]=i=>e("changePreview",!1))},null,8,["class","path"]),Ur]),_("div",Fr,[x(o,{class:te(["icon",{active:t.isPreview}]),path:R(hs),fill:"#5A677A",onClick:s[1]||(s[1]=i=>e("changePreview",!0))},null,8,["class","path"]),jr])])}}});const Zr=U(Vr,[["__scopeId","data-v-0d595f79"]]),Jr={class:"header"},Kr={key:0},Qr={key:1},qr={key:2,class:"state"},Yr={key:3,class:"state"},Xr={key:4,class:"state"},eo={key:5},to=z({__name:"RuntimeHeader",props:{dash:{},dashPlayerService:{}},setup(r){return(e,t)=>(S(),E("div",Jr,[e.dash.title?(S(),E("p",Kr,D(e.dash.title),1)):(S(),E("p",Qr,D(e.dash.path),1)),e.dashPlayerService.state.type==="RUNNING"?(S(),E("p",qr,"\u{1F7E2} running")):e.dashPlayerService.state.type==="ERROR"?(S(),E("p",Yr,"\u274C error")):e.dashPlayerService.state.type==="AUTHENTICATING"?(S(),E("p",Xr," \u{1F510} authenticating ")):e.dashPlayerService.state.type==="IDLE"?(S(),E("p",eo,"\u23F3 loading")):$("",!0)]))}});const so=U(to,[["__scopeId","data-v-eae88304"]]),ro={key:0,class:"widget-metadata-card"},oo=["src"],io={class:"metadata-title"},no={class:"metadata-description"},ao={key:1,class:"collapsed-widget-metadata-card"},lo=["src"],co=z({__name:"WidgetMetadataCard",props:{metadata:{},collapsed:{type:Boolean}},setup(r){const e=window.__baseURL?`${window.__baseURL}/media`:"",t=o=>o in ae?`${e}/${ae[o].thumbname}`:`${e}/widget-thumbs/${Mt(o)}.svg`,s=window.__vscodeTheme===2?"dark":"light";return(o,i)=>o.collapsed?(S(),E("div",ao,[_("img",{class:"metadata-thumbnail",src:t(o.metadata.type),style:he(R(s)==="dark"?{filter:"invert(1)"}:"")},null,12,lo)])):(S(),E("div",ro,[_("img",{class:"metadata-thumbnail",src:t(o.metadata.type),style:he(R(s)==="dark"?{filter:"invert(1)"}:"")},null,12,oo),_("div",io,D(o.metadata.name),1),_("div",no,D(o.metadata.description),1)]))}});const ho=U(co,[["__scopeId","data-v-2b654c57"]]),ve={"click-input":-1,"text-output":0,"number-input":1,"text-input":2,"link-output":3,"multiple-choice-input":4,"file-input":5,"email-input":6,"markdown-output":7,"dropdown-input":8,"date-input":9,"cards-input":10,"textarea-input":11,"list-input":12,"file-output":13,"html-output":14,"pandas-output":15,"checkbox-input":16,"cnpj-input":17,"code-input":18,"progress-output":19,"pandas-row-selection-input":20,"image-input":21,"password-input":22,"currency-input":23,"iframe-output":24,"checklist-input":25,"image-output":26,"nps-input":27,"phone-input":28},uo=z({__name:"WidgetsMetadataList",emits:["dragstart","hover","leave"],setup(r,{emit:e}){const t=k(""),s=k(),o=k(!0),i=()=>{o.value=!1},n=()=>{o.value=!0,c()},l=async()=>{await He(),s.value&&s.value.focus()},c=()=>{t.value=""},a=Object.values(V).concat(Object.entries(ae).map(([d,h])=>({type:d,...h}))).reduce((d,h)=>h.formOnly?d:{...d,[h.type]:h},{}),u=G(()=>t.value?Object.values(a).map(d=>({widget:d,score:Gt(d,t.value.split(" "))})).filter(({score:d})=>d>0).sort(({score:d},{score:h})=>h-d).map(({widget:d})=>d):Object.values(a).sort((d,h)=>{const g=d.type,f=h.type;if(g in ve){if(!(f in ve))return-1}else return 1;return ve[g]-ve[f]}));function p(d,h){e("dragstart",d,h)}return(d,h)=>{const g=_e("icon");return S(),E("div",{class:"widgets-metadata",onMouseover:i,onMouseleave:n},[_("div",Jt({class:["search",{collapsed:o.value}]},Kt(o.value?{click:l}:{},!0)),[x(g,{path:R(us),class:"search-icon"},null,8,["path"]),o.value?$("",!0):ge((S(),E("input",{key:0,ref_key:"searchInput",ref:s,"onUpdate:modelValue":h[0]||(h[0]=f=>t.value=f),type:"search",class:"widgets-metadata-filter",placeholder:"Find widgets"},null,512)),[[ht,t.value]])],16),_("div",{class:te(["widgets-metadata-list",{collapsed:o.value}])},[(S(!0),E(ce,null,de(u.value,f=>(S(),ee(ho,{key:f.type,metadata:f,draggable:!0,collapsed:o.value,onDragstart:w=>p(w,f.type)},{default:Y(()=>[Qt(D(f.type),1)]),_:2},1032,["metadata","collapsed","onDragstart"]))),128))],2)],32)}}});const po=U(uo,[["__scopeId","data-v-a17e6382"]]),go={class:"dash-layout-editor"},fo=z({__name:"DashLayoutEditor",props:{dash:{},params:{},dashEditorService:{},workspace:{}},emits:["navigate","create-variable","change-preview"],setup(r,{emit:e}){const t=r,s=k(null),o=k(null),i=(v,L)=>t.dashEditorService.metadataDragStart(v,L),n=v=>e("navigate",v),l=v=>e("create-variable",v),c=v=>e("change-preview",v);t.dashEditorService.pubsub.subscribe("change-preview",c);const a=()=>{t.dashEditorService.hoverZoomBar()},u=()=>{t.dashEditorService.leaveZoomBar()};le(t.dash.layout,()=>{t.dashEditorService.layoutModel.setLayout(t.dash.layout)}),t.dashEditorService.setupOnSave(),le(t.dashEditorService.layoutModel,()=>t.dashEditorService.setupOnSave());const p=G(()=>t.dashEditorService.getWidgetsWithErrors()),d=G(()=>t.dashEditorService.getSelectedWidgetErrors()),h=k(null),g=k(null),f=k(null),w=k(null);return gt(()=>{t.dashEditorService.selection.setLayoutModel(t.dashEditorService.layoutModel),f.value&&w.value&&g.value&&o.value&&s.value&&h.value&&t.dashEditorService.setup(f.value,w.value,g.value,o.value,s.value,h.value)}),pt(()=>{t.dashEditorService.tearDown()}),le(()=>t.dashEditorService.dashPlayerService.isAuthenticating(),v=>{v&&(t.dashEditorService.isPreview=!0)}),(v,L)=>(S(),E("div",go,[ge(x(po,{onDragstart:i},null,512),[[Ge,!v.dashEditorService.isPreview]]),_("div",{ref_key:"editor",ref:f,class:te(["editor"])},[_("div",{ref_key:"listeners",ref:w,class:"listeners",tabindex:"0"},[x(ss,{ref_key:"player",ref:s,class:te(["player",{preview:v.dashEditorService.isPreview}]),style:{top:0,left:0,height:"unset"},"is-preview":!0,params:v.params,camera:v.dashEditorService.camera,"editing-mode":!v.dashEditorService.isPreview,"force-responsivity":"desktop","widgets-with-errors":p.value,"dash-player-service":v.dashEditorService.dashPlayerService,onNavigate:n},null,8,["class","params","camera","editing-mode","widgets-with-errors","dash-player-service"]),_("canvas",{ref_key:"canvas",ref:g,class:te(["layout-canvas",{hide:v.dashEditorService.isPreview}])},null,2)],512),x(so,{ref_key:"runtimeHeader",ref:h,dash:v.dash,"dash-player-service":v.dashEditorService.dashPlayerService},null,8,["dash","dash-player-service"]),x(Zr,{ref_key:"interactMenu",ref:o,class:"interact-menu","is-preview":v.dashEditorService.isPreview,onChangePreview:c},null,8,["is-preview"])],512),(v.dashEditorService.selection.selectedWidgetsIds.length>0||v.dashEditorService.selection.selectedSlottableId)&&!v.dashEditorService.isPreview&&v.dashEditorService.mouseState.state==="IDLE"?(S(),ee(Hr,{key:0,"selected-widget-errors":d.value,"layout-model":v.dashEditorService.layoutModel,"selected-widgets":v.dashEditorService.selection.selectedSlottable?[v.dashEditorService.selection.selectedSlottable]:v.dashEditorService.selection.selectedWidgets,"dash-player-service":v.dashEditorService.dashPlayerService,onClose:L[0]||(L[0]=j=>v.dashEditorService.selection.resetSelection()),onCreateVariable:l},null,8,["selected-widget-errors","layout-model","selected-widgets","dash-player-service"])):$("",!0),x(Ws,{camera:v.dashEditorService.camera,class:"zoom-bar",onHover:a,onLeave:u},null,8,["camera"])]))}});const vo=U(fo,[["__scopeId","data-v-c2191cda"]]),mo="rgba(0, 128, 233, 0.05)";class ue{constructor(e,t){m(this,"context");this.canvas=e,this.context=this.canvas.getContext("2d"),t.slottableRenderer.setContext(this.context)}static create(e,t){return new ue(e,t)}render({mouseState:e,dashEditorService:t,hoverState:s,resizeHandlerRects:o,widgetsInRectangularSelection:i,selectedWidgets:n,computedState:l,isPreview:c,calculatedPositions:a,selectedSlottable:u}){const p=t.camera,d=t.dashPlayerService.layoutGrid,h=t.dashPlayerService.calculatePositions();if(t.dashPlayerService.state.type==="RUNNING"){if(!p)throw new Error("No camera value yet");this.renderFrame(d,p),this.renderGrid(d,p,e),this.renderWidgetShadow(l,d,p,a.widgets),this.renderInvisibleWidgets(p,a,d,h),this.renderWidgetHoverBorders(s,e,p,d,a.widgets),this.renderSelectionHull(e,p,d,n,a.widgets),this.renderWidgetsSelectionBorders(e,n,p,d,a.widgets),this.renderRectangularSelection(e),this.renderRectangularSelectionHovers(e,i,p,d,a.widgets),this.renderResizeHandlers(e,o),c||(t.slottableRenderer.slottables=a.slottables,t.slottableRenderer.renderSlottables(u))}}renderFrame(e,t){const s={x:0,y:0,width:e.width,height:e.height+e.navbarLength,referential:"world"};this.context.fillStyle="transparent",this.context.shadowColor="rgba(0,0,0,0.1)",this.context.shadowBlur=15;const o=t.worldRect2screen(s);this.context.fillRect(o.x,o.y,o.width,o.height),this.context.clearRect(o.x,o.y,o.width,o.height)}getGridDots(e,t){var u;const s=[];if(!e)return[];const o=t.worldPoint2screen({y:0,x:0,referential:"world"}),i=(u=t.projectedElement)==null?void 0:u.getBoundingClientRect(),n=e.margin*t.zoom,l=e.gap*t.zoom,c=e.cellHeight*t.zoom,a=(i.y+i.height-o.y-n)/(c+l);for(const p in Array(e.columns+1).fill(null))for(const d in Array(Math.ceil(a+1)).fill(null))s.push(t.worldPoint2screen({x:e.margin+parseInt(p)*(e.cellWidth+e.gap),y:e.margin+parseInt(d)*(e.cellHeight+e.gap)+e.navbarLength,referential:"world"}));return s}renderGrid(e,t,s){if(s.state==="MOVING"||s.state==="RESIZING"||s.state==="SLOTTABLE_RESIZING"||s.state==="MOVING_SLOTTABLE"||s.state==="DRAGGING_SLOTTABLE"||s.state==="DRAGGING"){this.context.fillStyle="rgba(0,0,0,0.1)";for(const o of this.getGridDots(e,t))this.context.beginPath(),this.context.ellipse(o.x,o.y,2,2,0,0,2*Math.PI),this.context.fill()}}renderWidgetShadow(e,t,s,o){this.context.fillStyle="rgba(0, 0, 0, 0.1)";for(const i in o){if(!e.operations.some(c=>c.path.includes(i)))continue;const n=o[i],l=s.worldRect2screen(B(n.position,t));this.context.fillRect(l.x,l.y,l.width,l.height)}}renderInvisibleWidgets(e,t,s,o){const n=t.widgets;for(const l in n){if(l in o.widgets)continue;const c=n[l],a=B(c.position,s),u={x:a.x+5,y:a.y+5,width:a.width-2*5,height:a.height-2*5,referential:"world"},p=e.worldRect2screen(u);this.context.fillStyle="rgba(0, 0, 0, 0.1)",this.context.fillRect(p.x,p.y,p.width,p.height),this.context.fillStyle="black",this.context.font="15px sans-serif",this.context.textAlign="center",this.context.textBaseline="middle",this.context.fillText(V[c.type].name,p.x+p.width/2,p.y+p.height/2)}}renderWidgetHoverBorders(e,t,s,o,i){if(this.context.strokeStyle="#ababab",e.state==="HOVERING_WIDGET"&&t.state==="IDLE"){const n=i[e.widgetId];if(!n)return;const l=s.worldRect2screen(B(n.position,o));this.context.strokeRect(l.x,l.y,l.width,l.height)}else(t.state==="MOVING"||t.state==="RESIZING"||t.state==="DRAGGING"||t.state==="SELECTING")&&Object.keys(i).forEach(n=>{const l=i[n],c=s.worldRect2screen(B(l.position,o));this.context.strokeRect(c.x,c.y,c.width,c.height)})}renderWidgetsSelectionBorders(e,t,s,o,i){if(e.state==="IDLE"||e.state==="SELECTING"){this.context.strokeStyle="#3482E5",this.context.lineWidth=2;for(const n of t){const l=i[n],c=s.worldRect2screen(B(l.position,o));this.context.strokeRect(c.x,c.y,c.width,c.height)}}}renderRectangularSelection(e){if(this.context.fillStyle=mo,e.state==="SELECTING"){const t=Math.min(e.initialMousePos.x,e.mousePos.x),s=Math.min(e.initialMousePos.y,e.mousePos.y),o=Math.abs(e.initialMousePos.x-e.mousePos.x),i=Math.abs(e.initialMousePos.y-e.mousePos.y),n={x:t,y:s,width:o,height:i};this.context.fillRect(n.x,n.y,o,i)}}renderRectangularSelectionHovers(e,t,s,o,i){if(this.context.strokeStyle="#3482E5",e.state==="SELECTING")for(const n of t){const l=i[n],c=s.worldRect2screen(B(l.position,o));this.context.strokeRect(c.x,c.y,c.width,c.height)}}renderSelectionHull(e,t,s,o,i){const n=Be(Object.entries(i).filter(([c])=>o.has(c)).map(([c,a])=>B(a.position,s)).filter(c=>c!==null));if(e.state!=="IDLE"||!n)return;this.context.strokeStyle="#3482E5";const l=t.worldRect2screen(n);this.context.strokeRect(l.x,l.y,l.width,l.height)}static drawResizeHandler(e,t){e.fillStyle="white",e.strokeStyle="#3482E5",e.lineWidth=1,e.fillRect(t.x,t.y,t.width,t.height),e.strokeRect(t.x,t.y,t.width,t.height)}renderResizeHandlers(e,t){if(e.state!=="MOVING")for(const{rect:s}of t)ue.drawResizeHandler(this.context,s)}cursor(e,t){if(e.state==="MOVING")return"grabbing";if(e.state==="SELECTING")return"crosshair";if(e.state==="RESIZING")switch(e.side){case"bottom":case"top":return"ns-resize";case"left":case"right":return"ew-resize"}else{if(e.state==="START_PANNING")return"grab";if(e.state==="PANNING")return"grabbing";if(e.state==="JUST_CLICKED_TOGGLE")return"grabbing";if(t.state==="HOVERING_WIDGET")return"grab";if(t.state==="HOVERING_RESIZE_HANDLER")switch(t.side){case"bottom":case"top":return"ns-resize";case"left":case"right":return"ew-resize";case"top-left":case"bottom-right":return"nwse-resize";case"top-right":case"bottom-left":return"nesw-resize"}else return t.state==="HOVERING_TOGGLE"?"pointer":t.state==="HOVERING_SLOTTABLE_RESIZE_HANDLER"?"ns-resize":t.state==="HOVERING_SLOTTABLE_SELECTOR"?"pointer":"default"}}}const Oe=()=>document.body.classList.contains("vscode-dark"),Ne=window.__baseURL?`${window.__baseURL}/media`:"",yo=(r,e,t,s,o,i)=>{let n=[];return mt(e)||(i||(n=n.concat(Eo(r,t,s,o))),i&&(n=n.concat(wo(r,t,s,o)).concat(So(r,t,s,o)))),n.concat(bo(r,t,s,e,o)).concat(Po(r,t,s,o))},mt=r=>{var e;return!((e=r.condition)==null||e)},wo=(r,e,t,s)=>{const{row:o,height:i}=r.position,{x:n,y:l,height:c,width:a}=e.getCell(0,o),u=i*c,p=a*e.columns,d={x:n,y:l,width:p,height:u,referential:"world"},h=3,g=2,f=t.worldRect2screen(d);return s.strokeStyle="#3482E5",s.lineWidth=g,s.strokeRect(f.x+h,f.y,f.width-2*h,f.height),[]},So=(r,e,t,s)=>{const o=_o(r,e,t);return ue.drawResizeHandler(s,o),[{type:"resizer",position:o,elementId:r.id}]},_o=(r,e,t)=>{const{row:i,height:n}=r.position,{x:l,y:c,height:a,width:u}=e.getCell(0,i),p=n*a,d=u*e.columns,h=t.worldRect2screen({x:l,y:c,width:d,height:p,referential:"world"});return{x:h.x+h.width/2-20/2,y:h.y+h.height-6/2,width:20,height:6,referential:"screen"}},Eo=(r,e,t,s)=>{const{row:o,height:i}=r.position,{x:n,y:l,height:c,width:a}=e.getCell(0,o),u=i*c,p=a*e.columns,d={x:n,y:l,width:p,height:u,referential:"world"},h=4,g=3,f=2,w=t.worldRect2screen(d);return s.strokeStyle="rgb(39, 67, 255, 0.13)",s.lineWidth=f,s.beginPath(),s.roundRect(w.x+g,w.y,w.width-2*g,w.height,h),s.stroke(),[]},bo=(r,e,t,s,o)=>{const{row:i,height:n}=r.position,l=Io(i,n,e,t),c=new Image(l.width,l.height);return c.src=mt(s)?`${Ne}/chevron-down-${Oe()?"dark":"light"}.svg`:`${Ne}/chevron-up-${Oe()?"dark":"light"}.svg`,c.style.viewBox=`0 0 ${l.width} ${l.height}`,o.drawImage(c,l.x,l.y,l.width,l.height),[{type:"toggle",position:l,elementId:r.id}]},Io=(r,e,t,s)=>{const{y:o}=t.getCell(0,e),i=24,n=24,l={x:-30,y:o+t.cellHeight*r-n,width:i,height:n,referential:"world"};return s.worldRect2screen(l)},Po=(r,e,t,s)=>{const{row:o}=r.position,i=Ro(o,e,t),n=new Image(i.width,i.height);return n.src=`${Ne}/drag-${Oe()?"dark":"light"}.svg`,s.drawImage(n,i.x,i.y,i.width,i.height),[{type:"selector",position:i,elementId:r.id}]},Ro=(r,e,t)=>{const{y:s}=e.getCell(0,r),o={x:-30,y:s,width:24,height:24,referential:"world"};return t.worldRect2screen(o)},Lo={"if-block":yo};class Fe{constructor(e,t){m(this,"context",null);m(this,"_slottables",[]);m(this,"selectableElements",[]);m(this,"getSlottableRenderedElement",(e,t)=>{var s;return(s=this.selectableElements.find(o=>o.elementId===e&&o.type===t))!=null?s:null});m(this,"getRenderedElementUnderCursor",(e,t)=>this._slottables.find(s=>{var i,n;const o=(n=(i=this.getSlottableRenderedElement(s.id,e))==null?void 0:i.position)!=null?n:null;return o?xe(t,o):!1})||null);m(this,"getSelectorUnderCursor",e=>this.getRenderedElementUnderCursor("selector",e));m(this,"getToggleUnderCursor",e=>this.getRenderedElementUnderCursor("toggle",e));m(this,"getResizerUnderCursor",e=>this.getRenderedElementUnderCursor("resizer",e));this.layoutGrid=e,this.camera=t}static create(e,t){return new Fe(e,t)}setContext(e){this.context=e}set slottables(e){if(!this.context)throw new Error("No context set yet");this._slottables=Object.values(e)}renderSlottables(e){if(this.selectableElements=[],this._slottables.length!==0)for(const t of this._slottables)this.selectableElements=this.selectableElements.concat(this.renderSlottable(t,e===t.id))}renderSlottable(e,t){return Lo[e.type](e,e.props,this.layoutGrid,this.camera,this.context,t)}}const xo=r=>e=>e[r],Oo=r=>[...new Set(r)];class je{constructor(){m(this,"_selectedWidgetsIds");m(this,"_selectedSlottableId");m(this,"layoutModel");this.layoutModel=null,this._selectedSlottableId=k(null),this._selectedWidgetsIds=k([])}static create(){return new je}setLayoutModel(e){this.layoutModel=e}get selectedWidgetsIds(){return this._selectedWidgetsIds.value}set selectedWidgetsIds(e){e.length!==0&&this.resetSelection(),this._selectedWidgetsIds.value=Oo(e)}get selectedWidgetId(){return this.selectedWidgetsIds[0]}get selectedWidget(){return this.layoutModel&&this.selectedWidgetId?this.layoutModel.getWidget(this.selectedWidgetId):null}get selectedWidgets(){return this.layoutModel?this.selectedWidgetsIds.map(e=>this.layoutModel.getWidget(e)):[]}addWidget(e){this.selectedWidgetsIds=[...this.selectedWidgetsIds,e]}addToSelectedWidgets(e){if(!this.layoutModel)return;const t=this.layoutModel.getWidgetOrSlottable(e);(!W(t)||this.selectedWidget&&!W(this.selectedWidget))&&this.clearWidgetSelection(),this.addWidget(e)}toggleWidgetSelection(e){this.selectedWidgetsIds.includes(e)?this.removeWidget(e):this.addWidget(e)}removeWidget(e){this.selectedWidgetsIds=this.selectedWidgetsIds.filter(t=>t!==e)}clearWidgetSelection(){this.selectedWidgetsIds=[]}selectAll(){!this.layoutModel||(this.selectedWidgetsIds=Object.keys(this.layoutModel.allWidgets))}get selectedSlottableId(){return this._selectedSlottableId.value}set selectedSlottableId(e){e&&this.resetSelection(),this._selectedSlottableId.value=e}get selectedSlottable(){return this.layoutModel&&this.selectedSlottableId?this.layoutModel.getSlottable(this.selectedSlottableId):null}has(e){return this.selectedWidgetsIds.includes(e)}resetSelection(){this.clearWidgetSelection(),this.selectedSlottableId=null}}const No=r=>e=>H.exports.uniq(r.map(xo(e))).length===1,Ao=r=>r.some(e=>V[e.type].autoHeight);function To(r,e){const t=No(r),s=Ao(r),o=[],i=16,n=6;return t("colStart")&&o.push({rect:{x:e.x-n/2,y:e.y+e.height/2-i/2,width:n,height:i,referential:"screen"},side:"left"}),t("colEnd")&&o.push({rect:{x:e.x+e.width-n/2,y:e.y+e.height/2-i/2,width:n,height:i,referential:"screen"},side:"right"}),t("colStart")&&t("rowStart")&&!s&&o.push({rect:{x:e.x-n/2,y:e.y-n/2,width:n,height:n,referential:"screen"},side:"top-left"}),t("colEnd")&&t("rowStart")&&!s&&o.push({rect:{x:e.x+e.width-n/2,y:e.y-n/2,width:n,height:n,referential:"screen"},side:"top-right"}),t("colStart")&&t("rowEnd")&&!s&&o.push({rect:{x:e.x-n/2,y:e.y+e.height-n/2,width:n,height:n,referential:"screen"},side:"bottom-left"}),t("colEnd")&&t("rowEnd")&&!s&&o.push({rect:{x:e.x+e.width-n/2,y:e.y+e.height-n/2,width:n,height:n,referential:"screen"},side:"bottom-right"}),t("rowStart")&&!s&&o.push({rect:{x:e.x+e.width/2-i/2,y:e.y-n/2,width:i,height:n,referential:"screen"},side:"top"}),t("rowEnd")&&!s&&o.push({rect:{x:e.x+e.width/2-i/2,y:e.y+e.height-n/2,width:i,height:n,referential:"screen"},side:"bottom"}),o}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */var Co=globalThis&&globalThis.__extends||function(){var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,o){s.__proto__=o}||function(s,o){for(var i in o)o.hasOwnProperty(i)&&(s[i]=o[i])},r(e,t)};return function(e,t){r(e,t);function s(){this.constructor=e}e.prototype=t===null?Object.create(t):(s.prototype=t.prototype,new s)}}(),ko=Object.prototype.hasOwnProperty;function Ae(r,e){return ko.call(r,e)}function Te(r){if(Array.isArray(r)){for(var e=new Array(r.length),t=0;t<e.length;t++)e[t]=""+t;return e}if(Object.keys)return Object.keys(r);var s=[];for(var o in r)Ae(r,o)&&s.push(o);return s}function M(r){switch(typeof r){case"object":return JSON.parse(JSON.stringify(r));case"undefined":return null;default:return r}}function Ce(r){for(var e=0,t=r.length,s;e<t;){if(s=r.charCodeAt(e),s>=48&&s<=57){e++;continue}return!1}return!0}function X(r){return r.indexOf("/")===-1&&r.indexOf("~")===-1?r:r.replace(/~/g,"~0").replace(/\//g,"~1")}function yt(r){return r.replace(/~1/g,"/").replace(/~0/g,"~")}function ke(r){if(r===void 0)return!0;if(r){if(Array.isArray(r)){for(var e=0,t=r.length;e<t;e++)if(ke(r[e]))return!0}else if(typeof r=="object"){for(var s=Te(r),o=s.length,i=0;i<o;i++)if(ke(r[s[i]]))return!0}}return!1}function nt(r,e){var t=[r];for(var s in e){var o=typeof e[s]=="object"?JSON.stringify(e[s],null,2):e[s];typeof o<"u"&&t.push(s+": "+o)}return t.join(`
`)}var wt=function(r){Co(e,r);function e(t,s,o,i,n){var l=this.constructor,c=r.call(this,nt(t,{name:s,index:o,operation:i,tree:n}))||this;return c.name=s,c.index=o,c.operation=i,c.tree=n,Object.setPrototypeOf(c,l.prototype),c.message=nt(t,{name:s,index:o,operation:i,tree:n}),c}return e}(Error),N=wt,Wo=M,ne={add:function(r,e,t){return r[e]=this.value,{newDocument:t}},remove:function(r,e,t){var s=r[e];return delete r[e],{newDocument:t,removed:s}},replace:function(r,e,t){var s=r[e];return r[e]=this.value,{newDocument:t,removed:s}},move:function(r,e,t){var s=ye(t,this.path);s&&(s=M(s));var o=se(t,{op:"remove",path:this.from}).removed;return se(t,{op:"add",path:this.path,value:o}),{newDocument:t,removed:s}},copy:function(r,e,t){var s=ye(t,this.from);return se(t,{op:"add",path:this.path,value:M(s)}),{newDocument:t}},test:function(r,e,t){return{newDocument:t,test:pe(r[e],this.value)}},_get:function(r,e,t){return this.value=r[e],{newDocument:t}}},Do={add:function(r,e,t){return Ce(e)?r.splice(e,0,this.value):r[e]=this.value,{newDocument:t,index:e}},remove:function(r,e,t){var s=r.splice(e,1);return{newDocument:t,removed:s[0]}},replace:function(r,e,t){var s=r[e];return r[e]=this.value,{newDocument:t,removed:s}},move:ne.move,copy:ne.copy,test:ne.test,_get:ne._get};function ye(r,e){if(e=="")return r;var t={op:"_get",path:e};return se(r,t),t.value}function se(r,e,t,s,o,i){if(t===void 0&&(t=!1),s===void 0&&(s=!0),o===void 0&&(o=!0),i===void 0&&(i=0),t&&(typeof t=="function"?t(e,0,r,e.path):we(e,0)),e.path===""){var n={newDocument:r};if(e.op==="add")return n.newDocument=e.value,n;if(e.op==="replace")return n.newDocument=e.value,n.removed=r,n;if(e.op==="move"||e.op==="copy")return n.newDocument=ye(r,e.from),e.op==="move"&&(n.removed=r),n;if(e.op==="test"){if(n.test=pe(r,e.value),n.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",i,e,r);return n.newDocument=r,n}else{if(e.op==="remove")return n.removed=r,n.newDocument=null,n;if(e.op==="_get")return e.value=r,n;if(t)throw new N("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,r);return n}}else{s||(r=M(r));var l=e.path||"",c=l.split("/"),a=r,u=1,p=c.length,d=void 0,h=void 0,g=void 0;for(typeof t=="function"?g=t:g=we;;){if(h=c[u],h&&h.indexOf("~")!=-1&&(h=yt(h)),o&&(h=="__proto__"||h=="prototype"&&u>0&&c[u-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(a[h]===void 0?d=c.slice(0,u).join("/"):u==p-1&&(d=e.path),d!==void 0&&g(e,0,r,d)),u++,Array.isArray(a)){if(h==="-")h=a.length;else{if(t&&!Ce(h))throw new N("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,r);Ce(h)&&(h=~~h)}if(u>=p){if(t&&e.op==="add"&&h>a.length)throw new N("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,r);var n=Do[e.op].call(e,a,h,r);if(n.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",i,e,r);return n}}else if(u>=p){var n=ne[e.op].call(e,a,h,r);if(n.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",i,e,r);return n}if(a=a[h],t&&u<p&&(!a||typeof a!="object"))throw new N("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,r)}}}function A(r,e,t,s,o){if(s===void 0&&(s=!0),o===void 0&&(o=!0),t&&!Array.isArray(e))throw new N("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");s||(r=M(r));for(var i=new Array(e.length),n=0,l=e.length;n<l;n++)i[n]=se(r,e[n],t,!0,o,n),r=i[n].newDocument;return i.newDocument=r,i}function $o(r,e,t){var s=se(r,e);if(s.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",t,e,r);return s.newDocument}function we(r,e,t,s){if(typeof r!="object"||r===null||Array.isArray(r))throw new N("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,r,t);if(ne[r.op]){if(typeof r.path!="string")throw new N("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,r,t);if(r.path.indexOf("/")!==0&&r.path.length>0)throw new N('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,r,t);if((r.op==="move"||r.op==="copy")&&typeof r.from!="string")throw new N("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,r,t);if((r.op==="add"||r.op==="replace"||r.op==="test")&&r.value===void 0)throw new N("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,r,t);if((r.op==="add"||r.op==="replace"||r.op==="test")&&ke(r.value))throw new N("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,r,t);if(t){if(r.op=="add"){var o=r.path.split("/").length,i=s.split("/").length;if(o!==i+1&&o!==i)throw new N("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,r,t)}else if(r.op==="replace"||r.op==="remove"||r.op==="_get"){if(r.path!==s)throw new N("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,r,t)}else if(r.op==="move"||r.op==="copy"){var n={op:"_get",path:r.from,value:void 0},l=St([n],t);if(l&&l.name==="OPERATION_PATH_UNRESOLVABLE")throw new N("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,r,t)}}}else throw new N("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,r,t)}function St(r,e,t){try{if(!Array.isArray(r))throw new N("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)A(M(e),M(r),t||!0);else{t=t||we;for(var s=0;s<r.length;s++)t(r[s],s,e,void 0)}}catch(o){if(o instanceof N)return o;throw o}}function pe(r,e){if(r===e)return!0;if(r&&e&&typeof r=="object"&&typeof e=="object"){var t=Array.isArray(r),s=Array.isArray(e),o,i,n;if(t&&s){if(i=r.length,i!=e.length)return!1;for(o=i;o--!==0;)if(!pe(r[o],e[o]))return!1;return!0}if(t!=s)return!1;var l=Object.keys(r);if(i=l.length,i!==Object.keys(e).length)return!1;for(o=i;o--!==0;)if(!e.hasOwnProperty(l[o]))return!1;for(o=i;o--!==0;)if(n=l[o],!pe(r[n],e[n]))return!1;return!0}return r!==r&&e!==e}const Mo=Object.freeze(Object.defineProperty({__proto__:null,JsonPatchError:N,deepClone:Wo,getValueByPointer:ye,applyOperation:se,applyPatch:A,applyReducer:$o,validator:we,validate:St,_areEquals:pe},Symbol.toStringTag,{value:"Module"}));/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2021 Joachim Wester
 * MIT license
 */var Ve=new WeakMap,Go=function(){function r(e){this.observers=new Map,this.obj=e}return r}(),Ho=function(){function r(e,t){this.callback=e,this.observer=t}return r}();function Bo(r){return Ve.get(r)}function zo(r,e){return r.observers.get(e)}function Uo(r,e){r.observers.delete(e.callback)}function Fo(r,e){e.unobserve()}function jo(r,e){var t=[],s,o=Bo(r);if(!o)o=new Go(r),Ve.set(r,o);else{var i=zo(o,e);s=i&&i.observer}if(s)return s;if(s={},o.value=M(r),e){s.callback=e,s.next=null;var n=function(){We(s)},l=function(){clearTimeout(s.next),s.next=setTimeout(n)};typeof window<"u"&&(window.addEventListener("mouseup",l),window.addEventListener("keyup",l),window.addEventListener("mousedown",l),window.addEventListener("keydown",l),window.addEventListener("change",l))}return s.patches=t,s.object=r,s.unobserve=function(){We(s),clearTimeout(s.next),Uo(o,s),typeof window<"u"&&(window.removeEventListener("mouseup",l),window.removeEventListener("keyup",l),window.removeEventListener("mousedown",l),window.removeEventListener("keydown",l),window.removeEventListener("change",l))},o.observers.set(e,new Ho(e,s)),s}function We(r,e){e===void 0&&(e=!1);var t=Ve.get(r.object);Ze(t.value,r.object,r.patches,"",e),r.patches.length&&A(t.value,r.patches);var s=r.patches;return s.length>0&&(r.patches=[],r.callback&&r.callback(s)),s}function Ze(r,e,t,s,o){if(e!==r){typeof e.toJSON=="function"&&(e=e.toJSON());for(var i=Te(e),n=Te(r),l=!1,c=n.length-1;c>=0;c--){var a=n[c],u=r[a];if(Ae(e,a)&&!(e[a]===void 0&&u!==void 0&&Array.isArray(e)===!1)){var p=e[a];typeof u=="object"&&u!=null&&typeof p=="object"&&p!=null&&Array.isArray(u)===Array.isArray(p)?Ze(u,p,t,s+"/"+X(a),o):u!==p&&(o&&t.push({op:"test",path:s+"/"+X(a),value:M(u)}),t.push({op:"replace",path:s+"/"+X(a),value:M(p)}))}else Array.isArray(r)===Array.isArray(e)?(o&&t.push({op:"test",path:s+"/"+X(a),value:M(u)}),t.push({op:"remove",path:s+"/"+X(a)}),l=!0):(o&&t.push({op:"test",path:s,value:r}),t.push({op:"replace",path:s,value:e}))}if(!(!l&&i.length==n.length))for(var c=0;c<i.length;c++){var a=i[c];!Ae(r,a)&&e[a]!==void 0&&t.push({op:"add",path:s+"/"+X(a),value:M(e[a])})}}}function Vo(r,e,t){t===void 0&&(t=!1);var s=[];return Ze(r,e,s,"",t),s}const Zo=Object.freeze(Object.defineProperty({__proto__:null,unobserve:Fo,observe:jo,generate:We,compare:Vo},Symbol.toStringTag,{value:"Module"}));Object.assign({},Mo,Zo,{JsonPatchError:wt,deepClone:M,escapePathComponent:X,unescapePathComponent:yt});function Je(r,e,t){const{selectedWidgets:s,dashEditorService:o}=r,i=o.dashPlayerService.layoutGrid,n=[...s,...t||[]],l=Math.min(...n.map(d=>{var h,g;return(g=(h=Q(d,e))==null?void 0:h.colStart)!=null?g:null}).filter(d=>d!==null)),c=Math.max(...n.map(d=>{var h,g;return(g=(h=Q(d,e))==null?void 0:h.colEnd)!=null?g:null}).filter(d=>d!==null)),a=Math.min(...n.map(d=>{var h,g;return(g=(h=Q(d,e))==null?void 0:h.rowStart)!=null?g:null}).filter(d=>d!==null)),u=c>i.columns-1?i.columns-1-c:l<0?-l:0,p=a<0?-a:0;return n.flatMap(d=>{const h=Q(d,e);if(u===0&&p===0)return[];if(!h||!W(h))return[];const g=J(Z(d,C(e)),e);return[{op:"replace",path:`${g}/${d}/colStart`,backup:h,value:h.colStart+u},{op:"replace",path:`${g}/${d}/colEnd`,backup:h,value:h.colEnd+u},{op:"replace",path:`${g}/${d}/rowStart`,backup:h,value:h.rowStart+p},{op:"replace",path:`${g}/${d}/rowEnd`,backup:h,value:h.rowEnd+p}]})}const Z=(r,e,t=null)=>{for(const s in e){const o=e[s];if(W(o)){if(s==r)return t}else{const i=Z(r,o.slot,s);if(i)return i}}return null},Jo=(r,e)=>r.rowStart>=e.row&&r.rowStart<e.row+e.height,_t=(r,e)=>{var t;return(t=Object.keys(e.slottables).find(s=>Jo(r,e.slottables[s].position)))!=null?t:null},at=(r,e)=>{const t=C(e),s=(i,n,l)=>{for(const c in n){if(c==i)return l;const a=n[c];if(W(a))continue;const u=s(i,a.slot,`${l}/${c}/slot`);if(u)return u}return null},o=s(r,t,me(e));if(!o)throw new Error("Widget not found in layout");return o},J=(r,e)=>r?`${me(e)}/${r}/slot`:me(e),Se=(r,e,t)=>{if(t){const o=e.slottables[t];return{...r,rowStart:r.rowStart-o.position.row,rowEnd:r.rowEnd-o.position.row}}const s=Object.values(e.slottables).reduce((o,i)=>o+(i.position.row<r.rowStart?i.position.height:0),0);return{...r,rowStart:r.rowStart-s,rowEnd:r.rowEnd-s}};function Ko(r){const{dashEditorService:e,mouseState:t,workingLayout:s,calculatedPositions:o}=r,i=e.dashPlayerService.layoutGrid;if(t.state!=="MOVING_SLOTTABLE")return[];const n=i.cellAt(t.mousePos.x,t.mousePos.y),l=[],c=t.slottableId,a=s.getSlottable(c);if(!a)throw new Error("Slottable not found");const u=It(bt(n,a.height),o,c);return l.push({op:"replace",path:`/slot/${c}/row`,backup:a.row,value:u.row}),l.push({op:"replace",path:`/slot/${c}/order`,backup:a.order,value:u.order}),l}function Qo(r,e){const{mouseState:t,selectedWidgets:s,calculatedPositions:o,workingLayout:i,dashEditorService:n}=r,l=n.dashPlayerService.layoutGrid;if(t.state!=="MOVING")return[];const c=l.cellAt(t.initialMousePos.x,t.initialMousePos.y),a=l.cellAt(t.mousePos.x,t.mousePos.y),u={deltaI:a.i-c.i,deltaJ:a.j-c.j},p=[];for(const d of s){const h=o.widgets[d],g={colStart:h.position.colStart+u.deltaI,colEnd:h.position.colEnd+u.deltaI,rowStart:h.position.rowStart+u.deltaJ,rowEnd:h.position.rowEnd+u.deltaJ},f=J(Z(d,C(i.layout)),i.layout),w=_t(g,o),v=J(w,i.layout),L=oe(d,C(e));!L||!W(L)||(f===v?p.push({op:"replace",path:`${f}/${d}`,backup:L,value:{...L,...Se(g,o,w)}}):(p.push({op:"remove",path:`${f}/${d}`,backup:L}),p.push({op:"add",path:`${v}/${d}`,value:{...L,...Se(g,o,w)}})))}return p}function qo(r,e,t,s){const o=[];for(const i of r.selectedWidgets){const n=J(Z(i,C(s)),s),l=Q(i,s);!W(l)||(o.push({op:"replace",path:`${n}/${i}/colStart`,backup:l,value:l.colStart+e}),o.push({op:"replace",path:`${n}/${i}/colEnd`,backup:l,value:l.colEnd+e}),o.push({op:"replace",path:`${n}/${i}/rowStart`,backup:l,value:l.rowStart+t}),o.push({op:"replace",path:`${n}/${i}/rowEnd`,backup:l,value:l.rowEnd+t}))}return o}function Et(r,e,t,s){const{mouseState:o,dashEditorService:i}=r,n=i.dashPlayerService.layoutGrid,l=i.camera;if(!l)throw new Error("No camera value yet");if(o.state!=="RESIZING"&&o.state!=="SLOTTABLE_RESIZING")return null;const c=o.side,a=l.screenPoint2world(o.mousePos),u=c==="bottom"||c==="right"?"bottom-right":"top-left",p=n.snap(a,u),d=c.includes("left")?p.x:e.x,h=c.includes("top")?p.y:e.y,g=c.includes("right")?p.x:e.x+e.width,f=c.includes("bottom")?p.y:e.y+e.height,w=Math.abs(g-d),v=Math.abs(f-h);let L={x:Math.min(d,g),y:Math.min(h,f),width:w,height:v,referential:p.referential};return w<t&&(L={...L,width:t}),v<s&&(L={...L,height:s}),L}const Yo=({selectedWidgets:r,calculatedPositions:e,dashEditorService:t})=>{const s=t.dashPlayerService.layoutGrid;return Be(Object.entries(e.widgets).filter(([o])=>r.has(o)).map(([o,i])=>B(e.widgets[o].position,s)).filter(o=>o!==null))};function Xo(r){const{mouseState:e,dashEditorService:t,calculatedPositions:s}=r,o=t.dashPlayerService.layoutGrid;if(e.state!=="SLOTTABLE_RESIZING")return[];const i=s.slottables[e.slottableId],n={colStart:0,rowStart:i.position.row,colEnd:o.columns,rowEnd:i.position.row+i.position.height},l=o.rectFromArea(n);if(!l)return[];const c=Et(r,l,o.width,o.cellHeight);if(!c)return[];const a=o.areaFromRect(c);return[{op:"replace",path:`/slot/${e.slottableId}/height`,backup:i.position.height,value:a.rowEnd-a.rowStart+1}]}function ei(r){const{mouseState:e,selectedWidgets:t,dashEditorService:s,workingLayout:o,calculatedPositions:i}=r,n=s.dashPlayerService.layoutGrid;if(e.state!=="RESIZING")return[];const l=e.side,c=Yo(r);if(!c)return[];const a=Array.from(t).filter(d=>{const h=i.widgets[d];return _s(B(h.position,n),c,l)}),{minWidth:u,minHeight:p}=V[e.type].dashProperties;return a.flatMap(d=>{const h=i.widgets[d],g=B(h.position,n),f=Et(r,g,u,p);if(!f)return[];const w=Z(d,C(o.layout)),v=J(w,o.layout),L=n.areaFromRect(g),j=Se(n.areaFromRect(f),i,w);return[{op:"replace",path:`${v}/${d}/colStart`,backup:L.colStart,value:Math.max(j.colStart,0)},{op:"replace",path:`${v}/${d}/colEnd`,backup:L.colEnd,value:Math.min(j.colEnd,n.columns-1)},{op:"replace",path:`${v}/${d}/rowStart`,backup:L.rowStart,value:Math.max(j.rowStart,0)},{op:"replace",path:`${v}/${d}/rowEnd`,backup:L.rowEnd,value:j.rowEnd}]})}function ti(r){const{mouseState:e,dashEditorService:t,calculatedPositions:s}=r,o=t.dashPlayerService.layoutGrid;if(e.state!=="DRAGGING")return{operations:[]};const i=Object.values(V[e.type].pythonAPI.params).reduce((g,f)=>(f.isKwarg||!f.dashesInitialValue||(g[f.argName]=f.dashesInitialValue),g),{}),{initialWidth:n,initialHeight:l}=V[e.type].dashProperties,c=o.areaFromRect({x:e.x,y:e.y,width:n,height:l,referential:"world"}),a=_t(c,s),u=J(a,r.workingLayout.layout),p=Ee(),d={id:p,type:e.type,props:{...i},...Se(c,s,a),events:{}};return{operations:[{op:"add",path:`${u}/${p}`,value:d}],widgetId:p}}const bt=({j:r},e)=>({row:r,height:e,order:0}),si=(r,e)=>Object.keys(r).reduce((t,s)=>(s===e||(t[s]=r[s]),t),{}),It=(r,e,t)=>{const s=t?{...e,slottables:si(e.slottables,t)}:e,o=Math.max(Object.values(s.slottables).reduce((n,l)=>l.position.row>=r.row?n:l.position.row+l.position.height<=r.row?n-l.position.height:n-(r.row-l.position.row),r.row),0),i=ri(r,s);return{...r,row:o,order:i}},lt=(r,e,t)=>Object.values(e.slottables).filter(s=>s.id!==t).find(s=>r.row>=s.position.row+s.position.height/2&&r.row<=s.position.row+s.position.height),ct=(r,e,t)=>Object.values(e.slottables).filter(s=>s.id!==t).filter(s=>s.position.row+s.position.height/2>r.row&&s.position.row<=r.row+r.height).reduce((s,o)=>!s||o.position.order<s.position.order?o:s,null),ri=(r,e)=>{var u,p;const t=lt(r,e),s=ct(r,e),o=t?ct(t.position,e,t.id):null,i=s?lt(s.position,e,s.id):null,n=[t,i].reduce((d,h)=>d?h&&d.position.order>h.position.order?h:d:h,null),l=[s,o].reduce((d,h)=>d?h&&d.position.order<h.position.order?h:d:h,null);if(!n&&!l)return 0;const c=(u=n==null?void 0:n.position.order)!=null?u:l.position.order-2,a=(p=l==null?void 0:l.position.order)!=null?p:n.position.order+2;return(c+a)/2};function oi(r){const{mouseState:e,dashEditorService:t,calculatedPositions:s}=r,o=t.dashPlayerService.layoutGrid;if(e.state!=="DRAGGING_SLOTTABLE")return{operations:[]};const i=o.cellAt(e.x,e.y),n=Ee(),l={id:n,type:e.type,props:{condition:"True"},slot:{},...It(bt(i,1),s)};return{operations:[{op:"add",path:`/slot/${n}`,value:l}],widgetId:n}}function ii(r,e){const{mouseState:t,selectedWidgets:s}=r;if(t.state!=="MOVING"||!t.duplicating)return[];const o=[];for(const i of s){const n=J(Z(i,C(e)),e),l=Q(i,e);if(!l)continue;const c=Ee();o.push({op:"add",path:`${n}/${c}`,value:{...H.exports.cloneDeep(l),id:c}})}return o}function Pt(r,e,t){const s=r.selectedWidgets,o=s.keys().next().value,i=Z(o,C(e)),n=i?De(i,e).slot:C(e),c=Object.keys(n).filter(p=>!s.has(p)&&!(t!=null&&t.some(d=>p==d))&&W(n[p])).sort((p,d)=>Es(oe(p,C(e)),oe(d,C(e)))),a=[...s,...t||[]].map(p=>oe(p,C(e))).filter(p=>p!=null),u=[];return c.forEach(p=>{const d=oe(p,C(e));if(!d||!W(d))return;let h=0,g={...d};const f=()=>a.some(w=>ft(g,w));for(;f();)h++,g={...d,rowStart:d.rowStart+h,rowEnd:d.rowEnd+h};if(h){const w=J(i,e);u.push({op:"replace",path:`${w}/${p}/rowStart`,backup:d.rowStart,value:d.rowStart+h}),u.push({op:"replace",path:`${w}/${p}/rowEnd`,backup:d.rowEnd,value:d.rowEnd+h})}a.push(g)}),u}function ni(r,e,t,s){const o=r.selectedWidgets;if(!o.size)return[];const i=[...o],n=[];return i.some(c=>{const a=Z(c,C(s)),u=a?De(a,s).slot:C(s),p=Object.keys(u).filter(h=>!o.has(h)&&W(u[h])),d=Q(c,s);return p.some(h=>ft(d,u[h]))})&&o.forEach(c=>{const a=oe(c,C(s)),u=J(Z(c,C(s)),s);!a||!W(a)||(n.push({op:"replace",path:`${u}/${c}/rowStart`,backup:a.rowStart,value:a.rowStart-t}),n.push({op:"replace",path:`${u}/${c}/rowEnd`,backup:a.rowEnd,value:a.rowEnd-t}),n.push({op:"replace",path:`${u}/${c}/colStart`,backup:a.colStart,value:a.colStart-e}),n.push({op:"replace",path:`${u}/${c}/colEnd`,backup:a.colEnd,value:a.colEnd-e}))}),n}function ai(r,e){const t=[],s=[];for(const o of e){const i=Ee();t.push({op:"add",path:`/slot/${i}`,value:{...H.exports.cloneDeep(o),id:i}}),s.push(i)}return{operations:t,widgetsId:s}}function li(r){const e=M(r.workingLayout.layout),t=ii(r,e);A(e,t);const s=Ko(r);A(e,s);const o=Qo(r,e);A(e,o);const i=ei(r);A(e,i);const n=Xo(r);A(e,n);const l=ti(r);A(e,l.operations);const c=oi(r);A(e,c.operations);const a=Je(r,e,l.widgetId?[l.widgetId]:[]);A(e,a);const u=Pt(r,e,l.widgetId?[l.widgetId]:[]);return A(e,u),{layout:e,operations:[...t,...o,...s,...i,...n,...l.operations,...a,...u,...c.operations]}}function ci(r,e,t){const s=r.workingLayout.layout,o=qo(r,e,t,s);A(s,o);const i=ni(r,e,t,s);A(s,i);const n=Je(r,s);return A(s,n),[...o,...i,...n]}function di(r,e){const t=r.workingLayout.layout,s=ai(r,e);A(t,s.operations);const o=Je(r,t,s.widgetsId);A(t,o);const i=Pt(r,t,s.widgetsId);return A(t,i),[...s.operations,...o,...i]}const hi=()=>window.location.href.startsWith("vscode-webview://"),ui=(r,e)=>{!hi()||window.vscode.postMessage({type:"usage-event",event:{type:r,payload:e}})},pi=async({operations:r,name:e})=>{ui("widgets_updated",{checkpoint:e,operations:M(r)})};class Ke{constructor(e,t){m(this,"pubsub");m(this,"checkpointHistory",{undos:[],redos:[]});m(this,"_save",null);this.workingLayout=e,this.dashEditorService=t,this.pubsub=new ze}static create(e,t){return new Ke(e,t)}setWorkingLayout(e){this.workingLayout=e}undo(){if(this.dashEditorService.isPreview||!this.checkpointHistory.undos.length)return;const e=this.checkpointHistory.undos.pop();if(e)return A(this.workingLayout,e.operations),this.checkpointHistory.redos.push(Le(e)),e}redo(){if(this.dashEditorService.isPreview)return;const e=this.checkpointHistory.redos.pop();if(e)return A(this.workingLayout,e.operations),this.checkpointHistory.undos.push(Le(e)),e}execute(e){this.dashEditorService.isPreview||(A(this.workingLayout,e.operations),this.checkpointHistory.undos.push(Le(e)),this.checkpointHistory.redos=[],this.save(),this.pubsub.publish("updated"),pi(e))}onSave(e){this._save=e}save(){var e;(e=this._save)==null||e.call(this)}}const Le=r=>({selection:r.selection,name:`RE: ${r.name}`,operations:r.operations.slice().reverse().map(e=>gi(e))}),gi=r=>{switch(r.op){case"add":return{op:"remove",backup:r.value,path:r.path};case"remove":return{op:"add",path:r.path,value:r.backup};case"replace":return{op:"replace",backup:r.value,path:r.path,value:r.backup}}};class Qe{constructor(e,t){m(this,"operationQueue");m(this,"pubsub");this.layout=e,this.pubsub=new ze,this.operationQueue=Ke.create(e,t)}getRootSlot(){return C(this.layout)}getRootSlotPath(){return me(this.layout)}setLayout(e){this.operationQueue.setWorkingLayout(e)}static create(e,t){return new Qe(e,t)}getWidget(e){return Q(e,this.layout)}getWidgetOrSlottable(e){const t=Ht(e,this.layout);if(!t)throw new Error(`Could not find widget or slottable with id ${e}`);return t}get widgets(){return this.getRootSlot()}get allWidgets(){const e=t=>Object.entries(t).reduce((s,[o,i])=>W(i)?{...s,[o]:i}:{...s,...e(i.slot)},{});return e(this.widgets)}getSlottable(e){return De(e,this.layout)}redo(){let e=this.operationQueue.redo();for(;e&&e.operations.length===0;)e=this.operationQueue.redo();return this.operationQueue.save(),e}undo(){let e=this.operationQueue.undo();for(;e&&e.operations.length===0;)e=this.operationQueue.undo();return this.operationQueue.save(),e}updateVariable(e,t){const s=this.getWidget(t);if(!W(s))return;const o=J(Z(t,this.getRootSlot()),this.layout);this.operationQueue.execute({name:"update variable",selection:new Set([t]),operations:[{op:"replace",backup:s.variable,value:e,path:`${o}/${t}/variable`}]})}updateProp({param:e,value:t},s){const o=n=>this.getWidgetOrSlottable(n).props,i=(n,l,c)=>{const a=at(n,this.layout);return[{op:"replace",backup:o(n)[l],value:c,path:`${a}/${n}/props/${l}`}]};this.operationQueue.execute({name:"update props",operations:s.flatMap(n=>i(n,e.argName,t)),selection:new Set(s)})}updateEvent({event:e,value:t},s){const o=n=>this.getWidget(n).events,i=(n,l,c)=>{const a=J(Z(n,this.getRootSlot()),this.layout);return[{op:"replace",backup:o(n)[l],value:c,path:`${a}/${n}/events/${l}`}]};this.operationQueue.execute({name:"update events",operations:s.flatMap(n=>i(n,e.key,t)),selection:new Set(s)})}delete(e){this.operationQueue.execute({name:"widgets deleted",operations:e.map(t=>{const s=at(t,this.layout);return{op:"remove",backup:this.getWidgetOrSlottable(t),path:`${s}/${t}`}}),selection:new Set(e)})}onSave(e){this.operationQueue.onSave(e)}updateVersion(){this.layout.version!=="0.2"&&this.operationQueue.execute({name:"Version updated",operations:[{op:"replace",backup:this.layout.version,value:"0.2",path:"/version"},{op:"add",value:this.layout.widgets,path:"/slot"},{op:"remove",path:"/widgets",backup:this.layout.widgets}],selection:new Set})}}const fi=r=>({type:"copyAndPaste",selectedWidgets:r});function vi(r,e){return r.setData("text/plain",JSON.stringify(fi(e))),!0}function mi(r,e,t){const s=r.getData("text/plain");try{const o=s&&JSON.parse(s);if(!(o&&"type"in o&&o.type==="copyAndPaste"&&"selectedWidgets"in o&&Array.isArray(o.selectedWidgets)))return!1;const n=di(e,o.selectedWidgets);return t.operationQueue.execute({name:"paste",operations:n,selection:e.selectedWidgets}),!0}catch{return!1}}class yi{constructor(e){m(this,"event");this.event=e}setData(e,t){var s;(s=this.event.clipboardData)==null||s.setData(e,t)}getData(e){var t,s;return(s=(t=this.event.clipboardData)==null?void 0:t.getData(e))!=null?s:null}getTransferItems(){var e,t;return Object.values((t=(e=this.event.clipboardData)==null?void 0:e.items)!=null?t:[]).map(Si)}}class wi{constructor(e){m(this,"item");this.item=e}get type(){return this.item.type}getAsString(){return new Promise(e=>this.item.getAsString(t=>e(t)))}getJSONValue(){return this.getAsString().then(e=>{try{return e?JSON.parse(e):null}catch{return null}})}getAsFile(){return this.item.getAsFile()}}function Si(r){return new wi(r)}function dt(r){return new yi(r)}function _i(r){var t;const e=(t=document.getSelection())==null?void 0:t.toString();return(r==null?void 0:r.selectionStart)!==void 0||!!e}class qe{constructor(e,t,s){m(this,"dash");m(this,"zoom");m(this,"prevSlot");m(this,"_collapsedSlottables");m(this,"_isPreview");m(this,"camera");m(this,"slottableRenderer");m(this,"selection");m(this,"dashPlayerService");m(this,"layoutModel");m(this,"workspace");m(this,"_mouseState");m(this,"_hoverState");m(this,"pubsub");m(this,"editor");m(this,"listener");m(this,"canvas");m(this,"interactMenu");m(this,"dashPlayer");m(this,"runtimeHeader");m(this,"canvasService");m(this,"computedState");m(this,"throttledWidgetsChangedSend",H.exports.throttle(()=>{H.exports.isEqual(this.dash.rootSlot,this.prevSlot)||(this.prevSlot=H.exports.cloneDeep(this.dash.rootSlot),this.dashPlayerService.sendWidgetsChanged(this.dash.rootSlot))},500));m(this,"startPanning",()=>{this.mouseState.state!=="PANNING"&&(this.mouseState.state="START_PANNING")});m(this,"onKeyDownEvents",e=>({escape:()=>this.escapeEvent(),backspace:()=>this.backspaceEvent(),delete:()=>this.backspaceEvent(),z:()=>this.undoEvent(e),arrowup:()=>this.arrowUpEvent(),arrowdown:()=>this.arrowDownEvent(),arrowleft:()=>this.arrowLeftEvent(),arrowright:()=>this.arrowRightEvent(),a:()=>this.selectAllEvent(e),p:()=>this.togglePreviewEvent(e),space:()=>this.startPanning()}));m(this,"resizeEventListener",e=>function(t){e.centerCanvasHandler(t)});m(this,"copyEventListener",e=>function(t){e.copyHandler(t)});m(this,"pasteEventListener",e=>function(t){e.pasteHandler(t)});m(this,"mousemoveEventListener",e=>function(t){e.mouseMoveHandler(t)});m(this,"mouseupEventListener",e=>function(t){e.mouseup(t)});m(this,"updateHoverStateOnResizeHandler",e=>{for(const t of this.getResizeHandlerRects())if(xe(e,t.rect)){this.hoverState={state:"HOVERING_RESIZE_HANDLER",side:t.side};return}});m(this,"updateHoverStateOnWidget",e=>{var o;if(this.dashPlayerService.state.type!=="RUNNING")return;const{widgets:t}=this.calculatePositions(),s=(o=Object.keys(t).find(i=>xe(this.camera.screenPoint2world(e),B(t[i].position,this.dashPlayerService.layoutGrid))))!=null?o:null;s?this.hoverState={state:"HOVERING_WIDGET",widgetId:s}:this.hoverState={state:"NONE"}});window.__dashEditorService=this,this.zoom={active:!1,hoverZoomBar:!1},this._isPreview=k(!1),this.dashPlayerService=e,this.dashPlayerService.layoutGrid.calculatePositions=()=>this.isPreview?this.dashPlayerService.calculatePositions():this.calculatePositions(),this.camera=Ue.create(this.dashPlayerService.layoutGrid),this.slottableRenderer=Fe.create(this.dashPlayerService.layoutGrid,this.camera),this._collapsedSlottables=qt({}),this._mouseState={state:"IDLE"},this._hoverState={state:"NONE"},this.selection=je.create(),this.dash=t,this.workspace=s,this.pubsub=new ze,this.layoutModel=Qe.create(H.exports.cloneDeep(this.dash.layout),this),this.layoutModel.updateVersion(),this.prevSlot=H.exports.cloneDeep(Bt(this.getRootWidgets(),V))}overloadCollapsedSlottablesCondition(e){return Object.entries(e).reduce((t,[s,o])=>s in this.collapsedSlottables?{...t,[s]:{condition:!0}}:{...t,[s]:o},{})}get collapsedSlottables(){return this._collapsedSlottables.value}set collapsedSlottables(e){this._collapsedSlottables.value=e}get isPreview(){return this._isPreview.value}set isPreview(e){this._isPreview.value=e}get mouseState(){return this._mouseState}set mouseState(e){this._mouseState=e}get hoverState(){return this._hoverState}set hoverState(e){this._hoverState=e}getWidgetsWithErrors(){const e=this.dashPlayerService.state;return e?e.type!=="RUNNING"?[]:Object.keys(this.layoutModel.widgets).reduce((t,s)=>{var l,c,a;const o=(l=e.errors.props)==null?void 0:l[s],i=(c=e.errors.variables)==null?void 0:c[s],n=(a=e.errors.widgets)==null?void 0:a[s];return!o&&!i&&!n||!Object.keys({...o,...i,...n}).length?t:t?[...t,s]:[s]},[]):[]}getSelectedWidgetErrors(){var s,o,i,n,l,c;const e={},t=this.dashPlayerService.state;return!t||t.type!=="RUNNING"?e:{props:(o=t.errors.props)==null?void 0:o[(s=this.selection.selectedSlottableId)!=null?s:this.selection.selectedWidgetId],widget:(n=t.errors.widgets)==null?void 0:n[(i=this.selection.selectedSlottableId)!=null?i:this.selection.selectedWidgetId],variable:(c=t.errors.variables)==null?void 0:c[(l=this.selection.selectedSlottableId)!=null?l:this.selection.selectedWidgetId]}}setupOnSave(){this.layoutModel.onSave(async()=>{!this.workspace||(this.dash.layout=this.layoutModel.layout,this.dashPlayerService.updateDashData(this.dash.makeRunnerData(this.workspace)),this.throttledWidgetsChangedSend())})}hoverZoomBar(){this.zoom.hoverZoomBar=!0}leaveZoomBar(){this.zoom.hoverZoomBar=!1}getRootWidgets(){return Object.keys(this.dash.rootSlot).reduce((e,t)=>{const s=this.dash.rootSlot[t];return s.position&&(e[t]=s),e},{})}static create(e,t,s){return new qe(e,t,s)}async restart(){return this.dashPlayerService.start(),await this.dashPlayerService.wait("widgets-computed"),this.dashPlayerService.sendWidgetsChanged(this.dash.rootSlot),this.dashPlayerService.wait("widgets-computed")}metadataDragStart(e,t){if(!this.camera)return;const s=this.camera.screenPoint2world({x:e.pageX,y:e.pageY,referential:"screen"});this.selection.resetSelection(),t in ae?this.mouseState={state:"DRAGGING_SLOTTABLE",...s,type:t}:this.mouseState={state:"DRAGGING",...s,type:t}}fixPosition(e){if(!this.canvas)return;const{origin:t,element:s,ignoreZoom:o}=e;if(!this.camera||!s||!s.style)return;const i=this.camera.worldPoint2screen(t),n=this.canvas.getBoundingClientRect(),l=[`translate(${i.x-n.x}px, ${i.y-n.y}px)`,o?null:`scale(${this.camera.zoom})`].filter(c=>c).join(" ");Object.assign(s.style,{transform:l,transformOrigin:"top left"})}fixCanvasRectPosition(){var i,n,l,c,a,u,p,d,h,g;const e=this.camera.screenRect2world(this.camera.canvasRect),t=this.camera.screenDelta2world({dx:8,dy:8,referential:"screen"}),s=this.camera.screenRect2world({x:(i=this.interactMenu)==null?void 0:i.$el.getBoundingClientRect().x,y:(n=this.interactMenu)==null?void 0:n.$el.getBoundingClientRect().y,width:(l=this.interactMenu)==null?void 0:l.$el.getBoundingClientRect().width,height:(c=this.interactMenu)==null?void 0:c.$el.getBoundingClientRect().height,referential:"screen"});this.fixPosition({origin:{x:Math.min(this.dashPlayerService.layoutGrid.width+t.dx,e.x+e.width-s.width-t.dx),y:Math.max(e.y+t.dy,0),referential:"world"},element:(a=this.interactMenu)==null?void 0:a.$el,ignoreZoom:!0});const o=this.camera.screenRect2world({x:(u=this.runtimeHeader)==null?void 0:u.$el.getBoundingClientRect().x,y:(p=this.runtimeHeader)==null?void 0:p.$el.getBoundingClientRect().y,width:(d=this.runtimeHeader)==null?void 0:d.$el.getBoundingClientRect().width,height:(h=this.runtimeHeader)==null?void 0:h.$el.getBoundingClientRect().height,referential:"screen"});this.fixPosition({origin:{x:0,y:-o.height-t.dy,referential:"world"},element:(g=this.runtimeHeader)==null?void 0:g.$el,ignoreZoom:!0})}canvasMousedown(e){var o;if(!this.camera)return;const t={x:e.pageX,y:e.pageY,referential:"screen"};if(e.button==1||e.button==0&&Is.isPressed("space")){this.mouseState={state:"PANNING",initialMousePos:t,mousePos:t};return}const s=this.camera.screenPoint2world(t);this.hoverState.state==="HOVERING_WIDGET"?this.mouseState={state:"JUST_CLICKED",pos:s,widgetId:this.hoverState.widgetId}:this.hoverState.state==="HOVERING_RESIZE_HANDLER"?this.mouseState={state:"RESIZING",side:this.hoverState.side,initialMousePos:t,mousePos:t,type:(o=this.selection.selectedWidget)==null?void 0:o.type}:this.hoverState.state==="HOVERING_TOGGLE"?this.mouseState={state:"JUST_CLICKED_TOGGLE",mousePos:t,slottable:this.hoverState.slottable}:this.hoverState.state==="HOVERING_SLOTTABLE_RESIZE_HANDLER"?this.mouseState={state:"SLOTTABLE_RESIZING",initialMousePos:t,mousePos:t,slottableId:this.hoverState.slottableId,side:"bottom"}:this.hoverState.state==="HOVERING_SLOTTABLE_SELECTOR"?this.mouseState={state:"JUST_CLICKED_SLOTTABLE_SELECTOR",slottableId:this.hoverState.slottableId,mousePos:t}:(q(e)||this.selection.resetSelection(),this.mouseState={state:"SELECTING",initialMousePos:t,mousePos:t})}mouseMoveHandler(e){if(!this.camera)return;const t={x:e.pageX,y:e.pageY,referential:"screen"},s=this.camera.screenPoint2world(t);if(this.mouseState.state==="PANNING"){const o={dx:-e.movementX,dy:-e.movementY},i=this.camera.screenDelta2world({dx:o.dx,dy:o.dy,referential:"screen"});this.camera.translate(i),e.preventDefault(),e.stopPropagation();return}this.mouseState.state==="MOVING"&&(this.mouseState.mousePos=s,this.mouseState.duplicating=et(e)),this.mouseState.state==="MOVING_SLOTTABLE"&&(this.mouseState.mousePos=s),this.mouseState.state==="JUST_CLICKED"&&Xe(this.mouseState.pos,s)*this.camera.zoom>5&&(this.selection.has(this.mouseState.widgetId)||(q(e)?this.selection.addToSelectedWidgets(this.mouseState.widgetId):(this.selection.resetSelection(),this.selection.addToSelectedWidgets(this.mouseState.widgetId))),this.mouseState={state:"MOVING",initialMousePos:this.mouseState.pos,mousePos:s,duplicating:et(e)}),this.mouseState.state==="JUST_CLICKED_SLOTTABLE_SELECTOR"&&Xe(this.mouseState.mousePos,s)*this.camera.zoom>5&&(this.mouseState={state:"MOVING_SLOTTABLE",initialMousePos:this.camera.screenPoint2world(this.mouseState.mousePos),mousePos:s,slottableId:this.mouseState.slottableId}),this.mouseState.state==="SELECTING"&&(this.mouseState.mousePos=t),this.mouseState.state==="RESIZING"&&(this.mouseState.mousePos=t),this.mouseState.state==="SLOTTABLE_RESIZING"&&(this.mouseState.mousePos=t),this.computeHoverState(t)}everySelectedWidgetInPreviewState(){const e=this.dashPlayerService.state;return e.type!=="RUNNING"?!1:this.selection.selectedWidgetsIds.every(t=>Object.keys(e.widgets).includes(t))}getRectangularHull(){const e=this.dashPlayerService.state;return e.type!=="RUNNING"?null:Be(Object.entries(e.widgets).filter(([t])=>this.selection.has(t)).map(([t,s])=>B(s.position,this.dashPlayerService.layoutGrid)))}selectionRect(){if(this.mouseState.state!=="SELECTING")return null;const{x:e,y:t}=this.mouseState.initialMousePos,{x:s,y:o}=this.mouseState.mousePos;return{x:Math.min(e,s),y:Math.min(t,o),width:Math.abs(e-s),height:Math.abs(t-o),referential:"screen"}}pasteHandler(e){mi(dt(e),this.getInput(),this.layoutModel)&&e.preventDefault()}renderScreenPositioning(){var s;if(!this.camera||!this.workspace||!this.canvas)return;this.fixPosition({origin:{x:0,y:0,referential:"world"},element:(s=this.dashPlayer)==null?void 0:s.$el}),this.fixCanvasRectPosition();const e=this.canvas.getContext("2d");if(!e)return;const t=this.canvas.getBoundingClientRect();this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,e.clearRect(0,0,this.canvas.width,this.canvas.height),e.translate(-t.x,-t.y)}renderComputeCursor(){var e,t;!this.canvas||(this.canvas.style.cursor=(t=(e=this.canvasService)==null?void 0:e.cursor(this.mouseState,this.hoverState))!=null?t:"default")}renderPreviewState(){var o,i;if(this.dashPlayerService.state.type!=="RUNNING")return;const e=this.getInput(),t=li(e);(!H.exports.isEqual(t.operations,(o=this.computedState)==null?void 0:o.operations)||!H.exports.isEqual(t.layout,(i=this.computedState)==null?void 0:i.layout))&&(this.computedState=t),this.computedState&&this.canvasService&&this.canvasService.render({...e,computedState:this.computedState,isPreview:this.isPreview,calculatedPositions:this.calculatePositions(this.dash.makeRunnerData(this.workspace,this.computedState.layout).layout.slot)})}render(){try{this.renderScreenPositioning(),this.renderComputeCursor(),this.renderPreviewState()}catch(e){console.error(e)}finally{requestAnimationFrame(()=>this.render())}}onDragover(e){if(!this.camera)return;e.preventDefault();const t=this.camera.screenPoint2world({x:e.pageX,y:e.pageY,referential:"screen"});this.mouseState={...this.mouseState,...t}}canvasWheel(e){if(!this.camera)return;const t={x:e.pageX,y:e.pageY,referential:"screen"};if(fe(e)||Ps(e))this.camera.zoomIn(Math.exp(-Math.sign(e.deltaY)*.05),t),e.preventDefault();else{const s=q(e)?{dx:e.deltaY,dy:0}:{dx:e.deltaX,dy:e.deltaY},o=this.camera.screenDelta2world({dx:s.dx,dy:s.dy,referential:"screen"});this.camera.translate(o)}e.stopPropagation()}togglePreviewEvent(e){q(e)&&this.pubsub.publish("change-preview",!this.isPreview)}resetEditingState(e){this.mouseState={state:"IDLE"},this.computeHoverState(e)}escapeEvent(){this.mouseState.state==="IDLE"&&this.selection.resetSelection(),this.resetEditingState({referential:"screen",x:0,y:0})}backspaceEvent(){this.selection.selectedSlottableId?this.layoutModel.delete([this.selection.selectedSlottableId]):this.layoutModel.delete(this.selection.selectedWidgetsIds),this.selection.resetSelection()}undoEvent(e){if(fe(e)&&q(e)){e.preventDefault(),e.stopPropagation();const t=this.layoutModel.redo();if(t){if(t.operations.some(s=>s.op==="remove")){this.selection.resetSelection();return}this.selection.selectedWidgetsIds=[...Array.from(t.selection)]}return}else if(fe(e)){e.preventDefault(),e.stopPropagation();const t=this.layoutModel.undo();if(t){if(t.operations.some(s=>s.op==="remove")){this.selection.resetSelection();return}this.selection.selectedWidgetsIds=[...Array.from(t.selection)]}return}}selectAllEvent(e){fe(e)&&(e.preventDefault(),e.stopPropagation(),this.selection.selectAll())}move(e,t){const[s,o]={up:[0,-1],down:[0,1],left:[-1,0],right:[1,0]}[t],i=ci(e,s,o);this.layoutModel.operationQueue.execute({name:`move ${t}`,operations:i,selection:e.selectedWidgets})}arrowUpEvent(){this.move(this.getInput(),"up")}arrowDownEvent(){this.move(this.getInput(),"down")}arrowLeftEvent(){this.move(this.getInput(),"left")}arrowRightEvent(){this.move(this.getInput(),"right")}selectingOnMouseUp(e){q(e)?this.widgetsInRectangularSelection().forEach(t=>{this.selection.toggleWidgetSelection(t)}):(this.selection.resetSelection(),this.widgetsInRectangularSelection().forEach(t=>{this.selection.addToSelectedWidgets(t)}))}toggleSlottable(e){this.collapsedSlottables={...this.collapsedSlottables,[e]:!this.collapsedSlottables[e]}}mouseup(e){var s;(s=this.computedState)!=null&&s.operations.length&&this.layoutModel.operationQueue.execute({name:"mouse up",operations:this.computedState.operations,selection:new Set(this.selection.selectedWidgetsIds)}),this.mouseState.state==="SELECTING"&&this.selectingOnMouseUp(e),this.mouseState.state==="JUST_CLICKED"&&(q(e)?this.selection.toggleWidgetSelection(this.mouseState.widgetId):(this.selection.resetSelection(),this.selection.selectedSlottableId=null,this.selection.addToSelectedWidgets(this.mouseState.widgetId))),this.mouseState.state==="JUST_CLICKED_TOGGLE"&&this.toggleSlottable(this.mouseState.slottable),this.mouseState.state==="JUST_CLICKED_SLOTTABLE_SELECTOR"&&(this.selection.selectedSlottableId=this.mouseState.slottableId);const t={x:e.pageX,y:e.pageY,referential:"screen"};this.resetEditingState(t)}onKeydown(e){var t,s;(s=(t=this.onKeyDownEvents(e))[e.key.toLowerCase().trim()?e.key.toLowerCase():e.code.toLowerCase()])==null||s.call(t)}onKeyup(e){this.mouseState={state:"IDLE"}}copyHandler(e){_i(e==null?void 0:e.target)||vi(dt(e),this.selection.selectedWidgets)&&e.preventDefault()}centerCanvasHandler(e){var t;(t=this.camera)==null||t.correct()}addGlobalEventListeners(){addEventListener("resize",this.resizeEventListener(this)),addEventListener("copy",this.copyEventListener(this)),addEventListener("paste",this.pasteEventListener(this)),addEventListener("mousemove",this.mousemoveEventListener(this)),addEventListener("mouseup",this.mouseupEventListener(this))}removeGlobalEventListeners(){removeEventListener("resize",this.resizeEventListener(this)),removeEventListener("copy",this.copyEventListener(this)),removeEventListener("paste",this.pasteEventListener(this)),removeEventListener("mousemove",this.mousemoveEventListener(this)),removeEventListener("mouseup",this.mouseupEventListener(this))}async setup(e,t,s,o,i,n){var c,a;if(this.editor=e,this.listener=t,this.interactMenu=o,this.dashPlayer=i,this.runtimeHeader=n,this.canvas=s,this.camera.setProjectedCanvas(s),this.camera.correct(),t.addEventListener("wheel",u=>this.canvasWheel(u)),s.addEventListener("mousedown",u=>this.canvasMousedown(u)),s.addEventListener("drop",u=>this.mouseup(u)),s.addEventListener("dragover",u=>this.onDragover(u)),(c=s.parentElement)==null||c.addEventListener("keydown",u=>this.onKeydown(u)),(a=s.parentElement)==null||a.addEventListener("keyup",u=>this.onKeyup(u)),!s.getContext("2d"))throw new Error(`I can't get no context 2d ${s}`);this.canvasService=ue.create(s,this),this.addGlobalEventListeners(),He(()=>{this.camera.fit(),this.render()})}tearDown(){this.removeGlobalEventListeners()}widgetsInRectangularSelection(){if(!this.camera)throw new Error("No camera value yet");if(this.dashPlayerService.state.type!=="RUNNING")return new Set;const{widgets:e}=this.calculatePositions(),t=this.selectionRect();return t?new Set(Object.keys(e).filter(s=>bs(this.camera.worldRect2screen(B(e[s].position,this.dashPlayerService.layoutGrid)),t))):new Set}calculatePositions(e){return this.dashPlayerService.state.type!=="RUNNING"?{widgets:{},slottables:{}}:this.dashPlayerService.calculatePositions(this.overloadCollapsedSlottablesCondition(this.dashPlayerService.state.props),e)}getInput(){switch(this.dashPlayerService.state.type){case"AUTHENTICATING":case"RUNNING":return{mouseState:this.mouseState,dashEditorService:this,workingLayout:this.layoutModel,hoverState:this.hoverState,resizeHandlerRects:this.getResizeHandlerRects(),widgetsInRectangularSelection:this.widgetsInRectangularSelection(),selectedWidgets:new Set(this.selection.selectedWidgetsIds),dash:this.dash,calculatedPositions:this.calculatePositions(),selectedSlottable:this.selection.selectedSlottableId};default:throw new Error(`Invalid state ${JSON.stringify(this.dashPlayerService.state.type)} for getInput`)}}getResizeHandlerRects(){if(!this.camera)throw new Error("No camera value yet");const e=this.getRectangularHull();return!e||!this.everySelectedWidgetInPreviewState()?[]:To(this.selection.selectedWidgets,this.camera.worldRect2screen(e))}updateHoverStateOnToggle(e){const t=this.slottableRenderer.getToggleUnderCursor(e);t&&(this.hoverState={state:"HOVERING_TOGGLE",slottable:t.id})}updateHoverStateOnSlottableSelector(e){const t=this.slottableRenderer.getSelectorUnderCursor(e);t&&(this.hoverState={state:"HOVERING_SLOTTABLE_SELECTOR",slottableId:t.id})}updateHoverStateOnSlottableResizeHandler(e){const t=this.slottableRenderer.getResizerUnderCursor(e);t&&(this.hoverState={state:"HOVERING_SLOTTABLE_RESIZE_HANDLER",slottableId:t.id})}computeHoverState(e){!this.camera||(this.updateHoverStateOnWidget(e),this.updateHoverStateOnResizeHandler(e),this.updateHoverStateOnToggle(e),this.updateHoverStateOnSlottableSelector(e),this.updateHoverStateOnSlottableResizeHandler(e))}}const Ei={class:"dash-editor"},bi=z({__name:"DashEditor",setup(r){const e=Yt(),t=Xt(),s=({id:g,type:f})=>{f==="dash"?(e.push({name:"dashEditor",params:{dashId:g},query:t.query}),n()):e.push({name:"editor",params:{formId:g},query:t.query})},{loading:o,result:i,refetch:n}=ps(()=>Promise.all([fs.get(),gs.get(t.params.dashPath)]).then(([g,f])=>ts({workspace:g,dash:f,...p(g,f)}))),l=g=>{i.value&&(i.value.dashEditorService.isPreview=g)},c=k(),a=g=>{var f;return(f=i.value)==null?void 0:f.dash.addVariableToCode(g)};function u(g,f){g.onRedirect(({url:w,queryParams:v})=>zt("editor",e,w,v)),g.on("eval-return",w=>{w.repr&&f.log({type:"eval-output",log:w.repr})}),g.on("eval-error",w=>{f.log({type:"eval-output",log:w.repr})}),g.on("stderr",w=>{f.log({type:"stderr",log:w.log})}),g.on("stdout",w=>{f.log({type:"stdout",log:w.log})}),g.on("widgets-computed",w=>{var v;(v=w.errors)!=null&&v.general&&f.log({type:"stderr",log:w.errors.general.repr})}),g.on("program-start-failed",w=>{var v;f.log({type:"stderr",log:(v=w.error)!=null?v:""})})}function p(g,f){const w=rs(f.makeRunnerData(g)),v=ns.create(),L=qe.create(w,f,g);return u(w,v),{dashPlayerService:w,logService:v,dashEditorService:L}}function d(g){var f;(f=i.value)==null||f.dashPlayerService.sendEvalRequest(g)}const h=async()=>{!i.value||(i.value.dashEditorService.restart(),u(i.value.dashPlayerService,i.value.logService))};return(g,f)=>{var w,v,L;return S(),E("div",Ei,[R(o)||!((w=R(i))!=null&&w.dash)||!((v=R(i))!=null&&v.workspace)?(S(),ee(as,{key:0,class:"loading",justify:"center"})):(S(),ee(Ut,{key:1},{left:Y(()=>[x(vs,{link:"/_editor/dashes"})]),right:Y(()=>[x(R(es),null,{default:Y(()=>[x(ws,{path:"dashes/overview"}),x(ys,{model:R(i).dash},null,8,["model"]),x(ms,{model:R(i).dash},null,8,["model"])]),_:1})]),default:Y(()=>[x(Ye,{title:"Layout editor"},{default:Y(()=>{var j;return[(j=R(i))!=null&&j.dashPlayerService?(S(),ee(vo,{key:0,workspace:R(i).workspace,dash:R(i).dash,"dash-editor-service":R(i).dashEditorService,params:R(t).query,onNavigate:s,onChangePreview:l,onCreateVariable:a},null,8,["workspace","dash","dash-editor-service","params"])):$("",!0)]}),_:1}),x(Ye,{title:"Settings"},{default:Y(()=>[x(As,{dash:R(i).dash},null,8,["dash"])]),_:1})]),_:1})),R(i)?(S(),ee(is,{key:2,ref_key:"smartConsole",ref:c,"log-service":R(i).logService,runtime:"dashes",onRestart:h,onEvalRequest:d},null,8,["log-service"])):$("",!0),x(Ft,{"has-changes":(L=R(i))==null?void 0:L.dash.hasChanges()},null,8,["has-changes"])])}}});const nn=U(bi,[["__scopeId","data-v-ba803148"]]);export{nn as default};
//# sourceMappingURL=DashEditor.2a83c584.js.map
