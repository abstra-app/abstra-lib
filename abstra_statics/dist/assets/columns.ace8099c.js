var j=Object.defineProperty;var w=(s,e,t)=>e in s?j(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var l=(s,e,t)=>(w(s,typeof e!="symbol"?e+"":e,t),t);import{C as n}from"./gateway.bca3ba41.js";import{E as f}from"./record.40f9594e.js";import{B as o}from"./index.1da01ec4.js";import{n as g}from"./string.4dfa525a.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[e]="829ca68f-fdbf-4769-be82-ab121a3e7514",s._sentryDebugIdIdentifier="sentry-dbid-829ca68f-fdbf-4769-be82-ab121a3e7514")}catch{}})();const $=["varchar","int","boolean","json","date","timestamp","uuid","real"],q={varchar:"'DEFAULT_VALUE'",int:"",boolean:"false",json:"'{}'::json",date:"now()",timestamp:"now()",uuid:"gen_random_uuid()",real:"0.0"};class T{async list(e){return n.get(`projects/${e}/tables`)}async create(e,t){return await n.post(`projects/${e.projectId}/tables`,t)}async get(e){return n.get(`projects/${e.projectId}/tables/${e.tableId}`)}async delete(e){return n.delete(`projects/${e.projectId}/tables/${e.tableId}`)}async selectRows(e){return n.get(`projects/${e.projectId}/tables/${e.tableId}/rows`,{limit:e.limit.toString(),offset:e.offset.toString(),search:e.search,where:JSON.stringify(e.where),orderBy:JSON.stringify(e.orderBy)})}async update(e,t){return n.patch(`projects/${e.projectId}/tables/${e.tableId}`,t)}async insertRow(e,t){return n.post(`projects/${e.projectId}/tables/${e.tableId}/rows`,t)}async updateRow(e,t){return n.patch(`projects/${e.projectId}/tables/${e.tableId}/rows/${e.rowId}`,t)}async deleteRow(e){return n.delete(`projects/${e.projectId}/tables/${e.tableId}/rows/${e.rowId}`)}async getByColumnID(e){return n.get(`projects/${e.projectId}/columns/${e.columnId}`)}}const a=new T;class p{constructor(e,t=null){l(this,"record");l(this,"columns");this.record=f.from(e),this.columns=t}static async list(e){return(await a.list(e)).map(r=>new p(r))}static async fromColumnId(e,t){const r=await a.getByColumnID({projectId:e,columnId:t});return p.get(e,r.table.id)}static async create(e,t,r){const c=g(t,!1),i=await a.create({projectId:e},{name:c,id:r});return new p(i.table,i.columns.map(m=>d.fromDTO(m)))}static async get(e,t){const r=await a.get({projectId:e,tableId:t}),c=r.table,i=r.columns.map(h=>d.fromDTO({...h,projectId:c.projectId}));return new p(c,i)}async delete(e,t){return a.delete({projectId:e,tableId:t})}fixTraillingName(){this.name=g(this.name,!1)}async save(){if(Object.keys(this.record.changes).length!==0){this.record.changes.name&&this.fixTraillingName();try{await a.update({id:this.id,tableId:this.id,projectId:this.projectId},this.record.changes)}finally{this.record.resetChanges()}}}resetChanges(){this.record.resetChanges()}onUpdate(e){this.record.pubsub.subscribe("update",e)}hasChanges(){return this.record.hasChanges()}hasChangesDeep(e){return this.record.hasChangesDeep(e)&&g(this.name,!1)!==this.record.initialState.name}getColumns(){var e;return(e=this.columns)!=null?e:[]}getUnprotectedColumns(){var e,t;return(t=(e=this.columns)==null?void 0:e.filter(r=>!r.protected).map(r=>r.toDTO()))!=null?t:[]}get id(){return this.record.get("id")}get name(){return this.record.get("name")}set name(e){const t=g(e,!0);this.record.set("name",t)}get projectId(){return this.record.get("projectId")}async addColumn(e){const t=await d.create(e.name,e.type,e.default,e.nullable,e.unique,this.id,this.projectId,e.foreignKey);return"error"in t?{success:!1,error:t.error}:this.columns?(this.columns.push(t),{success:!0,error:""}):(this.columns=[t],{success:!0,error:""})}getColumn(e){var t;return(t=this.columns)==null?void 0:t.find(r=>r.id&&r.id===e)}async select(e={},t,r,c,i){return a.selectRows({name:this.name,where:e,tableId:this.id,projectId:this.projectId,limit:r,offset:t,search:c,orderBy:i})}async insertRow(e){return a.insertRow({tableId:this.id,projectId:this.projectId},e)}async updateRow(e,t){return a.updateRow({tableId:this.id,projectId:this.projectId,rowId:e},t)}async deleteRow(e){return a.deleteRow({tableId:this.id,projectId:this.projectId,rowId:e})}}o.object({name:o.string().optional(),unique:o.boolean().optional(),nullable:o.boolean().optional(),type:o.object({newType:o.string(),using:o.string()}).optional(),default:o.string().optional(),foreignKey:o.object({columnId:o.string()}).nullish().optional()});const C={boolean:["boolean","bool"],int:["int","integer","int4"],varchar:["varchar","character varying","text"],json:["json"],date:["date"],timestamp:["timestamp"],uuid:["uuid"],real:["real","float4","float8"]},D=s=>{for(const e of $)if(C[e].includes(s))return e;throw new Error(`Unknown type: ${s}`)};class R{async create(e){return n.post(`projects/${e.projectId}/tables/${e.tableId}/columns`,e)}async delete(e){return n.delete(`projects/${e.projectId}/tables/${e.tableId}/columns/${e.id}`)}async update(e,t){return n.patch(`projects/${e.projectId}/tables/${e.tableId}/columns/${e.id}`,t)}async getById(e){return n.get(`projects/${e.projectId}/columns/${e.id}`)}}const y=new R,u=class{constructor(e){l(this,"record");this.record=f.from(e)}static async create(e,t,r,c,i,h,m,I){const b=await y.create({name:e,type:t,default:r,nullable:c,unique:i,tableId:h,projectId:m,foreignKey:I});return"error"in b?b:new u(b)}async update(e){const t={...this.record.changes,type:this.record.changes.type&&e?{newType:this.record.changes.type,using:e}:void 0};return Object.keys(t).length===0||!this.id?{success:!0,error:""}:(await y.update({id:this.id,tableId:this.tableId,projectId:this.projectId},t),{success:!0,error:""})}toDTO(){return this.record.state}get id(){return this.record.get("id")}get tableId(){return this.record.get("tableId")}get projectId(){return this.record.get("projectId")}get protected(){return this.record.get("protected")}get type(){return D(this.record.get("type"))}set type(e){this.record.set("type",e)}get name(){return this.record.get("name")}set name(e){this.record.set("name",e)}get nullable(){return this.record.get("nullable")}set nullable(e){this.record.set("nullable",e)}get unique(){return this.record.get("unique")}set unique(e){this.record.set("unique",e)}get primaryKey(){return this.record.get("primaryKey")}get default(){var e;return(e=this.record.get("default"))==null?void 0:e.split("::")[0]}set default(e){this.record.set("default",e)}get foreignKey(){return this.record.get("foreignKey")}set foreignKey(e){this.record.set("foreignKey",e)}async delete(){this.id&&await y.delete({id:this.id,tableId:this.tableId,projectId:this.projectId})}};let d=u;l(d,"fromDTO",e=>new u(e)),l(d,"fromID",async(e,t)=>{const r=await y.getById({projectId:e,id:t});return u.fromDTO(r.column)});export{d as C,p as T,q as d,$ as p};
//# sourceMappingURL=columns.ace8099c.js.map
