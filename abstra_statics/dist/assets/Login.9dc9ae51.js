import{O as B,L as C}from"./CircularLoading.7ed4de0e.js";import{d as E,r as $,o as v,a5 as y,e as f,f as o,ec as r,u as a,eG as s,a as I,b as _,bJ as q,eE as D,cz as A,g as h,bR as g,cy as T,h as R,_ as L,e5 as N,ea as U,c as V,dt as S}from"./jwt-decode.esm.aa7cdf41.js";import{_ as z}from"./AbstraLogo.vue_vue_type_script_setup_true_lang.a5e471ee.js";import{i as O}from"./string.83af24ac.js";import{j as k,T as j,k as F,E as G}from"./router.cc6e5ed9.js";import{A as K}from"./index.17841a8f.js";import"./Logo.7c2afb14.js";import"./index.0401f8fc.js";(function(){try{var i=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},l=new Error().stack;l&&(i._sentryDebugIds=i._sentryDebugIds||{},i._sentryDebugIds[l]="73de05ac-25c3-42b2-abe0-64a24c571d75",i._sentryDebugIdIdentifier="sentry-dbid-73de05ac-25c3-42b2-abe0-64a24c571d75")}catch{}})();const M={class:"form"},J={class:"header"},H={class:"description"},Q={class:"description"},W={class:"footer"},X={key:2,class:"loading"},Y=E({__name:"Passwordless",emits:["done"],setup(i,{emit:l}){const e=$({stage:"collect-info",info:{email:""},token:"",invalid:!1,secsToAllowResend:0});function d(){const n=e.value.info.email,t=O(n);return e.value.invalid=!t,t}let u;const c=async({isResend:n}={})=>{if(!!d()){e.value.stage="loading";try{await k.authenticate(e.value.info.email,n),e.value.stage="collect-token",e.value.secsToAllowResend=120,clearInterval(u),u=setInterval(()=>{e.value.secsToAllowResend-=1,e.value.secsToAllowResend<=0&&clearInterval(u)},1e3)}catch{e.value.invalid=!0,e.value.stage="collect-info"}}},m=n=>{if(!n){e.value.info.email="";return}e.value.info.email=n.toLowerCase()},p=async()=>{var n;if(!!((n=e.value.info)!=null&&n.email)){e.value.stage="loading";try{const t=await k.verify(e.value.info.email,e.value.token);if(!t)throw new Error("[Passwordless] Login did not return an user");j.trackSession(),l("done",t),e.value.stage="done"}catch{e.value.invalid=!0,e.value.stage="collect-token"}}},w=async n=>{await fetch(`https://admin.abstra.app/_hooks/notify-email-not-received?email=${n}`,{method:"GET"})},P=()=>{e.value.info&&(c({isResend:!0}),w(e.value.info.email))},x=()=>{e.value.stage="collect-info",e.value.info={email:""},e.value.token="",e.value.invalid=!1};return(n,t)=>(v(),y("div",M,[f("div",J,[o(z,{"hide-text":"",size:"large"}),f("h2",null,r(a(s).translate("i18n_auth_validate_your_email_login",null,{brandName:"Abstra"})),1)]),e.value.stage==="collect-info"?(v(),I(a(T),{key:0,class:"section"},{default:_(()=>[f("div",H,r(a(s).translate("i18n_auth_info_description")),1),o(a(A),{"has-feedback":"","validate-status":e.value.invalid?"error":"",help:e.value.invalid?a(s).translate("i18n_auth_info_invalid_email"):""},{default:_(()=>[o(a(q),{type:"email",value:e.value.info.email,placeholder:a(s).translate("i18n_auth_enter_your_work_email"),autofocus:"",onBlur:d,onKeyup:t[0]||(t[0]=D(()=>c(),["enter"])),onChange:t[1]||(t[1]=b=>m(b.target.value))},null,8,["value","placeholder"])]),_:1},8,["validate-status","help"]),o(a(g),{type:"primary",onClick:t[2]||(t[2]=()=>c())},{default:_(()=>[h(r(a(s).translate("i18n_auth_info_send_code")),1)]),_:1})]),_:1})):e.value.stage==="collect-token"?(v(),I(a(T),{key:1,class:"section"},{default:_(()=>[f("div",Q,r(a(s).translate("i18n_auth_token_label",null,e.value.info)),1),o(a(A),{"has-feedback":"","validate-status":e.value.invalid?"error":""},{default:_(()=>[o(B,{value:e.value.token,"onUpdate:value":t[3]||(t[3]=b=>e.value.token=b),length:6,numeric:!0,size:"large",onCollectToken:p},null,8,["value"]),e.value.invalid?(v(),I(a(K),{key:0,message:a(s).translate("i18n_auth_token_invalid"),type:"error",style:{"margin-top":"24px"}},null,8,["message"])):R("",!0)]),_:1},8,["validate-status"]),o(a(g),{type:"primary",onClick:p},{default:_(()=>[h(r(a(s).translate("i18n_auth_token_verify_email")),1)]),_:1}),o(a(g),{onClick:x},{default:_(()=>[h(r(a(s).translate("i18n_auth_edit_email")),1)]),_:1}),o(a(g),{disabled:!!e.value.secsToAllowResend,onClick:P},{default:_(()=>[h(r(a(s).translate("i18n_auth_token_resend_email"))+" ("+r(e.value.secsToAllowResend)+" s) ",1)]),_:1},8,["disabled"]),f("div",W,r(a(s).translate("i18n_auth_token_footer_alternative_email")),1)]),_:1})):e.value.stage==="loading"?(v(),y("div",X,[o(C)])):R("",!0)]))}});const Z=L(Y,[["__scopeId","data-v-5e3f799d"]]),ee=async(i,l)=>{const e=k.getAuthor();if(!e)return{onboarded:!1};const{status:d}=await F.getInfo();if(d==="active")return{onboarded:!0};const u=new URLSearchParams({token:e.jwt,status:d,...i&&{redirect:i},...l&&{"prev-redirect":l}});return window.location.replace(`${G.onboarding}/setup?${u}`),{onboarded:!1}},ae={key:0,class:"login"},te={key:1,class:"loading"},ne=E({__name:"Login",setup(i){const l=N(),e=U();async function d(){const c=e.query.redirect,m=e.query["prev-redirect"],{onboarded:p}=await ee(c,m);if(!!p)if(c){const w=c.split("/").at(-1);await l.push({path:w,query:{...e.query,redirect:e.query["prev-redirect"],"prev-redirect":void 0}})}else l.push({name:"home"})}const u=V(()=>!k.getAuthor());return S(()=>{u.value||d()}),(c,m)=>u.value?(v(),y("div",ae,[o(Z,{onDone:d})])):(v(),y("div",te,[o(C)]))}});const _e=L(ne,[["__scopeId","data-v-ec47ae9d"]]);export{_e as default};
//# sourceMappingURL=Login.9dc9ae51.js.map
