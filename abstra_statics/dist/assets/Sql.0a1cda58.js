import{_ as K}from"./AbstraButton.vue_vue_type_script_setup_true_lang.920beb54.js";import{_ as te}from"./ScrollArea.vue_vue_type_script_setup_true_lang.2db15b7c.js";import{a0 as J,Z as b,r as S,w as se,d as ae,eH as ne,U as oe,ac as T,f as i,e as v,b as u,u as e,aY as j,eA as le,o as y,t as C,i as E,a as N,S as re,eB as F,h as B,dj as h,g as A,eV as ie,d0 as ue,d6 as ce,cC as de,M as me,cQ as G,_ as fe}from"./jwt-decode.esm.466ece0e.js";import{G as pe}from"./PhClockCounterClockwise.vue.fd9708eb.js";import{I as ye}from"./PhDatabase.vue.998f78e7.js";import{G as _e}from"./PhDownloadSimple.vue.e1e2badc.js";import{F as ge}from"./PhKey.vue.7c294366.js";import{l as D,e as he}from"./toggleHighContrast.82635cc0.js";import{_ as ve}from"./TablesTabs.vue_vue_type_script_setup_true_lang.5bfc66eb.js";import{A as Ce,C as be}from"./router.8f19dff8.js";import{a as qe}from"./project.0b7908dc.js";import"./tables.276d9204.js";import{u as we}from"./useTables.76c6c12d.js";import{t as Ee}from"./ant-design.a154f7b2.js";import"./Card.4ede503a.js";import"./index.f0f4da2b.js";import"./record.5fd493ac.js";import"./string.87c756ca.js";(function(){try{var t=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},a=new Error().stack;a&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[a]="bd6c8a05-c0aa-4da8-952c-1ca4ba6e154b",t._sentryDebugIdIdentifier="sentry-dbid-bd6c8a05-c0aa-4da8-952c-1ca4ba6e154b")}catch{}})();const W=t=>{if(t==null)return"";const a=String(t);return a.includes(";")||a.includes(`
`)||a.includes('"')?`"${a.replace(/"/g,'""')}"`:a},$e=t=>{let a=t.columns.map(W).join(";")+`
`;t.rows.forEach(m=>{a+=m.map(W).join(";")+`
`});const n=document.createElement("a");n.href="data:text/csv;charset=utf-8,"+encodeURIComponent(a),n.target="_blank",n.download=`${t.fileName}.csv`,n.click()},O=new J(b.array(b.object({projectId:b.string(),lastQuery:b.string()})),"lastQueries"),R=new J(b.array(b.object({id:b.string(),query:b.string(),timestamp:b.number(),projectId:b.string()})),"queryHistory");function ke(t,a){var $;const n=t.toUpperCase(),m=/\b(FROM|JOIN|UPDATE|INTO)\s+\w*$/i.test(n)||/\bDELETE\s+FROM\s+\w*$/i.test(n),s=/\b(SELECT|WHERE|ON|SET|AND|OR|BY)\s+[\w.]*$/i.test(n)||/\w+\.\w*$/.test(t),c=t.match(/(\w+)\.\w*$/),L=c&&($=a.find(I=>I.name.toUpperCase()===c[1].toUpperCase()))!=null?$:null,q=/\b(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP|FROM|WHERE|JOIN)\b/.test(n);return{textBeforeCursor:t,isTableContext:m,isColumnContext:s,specificTable:L,hasSqlKeyword:q}}function xe(t,a,n){const m=[];if(t.specificTable)t.specificTable.getColumns().forEach(s=>{m.push({label:s.name,kind:D.CompletionItemKind.Field,insertText:s.name,detail:`${s.type}`,documentation:`Column from ${t.specificTable.name}`,range:n})});else if(t.isTableContext)a.forEach(s=>{m.push({label:s.name,kind:D.CompletionItemKind.Class,insertText:s.name,detail:"Table",documentation:`${s.getColumns().length} columns`,range:n})});else if(t.isColumnContext)a.forEach(s=>{s.getColumns().forEach(c=>{m.push({label:`${s.name}.${c.name}`,kind:D.CompletionItemKind.Field,insertText:`${s.name}.${c.name}`,detail:`${c.type}`,documentation:`${s.name}.${c.name}`,range:n})})});else{if(!t.hasSqlKeyword)return[];a.forEach(s=>{m.push({label:s.name,kind:D.CompletionItemKind.Class,insertText:s.name,detail:"Table",range:n}),s.getColumns().forEach(c=>{m.push({label:`${s.name}.${c.name}`,kind:D.CompletionItemKind.Field,insertText:`${s.name}.${c.name}`,detail:`${c.type}`,range:n})})})}return m}function Te(t,a){const n=S(""),m=S([]),s=S([]),c=S(!1),L=()=>{const r=O.get();if(!r)O.set([{projectId:t,lastQuery:n.value}]);else{const o=r.findIndex(d=>d.projectId===t);o===-1?r.push({projectId:t,lastQuery:n.value}):r[o].lastQuery=n.value,O.set(r)}},q=()=>{var o;const r=O.get();return(o=r==null?void 0:r.find(d=>d.projectId===t))==null?void 0:o.lastQuery},$=r=>{if(!r.trim())return;const o=R.get()||[],d={id:`${Date.now()}-${Math.random()}`,query:r.trim(),timestamp:Date.now(),projectId:t},_=o.filter(x=>x.projectId===t),g=o.filter(x=>x.projectId!==t),k=[d,..._].slice(0,50);R.set([...k,...g])},I=()=>(R.get()||[]).filter(o=>o.projectId===t).sort((o,d)=>d.timestamp-o.timestamp),z=()=>{const o=(R.get()||[]).filter(d=>d.projectId!==t);R.set(o)},M=async()=>{c.value=!0;const r=await qe.executeQuery(t,n.value,[]);if(L(),$(n.value),c.value=!1,!r)return{returns:{result:[],fields:[]},errors:[]};const{returns:o,errors:d}=r;return s.value=o.fields.map(_=>({title:_.name,key:_.name,dataIndex:_.name,ellipsis:!0})),m.value=o.result.map((_,g)=>{const k={key:`${g+1}`};return Object.entries(_).forEach(([x,U])=>{k[x]=U}),k}),{returns:o,errors:d}};let H=null;const P=()=>{!a.value||a.value.length===0||(H&&H.dispose(),H=D.registerCompletionItemProvider("sql",{provideCompletionItems:(r,o)=>{const d=r.getWordUntilPosition(o),_={startLineNumber:o.lineNumber,endLineNumber:o.lineNumber,startColumn:d.startColumn,endColumn:d.endColumn},g=r.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:o.lineNumber,endColumn:o.column}),k=ke(g,a.value);return{suggestions:xe(k,a.value,_)}}}))};return se(a,()=>{a.value&&a.value.length>0&&P()},{immediate:!0}),{sql:n,data:m,columns:s,loading:c,runSql:M,getLastQuery:q,setLastQuery:L,getHistory:I,clearHistory:z}}const Se={class:"sql-main-card"},Ie={class:"data-dictionary"},Ne={class:"dictionary-header"},Le=["onClick"],De={class:"column-name"},He={class:"column-type"},Qe={class:"sql-editor-container"},je={key:1,class:"history-list"},Ae=["onClick"],Re={class:"history-query"},Ke={class:"history-timestamp"},Oe=ae({__name:"Sql",setup(t){const a=le(),n=a.params.projectId,m=S(null);let s=null;const{tables:c,loading:L}=we(n),{sql:q,data:$,columns:I,loading:z,runSql:M,getLastQuery:H,setLastQuery:P,getHistory:r,clearHistory:o}=Te(n,c),d=S([]),_=S(!1),g=S([]),k=async()=>{const{errors:f}=await M();g.value=r();for(const p of f)G.error({message:E.translate("i18n_sql_execution_failed"),description:p});f.length||G.success({message:E.translate("i18n_sql_execution_succeeded")})},x=()=>{const f=I.value.map(Q=>Q.dataIndex),p=I.value.map(Q=>Q.title),l=$.value.map(Q=>f.map(ee=>Q[ee])),V=`data-${new Date().toISOString()}`;$e({fileName:V,columns:p,rows:l})},U=(f,p)=>{if(!s)return;const l=s.getSelection();if(!l)return;const w=`${f}.${p}`;s.executeEdits("",[{range:l,text:w}]),s.focus()},Y=f=>{s&&(s.setValue(f),q.value=f),_.value=!1},Z=()=>{o(),g.value=[]},X=ne.exports.debounce(P,1e3);return oe(()=>{g.value=r(),s=he.create(m.value,{language:"sql",value:q.value,fontFamily:"monospace",lineNumbers:"on",minimap:{enabled:!1},scrollbar:{vertical:"hidden",horizontal:"visible"},fontSize:14,scrollBeyondLastLine:!1,lineHeight:20,suggestOnTriggerCharacters:!0,quickSuggestions:{other:!0,comments:!1,strings:!1}}),s.onDidChangeModelContent(()=>{!s||(q.value=s.getValue(),X())});const f=a.query.filter;if(f&&typeof f=="string"&&f.trim())q.value=f,s.setValue(f);else{const p=H();p&&(q.value=p,s.setValue(p))}}),(f,p)=>(y(),T(j,null,[i(ve),v("div",Se,[i(e(h),{gap:"middle",style:{width:"100%",height:"100%"}},{default:u(()=>[v("div",Ie,[v("div",Ne,[i(e(ye),{size:16}),v("span",null,C(e(E).translate("i18n_sql_tables")),1)]),e(L)?(y(),N(e(re),{key:0,style:{width:"100%",padding:"20px"}})):(y(),N(e(be),{key:1,activeKey:d.value,"onUpdate:activeKey":p[0]||(p[0]=l=>d.value=l),ghost:""},{default:u(()=>[(y(!0),T(j,null,F(e(c),l=>(y(),N(e(Ce),{key:l.id,header:l.name},{default:u(()=>[(y(!0),T(j,null,F(l.getColumns(),w=>(y(),T("div",{key:w.id,class:"column-item",onClick:V=>U(l.name,w.name)},[w.primaryKey?(y(),N(e(ge),{key:0,size:12,style:{color:"#faad14"}})):B("",!0),v("span",De,C(w.name),1),v("span",He,C(w.type),1)],8,Le))),128))]),_:2},1032,["header"]))),128))]),_:1},8,["activeKey"]))]),i(e(h),{vertical:"",style:{flex:"1"},gap:"middle"},{default:u(()=>[v("div",Qe,[v("div",{ref_key:"sqlEditor",ref:m,class:"sql-editor"},null,512),i(e(h),{justify:"flex-end",class:"bottom-controls",gap:"small",align:"center"},{default:u(()=>[i(e(h),{gap:"small"},{default:u(()=>[i(K,{size:"small",type:"text",onClick:p[1]||(p[1]=l=>_.value=!0)},{default:u(()=>[i(e(h),{gap:"4",align:"center"},{default:u(()=>[i(e(pe),{size:14}),A(" "+C(e(E).translate("i18n_sql_history")),1)]),_:1})]),_:1})]),_:1}),i(e(h),{gap:"small",align:"center"},{default:u(()=>[i(K,{size:"small",type:"primary",loading:e(z),onClick:k},{default:u(()=>[i(e(h),{gap:"4",align:"center"},{default:u(()=>[A(C(e(E).translate("i18n_sql_run"))+" ",1),i(e(ie),{size:12})]),_:1})]),_:1},8,["loading"])]),_:1})]),_:1})]),i(te,{"outer-style":{width:"100%",height:"calc(100% - 220px)"}},{default:u(()=>[i(e(ue),{scroll:{x:100},"data-source":e($),columns:e(I)},{bodyCell:u(({text:l})=>[typeof l=="object"&&l!==null?(y(),N(e(ce),{key:0,"tree-data":e(Ee)(l),style:{"overflow-x":"scroll"}},null,8,["tree-data"])):(y(),T(j,{key:1},[A(C(l),1)],64))]),_:1},8,["data-source","columns"])]),_:1}),e($).length?(y(),N(e(h),{key:0,justify:"end"},{default:u(()=>[i(K,{onClick:x},{default:u(()=>[i(e(h),{align:"center",gap:"small"},{default:u(()=>[A(C(e(E).translate("i18n_sql_export_to_csv"))+" ",1),i(e(_e))]),_:1})]),_:1})]),_:1})):B("",!0)]),_:1})]),_:1})]),i(e(me),{open:_.value,"onUpdate:open":p[2]||(p[2]=l=>_.value=l),title:e(E).translate("i18n_sql_query_history"),width:"800px",footer:null},{default:u(()=>[i(e(h),{vertical:"",gap:"middle"},{default:u(()=>[i(e(h),{justify:"end"},{default:u(()=>[i(K,{danger:"",size:"small",onClick:Z},{default:u(()=>[A(C(e(E).translate("i18n_sql_clear_history")),1)]),_:1})]),_:1}),g.value.length?(y(),T("div",je,[(y(!0),T(j,null,F(g.value,l=>(y(),T("div",{key:l.id,class:"history-item",onClick:w=>Y(l.query)},[v("div",Re,C(l.query),1),v("div",Ke,C(new Date(l.timestamp).toLocaleString()),1)],8,Ae))),128))])):(y(),N(e(de),{key:0,description:e(E).translate("i18n_sql_no_query_history")},null,8,["description"]))]),_:1})]),_:1},8,["open","title"])],64))}});const ot=fe(Oe,[["__scopeId","data-v-c8d06130"]]);export{ot as default};
//# sourceMappingURL=Sql.0a1cda58.js.map
