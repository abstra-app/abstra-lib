var He=Object.defineProperty;var Fe=(s,e,t)=>e in s?He(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var C=(s,e,t)=>(Fe(s,typeof e!="symbol"?e+"":e,t),t);import{d as W,G as g,b as h,ev as _,f as c,u as o,eL as O,ex as E,bq as V,eC as Q,e as x,eD as A,eE as Le,eF as Ue,v as Y,r as H,E as pe,eM as Ve,eA as ze,eK as Be,o as ke,c as v,w as n,bM as Qe,bh as Pe,bf as B,cC as F,bH as j,br as _e,aq as S,eH as We,ez as Ae,ew as se,cB as Ye,ad as Je,I as je,cy as qe}from"./outputWidgets.c7d3adb6.js";import{w as ae,s as re}from"./metadata.7aba3896.js";import{u as Ze,x as Xe,y as et,z as Te}from"./icons.04bb36b4.js";import"./schema.60e99d9b.js";import{W as we}from"./workspaces.a6d61746.js";import{B as tt}from"./index.643a27af.js";import{A as J}from"./index.a17aa52c.js";import{A as I}from"./Text.b8f940d0.js";import{A as le}from"./FormItem.424fcca7.js";import{A as Ee}from"./Link.7cd46e88.js";import{C as ue}from"./Card.4b851c63.js";import"./index.cf4c23b9.js";import"./record.75c383f2.js";import"./pubsub.83cf89e6.js";import"./url.125f4924.js";import"./isNumeric.75337b1e.js";import"./hasIn.2d7f1a4b.js";import"./index.8f70a193.js";import"./TabPane.09eb877a.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[e]="5e56d63d-42a0-4a09-a90f-5cd304608ef9",s._sentryDebugIdIdentifier="sentry-dbid-5e56d63d-42a0-4a09-a90f-5cd304608ef9")}catch{}})();const Ce=s=>(Le("data-v-fd735e5b"),s=s(),Ue(),s),st={class:"empty-hint"},it={key:0,class:"drag-hint"},at=Ce(()=>x("div",{class:"title"},"Start here",-1)),ot={key:1,class:"drop-hint"},nt=Ce(()=>x("div",{class:"title"},"Drop here",-1)),rt={key:2,class:"stages-hint"},lt={class:"header"},ut={class:"title"},dt={class:"description"},ct=W({__name:"EmptyHint",props:{gui:{}},setup(s){const e=s,t=g(()=>e.gui.model.getState().stages.length===0&&e.gui.mouseState.state!=="ADDING_NEW_STAGES"),i=g(()=>e.gui.model.getState().stages.length===0&&e.gui.mouseState.state==="ADDING_NEW_STAGES");return(a,l)=>(h(),_("div",st,[t.value?(h(),_("div",it,[at,c(O,{path:o(Ze),class:"arrow"},null,8,["path"])])):E("",!0),i.value?(h(),_("div",ot,[nt,c(O,{path:o(Xe),class:"arrow"},null,8,["path"])])):E("",!0),t.value?(h(),_("div",rt,[(h(!0),_(V,null,Q(o(ae).stages,r=>(h(),_("div",{key:r.key,class:"stage-hint"},[x("div",lt,[c(O,{path:r.icon},null,8,["path"]),x("span",ut,A(r.title),1)]),x("div",dt,A(r.description),1)]))),128))])):E("",!0)]))}});const ht=Y(ct,[["__scopeId","data-v-fd735e5b"]]);function mt(s){return ft(s.p1,s.p2)}function b(s,e){return{dx:e.x-s.x,dy:e.y-s.y,referential:s.referential}}function q(s,e){return{referential:s.referential,x:s.x+e.dx,y:s.y+e.dy}}function pt(s,e){return{referential:s.referential,dx:s.dx*e,dy:s.dy*e}}function Z(s,e,t){const{x:i,y:a,width:l,height:r}=t,{dx:d,dy:u}=e,{x:m,y:f}=s,P=(i-m)/d,D=(i+l-m)/d,R=(a-f)/u,K=(a+r-f)/u,$=Math.max(Math.min(P,D),Math.min(R,K));return{x:m+$*d,y:f+$*u,referential:s.referential}}function gt(s,e){const t=he(s),i=he(e),a=Z(i,b(i,t),s),l=Z(t,b(t,i),e);return{p1:a,p2:l}}function St(s,e,t=!1){return t?e.x<=s.x&&e.x+e.width>=s.x&&e.y<=s.y&&e.y+e.height>=s.y:e.x<s.x&&e.x+e.width>s.x&&e.y<s.y&&e.y+e.height>s.y}function he(s){return{x:s.x+s.width/2,y:s.y+s.height/2,referential:s.referential}}const me=s=>s.reduce((e,t)=>{const i=e?Math.min(e.x,t.x):t.x,a=e?Math.min(e.y,t.y):t.y,l=e?Math.max(e.x+e.width,t.x+t.width):t.x+t.width,r=e?Math.max(e.y+e.height,t.y+t.height):t.y+t.height;return{x:i,y:a,width:l-i,height:r-a,referential:t.referential}},null);function ft(s,e){return Math.sqrt((s.x-e.x)**2+(s.y-e.y)**2)}function yt(s,e){const{p1:t,p2:i}=s,a=Math.atan2(i.y-t.y,i.x-t.x),l=e*Math.sin(a),d={dx:e*Math.cos(a),dy:l,referential:t.referential},u=q(t,d),m=q(i,pt(d,-1));return{p1:u,p2:m}}function Ne(s,e){return{referential:s.referential,x:s.x-e,y:s.y-e,width:s.width+2*e,height:s.height+2*e}}const ee={left:100,right:100,top:100,bottom:100},xe={width:600,height:600};class ge{constructor(e){C(this,"_state");C(this,"projectedElement");this._state=H({x:0,y:0,zoom:1}),this.projectedElement=e}get x(){return this._state.value.x}set x(e){if(Number.isNaN(e))throw new Error("x is NaN");this._state.value.x=e}get y(){return this._state.value.y}set y(e){if(Number.isNaN(e))throw new Error("y is NaN");this._state.value.y=e}static create(e){return new ge(e)}get zoom(){return this._state.value.zoom}set zoom(e){if(e<=0)throw new Error("Zoom must be positive");this._state.value.zoom=e}fit(e){const t={x:e.x+e.width/2,y:e.y+e.height/2,referential:"world"},i=this.screenRect2world(this.canvasRect);this.x=t.x-i.width/2,this.y=t.y-i.height/2,this.zoomIn(Math.min((this.canvasRect.width-ee.left-ee.right)/Math.max(xe.width,e.width),(this.canvasRect.height-ee.top-ee.bottom)/Math.max(xe.height,e.height))/this.zoom,this.worldPoint2screen(t))}screenPoint2world(e){return{x:e.x/this.zoom+this.x,y:e.y/this.zoom+this.y,referential:"world"}}worldPoint2screen(e){return{x:(e.x-this.x)*this.zoom,y:(e.y-this.y)*this.zoom,referential:"screen"}}screenDelta2world(e){return{dx:e.dx/this.zoom,dy:e.dy/this.zoom,referential:"world"}}worldDelta2screen(e){return{dx:e.dx*this.zoom,dy:e.dy*this.zoom,referential:"screen"}}screenRect2world(e){const t=this.screenPoint2world({x:e.x,y:e.y,referential:e.referential}),i=this.screenPoint2world({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:i.x-t.x,height:i.y-t.y,referential:t.referential}}worldRect2screen(e){const t=this.worldPoint2screen({x:e.x,y:e.y,referential:e.referential}),i=this.worldPoint2screen({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:i.x-t.x,height:i.y-t.y,referential:t.referential}}zoomIn(e,t){const i=this.screenPoint2world(t);this.zoom*=e;const a=this.worldPoint2screen(i),l=b(t,a),r=this.screenDelta2world({dx:l.dx,dy:l.dy,referential:"screen"});this.x+=r.dx,this.y+=r.dy}translate(e){this.x+=e.dx,this.y+=e.dy}get canvasRect(){if(!this.projectedElement)throw new Error("No canvas element");const e=this.projectedElement.getBoundingClientRect();return{x:e.x,y:e.y,width:e.width,height:e.height,referential:"screen"}}}class Se{static get isMac(){return navigator.userAgent.includes("Mac OS X")}static get buildPlatform(){return{}.CURRENT_PLATFORM||"web"}}const de=s=>Se.isMac&&s.ctrlKey,L=s=>Se.isMac?s.metaKey:s.ctrlKey,De=s=>s.altKey,U=s=>s.shiftKey,ce={alt:De,"arrow-up":s=>s.code==="ArrowUp","arrow-down":s=>s.code==="ArrowDown","arrow-left":s=>s.code==="ArrowLeft","arrow-right":s=>s.code==="ArrowRight",ctrl:L,delete:s=>Se.isMac?s.code==="Backspace":s.code==="Delete",enter:s=>s.code==="Enter",escape:s=>s.code==="Escape",shift:U,space:s=>s.code==="Space",a:s=>s.code==="KeyA",b:s=>s.code==="KeyB",c:s=>s.code==="KeyC",d:s=>s.code==="KeyD",f:s=>s.code==="KeyF",g:s=>s.code==="KeyG",h:s=>s.code==="KeyH",k:s=>s.code==="KeyK",p:s=>s.code==="KeyP",v:s=>s.code==="KeyV",x:s=>s.code==="KeyX",z:s=>s.code==="KeyZ",0:s=>s.code==="Digit0","[":s=>s.code==="BracketLeft","]":s=>s.code==="BracketRight"};class vt{constructor(e){C(this,"pressedKeys");C(this,"evt");this.evt=e,this.pressedKeys={};const t=i=>a=>{Object.keys(ce).forEach(l=>{ce[l](a)&&this.setPressed(l,i)})};this.evt||(window.addEventListener("keydown",t(!0)),window.addEventListener("keyup",t(!1)))}setPressed(e,t){this.pressedKeys[e]=t}isPressed(e){var t;return this.evt?ce[e](this.evt):(t=this.pressedKeys[e])!=null?t:!1}}new vt;class It{constructor(e){C(this,"selected");this.model=e,this.selected=pe([])}deselect(e){this.selected.value=this.selected.value.filter(t=>t.type==="stage"?!e.includes(t.stage.id):!e.includes(t.transition.id))}select(e,t=!1){t||(this.selected.value=[]),e.forEach(i=>{const a=this.model.getStage(i);a&&(this.selected.value=[...this.selected.value,{type:"stage",stage:a}]);const l=this.model.getTransition(i);if(l&&(this.selected.value=[...this.selected.value,{type:"transition",transition:l}]),!a&&!l)throw new Error(`Could not find stage or transition with id ${i}`)})}clear(){this.selected.value=[]}selectedStages(){return this.selected.value.map(e=>e.type==="stage"?this.model.getStage(e.stage.id):null).filter(Boolean)}selectedTransitions(){return this.selected.value.map(e=>e.type==="transition"?this.model.getTransition(e.transition.id):null).filter(Boolean)}selectedIds(){return this.selected.value.map(e=>e.type==="stage"?e.stage.id:e.transition.id)}has(e){return this.selected.value.some(t=>t.type==="stage"?t.stage.id===e.id:t.transition.id===e.id)}isEmpty(){return this.selected.value.length===0}selectAllStages(){this.select(this.model.getState().stages.map(e=>e.id))}}function Ge(s,e,t,i={}){s.strokeStyle=i.color||"black",s.lineWidth=4,s.lineJoin="round",s.lineCap="round";const a=Math.atan2(e.p2.y-e.p1.y,e.p2.x-e.p1.x);s.beginPath(),s.moveTo(e.p1.x,e.p1.y),s.lineTo(e.p2.x,e.p2.y),s.moveTo(e.p2.x-t*Math.cos(a-Math.PI/6),e.p2.y-t*Math.sin(a-Math.PI/6)),s.lineTo(e.p2.x,e.p2.y),s.lineTo(e.p2.x-t*Math.cos(a+Math.PI/6),e.p2.y-t*Math.sin(a+Math.PI/6)),s.stroke()}const Me="#ababab",fe="#e55b70",te=15;function ie(s,e){const t=s.getStageRect(e.id);return t?{x:t.x+t.width/2,y:t.y+t.height/2,referential:"screen"}:s.camera.worldPoint2screen({...e.position,referential:"world"})}function X(s,e){const t=s.getStageRect(e.id);if(t)return t;{const i=ie(s,e);return{x:i.x-100/2,y:i.y-100/2,width:100,height:100,referential:"screen"}}}function ye(s,e){const t=s.model.getStage(e.sourceStageId),i=s.model.getStage(e.targetStageId);if(!t)throw new Error(`Source node ${e.sourceStageId} not found`);if(!i)throw new Error(`Target node ${e.targetStageId} not found`);const a=ie(s,t),l=ie(s,i),r=Z(a,b(a,l),X(s,i));return{p1:Z(r,b(r,a),X(s,t)),p2:r}}function _t(s,e){const t=s.model.getTransition(e);if(!t)throw new Error(`Transition ${e} not found`);const i=ye(s,t);return{x:Math.min(i.p1.x,i.p2.x),y:Math.min(i.p1.y,i.p2.y),width:Math.abs(i.p1.x-i.p2.x),height:Math.abs(i.p1.y-i.p2.y),referential:"screen"}}function Tt(s,e){const t=s.selection.has(e),i=10,a=s.model.getStage(e.sourceStageId),l=s.model.getStage(e.targetStageId);if(!a)throw new Error(`Source node ${e.sourceStageId} not found`);if(!l)throw new Error(`Target node ${e.targetStageId} not found`);const r=Ne(X(s,a),te),d=Ne(X(s,l),te),u=gt(r,d);mt(u)<2*te||Ge(s.ctx,u,i,{color:t?fe:Me})}function wt(s,e){const t=ye(s,e);return{x:(t.p1.x+t.p2.x)/2,y:(t.p1.y+t.p2.y)/2,referential:"screen"}}function Et(s){if(s.mouseState.state!=="ADDING_TRANSITION")throw new Error("Invalid state");for(const e of s.selection.selectedStages())if(s.mouseState.snappedTarget)Re(s,{id:"",sourceStageId:e.id,targetStageId:s.mouseState.snappedTarget.id,props:{conditionValue:null}});else{const t=ie(s,e),i=Z(s.mouseState.mousePos,b(s.mouseState.mousePos,t),X(s,e)),a=s.mouseState.mousePos,r=yt({p1:i,p2:a},te);Ge(s.ctx,r,12,{color:Me})}}function Re(s,e){const t=s.model.getStage(e.sourceStageId),i=s.model.getStage(e.targetStageId);if(!t)throw new Error(`Source node ${e.sourceStageId} not found`);if(!i)throw new Error(`Target node ${e.targetStageId} not found`);Tt(s,e);const a=s.getTransitionRect(e.id);a&&s.ctx.clearRect(a.x,a.y,a.width,a.height)}function Nt(s,e){const t=ye(s,e);return{x:(t.p1.x+t.p2.x)/2,y:(t.p1.y+t.p2.y)/2,referential:"screen"}}function xt(s,e){var a;const t=s.model.getStage(e.sourceStageId);if(!t)throw new Error(`Source node ${e.sourceStageId} not found`);const i=t.type;if(!i.includes("conditions")&&!i.includes("iterators"))throw new Error("Source node is not a flow controller");return(a=t.props)==null?void 0:a.variableName}function kt(s,e){const t={...e.position,referential:"world"},i=s.camera.worldPoint2screen(t);return s.mouseState.state==="MOVING"&&s.selection.has(e)?q(i,b(s.mouseState.initialMousePos,s.mouseState.mousePos)):i}function Pt(s,e,t){const i=s.getStageRect(e.id);return i?St(t,i):!1}class ve{constructor(e,t){C(this,"_mouseState");C(this,"selection");C(this,"canvas");C(this,"ctx");C(this,"camera");C(this,"model");this.canvas=e,this.model=t,this.selection=new It(t),this.camera=ge.create(e),this._mouseState=pe({state:"IDLE",mousePos:{x:0,y:0,referential:"screen"}});const i=e.getContext("2d");if(!i)throw new Error("Unable to get canvas context");this.ctx=i}static create(e,t){const i=new ve(e,t);return i.init(),i}get mouseState(){return this._mouseState.value}set mouseState(e){this._mouseState.value=e}async deleteSelection(){this.model.delete(this.selection.selectedIds()),this.clearSelection(),this.goToIdle()}fixSize(){const{width:e,height:t}=this.canvas.getBoundingClientRect();this.canvas.width=e*devicePixelRatio,this.canvas.height=t*devicePixelRatio,this.ctx.scale(devicePixelRatio,devicePixelRatio)}computeCursor(){switch(this.mouseState.state){case"HOVERING_STAGE":this.canvas.style.cursor="pointer";break;case"HOVERING_TRANSITION":this.canvas.style.cursor="pointer";break;case"JUST_CLICKED_STAGE":this.canvas.style.cursor="default";break;case"JUST_CLICKED_TRANSITION":this.canvas.style.cursor="default";break;case"MOVING":this.canvas.style.cursor="move";break;case"PANNING":this.canvas.style.cursor="grabbing";break;case"ADDING_TRANSITION":this.canvas.style.cursor="crosshair";break;case"IDLE":default:this.canvas.style.cursor="grab"}}computePan(e){if(this.mouseState.state!=="PANNING")throw new Error(`Invalid state ${this.mouseState} on computePan`);const t=b(e,this.mouseState.mousePos),i=this.camera.screenDelta2world(t);this.camera.translate(i),this.mouseState={state:"PANNING",initialMousePos:this.mouseState.initialMousePos,mousePos:e}}setUpCanvasKeyDown(){let e=null;addEventListener("mousemove",t=>e=t),this.canvas.addEventListener("keydown",t=>{if(!!e)if(t.key==="f"||t.key==="F")this.dragstart("forms",e);else if(t.key==="h"||t.key==="H")this.dragstart("hooks",e);else if(t.key==="j"||t.key==="J")this.dragstart("jobs",e);else if(t.key==="c"||t.key==="C")this.dragstart("conditions",e);else if(t.key==="i"||t.key==="I")this.dragstart("iterators",e);else if(t.key==="s"||t.key==="S"){if(L(t))return;this.dragstart("scripts",e)}else(t.key==="z"||t.key==="Z")&&L(t)?(U(t)?this.model.history.redo():this.model.history.undo(),t.preventDefault()):(t.key==="a"||t.key==="A")&&L(t)?(this.selection.selectAllStages(),t.preventDefault()):(t.key==="Delete"||t.key==="Backspace")&&this.deleteSelection()})}setupMousemove(){const e=t=>{const i=this.getScreenPointerFromEvent(t);this.mouseState.state==="PANNING"?this.computePan(i):this.mouseState.state==="JUST_CLICKED_STAGE"?this.computeStartMoving(i,De(t),this.mouseState.stage):this.mouseState.state==="MOVING"?this.computeKeepMoving(i):this.mouseState.state==="ADDING_TRANSITION"?this.computeKeepLinking(i):this.mouseState.state==="ADDING_NEW_STAGES"&&this.computeKeepAdding(i),this.computeCursor()};addEventListener("mousemove",e)}setupMouseup(){const e=()=>{this.computeMouseRelease(),this.computeCursor()};addEventListener("mouseup",e)}computeMouseRelease(){this.mouseState.state!=="CHANGING_TRANSITION_TYPE"&&(this.mouseState.state==="PANNING"&&this.goToIdle(),this.mouseState.state==="MOVING"&&!this.mouseState.duplicating&&this.computeFinishMoving(),this.mouseState.state==="MOVING"&&this.mouseState.duplicating&&this.computeFinishDuplicating(),this.mouseState.state==="JUST_CLICKED_STAGE"&&this.computeStartHoveringStage(this.mouseState.stage),this.mouseState.state==="ADDING_TRANSITION"&&this.mouseState.snappedTarget&&this.computeFinishLinking())}setupDragover(){const e=t=>{if(t.preventDefault(),this.mouseState.state!=="ADDING_NEW_STAGES")return;const i=this.getScreenPointerFromEvent(t);this.computeKeepAdding(i)};this.canvas.addEventListener("dragover",e)}setupDrop(){const e=t=>{t.stopPropagation();const i=this.getScreenPointerFromEvent(t);this.computeFinishAdding(i)};this.canvas.addEventListener("drop",e)}setupWheel(){var t;const e=i=>{if(!this.camera)return;const a=this.getScreenPointerFromEvent(i);if(L(i)||de(i))this.computeZoomIn(a,i.deltaY>0?.9:1.1),i.preventDefault();else{const l=U(i)?{dx:i.deltaY,dy:0}:{dx:i.deltaX,dy:i.deltaY},r=this.camera.screenDelta2world({dx:l.dx,dy:l.dy,referential:"screen"});this.camera.translate(r)}i.stopPropagation()};(t=this.canvas.parentElement)==null||t.addEventListener("wheel",e)}setupMousedown(){const e=t=>{const i=this.getScreenPointerFromEvent(t);this.computeStartClicking(i)};this.canvas.addEventListener("mousedown",e)}computeZoomIn(e,t){this.camera.zoomIn(t,e)}computeStartMoving(e,t,i){if(this.mouseState.state!=="JUST_CLICKED_STAGE")throw new Error(`Invalid state ${this.mouseState.state} on computeStartMoving`);this.mouseState={state:"MOVING",duplicating:t,initialMousePos:this.mouseState.mousePos,mousePos:e,pivot:i}}computeKeepMoving(e){if(this.mouseState.state!=="MOVING")throw new Error(`Invalid state ${this.mouseState.state} on computeKeepMoving`);const t=this.mouseState.duplicating;this.mouseState={state:"MOVING",duplicating:t,initialMousePos:this.mouseState.initialMousePos,mousePos:e,pivot:this.mouseState.pivot}}computeFinishMoving(){if(this.mouseState.state!=="MOVING")throw new Error(`Invalid state ${this.mouseState.state} on computeFinishMoving`);const e=this.camera.screenPoint2world(this.mouseState.initialMousePos),t=this.camera.screenPoint2world(this.mouseState.mousePos),i=b(e,t);this.model.move(this.selection.selectedStages().map(l=>({id:l.id,position:q({...l.position,referential:"world"},i)})));const a=this.mouseState.pivot;this.goToIdle(),a&&this.computeStartHoveringStage(a)}createTransition(){if(this.mouseState.state!=="IDLE"&&this.mouseState.state!=="HOVERING_STAGE")throw new Error(`Invalid state ${this.mouseState.state} on createTransition`);this.mouseState={state:"ADDING_TRANSITION",mousePos:this.mouseState.mousePos,initialMousePos:this.mouseState.mousePos,snappedTarget:null}}computeKeepLinking(e){if(this.mouseState.state!=="ADDING_TRANSITION")throw new Error(`Invalid state ${this.mouseState.state} on computeKeepLinking`);const t=this.model.getState().stages.find(i=>Pt(this,i,e));t?this.mouseState={state:"ADDING_TRANSITION",initialMousePos:this.mouseState.initialMousePos,mousePos:e,snappedTarget:t}:this.mouseState={state:"ADDING_TRANSITION",initialMousePos:this.mouseState.initialMousePos,mousePos:e,snappedTarget:null}}computeFinishLinking(){if(this.mouseState.state!=="ADDING_TRANSITION"||!this.mouseState.snappedTarget)throw new Error(`Invalid state ${this.mouseState.state} on computeFinishLinking`);const e=this.mouseState.snappedTarget,t=this.selection.selectedStages().map(i=>({sourceStageId:i.id,targetStageId:e.id}));this.model.addTransitions(t),this.selection.select([this.mouseState.snappedTarget.id]),this.goToIdle(),this.computeStartHoveringStage(e)}duplicateSelection(){if(this.mouseState.state!=="HOVERING_STAGE"&&this.mouseState.state!=="HOVERING_TRANSITION"&&this.mouseState.state!=="IDLE")throw new Error(`Invalid state ${this.mouseState.state} on duplicateSelection`);const e=this.model.duplicateStages([...this.selection.selectedStages()]),t=he(me(e.stages.map(a=>({x:a.position.x,y:a.position.y,width:1,height:1,referential:"world"})))),i=this.camera.worldPoint2screen(t);return this.mouseState={state:"MOVING",duplicating:!0,initialMousePos:i,mousePos:this.mouseState.mousePos},e}duplicateThenSelect(){const t=this.duplicateSelection().stages.map(i=>i.id);this.selection.select(t)}computeFinishDuplicating(){if(this.mouseState.state!=="MOVING"||!this.mouseState.duplicating)throw new Error(`Invalid state ${this.mouseState.state} on computeFinishDuplicating`);const e=this.camera.screenPoint2world(this.mouseState.initialMousePos),t=this.camera.screenPoint2world(this.mouseState.mousePos),i=b(e,t);this.model.move(this.selection.selectedStages().map(a=>({id:a.id,position:q({...a.position,referential:"world"},i)}))),this.goToIdle()}computeKeepAdding(e){if(this.mouseState.state!=="ADDING_NEW_STAGES")throw new Error(`Invalid state ${this.mouseState.state} on computeKeepAdding`);this.mouseState={state:"ADDING_NEW_STAGES",mousePos:e,stages:this.mouseState.stages.map(t=>({...t,position:this.camera.screenPoint2world(e)}))}}computeFinishAdding(e){if(this.mouseState.state!=="ADDING_NEW_STAGES")return;this.computeKeepAdding(e);const t=this.model.addStages(this.mouseState.stages);this.selection.select(t.map(i=>i.id)),this.goToIdle()}getScreenPointerFromEvent(e){const t=this.canvas.getBoundingClientRect();return{x:e.pageX-t.x,y:e.pageY-t.y,referential:"screen"}}computeStartClicking(e){this.mouseState.state==="MOVING"&&this.mouseState.duplicating||(this.mouseState.state==="ADDING_NEW_STAGES"?this.computeFinishAdding(e):this.mouseState.state==="STAGE_QUICK_EDIT"?(this.model.updateStageTitle(this.mouseState.stage.id,this.mouseState.stage.title),this.model.updateStageProps(this.mouseState.stage.id,this.mouseState.draftProps),this.goToIdle()):this.mouseState.state==="CHANGING_TRANSITION_TYPE"?this.model.updateTransitionType(this.mouseState.transition.id,this.mouseState.newType):this.mouseState.state==="TRANSITION_QUICK_EDIT"&&this.model.updateTransitionProps(this.mouseState.transition.id,this.mouseState.draftProps),this.clearSelection(),this.mouseState={state:"PANNING",initialMousePos:e,mousePos:e})}stageMouseDown(e,t){if(this.mouseState.state==="HOVERING_STAGE"){if(this.selection.has(t)||this.selection.select([t.id],U(e)),e.button!==0)return;this.mouseState={state:"JUST_CLICKED_STAGE",mousePos:this.getScreenPointerFromEvent(e),stage:t};return}if(this.mouseState.state==="ADDING_TRANSITION"){this.computeFinishLinking();return}if(this.mouseState.state==="STAGE_QUICK_EDIT"){if(this.mouseState.stage.id===t.id)return;this.saveChangesOnChangingEditingEntity(),this.selection.select([t.id],U(e)),this.mouseState={state:"JUST_CLICKED_STAGE",mousePos:this.getScreenPointerFromEvent(e),stage:t}}(this.mouseState.state==="TRANSITION_QUICK_EDIT"||this.mouseState.state==="CHANGING_TRANSITION_TYPE")&&(this.saveChangesOnChangingEditingEntity(),this.selection.select([t.id],U(e)),this.mouseState={state:"JUST_CLICKED_STAGE",mousePos:this.getScreenPointerFromEvent(e),stage:t})}computeStartHoveringStage(e){this.mouseState.state!=="IDLE"&&this.mouseState.state!=="JUST_CLICKED_STAGE"||(this.mouseState={state:"HOVERING_STAGE",stage:e,mousePos:this.mouseState.mousePos})}computeFinishHoveringStage(e){this.mouseState.state==="HOVERING_STAGE"&&this.mouseState.stage.id===e.id&&this.goToIdle()}saveChangesOnChangingEditingEntity(){this.mouseState.state==="STAGE_QUICK_EDIT"&&(this.model.updateStageTitle(this.mouseState.stage.id,this.mouseState.stage.title),this.model.updateStageProps(this.mouseState.stage.id,this.mouseState.draftProps),this.goToIdle()),this.mouseState.state==="TRANSITION_QUICK_EDIT"&&(this.model.updateTransitionProps(this.mouseState.transition.id,this.mouseState.draftProps),this.goToIdle()),this.mouseState.state==="CHANGING_TRANSITION_TYPE"&&(this.model.updateTransitionType(this.mouseState.transition.id,this.mouseState.newType),this.goToIdle())}computeStartEditingStage(e){var t,i,a;if(!(this.mouseState.state==="STAGE_QUICK_EDIT"&&this.mouseState.stage.id===e.id)){if(this.saveChangesOnChangingEditingEntity(),this.mouseState.state!=="IDLE"&&this.mouseState.state!=="HOVERING_STAGE")throw new Error(`Invalid state ${this.mouseState.state} on computeStartEditingStage`);this.mouseState={state:"STAGE_QUICK_EDIT",stage:e,mousePos:this.mouseState.mousePos,draftProps:{path:(t=e.props)==null?void 0:t.path,filename:(i=e.props)==null?void 0:i.filename,variableName:(a=e.props)==null?void 0:a.variableName}},this.clearSelection()}}computeStartEditingStageSelection(){if(this.selection.selectedStages().length!==1)return;const e=this.selection.selectedStages()[0];this.computeStartEditingStage(e)}computeStartChangingTransitionSelection(){if(this.selection.selectedTransitions().length!==1)return;const e=this.selection.selectedTransitions()[0];this.computeStartChangingTransition(e)}computeChangeStage(e,t){if(this.mouseState.state!=="STAGE_QUICK_EDIT")throw new Error(`Invalid state ${this.mouseState.state} on computeChangeStage`);e==="title"?this.mouseState.stage.title=t:this.mouseState.draftProps={...this.mouseState.draftProps,[e]:t}}computeChangeStageType(e){if(this.mouseState.state!=="STAGE_QUICK_EDIT")throw new Error(`Invalid state ${this.mouseState.state} on computeChangeStageType`);this.mouseState.stage.type!==e&&this.model.updateStageType(this.mouseState.stage.id,e)}computeChangeTransition(e,t){this.mouseState.state==="TRANSITION_QUICK_EDIT"&&e==="condition"&&(this.mouseState.draftProps={conditionValue:t}),this.mouseState.state==="CHANGING_TRANSITION_TYPE"&&e==="type"&&(this.mouseState.newType=t)}computeKeyDownStage(e){if(e.key==="Enter"&&this.mouseState.state==="STAGE_QUICK_EDIT"){this.model.updateStageTitle(this.mouseState.stage.id,this.mouseState.stage.title),this.model.updateStageProps(this.mouseState.stage.id,this.mouseState.draftProps),this.goToIdle();return}this.mouseState.state==="STAGE_QUICK_EDIT"||this.mouseState.state==="TRANSITION_QUICK_EDIT"||(e.key==="t"||e.key==="T"?this.createTransition():e.key==="Enter"?this.selection.selectedStages().length===1&&this.computeStartEditingStage(this.selection.selectedStages()[0]):e.key==="d"||e.key==="D"?this.duplicateThenSelect():e.key==="Delete"||e.key==="Backspace"?this.deleteSelection():(e.key==="a"||e.key==="A")&&(L(e)||de(e))?(this.selection.select(this.model.getState().stages.map(t=>t.id)),e.preventDefault()):e.key==="Escape"&&(this.clearSelection(),this.goToIdle()))}transitionMouseDown(e,t){if(e.button===0&&!(this.mouseState.state==="MOVING"&&this.mouseState.duplicating)){if(this.mouseState.state==="TRANSITION_QUICK_EDIT"||this.mouseState.state==="CHANGING_TRANSITION_TYPE"){if(this.mouseState.transition.id===t.id)return;this.saveChangesOnChangingEditingEntity()}this.mouseState.state==="STAGE_QUICK_EDIT"&&this.saveChangesOnChangingEditingEntity(),this.selection.select([t.id],U(e)),this.computeStartHoveringTransition(t)}}computeStartHoveringTransition(e){if(!(this.mouseState.state==="CHANGING_TRANSITION_TYPE"||this.mouseState.state==="TRANSITION_QUICK_EDIT"||this.mouseState.state==="STAGE_QUICK_EDIT"||this.mouseState.state==="MOVING"||this.mouseState.state==="HOVERING_TRANSITION")){if(this.mouseState.state!=="IDLE")throw new Error(`Invalid state ${this.mouseState.state} on computeStartHoveringTransition`);this.mouseState={state:"HOVERING_TRANSITION",transition:e,mousePos:this.mouseState.mousePos}}}computeFinishHoveringTransition(e){if(!(this.mouseState.state==="CHANGING_TRANSITION_TYPE"||this.mouseState.state==="STAGE_QUICK_EDIT"||this.mouseState.state==="TRANSITION_QUICK_EDIT"||this.mouseState.state==="MOVING"||this.mouseState.state==="IDLE")){if(this.mouseState.state!=="HOVERING_TRANSITION")throw new Error(`Invalid state ${this.mouseState.state} on computeFinishHoveringTransition`);this.mouseState.transition.id===e.id&&this.goToIdle()}}computeAddTransition(){if(this.mouseState.state!=="IDLE")throw new Error(`Invalid state ${this.mouseState.state} on computeAddTransition`);this.mouseState={state:"ADDING_TRANSITION",mousePos:this.mouseState.mousePos,initialMousePos:this.mouseState.mousePos,snappedTarget:null}}revertTransitions(){this.selection.selectedTransitions().forEach(t=>this.model.revertTransition(t.id))}computeStartChangingTransition(e){var i;if(this.saveChangesOnChangingEditingEntity(),this.mouseState.state==="CHANGING_TRANSITION_TYPE")return;if(this.mouseState.state!=="HOVERING_TRANSITION"&&this.mouseState.state!=="IDLE")throw new Error(`Invalid state ${this.mouseState.state} on computeStartChangingTransition`);const t=this.model.getStage(e.sourceStageId);(t==null?void 0:t.type)!=="iterators"&&((t==null?void 0:t.type)==="conditions"?this.mouseState={state:"TRANSITION_QUICK_EDIT",transition:e,mousePos:this.mouseState.mousePos,draftProps:{conditionValue:(i=e.props)==null?void 0:i.conditionValue}}:this.mouseState={state:"CHANGING_TRANSITION_TYPE",transition:e,mousePos:this.mouseState.mousePos,newType:e.type})}computeKeyDownTransition(e){if(e.key==="Enter"&&this.mouseState.state==="TRANSITION_QUICK_EDIT"){this.model.updateTransitionProps(this.mouseState.transition.id,this.mouseState.draftProps),this.goToIdle();return}if(e.key==="Enter"&&this.mouseState.state==="CHANGING_TRANSITION_TYPE"){this.model.updateTransitionType(this.mouseState.transition.id,this.mouseState.newType),this.goToIdle();return}this.mouseState.state==="STAGE_QUICK_EDIT"||this.mouseState.state==="TRANSITION_QUICK_EDIT"||(e.key==="Enter"?this.selection.selectedTransitions().length===1&&this.computeStartChangingTransition(this.selection.selectedTransitions()[0]):e.key==="Delete"||e.key==="Backspace"?this.deleteSelection():e.key==="a"&&(L(e)||de(e))?(this.selection.select(this.model.getState().stages.map(t=>t.id)),e.preventDefault()):e.key==="r"||e.key==="R"?this.revertTransitions():e.key==="Escape"&&(this.clearSelection(),this.goToIdle()))}getStageRect(e){var l,r,d,u;this.mouseState,this.camera.x,this.camera.y,this.camera.zoom;const t=(l=this.canvas.parentElement)==null?void 0:l.querySelector(`.items-container [data-type="stage"][data-id="${e}"]`),i=(r=t==null?void 0:t.getBoundingClientRect)==null?void 0:r.call(t),a=(u=(d=t==null?void 0:t.parentElement)==null?void 0:d.getBoundingClientRect)==null?void 0:u.call(d);return!a||!i?null:{x:i.x-a.x,y:i.y-a.y,width:i.width,height:i.height,referential:"screen"}}getTransitionRect(e){var l,r,d,u;const t=(l=this.canvas.parentElement)==null?void 0:l.querySelector(`.items-container [data-type="transition"][data-id="${e}"]`),i=(r=t==null?void 0:t.getBoundingClientRect)==null?void 0:r.call(t),a=(u=(d=t==null?void 0:t.parentElement)==null?void 0:d.getBoundingClientRect)==null?void 0:u.call(d);return!a||!i?null:{x:i.x-a.x,y:i.y-a.y,width:i.width,height:i.height,referential:"screen"}}renderAddTransition(){this.mouseState.state==="ADDING_TRANSITION"&&Et(this)}debug(){this.ctx.fillText(JSON.stringify(this.mouseState,null,2),10,10),this.ctx.fillText(JSON.stringify(this.selection.selectedIds(),null,2),10,30)}render(){try{this.fixSize(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.model.getState().transitions.forEach(e=>{Re(this,e)}),this.renderAddTransition()}finally{requestAnimationFrame(()=>this.render())}}fitCamera(){const t=this.model.getState().stages.map(a=>({height:100,referential:"world",width:100,x:a.position.x-50,y:a.position.y-50})),i=me(t);!i||this.camera.fit(i)}init(){this.setUpCanvasKeyDown(),this.setupMousemove(),this.setupDragover(),this.setupMousedown(),this.setupDrop(),this.setupMouseup(),this.setupWheel(),this.render(),this.fitCamera()}clearSelection(){this.selection.clear()}dragstart(e,t){const i=this.getScreenPointerFromEvent(t);this.clearSelection(),this.mouseState={state:"ADDING_NEW_STAGES",mousePos:i,stages:[{type:e,position:this.camera.screenPoint2world(i)}]}}goToIdle(){this.mouseState={state:"IDLE",mousePos:this.mouseState.mousePos}}}const At=W({__name:"stage",props:{stage:{},gui:{},workspace:{}},emits:["change","changeType"],setup(s,{emit:e}){const t=s;Ve(p=>({"66c5c822":o(fe)}));const i=ze(),a=()=>{const p=i.resolve({path:`/_editor/${t.stage.type.slice(0,-1)}/${t.stage.id}`});window.open(p.href,"_blank")},l=H(!0),r=H(!1),d=Be.exports.debounce(async p=>{we.checkFile(p).then(w=>{l.value=w.exists,r.value=!1})},500),u=()=>{r.value=!0,!(t.stage.type==="conditions"||t.stage.type==="iterators")&&(t.workspace.initFile(M.value,t.stage.type).then(()=>{l.value=!0,r.value=!1}),we.checkFile(M.value).then(p=>{l.value=p.exists,r.value=!1}))},m=()=>{r.value=!0,!(t.stage.type==="conditions"||t.stage.type==="iterators")&&t.workspace.openFile(M.value).then(()=>{r.value=!1})},f=p=>{!p||e("change","title",p)},P=p=>{!p||e("change","path",p)},D=g(()=>t.stage.type==="conditions"||t.stage.type==="iterators"?{validateStatus:"success",help:""}:M.value.endsWith(".py")?l.value?{validateStatus:"success",help:""}:{validateStatus:"error",help:"This file does not exists"}:{validateStatus:"error",help:"File name must end with .py"}),R=g(()=>t.stage.type==="conditions"||t.stage.type==="iterators"||t.stage.type==="jobs"||t.stage.type==="scripts"?{validateStatus:"success",help:""}:z.value?{validateStatus:"success",help:""}:{validateStatus:"error",help:"Please insert a path"}),K=g(()=>t.stage.type!=="conditions"&&t.stage.type!=="iterators"?{validateStatus:"success",help:""}:oe.value?{validateStatus:"success",help:""}:{validateStatus:"error",help:"Please insert a variable name"}),$=g(()=>D.value.validateStatus==="error"||R.value.validateStatus==="error"||K.value.validateStatus==="error"),N=p=>{!p||(r.value=!0,d(p),e("change","filename",p))},y=p=>{!p||e("change","variableName",p)},G=p=>{!p||e("changeType",p)},k=H(t.stage.title),z=H(t.stage.props.path||""),M=H(t.stage.props.filename||""),oe=H(t.stage.props.variableName||""),Oe=g(()=>t.gui.selection.has(t.stage)),ne=g(()=>t.gui.mouseState.state==="STAGE_QUICK_EDIT"&&t.gui.mouseState.stage.id===t.stage.id),be=g(()=>t.stage.type==="conditions"||t.stage.type==="iterators"),Ke=g(()=>t.stage.type==="forms"||t.stage.type==="hooks"),Ie=g(()=>t.stage.type==="forms"||t.stage.type==="hooks"||t.stage.type==="jobs"),$e=g(()=>{const p=kt(t.gui,t.stage);return{transform:`translate(${p.x}px, ${p.y}px) scale(${t.gui.camera.zoom}) translate(-50%, -50%)`,transformOrigin:"top left"}});return ke(()=>{d(M.value)}),(p,w)=>(h(),_("div",{class:Ae(["stage-card",{selected:Oe.value}]),style:se($e.value),tabindex:"0"},[ne.value?(h(),v(o(ue),{key:0,class:"card"},{title:n(()=>[c(o(J),{justify:"space-between",align:"center"},{default:n(()=>[c(o(J),{align:"center"},{default:n(()=>[c(o(Qe),{trigger:["click"]},{overlay:n(()=>[c(o(Pe),null,{default:n(()=>[(h(!0),_(V,null,Q(o(ae).stages,T=>(h(),v(o(B),{key:T.key,onClick:qt=>G(T.typeName)},{default:n(()=>[c(o(F),null,{default:n(()=>[c(O,{path:T.icon},null,8,["path"]),c(o(I),{content:T.title},null,8,["content"])]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),default:n(()=>[x("a",null,[c(o(J),null,{default:n(()=>[c(O,{path:o(re)(p.stage.type)},null,8,["path"]),c(O,{path:o(et)},null,8,["path"])]),_:1})])]),_:1}),c(o(j),{value:k.value,"onUpdate:value":w[0]||(w[0]=T=>k.value=T),bordered:!1,class:"title-input",onChange:w[1]||(w[1]=T=>f(T.target.value))},null,8,["value"])]),_:1}),p.gui.model.stageHasChanges(p.stage.id)?(h(),v(o(_e),{key:1},{title:n(()=>[x("span",null,"Save to allow edit in "+A(p.stage.type)+" editor",1)]),default:n(()=>[Ie.value?(h(),v(O,{key:0,path:o(Te),style:{opacity:"0.5",cursor:"default"}},null,8,["path"])):E("",!0)]),_:1})):(h(),v(o(_e),{key:0},{title:n(()=>[x("span",null,"Edit more in "+A(p.stage.type)+" editor",1)]),default:n(()=>[Ie.value?(h(),v(O,{key:0,path:o(Te),onclick:a},null,8,["path"])):E("",!0)]),_:1}))]),_:1})]),default:n(()=>[be.value?(h(),v(o(F),{key:0,direction:"vertical",size:4,style:{width:"100%"}},{default:n(()=>[c(o(I),null,{default:n(()=>[S("Variable name")]),_:1}),c(o(le),{"validate-status":K.value.validateStatus,help:K.value.help},{default:n(()=>[c(o(j),{value:oe.value,"onUpdate:value":w[2]||(w[2]=T=>oe.value=T),onChange:w[3]||(w[3]=T=>y(T.target.value))},null,8,["value"])]),_:1},8,["validate-status","help"])]),_:1})):(h(),v(o(F),{key:1,direction:"vertical",style:{width:"100%"}},{default:n(()=>[Ke.value?(h(),v(o(F),{key:0,direction:"vertical",size:4,style:{width:"100%"}},{default:n(()=>[c(o(I),null,{default:n(()=>[S("Path")]),_:1}),c(o(le),{"validate-status":R.value.validateStatus,help:R.value.help},{default:n(()=>[c(o(j),{value:z.value,"onUpdate:value":w[4]||(w[4]=T=>z.value=T),onChange:w[5]||(w[5]=T=>P(T.target.value))},We({_:2},[p.stage.type==="forms"?{name:"addonBefore",fn:n(()=>[S("/")]),key:"0"}:p.stage.type==="hooks"?{name:"addonBefore",fn:n(()=>[S("/_hooks/")]),key:"1"}:void 0]),1032,["value"])]),_:1},8,["validate-status","help"])]),_:1})):E("",!0),c(o(F),{direction:"vertical",size:4,style:{width:"100%"}},{default:n(()=>[c(o(I),null,{default:n(()=>[S("File name")]),_:1}),c(o(le),{"validate-status":D.value.validateStatus},{help:n(()=>[M.value.endsWith(".py")?l.value?(h(),v(o(Ee),{key:2,onClick:m},{default:n(()=>[S(" Open file ")]),_:1})):(h(),v(o(I),{key:1},{default:n(()=>[S(" This file does not exist. "),c(o(Ee),{onClick:u},{default:n(()=>[S("Create file")]),_:1})]),_:1})):(h(),v(o(I),{key:0,type:"danger"},{default:n(()=>[S(A(D.value.help),1)]),_:1}))]),default:n(()=>[c(o(j),{value:M.value,"onUpdate:value":w[6]||(w[6]=T=>M.value=T),loading:r.value,onChange:w[7]||(w[7]=T=>N(T.target.value))},null,8,["value","loading"])]),_:1},8,["validate-status"])]),_:1})]),_:1}))]),_:1})):E("",!0),!ne.value&&$.value?(h(),v(o(tt),{key:1,count:"!"},{default:n(()=>[c(o(ue),{class:"card"},{default:n(()=>[c(o(J),{align:"center",gap:"small"},{default:n(()=>[c(O,{path:o(re)(p.stage.type)},null,8,["path"]),c(o(I),{content:p.stage.title},null,8,["content"])]),_:1})]),_:1})]),_:1})):E("",!0),!ne.value&&!$.value?(h(),v(o(ue),{key:2,class:"card"},{default:n(()=>[c(o(J),{align:"center",gap:"small"},{default:n(()=>[c(O,{path:o(re)(p.stage.type)},null,8,["path"]),c(o(I),{content:p.stage.title,ellipsis:!0},null,8,["content"])]),_:1})]),_:1})):E("",!0)],6))}});const Ct=Y(At,[["__scopeId","data-v-7398c030"]]),Dt={key:2},Gt={key:3},Mt={key:4},Rt=W({__name:"transition",props:{transition:{},gui:{}},emits:["change"],setup(s,{emit:e}){const t=s,i=y=>{e("change","type",String(y))},a=y=>{!y||e("change","condition",y)},l=t.gui.model.getStage(t.transition.sourceStageId);if(!l)throw new Error(`No source stage found for transition ${t.transition.id}`);const r=ae.stages.find(y=>y.typeName===l.type),d=g(()=>{const y=r==null?void 0:r.transitions.find(G=>G.typeName===t.transition.type);if(!y)throw new Error(`No metadata found for transition ${t.transition.type}`);return y.title}),u=g(()=>!R.value&&!D.value?"":xt(t.gui,t.transition)),m=g(()=>{var y;return D.value&&((y=t.transition.props)==null?void 0:y.conditionValue)||""}),f=g(()=>t.gui.mouseState.state!=="CHANGING_TRANSITION_TYPE"?!1:t.gui.mouseState.transition.id===t.transition.id),P=g(()=>t.gui.mouseState.state!=="TRANSITION_QUICK_EDIT"?!1:t.gui.mouseState.transition.id===t.transition.id),D=g(()=>t.transition.type.includes("conditions")),R=g(()=>t.transition.type.includes("iterators")),K=g(()=>t.gui.selection.has(t.transition)),$=g(()=>t.gui.mouseState.state!=="CHANGING_TRANSITION_TYPE"?"":t.gui.mouseState.newType),N=g(()=>{const y=wt(t.gui,t.transition);return{transform:`translate(${y.x}px, ${y.y}px) scale(${t.gui.camera.zoom}) translate(-50%, -50%)`,transformOrigin:"top left"}});return(y,G)=>(h(),_("div",{class:Ae(["transition-card",{selected:K.value}]),style:se(N.value),tabindex:"0"},[f.value?(h(),v(o(F),{key:0,class:"editing"},{default:n(()=>[c(o(Je),{class:"selector","default-value":$.value,"onUpdate:value":i},{default:n(()=>{var k,z;return[(h(!0),_(V,null,Q((z=(k=o(r))==null?void 0:k.transitions)!=null?z:[],M=>(h(),v(o(Ye),{key:M.typeName},{default:n(()=>[S(A(M.title),1)]),_:2},1024))),128))]}),_:1},8,["default-value"])]),_:1})):P.value?(h(),v(o(F),{key:1,class:"editing"},{default:n(()=>[c(o(j),{style:{width:"200px"},"default-value":m.value,onChange:G[0]||(G[0]=k=>a(k.target.value))},{addonBefore:n(()=>[S("= ")]),_:1},8,["default-value"])]),_:1})):D.value?(h(),_("span",Dt,[c(o(I),{code:""},{default:n(()=>[S(A(u.value),1)]),_:1}),S(" = "+A(m.value),1)])):R.value?(h(),_("span",Gt,[S("for "),c(o(I),{code:""},{default:n(()=>[S("item")]),_:1}),S(" in "),c(o(I),{code:""},{default:n(()=>[S(A(u.value),1)]),_:1})])):(h(),_("span",Mt,A(d.value),1))],6))}});const Ot=Y(Rt,[["__scopeId","data-v-c3016c87"]]),bt={class:"menu-item"},Kt={class:"menu-item"},$t={class:"menu-item"},Ht={class:"menu-item"},Ft={class:"menu-item"},Lt=W({__name:"selection",props:{gui:{}},emits:["add-transition","duplicate-stages","revert-transitions","edit-stage","edit-transition","delete"],setup(s,{emit:e}){const t=s,i=g(()=>t.gui.selection.selectedIds().length===t.gui.selection.selectedStages().length),a=g(()=>t.gui.selection.selectedIds().length===t.gui.selection.selectedTransitions().length),l=g(()=>t.gui.selection.selectedIds().length>1||t.gui.selection.selectedIds().length===1&&t.gui.selection.selectedTransitions().length>0),r=g(()=>t.gui.selection.selectedIds().length===1),d=g(()=>t.gui.selection.selectedTransitions().some(y=>y.type.includes("iterators"))),u=g(()=>t.gui.selection.selectedIds().length>0&&(t.gui.mouseState.state==="IDLE"||t.gui.mouseState.state==="HOVERING_STAGE"||t.gui.mouseState.state==="HOVERING_TRANSITION"));function m(){const N=t.gui.selection.selectedStages(),y=N.map(k=>t.gui.getStageRect(k.id)),G=t.gui.selection.selectedTransitions();return(G.length>1||N.length>0)&&y.push(...G.map(k=>_t(t.gui,k.id))),me(y)}const f=g(()=>{const N=m();if(!N)if(a.value&&r.value){const G=t.gui.selection.selectedTransitions()[0],k=Nt(t.gui,G);return{menu:{transform:`translate(${k.x+50}px, ${k.y-10}px) scale(${t.gui.camera.zoom}) `,transformOrigin:"top left"},hull:{}}}else return{menu:{display:"none"},hull:{display:"none"}};const y={x:N.x+N.width+10,y:N.y,referential:"screen"};return{menu:{transform:`translate(${y.x}px, ${y.y}px)`,transformOrigin:"top left"},hull:{position:"absolute",top:`${N.y}px`,left:`${N.x}px`,width:`${N.width}px`,height:`${N.height}px`,pointerEvents:"none",border:`1px dashed ${fe}`,boxSizing:"border-box"}}}),P=()=>e("add-transition"),D=()=>{i.value?e("edit-stage"):a.value&&e("edit-transition")},R=()=>e("duplicate-stages"),K=()=>e("delete"),$=()=>e("revert-transitions");return(N,y)=>(h(),_(V,null,[u.value?(h(),v(o(Pe),{key:0,class:"selection-menu",style:se(f.value.menu)},{default:n(()=>[i.value?(h(),v(o(B),{key:0,onClick:P},{default:n(()=>[x("div",bt,[c(o(I),null,{default:n(()=>[S("Add transition")]),_:1}),c(o(I),{keyboard:""},{default:n(()=>[S("T")]),_:1})])]),_:1})):E("",!0),r.value&&!d.value?(h(),v(o(B),{key:1,onClick:D},{default:n(()=>[x("div",Kt,[c(o(I),null,{default:n(()=>[S("Edit")]),_:1}),c(o(I),{keyboard:""},{default:n(()=>[S("Enter")]),_:1})])]),_:1})):E("",!0),i.value?(h(),v(o(B),{key:2,onClick:R},{default:n(()=>[x("div",$t,[c(o(I),null,{default:n(()=>[S("Duplicate")]),_:1}),c(o(I),{keyboard:""},{default:n(()=>[S("D")]),_:1})])]),_:1})):E("",!0),c(o(B),{onClick:K},{default:n(()=>[x("div",Ht,[c(o(I),null,{default:n(()=>[S("Delete")]),_:1}),c(o(I),{keyboard:""},{default:n(()=>[S("Del")]),_:1})])]),_:1}),a.value?(h(),v(o(B),{key:3,onClick:$},{default:n(()=>[x("div",Ft,[c(o(I),null,{default:n(()=>[S("Revert")]),_:1}),c(o(I),{keyboard:""},{default:n(()=>[S("R")]),_:1})])]),_:1})):E("",!0)]),_:1},8,["style"])):E("",!0),l.value?(h(),_("div",{key:1,class:"selection-hull",style:se(f.value.hull)},null,4)):E("",!0)],64))}});const Ut=Y(Lt,[["__scopeId","data-v-d4bbc465"]]),Vt={class:"canvas-container"},zt={key:0,class:"items-container"},Bt=W({__name:"CanvasGui",props:{model:{},workspace:{}},setup(s,{expose:e}){const t=s,i=H(null),a=pe(null);e({gui:a}),ke(()=>{if(!i.value)throw new Error("canvas is null");a.value=ve.create(i.value,t.model)});const l=g(()=>t.model.getState());return(r,d)=>(h(),_("div",Vt,[x("canvas",{ref_key:"canvas",ref:i,class:"workflow-canvas",tabindex:"0"},null,512),a.value?(h(),_("div",zt,[(h(!0),_(V,null,Q(l.value.stages,u=>(h(),v(Ct,{key:u.id,gui:a.value,workspace:r.workspace,"data-type":"stage","data-id":u.id,stage:u,onChange:d[0]||(d[0]=(m,f)=>{var P;return(P=a.value)==null?void 0:P.computeChangeStage(m,f)}),onMousedown:m=>{var f;return(f=a.value)==null?void 0:f.stageMouseDown(m,u)},onMouseenter:()=>{var m;return(m=a.value)==null?void 0:m.computeStartHoveringStage(u)},onMouseleave:()=>{var m;return(m=a.value)==null?void 0:m.computeFinishHoveringStage(u)},onKeydown:d[1]||(d[1]=m=>{var f;return(f=a.value)==null?void 0:f.computeKeyDownStage(m)}),onDblclick:()=>{var m;return(m=a.value)==null?void 0:m.computeStartEditingStage(u)},onChangeType:d[2]||(d[2]=m=>{var f;return(f=a.value)==null?void 0:f.computeChangeStageType(m)})},null,8,["gui","workspace","data-id","stage","onMousedown","onMouseenter","onMouseleave","onDblclick"]))),128)),(h(!0),_(V,null,Q(l.value.transitions,u=>(h(),v(Ot,{key:u.id,gui:a.value,"data-type":"transition","data-id":u.id,transition:u,onChange:d[3]||(d[3]=(m,f)=>{var P;return(P=a.value)==null?void 0:P.computeChangeTransition(m,f)}),onMousedown:m=>{var f;return(f=a.value)==null?void 0:f.transitionMouseDown(m,u)},onMouseenter:()=>{var m;return(m=a.value)==null?void 0:m.computeStartHoveringTransition(u)},onMouseleave:()=>{var m;return(m=a.value)==null?void 0:m.computeFinishHoveringTransition(u)},onDblclick:()=>{var m;return(m=a.value)==null?void 0:m.computeStartChangingTransition(u)},onKeydown:d[4]||(d[4]=m=>{var f;return(f=a.value)==null?void 0:f.computeKeyDownTransition(m)})},null,8,["gui","data-id","transition","onMousedown","onMouseenter","onMouseleave","onDblclick"]))),128)),c(Ut,{gui:a.value,onAddTransition:d[5]||(d[5]=()=>{var u;return(u=a.value)==null?void 0:u.computeAddTransition()}),onEditStage:d[6]||(d[6]=()=>{var u;return(u=a.value)==null?void 0:u.computeStartEditingStageSelection()}),onEditTransition:d[7]||(d[7]=()=>{var u;return(u=a.value)==null?void 0:u.computeStartChangingTransitionSelection()}),onRevertTransitions:d[8]||(d[8]=()=>{var u;return(u=a.value)==null?void 0:u.revertTransitions()}),onDuplicateStages:d[9]||(d[9]=()=>{var u;return(u=a.value)==null?void 0:u.duplicateThenSelect()}),onDelete:d[10]||(d[10]=()=>{var u;return(u=a.value)==null?void 0:u.deleteSelection()})},null,8,["gui"])])):E("",!0),a.value&&l.value.stages.length===0?(h(),v(ht,{key:1,gui:a.value},null,8,["gui"])):E("",!0)]))}});const Qt=Y(Bt,[["__scopeId","data-v-f7844f01"]]),Wt={class:"workflow-editor"},Yt={class:"workflow-toolbar"},Jt=["onDragstart"],jt=W({__name:"WorkflowEditor",props:{workflowModel:{},workspaceModel:{}},setup(s){const e=H(null),t=g(()=>{var a;return(a=e.value)==null?void 0:a.gui}),i=(a,l)=>{var r,d;(r=l.dataTransfer)==null||r.setData("type",a),(d=t.value)==null||d.dragstart(a,l)};return(a,l)=>(h(),_("div",Wt,[a.workflowModel?(h(),v(Qt,{key:0,ref_key:"canvasGui",ref:e,model:a.workflowModel,workspace:a.workspaceModel},null,8,["model","workspace"])):E("",!0),x("div",Yt,[(h(!0),_(V,null,Q(o(ae).stages,r=>(h(),v(o(qe),{key:r.typeName,placement:"right"},{title:n(()=>[c(o(F),null,{default:n(()=>[c(o(I),null,{default:n(()=>[S(A(r.title),1)]),_:2},1024),c(o(I),{keyboard:""},{default:n(()=>[S(A(r.key),1)]),_:2},1024)]),_:2},1024)]),content:n(()=>[S(A(r.description),1)]),default:n(()=>[x("span",{draggable:"true",onDragstart:d=>i(r.typeName,d)},[c(je,{class:"toolbar-item",path:r.icon},null,8,["path"])],40,Jt)]),_:2},1024))),128))])]))}});const ys=Y(jt,[["__scopeId","data-v-dce42ec4"]]);export{ys as default};
//# sourceMappingURL=WorkflowEditor.d9700e97.js.map
