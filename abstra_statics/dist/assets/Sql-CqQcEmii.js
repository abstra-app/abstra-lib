import{_ as O}from"./AbstraButton.vue_vue_type_script_setup_true_lang-DANYlrU3.js";import{_ as te}from"./ScrollArea.vue_vue_type_script_setup_true_lang-CBOyC6_e.js";import{r as x,H as se,L as J,z as b,a as ne,ac as ae,a9 as oe,D as re,b as T,e as y,j as l,h as v,w as u,p as I,u as e,U as C,ae as E,b6 as le,M as j,W as F,g as B,v as h,S as R,bC as ie,bj as ue,bB as ce,bp as de,a8 as me,br as W,aN as fe}from"./jwt-decode.esm-CE6d548p.js";import{G as pe}from"./PhClockCounterClockwise.vue-Dqwfxaw1.js";import{I as ye}from"./PhDatabase.vue-8-pojWZ2.js";import{G as ge}from"./PhDownloadSimple.vue-CuaGchT6.js";import{F as _e}from"./PhKey.vue-uPgIs0so.js";import{l as L,e as he}from"./editor.main-R7dy7zcL.js";import{_ as ve}from"./TablesTabs.vue_vue_type_script_setup_true_lang-CShnfomW.js";import{c as Ce,d as be}from"./router-BXGRMzeB.js";import{P as we}from"./project-DEEZLWc5.js";import"./tables-BFyZg84W.js";import{u as qe}from"./useTables-Cuyg7Pbo.js";import{t as Ee}from"./ant-design-BMucGbMa.js";import"./index-DktijNNl.js";import"./ts.worker-CX8FhOYB.js";import"./record-BFEOOAtC.js";import"./string-BXdXBLw0.js";(function(){try{var t=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},n=new Error().stack;n&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[n]="e5e29877-bba6-4c61-b8bf-e7a85b240897",t._sentryDebugIdIdentifier="sentry-dbid-e5e29877-bba6-4c61-b8bf-e7a85b240897")}catch{}})();const G=t=>{if(t==null)return"";const n=String(t);return n.includes(";")||n.includes(`
`)||n.includes('"')?`"${n.replace(/"/g,'""')}"`:n},$e=t=>{let n=t.columns.map(G).join(";")+`
`;t.rows.forEach(d=>{n+=d.map(G).join(";")+`
`});const a=document.createElement("a");a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(n),a.target="_blank",a.download=`${t.fileName}.csv`,a.click()},P=new J(b.array(b.object({projectId:b.string(),lastQuery:b.string()})),"lastQueries"),K=new J(b.array(b.object({id:b.string(),query:b.string(),timestamp:b.number(),projectId:b.string()})),"queryHistory");function ke(t,n){const a=t.toUpperCase(),d=/\b(FROM|JOIN|UPDATE|INTO)\s+\w*$/i.test(a)||/\bDELETE\s+FROM\s+\w*$/i.test(a),s=/\b(SELECT|WHERE|ON|SET|AND|OR|BY)\s+[\w.]*$/i.test(a)||/\w+\.\w*$/.test(t),c=t.match(/(\w+)\.\w*$/),N=c?n.find(S=>S.name.toUpperCase()===c[1].toUpperCase())??null:null,w=/\b(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP|FROM|WHERE|JOIN)\b/.test(a);return{textBeforeCursor:t,isTableContext:d,isColumnContext:s,specificTable:N,hasSqlKeyword:w}}function Te(t,n,a){const d=[];if(t.specificTable)t.specificTable.getColumns().forEach(s=>{d.push({label:s.name,kind:L.CompletionItemKind.Field,insertText:s.name,detail:`${s.type}`,documentation:`Column from ${t.specificTable.name}`,range:a})});else if(t.isTableContext)n.forEach(s=>{d.push({label:s.name,kind:L.CompletionItemKind.Class,insertText:s.name,detail:"Table",documentation:`${s.getColumns().length} columns`,range:a})});else if(t.isColumnContext)n.forEach(s=>{s.getColumns().forEach(c=>{d.push({label:`${s.name}.${c.name}`,kind:L.CompletionItemKind.Field,insertText:`${s.name}.${c.name}`,detail:`${c.type}`,documentation:`${s.name}.${c.name}`,range:a})})});else{if(!t.hasSqlKeyword)return[];n.forEach(s=>{d.push({label:s.name,kind:L.CompletionItemKind.Class,insertText:s.name,detail:"Table",range:a}),s.getColumns().forEach(c=>{d.push({label:`${s.name}.${c.name}`,kind:L.CompletionItemKind.Field,insertText:`${s.name}.${c.name}`,detail:`${c.type}`,range:a})})})}return d}function xe(t,n){const a=x(""),d=x([]),s=x([]),c=x(!1),N=()=>{const i=P.get();if(!i)P.set([{projectId:t,lastQuery:a.value}]);else{const o=i.findIndex(p=>p.projectId===t);o===-1?i.push({projectId:t,lastQuery:a.value}):i[o].lastQuery=a.value,P.set(i)}},w=()=>P.get()?.find(o=>o.projectId===t)?.lastQuery,S=i=>{if(!i.trim())return;const o=K.get()||[],p={id:`${Date.now()}-${Math.random()}`,query:i.trim(),timestamp:Date.now(),projectId:t},g=o.filter(k=>k.projectId===t),_=o.filter(k=>k.projectId!==t),$=[p,...g].slice(0,50);K.set([...$,..._])},D=()=>(K.get()||[]).filter(o=>o.projectId===t).sort((o,p)=>p.timestamp-o.timestamp),z=()=>{const o=(K.get()||[]).filter(p=>p.projectId!==t);K.set(o)},A=async()=>{c.value=!0;const i=await we.executeQuery(t,a.value,[]);if(N(),S(a.value),c.value=!1,!i)return{returns:{result:[],fields:[]},errors:[]};const{returns:o,errors:p}=i;return s.value=o.fields.map(g=>({title:g.name,key:g.name,dataIndex:g.name,ellipsis:!0})),d.value=o.result.map((g,_)=>{const $={key:`${_+1}`};return Object.entries(g).forEach(([k,U])=>{$[k]=U}),$}),{returns:o,errors:p}};let H=null;const M=()=>{!n.value||n.value.length===0||(H&&H.dispose(),H=L.registerCompletionItemProvider("sql",{provideCompletionItems:(i,o)=>{const p=i.getWordUntilPosition(o),g={startLineNumber:o.lineNumber,endLineNumber:o.lineNumber,startColumn:p.startColumn,endColumn:p.endColumn},_=i.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:o.lineNumber,endColumn:o.column}),$=ke(_,n.value);return{suggestions:Te($,n.value,g)}}}))};return se(n,()=>{n.value&&n.value.length>0&&M()},{immediate:!0}),{sql:a,data:d,columns:s,loading:c,runSql:A,getLastQuery:w,setLastQuery:N,getHistory:D,clearHistory:z}}const Se={class:"sql-main-card"},Ie={class:"data-dictionary"},Ne={class:"dictionary-header"},Le=["onClick"],De={class:"column-name"},He={class:"column-type"},Qe={class:"sql-editor-container"},je={key:1,class:"history-list"},Re=["onClick"],Ke={class:"history-query"},Oe={class:"history-timestamp"},Pe=ne({__name:"Sql",setup(t){const n=ae(),a=n.params.projectId,d=x(null);let s=null;const{tables:c,loading:N}=qe(a),{sql:w,data:S,columns:D,loading:z,runSql:A,getLastQuery:H,setLastQuery:M,getHistory:i,clearHistory:o}=xe(a,c),p=x([]),g=x(!1),_=x([]),$=async()=>{const{errors:m}=await A();_.value=i();for(const f of m)W.error({message:E.translate("i18n_sql_execution_failed"),description:f});m.length||W.success({message:E.translate("i18n_sql_execution_succeeded")})},k=()=>{const m=D.value.map(Q=>Q.dataIndex),f=D.value.map(Q=>Q.title),r=S.value.map(Q=>m.map(ee=>Q[ee])),V=`data-${new Date().toISOString()}`;$e({fileName:V,columns:f,rows:r})},U=(m,f)=>{if(!s)return;const r=s.getSelection();if(!r)return;const q=`${m}.${f}`;s.executeEdits("",[{range:r,text:q}]),s.focus()},Y=m=>{s&&(s.setValue(m),w.value=m),g.value=!1},X=()=>{o(),_.value=[]},Z=oe.debounce(M,1e3);return re(()=>{_.value=i(),s=he.create(d.value,{language:"sql",value:w.value,fontFamily:"monospace",lineNumbers:"on",minimap:{enabled:!1},scrollbar:{vertical:"hidden",horizontal:"visible"},fontSize:14,scrollBeyondLastLine:!1,lineHeight:20,suggestOnTriggerCharacters:!0,quickSuggestions:{other:!0,comments:!1,strings:!1}}),s.onDidChangeModelContent(()=>{s&&(w.value=s.getValue(),Z())});const m=n.query.filter;if(m&&typeof m=="string"&&m.trim())w.value=m,s.setValue(m);else{const f=H();f&&(w.value=f,s.setValue(f))}}),(m,f)=>(y(),T(j,null,[l(ve),v("div",Se,[l(e(h),{gap:"middle",style:{width:"100%",height:"100%"}},{default:u(()=>[v("div",Ie,[v("div",Ne,[l(e(ye),{size:16}),v("span",null,C(e(E).translate("i18n_sql_tables")),1)]),e(N)?(y(),I(e(le),{key:0,style:{width:"100%",padding:"20px"}})):(y(),I(e(Ce),{key:1,activeKey:p.value,"onUpdate:activeKey":f[0]||(f[0]=r=>p.value=r),ghost:""},{default:u(()=>[(y(!0),T(j,null,F(e(c),r=>(y(),I(e(be),{key:r.id,header:r.name},{default:u(()=>[(y(!0),T(j,null,F(r.getColumns(),q=>(y(),T("div",{key:q.id,class:"column-item",onClick:V=>U(r.name,q.name)},[q.primaryKey?(y(),I(e(_e),{key:0,size:12,style:{color:"#faad14"}})):B("",!0),v("span",De,C(q.name),1),v("span",He,C(q.type),1)],8,Le))),128))]),_:2},1032,["header"]))),128))]),_:1},8,["activeKey"]))]),l(e(h),{vertical:"",style:{flex:"1"},gap:"middle"},{default:u(()=>[v("div",Qe,[v("div",{ref_key:"sqlEditor",ref:d,class:"sql-editor"},null,512),l(e(h),{justify:"flex-end",class:"bottom-controls",gap:"small",align:"center"},{default:u(()=>[l(e(h),{gap:"small"},{default:u(()=>[l(O,{size:"small",type:"text",onClick:f[1]||(f[1]=r=>g.value=!0)},{default:u(()=>[l(e(h),{gap:"4",align:"center"},{default:u(()=>[l(e(pe),{size:14}),R(" "+C(e(E).translate("i18n_sql_history")),1)]),_:1})]),_:1})]),_:1}),l(e(h),{gap:"small",align:"center"},{default:u(()=>[l(O,{size:"small",type:"primary",loading:e(z),onClick:$},{default:u(()=>[l(e(h),{gap:"4",align:"center"},{default:u(()=>[R(C(e(E).translate("i18n_sql_run"))+" ",1),l(e(ie),{size:12})]),_:1})]),_:1},8,["loading"])]),_:1})]),_:1})]),l(te,{"outer-style":{width:"100%",height:"calc(100% - 220px)"}},{default:u(()=>[l(e(ue),{scroll:{x:100},"data-source":e(S),columns:e(D)},{bodyCell:u(({text:r})=>[typeof r=="object"&&r!==null?(y(),I(e(ce),{key:0,"tree-data":e(Ee)(r),style:{"overflow-x":"scroll"}},null,8,["tree-data"])):(y(),T(j,{key:1},[R(C(r),1)],64))]),_:1},8,["data-source","columns"])]),_:1}),e(S).length?(y(),I(e(h),{key:0,justify:"end"},{default:u(()=>[l(O,{onClick:k},{default:u(()=>[l(e(h),{align:"center",gap:"small"},{default:u(()=>[R(C(e(E).translate("i18n_sql_export_to_csv"))+" ",1),l(e(ge))]),_:1})]),_:1})]),_:1})):B("",!0)]),_:1})]),_:1})]),l(e(me),{open:g.value,"onUpdate:open":f[2]||(f[2]=r=>g.value=r),title:e(E).translate("i18n_sql_query_history"),width:"800px",footer:null},{default:u(()=>[l(e(h),{vertical:"",gap:"middle"},{default:u(()=>[l(e(h),{justify:"end"},{default:u(()=>[l(O,{danger:"",size:"small",onClick:X},{default:u(()=>[R(C(e(E).translate("i18n_sql_clear_history")),1)]),_:1})]),_:1}),_.value.length?(y(),T("div",je,[(y(!0),T(j,null,F(_.value,r=>(y(),T("div",{key:r.id,class:"history-item",onClick:q=>Y(r.query)},[v("div",Ke,C(r.query),1),v("div",Oe,C(new Date(r.timestamp).toLocaleString()),1)],8,Re))),128))])):(y(),I(e(de),{key:0,description:e(E).translate("i18n_sql_no_query_history")},null,8,["description"]))]),_:1})]),_:1},8,["open","title"])],64))}}),ot=fe(Pe,[["__scopeId","data-v-c8d06130"]]);export{ot as default};
//# sourceMappingURL=Sql-CqQcEmii.js.map
