import{k as j,A as se,C as oe}from"./router.09566602.js";import{d as N,at as T,c as V,o as d,ac as f,ae as ne,h as Z,ed as ie,e as A,v as re,r as H,al as D,ep as ce,w as B,a as I,b as _,aY as U,ej as Y,ad as le,t as C,u as c,df as $,g as S,dj as X,_ as K,f as w,i as v,b0 as z,eh as de,d6 as ue,cM as M}from"./jwt-decode.esm.f87c17f7.js";import{B as pe}from"./build.11c6f0e3.js";import{c as ee}from"./string.0c102318.js";import"./tables.1b5568d1.js";import{u as ge}from"./polling.9bc57b91.js";import{t as fe}from"./ant-design.3284f24b.js";import{I as Q}from"./PhCopy.vue.d2b17064.js";import{A as he}from"./index.97648248.js";(function(){try{var l=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(l._sentryDebugIds=l._sentryDebugIds||{},l._sentryDebugIds[e]="778aca4e-032e-4d5d-a65d-223fcef3334f",l._sentryDebugIdIdentifier="sentry-dbid-778aca4e-032e-4d5d-a65d-223fcef3334f")}catch{}})();const me=["width","height","fill","transform"],ye={key:0},_e=A("path",{d:"M72,104a16,16,0,1,1,16,16A16,16,0,0,1,72,104Zm96,16a16,16,0,1,0-16-16A16,16,0,0,0,168,120Zm68-40V192a36,36,0,0,1-36,36H56a36,36,0,0,1-36-36V80A36,36,0,0,1,56,44h60V16a12,12,0,0,1,24,0V44h60A36,36,0,0,1,236,80Zm-24,0a12,12,0,0,0-12-12H56A12,12,0,0,0,44,80V192a12,12,0,0,0,12,12H200a12,12,0,0,0,12-12Zm-12,82a30,30,0,0,1-30,30H86a30,30,0,0,1,0-60h84A30,30,0,0,1,200,162Zm-80-6v12h16V156ZM86,168H96V156H86a6,6,0,0,0,0,12Zm90-6a6,6,0,0,0-6-6H160v12h10A6,6,0,0,0,176,162Z"},null,-1),xe=[_e],ve={key:1},we=A("path",{d:"M200,56H56A24,24,0,0,0,32,80V192a24,24,0,0,0,24,24H200a24,24,0,0,0,24-24V80A24,24,0,0,0,200,56ZM164,184H92a20,20,0,0,1,0-40h72a20,20,0,0,1,0,40Z",opacity:"0.2"},null,-1),be=A("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Zm4,28H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24Z"},null,-1),Ae=[we,be],ke={key:2},He=A("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48ZM172,96a12,12,0,1,1-12,12A12,12,0,0,1,172,96ZM96,184H80a16,16,0,0,1,0-32H96ZM84,120a12,12,0,1,1,12-12A12,12,0,0,1,84,120Zm60,64H112V152h32Zm32,0H160V152h16a16,16,0,0,1,0,32Z"},null,-1),Ze=[He],Ie={key:3},Ve=A("path",{d:"M200,50H134V16a6,6,0,0,0-12,0V50H56A30,30,0,0,0,26,80V192a30,30,0,0,0,30,30H200a30,30,0,0,0,30-30V80A30,30,0,0,0,200,50Zm18,142a18,18,0,0,1-18,18H56a18,18,0,0,1-18-18V80A18,18,0,0,1,56,62H200a18,18,0,0,1,18,18ZM74,108a10,10,0,1,1,10,10A10,10,0,0,1,74,108Zm88,0a10,10,0,1,1,10,10A10,10,0,0,1,162,108Zm2,30H92a26,26,0,0,0,0,52h72a26,26,0,0,0,0-52Zm-22,12v28H114V150ZM78,164a14,14,0,0,1,14-14h10v28H92A14,14,0,0,1,78,164Zm86,14H154V150h10a14,14,0,0,1,0,28Z"},null,-1),Ce=[Ve],Se={key:4},Ee=A("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16Zm-52-56H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Z"},null,-1),je=[Ee],Te={key:5},De=A("path",{d:"M200,52H132V16a4,4,0,0,0-8,0V52H56A28,28,0,0,0,28,80V192a28,28,0,0,0,28,28H200a28,28,0,0,0,28-28V80A28,28,0,0,0,200,52Zm20,140a20,20,0,0,1-20,20H56a20,20,0,0,1-20-20V80A20,20,0,0,1,56,60H200a20,20,0,0,1,20,20ZM76,108a8,8,0,1,1,8,8A8,8,0,0,1,76,108Zm88,0a8,8,0,1,1,8,8A8,8,0,0,1,164,108Zm0,32H92a24,24,0,0,0,0,48h72a24,24,0,0,0,0-48Zm-20,8v32H112V148ZM76,164a16,16,0,0,1,16-16h12v32H92A16,16,0,0,1,76,164Zm88,16H152V148h12a16,16,0,0,1,0,32Z"},null,-1),Me=[De],$e={name:"PhRobot"},Re=N({...$e,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(l){const e=l,a=T("weight","regular"),o=T("size","1em"),h=T("color","currentColor"),r=T("mirrored",!1),i=V(()=>{var u;return(u=e.weight)!=null?u:a}),n=V(()=>{var u;return(u=e.size)!=null?u:o}),m=V(()=>{var u;return(u=e.color)!=null?u:h}),t=V(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:r?"scale(-1, 1)":void 0);return(u,k)=>(d(),f("svg",ie({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:n.value,height:n.value,fill:m.value,transform:t.value},u.$attrs),[ne(u.$slots,"default"),i.value==="bold"?(d(),f("g",ye,xe)):i.value==="duotone"?(d(),f("g",ve,Ae)):i.value==="fill"?(d(),f("g",ke,Ze)):i.value==="light"?(d(),f("g",Ie,Ce)):i.value==="regular"?(d(),f("g",Se,je)):i.value==="thin"?(d(),f("g",Te,Me)):Z("",!0)],16,me))}}),Oe=["running","lock-failed","failed","finished","abandoned"];class R{constructor(e){this.dto=e}static from(e){return new R(e)}get entries(){return this.dto.sort((e,a)=>e.sequence-a.sequence).filter(e=>e.event!=="form-message")}}class O{constructor(e){this.dto=e}static from(e){return new O(e)}get id(){return this.dto.id}get shortId(){return this.dto.id.slice(0,8)}get createdAt(){return new Date(this.dto.createdAt)}get updatedAt(){return new Date(this.dto.updatedAt)}get status(){return this.dto.status}get context(){return this.dto.context}get buildId(){var e;return(e=this.dto.buildId)!=null?e:""}get stageId(){return this.dto.stageId}get duration_seconds(){return this.status==="running"?"-":`${(this.updatedAt.getTime()-this.createdAt.getTime())/1e3} s`}get stageRunId(){return this.dto.stageRunId}get projectId(){return this.dto.projectId}}class at{async list({projectId:e,...a}){var r,i;const o={...a,offset:(r=a.offset)==null?void 0:r.toString(),limit:(i=a.limit)==null?void 0:i.toString()};Object.keys(o).forEach(n=>o[n]===void 0&&delete o[n]);const h=await j.get(`projects/${e}/executions`,o);return{executions:h.executions.map(n=>O.from(n)),totalCount:h.totalCount}}async fetchLogs(e,a){const o=await j.get(`projects/${e}/executions/${a}/logs`);return R.from(o)}async fetchThreadData(e,a){return(await j.get(`projects/${e}/executions/${a}/thread-data`)).response}async getExecutionTasks(e,a){return await j.get(`projects/${e}/executions/${a}/tasks`)}async fetchStages(){throw new Error("Method not implemented.")}}class st{async list(e){var n,m;const a={...e,offset:(n=e.offset)==null?void 0:n.toString(),limit:(m=e.limit)==null?void 0:m.toString()};Object.keys(a).forEach(t=>a[t]===void 0&&delete a[t]);const o=Object.fromEntries(Object.entries(a!=null?a:{}).filter(([,t])=>t!=null)),h=Object.keys(o).length>0?`?${new URLSearchParams(o).toString()}`:"",i=await(await fetch(`/_editor/api/executions${h}`)).json();return{executions:i.executions.map(t=>O.from(t)),totalCount:i.totalCount}}async fetchLogs(e,a){const h=await(await fetch(`/_editor/api/logs/${a}`)).json();return R.from(h)}async fetchThreadData(){return{}}async getExecutionTasks(e,a){return await(await fetch(`/_editor/api/executions/${a}/tasks`)).json()}async fetchStages(){return await(await fetch("/_editor/api/executions/stages")).json()}}const ot=re("logs",()=>{const l=H(null),e=H(null),a=H(""),o=H(!1),h=H(),r=D({openedExecutionIds:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],executionData:{}}),i=D({currentIndex:1,pageSize:10,totalCount:0}),n=D({dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0}),m=D({builds:[],stages:[],statuses:Oe.map(s=>({label:ee(s),value:s}))}),t=ge({task:()=>W(),interval:1e4}),u=async s=>{var p;l.value=s.executionRepository,e.value=s.buildRepository,a.value=s.projectId,o.value=(p=s.pool)!=null?p:!1,h.value=s.onFilterChange,Object.assign(n,s.filters||{}),Object.assign(i,s.pagination||{}),s.openedExecutionId&&(r.openedExecutionIds=[s.openedExecutionId]),await Promise.all([b(),F()]),q(),o.value&&t.startPolling()},k=()=>{t.endPolling()},b=async()=>{var y,g,x;if(!l.value)return;r.loadingExecutions=!0;const{executions:s,totalCount:p}=await l.value.list({projectId:a.value,buildId:n.buildId,status:n.status,limit:i.pageSize,offset:(i.currentIndex-1)*i.pageSize,stageId:n.stageId,startDate:(g=(y=n.dateRange)==null?void 0:y[0])==null?void 0:g.toISOString().slice(0,10),endDate:(x=n.dateRange)==null?void 0:x[1].add(1,"day").toISOString().slice(0,10),search:n.search});r.loadingExecutions=!1,r.executions=s,i.totalCount=p},E=async()=>{if(!e.value)return;const p=(await e.value.list(a.value)).map(y=>({label:`[${y.id.slice(0,8)}] ${y.createdAt.toLocaleString()} ${y.latest?"(Latest)":""}`,value:y.id}));m.builds=p},P=async()=>{var y;if(!l.value)return;if(!e.value){const x=(await l.value.fetchStages()).map(J=>({label:J.title,value:J.id}));m.stages=x!=null?x:[];return}const s=await pe.get((y=n.buildId)!=null?y:m.builds[0].value),p=s==null?void 0:s.runtimes.map(g=>({label:g.title,value:g.id}));m.stages=p!=null?p:[]},F=async()=>{await E(),await P()},L=async s=>{if(!l.value)return;const[p,y,g]=await Promise.all([l.value.fetchLogs(a.value,s),l.value.fetchThreadData(a.value,s),l.value.getExecutionTasks(a.value,s)]);r.executionData[s]={logs:p,threadData:y,tasks:{triggerTask:g.triggerTask?{type:g.triggerTask.type,payload:g.triggerTask.payload}:null,sentTasks:g.sentTasks.map(x=>({type:x.type,payload:x.payload}))}}},q=()=>{r.openedExecutionIds.forEach(async s=>{r.executionData[s]||await L(s)})},W=async()=>{r.openedExecutionIds.map(s=>L(s))},G=()=>{r.waitingDebounce=!0,i.currentIndex=1,te(),h.value&&h.value(n)},te=ce.exports.debounce(async()=>{await b(),r.waitingDebounce=!1},500),ae=async s=>{let p=r.executions;return s&&(p=p.filter(g=>g.stageId===s)),p.length===0?null:p.reduce((g,x)=>g.createdAt>x.createdAt?g:x).id};return B(()=>n.buildId,()=>{P()}),B(n,()=>{r.openedExecutionIds=[],G()}),B(i,()=>{r.openedExecutionIds=[],b()}),{state:V(()=>({currentPage:r,pagination:i,filters:n,filterOptions:m})),currentPage:r,pagination:i,filters:n,filterOptions:m,init:u,teardown:k,fetchPage:b,fetchBuildOptions:E,fetchStageOptions:P,fetchOptions:F,fetchExecutionDetails:L,fetchEmptyLogs:q,refetch:W,handleFilterChange:G,getNewestExecutionId:ae,polling:t}}),Pe={key:0,class:"cli"},Le={key:0},Be=N({__name:"LogContainer",props:{logs:{}},setup(l){return(e,a)=>(d(),I(c(X),{vertical:"",gap:"small"},{default:_(()=>[e.logs.entries.length?(d(),f("div",Pe,[(d(!0),f(U,null,Y(e.logs.entries,o=>(d(),f("p",{key:o.createdAt,style:le({margin:0,"white-space":"pre-wrap",color:o.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},[o.payload.text?(d(),f("span",Le,C(o.payload.text.trim()),1)):Z("",!0)],4))),128))])):(d(),I(c($),{key:1,type:"secondary"},{default:_(()=>[S("Empty")]),_:1}))]),_:1}))}});const nt=K(Be,[["__scopeId","data-v-b7f04a41"]]),ze={key:0},Ne=["onClick"],Fe=["onClick"],qe=N({__name:"ExecutionContext",props:{data:{},showFixWithAi:{type:Boolean},isSmartChatIdle:{type:Boolean}},emits:["ask-ai"],setup(l,{emit:e}){const a=l,o=H(!1),h=t=>{if(t==="legacyThreadData")return v.translate("i18n_executioncontext_thread_data");const u=ee(t);return u.replace(/([A-Z])/g," $1").trim(),u},r=t=>t==null?!0:Array.isArray(t)?t.length===0:typeof t=="object"?Object.keys(t).length===0:!1,i=t=>{typeof t=="object"&&t!==null&&"payload"in t?(navigator.clipboard.writeText(JSON.stringify(t.payload)),M.success({content:v.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),M.error({content:v.translate("i18n_executioncontext_no_payload")}))},n=t=>{o.value=!0,t.stopPropagation(),a.isSmartChatIdle!==!1&&(e("ask-ai"),setTimeout(()=>{o.value=!1},1e3))},m=t=>{typeof t=="object"?(navigator.clipboard.writeText(JSON.stringify(t)),M.success({content:v.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),M.error({content:v.translate("i18n_executioncontext_failed_copy_request")}))};return(t,u)=>(d(),I(c(oe),{bordered:!1,style:{"background-color":"transparent",width:"100%"}},{default:_(()=>[w(c(se),{key:"execution-context"},{header:_(()=>[w(c(X),{justify:"space-between"},{default:_(()=>[w(c($),null,{default:_(()=>[S(C(c(v).translate("i18n_executioncontext_header")),1)]),_:1}),w(c(z),{title:t.isSmartChatIdle?"":c(v).translate("i18n_executioncontext_wait_or_stop"),placement:"left"},{default:_(()=>[t.showFixWithAi?(d(),f("div",{key:0,class:de(["ask-to-ai",{disabled:!t.isSmartChatIdle||o.value}]),onClick:n},[S(C(c(v).translate("i18n_executioncontext_fix_with_ai"))+" ",1),w(c(Re),{size:16})],2)):Z("",!0)]),_:1},8,["title"])]),_:1})]),default:_(()=>[w(c(he),{direction:"vertical",style:{"border-radius":"5px",padding:"10px",color:"#fff",width:"100%","font-family":"monospace","max-height":"600px",overflow:"auto",border:"1px solid #e8e8e8"}},{default:_(()=>[Object.keys(t.data).length?(d(!0),f(U,{key:1},Y(Object.entries(t.data),([k,b])=>(d(),f("div",{key:k,class:"tree"},[k!=="legacyThreadData"||!r(b)?(d(),f("div",ze,[w(c($),{strong:""},{default:_(()=>[S(C(h(k)),1)]),_:2},1024),k==="request"?(d(),I(c(z),{key:0,title:c(v).translate("i18n_executioncontext_copy_request_tooltip")},{default:_(()=>[A("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:E=>m(b)},[w(c(Q))],8,Ne)]),_:2},1032,["title"])):Z("",!0),k==="triggerTask"?(d(),I(c(z),{key:1,title:c(v).translate("i18n_executioncontext_copy_payload_tooltip")},{default:_(()=>[A("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:E=>i(b)},[w(c(Q))],8,Fe)]),_:2},1032,["title"])):Z("",!0),w(c(ue),{"tree-data":c(fe)(b),selectable:!1},null,8,["tree-data"])])):Z("",!0)]))),128)):(d(),I(c($),{key:0,type:"secondary"},{default:_(()=>[S(C(c(v).translate("i18n_executioncontext_empty")),1)]),_:1}))]),_:1})]),_:1})]),_:1}))}});const it=K(qe,[["__scopeId","data-v-f7630ec7"]]);export{it as E,nt as L,at as R,st as a,ot as u};
//# sourceMappingURL=ExecutionContext.2933148d.js.map
