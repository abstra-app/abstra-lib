import{k as T,A as se,C as oe}from"./router.15a12e65.js";import{d as N,at as D,c as S,o as d,ac as h,ae as ne,h as I,ew as ie,e as A,v as re,r as Z,al as M,eH as ce,w as B,a as V,b as x,aY as U,eB as Y,ad as le,t as E,u as l,df as R,g as j,dj as X,_ as K,f as b,i as v,b0 as z,ez as de,d6 as ue,cM as $}from"./jwt-decode.esm.3f85b5bd.js";import{B as pe}from"./build.2edec66a.js";import{c as ee}from"./string.9fda8d6f.js";import"./tables.42ba584a.js";import{u as ge}from"./polling.1032826b.js";import{t as fe}from"./ant-design.cfc322f7.js";import{I as Q}from"./PhCopy.vue.73164451.js";import{b as he}from"./index.c0e60a0a.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[e]="fe839dcb-78b4-49a4-8fa4-4fe23da20447",o._sentryDebugIdIdentifier="sentry-dbid-fe839dcb-78b4-49a4-8fa4-4fe23da20447")}catch{}})();const me=["width","height","fill","transform"],ye={key:0},xe=A("path",{d:"M72,104a16,16,0,1,1,16,16A16,16,0,0,1,72,104Zm96,16a16,16,0,1,0-16-16A16,16,0,0,0,168,120Zm68-40V192a36,36,0,0,1-36,36H56a36,36,0,0,1-36-36V80A36,36,0,0,1,56,44h60V16a12,12,0,0,1,24,0V44h60A36,36,0,0,1,236,80Zm-24,0a12,12,0,0,0-12-12H56A12,12,0,0,0,44,80V192a12,12,0,0,0,12,12H200a12,12,0,0,0,12-12Zm-12,82a30,30,0,0,1-30,30H86a30,30,0,0,1,0-60h84A30,30,0,0,1,200,162Zm-80-6v12h16V156ZM86,168H96V156H86a6,6,0,0,0,0,12Zm90-6a6,6,0,0,0-6-6H160v12h10A6,6,0,0,0,176,162Z"},null,-1),_e=[xe],ve={key:1},we=A("path",{d:"M200,56H56A24,24,0,0,0,32,80V192a24,24,0,0,0,24,24H200a24,24,0,0,0,24-24V80A24,24,0,0,0,200,56ZM164,184H92a20,20,0,0,1,0-40h72a20,20,0,0,1,0,40Z",opacity:"0.2"},null,-1),be=A("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Zm4,28H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24Z"},null,-1),Ae=[we,be],He={key:2},ke=A("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48ZM172,96a12,12,0,1,1-12,12A12,12,0,0,1,172,96ZM96,184H80a16,16,0,0,1,0-32H96ZM84,120a12,12,0,1,1,12-12A12,12,0,0,1,84,120Zm60,64H112V152h32Zm32,0H160V152h16a16,16,0,0,1,0,32Z"},null,-1),Ze=[ke],Ie={key:3},Ve=A("path",{d:"M200,50H134V16a6,6,0,0,0-12,0V50H56A30,30,0,0,0,26,80V192a30,30,0,0,0,30,30H200a30,30,0,0,0,30-30V80A30,30,0,0,0,200,50Zm18,142a18,18,0,0,1-18,18H56a18,18,0,0,1-18-18V80A18,18,0,0,1,56,62H200a18,18,0,0,1,18,18ZM74,108a10,10,0,1,1,10,10A10,10,0,0,1,74,108Zm88,0a10,10,0,1,1,10,10A10,10,0,0,1,162,108Zm2,30H92a26,26,0,0,0,0,52h72a26,26,0,0,0,0-52Zm-22,12v28H114V150ZM78,164a14,14,0,0,1,14-14h10v28H92A14,14,0,0,1,78,164Zm86,14H154V150h10a14,14,0,0,1,0,28Z"},null,-1),Ce=[Ve],Se={key:4},Ee=A("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16Zm-52-56H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Z"},null,-1),je=[Ee],Te={key:5},De=A("path",{d:"M200,52H132V16a4,4,0,0,0-8,0V52H56A28,28,0,0,0,28,80V192a28,28,0,0,0,28,28H200a28,28,0,0,0,28-28V80A28,28,0,0,0,200,52Zm20,140a20,20,0,0,1-20,20H56a20,20,0,0,1-20-20V80A20,20,0,0,1,56,60H200a20,20,0,0,1,20,20ZM76,108a8,8,0,1,1,8,8A8,8,0,0,1,76,108Zm88,0a8,8,0,1,1,8,8A8,8,0,0,1,164,108Zm0,32H92a24,24,0,0,0,0,48h72a24,24,0,0,0,0-48Zm-20,8v32H112V148ZM76,164a16,16,0,0,1,16-16h12v32H92A16,16,0,0,1,76,164Zm88,16H152V148h12a16,16,0,0,1,0,32Z"},null,-1),Me=[De],$e={name:"PhRobot"},Re=N({...$e,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(o){const e=o,t=D("weight","regular"),i=D("size","1em"),p=D("color","currentColor"),c=D("mirrored",!1),r=S(()=>{var a;return(a=e.weight)!=null?a:t}),n=S(()=>{var a;return(a=e.size)!=null?a:i}),m=S(()=>{var a;return(a=e.color)!=null?a:p}),f=S(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:c?"scale(-1, 1)":void 0);return(a,k)=>(d(),h("svg",ie({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:n.value,height:n.value,fill:m.value,transform:f.value},a.$attrs),[ne(a.$slots,"default"),r.value==="bold"?(d(),h("g",ye,_e)):r.value==="duotone"?(d(),h("g",ve,Ae)):r.value==="fill"?(d(),h("g",He,Ze)):r.value==="light"?(d(),h("g",Ie,Ce)):r.value==="regular"?(d(),h("g",Se,je)):r.value==="thin"?(d(),h("g",Te,Me)):I("",!0)],16,me))}}),Oe=["running","lock-failed","failed","finished","abandoned"];class O{constructor(e){this.dto=e}static from(e){return new O(e)}get entries(){return this.dto.sort((e,t)=>e.sequence-t.sequence).filter(e=>e.event!=="form-message")}}class P{constructor(e){this.dto=e}static from(e){return new P(e)}get id(){return this.dto.id}get shortId(){return this.dto.id.slice(0,8)}get createdAt(){return new Date(this.dto.createdAt)}get updatedAt(){return new Date(this.dto.updatedAt)}get status(){return this.dto.status}get context(){return this.dto.context}get buildId(){var e;return(e=this.dto.buildId)!=null?e:""}get stageId(){return this.dto.stageId}get duration_seconds(){return this.status==="running"?"-":`${(this.updatedAt.getTime()-this.createdAt.getTime())/1e3} s`}get stageRunId(){return this.dto.stageRunId}get projectId(){return this.dto.projectId}}class at{async list({projectId:e,...t}){var c,r;const i={...t,offset:(c=t.offset)==null?void 0:c.toString(),limit:(r=t.limit)==null?void 0:r.toString()};Object.keys(i).forEach(n=>i[n]===void 0&&delete i[n]);const p=await T.get(`projects/${e}/executions`,i);return{executions:p.executions.map(n=>P.from(n)),totalCount:p.totalCount}}async fetchLogs(e,t){const i=await T.get(`projects/${e}/executions/${t}/logs`);return O.from(i)}async fetchThreadData(e,t){return(await T.get(`projects/${e}/executions/${t}/thread-data`)).response}async getExecutionTasks(e,t){return await T.get(`projects/${e}/executions/${t}/tasks`)}async fetchStages(){throw new Error("Method not implemented.")}}class st{async list(e){var n,m;const t={...e,offset:(n=e.offset)==null?void 0:n.toString(),limit:(m=e.limit)==null?void 0:m.toString()};Object.keys(t).forEach(f=>t[f]===void 0&&delete t[f]);const i=Object.fromEntries(Object.entries(t!=null?t:{}).filter(([,f])=>f!=null)),p=Object.keys(i).length>0?`?${new URLSearchParams(i).toString()}`:"",r=await(await fetch(`/_editor/api/executions${p}`)).json();return{executions:r.executions.map(f=>P.from(f)),totalCount:r.totalCount}}async fetchLogs(e,t){const p=await(await fetch(`/_editor/api/logs/${t}`)).json();return O.from(p)}async fetchThreadData(){return{}}async getExecutionTasks(e,t){return await(await fetch(`/_editor/api/executions/${t}/tasks`)).json()}async fetchStages(){return await(await fetch("/_editor/api/executions/stages")).json()}}const ot=re("logs",()=>{const o=Z(null),e=Z(null),t=Z(""),i=Z(!1),p=Z(),c=M({openedExecutionIds:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],executionData:{}}),r=M({currentIndex:1,pageSize:10,totalCount:0}),n=M({dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0}),m=M({builds:[],stages:[],statuses:Oe.map(s=>({label:ee(s),value:s}))}),f=ge({task:()=>W(),interval:1e4}),a=async s=>{var u;o.value=s.executionRepository,e.value=s.buildRepository,t.value=s.projectId,i.value=(u=s.pool)!=null?u:!1,p.value=s.onFilterChange,Object.assign(n,s.filters||{}),Object.assign(r,s.pagination||{}),s.openedExecutionId&&(c.openedExecutionIds=[s.openedExecutionId]),await Promise.all([w(),F()]),q(),i.value&&f.startPolling()},k=()=>{f.endPolling()},w=async()=>{var y,g,_;if(!o.value)return;c.loadingExecutions=!0;const{executions:s,totalCount:u}=await o.value.list({projectId:t.value,buildId:n.buildId,status:n.status,limit:r.pageSize,offset:(r.currentIndex-1)*r.pageSize,stageId:n.stageId,startDate:(g=(y=n.dateRange)==null?void 0:y[0])==null?void 0:g.toISOString().slice(0,10),endDate:(_=n.dateRange)==null?void 0:_[1].add(1,"day").toISOString().slice(0,10),search:n.search});c.loadingExecutions=!1,c.executions=s,r.totalCount=u},H=async()=>{if(!e.value)return;const u=(await e.value.list(t.value)).map(y=>({label:`[${y.id.slice(0,8)}] ${y.createdAt.toLocaleString()} ${y.latest?"(Latest)":""}`,value:y.id}));m.builds=u},C=async()=>{var y;if(!o.value)return;if(!e.value){const _=(await o.value.fetchStages()).map(J=>({label:J.title,value:J.id}));m.stages=_!=null?_:[];return}const s=await pe.get((y=n.buildId)!=null?y:m.builds[0].value),u=s==null?void 0:s.runtimes.map(g=>({label:g.title,value:g.id}));m.stages=u!=null?u:[]},F=async()=>{await H(),await C()},L=async s=>{if(!o.value)return;const[u,y,g]=await Promise.all([o.value.fetchLogs(t.value,s),o.value.fetchThreadData(t.value,s),o.value.getExecutionTasks(t.value,s)]);c.executionData[s]={logs:u,threadData:y,tasks:{triggerTask:g.triggerTask?{type:g.triggerTask.type,payload:g.triggerTask.payload}:null,sentTasks:g.sentTasks.map(_=>({type:_.type,payload:_.payload}))}}},q=()=>{c.openedExecutionIds.forEach(async s=>{c.executionData[s]||await L(s)})},W=async()=>{c.openedExecutionIds.map(s=>L(s))},G=()=>{c.waitingDebounce=!0,r.currentIndex=1,te(),p.value&&p.value(n)},te=ce.exports.debounce(async()=>{await w(),c.waitingDebounce=!1},500),ae=async s=>{let u=c.executions;return s&&(u=u.filter(g=>g.stageId===s)),u.length===0?null:u.reduce((g,_)=>g.createdAt>_.createdAt?g:_).id};return B(()=>n.buildId,()=>{C()}),B(n,()=>{c.openedExecutionIds=[],G()}),B(r,()=>{c.openedExecutionIds=[],w()}),{state:S(()=>({currentPage:c,pagination:r,filters:n,filterOptions:m})),currentPage:c,pagination:r,filters:n,filterOptions:m,init:a,teardown:k,fetchPage:w,fetchBuildOptions:H,fetchStageOptions:C,fetchOptions:F,fetchExecutionDetails:L,fetchEmptyLogs:q,refetch:W,handleFilterChange:G,getNewestExecutionId:ae,polling:f}}),Pe={key:0,class:"cli"},Le={key:0},Be=N({__name:"LogContainer",props:{logs:{}},setup(o){return(e,t)=>(d(),V(l(X),{vertical:"",gap:"small"},{default:x(()=>[o.logs.entries.length?(d(),h("div",Pe,[(d(!0),h(U,null,Y(o.logs.entries,i=>(d(),h("p",{key:i.createdAt,style:le({margin:0,"white-space":"pre-wrap",color:i.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},[i.payload.text?(d(),h("span",Le,E(i.payload.text.trim()),1)):I("",!0)],4))),128))])):(d(),V(l(R),{key:1,type:"secondary"},{default:x(()=>[...t[0]||(t[0]=[j("Empty",-1)])]),_:1}))]),_:1}))}});const nt=K(Be,[["__scopeId","data-v-b7f04a41"]]),ze={key:0},Ne=["onClick"],Fe=["onClick"],qe=N({__name:"ExecutionContext",props:{data:{},showFixWithAi:{type:Boolean},isSmartChatIdle:{type:Boolean}},emits:["ask-ai"],setup(o,{emit:e}){const t=o,i=e,p=Z(!1),c=a=>{if(a==="legacyThreadData")return v.translate("i18n_executioncontext_thread_data");const k=ee(a);return k.replace(/([A-Z])/g," $1").trim(),k},r=a=>a==null?!0:Array.isArray(a)?a.length===0:typeof a=="object"?Object.keys(a).length===0:!1,n=a=>{typeof a=="object"&&a!==null&&"payload"in a?(navigator.clipboard.writeText(JSON.stringify(a.payload)),$.success({content:v.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),$.error({content:v.translate("i18n_executioncontext_no_payload")}))},m=a=>{p.value=!0,a.stopPropagation(),t.isSmartChatIdle!==!1&&(i("ask-ai"),setTimeout(()=>{p.value=!1},1e3))},f=a=>{typeof a=="object"?(navigator.clipboard.writeText(JSON.stringify(a)),$.success({content:v.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),$.error({content:v.translate("i18n_executioncontext_failed_copy_request")}))};return(a,k)=>(d(),V(l(oe),{bordered:!1,style:{"background-color":"transparent",width:"100%"}},{default:x(()=>[b(l(se),{key:"execution-context"},{header:x(()=>[b(l(X),{justify:"space-between"},{default:x(()=>[b(l(R),null,{default:x(()=>[j(E(l(v).translate("i18n_executioncontext_header")),1)]),_:1}),b(l(z),{title:o.isSmartChatIdle?"":l(v).translate("i18n_executioncontext_wait_or_stop"),placement:"left"},{default:x(()=>[o.showFixWithAi?(d(),h("div",{key:0,class:de(["ask-to-ai",{disabled:!o.isSmartChatIdle||p.value}]),onClick:m},[j(E(l(v).translate("i18n_executioncontext_fix_with_ai"))+" ",1),b(l(Re),{size:16})],2)):I("",!0)]),_:1},8,["title"])]),_:1})]),default:x(()=>[b(l(he),{direction:"vertical",style:{"border-radius":"5px",padding:"10px",color:"#fff",width:"100%","font-family":"monospace","max-height":"600px",overflow:"auto",border:"1px solid #e8e8e8"}},{default:x(()=>[Object.keys(o.data).length?(d(!0),h(U,{key:1},Y(Object.entries(o.data),([w,H])=>(d(),h("div",{key:w,class:"tree"},[w!=="legacyThreadData"||!r(H)?(d(),h("div",ze,[b(l(R),{strong:""},{default:x(()=>[j(E(c(w)),1)]),_:2},1024),w==="request"?(d(),V(l(z),{key:0,title:l(v).translate("i18n_executioncontext_copy_request_tooltip")},{default:x(()=>[A("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:C=>f(H)},[b(l(Q))],8,Ne)]),_:2},1032,["title"])):I("",!0),w==="triggerTask"?(d(),V(l(z),{key:1,title:l(v).translate("i18n_executioncontext_copy_payload_tooltip")},{default:x(()=>[A("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:C=>n(H)},[b(l(Q))],8,Fe)]),_:2},1032,["title"])):I("",!0),b(l(ue),{"tree-data":l(fe)(H),selectable:!1},null,8,["tree-data"])])):I("",!0)]))),128)):(d(),V(l(R),{key:0,type:"secondary"},{default:x(()=>[j(E(l(v).translate("i18n_executioncontext_empty")),1)]),_:1}))]),_:1})]),_:1})]),_:1}))}});const it=K(qe,[["__scopeId","data-v-f7630ec7"]]);export{it as E,nt as L,at as R,st as a,ot as u};
//# sourceMappingURL=ExecutionContext.5ba8d44c.js.map
