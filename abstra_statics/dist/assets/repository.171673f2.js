import{f as o,eG as at,r as nt,H,F as mt,d as D,b as i,ev as S,w as s,aD as P,eC as x,eD as w,u as t,v as G,c as d,ar as m,cM as _t,cE as T,ex as A,bg as ht,eJ as st,e as z,eI as V,aH as rt,cm as ot,eE as vt,eF as bt,eP as St,a as kt,cD as lt,ae as it,bG as Q,eA as wt,o as At,L as Rt,dm as Ct}from"./outputWidgets.8380e627.js";import{a as ut}from"./asyncComputed.6f6ec7a1.js";import"./workspaces.ec997847.js";import{S as It}from"./scripts.1e906e38.js";import"./envVars.2289e5a1.js";import{A as Ot,s as ct}from"./api.d5d0a63b.js";import{A as Dt}from"./contracts.generated.1c2d77b6.js";import{A as R}from"./index.92b0be86.js";import{q as $t,r as Pt}from"./icons.ad30c4b8.js";import{t as xt}from"./ant-design.a4f5c356.js";import{A as B}from"./Text.0a0536af.js";import"./index.80a03410.js";import{A as K}from"./index.1fce0e2a.js";import{f as Ft}from"./index.9be56d78.js";import{A as X}from"./Paragraph.7f55a5be.js";import{A as q}from"./Title.78dbba38.js";import"./index.e03eb56e.js";import{T as Et,A as Tt}from"./Timeline.dbe9c162.js";import{A as dt,C as pt}from"./CollapsePanel.d13a37d0.js";import{A as Ut}from"./Link.d6199d5e.js";import{A as gt}from"./index.fce20ba2.js";import{A as Lt}from"./index.1cc39dcd.js";import{E as Nt}from"./ExpandOutlined.1ab9a1a8.js";import{C as jt}from"./Card.d9693c9e.js";import{D as qt}from"./DownOutlined.0197fde7.js";import"./index.57db928f.js";import{F as zt,A as Bt}from"./Form.a2be0836.js";(function(){try{var n=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[e]="01ad7dc5-1d6f-416a-bd89-86d48a0f7978",n._sentryDebugIdIdentifier="sentry-dbid-01ad7dc5-1d6f-416a-bd89-86d48a0f7978")}catch{}})();var Vt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM641.7 520.8L442.3 677.6c-7.4 5.8-18.3.6-18.3-8.8V355.3c0-9.4 10.9-14.7 18.3-8.8l199.4 156.7a11.2 11.2 0 010 17.6z"}}]},name:"play-square",theme:"filled"};const Ht=Vt;var Kt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M168 504.2c1-43.7 10-86.1 26.9-126 17.3-41 42.1-77.7 73.7-109.4S337 212.3 378 195c42.4-17.9 87.4-27 133.9-27s91.5 9.1 133.8 27A341.5 341.5 0 01755 268.8c9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47a8 8 0 003 14.1l175.7 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c0-6.7-7.7-10.5-12.9-6.3l-56.4 44.1C765.8 155.1 646.2 92 511.8 92 282.7 92 96.3 275.6 92 503.8a8 8 0 008 8.2h60c4.4 0 7.9-3.5 8-7.8zm756 7.8h-60c-4.4 0-7.9 3.5-8 7.8-1 43.7-10 86.1-26.9 126-17.3 41-42.1 77.8-73.7 109.4A342.45 342.45 0 01512.1 856a342.24 342.24 0 01-243.2-100.8c-9.9-9.9-19.2-20.4-27.8-31.4l60.2-47a8 8 0 00-3-14.1l-175.7-43c-5-1.2-9.9 2.6-9.9 7.7l-.7 181c0 6.7 7.7 10.5 12.9 6.3l56.4-44.1C258.2 868.9 377.8 932 512.2 932c229.2 0 415.5-183.7 419.8-411.8a8 8 0 00-8-8.2z"}}]},name:"sync",theme:"outlined"};const Mt=Kt;function tt(n){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?Object(arguments[e]):{},l=Object.keys(r);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(r).filter(function(a){return Object.getOwnPropertyDescriptor(r,a).enumerable}))),l.forEach(function(a){Gt(n,a,r[a])})}return n}function Gt(n,e,r){return e in n?Object.defineProperty(n,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[e]=r,n}var J=function(e,r){var l=tt({},e,r.attrs);return o(at,tt({},l,{icon:Ht}),null)};J.displayName="PlaySquareFilled";J.inheritAttrs=!1;const Jt=J;function et(n){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?Object(arguments[e]):{},l=Object.keys(r);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(r).filter(function(a){return Object.getOwnPropertyDescriptor(r,a).enumerable}))),l.forEach(function(a){Wt(n,a,r[a])})}return n}function Wt(n,e,r){return e in n?Object.defineProperty(n,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[e]=r,n}var W=function(e,r){var l=et({},e,r.attrs);return o(at,et({},l,{icon:Mt}),null)};W.displayName="SyncOutlined";W.inheritAttrs=!1;const Yt=W;function Zt(){const n=nt({state:"closed"});function e(){n.value={state:"closed"}}function r(){n.value={state:"visualizations"}}function l(u,p){n.value={state:"stage-run",stageRun:p}}const a=H(()=>"stageRun"in n.value?n.value.stageRun:null);return{closeDrawer:e,openVisualizationEditor:r,inspectStageRun:l,drawerState:n,selectedStageRunForDrawer:a}}const U="kanban-selected-stage-ids",L=10,Qt=({kanbanRepository:n,storage:e,filterFactory:r,router:l})=>{const a=mt([]),u=ut(async()=>{try{const f=await n.getData({selection:a.value,filter:r()}),g=await e.get(U)||[];for(const y of f.not_found_stages)e.set(U,g.filter(h=>h!==y)),a.value=a.value.filter(h=>h.stage_id!==y);return f}catch{return a.value=[],await e.set(U,[]),{columns:[],next_stage_options:[]}}});function p(f){const g=f.selected_stage.id,y=a.value.find(h=>h.stage_id===g);return y!=null&&y.limit?y.limit<f.total_count:!1}async function c(f){var y;const g=a.value.find(h=>h.stage_id===f.selected_stage.id);g&&(g.limit=((y=g.limit)!=null?y:0)+L,await u.refetch())}async function _(f){const g=a.value.find(y=>y.stage_id===f);g&&g.limit&&g.limit>L&&(g.limit-=L,await u.refetch())}async function v(){const f=await e.get(U)||[];a.value=f.map(g=>({stage_id:g,limit:L,offset:0}))}async function C(f,g){f?a.value=[...a.value.slice(0,g),{stage_id:f.id,limit:L,offset:0},...a.value.slice(g+1)]:a.value=[...a.value.slice(0,g),...a.value.slice(g+1)],await e.set(U,a.value.map(y=>y.stage_id)),await u.refetch()}async function F(f){await C(f,a.value.length)}let b=null;return{kanbanAsyncComputed:u,selection:a,increasePagination:c,hasPagination:p,seeLess:_,setStage:C,addStage:F,cardActionHandler:async(f,g)=>{const y=f.selected_stage,h=g.id;if(y.type==="script"){const k=await It.get(y.id);if(!k)return;await k.run(h)}if(y.type==="form"){const k=l.resolve({path:`/${y.path}`,query:h?{[Ot]:h}:{}});window.open(k.href,h)}},setup:async()=>{await v(),u.refetch(),b=setInterval(()=>{u.refetch()},1e3)},tearDown:()=>{b&&clearInterval(b)}}};function Y(n){switch(n.status){case"waiting":return{color:"blue",text:"Waiting"};case"running":return{color:"processing",text:"Running"};case"finished":return{color:"success",text:"Success"};case"failed":return{color:"error",text:"Failed"};case"abandoned":return{color:"warning",text:"Abandoned"}}}const N="Show All",Xt=[N,...Dt];function te(){const n=nt(N);return{filterStatus:n,filterFactory:()=>n.value==N?{}:{status:n.value},labelOption:l=>l==N?N:Y({status:l}).text}}const ee={key:0},ae={key:1,class:"terminal"},ne=D({__name:"ExecutionInspector",props:{logs:{}},setup(n){return(e,r)=>e.logs.length===0?(i(),S("span",ee)):(i(),S("div",ae,[o(t(R),{vertical:""},{default:s(()=>[(i(!0),S(P,null,x(e.logs,l=>(i(),S("pre",{key:l.executionId,class:"log-text"},w(l.payload.text),1))),128))]),_:1})]))}});const se=G(ne,[["__scopeId","data-v-4e71a195"]]),M=D({__name:"StageRunData",props:{data:{}},setup(n){return(e,r)=>(i(),d(t(T),{direction:"vertical",style:{overflow:"hidden"}},{default:s(()=>[(i(!0),S(P,null,x(e.data,l=>(i(),S("div",{key:l.key},[o(t(B),{strong:""},{default:s(()=>[m(w(l.key),1)]),_:2},1024),o(t(_t),{"tree-data":t(xt)(l.value),selectable:!1},null,8,["tree-data"])]))),128))]),_:1}))}}),re=n=>(vt("data-v-68c9e478"),n=n(),bt(),n),oe={key:1},le={key:1},ie=re(()=>z("span",null,"[Deleted Stage]",-1)),ue=["onClick"],ce=D({__name:"StageRunInspector",props:{stageRun:{},kanbanRepository:{},stageRunRepository:{}},emits:["close"],setup(n,{emit:e}){const r=n;function l(c){return Object.entries(c).map(([_,v])=>({key:_,value:v,type:typeof v}))}const{result:a,loading:u}=ut(()=>{var c;return r.kanbanRepository.getLogs((c=r.stageRun)==null?void 0:c.id)}),p=(c,_)=>{var v;c.stopPropagation(),(v=r.stageRunRepository)==null||v.fork(_),e("close")};return(c,_)=>(i(),d(t(Lt),{open:"",title:"Thread details",size:"large",onClose:_[0]||(_[0]=v=>e("close"))},{extra:s(()=>[o(t(X),null,{default:s(()=>[o(t(K),{style:{"font-weight":"600"}},{default:s(()=>{var v;return[m(w(t(Y)({status:(v=c.stageRun)==null?void 0:v.status}).text),1)]}),_:1}),m(" "+w(t(Ft)(new Date(c.stageRun.created_at),{addSuffix:!0})),1)]),_:1})]),default:s(()=>{var v,C,F;return[(v=c.stageRun)!=null&&v.assignee?(i(),d(t(X),{key:0},{default:s(()=>{var b;return[m(" Assignee: "+w((b=c.stageRun)==null?void 0:b.assignee),1)]}),_:1})):A("",!0),((C=c.stageRun)==null?void 0:C.content)&&((F=c.stageRun)==null?void 0:F.content.length)>0?(i(),S("div",oe,[o(t(q),{level:4},{default:s(()=>[m("Current data")]),_:1}),o(M,{data:c.stageRun.content},null,8,["data"])])):A("",!0),o(t(q),{level:4,style:{"margin-bottom":"30px"}},{default:s(()=>[m(" Timeline ")]),_:1}),t(u)?(i(),d(t(ht),{key:2})):t(a)?(i(),d(t(Et),{key:3},{default:s(()=>[(i(!0),S(P,null,x(t(a),({stage:b,stage_run:I,logs:$})=>(i(),d(t(Tt),{key:I.id},{default:s(()=>[o(t(pt),{ghost:"","expand-icon-position":"end"},{default:s(()=>[o(t(dt),{class:"panel"},st({header:s(()=>[b?(i(),d(t(R),{key:0,align:"center",gap:15},{default:s(()=>[o(V,{path:t(ct)(b.type)},null,8,["path"]),$.length?(i(),S("span",le,w(b.title),1)):(i(),d(t(rt),{key:0,placement:"right",title:"No logs"},{default:s(()=>[m(w(b.title),1)]),_:2},1024))]),_:2},1024)):(i(),d(t(R),{key:1,align:"center",gap:15},{default:s(()=>[o(V,{path:t(Pt)},null,8,["path"]),ie]),_:1}))]),default:s(()=>[l(I.data).length||$.length?(i(),d(t(R),{key:0,vertical:""},{default:s(()=>[l(I.data).length?(i(),d(t(R),{key:0,gap:0,vertical:""},{default:s(()=>[o(t(q),{level:5},{default:s(()=>[m(" Output data ")]),_:1}),o(M,{data:l(I.data)},null,8,["data"])]),_:2},1024)):A("",!0),$.length?(i(),d(t(R),{key:1,vertical:"",gap:0},{default:s(()=>[o(t(gt)),o(t(q),{level:5},{default:s(()=>[m(" Logs ")]),_:1}),o(se,{logs:$},null,8,["logs"])]),_:2},1024)):A("",!0)]),_:2},1024)):(i(),d(t(ot),{key:1,description:"No logs"}))]),_:2},[c.stageRunRepository&&b?{name:"extra",fn:s(()=>[z("span",{onClick:j=>p(j,I.id)},[o(t(R),{gap:"small"},{default:s(()=>[o(V,{path:t($t),width:"22"},null,8,["path"]),o(t(Ut),null,{default:s(()=>[m("Fork")]),_:1})]),_:1})],8,ue)]),key:"0"}:void 0]),1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):A("",!0)]}),_:1}))}});const de=G(ce,[["__scopeId","data-v-68c9e478"]]),pe=D({__name:"Card",props:{stage:{},card:{}},emits:["inspect","action"],setup(n){const e=n,r=H(()=>Y({status:e.card.status}).text),l=H(()=>St(new Date(String(e.card.updated_at))));return(a,u)=>{var p;return i(),d(t(jt),{size:"small",style:{width:"275px",cursor:"pointer"},"body-style":{display:((p=a.card.content)==null?void 0:p.length)>0?"block":"none"}},st({title:s(()=>[o(t(K),null,{default:s(()=>[m(w(r.value)+" ",1),r.value==="Running"?(i(),d(t(Yt),{key:0,spin:!0,style:{"margin-left":"4px"}})):A("",!0)]),_:1})]),default:s(()=>[o(t(T),{direction:"vertical",style:{"max-height":"300px",width:"100%",overflow:"hidden"},onClick:u[0]||(u[0]=c=>a.$emit("inspect"))},{default:s(()=>[o(M,{data:a.card.content,disabled:!0},null,8,["data"]),a.card.assignee?(i(),d(t(K),{key:0},{default:s(()=>[m(w(a.card.assignee),1)]),_:1})):A("",!0)]),_:1})]),extra:s(()=>[o(t(R),{gap:"10"},{default:s(()=>[o(t(rt),null,{title:s(()=>[m(w(a.card.updated_at),1)]),default:s(()=>[o(t(B),{type:"secondary",style:{"font-size":"12px"}},{default:s(()=>[m(w(l.value),1)]),_:1})]),_:1}),o(t(Nt),{onClick:u[2]||(u[2]=c=>a.$emit("inspect"))})]),_:1})]),_:2},[a.card.status==="waiting"?{name:"actions",fn:s(()=>[o(t(Jt),{onClick:u[1]||(u[1]=c=>a.$emit("action"))})]),key:"0"}:void 0]),1032,["body-style"])}}}),ft=D({__name:"ColumnHeader",props:{stageOptions:{},stage:{},stageCount:{}},emits:["stageUpdate"],setup(n,{emit:e}){const r=n,l=a=>{const u=r.stageOptions.find(p=>p.id===a);e("stageUpdate",u!=null?u:null)};return(a,u)=>{var c;const p=kt("icon");return i(),d(t(it),{style:{width:"275px"},"allow-clear":"",value:((c=a.stage)==null?void 0:c.id)||"","onUpdate:value":l},{suffixIcon:s(()=>[o(t(B),{type:"secondary",style:{"font-size":"small","margin-right":"2px"}},{default:s(()=>[m(w(a.stageCount),1)]),_:1}),o(t(gt),{type:"vertical"}),o(t(qt))]),default:s(()=>[(i(!0),S(P,null,x(a.stageOptions,_=>(i(),d(t(lt),{key:_.id,value:_.id},{default:s(()=>[o(t(R),{gap:"10",style:{"max-width":"200px"}},{default:s(()=>[o(p,{path:t(ct)(_.type),style:{"flex-shrink":"0",width:"24px"}},null,8,["path"]),o(t(B),{ellipsis:"",content:_.title},null,8,["content"])]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])}}});class ge{constructor(e,r,l){this.router=e,this.column=r,this.kanbanRepository=l}get stage(){return this.column.selected_stage}get canStart(){return this.stage.can_be_started}get launchLink(){return!this.stage.can_be_started||this.stage.type!=="form"||!this.stage.path?null:this.router.resolve({path:`/${this.stage.path}`}).href}click(){if(this.launchLink)return window.open(this.launchLink,"_blank");if(this.stage.type==="job")return this.kanbanRepository.startJob(this.stage.id).catch(console.error)}}const fe=D({__name:"Column",props:{router:{},hasPagination:{type:Boolean},column:{},kanbanRepository:{}},emits:["increasePagination","cardAction","stageUpdate","cardInspection"],setup(n,{emit:e}){const r=n,l=new ge(r.router,r.column,r.kanbanRepository);return(a,u)=>(i(),d(t(T),{direction:"vertical"},{default:s(()=>[o(ft,{"stage-options":a.column.stages,stage:a.column.selected_stage,"stage-count":a.column.total_count,onStageUpdate:u[0]||(u[0]=p=>e("stageUpdate",p))},null,8,["stage-options","stage","stage-count"]),o(t(T),{direction:"vertical",style:{width:"100%"}},{default:s(()=>[a.column.stage_run_cards.length===0?(i(),d(t(ot),{key:0})):A("",!0),(i(!0),S(P,null,x(a.column.stage_run_cards,p=>(i(),d(pe,{key:p.id,stage:a.column.selected_stage,card:p,onInspect:c=>e("cardInspection",p),onAction:c=>e("cardAction",p)},null,8,["stage","card","onInspect","onAction"]))),128)),a.hasPagination?(i(),d(t(Q),{key:1,style:{width:"100%"},onClick:u[1]||(u[1]=p=>e("increasePagination"))},{default:s(()=>[m("See more")]),_:1})):A("",!0),t(l).canStart?(i(),d(t(Q),{key:2,style:{width:"100%"},onClick:u[2]||(u[2]=()=>t(l).click())},{default:s(()=>[m(" Start ")]),_:1})):A("",!0)]),_:1})]),_:1}))}}),ye=D({__name:"EmptyColumn",props:{stages:{}},emits:["stageUpdate"],setup(n,{emit:e}){const r=l=>{e("stageUpdate",l)};return(l,a)=>(i(),d(t(T),{direction:"vertical"},{default:s(()=>[o(ft,{"stage-options":l.stages,onStageUpdate:r},null,8,["stage-options"])]),_:1}))}}),me={style:{width:"100%",padding:"20px"}},_e={class:"stages-container"},he={class:"stages-content"},ve=D({__name:"Kanban",props:{storage:{},kanbanRepository:{},stageRunRepository:{}},setup(n){const e=n,r=wt(),{closeDrawer:l,inspectStageRun:a,drawerState:u,selectedStageRunForDrawer:p}=Zt(),{filterFactory:c,filterStatus:_,labelOption:v}=te(),{kanbanAsyncComputed:C,setStage:F,addStage:b,setup:I,tearDown:$,cardActionHandler:j,increasePagination:f,hasPagination:g}=Qt({kanbanRepository:e.kanbanRepository,storage:e.storage,filterFactory:c,router:r});return At(I),Rt($),(y,h)=>(i(),S("div",me,[o(t(R),{vertical:"",style:{height:"100%"}},{default:s(()=>[o(t(pt),{ghost:""},{default:s(()=>[o(t(dt),{header:"Filters"},{default:s(()=>[o(t(zt),null,{default:s(()=>[o(t(Bt),{label:"Status"},{default:s(()=>[o(t(it),{value:t(_),"onUpdate:value":h[0]||(h[0]=k=>Ct(_)?_.value=k:null),style:{width:"325px"}},{default:s(()=>[(i(!0),S(P,null,x(t(Xt),k=>(i(),d(t(lt),{key:k,value:k},{default:s(()=>[m(w(t(v)(k)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),z("div",_e,[z("div",he,[o(t(T),{align:"start"},{default:s(()=>{var k,Z;return[(i(!0),S(P,null,x(((k=t(C).result.value)==null?void 0:k.columns)||[],(O,yt)=>(i(),d(t(fe),{key:O.selected_stage.id,column:O,router:t(r),"has-pagination":t(g)(O),"kanban-repository":e.kanbanRepository,onIncreasePagination:E=>t(f)(O),onCardInspection:E=>t(a)(O,E),onCardAction:E=>t(j)(O,E),onStageUpdate:E=>t(F)(E,yt)},null,8,["column","router","has-pagination","kanban-repository","onIncreasePagination","onCardInspection","onCardAction","onStageUpdate"]))),128)),o(t(ye),{stages:((Z=t(C).result.value)==null?void 0:Z.next_stage_options)||[],onStageUpdate:h[1]||(h[1]=O=>t(b)(O))},null,8,["stages"])]}),_:1})])])]),_:1}),t(u).state==="stage-run"&&t(p)?(i(),d(t(de),{key:0,"kanban-repository":e.kanbanRepository,"stage-run":t(p),"stage-run-repository":e.stageRunRepository,onClose:t(l)},null,8,["kanban-repository","stage-run","stage-run-repository","onClose"])):A("",!0)]))}});const Ge=G(ve,[["__scopeId","data-v-8d6c77ed"]]);class Je{constructor(e,r=localStorage){this.contextKey=e,this.storage=r}makeKey(e){return`${this.contextKey}:${e}`}async get(e){const r=this.storage.getItem(this.makeKey(e));return r?JSON.parse(r):null}async set(e,r){this.storage.setItem(this.makeKey(e),JSON.stringify(r))}}export{Ge as K,Je as L};
//# sourceMappingURL=repository.171673f2.js.map
