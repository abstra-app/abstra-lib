import{d as A,J as b,K as pe,b as p,ew as z,f as o,w as t,u as a,as as f,ak as fe,cy as x,aj as I,e as h,c as g,ey as S,eC as de,eD as me,x as Q,bz as Y,aI as ve,eH as T,bG as L,af as ge,eF as ye,cB as _e,aE as Z,eR as he,eK as be,r as q,eS as ke}from"./outputWidgets.6e1c5425.js";import{C as we}from"./ContentLayout.150390bd.js";import{C as Fe}from"./CrudView.88823d06.js";import{a as K}from"./ant-design.f246aa2b.js";import{a as D}from"./asyncComputed.06ede41f.js";import{c as Se}from"./string.21869e46.js";import{F as Ce}from"./PhArrowSquareOut.vue.b51cdf06.js";import{F as j}from"./forms.58928383.js";import{H as P,J as B}from"./jobs.c0907d69.js";import{W as ee}from"./workspaces.0676e56f.js";import{S as V}from"./scripts.29615e06.js";import"./envVars.72a577f4.js";import{I as Te}from"./PhScroll.vue.1ea6100a.js";import{F as Ae,G as xe,a as Ie}from"./PhWebhooksLogo.vue.9951768a.js";import{_ as W}from"./DocsButton.vue_vue_type_script_setup_true_lang.3a6e05dd.js";import{a as $e}from"./Base.0277cf44.js";import{A as $}from"./index.c12e1c2f.js";import{A as N}from"./Paragraph.4ce326b3.js";import{v as te,b as Ne}from"./validations.4d841ad6.js";import{A as U,F as ae}from"./Form.b82a2cec.js";import{A as E}from"./Text.b10c1140.js";import{A as Ue}from"./index.0b7245cc.js";import{M as Ee}from"./Modal.e50e9e9a.js";import{A as De}from"./Title.dfd37452.js";import{A as je}from"./Link.5b1de2a9.js";import{A as Pe}from"./index.1442882a.js";import"./router.4a0ba06b.js";import"./popupNotifcation.76f4dd63.js";import"./url.5357e9db.js";import"./index.1a6a6e78.js";import"./record.c7d63161.js";import"./pubsub.4f3043c8.js";import"./runnerData.dbd7d7cb.js";import"./BookOutlined.8202b78f.js";import"./hasIn.bf07751b.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},n=new Error().stack;n&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[n]="9e70513c-be06-473e-bcf6-d5d257abeee3",s._sentryDebugIdIdentifier="sentry-dbid-9e70513c-be06-473e-bcf6-d5d257abeee3")}catch{}})();const H=s=>(de("data-v-66ec5be6"),s=s(),me(),s),Be={key:0,class:"choose-type"},He={class:"option-content"},Ge=H(()=>h("span",null,"Forms",-1)),Je={class:"option-content"},Le=H(()=>h("span",null,"Hooks",-1)),Oe={class:"option-content"},Ve=H(()=>h("span",null,"Scripts",-1)),ze={class:"option-content"},Me=H(()=>h("span",null,"Jobs",-1)),Re=A({__name:"ChooseStageType",props:{state:{}},emits:["choose-type"],setup(s,{emit:n}){const i=s,u=b(()=>i.state.type==="form"?"#fff":void 0),y=b(()=>i.state.type==="hook"?"#fff":void 0),k=b(()=>i.state.type==="script"?"#fff":void 0),d=b(()=>i.state.type==="job"?"#fff":void 0);return pe(()=>i.state.type,_=>{_&&n("choose-type",_)}),(_,F)=>_.state.state==="choosing-type"?(p(),z("div",Be,[o(a($),{vertical:"",gap:"30"},{default:t(()=>[o(a($e),null,{default:t(()=>[f("Choose your stage type")]),_:1}),o(a(fe),{value:_.state.type,"onUpdate:value":F[0]||(F[0]=w=>_.state.type=w),size:"large","button-style":"solid"},{default:t(()=>[o(a($),{gap:"24",vertical:""},{default:t(()=>[o(a($),{gap:"24"},{default:t(()=>[o(a(x),{placement:"left",title:"Forms"},{content:t(()=>[o(a(N),null,{default:t(()=>[f(" Use to collect user input via interaction with a form interface ")]),_:1}),o(W,{path:"concepts/forms"})]),default:t(()=>[o(a(I),{value:"form",class:"option"},{default:t(()=>[h("div",He,[(p(),g(a(Ae),{key:u.value,color:u.value},null,8,["color"])),Ge])]),_:1})]),_:1}),o(a(x),{placement:"right",title:"Hooks"},{content:t(()=>[o(a(N),null,{default:t(()=>[f("Use to build endpoints triggered by HTTP requests")]),_:1}),o(W,{path:"concepts/forms"})]),default:t(()=>[o(a(I),{value:"hook",class:"option"},{default:t(()=>[h("div",Je,[(p(),g(a(xe),{key:y.value,color:y.value},null,8,["color"])),Le])]),_:1})]),_:1})]),_:1}),o(a($),{gap:"24"},{default:t(()=>[o(a(x),{placement:"left",title:"Scripts"},{content:t(()=>[o(a(N),null,{default:t(()=>[f(" Use to write plain Python scripts ")]),_:1})]),default:t(()=>[o(a(I),{value:"script",class:"option"},{default:t(()=>[h("div",Oe,[(p(),g(a(Te),{key:k.value,color:k.value},null,8,["color"])),Ve])]),_:1})]),_:1}),o(a(x),{placement:"right",title:"Jobs"},{content:t(()=>[o(a(N),null,{default:t(()=>[f(" Use to schedule your script execution periodically ")]),_:1})]),default:t(()=>[o(a(I),{value:"job",class:"option"},{default:t(()=>[h("div",ze,[(p(),g(a(Ie),{key:d.value,color:d.value},null,8,["color"])),Me])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["value"])]),_:1})])):S("",!0)}});const Ye=Q(Re,[["__scopeId","data-v-66ec5be6"]]),qe=h("br",null,null,-1),Ke=A({__name:"NewStage",props:{state:{}},emits:["update-name","update-file"],setup(s,{emit:n}){const i=s,{result:u}=D(()=>fetch("/_editor/api/workspace/root").then(v=>v.text())),y=b(()=>i.state.state!=="creating"?"":`${u.value}/${i.state.stage.filename}`),k=b(()=>i.state.state!=="creating"?"":`${i.state.stage.type[0].toUpperCase()+i.state.stage.type.slice(1)} title`),d=v=>{n("update-name",v);const e=Ne(v);n("update-file",e),F()},{result:_,refetch:F}=D(()=>ee.checkFile(i.state.stage.filename)),w=b(()=>te(i.state.stage.filename));return(v,e)=>(p(),g(a(ae),{layout:"vertical"},{default:t(()=>{var C;return[o(a(U),{label:k.value,required:!0},{default:t(()=>[o(a(Y),{value:v.state.stage.title,"onUpdate:value":d},null,8,["value"])]),_:1},8,["label"]),o(a(U),{label:"Generated file",required:!0,"validate-status":w.value.valid?"success":"error",help:w.value.valid?void 0:w.value.reason},{default:t(()=>[o(a(ve),{placement:"right"},{title:t(()=>[f(" You can change this later ")]),default:t(()=>[o(a(Y),{value:v.state.stage.filename,"onUpdate:value":e[0]||(e[0]=G=>v.state.stage.filename=G),disabled:!0},null,8,["value"])]),_:1})]),_:1},8,["validate-status","help"]),o(a(U),null,{default:t(()=>[o(a(E),null,{default:t(()=>[f(" Your stage source code will be generated at: ")]),_:1}),qe,o(a(E),{code:""},{default:t(()=>[f(T(y.value),1)]),_:1})]),_:1}),(C=a(_))!=null&&C.exists?(p(),g(a(Ue),{key:0,type:"warning","show-icon":""},{message:t(()=>[o(a(E),null,{default:t(()=>[f(" This file already exists and might be in use by another stage. Contents will be left unchanged. ")]),_:1})]),_:1})):S("",!0)]}),_:1}))}}),We=A({__name:"CreateModal",props:{open:{type:Boolean},state:{}},emits:["close","choose-type","next-step","previous-step","create-stage","update-name","update-file"],setup(s,{emit:n}){const i=s,u=e=>n("update-name",e),y=e=>n("update-file",e),k=()=>n("close"),d=e=>n("choose-type",e),_=()=>n("next-step"),F=()=>n("previous-step"),w=()=>n("create-stage"),v=b(()=>!(i.state.state!=="creating"||!te(i.state.stage.filename).valid||!i.state.stage.title));return(e,C)=>(p(),g(a(Ee),{open:e.open,title:"Create a new stage",onCancel:k},{footer:t(()=>[e.state.state==="creating"?(p(),g(a(L),{key:0,onClick:F},{default:t(()=>[f("Previous")]),_:1})):S("",!0),e.state.state==="creating"?(p(),g(a(L),{key:1,type:"primary",disabled:!v.value,onClick:w},{default:t(()=>[f(" Create ")]),_:1},8,["disabled"])):S("",!0),e.state.state==="choosing-type"?(p(),g(a(L),{key:2,type:"primary",disabled:!e.state.type,onClick:_},{default:t(()=>[f(" Next ")]),_:1},8,["disabled"])):S("",!0)]),default:t(()=>[e.state.state==="choosing-type"?(p(),g(Ye,{key:0,state:e.state,onChooseType:d},null,8,["state"])):S("",!0),e.state.state==="creating"?(p(),g(Ke,{key:1,state:e.state,onUpdateName:u,onUpdateFile:y},null,8,["state"])):S("",!0)]),_:1},8,["open"]))}}),Xe=A({__name:"FilterStages",emits:["update-filter"],setup(s,{emit:n}){const i=[{label:"Forms",value:"form"},{label:"Hooks",value:"hook"},{label:"Scripts",value:"script"},{label:"Jobs",value:"job"}],u=y=>n("update-filter",y);return(y,k)=>(p(),g(a(ae),null,{default:t(()=>[o(a(U),{label:"Filter"},{default:t(()=>[o(a(ge),{mode:"multiple",style:{width:"360px"},placeholder:"All","onUpdate:value":u},{default:t(()=>[(p(),z(Z,null,ye(i,d=>o(a(_e),{key:d.value,value:d.value},{default:t(()=>[f(T(d.label),1)]),_:2},1032,["value"])),64))]),_:1})]),_:1})]),_:1}))}}),Qe=200,Ze=s=>{if(!s)return[0,0];if(s.length===0)return[0,0];let n=-1/0,i=0;for(const u of s)u.position.x>n&&(n=u.position.x),i+=u.position.y/s.length;return[n+Qe,i]},O=s=>{if(s instanceof j)return"form";if(s instanceof P)return"hook";if(s instanceof B)return"job";if(s instanceof V)return"script";throw new Error("Invalid script type")},et=s=>s instanceof j?`/${s.path}`:s instanceof P?`/_hooks/${s.path}`:s instanceof B?`${s.schedule}`:"",tt={class:"ellipsis",style:{"max-width":"300px"}},at={class:"ellipsis",style:{"max-width":"250px"}},ot={class:"ellipsis",style:{"max-width":"200px"}},X=100,st=A({__name:"Stages",setup(s){he(l=>({"5fdb2219":ue()}));const n=be(),{loading:i,result:u,refetch:y}=D(async()=>Promise.all([j.list(),P.list(),B.list(),V.list()]).then(([l,r,c,m])=>[...l,...r,...c,...m])),{result:k}=D(()=>ee.get()),d=q([]),_=l=>{d.value=l},F=b(()=>u.value?d.value.length===0?u.value:u.value.filter(l=>d.value.includes(O(l))):[]),w=l=>{!k.value||k.value.openFile(l)},v=b(()=>{const l=[{name:"Type",align:"left"},{name:"Title",align:"left"},{name:"File",align:"left"},{name:"Trigger",align:"left"},{name:"",align:"right"}],r=F.value;if(!r)return{columns:l,rows:[]};const c=r.map(m=>{const J=Se(O(m));return{key:m.id,cells:[{type:"tag",text:J},{type:"slot",key:"title",payload:{script:m}},{type:"slot",key:"file",payload:{script:m}},{type:"slot",key:"trigger",payload:{script:m}},{type:"actions",actions:[{icon:Ce,label:"Open .py file",onClick:()=>w(m.file)},{icon:ke,label:"Delete",onClick:()=>re(m.id)}]}]}});return{columns:l,rows:c}}),e=q({state:"idle"}),C=b(()=>e.value.state==="choosing-type"||e.value.state==="creating"),G=()=>{e.value={state:"choosing-type",type:null}},M=()=>{e.value={state:"idle"}},oe=l=>{e.value.state==="choosing-type"&&(e.value={state:"choosing-type",type:l})},se=()=>{e.value.state==="choosing-type"&&e.value.type!==null&&(e.value={state:"creating",stage:{type:e.value.type,title:`Untitled ${e.value.type}`,filename:`untitled_${e.value.type}.py`}})},le=()=>{e.value.state==="creating"&&(e.value={state:"choosing-type",type:e.value.stage.type})},ne=l=>{e.value.state==="creating"&&(e.value.stage.title=l)},ie=l=>{e.value.state==="creating"&&(e.value.stage.filename=l)},re=async l=>{var r,c;if(await K("Are you sure you want to delete this script?")){const m=await K("Do you want to delete the .py file associated with this script?",{okText:"Yes",cancelText:"No"});await((c=(r=u.value)==null?void 0:r.find(J=>J.id===l))==null?void 0:c.delete(m)),await y()}},ue=()=>(X/1e3).toString()+"s",ce=async()=>{if(e.value.state!=="creating")return;const l=Ze(u.value||[]);let r;if(e.value.stage.type==="form"?r=await j.create(e.value.stage.title,e.value.stage.filename,l):e.value.stage.type==="hook"?r=await P.create(e.value.stage.title,e.value.stage.filename,l):e.value.stage.type==="job"?r=await B.create(e.value.stage.title,e.value.stage.filename,l):e.value.stage.type==="script"&&(r=await V.create(e.value.stage.title,e.value.stage.filename,l)),!r)throw new Error("Failed to create script");const c=r.id,m=e.value.stage.type;M(),await y(),setTimeout(()=>{R(c,m)},X)},R=(l,r)=>{r==="form"&&n.push({name:"formEditor",params:{id:l}}),r==="hook"&&n.push({name:"hookEditor",params:{id:l}}),r==="script"&&n.push({name:"scriptEditor",params:{id:l}}),r==="job"&&n.push({name:"jobEditor",params:{id:l}})};return(l,r)=>(p(),z(Z,null,[o(we,null,{default:t(()=>[o(a(De),null,{default:t(()=>[f("Stages")]),_:1}),o(Xe,{onUpdateFilter:_}),o(Fe,{"empty-title":"There are no scripts","entity-name":"scripts",description:"",table:v.value,loading:a(i),title:"","create-button-text":"Create new",onCreate:G},{title:t(({payload:c})=>[h("div",tt,[o(a(je),{onClick:m=>R(c.script.id,a(O)(c.script))},{default:t(()=>[f(T(c.script.title),1)]),_:2},1032,["onClick"])])]),file:t(({payload:c})=>[h("div",at,[o(a(E),null,{default:t(()=>[f(T(c.script.file),1)]),_:2},1024)])]),trigger:t(({payload:c})=>[o(a(Pe),{color:"default"},{default:t(()=>[h("div",ot,T(a(et)(c.script)),1)]),_:2},1024)]),_:1},8,["table","loading"])]),_:1}),o(We,{open:C.value,state:e.value,onClose:M,onChooseType:oe,onNextStep:se,onPreviousStep:le,onCreateStage:ce,onUpdateName:ne,onUpdateFile:ie},null,8,["open","state"])],64))}});const Jt=Q(st,[["__scopeId","data-v-8f3aeb8f"]]);export{Jt as default};
//# sourceMappingURL=Stages.db8578d2.js.map
