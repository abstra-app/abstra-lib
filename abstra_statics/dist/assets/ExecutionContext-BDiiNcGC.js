import{C as M,e as ct,f as ut}from"./router-JQGqXn2H.js";import{a as W,i as O,c as P,b as h,e as u,f as dt,g as A,h as _,m as gt,d as ft,r as I,P as z,a9 as pt,H as q,p as k,u as r,v as G,w as m,M as et,W as at,K as ht,U as D,bn as mt,ak as R,S as j,aN as ot,j as w,ae as v,A as F,bF as yt,E as xt,bq as L}from"./jwt-decode.esm-CyZeei5F.js";import{b as vt}from"./build-iTChJXxg.js";import{c as nt}from"./string-C8wdSl0M.js";import"./tables-DYwB4s8Y.js";import{u as bt}from"./polling-CKmJnvsA.js";import{t as wt}from"./ant-design-KM8Drp7f.js";import{I as tt}from"./PhCopy.vue-CQHPVB2s.js";import{S as At}from"./index-CihYfCC1.js";(function(){try{var n=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[e]="5bcb3e5f-1629-4d42-98f8-3e5c3dbde451",n._sentryDebugIdIdentifier="sentry-dbid-5bcb3e5f-1629-4d42-98f8-3e5c3dbde451")}catch{}})();const _t=["width","height","fill","transform"],kt={key:0},Ht=_("path",{d:"M72,104a16,16,0,1,1,16,16A16,16,0,0,1,72,104Zm96,16a16,16,0,1,0-16-16A16,16,0,0,0,168,120Zm68-40V192a36,36,0,0,1-36,36H56a36,36,0,0,1-36-36V80A36,36,0,0,1,56,44h60V16a12,12,0,0,1,24,0V44h60A36,36,0,0,1,236,80Zm-24,0a12,12,0,0,0-12-12H56A12,12,0,0,0,44,80V192a12,12,0,0,0,12,12H200a12,12,0,0,0,12-12Zm-12,82a30,30,0,0,1-30,30H86a30,30,0,0,1,0-60h84A30,30,0,0,1,200,162Zm-80-6v12h16V156ZM86,168H96V156H86a6,6,0,0,0,0,12Zm90-6a6,6,0,0,0-6-6H160v12h10A6,6,0,0,0,176,162Z"},null,-1),St=[Ht],Zt={key:1},Ct=_("path",{d:"M200,56H56A24,24,0,0,0,32,80V192a24,24,0,0,0,24,24H200a24,24,0,0,0,24-24V80A24,24,0,0,0,200,56ZM164,184H92a20,20,0,0,1,0-40h72a20,20,0,0,1,0,40Z",opacity:"0.2"},null,-1),It=_("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Zm4,28H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24Z"},null,-1),Vt=[Ct,It],Et={key:2},Pt=_("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48ZM172,96a12,12,0,1,1-12,12A12,12,0,0,1,172,96ZM96,184H80a16,16,0,0,1,0-32H96ZM84,120a12,12,0,1,1,12-12A12,12,0,0,1,84,120Zm60,64H112V152h32Zm32,0H160V152h16a16,16,0,0,1,0,32Z"},null,-1),Dt=[Pt],jt={key:3},Tt=_("path",{d:"M200,50H134V16a6,6,0,0,0-12,0V50H56A30,30,0,0,0,26,80V192a30,30,0,0,0,30,30H200a30,30,0,0,0,30-30V80A30,30,0,0,0,200,50Zm18,142a18,18,0,0,1-18,18H56a18,18,0,0,1-18-18V80A18,18,0,0,1,56,62H200a18,18,0,0,1,18,18ZM74,108a10,10,0,1,1,10,10A10,10,0,0,1,74,108Zm88,0a10,10,0,1,1,10,10A10,10,0,0,1,162,108Zm2,30H92a26,26,0,0,0,0,52h72a26,26,0,0,0,0-52Zm-22,12v28H114V150ZM78,164a14,14,0,0,1,14-14h10v28H92A14,14,0,0,1,78,164Zm86,14H154V150h10a14,14,0,0,1,0,28Z"},null,-1),$t=[Tt],Mt={key:4},Ot=_("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16Zm-52-56H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Z"},null,-1),zt=[Ot],Lt={key:5},Rt=_("path",{d:"M200,52H132V16a4,4,0,0,0-8,0V52H56A28,28,0,0,0,28,80V192a28,28,0,0,0,28,28H200a28,28,0,0,0,28-28V80A28,28,0,0,0,200,52Zm20,140a20,20,0,0,1-20,20H56a20,20,0,0,1-20-20V80A20,20,0,0,1,56,60H200a20,20,0,0,1,20,20ZM76,108a8,8,0,1,1,8,8A8,8,0,0,1,76,108Zm88,0a8,8,0,1,1,8,8A8,8,0,0,1,164,108Zm0,32H92a24,24,0,0,0,0,48h72a24,24,0,0,0,0-48Zm-20,8v32H112V148ZM76,164a16,16,0,0,1,16-16h12v32H92A16,16,0,0,1,76,164Zm88,16H152V148h12a16,16,0,0,1,0,32Z"},null,-1),Bt=[Rt],Nt={name:"PhRobot"},qt=W({...Nt,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(n){const e=n,o=O("weight","regular"),s=O("size","1em"),g=O("color","currentColor"),a=O("mirrored",!1),l=P(()=>e.weight??o),i=P(()=>e.size??s),y=P(()=>e.color??g),H=P(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:a?"scale(-1, 1)":void 0);return(c,Z)=>(u(),h("svg",gt({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:i.value,height:i.value,fill:y.value,transform:H.value},c.$attrs),[dt(c.$slots,"default"),l.value==="bold"?(u(),h("g",kt,St)):l.value==="duotone"?(u(),h("g",Zt,Vt)):l.value==="fill"?(u(),h("g",Et,Dt)):l.value==="light"?(u(),h("g",jt,$t)):l.value==="regular"?(u(),h("g",Mt,zt)):l.value==="thin"?(u(),h("g",Lt,Bt)):A("",!0)],16,_t))}}),Ft=["running","lock-failed","failed","finished","abandoned"];class B{constructor(e){this.dto=e}static from(e){return new B(e)}get entries(){return this.dto.sort((e,o)=>e.sequence-o.sequence).filter(e=>e.event!=="form-message")}}class N{constructor(e){this.dto=e}static from(e){return new N(e)}get id(){return this.dto.id}get shortId(){return this.dto.id.slice(0,8)}get createdAt(){return new Date(this.dto.createdAt)}get updatedAt(){return new Date(this.dto.updatedAt)}get status(){return this.dto.status}get context(){return this.dto.context}get buildId(){return this.dto.buildId??""}get stageId(){return this.dto.stageId}get duration_seconds(){return this.status==="running"?"-":`${(this.updatedAt.getTime()-this.createdAt.getTime())/1e3} s`}get stageRunId(){return this.dto.stageRunId}get projectId(){return this.dto.projectId}}class ce{async list({projectId:e,...o}){const s={...o,offset:o.offset?.toString(),limit:o.limit?.toString()};Object.keys(s).forEach(a=>s[a]===void 0&&delete s[a]);const g=await M.get(`projects/${e}/executions`,s);return{executions:g.executions.map(a=>N.from(a)),totalCount:g.totalCount}}async fetchLogs(e,o,s){const g={};s?.limit!==void 0&&(g.limit=s.limit.toString()),s?.offset!==void 0&&(g.offset=s.offset.toString());const a=Object.keys(g).length>0?`?${new URLSearchParams(g).toString()}`:"",l=await M.get(`projects/${e}/executions/${o}/logs${a}`);return{logs:B.from(l.logs),totalCount:l.totalCount}}async fetchThreadData(e,o){return(await M.get(`projects/${e}/executions/${o}/thread-data`)).response}async getExecutionTasks(e,o){return await M.get(`projects/${e}/executions/${o}/tasks`)}async fetchStages(){throw new Error("Method not implemented.")}}class ue{async list(e){const o={...e,offset:e.offset?.toString(),limit:e.limit?.toString()};Object.keys(o).forEach(i=>o[i]===void 0&&delete o[i]);const s=Object.fromEntries(Object.entries(o??{}).filter(([,i])=>i!=null)),g=Object.keys(s).length>0?`?${new URLSearchParams(s).toString()}`:"",l=await(await fetch(`/_editor/api/executions${g}`)).json();return{executions:l.executions.map(i=>N.from(i)),totalCount:l.totalCount}}async fetchLogs(e,o,s){const a=await(await fetch(`/_editor/api/logs/${o}`)).json();return{logs:B.from(a),totalCount:a.length}}async fetchThreadData(){return{}}async getExecutionTasks(e,o){return await(await fetch(`/_editor/api/executions/${o}/tasks`)).json()}async fetchStages(){return await(await fetch("/_editor/api/executions/stages")).json()}}const T=300,de=ft("logs",()=>{const n=I(null),e=I(null),o=I(""),s=I(!1),g=I(),a=z({openedExecutionIds:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],executionData:{}}),l=z({currentIndex:1,pageSize:10,totalCount:0}),i=z({dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0}),y=z({builds:[],stages:[],statuses:Ft.map(t=>({label:nt(t),value:t}))}),H=bt({task:()=>Q(),interval:1e4}),c=async t=>{n.value=t.executionRepository,e.value=t.buildRepository,o.value=t.projectId,s.value=t.pool??!1,g.value=t.onFilterChange,Object.assign(i,t.filters||{}),Object.assign(l,t.pagination||{}),t.openedExecutionId&&(a.openedExecutionIds=[t.openedExecutionId]),await Promise.all([b(),U()]),J(),s.value&&H.startPolling()},Z=()=>{H.endPolling()},b=async()=>{if(n.value){a.loadingExecutions=!0;try{const{executions:t,totalCount:f}=await n.value.list({projectId:o.value,buildId:i.buildId,status:i.status,limit:l.pageSize,offset:(l.currentIndex-1)*l.pageSize,stageId:i.stageId,startDate:i.dateRange?.[0]?.toISOString(),endDate:i.dateRange?.[1]?.toISOString(),search:i.search});a.executions=t,l.totalCount=f}finally{a.loadingExecutions=!1}}},S=async()=>{if(!e.value){y.builds=[];return}const f=(await e.value.list(o.value)).map(d=>({label:`[${d.id.slice(0,8)}] ${d.createdAt.toLocaleString()} ${d.latest?"(Latest)":""}`,value:d.id}));y.builds=f},V=async()=>{if(!n.value)return;if(!e.value){const x=(await n.value.fetchStages()).map(C=>({label:C.title,value:C.id}));y.stages=x??[];return}const t=i.buildId??(y.builds.length>0?y.builds[0].value:void 0);if(!t){console.warn("No buildId available for fetching stage options"),y.stages=[];return}const d=(await vt.get(t))?.runtimes.map(p=>({label:p.title,value:p.id}));y.stages=d??[]},U=async()=>{try{await S(),await V()}catch(t){console.error("Error fetching options:",t)}},E=async(t,f)=>{if(!n.value)return;const d=a.executionData[t],p=f||{limit:T,offset:0},[x,C,$]=await Promise.all([n.value.fetchLogs(o.value,t,p),n.value.fetchThreadData(o.value,t),n.value.getExecutionTasks(o.value,t)]),lt={currentIndex:1,pageSize:T,totalCount:x.totalCount,loading:!1};a.executionData[t]={logs:x.logs,threadData:C,tasks:{triggerTask:$.triggerTask?{type:$.triggerTask.type,payload:$.triggerTask.payload}:null,sentTasks:$.sentTasks.map(K=>({type:K.type,payload:K.payload}))},logsPagination:d?.logsPagination||lt},a.executionData[t].logsPagination&&(a.executionData[t].logsPagination.totalCount=x.totalCount,a.executionData[t].logsPagination.loading=!1)},J=()=>{a.openedExecutionIds.forEach(async t=>{a.executionData[t]||await E(t,{limit:T,offset:0})})},Q=async()=>{a.openedExecutionIds.map(t=>{const f=a.executions.find(p=>p.id===t);if(!f||f.status!=="running")return;const d=a.executionData[t];if(d?.logsPagination){const{currentIndex:p,pageSize:x}=d.logsPagination,C=(p-1)*x;return E(t,{limit:x,offset:C})}else return E(t,{limit:T,offset:0})})},X=()=>{a.waitingDebounce=!0,l.currentIndex=1,st(),g.value&&g.value(i)},st=pt.debounce(async()=>{await b(),a.waitingDebounce=!1},500),it=async t=>{let f=a.executions;return t&&(f=f.filter(p=>p.stageId===t)),f.length===0?null:f.reduce((p,x)=>p.createdAt>x.createdAt?p:x).id},Y=async(t,f)=>{const d=a.executionData[t];if(!d?.logsPagination)return;const{pageSize:p}=d.logsPagination;d.logsPagination.loading=!0,d.logsPagination.currentIndex=f;const x=(f-1)*p;await E(t,{limit:p,offset:x})},rt=(t,f)=>{const d=a.executionData[t];d?.logsPagination&&(d.logsPagination.pageSize=f,d.logsPagination.currentIndex=1,Y(t,1))};return q(()=>i.buildId,()=>{V()}),q(i,()=>{a.openedExecutionIds=[],X()}),q([()=>l.currentIndex,()=>l.pageSize],()=>{a.openedExecutionIds=[],b()}),{state:P(()=>({currentPage:a,pagination:l,filters:i,filterOptions:y})),currentPage:a,pagination:l,filters:i,filterOptions:y,init:c,teardown:Z,fetchPage:b,fetchBuildOptions:S,fetchStageOptions:V,fetchOptions:U,fetchExecutionDetails:E,fetchEmptyLogs:J,refetch:Q,handleFilterChange:X,getNewestExecutionId:it,fetchExecutionLogsPage:Y,setExecutionLogsPageSize:rt,polling:H}}),Gt={key:0,class:"cli"},Wt={key:0},Ut=W({__name:"LogContainer",props:{logs:{},pagination:{}},emits:["page-change"],setup(n){return(e,o)=>(u(),k(r(G),{vertical:"",gap:"small"},{default:m(()=>[n.logs.entries.length?(u(),h("div",Gt,[(u(!0),h(et,null,at(n.logs.entries,s=>(u(),h("p",{key:s.createdAt,style:ht({margin:0,"white-space":"pre-wrap",color:s.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},[s.payload.text?(u(),h("span",Wt,D(s.payload.text.trim()),1)):A("",!0)],4))),128))])):A("",!0),n.pagination?(u(),k(r(G),{key:1,vertical:"",gap:"small",align:"end"},{default:m(()=>[n.pagination.totalCount>r(T)?(u(),k(r(mt),{key:0,current:n.pagination.currentIndex,"page-size":n.pagination.pageSize,total:n.pagination.totalCount,"show-size-changer":!1,"show-quick-jumper":!1,size:"small",onChange:o[0]||(o[0]=s=>e.$emit("page-change",s))},null,8,["current","page-size","total"])):A("",!0)]),_:1})):n.logs.entries.length?A("",!0):(u(),k(r(R),{key:2,type:"secondary"},{default:m(()=>[...o[1]||(o[1]=[j("Empty",-1)])]),_:1}))]),_:1}))}}),ge=ot(Ut,[["__scopeId","data-v-ee1d10cd"]]),Jt={key:0},Qt=["onClick"],Xt=["onClick"],Yt=W({__name:"ExecutionContext",props:{data:{},showFixWithAi:{type:Boolean},isSmartChatIdle:{type:Boolean}},emits:["ask-ai"],setup(n,{emit:e}){const o=n,s=e,g=I(!1),a=c=>{if(c==="legacyThreadData")return v.translate("i18n_executioncontext_thread_data");const Z=nt(c);return Z.replace(/([A-Z])/g," $1").trim(),Z},l=c=>c==null?!0:Array.isArray(c)?c.length===0:typeof c=="object"?Object.keys(c).length===0:!1,i=c=>{typeof c=="object"&&c!==null&&"payload"in c?(navigator.clipboard.writeText(JSON.stringify(c.payload)),L.success({content:v.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),L.error({content:v.translate("i18n_executioncontext_no_payload")}))},y=c=>{g.value=!0,c.stopPropagation(),o.isSmartChatIdle!==!1&&(s("ask-ai"),setTimeout(()=>{g.value=!1},1e3))},H=c=>{typeof c=="object"?(navigator.clipboard.writeText(JSON.stringify(c)),L.success({content:v.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),L.error({content:v.translate("i18n_executioncontext_failed_copy_request")}))};return(c,Z)=>(u(),k(r(ct),{bordered:!1,style:{"background-color":"transparent",width:"100%"}},{default:m(()=>[w(r(ut),{key:"execution-context"},{header:m(()=>[w(r(G),{justify:"space-between"},{default:m(()=>[w(r(R),null,{default:m(()=>[j(D(r(v).translate("i18n_executioncontext_header")),1)]),_:1}),w(r(F),{title:n.isSmartChatIdle?"":r(v).translate("i18n_executioncontext_wait_or_stop"),placement:"left"},{default:m(()=>[n.showFixWithAi?(u(),h("div",{key:0,class:xt(["ask-to-ai",{disabled:!n.isSmartChatIdle||g.value}]),onClick:y},[j(D(r(v).translate("i18n_executioncontext_fix_with_ai"))+" ",1),w(r(qt),{size:16})],2)):A("",!0)]),_:1},8,["title"])]),_:1})]),default:m(()=>[w(r(At),{direction:"vertical",style:{"border-radius":"5px",padding:"10px",color:"#fff",width:"100%","font-family":"monospace","max-height":"600px",overflow:"auto",border:"1px solid #e8e8e8"}},{default:m(()=>[Object.keys(n.data).length?(u(!0),h(et,{key:1},at(Object.entries(n.data),([b,S])=>(u(),h("div",{key:b,class:"tree"},[b!=="legacyThreadData"||!l(S)?(u(),h("div",Jt,[w(r(R),{strong:""},{default:m(()=>[j(D(a(b)),1)]),_:2},1024),b==="request"?(u(),k(r(F),{key:0,title:r(v).translate("i18n_executioncontext_copy_request_tooltip")},{default:m(()=>[_("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:V=>H(S)},[w(r(tt))],8,Qt)]),_:2},1032,["title"])):A("",!0),b==="triggerTask"?(u(),k(r(F),{key:1,title:r(v).translate("i18n_executioncontext_copy_payload_tooltip")},{default:m(()=>[_("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:V=>i(S)},[w(r(tt))],8,Xt)]),_:2},1032,["title"])):A("",!0),w(r(yt),{"tree-data":r(wt)(S),selectable:!1},null,8,["tree-data"])])):A("",!0)]))),128)):(u(),k(r(R),{key:0,type:"secondary"},{default:m(()=>[j(D(r(v).translate("i18n_executioncontext_empty")),1)]),_:1}))]),_:1})]),_:1})]),_:1}))}}),fe=ot(Yt,[["__scopeId","data-v-f7630ec7"]]);export{fe as E,ge as L,ce as R,ue as a,de as u};
//# sourceMappingURL=ExecutionContext-BDiiNcGC.js.map
