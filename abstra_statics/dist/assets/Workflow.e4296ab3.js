var J=Object.defineProperty;var L=(o,t,e)=>t in o?J(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var n=(o,t,e)=>(L(o,typeof t!="symbol"?t+"":t,e),e);import{E as K,eK as k,d as Y,eA as Q,eB as X,G as _,a as Z,b as y,ev as O,f as u,w as p,u as d,c as m,ex as T,e as x,aq as E,eD as tt,I as et,cy as st,bg as it,e$ as at,f0 as rt,eO as nt,eE as ot,eF as dt,v as ht}from"./outputWidgets.737278d2.js";import{W as lt}from"./workspaces.4aa8b2bc.js";import{v as pt}from"./icons.00e0b192.js";import{N as ct}from"./NavbarControls.7fdef227.js";import{_ as ut}from"./SaveButton.vue_vue_type_script_setup_true_lang.00799bb9.js";import{s as B,w as f}from"./schema.88d7d5e2.js";import{a as gt}from"./asyncComputed.a421a144.js";import{A as wt,c as yt}from"./index.d81945ac.js";import{a as b}from"./Text.208da576.js";import{A as H,T as ft}from"./TabPane.a6437ae3.js";import{A as q}from"./index.6eceeb2d.js";import"./record.605beade.js";import"./pubsub.88c6ed51.js";import"./url.2a6e0213.js";import"./popupNotifcation.0314a85e.js";import"./index.0b1e2011.js";import"./DocsButton.vue_vue_type_script_setup_true_lang.fde3f549.js";import"./index.b108b24d.js";import"./index.fc2fbf76.js";import"./Title.17b695f3.js";import"./Link.c8e2f9ae.js";import"./Modal.2dd7ed00.js";import"./ant-design.38d76521.js";import"./index.10799228.js";import"./index.cf4c23b9.js";import"./hasIn.1648684d.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[t]="0c328032-168c-4a82-8dfc-1196dc538aa2",o._sentryDebugIdIdentifier="sentry-dbid-0c328032-168c-4a82-8dfc-1196dc538aa2")}catch{}})();const St={"Content-Type":"application/json"};class mt{async load(){const t=await fetch("/_editor/api/workflows");if(t.ok){const e=await t.json();return B.parse(e)}else throw new Error("Failed to fetch initial data")}async update(t){const e=await fetch("/_editor/api/workflows",{method:"PUT",headers:St,body:JSON.stringify(t)});if(e.ok){const s=await e.json();return B.parse(s)}else throw new Error("Failed to update workflow")}}function l(){return Math.random().toString(36).slice(2,9)}class S{constructor(t){this.changes=t}apply(t){return this.changes.reduce((e,s)=>s.apply(e),t)}reverse(){return new S(this.changes.map(t=>t.reverse()).reverse())}}class z{constructor(t){n(this,"removed");this.stageId=t,this.removed=null}apply(t){const e=t.stages.find(i=>i.id===this.stageId)||null;if(!e)throw new Error(`Stage ${this.stageId} not found`);const s=t.transitions.filter(i=>i.sourceStageId===this.stageId||i.targetStageId===this.stageId);return this.removed={stage:e,transitions:s},{stages:t.stages.filter(i=>i.id!==e.id),transitions:t.transitions.filter(i=>!s.find(r=>r.id===i.id))}}reverse(){if(!this.removed)throw new Error("Cannot reverse change that was not applied");const t=new N(this.removed.stage.type,this.removed.stage.title,this.removed.stage.position,this.removed.stage.id,this.removed.stage.props),e=this.removed.transitions.map(s=>new I(s.sourceStageId,s.targetStageId,s.type,s.id));return new S([t,...e])}}class N{constructor(t,e,s,i,r){n(this,"addedStage");this.stageType=t,this.nodeTitle=e,this.position=s,this.id=i,this.props=r,this.addedStage=null}assertStageDoesNotExist(t){if(t.stages.find(e=>e.id===this.id))throw new Error(`Stage ${this.id} already exists`)}assertValidStageType(){if(!f.stages.find(t=>t.typeName===this.stageType))throw new Error(`Invalid stage type ${this.stageType}`)}assertTransitionDoesNotExist(t){if(t.transitions.find(e=>e.sourceStageId===this.id||e.targetStageId===this.id))throw new Error("Stage already has transitions")}makePath(){switch(this.stageType){case"forms":return`new_form_${l()}`;case"hooks":return`new_hook_${l()}`;default:return null}}makeFilename(){switch(this.stageType){case"forms":return`new_form_${l()}.py`;case"hooks":return`new_hook_${l()}.py`;case"jobs":return`new_job_${l()}.py`;case"scripts":return`new_script_${l()}.py`;default:return null}}makeVariableName(){switch(this.stageType){case"conditions":return"my_condition";case"iterators":return"my_list";default:return null}}apply(t){var s,i;const e=(s=this.props)!=null?s:{path:this.makePath(),filename:this.makeFilename(),variableName:this.makeVariableName()};return this.assertStageDoesNotExist(t),this.assertValidStageType(),this.assertTransitionDoesNotExist(t),this.addedStage={id:(i=this.id)!=null?i:l(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:e},{transitions:t.transitions,stages:[...t.stages,this.addedStage]}}reverse(){if(!this.addedStage)throw new Error("Cannot reverse change that was not applied");return new z(this.addedStage.id)}}class Tt extends S{constructor(t){super(t.map(e=>new N(e.type,e.title,e.position,e.id)))}}class ${constructor(t,e){n(this,"oldTitle");this.stageId=t,this.newTitle=e,this.oldTitle=""}apply(t){const e=t.stages.find(s=>s.id===this.stageId);if(!e)throw new Error(`Stage ${this.stageId} not found`);return this.oldTitle=e.title,{stages:t.stages.map(s=>s.id===this.stageId?{...s,title:this.newTitle}:s),transitions:t.transitions}}reverse(){return new $(this.stageId,this.oldTitle)}}class U{constructor(t){n(this,"removedTransition");this.transitionId=t,this.removedTransition=null}apply(t){const e=t.transitions.find(s=>s.id===this.transitionId);if(!e)throw new Error(`Transition ${this.transitionId} not found`);return this.removedTransition=e!=null?e:null,{stages:t.stages,transitions:t.transitions.filter(s=>s.id!==this.transitionId)}}reverse(){if(!this.removedTransition)throw new Error("Cannot reverse change that was not applied");return new I(this.removedTransition.sourceStageId,this.removedTransition.targetStageId,this.removedTransition.type,this.removedTransition.id)}}class I{constructor(t,e,s,i){n(this,"addedTransition");this.sourceStageId=t,this.targetStageId=e,this.transitionType=s,this.transitionId=i,this.addedTransition=null}assertSourceStageExists(t){if(!t.stages.find(e=>e.id===this.sourceStageId))throw new Error(`Stage ${this.sourceStageId} not found`)}assertTargetStageExists(t){if(!t.stages.find(e=>e.id===this.targetStageId))throw new Error(`Stage ${this.targetStageId} not found`)}assertTransitionDoesNotExist(t){if(t.transitions.find(e=>e.id===this.transitionId))throw new Error(`Transition ${this.transitionId} already exists`)}assertNotSelfTransition(){if(this.sourceStageId===this.targetStageId)throw new Error("Self transitions are not allowed")}assertNoDuplicatedTransitionStages(t){if(t.transitions.find(e=>e.sourceStageId===this.sourceStageId&&e.targetStageId===this.targetStageId))throw new Error("Transition already exists")}assertValidTransitionType(t){const e=t.stages.find(r=>r.id===this.sourceStageId);if(!f.stages.find(r=>r.typeName===e.type).transitions.map(r=>r.typeName).includes(this.transitionType))throw new Error(`Invalid transition type ${this.transitionType}`)}assertNotStartingOnlyTargetStage(t){const e=t.stages.find(i=>i.id===this.targetStageId);if(f.stages.find(i=>i.typeName===e.type).startingOnly)throw new Error("Cannot transition to starting-only stage")}assertNoStageWithSameId(t){if(t.stages.find(e=>e.id===this.transitionId))throw new Error(`Stage with id ${this.transitionId} already exists`)}apply(t){var e;return this.assertSourceStageExists(t),this.assertTargetStageExists(t),this.assertTransitionDoesNotExist(t),this.assertNotSelfTransition(),this.assertNoDuplicatedTransitionStages(t),this.assertValidTransitionType(t),this.assertNotStartingOnlyTargetStage(t),this.assertNoStageWithSameId(t),this.addedTransition={id:(e=this.transitionId)!=null?e:l(),sourceStageId:this.sourceStageId,targetStageId:this.targetStageId,type:this.transitionType,props:{conditionValue:null}},{stages:t.stages,transitions:[...t.transitions,this.addedTransition]}}reverse(){if(!this.addedTransition)throw new Error("Cannot reverse change that was not applied");return new U(this.addedTransition.id)}}class P{constructor(t){n(this,"transitionId");this.transitionId=t}assertValidTransitionType(t){const e=t.transitions.find(a=>a.id===this.transitionId),s=t.stages.find(a=>a.id===e.targetStageId);if(!f.stages.find(a=>a.typeName===s.type).transitions.map(a=>a.typeName).includes(e.type))throw new Error(`Invalid transition type ${e.type}`)}apply(t){if(this.assertValidTransitionType(t),!t.transitions.find(s=>s.id===this.transitionId))throw new Error(`Transition ${this.transitionId} not found`);return{stages:t.stages,transitions:t.transitions.map(s=>s.id===this.transitionId?{...s,sourceStageId:s.targetStageId,targetStageId:s.sourceStageId}:s)}}reverse(){return new P(this.transitionId)}}class vt extends S{constructor(t){super(t.map(e=>new I(e.sourceStageId,e.targetStageId,e.type,e.id)))}}class C{constructor(t){n(this,"oldPositions");this.newPositions=t,this.oldPositions=null}assertStagesExists(t){this.newPositions.forEach(({id:e})=>{if(!t.stages.find(s=>s.id===e))throw new Error(`Stage ${e} not found`)})}assertIsNumber(){this.newPositions.forEach(({position:t})=>{if(Number.isNaN(t.x)||Number.isNaN(t.y)||!Number.isFinite(t.x)||!Number.isFinite(t.y))throw new Error("Position must be a number")})}apply(t){return this.assertIsNumber(),this.assertStagesExists(t),this.oldPositions=t.stages.map(s=>({id:s.id,position:s.position})),{stages:t.stages.map(s=>{var r,a;const i=(a=(r=this.newPositions.find(c=>c.id===s.id))==null?void 0:r.position)!=null?a:s.position;return{...s,position:{x:i.x,y:i.y}}}),transitions:t.transitions}}reverse(){if(!this.oldPositions)throw new Error("Cannot reverse change that was not applied");return new C(this.oldPositions)}}class D{constructor(t,e){n(this,"stageId");n(this,"newTitle");n(this,"oldTitle");this.stageId=t,this.newTitle=e,this.oldTitle=""}assertStageExists(t){if(!t.stages.find(e=>e.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}apply(t){return this.assertStageExists(t),this.oldTitle=t.stages.find(e=>e.id===this.stageId).title,{stages:t.stages.map(e=>e.id===this.stageId?{...e,title:this.newTitle}:e),transitions:t.transitions}}reverse(){return new D(this.stageId,this.oldTitle)}}class V{constructor(t,e){n(this,"stageId");n(this,"newType");n(this,"oldType");this.stageId=t,this.newType=e,this.oldType="forms"}assertStageExists(t){if(!t.stages.find(e=>e.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}assertValidStageType(){if(!f.stages.find(t=>t.typeName===this.newType))throw new Error(`Invalid stage type ${this.newType}`)}makePath(){switch(this.newType){case"forms":return`new_form_${l()}`;case"hooks":return`new_hook_${l()}`;default:return null}}makeFilename(){switch(this.newType){case"forms":return`new_form_${l()}`;case"hooks":return`new_hook_${l()}`;case"jobs":return`new_job_${l()}`;case"scripts":return`new_script_${l()}`;default:return null}}makeVariableName(){switch(this.newType){case"conditions":return"my_condition";case"iterators":return"my_list";default:return null}}apply(t){return this.assertStageExists(t),this.assertValidStageType(),this.oldType=t.stages.find(e=>e.id===this.stageId).type,{stages:t.stages.map(e=>e.id===this.stageId?{...e,type:this.newType,props:{path:this.makePath(),filename:this.makeFilename(),variableName:this.makeVariableName()}}:e),transitions:t.transitions}}reverse(){return new V(this.stageId,this.oldType)}}class A{constructor(t,e){n(this,"stageId");n(this,"newProps");n(this,"oldProps");this.stageId=t,this.newProps=e,this.oldProps={path:null,filename:null,variableName:null}}assertStageExists(t){if(!t.stages.find(e=>e.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}apply(t){return this.assertStageExists(t),this.oldProps=t.stages.find(e=>e.id===this.stageId).props,{stages:t.stages.map(e=>e.id===this.stageId?{...e,props:this.newProps}:e),transitions:t.transitions}}reverse(){return new A(this.stageId,this.oldProps)}}class W{constructor(t,e){n(this,"newType");n(this,"transitionId");this.newType=e,this.transitionId=t}apply(t){return{transitions:t.transitions.map(e=>e.id===this.transitionId?{...e,type:this.newType}:e),stages:t.stages}}reverse(){return new W(this.transitionId,this.newType)}}class M{constructor(t,e){n(this,"newProps");n(this,"transitionId");this.newProps=e,this.transitionId=t}apply(t){return{transitions:t.transitions.map(e=>e.id===this.transitionId?{...e,props:this.newProps}:e),stages:t.stages}}reverse(){return new M(this.transitionId,this.newProps)}}class It{constructor(t){n(this,"change");this.duplicatedStages=t,this.change=null}assertStagesExists(t){this.duplicatedStages.forEach(e=>{if(!t.stages.find(s=>s.id===e.id))throw new Error(`Stage ${e.id} not found`)})}apply(t){this.assertStagesExists(t);const e=this.duplicatedStages.map(l),s=this.duplicatedStages.map((a,c)=>new N(a.type,`${a.title} - Copy`,{x:a.position.x,y:a.position.y},e[c])),r=t.transitions.filter(a=>{const c=this.duplicatedStages.find(w=>w.id===a.sourceStageId),h=this.duplicatedStages.find(w=>w.id===a.targetStageId);return c&&h}).map(a=>{const c=e[this.duplicatedStages.findIndex(w=>w.id===a.sourceStageId)],h=e[this.duplicatedStages.findIndex(w=>w.id===a.targetStageId)];return new I(c,h,a.type)});return this.change=new S([...s,...r]),this.change.apply(t)}reverse(){if(!this.change)throw new Error("Cannot reverse change that was not applied");return this.change.reverse()}}class kt extends S{constructor(t,e){super([...e.map(s=>new U(s)),...t.map(s=>new z(s))])}}class F{constructor(t,e){n(this,"oldTransitionState");this.transitionId=t,this.newType=e,this.oldTransitionState=null}assertTransitionExists(t){if(!t.transitions.find(e=>e.id===this.transitionId))throw new Error(`Transition ${this.transitionId} not found`)}assertValidTransitionType(t){const e=t.transitions.find(a=>a.id===this.transitionId),s=t.stages.find(a=>a.id===e.sourceStageId);if(!f.stages.find(a=>a.typeName===s.type).transitions.map(a=>a.typeName).includes(this.newType))throw new Error(`Invalid transition type ${this.newType}`)}apply(t){this.assertTransitionExists(t),this.assertValidTransitionType(t);const e=t.transitions.find(s=>s.id===this.transitionId);return this.oldTransitionState=e,{stages:t.stages,transitions:t.transitions.map(s=>s.id===this.transitionId?{...s,type:this.newType}:s)}}reverse(){if(!this.oldTransitionState)throw new Error("Cannot reverse change that was not applied");return new F(this.transitionId,this.oldTransitionState.type)}}class _t{constructor(t){n(this,"currentState");n(this,"serverState");n(this,"undoStack");n(this,"redoStack");this.undoStack=[],this.redoStack=[],this.currentState=K(Object.freeze(t)),this.serverState=K(Object.freeze(t))}apply(t){return this.currentState.value=t.apply(this.currentState.value),this.undoStack.push(t),this.redoStack=[],this.currentState.value}undo(){const t=this.undoStack.pop();if(t){const e=t.reverse();this.currentState.value=e.apply(this.currentState.value),this.redoStack.push(t)}return this.currentState.value}redo(){const t=this.redoStack.pop();return t&&(this.currentState.value=t.apply(this.currentState.value),this.undoStack.push(t)),this.currentState.value}getState(){return this.currentState.value}setServerState(t){this.serverState.value=t}hasStageChanges(){return!k.exports.isEqual(this.currentState.value.stages,this.serverState.value.stages)}hasChanges(){const t={...this.currentState.value,stages:[...this.currentState.value.stages].sort((s,i)=>s.id.localeCompare(i.id)),transitions:[...this.currentState.value.transitions].sort((s,i)=>s.id.localeCompare(i.id))},e={...this.serverState.value,stages:[...this.serverState.value.stages].sort((s,i)=>s.id.localeCompare(i.id)),transitions:[...this.serverState.value.transitions].sort((s,i)=>s.id.localeCompare(i.id))};return!k.exports.isEqual(t,e)}stageHasChanges(t){const e=this.currentState.value.stages.find(i=>i.id===t),s=this.serverState.value.stages.find(i=>i.id===t);return!k.exports.isEqual(e,s)}}class j{constructor(t,e){n(this,"api");n(this,"history");this.api=t,this.history=new _t(e)}static async create(){const t=new mt,e=await t.load();return new j(t,e)}move(t){this.history.apply(new C(t))}revertTransition(t){this.history.apply(new P(t))}delete(t){const e=this.history.getState(),s=e.stages.filter(r=>t.includes(r.id)).map(r=>r.id),i=e.transitions.filter(r=>t.includes(r.id)).map(r=>r.id);this.history.apply(new kt(s,i))}addStages(t){return this.history.apply(new Tt(t.map(e=>{var s;return{...e,title:(s=e.title)!=null?s:`New ${e.type.slice(0,-1)}`}}))),this.history.getState().stages.slice(-t.length)}updateStageTitle(t,e){this.history.apply(new D(t,e))}updateStageType(t,e){this.history.apply(new V(t,e))}updateStageProps(t,e){this.history.apply(new A(t,e))}updateTransitionType(t,e){this.history.apply(new W(t,e))}updateTransitionProps(t,e){this.history.apply(new M(t,e))}duplicateStages(t){const e=this.history.getState(),s=this.history.apply(new It(t));return{stages:s.stages.filter(i=>!e.stages.find(r=>r.id===i.id)),transitions:s.transitions.filter(i=>!e.transitions.find(r=>r.id===i.id))}}ensureTransitionWithType(t){var a;const e=this.getStage(t.sourceStageId);if(!e)throw new Error(`Source stage ${t.sourceStageId} not found`);const s=e.type,i=f.stages.find(c=>c.typeName===s),r=i==null?void 0:i.transitions[0].typeName;if(!r)throw new Error(`No default transition type for ${s}`);return{sourceStageId:t.sourceStageId,targetStageId:t.targetStageId,type:(a=t.type)!=null?a:r}}addTransitions(t){this.history.apply(new vt(t.map(e=>this.ensureTransitionWithType(e))))}changeTransitionType(t,e){const s=new F(t,e);this.history.apply(s)}renameStage(t,e){const s=new $(t,e);this.history.apply(s)}async reload(){const t=await this.api.load();return this.history.setServerState(t),t}hasChanges(){return this.history.hasChanges()}stageHasChanges(t){return this.history.stageHasChanges(t)}async save(){if(this.history.hasChanges()){const t=await this.api.update(this.history.getState());this.history.setServerState(t)}}getStage(t){var e;return(e=this.history.getState().stages.find(s=>s.id===t))!=null?e:null}getTransition(t){var e;return(e=this.history.getState().transitions.find(s=>s.id===t))!=null?e:null}getState(){return this.history.getState()}}const Et=o=>(ot("data-v-632aa636"),o=o(),dt(),o),bt={class:"workflow"},xt={class:"title"},Nt={href:"/_editor/style"},$t=Et(()=>x("span",null,"Kanban",-1)),Pt={key:1},Ct=Y({__name:"Workflow",setup(o){const t=Q(),e=X();function s(){t.push({name:"home"})}const i=_(()=>{switch(e.name){case"workflowEditor":return"editor";case"workflowKanban":return"kanban";default:return}});function r(g){switch(g){case"editor":t.push({name:"workflowEditor"});break;case"kanban":t.push({name:"workflowKanban"});break}}const a=_(()=>{var g;return(g=h.value)==null?void 0:g.workspace.makeRunnerData().logoUrl}),c=_(()=>{var g;return(g=h.value)==null?void 0:g.workspace.makeRunnerData().brandName}),{result:h,loading:w}=gt(()=>Promise.all([lt.get(),j.create()]).then(([g,R])=>({workspace:g,workflow:R})));return(g,R)=>{const G=Z("router-view");return y(),O("div",bt,[u(d(yt),{style:{padding:"5px 25px"},onBack:s},{extra:p(()=>{var v;return[u(ct,{"editing-model":(v=d(h))==null?void 0:v.workflow,"show-v-s-code-button":"","show-save-button":""},null,8,["editing-model"])]}),avatar:p(()=>[a.value?(y(),m(d(wt),{key:0,src:a.value},null,8,["src"])):T("",!0),x("span",xt,[u(d(b),null,{default:p(()=>[E(tt(c.value||"New Workflow"),1)]),_:1}),x("a",Nt,[u(et,{path:d(pt),class:"edit-icon"},null,8,["path"])])])]),footer:p(()=>[d(h)?(y(),m(d(ft),{key:0,"active-key":i.value,onChange:r},{default:p(()=>[u(d(H),{key:"editor",tab:"Editor"}),u(d(H),{key:"kanban",disabled:d(h).workflow.hasChanges()},{tab:p(()=>[i.value!=="kanban"&&d(h).workflow.hasChanges()?(y(),m(d(st),{key:0,placement:"bottomLeft"},{title:p(()=>[u(d(q),null,{default:p(()=>[u(d(b),null,{default:p(()=>[E("You have unsaved changes")]),_:1})]),_:1})]),content:p(()=>[u(d(q),{vertical:"",gap:"small"},{default:p(()=>[u(d(b),null,{default:p(()=>[E(" Save them before switching to Kanban ")]),_:1}),d(h).workflow?(y(),m(ut,{key:0,model:d(h).workflow},null,8,["model"])):T("",!0)]),_:1})]),default:p(()=>[$t]),_:1})):(y(),O("span",Pt,"Kanban"))]),_:1},8,["disabled"])]),_:1},8,["active-key"])):T("",!0)]),_:1}),d(w)?(y(),m(d(it),{key:0})):T("",!0),u(G,null,{default:p(({Component:v})=>[d(h)?(y(),m(nt(v),at(rt({key:0},{workflowModel:d(h).workflow,workspaceModel:d(h).workspace})),null,16)):T("",!0)]),_:1})])}}});const re=ht(Ct,[["__scopeId","data-v-632aa636"]]);export{re as default};
//# sourceMappingURL=Workflow.e4296ab3.js.map
