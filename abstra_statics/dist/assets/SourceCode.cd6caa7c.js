var fe=Object.defineProperty;var me=(s,t,e)=>t in s?fe(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var j=(s,t,e)=>(me(s,typeof t!="symbol"?t+"":t,e),e);import{u as q}from"./uuid.79e6386b.js";import{F as oe,d as H,r as p,S as Z,G as D,b as h,ev as g,e as l,ez as A,eE as re,eF as le,v as N,eB as _e,H as J,a3 as ie,o as ce,K as ue,a as de,f,u as d,I as F,aq as M,eD as $,ex as L,ew as ye,bq as G,eC as be,c as Y,eP as we,eV as Ce,eH as ke,w as R,bH as pe}from"./outputWidgets.333243b5.js";import{e as ee,g as te,k as se,l as Se,n as xe,o as Ie}from"./icons.ec7238f6.js";import{l as Ee}from"./NavbarControls.d18ea1e3.js";import{H as Oe,J as Re,S as Fe,v as Le,n as He}from"./validations.0ebe149e.js";import{A as he}from"./FormItem.413481bf.js";import{W as Be}from"./workspaces.76ae478a.js";import{a as ne}from"./asyncComputed.916d2e38.js";import{l as Te,e as Ae,R as De}from"./toggleHighContrast.352551aa.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[t]="91bedb0e-25ea-4bf4-b664-cc748b2aa23f",s._sentryDebugIdIdentifier="sentry-dbid-91bedb0e-25ea-4bf4-b664-cc748b2aa23f")}catch{}})();class ve{constructor(){j(this,"logState",oe({log:[]}));j(this,"_listeners",{})}static create(){return new ve}get logs(){return this.logState.log}log(t,e){if(t.type!=="restart"&&t.log.trim()==="")return;const n=e?this.logs.find(o=>o.id===e):null;return n?Object.assign(n,t):this.logs.push({...t,id:e||q()}),this.notifyListeners(t),e}clear(){this.logState.log=[]}listen(t){const e=q();return this._listeners[e]=t,e}unlisten(t){delete this._listeners[t]}notifyListeners(t){Object.values(this._listeners).forEach(e=>e(t))}}class Me{static async*sendMessage(t,e){var r;const o=(r=(await fetch("/_editor/api/ai/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:t,runtime:e})})).body)==null?void 0:r.getReader();if(!o)throw new Error("No response body");for(;;){const c=await o.read();if(c.done)break;yield new TextDecoder().decode(c.value)}}}const $e=s=>(re("data-v-59ca7295"),s=s(),le(),s),ze=$e(()=>l("div",{class:"text"}," Changes were made in your code. Click Restart to refresh the preview window. ",-1)),ae="ignoreCodeChangesWarning",Ne=H({__name:"ChangesWarning",props:{hasChanges:{type:Boolean}},setup(s){var r;const t=s,e=p((r=Z.get(ae))!=null?r:!1),n=D(()=>t.hasChanges&&!e.value),o=()=>{Z.set(ae,!0),e.value=!0};return(c,y)=>(h(),g("div",{class:A(["changes-warning",{visible:n.value}])},[ze,l("div",{class:"no-more-alert",onClick:o},"Do not show again")],2))}});const Pe=N(Ne,[["__scopeId","data-v-59ca7295"]]),We=s=>(re("data-v-fa74f10a"),s=s(),le(),s),Ve={class:"smart-console"},Ke={class:"header"},Ue={class:"left"},je={class:"right"},qe={class:"changes-container"},Je=["unseen-severity"],Ge={class:"cli"},Ye={class:"left"},Qe=We(()=>l("div",{class:"entry ai-output"}," Hello there! I'm both an output console and AI assistant. You can ask me anything. ",-1)),Xe={key:1,class:"local-entry"},Ze={class:"input"},et=["pointer-events","onKeydown"],tt={class:"right"},st=H({__name:"SmartConsole",props:{inputEnabled:{type:Boolean},formCode:{},runtime:{},logService:{}},emits:["eval-request","clear-terminal","restart","enter"],setup(s,{emit:t}){const e=s,n=p(""),o=p(null),r=_e(),c=p({type:"seen"}),y=p(!1),x=p(!1),m=()=>{e.logService.clear(),t("restart")},C=()=>{E.value=E.value==="assistant"?"debugger":"assistant"};function I(i){switch(i.type){case"ai-input":return{role:"user",content:i.log};case"ai-output":return{role:"assistant",content:i.log};case"stderr":case"stdout":return{role:"user",content:i.log};case"restart":return{role:"user",content:"-- new session --"};case"files-changed":return{role:"user",content:"-- files changed --"};default:throw new Error(`Unknown log type: ${i.type}`)}}const _=D(()=>e.logService.logs.some(i=>i.type==="files-changed"));function v(){a.value=!a.value,a.value&&(c.value={type:"seen"})}J(r,()=>{e.logService.clear(),t("clear-terminal")});const b=p(null),E=p("assistant"),B=async i=>{var S;if(i.preventDefault(),n.value=((S=b.value)==null?void 0:S.innerText)||"",i.shiftKey){document.execCommand("insertLineBreak");return}b.value&&(b.value.innerText=""),E.value==="assistant"?await T():await P()},T=async()=>{var S;if(t("enter",n.value),e.logService.log({type:"ai-input",log:n.value}),n.value="",!x.value){e.logService.log({type:"stderr",log:"Please login to use the AI assistant."});return}y.value=!0;const i={role:"user",content:(S=e.formCode)!=null?S:""};try{const O=q();let w="";const K=Me.sendMessage([i,...e.logService.logs.map(U=>I(U)),{role:"user",content:n.value}],e.runtime);for await(const U of K)w+=U,e.logService.log({type:"ai-output",log:w},O)}catch(O){e.logService.log({type:"ai-output",log:"Sorry, I don't know how to answer that."}),console.error(O),Ce(O)}finally{y.value=!1}},P=async()=>{n.value&&(e.logService.log({type:"eval-input",log:`>>> ${n.value}`}),t("eval-request",n.value),n.value="")},u=()=>{e.logService.clear()};e.logService.listen(async i=>{a.value||(c.value={type:"unseen",count:c.value.type==="unseen"?c.value.count+1:1,severity:i.type==="stderr"?"error":"info"}),i.type!=="restart"&&(await ie(),o.value&&(o.value.scrollTop=o.value.scrollHeight))});const a=p(!1),k=p(400),W=D(()=>({height:`${k.value}px`})),V=p(!1),ge=()=>V.value=!0,Q=i=>{!V.value||(k.value=document.body.clientHeight-i.clientY)},X=()=>V.value=!1;return ce(()=>{document.addEventListener("mousemove",Q),document.addEventListener("mouseup",X),Ee.get().then(i=>{x.value=!!i.logged})}),ue(()=>{document.removeEventListener("mousemove",Q),document.removeEventListener("mouseup",X)}),(i,S)=>{const O=de("Markdown");return h(),g("div",Ve,[l("div",Ke,[l("div",Ue,[f(F,{path:E.value==="assistant"?d(ee):d(te)},null,8,["path"]),M(" Smart Console ")]),l("div",je,[l("div",qe,[f(Pe,{"has-changes":_.value},null,8,["has-changes"]),l("button",{class:"header-button",onClick:m},"Restart")]),l("div",{class:"toggle-button",onClick:v},[f(F,{class:A(["icon",{open:a.value}]),path:d(se),fill:"#fff"},null,8,["class","path"]),c.value.type==="unseen"?(h(),g("div",{key:0,class:"unseen-count","unseen-severity":c.value.severity},$(c.value.count),9,Je)):L("",!0)])])]),a.value?(h(),g("div",{key:0,class:"terminal",style:ye(W.value)},[l("div",{class:"resize-handler",onMousedown:ge},null,32),l("div",Ge,[l("div",Ye,[l("div",{ref_key:"entriesContainer",ref:o,class:"entries"},[Qe,(h(!0),g(G,null,be(e.logService.logs,(w,K)=>(h(),g("div",{key:K,class:A([w.type,"entry"])},[w.type==="ai-output"?(h(),Y(O,{key:0,source:w.log},null,8,["source"])):(h(),g("div",Xe,$(w.type==="restart"?"-- restarted --":w.log),1))],2))),128))],512),l("div",Ze,[f(F,{class:A(["icon",{open:a.value}]),path:d(se)},null,8,["class","path"]),l("div",{ref_key:"inputRef",ref:b,class:"input-text",contenteditable:"","pointer-events":y.value?"none":"auto",placeholder:"Ask AI anything",onKeydown:we(B,["enter"])},null,40,et)])]),l("div",tt,[l("div",{class:"icons",onClick:u},[f(F,{class:"icon",path:d(Se)},null,8,["path"])]),l("div",null,[f(F,{class:"icon clickable",path:E.value==="assistant"?d(ee):d(te),onClick:S[0]||(S[0]=w=>C())},null,8,["path"])])])])],4)):L("",!0)])}}});const yt=N(st,[["__scopeId","data-v-fa74f10a"]]),nt=H({__name:"PathInput",props:{runtime:{}},setup(s){const t=s,e=p(!1),n=async()=>{e.value=!0;const r=await(await fetch("/_editor/api/utils/normalize_path",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:t.runtime.path})})).text();r&&r!==t.runtime.path&&(t.runtime.path=r),e.value=!1};return(o,r)=>(h(),Y(d(pe),{value:o.runtime.path,"onUpdate:value":r[0]||(r[0]=c=>o.runtime.path=c),type:"text",disabled:e.value,onBlur:n},ke({_:2},[o.runtime instanceof d(Oe)?{name:"addonBefore",fn:R(()=>[M(" https://[your-subdomain].abstra.app/_hooks/ ")]),key:"0"}:{name:"addonBefore",fn:R(()=>[M(" https://[your-subdomain].abstra.app/ ")]),key:"1"}]),1032,["value","disabled"]))}}),at={key:1},ot=H({__name:"RuntimeCommonSettings",props:{runtime:{}},setup(s){const t=oe({pathError:null});return(e,n)=>(h(),g(G,null,[e.runtime instanceof d(Re)||e.runtime instanceof d(Fe)?L("",!0):(h(),Y(d(he),{key:0,label:"URL path"},{default:R(()=>[f(nt,{runtime:e.runtime},null,8,["runtime"])]),_:1})),t.pathError?(h(),g("div",at,$(t.pathError),1)):L("",!0)],64))}});const bt=N(ot,[["__scopeId","data-v-60a397e0"]]);let z={};function rt(s){return s in z?"\n\n```python\n"+s+" = "+z[s]+"\n```":""}Te.registerHoverProvider("python",{provideHover:function(s,t){const e=s.getWordAtPosition(t);if(!!e)return{contents:[{value:rt(e.word)}]}}});const lt=(s,t,e={})=>{var m;const n=Ae.create(s,{language:"python",value:t,minimap:{enabled:!1},readOnly:(m=e.readOnly)!=null?m:!1,contextmenu:!e.readOnly,automaticLayout:!e.readOnly,tabSize:4,fixedOverflowWidgets:!0,theme:e.theme?e.theme:"vs",fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:e.readOnly?0:5,scrollBeyondLastLine:!e.readOnly,renderLineHighlight:e.readOnly?"none":"all",scrollbar:{useShadows:!1,alwaysConsumeMouseWheel:!1}}),o=n.getContribution("editor.contrib.messageController");n.onDidAttemptReadOnlyEdit(()=>{o.showMessage("Use an external text editor",n.getPosition())});const r=n.createDecorationsCollection([]),c=(C,I)=>{r.set(C.map(_=>({range:new De(_.lineno,1,_.lineno,1),options:{isWholeLine:!0,className:I}}))),z=C.reduce((_,v)=>({..._,...v.locals}),{})};return{editor:n,highlight:C=>I=>{var v,b;const _=(b=(v=I.debug)==null?void 0:v.stack)!=null?b:[];c(_,C)},clearHighlights:()=>{r.clear(),z={}}}},it=H({__name:"SourceCode",props:{script:{},workspace:{},broker:{}},emits:["update-file"],setup(s,{emit:t}){const e=s,n=()=>{!e.script.file||e.workspace.openFile(e.script.file)},o=p(null);let r,c,y;const{result:x}=ne(()=>fetch("/_editor/api/workspace/root").then(u=>u.text())),m=p(e.script.file);J(()=>e.script.file,()=>m.value=e.script.file);const{result:C,refetch:I}=ne(()=>Be.checkFile(m.value)),_=()=>{v.value.valid?t("update-file",He(m.value)):t("update-file",m.value),I()},v=D(()=>{var a;const u=Le(m.value);return u.valid?((a=C.value)==null?void 0:a.exists)&&e.script.hasChanges("file")?{valid:!0,help:"This file already exists"}:e.script.hasChanges("file")?{valid:!0,help:"The original file will be renamed"}:u:u}),b=()=>{!e.workspace||!x.value||e.workspace.openFile(".")},E=async()=>{var a;if(e.script.hasChanges("file")||(a=e.broker)!=null&&a.isConnected()||!e.script.file)return;const u=await e.workspace.readFile(e.script.file);u!==r.getValue()&&r.setValue(u)};let B;ce(()=>{P(),B=setInterval(E,1e3)}),ue(()=>{clearInterval(B)}),J(()=>e.broker,()=>{c(),T()});const T=()=>{var u,a;(u=e.broker)==null||u.on("form",y("executing-line")),(a=e.broker)==null||a.on("program:end",k=>{k.exception?y("error-line")(k):c()})},P=async()=>{await ie(),e.workspace.readFile(e.script.file).then(u=>{const a=lt(o.value,u,{readOnly:!0});r=a.editor,c=a.clearHighlights,y=a.highlight,T()})};return(u,a)=>{const k=de("icon");return h(),g(G,null,[f(d(he),{"validate-status":v.value.valid?"success":"error",help:v.value.valid?v.value.help:v.value.reason},{default:R(()=>[f(d(pe),{value:u.script.file,"onUpdate:value":a[0]||(a[0]=W=>u.script.file=W),onBlur:_},{addonBefore:R(()=>[d(x)?(h(),g("span",{key:0,class:"clickable",onClick:b},[f(k,{path:d(xe)},null,8,["path"]),l("span",null,$(d(x)),1)])):L("",!0)]),addonAfter:R(()=>[l("span",{class:"clickable",onClick:n},[M(" Open in editor "),f(k,{path:d(Ie),width:"22"},null,8,["path"])])]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),l("div",{id:"code",ref_key:"codeComponent",ref:o,class:"code-container"},null,512)],64)}}});const wt=N(it,[["__scopeId","data-v-733c74dc"]]);export{ve as L,bt as R,wt as S,yt as a};
//# sourceMappingURL=SourceCode.cd6caa7c.js.map
