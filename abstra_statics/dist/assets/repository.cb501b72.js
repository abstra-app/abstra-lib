import{f as o,eG as de,r as Q,H as pe,F as ge,d as $,b as l,ev as S,w as a,aD as x,eC as O,eD as b,u as e,v as M,c,ar as h,cM as fe,cE as T,ex as A,bg as _e,eK as X,e as V,eJ as B,aH as me,cm as ee,eE as ye,eF as ve,a as te,cD as ae,ae as ne,bG as W,eA as he,o as ke,L as Se,dm as we}from"./outputWidgets.91c9f730.js";import{a as se}from"./asyncComputed.5cff1726.js";import"./workspaces.e0f5ccda.js";import{S as be}from"./scripts.8ea61e22.js";import"./envVars.bfc20846.js";import{A as Ae,s as oe}from"./api.9186109d.js";import{A as Re}from"./contracts.generated.cc987ccb.js";import{A as R}from"./index.5a63d36f.js";import{r as Ie,t as Ce}from"./icons.e854b740.js";import{t as De}from"./ant-design.b392f32d.js";import{A as H}from"./Text.2f03529d.js";import"./index.6a722ed0.js";import{A as z}from"./index.946fdb2e.js";import{f as $e}from"./index.f6bc8d33.js";import{A as Y}from"./Paragraph.18e7082b.js";import{A as q}from"./Title.69e80303.js";import"./index.91782368.js";import{T as Pe,A as xe}from"./Timeline.d06a0a15.js";import{A as re,C as le}from"./CollapsePanel.4c443ee5.js";import{A as Oe}from"./Link.dd2279d6.js";import{A as ie}from"./index.981556bf.js";import{A as Fe}from"./index.447513b5.js";import{E as Ee}from"./ExpandOutlined.a22b2405.js";import{C as Te}from"./Card.a8631760.js";import{D as Ue}from"./DownOutlined.7911c167.js";import"./index.4bd92eaa.js";import{F as Le,A as Ne}from"./Form.f24a1c0a.js";(function(){try{var n=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[t]="059d87a5-b891-408d-9879-6e82cfd6107f",n._sentryDebugIdIdentifier="sentry-dbid-059d87a5-b891-408d-9879-6e82cfd6107f")}catch{}})();var Ke={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM641.7 520.8L442.3 677.6c-7.4 5.8-18.3.6-18.3-8.8V355.3c0-9.4 10.9-14.7 18.3-8.8l199.4 156.7a11.2 11.2 0 010 17.6z"}}]},name:"play-square",theme:"filled"};const qe=Ke;function Z(n){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?Object(arguments[t]):{},r=Object.keys(i);typeof Object.getOwnPropertySymbols=="function"&&(r=r.concat(Object.getOwnPropertySymbols(i).filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable}))),r.forEach(function(s){Ve(n,s,i[s])})}return n}function Ve(n,t,i){return t in n?Object.defineProperty(n,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[t]=i,n}var G=function(t,i){var r=Z({},t,i.attrs);return o(de,Z({},r,{icon:qe}),null)};G.displayName="PlaySquareFilled";G.inheritAttrs=!1;const Be=G;function He(){const n=Q({state:"closed"});function t(){n.value={state:"closed"}}function i(){n.value={state:"visualizations"}}function r(u,_){n.value={state:"stage-run",stageRun:_}}const s=pe(()=>"stageRun"in n.value?n.value.stageRun:null);return{closeDrawer:t,openVisualizationEditor:i,inspectStageRun:r,drawerState:n,selectedStageRunForDrawer:s}}const U="kanban-selected-stage-ids",L=10,ze=({kanbanRepository:n,storage:t,filterFactory:i,router:r})=>{const s=ge([]),u=se(async()=>{try{const f=await n.getData({selection:s.value,filter:i()}),g=await t.get(U)||[];for(const m of f.not_found_stages)t.set(U,g.filter(v=>v!==m)),s.value=s.value.filter(v=>v.stage_id!==m);return f}catch{return s.value=[],await t.set(U,[]),{columns:[],next_stage_options:[]}}});function _(f){const g=f.selected_stage.id,m=s.value.find(v=>v.stage_id===g);return m!=null&&m.limit?m.limit<f.total_count:!1}async function p(f){var m;const g=s.value.find(v=>v.stage_id===f.selected_stage.id);g&&(g.limit=((m=g.limit)!=null?m:0)+L,await u.refetch())}async function d(f){const g=s.value.find(m=>m.stage_id===f);g&&g.limit&&g.limit>L&&(g.limit-=L,await u.refetch())}async function y(){const f=await t.get(U)||[];s.value=f.map(g=>({stage_id:g,limit:L,offset:0}))}async function I(f,g){f?s.value=[...s.value.slice(0,g),{stage_id:f.id,limit:L,offset:0},...s.value.slice(g+1)]:s.value=[...s.value.slice(0,g),...s.value.slice(g+1)],await t.set(U,s.value.map(m=>m.stage_id)),await u.refetch()}async function F(f){await I(f,s.value.length)}let k=null;return{kanbanAsyncComputed:u,selection:s,increasePagination:p,hasPagination:_,seeLess:d,setStage:I,addStage:F,cardActionHandler:async(f,g)=>{const m=f.selected_stage,v=g.id;if(m.type==="script"){const w=await be.get(m.id);if(!w)return;await w.run(v)}m.type==="form"&&r.push({path:`/${m.path}`,query:v?{[Ae]:v}:{}})},setup:async()=>{await y(),u.refetch(),k=setInterval(()=>{u.refetch()},1e3)},tearDown:()=>{k&&clearInterval(k)}}};function J(n){switch(n.status){case"waiting":return{color:"blue",text:"Waiting"};case"running":return{color:"processing",text:"Running"};case"finished":return{color:"success",text:"Success"};case"failed":return{color:"error",text:"Failed"};case"abandoned":return{color:"warning",text:"Abandoned"}}}const N="Show All",je=[N,...Re];function Me(){const n=Q(N);return{filterStatus:n,filterFactory:()=>n.value==N?{}:{status:n.value},labelOption:r=>r==N?N:J({status:r}).text}}const Ge={key:0},Je={key:1,class:"terminal"},We=$({__name:"ExecutionInspector",props:{logs:{}},setup(n){return(t,i)=>t.logs.length===0?(l(),S("span",Ge)):(l(),S("div",Je,[o(e(R),{vertical:""},{default:a(()=>[(l(!0),S(x,null,O(t.logs,r=>(l(),S("pre",{key:r.executionId,class:"log-text"},b(r.payload.text),1))),128))]),_:1})]))}});const Ye=M(We,[["__scopeId","data-v-4e71a195"]]),j=$({__name:"StageRunData",props:{data:{}},setup(n){return(t,i)=>(l(),c(e(T),{direction:"vertical",style:{overflow:"hidden"}},{default:a(()=>[(l(!0),S(x,null,O(t.data,r=>(l(),S("div",{key:r.key},[o(e(H),{strong:""},{default:a(()=>[h(b(r.key),1)]),_:2},1024),o(e(fe),{"tree-data":e(De)(r.value),selectable:!1},null,8,["tree-data"])]))),128))]),_:1}))}}),Ze=n=>(ye("data-v-68c9e478"),n=n(),ve(),n),Qe={key:1},Xe={key:1},et=Ze(()=>V("span",null,"[Deleted Stage]",-1)),tt=["onClick"],at=$({__name:"StageRunInspector",props:{stageRun:{},kanbanRepository:{},stageRunRepository:{}},emits:["close"],setup(n,{emit:t}){const i=n;function r(p){return Object.entries(p).map(([d,y])=>({key:d,value:y,type:typeof y}))}const{result:s,loading:u}=se(()=>{var p;return i.kanbanRepository.getLogs((p=i.stageRun)==null?void 0:p.id)}),_=(p,d)=>{var y;p.stopPropagation(),(y=i.stageRunRepository)==null||y.fork(d),t("close")};return(p,d)=>(l(),c(e(Fe),{open:"",title:"Thread details",size:"large",onClose:d[0]||(d[0]=y=>t("close"))},{extra:a(()=>[o(e(Y),null,{default:a(()=>[o(e(z),{style:{"font-weight":"600"}},{default:a(()=>{var y;return[h(b(e(J)({status:(y=p.stageRun)==null?void 0:y.status}).text),1)]}),_:1}),h(" "+b(e($e)(new Date(p.stageRun.created_at),{addSuffix:!0})),1)]),_:1})]),default:a(()=>{var y,I,F;return[(y=p.stageRun)!=null&&y.assignee?(l(),c(e(Y),{key:0},{default:a(()=>{var k;return[h(" Assignee: "+b((k=p.stageRun)==null?void 0:k.assignee),1)]}),_:1})):A("",!0),((I=p.stageRun)==null?void 0:I.content)&&((F=p.stageRun)==null?void 0:F.content.length)>0?(l(),S("div",Qe,[o(e(q),{level:4},{default:a(()=>[h("Current data")]),_:1}),o(j,{data:p.stageRun.content},null,8,["data"])])):A("",!0),o(e(q),{level:4,style:{"margin-bottom":"30px"}},{default:a(()=>[h(" Timeline ")]),_:1}),e(u)?(l(),c(e(_e),{key:2})):e(s)?(l(),c(e(Pe),{key:3},{default:a(()=>[(l(!0),S(x,null,O(e(s),({stage:k,stage_run:C,logs:P})=>(l(),c(e(xe),{key:C.id},{default:a(()=>[o(e(le),{ghost:"","expand-icon-position":"end"},{default:a(()=>[o(e(re),{class:"panel"},X({header:a(()=>[k?(l(),c(e(R),{key:0,align:"center",gap:15},{default:a(()=>[o(B,{path:e(oe)(k.type)},null,8,["path"]),P.length?(l(),S("span",Xe,b(k.title),1)):(l(),c(e(me),{key:0,placement:"right",title:"No logs"},{default:a(()=>[h(b(k.title),1)]),_:2},1024))]),_:2},1024)):(l(),c(e(R),{key:1,align:"center",gap:15},{default:a(()=>[o(B,{path:e(Ce)},null,8,["path"]),et]),_:1}))]),default:a(()=>[r(C.data).length||P.length?(l(),c(e(R),{key:0,vertical:""},{default:a(()=>[r(C.data).length?(l(),c(e(R),{key:0,gap:0,vertical:""},{default:a(()=>[o(e(q),{level:5},{default:a(()=>[h(" Output data ")]),_:1}),o(j,{data:r(C.data)},null,8,["data"])]),_:2},1024)):A("",!0),P.length?(l(),c(e(R),{key:1,vertical:"",gap:0},{default:a(()=>[o(e(ie)),o(e(q),{level:5},{default:a(()=>[h(" Logs ")]),_:1}),o(Ye,{logs:P},null,8,["logs"])]),_:2},1024)):A("",!0)]),_:2},1024)):(l(),c(e(ee),{key:1,description:"No logs"}))]),_:2},[p.stageRunRepository&&k?{name:"extra",fn:a(()=>[V("span",{onClick:K=>_(K,C.id)},[o(e(R),{gap:"small"},{default:a(()=>[o(B,{path:e(Ie),width:"22"},null,8,["path"]),o(e(Oe),null,{default:a(()=>[h("Fork")]),_:1})]),_:1})],8,tt)]),key:"0"}:void 0]),1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):A("",!0)]}),_:1}))}});const nt=M(at,[["__scopeId","data-v-68c9e478"]]),st=$({__name:"Card",props:{stage:{},card:{}},emits:["inspect","action"],setup(n){const i=J({status:n.card.status}).text;return(r,s)=>{var u;return l(),c(e(Te),{size:"small",style:{width:"275px",cursor:"pointer"},"body-style":{display:((u=r.card.content)==null?void 0:u.length)>0?"block":"none"}},X({title:a(()=>[o(e(z),null,{default:a(()=>[h(b(e(i)),1)]),_:1})]),default:a(()=>[o(e(T),{direction:"vertical",style:{"min-height":"150px","max-height":"300px",width:"100%",overflow:"hidden"},onClick:s[0]||(s[0]=_=>r.$emit("inspect"))},{default:a(()=>[o(j,{data:r.card.content,disabled:!0},null,8,["data"]),r.card.assignee?(l(),c(e(z),{key:0},{default:a(()=>[h(b(r.card.assignee),1)]),_:1})):A("",!0)]),_:1})]),extra:a(()=>[o(e(Ee),{onClick:s[2]||(s[2]=_=>r.$emit("inspect"))})]),_:2},[r.card.status==="waiting"?{name:"actions",fn:a(()=>[o(e(Be),{onClick:s[1]||(s[1]=_=>r.$emit("action"))})]),key:"0"}:void 0]),1032,["body-style"])}}}),ue=$({__name:"ColumnHeader",props:{stageOptions:{},stage:{},stageCount:{}},emits:["stageUpdate"],setup(n,{emit:t}){const i=n,r=s=>{const u=i.stageOptions.find(_=>_.id===s);t("stageUpdate",u!=null?u:null)};return(s,u)=>{var p;const _=te("icon");return l(),c(e(ne),{style:{width:"275px"},"allow-clear":"",value:((p=s.stage)==null?void 0:p.id)||"","onUpdate:value":r},{suffixIcon:a(()=>[o(e(H),{type:"secondary",style:{"font-size":"small","margin-right":"2px"}},{default:a(()=>[h(b(s.stageCount),1)]),_:1}),o(e(ie),{type:"vertical"}),o(e(Ue))]),default:a(()=>[(l(!0),S(x,null,O(s.stageOptions,d=>(l(),c(e(ae),{key:d.id,value:d.id},{default:a(()=>[o(e(R),{gap:"10",style:{"max-width":"200px"}},{default:a(()=>[o(_,{path:e(oe)(d.type),style:{"flex-shrink":"0",width:"24px"}},null,8,["path"]),o(e(H),{ellipsis:"",content:d.title},null,8,["content"])]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])}}});class ot{constructor(t){this.column=t}get stage(){return this.column.selected_stage}get launchLink(){return!this.stage.can_be_started||this.stage.type!=="form"?null:{path:`/${this.stage.path}`,query:{}}}}const rt=$({__name:"Column",props:{hasPagination:{type:Boolean},column:{}},emits:["increasePagination","cardInspection","cardAction","stageUpdate"],setup(n,{emit:t}){const i=n,s=new ot(i.column).launchLink;return(u,_)=>{const p=te("router-link");return l(),c(e(T),{direction:"vertical"},{default:a(()=>[o(ue,{"stage-options":u.column.stages,stage:u.column.selected_stage,"stage-count":u.column.total_count,onStageUpdate:_[0]||(_[0]=d=>t("stageUpdate",d))},null,8,["stage-options","stage","stage-count"]),o(e(T),{direction:"vertical",style:{width:"100%"}},{default:a(()=>[u.column.stage_run_cards.length===0?(l(),c(e(ee),{key:0})):A("",!0),(l(!0),S(x,null,O(u.column.stage_run_cards,d=>(l(),c(st,{key:d.id,stage:u.column.selected_stage,card:d,onInspect:y=>t("cardInspection",d),onAction:y=>t("cardAction",d)},null,8,["stage","card","onInspect","onAction"]))),128)),u.hasPagination?(l(),c(e(W),{key:1,style:{width:"100%"},onClick:_[1]||(_[1]=d=>t("increasePagination"))},{default:a(()=>[h("See more")]),_:1})):A("",!0),e(s)?(l(),c(p,{key:2,target:"_blank",to:e(s)},{default:a(()=>[o(e(W),{style:{width:"100%"}},{default:a(()=>[h(" Start ")]),_:1})]),_:1},8,["to"])):A("",!0)]),_:1})]),_:1})}}}),lt=$({__name:"EmptyColumn",props:{stages:{}},emits:["stageUpdate"],setup(n,{emit:t}){const i=r=>{t("stageUpdate",r)};return(r,s)=>(l(),c(e(T),{direction:"vertical"},{default:a(()=>[o(ue,{"stage-options":r.stages,onStageUpdate:i},null,8,["stage-options"])]),_:1}))}}),it={style:{width:"100%",padding:"20px"}},ut={class:"stages-container"},ct={class:"stages-content"},dt=$({__name:"Kanban",props:{storage:{},kanbanRepository:{},stageRunRepository:{}},setup(n){const t=n,i=he(),{closeDrawer:r,inspectStageRun:s,drawerState:u,selectedStageRunForDrawer:_}=He(),{filterFactory:p,filterStatus:d,labelOption:y}=Me(),{kanbanAsyncComputed:I,setStage:F,addStage:k,setup:C,tearDown:P,cardActionHandler:K,increasePagination:f,hasPagination:g}=ze({kanbanRepository:t.kanbanRepository,storage:t.storage,filterFactory:p,router:i});return ke(C),Se(P),(m,v)=>(l(),S("div",it,[o(e(R),{vertical:"",style:{height:"100%"}},{default:a(()=>[o(e(le),{ghost:""},{default:a(()=>[o(e(re),{header:"Filters"},{default:a(()=>[o(e(Le),null,{default:a(()=>[o(e(Ne),{label:"Status"},{default:a(()=>[o(e(ne),{value:e(d),"onUpdate:value":v[0]||(v[0]=w=>we(d)?d.value=w:null),style:{width:"325px"}},{default:a(()=>[(l(!0),S(x,null,O(e(je),w=>(l(),c(e(ae),{key:w,value:w},{default:a(()=>[h(b(e(y)(w)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),V("div",ut,[V("div",ct,[o(e(T),{align:"start"},{default:a(()=>{var w;return[(l(!0),S(x,null,O(((w=e(I).result.value)==null?void 0:w.columns)||[],(D,ce)=>(l(),c(e(rt),{key:D.selected_stage.id,column:D,"has-pagination":e(g)(D),onIncreasePagination:E=>e(f)(D),onCardInspection:E=>e(s)(D,E),onCardAction:E=>e(K)(D,E),onStageUpdate:E=>e(F)(E,ce)},null,8,["column","has-pagination","onIncreasePagination","onCardInspection","onCardAction","onStageUpdate"]))),128)),o(e(lt),{stages:e(I).result.value.next_stage_options||[],onStageUpdate:v[1]||(v[1]=D=>e(k)(D))},null,8,["stages"])]}),_:1})])])]),_:1}),e(u).state==="stage-run"&&e(_)?(l(),c(e(nt),{key:0,"kanban-repository":t.kanbanRepository,"stage-run":e(_),"stage-run-repository":t.stageRunRepository,onClose:e(r)},null,8,["kanban-repository","stage-run","stage-run-repository","onClose"])):A("",!0)]))}});const Kt=M(dt,[["__scopeId","data-v-f660bc8e"]]);class qt{constructor(t,i=localStorage){this.contextKey=t,this.storage=i}makeKey(t){return`${this.contextKey}:${t}`}async get(t){const i=this.storage.getItem(this.makeKey(t));return i?JSON.parse(i):null}async set(t,i){this.storage.setItem(this.makeKey(t),JSON.stringify(i))}}export{Kt as K,qt as L};
//# sourceMappingURL=repository.cb501b72.js.map
