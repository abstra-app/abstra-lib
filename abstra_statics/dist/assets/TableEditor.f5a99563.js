import{d as P,r as E,G as N,F as ee,b as u,eu as $,f as t,w as a,b8 as q,aA as k,eD as R,ew as U,e as _,u as e,cF as te,b$ as x,cM as ae,cK as j,eC as M,c as D,bU as L,eH as Z,ad as H,cJ as le,a as G,t as J,H as ce,eA as ne,eE as oe,eF as se,eB as pe,eG as me}from"./outputWidgets.be869244.js";import{B as fe}from"./BaseLayout.860b2b28.js";import{p as ue,T as ve}from"./tables.6f07e79d.js";import{a as ie}from"./asyncComputed.22c467bd.js";import{p as z}from"./popupNotifcation.56aa6f55.js";import{A as Q,a as K}from"./index.58e8ed53.js";import{A as re}from"./index.9a39d75e.js";import{F as W,A}from"./Base.402efeb6.js";import"./router.58afb527.js";import"./columns.39b62365.js";import{H as be,w as ye,I as ge}from"./icons.bdc5c208.js";import{L as _e}from"./CircularLoading.26783e5b.js";import{P as he}from"./project.b473bbff.js";import{O as ke}from"./organization.27b898b7.js";import{T as Ce,A as V}from"./TabPane.1edd9d3d.js";import{B as we,a as De,c as $e}from"./index.5a58d51c.js";import"./gateway.178cd360.js";import"./activeRecord.37f03962.js";import"./pubsub.b34d2fda.js";import"./string.1d9ffe03.js";import"./isNumeric.75337b1e.js";import"./transButton.b7be824a.js";import"./Text.2d270728.js";import"./Title.bfbbb427.js";import"./index.3ed139f2.js";(function(){try{var f=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},m=new Error().stack;m&&(f._sentryDebugIds=f._sentryDebugIds||{},f._sentryDebugIds[m]="d3d45975-b513-44d9-892d-1ff82c6aa619",f._sentryDebugIdIdentifier="sentry-dbid-d3d45975-b513-44d9-892d-1ff82c6aa619")}catch{}})();const Ie={class:"table-data",style:{width:"calc(100% - 80px)"}},Se={key:1},Ue=["onClick"],Te=_("a",null,"Delete",-1),Ae=P({__name:"TableData",props:{table:{}},setup(f){var d;const m=f,o=E(1),l=E(5),I=N(()=>{var b,y;return{total:(y=(b=c.value)==null?void 0:b.total)!=null?y:0,current:o.value,pageSize:l.value,onChange:async(w,F)=>{o.value=w,l.value=F,await C()}}}),{result:c,loading:v,refetch:C}=ie(()=>m.table.select({},(o.value-1)*l.value,l.value)),p=N(()=>{var y;return[...(y=m.table)==null?void 0:y.getColumns().map(w=>({title:w.name,dataIndex:w.name})),{title:"Actions",key:"action",fixed:"right",width:100,align:"center"}]}),s=N(()=>{var b;return((b=c.value)==null?void 0:b.rows.map(y=>({key:y.id,...y})))||[]}),T=E(!1),r=E({}),g=()=>{T.value=!0},S=()=>{r.value={},T.value=!1};let B=ee((d=m.table)==null?void 0:d.getUnprotectedColumns().reduce((b,y)=>({...b,[y.name]:""}),{}));async function i(){if(!(!m.table||!B))try{r.value.id?await m.table.updateRow(r.value.id,r.value):await m.table.insertRow(r.value),r.value={},C(),S()}catch(b){b instanceof Error&&z("Database error",b.message)}}const n=async b=>{if(!(!c.value||!c.value.rows.find(y=>y.id===b)))try{await m.table.deleteRow(b),C()}catch(y){y instanceof Error&&z("Database error",y.message)}},h=b=>{var y;r.value=Z.exports.pick(Z.exports.cloneDeep((y=s.value)==null?void 0:y.filter(w=>b===w.key)[0]),m.table.getColumns().map(w=>w.name)),g()};return(b,y)=>(u(),$("div",Ie,[t(e(ae),{columns:p.value,"data-source":s.value,pagination:I.value,bordered:"",loading:e(v),scroll:{x:2e3,y:720}},{bodyCell:a(({column:w,text:F,record:Y})=>[p.value.map(O=>O.title).includes(w.dataIndex)?(u(),$(q,{key:0},[k(R(F),1)],64)):U("",!0),w.key==="action"?(u(),$("div",Se,[_("span",null,[_("a",{onClick:O=>h(Y.id)},"Edit",8,Ue)]),t(e(re),{type:"vertical"}),t(e(te),{title:"Sure to delete?",onConfirm:O=>n(Y.id)},{default:a(()=>[Te]),_:2},1032,["onConfirm"])])):U("",!0)]),footer:a(()=>[t(e(x),{type:"primary",onClick:g},{default:a(()=>[k("+ Add New Data")]),_:1})]),_:1},8,["columns","data-source","pagination","loading"]),t(e(Q),{title:"Data",width:720,open:T.value,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:S},{extra:a(()=>[t(e(j),null,{default:a(()=>[t(e(x),{onClick:S},{default:a(()=>[k("Cancel")]),_:1}),t(e(x),{type:"primary",onClick:i},{default:a(()=>[k("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(W),{model:r.value,layout:"vertical"},{default:a(()=>[(u(!0),$(q,null,M(b.table.getUnprotectedColumns(),w=>(u(),D(e(A),{key:w.id,label:w.name},{default:a(()=>[r.value?(u(),D(e(L),{key:0,value:r.value[w.name],"onUpdate:value":F=>r.value[w.name]=F},null,8,["value","onUpdate:value"])):U("",!0)]),_:2},1032,["label"]))),128))]),_:1},8,["model"])]),_:1},8,["open"])]))}});const xe=P({__name:"NewColumn",props:{open:{type:Boolean},table:{}},emits:["created","cancel"],setup(f,{emit:m}){const o=f,l=E({name:"",type:"varchar",nullable:!0,unique:!1}),I=()=>{l.value={name:"",type:"varchar",nullable:!0,unique:!1}};function c(){m("cancel")}async function v(){if(!o.table||!l.value.name||!l.value.type)return;const{success:C,error:p}=await o.table.addColumn(l.value);C||z("Database error",p),I(),m("created")}return(C,p)=>(u(),D(e(Q),{title:"New column",width:720,open:o.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:c},{extra:a(()=>[t(e(j),null,{default:a(()=>[t(e(x),{onClick:c},{default:a(()=>[k("Cancel")]),_:1}),t(e(x),{type:"primary",onClick:v},{default:a(()=>[k("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(W),{model:l.value,layout:"vertical"},{default:a(()=>[t(e(A),{key:"name",label:"Name"},{default:a(()=>[t(e(L),{value:l.value.name,"onUpdate:value":p[0]||(p[0]=s=>l.value.name=s)},null,8,["value"])]),_:1}),t(e(A),{key:"type",label:"Type"},{default:a(()=>[t(e(H),{value:l.value.type,"onUpdate:value":p[1]||(p[1]=s=>l.value.type=s),"default-active-first-option":""},{default:a(()=>[(u(!0),$(q,null,M(e(ue),s=>(u(),D(e(le),{key:s,value:s},{default:a(()=>[k(R(s),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),t(e(A),{key:"nullable",label:"Nullable"},{default:a(()=>[t(e(K),{checked:l.value.nullable,"onUpdate:checked":p[2]||(p[2]=s=>l.value.nullable=s)},null,8,["checked"])]),_:1}),t(e(A),{key:"unique",label:"Unique"},{default:a(()=>[t(e(K),{checked:l.value.unique,"onUpdate:checked":p[3]||(p[3]=s=>l.value.unique=s)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"]))}}),Be={class:"types-container"},Ee={class:"fullwidth-input"},Ne={class:"fullwidth-input"},qe={class:"using-container"},Re={class:"fullwidth-input"},ze=P({__name:"UpdateColumn",props:{open:{type:Boolean},table:{},column:{}},emits:["updated","cancel"],setup(f,{emit:m}){const o=f;function l(){m("cancel")}const I=()=>o.column.record.hasChangesDeep("type"),c=E({type:"default"});function v(i,n){return n==="varchar"||i==="int"&&n==="boolean"||i==="boolean"&&n==="int"}const C=()=>{s.value&&(c.value={type:"user-defined",using:S.value,mandatory:!0})},p=N(()=>c.value.type==="default"&&v(o.column.record.initialState.type,o.column.type)),s=N(()=>!v(o.column.record.initialState.type,o.column.type));function T(i){i?c.value={type:"default"}:c.value={type:"user-defined",using:S.value,mandatory:!1}}function r(i){if(c.value.type==="default")throw new Error("Can't change using when using default casting");c.value.using=i!=null?i:""}const g=()=>s.value?!0:I()&&c.value.type==="user-defined",S=N(()=>`${o.column.record.initialState.name}::${o.column.type}`);async function B(){if(!o.column)return;const i=c.value.type==="default"?S.value:c.value.using;try{await o.column.update(i),m("updated")}catch(n){n instanceof Error&&z("Database error",n.message)}}return(i,n)=>{const h=G("icon");return u(),D(e(Q),{title:"Edit column",width:720,open:o.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:l},{extra:a(()=>[t(e(j),null,{default:a(()=>[t(e(x),{onClick:l},{default:a(()=>[k("Cancel")]),_:1}),t(e(x),{type:"primary",onClick:B},{default:a(()=>[k("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(W),{model:i.column,layout:"vertical"},{default:a(()=>[t(e(A),{key:"name",label:"Name"},{default:a(()=>[t(e(L),{value:i.column.name,"onUpdate:value":n[0]||(n[0]=d=>i.column.name=d)},null,8,["value"])]),_:1}),_("div",Be,[_("span",Ee,[t(e(A),{key:"type",label:"Current Type"},{default:a(()=>[t(e(H),{value:i.column.record.initialState.type,"onUpdate:value":n[1]||(n[1]=d=>i.column.record.initialState.type=d),"default-active-first-option":"",disabled:""},null,8,["value"])]),_:1})]),t(h,{class:"right-arrow",path:e(be)},null,8,["path"]),_("span",Ne,[t(e(A),{key:"new-type",label:"New Type"},{default:a(()=>[t(e(H),{value:i.column.type,"onUpdate:value":n[2]||(n[2]=d=>i.column.type=d),"default-active-first-option":"",onChange:n[3]||(n[3]=d=>C())},{default:a(()=>[(u(!0),$(q,null,M(e(ue),d=>(u(),D(e(le),{key:d,value:d},{default:a(()=>[k(R(d),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})])]),_("div",qe,[I()?(u(),D(e(A),{key:"default-casting",label:"Use default casting"},{default:a(()=>[t(e(K),{checked:p.value,disabled:s.value,"onUpdate:checked":n[4]||(n[4]=d=>T(!!d))},null,8,["checked","disabled"])]),_:1})):U("",!0),_("span",Re,[I()?(u(),D(e(A),{key:"using",label:"Using"},{default:a(()=>[t(e(L),{value:c.value.type==="user-defined"?c.value.using:S.value,disabled:!g(),onInput:n[5]||(n[5]=d=>r(d.target.value))},null,8,["value","disabled"])]),_:1})):U("",!0)])]),t(e(A),{key:"nullable",label:"Nullable"},{default:a(()=>[t(e(K),{checked:i.column.nullable,"onUpdate:checked":n[6]||(n[6]=d=>i.column.nullable=d)},null,8,["checked"])]),_:1}),t(e(A),{key:"unique",label:"Unique"},{default:a(()=>[t(e(K),{checked:i.column.unique,"onUpdate:checked":n[7]||(n[7]=d=>i.column.unique=d)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])}}});const Pe=J(ze,[["__scopeId","data-v-e474c12f"]]),de=f=>(oe("data-v-4f8ba920"),f=f(),se(),f),Fe={class:"table-settings"},Ke={key:0},je=de(()=>_("span",null," protected ",-1)),Le=[je],Me={key:1},Oe=["onClick"],Ve=de(()=>_("a",null,"Delete",-1)),He=P({__name:"TableColumns",props:{table:{},loading:{type:Boolean}},emits:["refresh"],setup(f,{emit:m}){var i;const o=f,l=E(o.loading);ce(()=>o.loading,()=>{l.value=o.loading});const I=ne();(i=o.table)==null||i.onUpdate(()=>{var n;I.replace({name:"tableEditor",params:{tableName:(n=o.table)==null?void 0:n.name}})});const v=[...[{title:"Name",dataIndex:"name"},{title:"Type",dataIndex:"type"},{title:"Default Value",dataIndex:"default"},{title:"Nullable",dataIndex:"nullable"},{title:"Primary Key",dataIndex:"primaryKey"}],{title:"Actions",key:"action"}],C=N(()=>{var n;return(n=o.table)==null?void 0:n.getColumns().map(h=>({name:h.name,type:h.type,default:h.default,nullable:h.nullable,primaryKey:h.primaryKey,id:h.id,unique:h.unique}))});function p(){r.value={type:"idle"}}function s(){p(),l.value=!0,setTimeout(()=>{m("refresh")},500)}function T(){r.value={type:"creating"}}const r=E({type:"idle"});function g(n){var h,d;(d=(h=o.table)==null?void 0:h.getColumn(n))==null||d.delete(),l.value=!0,setTimeout(()=>{m("refresh")},500)}const S=n=>{var h,d,b;return(b=(d=(h=o.table)==null?void 0:h.getColumn(n))==null?void 0:d.protected)!=null?b:!1},B=n=>{if(!o.table)throw new Error("Table not found");r.value={type:"editing",column:o.table.getColumn(n)}};return(n,h)=>(u(),$("div",Fe,[t(e(ae),{columns:v,"data-source":C.value,bordered:"",loading:l.value,pagination:!1},{bodyCell:a(({column:d,text:b,record:y})=>[d.key!=="action"?(u(),$(q,{key:0},[k(R(b),1)],64)):(u(),$(q,{key:1},[S(y.id)?(u(),$("div",Ke,Le)):(u(),$("div",Me,[_("span",null,[_("a",{onClick:()=>B(y.id)},"Edit",8,Oe)]),t(e(re),{type:"vertical"}),t(e(te),{title:"Sure to delete?",onConfirm:w=>g(y.id)},{default:a(()=>[Ve]),_:2},1032,["onConfirm"])]))],64))]),footer:a(()=>[t(e(x),{type:"primary",onClick:T},{default:a(()=>[k("+ Add New Column")]),_:1})]),_:1},8,["data-source","loading"]),n.table&&r.value.type==="creating"?(u(),D(xe,{key:0,open:"",table:o.table,onClose:p,onCreated:s},null,8,["table"])):U("",!0),n.table&&r.value.type==="editing"?(u(),D(Pe,{key:1,column:r.value.column,open:"",table:n.table,onUpdated:s,onClose:p,onCancel:p},null,8,["column","table"])):U("",!0)]))}});const Ge=J(He,[["__scopeId","data-v-4f8ba920"]]),X=f=>(oe("data-v-06f57b7a"),f=f(),se(),f),Je={class:"table-settings"},Qe=X(()=>_("h2",{class:"title"},"Table settings",-1)),We=X(()=>_("div",{class:"subtitle"},"Edit table metadata",-1)),Xe={key:0,class:"table-presenter"},Ye={class:"table-property-item"},Ze={class:"property-item"},et={key:1},tt={class:"change-warning"},at={class:"section-title"},lt=X(()=>_("div",{class:"section-body"}," Changing the table's name can possibly result in the break of running applications. ",-1)),nt={class:"table-name-value-input"},ot={key:0,class:"error"},st=P({__name:"TableSettings",props:{table:{}},emits:["refresh"],setup(f,{emit:m}){const o=f,l=ee({error:"",editing:!1,loading:!1}),I=()=>l.editing=!0,c=()=>{o.table.resetChanges(),l.editing=!1,l.error=""},v=async()=>{l.error="",l.loading=!0;try{await C()}catch(s){s instanceof Error&&(z("Database error",s.message),l.error=s.message)}l.error||(l.editing=!1),l.loading=!1},C=async()=>{if(!o.table.name){l.error="Table name cannot be empty";return}try{await o.table.save(),m("refresh")}catch(s){s instanceof Error&&(z("Database error",s.message),l.error=s.message)}},p=s=>{o.table.name=s.target.value};return(s,T)=>{var g;const r=G("icon");return u(),$("div",Je,[Qe,We,l.editing?(u(),$("div",et,[_("div",tt,[_("div",at,[t(r,{path:e(ye),width:"12",height:"12",fill:"#D35249"},null,8,["path"]),k(" Be careful ")]),lt]),t(e(j),{direction:"vertical"},{default:a(()=>[_("div",nt,[t(e(L),{value:s.table.name,type:"text",onInput:p,onBlur:T[0]||(T[0]=S=>s.table.fixTraillingName())},null,8,["value"])]),l.error?(u(),$("div",ot,[t(r,{path:e(ge),fill:"#D35249",width:"12",height:"12"},null,8,["path"]),k(" "+R(l.error),1)])):U("",!0),t(e(j),null,{default:a(()=>[t(e(x),{onClick:c},{default:a(()=>[k("Cancel")]),_:1}),t(e(x),{type:"primary",disabled:!s.table.hasChangesDeep("name"),onClick:v},{default:a(()=>[k(" Save Changes "),l.loading?(u(),D(_e,{key:0,size:"16"})):U("",!0)]),_:1},8,["disabled"])]),_:1})]),_:1})])):(u(),$("div",Xe,[_("div",Ye,[_("div",Ze,"Name: "+R((g=s.table)==null?void 0:g.name),1)]),t(e(x),{onClick:I},{default:a(()=>[k("Edit Name")]),_:1})]))])}}});const ut=J(st,[["__scopeId","data-v-06f57b7a"]]),Et=P({__name:"TableEditor",setup(f){const m=ne(),o=pe(),l=o.params.tableId,I=o.params.projectId,c=E("data"),{result:v,loading:C,refetch:p}=ie(()=>Promise.all([he.get(I).then(async r=>{const g=await ke.get(r.organizationId);return{project:r,organization:g}}),ve.get(I,l)]).then(([{project:r,organization:g},S])=>me({project:r,organization:g,table:S}))),s=N(()=>!C.value&&v.value?[{label:"My organizations",path:"/organizations"},{label:v.value.organization.name,path:`/organizations/${v.value.organization.id}`},{label:v.value.project.name,path:`/projects/${v.value.project.id}/tables`}]:void 0);function T(){m.push({name:"tables",params:{projectId:I}})}return(r,g)=>{const S=G("router-link");return u(),D(fe,null,{navbar:a(()=>{var B;return[t(e($e),{title:(B=e(v))==null?void 0:B.table.name,style:{padding:"5px 10px"},onBack:T},{footer:a(()=>[t(e(Ce),{"active-key":c.value,"onUpdate:activeKey":g[0]||(g[0]=i=>c.value=i)},{default:a(()=>[t(e(V),{key:"data",tab:"Data"}),t(e(V),{key:"columns",tab:"Columns"}),t(e(V),{key:"settings",tab:"Settings"})]),_:1},8,["active-key"])]),breadcrumb:a(()=>[s.value?(u(),D(e(we),{key:0},{default:a(()=>[(u(!0),$(q,null,M(s.value,(i,n)=>(u(),D(e(De),{key:n},{default:a(()=>[t(S,{to:i.path},{default:a(()=>[k(R(i.label),1)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1})):U("",!0)]),_:1},8,["title"])]}),content:a(()=>[e(v)&&c.value==="data"?(u(),D(Ae,{key:0,loading:e(C),table:e(v).table},null,8,["loading","table"])):U("",!0),e(v)&&c.value==="columns"?(u(),D(Ge,{key:1,table:e(v).table,loading:e(C),onRefresh:g[1]||(g[1]=B=>e(p)())},null,8,["table","loading"])):U("",!0),e(v)&&c.value==="settings"?(u(),D(ut,{key:2,table:e(v).table,loading:e(C),onRefresh:g[2]||(g[2]=B=>e(p)())},null,8,["table","loading"])):U("",!0)]),_:1})}}});export{Et as default};
//# sourceMappingURL=TableEditor.f5a99563.js.map
