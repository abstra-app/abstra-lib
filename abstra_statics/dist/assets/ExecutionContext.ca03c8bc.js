import{k as T,A as st,C as ot}from"./router.2fd242d8.js";import{d as N,at as D,c as S,o as d,ac as h,ae as nt,h as I,ew as it,e as A,v as rt,r as Z,al as M,eH as ct,w as B,a as V,b as x,aY as U,eB as Y,ad as lt,t as E,u as l,df as R,g as j,dj as X,_ as K,f as w,i as v,b0 as z,ez as dt,d6 as ut,cM as $}from"./jwt-decode.esm.5418d57c.js";import{B as pt}from"./build.683fdb20.js";import{c as tt}from"./string.eaee8887.js";import"./tables.3dfd442e.js";import{u as gt}from"./polling.a24080d5.js";import{t as ft}from"./ant-design.c509a383.js";import{I as Q}from"./PhCopy.vue.c60548d3.js";import{b as ht}from"./index.74ea4823.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[t]="51fcb2bb-23d5-4fb6-8a98-9ff63840e82a",o._sentryDebugIdIdentifier="sentry-dbid-51fcb2bb-23d5-4fb6-8a98-9ff63840e82a")}catch{}})();const mt=["width","height","fill","transform"],yt={key:0},xt=A("path",{d:"M72,104a16,16,0,1,1,16,16A16,16,0,0,1,72,104Zm96,16a16,16,0,1,0-16-16A16,16,0,0,0,168,120Zm68-40V192a36,36,0,0,1-36,36H56a36,36,0,0,1-36-36V80A36,36,0,0,1,56,44h60V16a12,12,0,0,1,24,0V44h60A36,36,0,0,1,236,80Zm-24,0a12,12,0,0,0-12-12H56A12,12,0,0,0,44,80V192a12,12,0,0,0,12,12H200a12,12,0,0,0,12-12Zm-12,82a30,30,0,0,1-30,30H86a30,30,0,0,1,0-60h84A30,30,0,0,1,200,162Zm-80-6v12h16V156ZM86,168H96V156H86a6,6,0,0,0,0,12Zm90-6a6,6,0,0,0-6-6H160v12h10A6,6,0,0,0,176,162Z"},null,-1),_t=[xt],vt={key:1},bt=A("path",{d:"M200,56H56A24,24,0,0,0,32,80V192a24,24,0,0,0,24,24H200a24,24,0,0,0,24-24V80A24,24,0,0,0,200,56ZM164,184H92a20,20,0,0,1,0-40h72a20,20,0,0,1,0,40Z",opacity:"0.2"},null,-1),wt=A("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Zm4,28H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24Z"},null,-1),At=[bt,wt],Ht={key:2},kt=A("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48ZM172,96a12,12,0,1,1-12,12A12,12,0,0,1,172,96ZM96,184H80a16,16,0,0,1,0-32H96ZM84,120a12,12,0,1,1,12-12A12,12,0,0,1,84,120Zm60,64H112V152h32Zm32,0H160V152h16a16,16,0,0,1,0,32Z"},null,-1),Zt=[kt],It={key:3},Vt=A("path",{d:"M200,50H134V16a6,6,0,0,0-12,0V50H56A30,30,0,0,0,26,80V192a30,30,0,0,0,30,30H200a30,30,0,0,0,30-30V80A30,30,0,0,0,200,50Zm18,142a18,18,0,0,1-18,18H56a18,18,0,0,1-18-18V80A18,18,0,0,1,56,62H200a18,18,0,0,1,18,18ZM74,108a10,10,0,1,1,10,10A10,10,0,0,1,74,108Zm88,0a10,10,0,1,1,10,10A10,10,0,0,1,162,108Zm2,30H92a26,26,0,0,0,0,52h72a26,26,0,0,0,0-52Zm-22,12v28H114V150ZM78,164a14,14,0,0,1,14-14h10v28H92A14,14,0,0,1,78,164Zm86,14H154V150h10a14,14,0,0,1,0,28Z"},null,-1),Ct=[Vt],St={key:4},Et=A("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16Zm-52-56H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Z"},null,-1),jt=[Et],Tt={key:5},Dt=A("path",{d:"M200,52H132V16a4,4,0,0,0-8,0V52H56A28,28,0,0,0,28,80V192a28,28,0,0,0,28,28H200a28,28,0,0,0,28-28V80A28,28,0,0,0,200,52Zm20,140a20,20,0,0,1-20,20H56a20,20,0,0,1-20-20V80A20,20,0,0,1,56,60H200a20,20,0,0,1,20,20ZM76,108a8,8,0,1,1,8,8A8,8,0,0,1,76,108Zm88,0a8,8,0,1,1,8,8A8,8,0,0,1,164,108Zm0,32H92a24,24,0,0,0,0,48h72a24,24,0,0,0,0-48Zm-20,8v32H112V148ZM76,164a16,16,0,0,1,16-16h12v32H92A16,16,0,0,1,76,164Zm88,16H152V148h12a16,16,0,0,1,0,32Z"},null,-1),Mt=[Dt],$t={name:"PhRobot"},Rt=N({...$t,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(o){const t=o,e=D("weight","regular"),i=D("size","1em"),p=D("color","currentColor"),c=D("mirrored",!1),r=S(()=>{var a;return(a=t.weight)!=null?a:e}),n=S(()=>{var a;return(a=t.size)!=null?a:i}),m=S(()=>{var a;return(a=t.color)!=null?a:p}),f=S(()=>t.mirrored!==void 0?t.mirrored?"scale(-1, 1)":void 0:c?"scale(-1, 1)":void 0);return(a,k)=>(d(),h("svg",it({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:n.value,height:n.value,fill:m.value,transform:f.value},a.$attrs),[nt(a.$slots,"default"),r.value==="bold"?(d(),h("g",yt,_t)):r.value==="duotone"?(d(),h("g",vt,At)):r.value==="fill"?(d(),h("g",Ht,Zt)):r.value==="light"?(d(),h("g",It,Ct)):r.value==="regular"?(d(),h("g",St,jt)):r.value==="thin"?(d(),h("g",Tt,Mt)):I("",!0)],16,mt))}}),Ot=["running","lock-failed","failed","finished","abandoned"];class O{constructor(t){this.dto=t}static from(t){return new O(t)}get entries(){return this.dto.sort((t,e)=>t.sequence-e.sequence).filter(t=>t.event!=="form-message")}}class P{constructor(t){this.dto=t}static from(t){return new P(t)}get id(){return this.dto.id}get shortId(){return this.dto.id.slice(0,8)}get createdAt(){return new Date(this.dto.createdAt)}get updatedAt(){return new Date(this.dto.updatedAt)}get status(){return this.dto.status}get context(){return this.dto.context}get buildId(){var t;return(t=this.dto.buildId)!=null?t:""}get stageId(){return this.dto.stageId}get duration_seconds(){return this.status==="running"?"-":`${(this.updatedAt.getTime()-this.createdAt.getTime())/1e3} s`}get stageRunId(){return this.dto.stageRunId}get projectId(){return this.dto.projectId}}class ae{async list({projectId:t,...e}){var c,r;const i={...e,offset:(c=e.offset)==null?void 0:c.toString(),limit:(r=e.limit)==null?void 0:r.toString()};Object.keys(i).forEach(n=>i[n]===void 0&&delete i[n]);const p=await T.get(`projects/${t}/executions`,i);return{executions:p.executions.map(n=>P.from(n)),totalCount:p.totalCount}}async fetchLogs(t,e){const i=await T.get(`projects/${t}/executions/${e}/logs`);return O.from(i)}async fetchThreadData(t,e){return(await T.get(`projects/${t}/executions/${e}/thread-data`)).response}async getExecutionTasks(t,e){return await T.get(`projects/${t}/executions/${e}/tasks`)}async fetchStages(){throw new Error("Method not implemented.")}}class se{async list(t){var n,m;const e={...t,offset:(n=t.offset)==null?void 0:n.toString(),limit:(m=t.limit)==null?void 0:m.toString()};Object.keys(e).forEach(f=>e[f]===void 0&&delete e[f]);const i=Object.fromEntries(Object.entries(e!=null?e:{}).filter(([,f])=>f!=null)),p=Object.keys(i).length>0?`?${new URLSearchParams(i).toString()}`:"",r=await(await fetch(`/_editor/api/executions${p}`)).json();return{executions:r.executions.map(f=>P.from(f)),totalCount:r.totalCount}}async fetchLogs(t,e){const p=await(await fetch(`/_editor/api/logs/${e}`)).json();return O.from(p)}async fetchThreadData(){return{}}async getExecutionTasks(t,e){return await(await fetch(`/_editor/api/executions/${e}/tasks`)).json()}async fetchStages(){return await(await fetch("/_editor/api/executions/stages")).json()}}const oe=rt("logs",()=>{const o=Z(null),t=Z(null),e=Z(""),i=Z(!1),p=Z(),c=M({openedExecutionIds:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],executionData:{}}),r=M({currentIndex:1,pageSize:10,totalCount:0}),n=M({dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0}),m=M({builds:[],stages:[],statuses:Ot.map(s=>({label:tt(s),value:s}))}),f=gt({task:()=>W(),interval:1e4}),a=async s=>{var u;o.value=s.executionRepository,t.value=s.buildRepository,e.value=s.projectId,i.value=(u=s.pool)!=null?u:!1,p.value=s.onFilterChange,Object.assign(n,s.filters||{}),Object.assign(r,s.pagination||{}),s.openedExecutionId&&(c.openedExecutionIds=[s.openedExecutionId]),await Promise.all([b(),F()]),q(),i.value&&f.startPolling()},k=()=>{f.endPolling()},b=async()=>{var y,g,_;if(!o.value)return;c.loadingExecutions=!0;const{executions:s,totalCount:u}=await o.value.list({projectId:e.value,buildId:n.buildId,status:n.status,limit:r.pageSize,offset:(r.currentIndex-1)*r.pageSize,stageId:n.stageId,startDate:(g=(y=n.dateRange)==null?void 0:y[0])==null?void 0:g.toISOString().slice(0,10),endDate:(_=n.dateRange)==null?void 0:_[1].add(1,"day").toISOString().slice(0,10),search:n.search});c.loadingExecutions=!1,c.executions=s,r.totalCount=u},H=async()=>{if(!t.value)return;const u=(await t.value.list(e.value)).map(y=>({label:`[${y.id.slice(0,8)}] ${y.createdAt.toLocaleString()} ${y.latest?"(Latest)":""}`,value:y.id}));m.builds=u},C=async()=>{var y;if(!o.value)return;if(!t.value){const _=(await o.value.fetchStages()).map(J=>({label:J.title,value:J.id}));m.stages=_!=null?_:[];return}const s=await pt.get((y=n.buildId)!=null?y:m.builds[0].value),u=s==null?void 0:s.runtimes.map(g=>({label:g.title,value:g.id}));m.stages=u!=null?u:[]},F=async()=>{await H(),await C()},L=async s=>{if(!o.value)return;const[u,y,g]=await Promise.all([o.value.fetchLogs(e.value,s),o.value.fetchThreadData(e.value,s),o.value.getExecutionTasks(e.value,s)]);c.executionData[s]={logs:u,threadData:y,tasks:{triggerTask:g.triggerTask?{type:g.triggerTask.type,payload:g.triggerTask.payload}:null,sentTasks:g.sentTasks.map(_=>({type:_.type,payload:_.payload}))}}},q=()=>{c.openedExecutionIds.forEach(async s=>{c.executionData[s]||await L(s)})},W=async()=>{c.openedExecutionIds.map(s=>L(s))},G=()=>{c.waitingDebounce=!0,r.currentIndex=1,et(),p.value&&p.value(n)},et=ct.exports.debounce(async()=>{await b(),c.waitingDebounce=!1},500),at=async s=>{let u=c.executions;return s&&(u=u.filter(g=>g.stageId===s)),u.length===0?null:u.reduce((g,_)=>g.createdAt>_.createdAt?g:_).id};return B(()=>n.buildId,()=>{C()}),B(n,()=>{c.openedExecutionIds=[],G()}),B(r,()=>{c.openedExecutionIds=[],b()}),{state:S(()=>({currentPage:c,pagination:r,filters:n,filterOptions:m})),currentPage:c,pagination:r,filters:n,filterOptions:m,init:a,teardown:k,fetchPage:b,fetchBuildOptions:H,fetchStageOptions:C,fetchOptions:F,fetchExecutionDetails:L,fetchEmptyLogs:q,refetch:W,handleFilterChange:G,getNewestExecutionId:at,polling:f}}),Pt={key:0,class:"cli"},Lt={key:0},Bt=N({__name:"LogContainer",props:{logs:{}},setup(o){return(t,e)=>(d(),V(l(X),{vertical:"",gap:"small"},{default:x(()=>[o.logs.entries.length?(d(),h("div",Pt,[(d(!0),h(U,null,Y(o.logs.entries,i=>(d(),h("p",{key:i.createdAt,style:lt({margin:0,"white-space":"pre-wrap",color:i.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},[i.payload.text?(d(),h("span",Lt,E(i.payload.text.trim()),1)):I("",!0)],4))),128))])):(d(),V(l(R),{key:1,type:"secondary"},{default:x(()=>[...e[0]||(e[0]=[j("Empty",-1)])]),_:1}))]),_:1}))}});const ne=K(Bt,[["__scopeId","data-v-b7f04a41"]]),zt={key:0},Nt=["onClick"],Ft=["onClick"],qt=N({__name:"ExecutionContext",props:{data:{},showFixWithAi:{type:Boolean},isSmartChatIdle:{type:Boolean}},emits:["ask-ai"],setup(o,{emit:t}){const e=o,i=t,p=Z(!1),c=a=>{if(a==="legacyThreadData")return v.translate("i18n_executioncontext_thread_data");const k=tt(a);return k.replace(/([A-Z])/g," $1").trim(),k},r=a=>a==null?!0:Array.isArray(a)?a.length===0:typeof a=="object"?Object.keys(a).length===0:!1,n=a=>{typeof a=="object"&&a!==null&&"payload"in a?(navigator.clipboard.writeText(JSON.stringify(a.payload)),$.success({content:v.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),$.error({content:v.translate("i18n_executioncontext_no_payload")}))},m=a=>{p.value=!0,a.stopPropagation(),e.isSmartChatIdle!==!1&&(i("ask-ai"),setTimeout(()=>{p.value=!1},1e3))},f=a=>{typeof a=="object"?(navigator.clipboard.writeText(JSON.stringify(a)),$.success({content:v.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),$.error({content:v.translate("i18n_executioncontext_failed_copy_request")}))};return(a,k)=>(d(),V(l(ot),{bordered:!1,style:{"background-color":"transparent",width:"100%"}},{default:x(()=>[w(l(st),{key:"execution-context"},{header:x(()=>[w(l(X),{justify:"space-between"},{default:x(()=>[w(l(R),null,{default:x(()=>[j(E(l(v).translate("i18n_executioncontext_header")),1)]),_:1}),w(l(z),{title:o.isSmartChatIdle?"":l(v).translate("i18n_executioncontext_wait_or_stop"),placement:"left"},{default:x(()=>[o.showFixWithAi?(d(),h("div",{key:0,class:dt(["ask-to-ai",{disabled:!o.isSmartChatIdle||p.value}]),onClick:m},[j(E(l(v).translate("i18n_executioncontext_fix_with_ai"))+" ",1),w(l(Rt),{size:16})],2)):I("",!0)]),_:1},8,["title"])]),_:1})]),default:x(()=>[w(l(ht),{direction:"vertical",style:{"border-radius":"5px",padding:"10px",color:"#fff",width:"100%","font-family":"monospace","max-height":"600px",overflow:"auto",border:"1px solid #e8e8e8"}},{default:x(()=>[Object.keys(o.data).length?(d(!0),h(U,{key:1},Y(Object.entries(o.data),([b,H])=>(d(),h("div",{key:b,class:"tree"},[b!=="legacyThreadData"||!r(H)?(d(),h("div",zt,[w(l(R),{strong:""},{default:x(()=>[j(E(c(b)),1)]),_:2},1024),b==="request"?(d(),V(l(z),{key:0,title:l(v).translate("i18n_executioncontext_copy_request_tooltip")},{default:x(()=>[A("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:C=>f(H)},[w(l(Q))],8,Nt)]),_:2},1032,["title"])):I("",!0),b==="triggerTask"?(d(),V(l(z),{key:1,title:l(v).translate("i18n_executioncontext_copy_payload_tooltip")},{default:x(()=>[A("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:C=>n(H)},[w(l(Q))],8,Ft)]),_:2},1032,["title"])):I("",!0),w(l(ut),{"tree-data":l(ft)(H),selectable:!1},null,8,["tree-data"])])):I("",!0)]))),128)):(d(),V(l(R),{key:0,type:"secondary"},{default:x(()=>[j(E(l(v).translate("i18n_executioncontext_empty")),1)]),_:1}))]),_:1})]),_:1})]),_:1}))}});const ie=K(qt,[["__scopeId","data-v-f7630ec7"]]);export{ie as E,ne as L,ae as R,se as a,oe as u};
//# sourceMappingURL=ExecutionContext.ca03c8bc.js.map
