import{f as o,eG as ae,r as ne,H,F as me,d as D,b as i,ev as S,w as s,aD as P,eC as x,eD as w,u as e,v as G,c as d,ar as m,cM as _e,cE as T,ex as A,bg as he,eJ as se,e as z,eI as V,aH as re,cm as oe,eE as ve,eF as be,eP as Se,a as ke,cD as le,ae as ie,bG as Q,eA as we,o as Ae,L as Re,dm as Ce}from"./outputWidgets.84400f3d.js";import{a as ue}from"./asyncComputed.f2a51feb.js";import"./workspaces.ec77028e.js";import{S as Ie}from"./scripts.27f061d5.js";import"./envVars.6242e707.js";import{A as Oe,s as ce}from"./api.1ac75b8d.js";import{A as De}from"./contracts.generated.dfc46d7a.js";import{A as R}from"./index.fa6ccec8.js";import{q as $e,r as Pe}from"./icons.51c500b8.js";import{t as xe}from"./ant-design.c41e79aa.js";import{A as B}from"./Text.471d0d00.js";import"./index.d9de2813.js";import{A as K}from"./index.f01295b9.js";import{f as Fe}from"./index.a2b63deb.js";import{A as X}from"./Paragraph.4b47bceb.js";import{A as q}from"./Title.77255753.js";import"./index.8a6b1787.js";import{T as Ee,A as Te}from"./Timeline.2a1b60bf.js";import{A as de,C as pe}from"./CollapsePanel.5525fdb8.js";import{A as Ue}from"./Link.c40d5ee3.js";import{A as ge}from"./index.617fe5ff.js";import{A as Le}from"./index.93162d4c.js";import{E as Ne}from"./ExpandOutlined.d72dbd51.js";import{C as je}from"./Card.213c3593.js";import{D as qe}from"./DownOutlined.e05fa14d.js";import"./index.15ddb2c1.js";import{F as ze,A as Be}from"./Form.d05a1b22.js";(function(){try{var n=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[t]="521af99d-e2aa-4d7d-9cc4-da202ad7b1f2",n._sentryDebugIdIdentifier="sentry-dbid-521af99d-e2aa-4d7d-9cc4-da202ad7b1f2")}catch{}})();var Ve={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM641.7 520.8L442.3 677.6c-7.4 5.8-18.3.6-18.3-8.8V355.3c0-9.4 10.9-14.7 18.3-8.8l199.4 156.7a11.2 11.2 0 010 17.6z"}}]},name:"play-square",theme:"filled"};const He=Ve;var Ke={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M168 504.2c1-43.7 10-86.1 26.9-126 17.3-41 42.1-77.7 73.7-109.4S337 212.3 378 195c42.4-17.9 87.4-27 133.9-27s91.5 9.1 133.8 27A341.5 341.5 0 01755 268.8c9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47a8 8 0 003 14.1l175.7 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c0-6.7-7.7-10.5-12.9-6.3l-56.4 44.1C765.8 155.1 646.2 92 511.8 92 282.7 92 96.3 275.6 92 503.8a8 8 0 008 8.2h60c4.4 0 7.9-3.5 8-7.8zm756 7.8h-60c-4.4 0-7.9 3.5-8 7.8-1 43.7-10 86.1-26.9 126-17.3 41-42.1 77.8-73.7 109.4A342.45 342.45 0 01512.1 856a342.24 342.24 0 01-243.2-100.8c-9.9-9.9-19.2-20.4-27.8-31.4l60.2-47a8 8 0 00-3-14.1l-175.7-43c-5-1.2-9.9 2.6-9.9 7.7l-.7 181c0 6.7 7.7 10.5 12.9 6.3l56.4-44.1C258.2 868.9 377.8 932 512.2 932c229.2 0 415.5-183.7 419.8-411.8a8 8 0 00-8-8.2z"}}]},name:"sync",theme:"outlined"};const Me=Ke;function ee(n){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?Object(arguments[t]):{},l=Object.keys(r);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(r).filter(function(a){return Object.getOwnPropertyDescriptor(r,a).enumerable}))),l.forEach(function(a){Ge(n,a,r[a])})}return n}function Ge(n,t,r){return t in n?Object.defineProperty(n,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[t]=r,n}var J=function(t,r){var l=ee({},t,r.attrs);return o(ae,ee({},l,{icon:He}),null)};J.displayName="PlaySquareFilled";J.inheritAttrs=!1;const Je=J;function te(n){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?Object(arguments[t]):{},l=Object.keys(r);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(r).filter(function(a){return Object.getOwnPropertyDescriptor(r,a).enumerable}))),l.forEach(function(a){We(n,a,r[a])})}return n}function We(n,t,r){return t in n?Object.defineProperty(n,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[t]=r,n}var W=function(t,r){var l=te({},t,r.attrs);return o(ae,te({},l,{icon:Me}),null)};W.displayName="SyncOutlined";W.inheritAttrs=!1;const Ye=W;function Ze(){const n=ne({state:"closed"});function t(){n.value={state:"closed"}}function r(){n.value={state:"visualizations"}}function l(u,p){n.value={state:"stage-run",stageRun:p}}const a=H(()=>"stageRun"in n.value?n.value.stageRun:null);return{closeDrawer:t,openVisualizationEditor:r,inspectStageRun:l,drawerState:n,selectedStageRunForDrawer:a}}const U="kanban-selected-stage-ids",L=10,Qe=({kanbanRepository:n,storage:t,filterFactory:r,router:l})=>{const a=me([]),u=ue(async()=>{try{const f=await n.getData({selection:a.value,filter:r()}),g=await t.get(U)||[];for(const y of f.not_found_stages)t.set(U,g.filter(h=>h!==y)),a.value=a.value.filter(h=>h.stage_id!==y);return f}catch{return a.value=[],await t.set(U,[]),{columns:[],next_stage_options:[]}}});function p(f){const g=f.selected_stage.id,y=a.value.find(h=>h.stage_id===g);return y!=null&&y.limit?y.limit<f.total_count:!1}async function c(f){var y;const g=a.value.find(h=>h.stage_id===f.selected_stage.id);g&&(g.limit=((y=g.limit)!=null?y:0)+L,await u.refetch())}async function _(f){const g=a.value.find(y=>y.stage_id===f);g&&g.limit&&g.limit>L&&(g.limit-=L,await u.refetch())}async function v(){const f=await t.get(U)||[];a.value=f.map(g=>({stage_id:g,limit:L,offset:0}))}async function C(f,g){f?a.value=[...a.value.slice(0,g),{stage_id:f.id,limit:L,offset:0},...a.value.slice(g+1)]:a.value=[...a.value.slice(0,g),...a.value.slice(g+1)],await t.set(U,a.value.map(y=>y.stage_id)),await u.refetch()}async function F(f){await C(f,a.value.length)}let b=null;return{kanbanAsyncComputed:u,selection:a,increasePagination:c,hasPagination:p,seeLess:_,setStage:C,addStage:F,cardActionHandler:async(f,g)=>{const y=f.selected_stage,h=g.id;if(y.type==="script"){const k=await Ie.get(y.id);if(!k)return;await k.run(h)}if(y.type==="form"){const k=l.resolve({path:`/${y.path}`,query:h?{[Oe]:h}:{}});window.open(k.href,h)}},setup:async()=>{await v(),u.refetch(),b=setInterval(()=>{u.refetch()},1e3)},tearDown:()=>{b&&clearInterval(b)}}};function Y(n){switch(n.status){case"waiting":return{color:"blue",text:"Waiting"};case"running":return{color:"processing",text:"Running"};case"finished":return{color:"success",text:"Success"};case"failed":return{color:"error",text:"Failed"};case"abandoned":return{color:"warning",text:"Abandoned"}}}const N="Show All",Xe=[N,...De];function et(){const n=ne(N);return{filterStatus:n,filterFactory:()=>n.value==N?{}:{status:n.value},labelOption:l=>l==N?N:Y({status:l}).text}}const tt={key:0},at={key:1,class:"terminal"},nt=D({__name:"ExecutionInspector",props:{logs:{}},setup(n){return(t,r)=>t.logs.length===0?(i(),S("span",tt)):(i(),S("div",at,[o(e(R),{vertical:""},{default:s(()=>[(i(!0),S(P,null,x(t.logs,l=>(i(),S("pre",{key:l.executionId,class:"log-text"},w(l.payload.text),1))),128))]),_:1})]))}});const st=G(nt,[["__scopeId","data-v-4e71a195"]]),M=D({__name:"StageRunData",props:{data:{}},setup(n){return(t,r)=>(i(),d(e(T),{direction:"vertical",style:{overflow:"hidden"}},{default:s(()=>[(i(!0),S(P,null,x(t.data,l=>(i(),S("div",{key:l.key},[o(e(B),{strong:""},{default:s(()=>[m(w(l.key),1)]),_:2},1024),o(e(_e),{"tree-data":e(xe)(l.value),selectable:!1},null,8,["tree-data"])]))),128))]),_:1}))}}),rt=n=>(ve("data-v-68c9e478"),n=n(),be(),n),ot={key:1},lt={key:1},it=rt(()=>z("span",null,"[Deleted Stage]",-1)),ut=["onClick"],ct=D({__name:"StageRunInspector",props:{stageRun:{},kanbanRepository:{},stageRunRepository:{}},emits:["close"],setup(n,{emit:t}){const r=n;function l(c){return Object.entries(c).map(([_,v])=>({key:_,value:v,type:typeof v}))}const{result:a,loading:u}=ue(()=>{var c;return r.kanbanRepository.getLogs((c=r.stageRun)==null?void 0:c.id)}),p=(c,_)=>{var v;c.stopPropagation(),(v=r.stageRunRepository)==null||v.fork(_),t("close")};return(c,_)=>(i(),d(e(Le),{open:"",title:"Thread details",size:"large",onClose:_[0]||(_[0]=v=>t("close"))},{extra:s(()=>[o(e(X),null,{default:s(()=>[o(e(K),{style:{"font-weight":"600"}},{default:s(()=>{var v;return[m(w(e(Y)({status:(v=c.stageRun)==null?void 0:v.status}).text),1)]}),_:1}),m(" "+w(e(Fe)(new Date(c.stageRun.created_at),{addSuffix:!0})),1)]),_:1})]),default:s(()=>{var v,C,F;return[(v=c.stageRun)!=null&&v.assignee?(i(),d(e(X),{key:0},{default:s(()=>{var b;return[m(" Assignee: "+w((b=c.stageRun)==null?void 0:b.assignee),1)]}),_:1})):A("",!0),((C=c.stageRun)==null?void 0:C.content)&&((F=c.stageRun)==null?void 0:F.content.length)>0?(i(),S("div",ot,[o(e(q),{level:4},{default:s(()=>[m("Current data")]),_:1}),o(M,{data:c.stageRun.content},null,8,["data"])])):A("",!0),o(e(q),{level:4,style:{"margin-bottom":"30px"}},{default:s(()=>[m(" Timeline ")]),_:1}),e(u)?(i(),d(e(he),{key:2})):e(a)?(i(),d(e(Ee),{key:3},{default:s(()=>[(i(!0),S(P,null,x(e(a),({stage:b,stage_run:I,logs:$})=>(i(),d(e(Te),{key:I.id},{default:s(()=>[o(e(pe),{ghost:"","expand-icon-position":"end"},{default:s(()=>[o(e(de),{class:"panel"},se({header:s(()=>[b?(i(),d(e(R),{key:0,align:"center",gap:15},{default:s(()=>[o(V,{path:e(ce)(b.type)},null,8,["path"]),$.length?(i(),S("span",lt,w(b.title),1)):(i(),d(e(re),{key:0,placement:"right",title:"No logs"},{default:s(()=>[m(w(b.title),1)]),_:2},1024))]),_:2},1024)):(i(),d(e(R),{key:1,align:"center",gap:15},{default:s(()=>[o(V,{path:e(Pe)},null,8,["path"]),it]),_:1}))]),default:s(()=>[l(I.data).length||$.length?(i(),d(e(R),{key:0,vertical:""},{default:s(()=>[l(I.data).length?(i(),d(e(R),{key:0,gap:0,vertical:""},{default:s(()=>[o(e(q),{level:5},{default:s(()=>[m(" Output data ")]),_:1}),o(M,{data:l(I.data)},null,8,["data"])]),_:2},1024)):A("",!0),$.length?(i(),d(e(R),{key:1,vertical:"",gap:0},{default:s(()=>[o(e(ge)),o(e(q),{level:5},{default:s(()=>[m(" Logs ")]),_:1}),o(st,{logs:$},null,8,["logs"])]),_:2},1024)):A("",!0)]),_:2},1024)):(i(),d(e(oe),{key:1,description:"No logs"}))]),_:2},[c.stageRunRepository&&b?{name:"extra",fn:s(()=>[z("span",{onClick:j=>p(j,I.id)},[o(e(R),{gap:"small"},{default:s(()=>[o(V,{path:e($e),width:"22"},null,8,["path"]),o(e(Ue),null,{default:s(()=>[m("Fork")]),_:1})]),_:1})],8,ut)]),key:"0"}:void 0]),1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):A("",!0)]}),_:1}))}});const dt=G(ct,[["__scopeId","data-v-68c9e478"]]),pt=D({__name:"Card",props:{stage:{},card:{}},emits:["inspect","action"],setup(n){const t=n,r=H(()=>Y({status:t.card.status}).text),l=H(()=>Se(new Date(String(t.card.updated_at))));return(a,u)=>{var p;return i(),d(e(je),{size:"small",style:{width:"275px",cursor:"pointer"},"body-style":{display:((p=a.card.content)==null?void 0:p.length)>0?"block":"none"}},se({title:s(()=>[o(e(K),null,{default:s(()=>[m(w(r.value)+" ",1),r.value==="Running"?(i(),d(e(Ye),{key:0,spin:!0,style:{"margin-left":"4px"}})):A("",!0)]),_:1})]),default:s(()=>[o(e(T),{direction:"vertical",style:{"max-height":"300px",width:"100%",overflow:"hidden"},onClick:u[0]||(u[0]=c=>a.$emit("inspect"))},{default:s(()=>[o(M,{data:a.card.content,disabled:!0},null,8,["data"]),a.card.assignee?(i(),d(e(K),{key:0},{default:s(()=>[m(w(a.card.assignee),1)]),_:1})):A("",!0)]),_:1})]),extra:s(()=>[o(e(R),{gap:"10"},{default:s(()=>[o(e(re),null,{title:s(()=>[m(w(a.card.updated_at),1)]),default:s(()=>[o(e(B),{type:"secondary",style:{"font-size":"12px"}},{default:s(()=>[m(w(l.value),1)]),_:1})]),_:1}),o(e(Ne),{onClick:u[2]||(u[2]=c=>a.$emit("inspect"))})]),_:1})]),_:2},[a.card.status==="waiting"?{name:"actions",fn:s(()=>[o(e(Je),{onClick:u[1]||(u[1]=c=>a.$emit("action"))})]),key:"0"}:void 0]),1032,["body-style"])}}}),fe=D({__name:"ColumnHeader",props:{stageOptions:{},stage:{},stageCount:{}},emits:["stageUpdate"],setup(n,{emit:t}){const r=n,l=a=>{const u=r.stageOptions.find(p=>p.id===a);t("stageUpdate",u!=null?u:null)};return(a,u)=>{var c;const p=ke("icon");return i(),d(e(ie),{style:{width:"275px"},"allow-clear":"",value:((c=a.stage)==null?void 0:c.id)||"","onUpdate:value":l},{suffixIcon:s(()=>[o(e(B),{type:"secondary",style:{"font-size":"small","margin-right":"2px"}},{default:s(()=>[m(w(a.stageCount),1)]),_:1}),o(e(ge),{type:"vertical"}),o(e(qe))]),default:s(()=>[(i(!0),S(P,null,x(a.stageOptions,_=>(i(),d(e(le),{key:_.id,value:_.id},{default:s(()=>[o(e(R),{gap:"10",style:{"max-width":"200px"}},{default:s(()=>[o(p,{path:e(ce)(_.type),style:{"flex-shrink":"0",width:"24px"}},null,8,["path"]),o(e(B),{ellipsis:"",content:_.title},null,8,["content"])]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])}}});class gt{constructor(t,r,l){this.router=t,this.column=r,this.kanbanRepository=l}get stage(){return this.column.selected_stage}get canStart(){return this.stage.can_be_started}get launchLink(){return!this.stage.can_be_started||this.stage.type!=="form"||!this.stage.path?null:this.router.resolve({path:`/${this.stage.path}`}).href}click(){if(this.launchLink)return window.open(this.launchLink,"_blank");if(this.stage.type==="job")return this.kanbanRepository.startJob(this.stage.id).catch(console.error)}}const ft=D({__name:"Column",props:{router:{},hasPagination:{type:Boolean},column:{},kanbanRepository:{}},emits:["increasePagination","cardAction","stageUpdate","cardInspection"],setup(n,{emit:t}){const r=n,l=new gt(r.router,r.column,r.kanbanRepository);return(a,u)=>(i(),d(e(T),{direction:"vertical"},{default:s(()=>[o(fe,{"stage-options":a.column.stages,stage:a.column.selected_stage,"stage-count":a.column.total_count,onStageUpdate:u[0]||(u[0]=p=>t("stageUpdate",p))},null,8,["stage-options","stage","stage-count"]),o(e(T),{direction:"vertical",style:{width:"100%"}},{default:s(()=>[a.column.stage_run_cards.length===0?(i(),d(e(oe),{key:0})):A("",!0),(i(!0),S(P,null,x(a.column.stage_run_cards,p=>(i(),d(pt,{key:p.id,stage:a.column.selected_stage,card:p,onInspect:c=>t("cardInspection",p),onAction:c=>t("cardAction",p)},null,8,["stage","card","onInspect","onAction"]))),128)),a.hasPagination?(i(),d(e(Q),{key:1,style:{width:"100%"},onClick:u[1]||(u[1]=p=>t("increasePagination"))},{default:s(()=>[m("See more")]),_:1})):A("",!0),e(l).canStart?(i(),d(e(Q),{key:2,style:{width:"100%"},onClick:u[2]||(u[2]=()=>e(l).click())},{default:s(()=>[m(" Start ")]),_:1})):A("",!0)]),_:1})]),_:1}))}}),yt=D({__name:"EmptyColumn",props:{stages:{}},emits:["stageUpdate"],setup(n,{emit:t}){const r=l=>{t("stageUpdate",l)};return(l,a)=>(i(),d(e(T),{direction:"vertical"},{default:s(()=>[o(fe,{"stage-options":l.stages,onStageUpdate:r},null,8,["stage-options"])]),_:1}))}}),mt={style:{width:"100%",padding:"20px"}},_t={class:"stages-container"},ht={class:"stages-content"},vt=D({__name:"Kanban",props:{storage:{},kanbanRepository:{},stageRunRepository:{}},setup(n){const t=n,r=we(),{closeDrawer:l,inspectStageRun:a,drawerState:u,selectedStageRunForDrawer:p}=Ze(),{filterFactory:c,filterStatus:_,labelOption:v}=et(),{kanbanAsyncComputed:C,setStage:F,addStage:b,setup:I,tearDown:$,cardActionHandler:j,increasePagination:f,hasPagination:g}=Qe({kanbanRepository:t.kanbanRepository,storage:t.storage,filterFactory:c,router:r});return Ae(I),Re($),(y,h)=>(i(),S("div",mt,[o(e(R),{vertical:"",style:{height:"100%"}},{default:s(()=>[o(e(pe),{ghost:""},{default:s(()=>[o(e(de),{header:"Filters"},{default:s(()=>[o(e(ze),null,{default:s(()=>[o(e(Be),{label:"Status"},{default:s(()=>[o(e(ie),{value:e(_),"onUpdate:value":h[0]||(h[0]=k=>Ce(_)?_.value=k:null),style:{width:"325px"}},{default:s(()=>[(i(!0),S(P,null,x(e(Xe),k=>(i(),d(e(le),{key:k,value:k},{default:s(()=>[m(w(e(v)(k)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),z("div",_t,[z("div",ht,[o(e(T),{align:"start"},{default:s(()=>{var k,Z;return[(i(!0),S(P,null,x(((k=e(C).result.value)==null?void 0:k.columns)||[],(O,ye)=>(i(),d(e(ft),{key:O.selected_stage.id,column:O,router:e(r),"has-pagination":e(g)(O),"kanban-repository":t.kanbanRepository,onIncreasePagination:E=>e(f)(O),onCardInspection:E=>e(a)(O,E),onCardAction:E=>e(j)(O,E),onStageUpdate:E=>e(F)(E,ye)},null,8,["column","router","has-pagination","kanban-repository","onIncreasePagination","onCardInspection","onCardAction","onStageUpdate"]))),128)),o(e(yt),{stages:((Z=e(C).result.value)==null?void 0:Z.next_stage_options)||[],onStageUpdate:h[1]||(h[1]=O=>e(b)(O))},null,8,["stages"])]}),_:1})])])]),_:1}),e(u).state==="stage-run"&&e(p)?(i(),d(e(dt),{key:0,"kanban-repository":t.kanbanRepository,"stage-run":e(p),"stage-run-repository":t.stageRunRepository,onClose:e(l)},null,8,["kanban-repository","stage-run","stage-run-repository","onClose"])):A("",!0)]))}});const Gt=G(vt,[["__scopeId","data-v-8d6c77ed"]]);class Jt{constructor(t,r=localStorage){this.contextKey=t,this.storage=r}makeKey(t){return`${this.contextKey}:${t}`}async get(t){const r=this.storage.getItem(this.makeKey(t));return r?JSON.parse(r):null}async set(t,r){this.storage.setItem(this.makeKey(t),JSON.stringify(r))}}export{Gt as K,Jt as L};
//# sourceMappingURL=repository.1e7f3516.js.map
