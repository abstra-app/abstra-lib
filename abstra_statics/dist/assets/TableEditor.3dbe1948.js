import{d as K,J as B,r as N,H as Z,a as A,b as c,eu as w,f as a,w as n,bg as q,aJ as g,eC as R,ew as $,e as _,u as e,eB as V,c as k,t as Y,c1 as S,bW as L,af as J,cI as ee,x as Q,K as fe,ez as te,cE as ve,cK as _e,eD as ae,eE as ne,eA as be,eF as ye}from"./outputWidgets.50a32881.js";import{B as ge}from"./BaseLayout.4ea40a14.js";import{p as le,T as he}from"./tables.a86e907c.js";import{a as oe}from"./asyncComputed.b13ea8c8.js";import{p as P}from"./popupNotifcation.47671146.js";import"./router.05c8f462.js";import"./columns.87749077.js";import{A as j}from"./index.5cd89e0c.js";import{A as O}from"./index.9b89ff38.js";import{A as T}from"./Title.6ed5196f.js";import{F as se}from"./Form.eef121ef.js";import{A as re}from"./index.68c386c0.js";import{Q as ke,w as Ce,R as we}from"./icons.21c36b2d.js";import{A as De}from"./index.0fb677b8.js";import{L as $e}from"./CircularLoading.c89fded4.js";import{P as Ie}from"./project.9a4bd643.js";import{O as Ae}from"./organization.51ac1db5.js";import{T as Te,A as H}from"./TabPane.226d96c9.js";import{B as Ue,a as Se,c as xe}from"./index.c2109f24.js";import"./gateway.557f1ef0.js";import"./activeRecord.a6d1caaf.js";import"./pubsub.a612a4ec.js";import"./string.df7840f3.js";import"./index.c6d42cf5.js";import"./index.f4ac7424.js";(function(){try{var v=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},m=new Error().stack;m&&(v._sentryDebugIds=v._sentryDebugIds||{},v._sentryDebugIds[m]="2d28fd64-7378-4297-ac0c-8d4773580036",v._sentryDebugIdIdentifier="sentry-dbid-2d28fd64-7378-4297-ac0c-8d4773580036")}catch{}})();const Ee={class:"table-data",style:{width:"calc(100% - 80px)"}},Be={key:1},Ne=["onClick"],qe=_("a",null,"Delete",-1),Re=K({__name:"TableData",props:{table:{}},setup(v){var i;const m=v,{result:o,loading:l,refetch:C}=oe(()=>m.table.select()),p=B(()=>{var d;return[...(d=m.table)==null?void 0:d.getColumns().map(r=>({title:r.name,dataIndex:r.name})),{title:"Actions",key:"action",fixed:"right",width:100,align:"center"}]}),f=B(()=>{var t;return((t=o.value)==null?void 0:t.map(d=>({key:d.id,...d})))||[]}),h=N(!1),u=N({}),s=()=>{h.value=!0},I=()=>{u.value={},h.value=!1};let b=Z((i=m.table)==null?void 0:i.getUnprotectedColumns().reduce((t,d)=>({...t,[d.name]:""}),{}));async function y(){if(!(!m.table||!b))try{u.value.id?await m.table.updateRow(u.value.id,u.value):await m.table.insertRow(u.value),u.value={},C(),I()}catch(t){t instanceof Error&&P("Database error",t.message)}}const D=async t=>{if(!(!o.value||!o.value.find(d=>d.id===t)))try{await m.table.deleteRow(t),C()}catch(d){d instanceof Error&&P("Database error",d.message)}},U=t=>{var d;u.value=Y.exports.pick(Y.exports.cloneDeep((d=f.value)==null?void 0:d.filter(r=>t===r.key)[0]),m.table.getColumns().map(r=>r.name)),s()};return(t,d)=>{const r=A("a-divider"),z=A("a-popconfirm"),x=A("a-button"),G=A("a-table"),ie=A("a-input"),de=A("a-form-item"),ce=A("a-form"),pe=A("a-space"),me=A("a-drawer");return c(),w("div",Ee,[a(G,{columns:p.value,"data-source":f.value,bordered:"",loading:e(l),scroll:{x:2e3,y:720}},{bodyCell:n(({column:E,text:F,record:X})=>[p.value.map(M=>M.title).includes(E.dataIndex)?(c(),w(q,{key:0},[g(R(F),1)],64)):$("",!0),E.key==="action"?(c(),w("div",Be,[_("span",null,[_("a",{onClick:M=>U(X.id)},"Edit",8,Ne)]),a(r,{type:"vertical"}),a(z,{title:"Sure to delete?",onConfirm:M=>D(X.id)},{default:n(()=>[qe]),_:2},1032,["onConfirm"])])):$("",!0)]),footer:n(()=>[a(x,{type:"primary",onClick:s},{default:n(()=>[g("+ Add New Data")]),_:1})]),_:1},8,["columns","data-source","loading"]),a(me,{title:"Data",width:720,open:h.value,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:I},{extra:n(()=>[a(pe,null,{default:n(()=>[a(x,{onClick:I},{default:n(()=>[g("Cancel")]),_:1}),a(x,{type:"primary",onClick:y},{default:n(()=>[g("Submit")]),_:1})]),_:1})]),default:n(()=>[a(ce,{model:u.value,layout:"vertical"},{default:n(()=>[(c(!0),w(q,null,V(t.table.getUnprotectedColumns(),E=>(c(),k(de,{key:E.id,label:E.name},{default:n(()=>[u.value?(c(),k(ie,{key:0,value:u.value[E.name],"onUpdate:value":F=>u.value[E.name]=F},null,8,["value","onUpdate:value"])):$("",!0)]),_:2},1032,["label"]))),128))]),_:1},8,["model"])]),_:1},8,["open"])])}}});const ze=K({__name:"NewColumn",props:{open:{type:Boolean},table:{}},emits:["created","cancel"],setup(v,{emit:m}){const o=v,l=N({name:"",type:"varchar",nullable:!0,unique:!1}),C=()=>{l.value={name:"",type:"varchar",nullable:!0,unique:!1}};function p(){m("cancel")}async function f(){if(!o.table||!l.value.name||!l.value.type)return;const{success:h,error:u}=await o.table.addColumn(l.value);h||P("Database error",u),C(),m("created")}return(h,u)=>(c(),k(e(re),{title:"New column",width:720,open:o.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:p},{extra:n(()=>[a(e(O),null,{default:n(()=>[a(e(S),{onClick:p},{default:n(()=>[g("Cancel")]),_:1}),a(e(S),{type:"primary",onClick:f},{default:n(()=>[g("Submit")]),_:1})]),_:1})]),default:n(()=>[a(e(se),{model:l.value,layout:"vertical"},{default:n(()=>[a(e(T),{key:"name",label:"Name"},{default:n(()=>[a(e(L),{value:l.value.name,"onUpdate:value":u[0]||(u[0]=s=>l.value.name=s)},null,8,["value"])]),_:1}),a(e(T),{key:"type",label:"Type"},{default:n(()=>[a(e(J),{value:l.value.type,"onUpdate:value":u[1]||(u[1]=s=>l.value.type=s),"default-active-first-option":""},{default:n(()=>[(c(!0),w(q,null,V(e(le),s=>(c(),k(e(ee),{key:s,value:s},{default:n(()=>[g(R(s),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),a(e(T),{key:"nullable",label:"Nullable"},{default:n(()=>[a(e(j),{checked:l.value.nullable,"onUpdate:checked":u[2]||(u[2]=s=>l.value.nullable=s)},null,8,["checked"])]),_:1}),a(e(T),{key:"unique",label:"Unique"},{default:n(()=>[a(e(j),{checked:l.value.unique,"onUpdate:checked":u[3]||(u[3]=s=>l.value.unique=s)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"]))}}),Pe={class:"types-container"},Ke={class:"fullwidth-input"},je={class:"fullwidth-input"},Le={class:"using-container"},Oe={class:"fullwidth-input"},Ve=K({__name:"UpdateColumn",props:{open:{type:Boolean},table:{},column:{}},emits:["updated","cancel"],setup(v,{emit:m}){const o=v;function l(){m("cancel")}const C=()=>o.column.record.hasChangesDeep("type"),p=N({type:"default"});function f(i,t){return t==="varchar"||i==="int"&&t==="boolean"||i==="boolean"&&t==="int"}const h=()=>{s.value&&(p.value={type:"user-defined",using:D.value,mandatory:!0})},u=B(()=>p.value.type==="default"&&f(o.column.record.initialState.type,o.column.type)),s=B(()=>!f(o.column.record.initialState.type,o.column.type));function I(i){i?p.value={type:"default"}:p.value={type:"user-defined",using:D.value,mandatory:!1}}function b(i){if(p.value.type==="default")throw new Error("Can't change using when using default casting");p.value.using=i!=null?i:""}const y=()=>s.value?!0:C()&&p.value.type==="user-defined",D=B(()=>`${o.column.record.initialState.name}::${o.column.type}`);async function U(){if(!o.column)return;const i=p.value.type==="default"?D.value:p.value.using;try{await o.column.update(i),m("updated")}catch(t){t instanceof Error&&P("Database error",t.message)}}return(i,t)=>{const d=A("icon");return c(),k(e(re),{title:"Edit column",width:720,open:o.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:l},{extra:n(()=>[a(e(O),null,{default:n(()=>[a(e(S),{onClick:l},{default:n(()=>[g("Cancel")]),_:1}),a(e(S),{type:"primary",onClick:U},{default:n(()=>[g("Submit")]),_:1})]),_:1})]),default:n(()=>[a(e(se),{model:i.column,layout:"vertical"},{default:n(()=>[a(e(T),{key:"name",label:"Name"},{default:n(()=>[a(e(L),{value:i.column.name,"onUpdate:value":t[0]||(t[0]=r=>i.column.name=r)},null,8,["value"])]),_:1}),_("div",Pe,[_("span",Ke,[a(e(T),{key:"type",label:"Current Type"},{default:n(()=>[a(e(J),{value:i.column.record.initialState.type,"onUpdate:value":t[1]||(t[1]=r=>i.column.record.initialState.type=r),"default-active-first-option":"",disabled:""},null,8,["value"])]),_:1})]),a(d,{class:"right-arrow",path:e(ke)},null,8,["path"]),_("span",je,[a(e(T),{key:"new-type",label:"New Type"},{default:n(()=>[a(e(J),{value:i.column.type,"onUpdate:value":t[2]||(t[2]=r=>i.column.type=r),"default-active-first-option":"",onChange:t[3]||(t[3]=r=>h())},{default:n(()=>[(c(!0),w(q,null,V(e(le),r=>(c(),k(e(ee),{key:r,value:r},{default:n(()=>[g(R(r),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})])]),_("div",Le,[C()?(c(),k(e(T),{key:"default-casting",label:"Use default casting"},{default:n(()=>[a(e(j),{checked:u.value,disabled:s.value,"onUpdate:checked":t[4]||(t[4]=r=>I(!!r))},null,8,["checked","disabled"])]),_:1})):$("",!0),_("span",Oe,[C()?(c(),k(e(T),{key:"using",label:"Using"},{default:n(()=>[a(e(L),{value:p.value.type==="user-defined"?p.value.using:D.value,disabled:!y(),onInput:t[5]||(t[5]=r=>b(r.target.value))},null,8,["value","disabled"])]),_:1})):$("",!0)])]),a(e(T),{key:"nullable",label:"Nullable"},{default:n(()=>[a(e(j),{checked:i.column.nullable,"onUpdate:checked":t[6]||(t[6]=r=>i.column.nullable=r)},null,8,["checked"])]),_:1}),a(e(T),{key:"unique",label:"Unique"},{default:n(()=>[a(e(j),{checked:i.column.unique,"onUpdate:checked":t[7]||(t[7]=r=>i.column.unique=r)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])}}});const Fe=Q(Ve,[["__scopeId","data-v-e474c12f"]]),ue=v=>(ae("data-v-4f8ba920"),v=v(),ne(),v),Me={class:"table-settings"},He={key:0},Je=ue(()=>_("span",null," protected ",-1)),Qe=[Je],We={key:1},Ge=["onClick"],Xe=ue(()=>_("a",null,"Delete",-1)),Ye=K({__name:"TableColumns",props:{table:{},loading:{type:Boolean}},emits:["refresh"],setup(v,{emit:m}){var i;const o=v,l=N(o.loading);fe(()=>o.loading,()=>{l.value=o.loading});const C=te();(i=o.table)==null||i.onUpdate(()=>{var t;C.replace({name:"tableEditor",params:{tableName:(t=o.table)==null?void 0:t.name}})});const f=[...[{title:"Name",dataIndex:"name"},{title:"Type",dataIndex:"type"},{title:"Default Value",dataIndex:"default"},{title:"Nullable",dataIndex:"nullable"},{title:"Primary Key",dataIndex:"primaryKey"}],{title:"Actions",key:"action"}],h=B(()=>{var t;return(t=o.table)==null?void 0:t.getColumns().map(d=>({name:d.name,type:d.type,default:d.default,nullable:d.nullable,primaryKey:d.primaryKey,id:d.id,unique:d.unique}))});function u(){b.value={type:"idle"}}function s(){u(),l.value=!0,setTimeout(()=>{m("refresh")},500)}function I(){b.value={type:"creating"}}const b=N({type:"idle"});function y(t){var d,r;(r=(d=o.table)==null?void 0:d.getColumn(t))==null||r.delete(),l.value=!0,setTimeout(()=>{m("refresh")},500)}const D=t=>{var d,r,z;return(z=(r=(d=o.table)==null?void 0:d.getColumn(t))==null?void 0:r.protected)!=null?z:!1},U=t=>{if(!o.table)throw new Error("Table not found");b.value={type:"editing",column:o.table.getColumn(t)}};return(t,d)=>(c(),w("div",Me,[a(e(_e),{columns:f,"data-source":h.value,bordered:"",loading:l.value,pagination:!1},{bodyCell:n(({column:r,text:z,record:x})=>[r.key!=="action"?(c(),w(q,{key:0},[g(R(z),1)],64)):(c(),w(q,{key:1},[D(x.id)?(c(),w("div",He,Qe)):(c(),w("div",We,[_("span",null,[_("a",{onClick:()=>U(x.id)},"Edit",8,Ge)]),a(e(De),{type:"vertical"}),a(e(ve),{title:"Sure to delete?",onConfirm:G=>y(x.id)},{default:n(()=>[Xe]),_:2},1032,["onConfirm"])]))],64))]),footer:n(()=>[a(e(S),{type:"primary",onClick:I},{default:n(()=>[g("+ Add New Column")]),_:1})]),_:1},8,["data-source","loading"]),t.table&&b.value.type==="creating"?(c(),k(ze,{key:0,open:"",table:o.table,onClose:u,onCreated:s},null,8,["table"])):$("",!0),t.table&&b.value.type==="editing"?(c(),k(Fe,{key:1,column:b.value.column,open:"",table:t.table,onUpdated:s,onClose:u,onCancel:u},null,8,["column","table"])):$("",!0)]))}});const Ze=Q(Ye,[["__scopeId","data-v-4f8ba920"]]),W=v=>(ae("data-v-06f57b7a"),v=v(),ne(),v),et={class:"table-settings"},tt=W(()=>_("h2",{class:"title"},"Table settings",-1)),at=W(()=>_("div",{class:"subtitle"},"Edit table metadata",-1)),nt={key:0,class:"table-presenter"},lt={class:"table-property-item"},ot={class:"property-item"},st={key:1},rt={class:"change-warning"},ut={class:"section-title"},it=W(()=>_("div",{class:"section-body"}," Changing the table's name can possibly result in the break of running applications. ",-1)),dt={class:"table-name-value-input"},ct={key:0,class:"error"},pt=K({__name:"TableSettings",props:{table:{}},emits:["refresh"],setup(v,{emit:m}){const o=v,l=Z({error:"",editing:!1,loading:!1}),C=()=>l.editing=!0,p=()=>{o.table.resetChanges(),l.editing=!1,l.error=""},f=async()=>{l.error="",l.loading=!0;try{await h()}catch(s){s instanceof Error&&(P("Database error",s.message),l.error=s.message)}l.error||(l.editing=!1),l.loading=!1},h=async()=>{if(!o.table.name){l.error="Table name cannot be empty";return}try{await o.table.save(),m("refresh")}catch(s){s instanceof Error&&(P("Database error",s.message),l.error=s.message)}},u=s=>{o.table.name=s.target.value};return(s,I)=>{var y;const b=A("icon");return c(),w("div",et,[tt,at,l.editing?(c(),w("div",st,[_("div",rt,[_("div",ut,[a(b,{path:e(Ce),width:"12",height:"12",fill:"#D35249"},null,8,["path"]),g(" Be careful ")]),it]),a(e(O),{direction:"vertical"},{default:n(()=>[_("div",dt,[a(e(L),{value:s.table.name,type:"text",onInput:u,onBlur:I[0]||(I[0]=D=>s.table.fixTraillingName())},null,8,["value"])]),l.error?(c(),w("div",ct,[a(b,{path:e(we),fill:"#D35249",width:"12",height:"12"},null,8,["path"]),g(" "+R(l.error),1)])):$("",!0),a(e(O),null,{default:n(()=>[a(e(S),{onClick:p},{default:n(()=>[g("Cancel")]),_:1}),a(e(S),{type:"primary",disabled:!s.table.hasChangesDeep("name"),onClick:f},{default:n(()=>[g(" Save Changes "),l.loading?(c(),k($e,{key:0,size:"16"})):$("",!0)]),_:1},8,["disabled"])]),_:1})]),_:1})])):(c(),w("div",nt,[_("div",lt,[_("div",ot,"Name: "+R((y=s.table)==null?void 0:y.name),1)]),a(e(S),{onClick:C},{default:n(()=>[g("Edit Name")]),_:1})]))])}}});const mt=Q(pt,[["__scopeId","data-v-06f57b7a"]]),Kt=K({__name:"TableEditor",setup(v){const m=te(),o=be(),l=o.params.tableId,C=o.params.projectId,p=N("data"),{result:f,loading:h,refetch:u}=oe(()=>Promise.all([Ie.get(C).then(async b=>{const y=await Ae.get(b.organizationId);return{project:b,organization:y}}),he.get(C,l)]).then(([{project:b,organization:y},D])=>ye({project:b,organization:y,table:D}))),s=B(()=>!h.value&&f.value?[{label:"My organizations",path:"/organizations"},{label:f.value.organization.name,path:`/organizations/${f.value.organization.id}`},{label:f.value.project.name,path:`/projects/${f.value.project.id}/tables`}]:void 0);function I(){m.push({name:"tables",params:{projectId:C}})}return(b,y)=>{const D=A("router-link");return c(),k(ge,null,{navbar:n(()=>{var U;return[a(e(xe),{title:(U=e(f))==null?void 0:U.table.name,style:{padding:"5px 10px"},onBack:I},{footer:n(()=>[a(e(Te),{"active-key":p.value,"onUpdate:activeKey":y[0]||(y[0]=i=>p.value=i)},{default:n(()=>[a(e(H),{key:"data",tab:"Data"}),a(e(H),{key:"columns",tab:"Columns"}),a(e(H),{key:"settings",tab:"Settings"})]),_:1},8,["active-key"])]),breadcrumb:n(()=>[s.value?(c(),k(e(Ue),{key:0},{default:n(()=>[(c(!0),w(q,null,V(s.value,(i,t)=>(c(),k(e(Se),{key:t},{default:n(()=>[a(D,{to:i.path},{default:n(()=>[g(R(i.label),1)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1})):$("",!0)]),_:1},8,["title"])]}),content:n(()=>[e(f)&&p.value==="data"?(c(),k(Re,{key:0,loading:e(h),table:e(f).table},null,8,["loading","table"])):$("",!0),e(f)&&p.value==="columns"?(c(),k(Ze,{key:1,table:e(f).table,loading:e(h),onRefresh:y[1]||(y[1]=U=>e(u)())},null,8,["table","loading"])):$("",!0),e(f)&&p.value==="settings"?(c(),k(mt,{key:2,table:e(f).table,loading:e(h),onRefresh:y[2]||(y[2]=U=>e(u)())},null,8,["table","loading"])):$("",!0)]),_:1})}}});export{Kt as default};
//# sourceMappingURL=TableEditor.3dbe1948.js.map
