var N=Object.defineProperty;var q=(u,i,r)=>i in u?N(u,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):u[i]=r;var D=(u,i,r)=>(q(u,typeof i!="symbol"?i+"":i,r),r);import{E as Q,g as A,ej as V,d as O,o as d,c as g,w as a,b as e,aG as h,u as t,de as S,Y as v,aS as C,eb as j,Z,e9 as m,dj as z,d4 as G,S as K,a0 as Y,ea as H,eD as B,df as J,cA as T,cB as y,bL as M,aB as P,by as F,d7 as R,a as W,bQ as X,cz as tt}from"./index.e1ec3e10.js";import{c as L}from"./string.569a6924.js";import"./gateway.ab874197.js";import{B as et}from"./build.36d6c699.js";import"./tables.6ebfa228.js";import{e as at,_ as st}from"./ExecutionStatusIcon.vue_vue_type_script_setup_true_lang.a07a006e.js";import{g as it}from"./datetime.67f00294.js";import{t as lt}from"./ant-design.ac028450.js";import{A as k}from"./index.73a3b654.js";import{A as b,a as E}from"./index.3b0dcd0b.js";import{R as U}from"./dayjs.019c21b1.js";import{A as ot,C as nt}from"./CollapsePanel.272fd103.js";(function(){try{var u=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},i=new Error().stack;i&&(u._sentryDebugIds=u._sentryDebugIds||{},u._sentryDebugIds[i]="3bd619e0-ac40-4167-abcb-8da2b1be97b2",u._sentryDebugIdIdentifier="sentry-dbid-3bd619e0-ac40-4167-abcb-8da2b1be97b2")}catch{}})();class rt{constructor(i,r,o,p,c,f){D(this,"state");D(this,"handleFilterChange",()=>{this.state.currentPage.waitingDebounce=!0,this.state.pagination.currentIndex=1,this.debouncedPageRefetch()});D(this,"debouncedPageRefetch",V.exports.debounce(async()=>{await this.fetchPage(),this.state.currentPage.waitingDebounce=!1},500));D(this,"fetchEmptyLogs",()=>{this.state.currentPage.openedExecutionIds.forEach(async i=>{this.state.currentPage.executionData[i]||await this.fetchExecutionDetails(i)})});this.executionRepository=i,this.buildRepository=r,this.projectId=o,this.state=Q({currentPage:{openedExecutionIds:f?[f]:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],executionData:{}},pagination:{currentIndex:1,pageSize:10,totalCount:0,...c},filters:{dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0,...p},filterOptions:{builds:[],stages:[],statuses:at.map(_=>({label:L(_),value:_}))}}),A(()=>this.state.filters.buildId,()=>{this.fetchStageOptions()}),A(this.state.filters,()=>{this.state.currentPage.openedExecutionIds=[],this.handleFilterChange()}),A(this.state.pagination,()=>{this.state.currentPage.openedExecutionIds=[],this.fetchPage()})}async init(){await Promise.all([this.fetchPage(),this.fetchOptions()]),this.fetchEmptyLogs(),this.setupRefetchInterval()}async fetchPage(){var o,p,c,f;this.state.currentPage.loadingExecutions=!0;const{executions:i,totalCount:r}=await this.executionRepository.list({projectId:this.projectId,buildId:this.state.filters.buildId,status:this.state.filters.status,limit:this.state.pagination.pageSize,offset:(this.state.pagination.currentIndex-1)*this.state.pagination.pageSize,stageId:this.state.filters.stageId,startDate:(p=(o=this.state.filters.dateRange)==null?void 0:o[0])==null?void 0:p.toISOString(),endDate:(f=(c=this.state.filters.dateRange)==null?void 0:c[1])==null?void 0:f.toISOString(),search:this.state.filters.search});this.state.currentPage.loadingExecutions=!1,this.state.currentPage.executions=i,this.state.pagination.totalCount=r}async fetchBuildOptions(){if(!this.buildRepository)return;const r=(await this.buildRepository.list(this.projectId)).map(o=>({label:`[${o.id.slice(0,8)}] ${o.createdAt.toLocaleString()} ${o.latest?"(Latest)":""}`,value:o.id}));this.state.filterOptions.builds=r}async fetchStageOptions(){var o;if(!this.buildRepository){const c=(await this.executionRepository.fetchStages()).map(f=>({label:f.title,value:f.id}));this.state.filterOptions.stages=c!=null?c:[];return}const i=await et.get((o=this.state.filters.buildId)!=null?o:this.state.filterOptions.builds[0].value),r=i==null?void 0:i.runtimes.map(p=>({label:p.title,value:p.id}));this.state.filterOptions.stages=r!=null?r:[]}async fetchOptions(){await this.fetchBuildOptions(),await this.fetchStageOptions()}async fetchExecutionDetails(i){const[r,o]=await Promise.all([this.executionRepository.fetchLogs(this.projectId,i),this.executionRepository.fetchThreadData(this.projectId,i)]);this.state.currentPage.executionData[i]={logs:r,threadData:o}}async setupRefetchInterval(){setTimeout(async()=>{await Promise.all(this.state.currentPage.openedExecutionIds.map(i=>this.fetchExecutionDetails(i))),this.setupRefetchInterval()},1e5)}}const dt={key:0,style:{"background-color":"#555","border-radius":"5px",padding:"10px",color:"#fff","font-family":"monospace","max-height":"600px",overflow:"auto"}},ut=O({__name:"LogContainer",props:{logs:{}},setup(u){return(i,r)=>(d(),g(t(z),{vertical:"",gap:"small"},{default:a(()=>[e(t(S),{strong:""},{default:a(()=>[h("Terminal Output")]),_:1}),i.logs.entries.length?(d(),v("div",dt,[(d(!0),v(C,null,j(i.logs.entries,o=>(d(),v("p",{key:o.createdAt,style:Z({margin:0,"white-space":"pre-wrap",color:o.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},m(o.payload.text.trim()),5))),128))])):(d(),g(t(S),{key:1,type:"secondary"},{default:a(()=>[h("Empty")]),_:1}))]),_:1}))}}),pt={key:0},ct=O({__name:"ExecutionContext",props:{data:{}},setup(u){const i=o=>{if(o==="legacyThreadData")return"Thread data";const p=L(o);return p.replace(/([A-Z])/g," $1").trim(),p},r=o=>o==null?!0:Array.isArray(o)?o.length===0:typeof o=="object"?Object.keys(o).length===0:!1;return(o,p)=>(d(),g(t(z),{vertical:"",gap:"small"},{default:a(()=>[e(t(S),{strong:""},{default:a(()=>[h("Execution context")]),_:1}),e(t(k),{direction:"vertical",style:{"border-radius":"5px",padding:"10px",color:"#fff",width:"100%","font-family":"monospace","max-height":"600px",overflow:"auto",border:"1px solid #e8e8e8"}},{default:a(()=>[Object.keys(o.data).length?(d(!0),v(C,{key:1},j(Object.entries(o.data),([c,f])=>(d(),v("div",{key:c,class:"tree"},[c!=="legacyThreadData"||!r(f)?(d(),v("div",pt,[e(t(S),{strong:""},{default:a(()=>[h(m(i(c)),1)]),_:2},1024),e(t(G),{"tree-data":t(lt)(f),selectable:!1},null,8,["tree-data"])])):K("",!0)]))),128)):(d(),g(t(S),{key:0,type:"secondary"},{default:a(()=>[h("Empty")]),_:1}))]),_:1})]),_:1}))}});const ft=Y(ct,[["__scopeId","data-v-599a1d92"]]),gt={style:{width:"100px",height:"100%",display:"flex","align-items":"center","justify-content":"right",gap:"10px"}},ht={key:0,style:{display:"flex",width:"100%","justify-content":"center"}},Et=O({__name:"Logs",props:{executionRepository:{},buildRepository:{},showAllFilters:{type:Boolean}},setup(u){const i=u,r=H(),o=r.params.projectId,p=r.query.executionId;function c(){const{stageId:x,buildId:n,status:s,startDate:I,endDate:w}=r.query;return I&&w?{stageId:x,buildId:n,status:s,dateRange:[B(I),B(w)]}:{stageId:x,buildId:n,status:s}}function f(){const{page:x,pageSize:n}=r.query;return{page:x?parseInt(x,10):1,pageSize:n?parseInt(n,10):10}}const _=new rt(i.executionRepository,i.buildRepository,o,c(),f(),p),{state:l}=_;return _.init(),(x,n)=>(d(),g(t(k),{direction:"vertical",style:{width:"100%",padding:"0px 0px 20px 0px"}},{default:a(()=>[e(t(J),null,{default:a(()=>[h("Logs")]),_:1}),x.showAllFilters?(d(),g(t(T),{key:0,layout:"vertical"},{default:a(()=>[e(t(E),{gutter:10},{default:a(()=>[e(t(b),{span:12},{default:a(()=>[e(t(y),{label:"Run ID"},{default:a(()=>[e(t(M),{value:t(l).filters.search,"onUpdate:value":n[0]||(n[0]=s=>t(l).filters.search=s),placeholder:"Search by Run ID",style:{width:"100%"}},null,8,["value"])]),_:1})]),_:1}),e(t(b),{span:12},{default:a(()=>[e(t(y),{label:"Stage"},{default:a(()=>[e(t(P),{value:t(l).filters.stageId,"onUpdate:value":n[1]||(n[1]=s=>t(l).filters.stageId=s),options:t(l).filterOptions.stages,placeholder:"All","allow-clear":""},null,8,["value","options"])]),_:1})]),_:1})]),_:1}),e(t(E),{gutter:10},{default:a(()=>[e(t(b),{span:8},{default:a(()=>[e(t(y),{label:"Date"},{default:a(()=>[e(t(U),{value:t(l).filters.dateRange,"onUpdate:value":n[2]||(n[2]=s=>t(l).filters.dateRange=s),style:{width:"100%"}},null,8,["value"])]),_:1})]),_:1}),e(t(b),{span:10},{default:a(()=>[e(t(y),{label:"Build"},{default:a(()=>[e(t(P),{value:t(l).filters.buildId,"onUpdate:value":n[3]||(n[3]=s=>t(l).filters.buildId=s),options:t(l).filterOptions.builds,"option-label":"label","option-value":"value",filter:!1,placeholder:"All","allow-clear":""},null,8,["value","options"])]),_:1})]),_:1}),e(t(b),{span:6},{default:a(()=>[e(t(y),{label:"Status"},{default:a(()=>[e(t(P),{value:t(l).filters.status,"onUpdate:value":n[4]||(n[4]=s=>t(l).filters.status=s),options:t(l).filterOptions.statuses,"option-label":"label","option-value":"value",filter:!1,placeholder:"All","allow-clear":""},null,8,["value","options"])]),_:1})]),_:1})]),_:1})]),_:1})):(d(),g(t(T),{key:1,layout:"vertical"},{default:a(()=>[e(t(E),{gutter:10},{default:a(()=>[e(t(b),{span:8},{default:a(()=>[e(t(y),{label:"Date"},{default:a(()=>[e(t(U),{value:t(l).filters.dateRange,"onUpdate:value":n[5]||(n[5]=s=>t(l).filters.dateRange=s),style:{width:"100%"}},null,8,["value"])]),_:1})]),_:1}),e(t(b),{span:10},{default:a(()=>[e(t(y),{label:"Script"},{default:a(()=>[e(t(P),{value:t(l).filters.stageId,"onUpdate:value":n[6]||(n[6]=s=>t(l).filters.stageId=s),options:t(l).filterOptions.stages,placeholder:"All","allow-clear":""},null,8,["value","options"])]),_:1})]),_:1}),e(t(b),{span:6},{default:a(()=>[e(t(y),{label:"Status"},{default:a(()=>[e(t(P),{value:t(l).filters.status,"onUpdate:value":n[7]||(n[7]=s=>t(l).filters.status=s),options:t(l).filterOptions.statuses,"option-label":"label","option-value":"value",filter:!1,placeholder:"All","allow-clear":""},null,8,["value","options"])]),_:1})]),_:1})]),_:1})]),_:1})),t(l).currentPage.loadingExecutions||t(l).currentPage.waitingDebounce?(d(),g(t(F),{key:2,style:{width:"100%"}})):t(l).currentPage.executions&&t(l).currentPage.executions.length>0?(d(),g(t(k),{key:3,direction:"vertical",style:{width:"100%"}},{default:a(()=>[e(t(nt),{"active-key":t(l).currentPage.openedExecutionIds,"onUpdate:activeKey":n[8]||(n[8]=s=>t(l).currentPage.openedExecutionIds=s),bordered:!1,style:{"background-color":"transparent"},onChange:t(_).fetchEmptyLogs},{default:a(()=>[(d(!0),v(C,null,j(t(l).currentPage.executions,s=>(d(),g(t(ot),{key:s.id,style:{"border-radius":"4px","margin-bottom":"10px",border:"0",overflow:"hidden","background-color":"#fff"}},{header:a(()=>[e(t(R),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:a(()=>[h(m(t(it)(s.createdAt)),1)]),_:2},1024),e(t(R),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:a(()=>[h(" Run ID: "+m(s.id.slice(0,8)),1)]),_:2},1024),e(t(R),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:a(()=>[h(" Build: "+m(s.buildId.slice(0,8)),1)]),_:2},1024),e(t(R),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:a(()=>[h(" Duration: "+m(s.duration_seconds),1)]),_:2},1024),e(t(R),{color:"default",style:{"margin-right":"10px"},bordered:!1},{default:a(()=>{var I,w;return[h(m((w=(I=t(l).filterOptions.stages.find($=>$.value===s.stageId))==null?void 0:I.label)!=null?w:s.stageId.slice(0,8)),1)]}),_:2},1024)]),extra:a(()=>[W("div",gt,[h(m(t(L)(s.status))+" ",1),e(st,{status:s.status},null,8,["status"])])]),default:a(()=>[t(l).currentPage.executionData[s.id]?(d(),g(t(z),{key:1,vertical:"",gap:"middle"},{default:a(()=>[e(ft,{data:s.context},null,8,["data"]),e(ut,{logs:t(l).currentPage.executionData[s.id].logs},null,8,["logs"])]),_:2},1024)):(d(),v("div",ht,[e(t(F))]))]),_:2},1024))),128))]),_:1},8,["active-key","onChange"]),e(t(X),{current:t(l).pagination.currentIndex,"onUpdate:current":n[9]||(n[9]=s=>t(l).pagination.currentIndex=s),"page-size":t(l).pagination.pageSize,"onUpdate:pageSize":n[10]||(n[10]=s=>t(l).pagination.pageSize=s),total:t(l).pagination.totalCount,"show-total":s=>`Found ${s} runs`,"show-size-changer":""},null,8,["current","page-size","total","show-total"])]),_:1})):(d(),g(t(tt),{key:4}))]),_:1}))}});export{Et as _};
//# sourceMappingURL=Logs.vue_vue_type_script_setup_true_lang.6f7f2cdb.js.map
