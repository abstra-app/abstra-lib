var D=Object.defineProperty;var T=(o,e,t)=>e in o?D(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var M=(o,e,t)=>(T(o,typeof e!="symbol"?e+"":e,t),t);import{C as x}from"./ContentLayout.34675bf7.js";import{l as B}from"./fetch.9dae2a64.js";import{E as $}from"./record.2a93f29c.js";import{d as C,a0 as A,y as v,b as u,ey as g,dq as E,eA as P,eD as N,e as _,f as c,eK as U,c as b,w as i,u as r,bI as L,au as y,eH as k,cF as z,eJ as S,aG as H,ah as F,eI as G,aK as J,am as W,al as Z,dn as Y}from"./outputWidgets.52571dac.js";import{E as K}from"./repository.919a8833.js";import{a as j}from"./asyncComputed.2a2a1288.js";import"./workspaces.daf256e7.js";import{l as V}from"./editor.a72f2338.js";import{S as Q}from"./SaveButton.c3c882ea.js";import{I as X}from"./PhGlobe.vue.f23523d3.js";import{P as ee}from"./PlusOutlined.cf52d035.js";import{A as te}from"./index.6763f634.js";import{i as se}from"./metadata.baee0e00.js";import{a as re}from"./Base.e64db743.js";import{A as w}from"./index.89edc4ba.js";import{A as oe}from"./Text.0586c869.js";import{A as ae}from"./index.f3e1df2a.js";import{A as ne}from"./index.7797c9cd.js";import{A as le}from"./Title.8fbc2e7d.js";import{A as ie}from"./Link.a6766c40.js";import{A as ce}from"./Paragraph.7aa2ce32.js";import"./pubsub.be7004e9.js";import"./gateway.9b472f57.js";import"./popupNotifcation.e85fac74.js";import"./runnerData.3982af84.js";import"./url.5cc70021.js";import"./index.8b944c64.js";import"./UnsavedChangesHandler.27f75b7f.js";import"./ExclamationCircleOutlined.70211d7b.js";import"./Modal.514213ca.js";import"./PhCheckCircle.vue.67b14c02.js";import"./PhKanban.vue.bce4e3b1.js";import"./PhScroll.vue.9f99ffd4.js";import"./PhWebhooksLogo.vue.5cbb3f37.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[e]="ab02220d-5017-4020-94da-0a91d4977ea9",o._sentryDebugIdIdentifier="sentry-dbid-ab02220d-5017-4020-94da-0a91d4977ea9")}catch{}})();const ue=["width","height","fill","transform"],de={key:0},pe=_("path",{d:"M208,76H180V56A52,52,0,0,0,76,56V76H48A20,20,0,0,0,28,96V208a20,20,0,0,0,20,20H208a20,20,0,0,0,20-20V96A20,20,0,0,0,208,76ZM100,56a28,28,0,0,1,56,0V76H100ZM204,204H52V100H204Z"},null,-1),me=[pe],fe={key:1},he=_("path",{d:"M216,96V208a8,8,0,0,1-8,8H48a8,8,0,0,1-8-8V96a8,8,0,0,1,8-8H208A8,8,0,0,1,216,96Z",opacity:"0.2"},null,-1),ge=_("path",{d:"M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80ZM96,56a32,32,0,0,1,64,0V80H96ZM208,208H48V96H208V208Z"},null,-1),ve=[he,ge],ye={key:2},be=_("path",{d:"M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80ZM96,56a32,32,0,0,1,64,0V80H96Z"},null,-1),Ce=[be],_e={key:3},we=_("path",{d:"M208,82H174V56a46,46,0,0,0-92,0V82H48A14,14,0,0,0,34,96V208a14,14,0,0,0,14,14H208a14,14,0,0,0,14-14V96A14,14,0,0,0,208,82ZM94,56a34,34,0,0,1,68,0V82H94ZM210,208a2,2,0,0,1-2,2H48a2,2,0,0,1-2-2V96a2,2,0,0,1,2-2H208a2,2,0,0,1,2,2Z"},null,-1),Ae=[we],Ve={key:4},He=_("path",{d:"M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80ZM96,56a32,32,0,0,1,64,0V80H96ZM208,208H48V96H208V208Z"},null,-1),Pe=[He],ke={key:5},Se=_("path",{d:"M208,84H172V56a44,44,0,0,0-88,0V84H48A12,12,0,0,0,36,96V208a12,12,0,0,0,12,12H208a12,12,0,0,0,12-12V96A12,12,0,0,0,208,84ZM92,56a36,36,0,0,1,72,0V84H92ZM212,208a4,4,0,0,1-4,4H48a4,4,0,0,1-4-4V96a4,4,0,0,1,4-4H208a4,4,0,0,1,4,4Z"},null,-1),Oe=[Se],Re={name:"PhLockSimple"},Me=C({...Re,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(o){const e=o,t=A("weight","regular"),l=A("size","1em"),m=A("color","currentColor"),h=A("mirrored",!1),a=v(()=>{var s;return(s=e.weight)!=null?s:t}),d=v(()=>{var s;return(s=e.size)!=null?s:l}),f=v(()=>{var s;return(s=e.color)!=null?s:m}),n=v(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:h?"scale(-1, 1)":void 0);return(s,p)=>(u(),g("svg",N({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:d.value,height:d.value,fill:f.value,transform:n.value},s.$attrs),[E(s.$slots,"default"),a.value==="bold"?(u(),g("g",de,me)):a.value==="duotone"?(u(),g("g",fe,ve)):a.value==="fill"?(u(),g("g",ye,Ce)):a.value==="light"?(u(),g("g",_e,Ae)):a.value==="regular"?(u(),g("g",Ve,Pe)):a.value==="thin"?(u(),g("g",ke,Oe)):P("",!0)],16,ue))}});function q(o){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?Object(arguments[e]):{},l=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(t).filter(function(m){return Object.getOwnPropertyDescriptor(t,m).enumerable}))),l.forEach(function(m){Ze(o,m,t[m])})}return o}function Ze(o,e,t){return e in o?Object.defineProperty(o,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):o[e]=t,o}var O=function(e,t){var l=q({},e,t.attrs);return c(U,q({},l,{icon:ee}),null)};O.displayName="PlusOutlined";O.inheritAttrs=!1;const je=O;class R{constructor(e){M(this,"record");this.record=$.from(e)}get id(){return this.record.get("id")}get type(){return this.record.get("type")}get title(){return this.record.get("title")}get isPublic(){return this.record.get("is_public")}set isPublic(e){e&&this.record.set("required_roles",[]),this.record.set("is_public",e)}get requiredRoles(){return this.record.get("required_roles")}set requiredRoles(e){e.length!==0&&this.record.set("is_public",!1),this.record.set("required_roles",e)}makePublic(){this.isPublic=!0}makeProtected(){this.isPublic=!1,this.requiredRoles=[]}require(e){e.length!==0&&(this.isPublic=!1),this.requiredRoles=e}get visibility(){return this.isPublic?"public":"private"}hasChanges(){return this.record.hasChanges("is_public")||this.record.hasChangesDeep("required_roles")}get changes(){return this.record.changes}get initialState(){return this.record.initialState}toUpdateDTO(){return{id:this.id,is_public:this.isPublic,required_roles:this.requiredRoles}}commit(){this.record.commit()}static from(e){return new R(e)}}class qe{constructor(e=B){this.fetch=e}async list(){return(await(await this.fetch("/_editor/api/access-control",{method:"GET",headers:{"Content-Type":"application/json"}})).json()).map(R.from)}async update(e){const t=e.reduce((m,h)=>(h.hasChanges()&&m.push({id:h.id,...h.changes}),m),[]);return await(await fetch("/_editor/api/access-control",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()}}const Ie=C({__name:"RoleSelector",props:{value:{},roleOptions:{},disabled:{type:Boolean}},emits:["update:value"],setup(o,{emit:e}){const t=o,l=()=>{var f,n;if(!((f=V.asyncComputed.result.value)!=null&&f.logged))return;const d=(n=V.asyncComputed.result.value)==null?void 0:n.info.projectId;window.open(`https://cloud.abstra.io/projects/${d}/access-control?selected-panel=roles`,"__roles")},m=d=>{e("update:value",d)},h=v(()=>t.disabled?"":"All users listed in the cloud"),a=C({props:{vnodes:{type:Object,required:!0}},render(){return this.vnodes}});return(d,f)=>(u(),b(r(F),{value:d.value,mode:"multiple",placeholder:h.value,disabled:d.disabled,"onUpdate:value":m},{dropdownRender:i(({menuNode:n})=>{var s;return[c(r(a),{vnodes:n},null,8,["vnodes"]),c(r(te),{style:{margin:"4px 0"}}),(s=r(V).asyncComputed.result.value)!=null&&s.logged?(u(),b(r(L),{key:0,type:"default",style:{width:"100%"},onClick:l},{icon:i(()=>[c(r(je))]),default:i(()=>[y(" Create a new role ")]),_:1})):P("",!0)]}),default:i(()=>[(u(!0),g(H,null,k(d.roleOptions,n=>(u(),b(r(z),{key:n,value:n},{default:i(()=>[y(S(n),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder","disabled"]))}}),De=C({__name:"AccessControlItem",props:{accessControl:{},roles:{}},emits:["update:access-control"],setup(o,{emit:e}){const t=o,l=v(()=>t.roles.map(a=>a.name)),m=a=>{a?t.accessControl.makePublic():t.accessControl.makeProtected(),e("update:access-control",t.accessControl)},h=a=>{t.accessControl.require(a),a.length!==0&&(t.accessControl.isPublic=!1),e("update:access-control",t.accessControl)};return(a,d)=>(u(),b(r(w),{justify:"space-between",align:"center",gap:"small"},{default:i(()=>[(u(),b(G(r(se)(a.accessControl.type)),{style:{"flex-shrink":"0",width:"22px",height:"18px"}})),c(r(re),{style:{width:"300px","text-overflow":"ellipsis",overflow:"hidden","white-space":"nowrap"}},{default:i(()=>[c(r(J),{title:a.accessControl.title,placement:"left",open:a.accessControl.title.length>36?void 0:!1},{default:i(()=>[y(S(a.accessControl.title),1)]),_:1},8,["title","open"])]),_:1}),c(r(w),{gap:"large",align:"center"},{default:i(()=>[c(Ie,{disabled:a.accessControl.visibility==="public",style:{width:"320px"},value:a.accessControl.requiredRoles||[],"role-options":l.value||[],"onUpdate:value":d[0]||(d[0]=f=>h(f))},null,8,["disabled","value","role-options"]),c(r(W),{value:a.accessControl.visibility},{default:i(()=>[c(r(Z),{value:"public",onChange:d[1]||(d[1]=f=>m(!0))},{default:i(()=>[c(r(w),{align:"center",gap:"small"},{default:i(()=>[y(" Public "),c(r(X),{size:14})]),_:1})]),_:1}),c(r(Z),{value:"private",onChange:d[2]||(d[2]=f=>m(!1))},{default:i(()=>[c(r(w),{align:"center",gap:"small"},{default:i(()=>[y(" Private "),c(r(Me),{size:14})]),_:1})]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}))}}),Te=C({__name:"DanglingRolesAlert",props:{danglingRoles:{}},setup(o){return(e,t)=>(u(),b(r(ne),{type:"warning","show-icon":"",closable:"",style:{margin:"5px"}},{description:i(()=>[c(r(oe),null,{default:i(()=>[y("The following roles are not defined in the Cloud Console:")]),_:1}),(u(!0),g(H,null,k(e.danglingRoles,l=>(u(),b(r(ae),{key:l,style:{margin:"2px"},color:"red"},{default:i(()=>[y(S(l),1)]),_:2},1024))),128))]),_:1}))}}),xe=C({__name:"View",props:{accessControls:{},roles:{},loading:{type:Boolean}},emits:["update:access-controls","save"],setup(o,{emit:e}){const t=o,l=n=>{const s=t.accessControls.findIndex(p=>p.id===n.id);s!==-1&&(t.accessControls[s]=n,e("update:access-controls",[...t.accessControls]))},m=v(()=>{var n;return((n=t.accessControls)==null?void 0:n.filter(s=>s.hasChanges()))||[]}),h=v(()=>m.value.length>0),d={save:async()=>{e("save")},hasChanges:()=>h.value},f=v(()=>{const n=[...new Set(t.accessControls.flatMap(p=>p.requiredRoles)||[])],s=t.roles.map(p=>p.name)||[];return(n==null?void 0:n.filter(p=>!s.includes(p)))||[]});return(n,s)=>(u(),g(H,null,[!n.loading&&f.value.length>0?(u(),b(Te,{key:0,"dangling-roles":f.value},null,8,["dangling-roles"])):P("",!0),c(Q,{model:d}),c(r(w),{vertical:"",gap:"small",style:{"margin-top":"10px"}},{default:i(()=>[(u(!0),g(H,null,k(n.accessControls,p=>(u(),b(r(w),{key:p.id},{default:i(()=>[c(De,{"access-control":p,roles:n.roles,"onUpdate:accessControl":l},null,8,["access-control","roles"])]),_:2},1024))),128))]),_:1})],64))}}),Ct=C({__name:"AccessControlEditor",setup(o){const e=new qe,t=v(()=>{const s=V.asyncComputed.result.value,p=s!=null&&s.logged?s==null?void 0:s.info.projectId:"";return p?`https://cloud.abstra.io/projects/${p}/access-control?selected-panel=users`:""}),{result:l,refetch:m}=j(async()=>await e.list()),h=v(()=>{var s;return((s=l.value)==null?void 0:s.filter(p=>p.hasChanges()))||[]}),a=async()=>{await e.update(h.value),await m()},d=new K,{result:f,loading:n}=j(()=>d.list(100,0));return(s,p)=>(u(),b(x,null,{default:i(()=>[c(r(le),null,{default:i(()=>[y("Access Control")]),_:1}),c(r(ce),null,{default:i(()=>[y(" Configure the security level of your application. You can define which pages are accessible to "),c(r(ie),{href:t.value,target:"_users"},{default:i(()=>[y("signed-in users")]),_:1},8,["href"]),y(", which pages are accessible to users with specific roles, and which pages are accessible to everyone. ")]),_:1}),r(l)?(u(),b(xe,{key:0,"access-controls":r(l),"onUpdate:accessControls":p[0]||(p[0]=I=>Y(l)?l.value=I:null),roles:r(f)||[],loading:r(n),onSave:a},null,8,["access-controls","roles","loading"])):P("",!0)]),_:1}))}});export{Ct as default};
//# sourceMappingURL=AccessControlEditor.5610ee4e.js.map
