var ke=Object.defineProperty;var Ee=(o,e,s)=>e in o?ke(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var M=(o,e,s)=>(Ee(o,typeof e!="symbol"?e+"":e,s),s);import{u as te}from"./uuid.2b259c22.js";import{E as he,d as K,r as m,F as Q,b as p,et as b,e as d,ex as H,eC as fe,eD as ve,t as Z,ez as Me,G as se,a1 as ge,o as _e,J as me,a as ye,f as h,u as i,I as N,ao as C,eB as z,ev as S,eu as Se,bo as oe,eA as Ie,c as W,eN as xe,eT as De,eG as Fe,w as u,bF as Ce,D as j,bM as Y,bp as ee}from"./outputWidgets.b703ca45.js";import{k as ie,l as re,n as le,o as Re,q as Ae,u as Oe}from"./icons.5202cd65.js";import{S as ce}from"./storage.4f0beb94.js";import{l as Be}from"./NavbarControls.5db01344.js";import{H as We,J as $e}from"./jobs.30458756.js";import{S as Te}from"./scripts.1bf47b79.js";import{n as He,v as Pe,a as Le}from"./validations.8e396df8.js";import{A as we}from"./FormItem.39e0b98f.js";import{W as Ne}from"./workspaces.ac64317a.js";import{a as ue}from"./asyncComputed.557fdbc3.js";import{l as ze,e as q,R as Ke}from"./toggleHighContrast.9a97398c.js";import{A as de}from"./index.44c0d841.js";import{A as Ve}from"./index.c55859fc.js";import{C as Ue}from"./Card.3c731ead.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[e]="ba62e795-bd75-42d5-8a7b-d4b1aca0c191",o._sentryDebugIdIdentifier="sentry-dbid-ba62e795-bd75-42d5-8a7b-d4b1aca0c191")}catch{}})();class be{constructor(){M(this,"logState",he({log:[]}));M(this,"_listeners",{})}static create(){return new be}get logs(){return this.logState.log}log(e,s){if(e.type!=="restart"&&e.log.trim()==="")return;const t=s?this.logs.find(r=>r.id===s):null;return t?Object.assign(t,e):this.logs.push({...e,id:s||te()}),this.notifyListeners(e),s}clear(){this.logState.log=[]}listen(e){const s=te();return this._listeners[s]=e,s}unlisten(e){delete this._listeners[e]}notifyListeners(e){Object.values(this._listeners).forEach(s=>s(e))}}class Ge{static async*sendMessage(e,s){var f;const r=(f=(await fetch("/_editor/api/ai/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e,runtime:s})})).body)==null?void 0:f.getReader();if(!r)throw new Error("No response body");for(;;){const _=await r.read();if(_.done)break;yield new TextDecoder().decode(_.value)}}}const Je=o=>(fe("data-v-59ca7295"),o=o(),ve(),o),Ye=Je(()=>d("div",{class:"text"}," Changes were made in your code. Click Restart to refresh the preview window. ",-1)),pe="ignoreCodeChangesWarning",je=K({__name:"ChangesWarning",props:{hasChanges:{type:Boolean}},setup(o){var f;const e=o,s=m((f=ce.get(pe))!=null?f:!1),t=Q(()=>e.hasChanges&&!s.value),r=()=>{ce.set(pe,!0),s.value=!0};return(_,F)=>(p(),b("div",{class:H(["changes-warning",{visible:t.value}])},[Ye,d("div",{class:"no-more-alert",onClick:r},"Do not show again")],2))}});const qe=Z(je,[["__scopeId","data-v-59ca7295"]]),Qe=o=>(fe("data-v-9d2d7cb6"),o=o(),ve(),o),Xe={class:"smart-console"},Ze={class:"header"},et={class:"left"},tt={class:"right"},st={class:"changes-container"},ot=["unseen-severity"],nt={class:"cli"},at={class:"left"},it=Qe(()=>d("div",{class:"entry ai-output"}," Hello there! I'm both an output console and AI assistant. You can ask me anything. ",-1)),rt={key:1,class:"local-entry"},lt={class:"input"},ct=["pointer-events","onKeydown"],ut={class:"right"},dt=K({__name:"SmartConsole",props:{inputEnabled:{type:Boolean},formCode:{},runtime:{},logService:{}},emits:["eval-request","clear-terminal","restart","enter"],setup(o,{emit:e}){const s=o,t=m(""),r=m(null),f=Me(),_=m({type:"seen"}),F=m(!1),R=m(!1),O=()=>{k.value=k.value==="assistant"?"debugger":"assistant"};function A(c){switch(c.type){case"ai-input":return{role:"user",content:c.log};case"ai-output":return{role:"assistant",content:c.log};case"stderr":case"stdout":return{role:"user",content:c.log};case"restart":return{role:"user",content:"-- new session --"};case"files-changed":return{role:"user",content:"-- files changed --"};default:throw new Error(`Unknown log type: ${c.type}`)}}const y=Q(()=>s.logService.logs.some(c=>c.type==="files-changed"));function I(){w.value=!w.value,w.value&&(_.value={type:"seen"})}se(f,()=>{s.logService.clear(),e("clear-terminal")});const v=m(null),k=m("assistant"),P=async c=>{var n;if(c.preventDefault(),t.value=((n=v.value)==null?void 0:n.innerText)||"",c.shiftKey){document.execCommand("insertLineBreak");return}v.value&&(v.value.innerText=""),k.value==="assistant"?await $():await E()},$=async()=>{var n;if(e("enter",t.value),s.logService.log({type:"ai-input",log:t.value}),t.value="",!R.value){s.logService.log({type:"stderr",log:"Please login to use the AI assistant."});return}F.value=!0;const c={role:"user",content:(n=s.formCode)!=null?n:""};try{const a=te();let g="";const x=Ge.sendMessage([c,...s.logService.logs.map(D=>A(D)),{role:"user",content:t.value}],s.runtime);for await(const D of x)g+=D,s.logService.log({type:"ai-output",log:g},a)}catch(a){s.logService.log({type:"ai-output",log:"Sorry, I don't know how to answer that."}),console.error(a),De(a)}finally{F.value=!1}},E=async()=>{t.value&&(s.logService.log({type:"eval-input",log:`>>> ${t.value}`}),e("eval-request",t.value),t.value="")},L=()=>{s.logService.clear()};s.logService.listen(async c=>{w.value||(_.value={type:"unseen",count:_.value.type==="unseen"?_.value.count+1:1,severity:c.type==="stderr"?"error":"info"}),c.type!=="restart"&&(await ge(),r.value&&(r.value.scrollTop=r.value.scrollHeight))});const w=m(!1),V=m(400),l=Q(()=>({height:`${V.value}px`})),T=m(!1),U=()=>T.value=!0,G=c=>{!T.value||(V.value=document.body.clientHeight-c.clientY)},J=()=>T.value=!1;return _e(()=>{document.addEventListener("mousemove",G),document.addEventListener("mouseup",J),Be.get().then(c=>{R.value=!!c.logged})}),me(()=>{document.removeEventListener("mousemove",G),document.removeEventListener("mouseup",J)}),(c,n)=>{const a=ye("Markdown");return p(),b("div",Xe,[d("div",Ze,[d("div",et,[h(N,{path:k.value==="assistant"?i(ie):i(re)},null,8,["path"]),C(" Smart Console ")]),d("div",tt,[d("div",st,[h(qe,{"has-changes":y.value},null,8,["has-changes"])]),d("div",{class:"toggle-button",onClick:I},[h(N,{class:H(["icon",{open:w.value}]),path:i(le),fill:"#fff"},null,8,["class","path"]),_.value.type==="unseen"?(p(),b("div",{key:0,class:"unseen-count","unseen-severity":_.value.severity},z(_.value.count),9,ot)):S("",!0)])])]),w.value?(p(),b("div",{key:0,class:"terminal",style:Se(l.value)},[d("div",{class:"resize-handler",onMousedown:U},null,32),d("div",nt,[d("div",at,[d("div",{ref_key:"entriesContainer",ref:r,class:"entries"},[it,(p(!0),b(oe,null,Ie(s.logService.logs,(g,x)=>(p(),b("div",{key:x,class:H([g.type,"entry"])},[g.type==="ai-output"?(p(),W(a,{key:0,source:g.log},null,8,["source"])):(p(),b("div",rt,z(g.type==="restart"?"-- restarted --":g.log),1))],2))),128))],512),d("div",lt,[h(N,{class:H(["icon",{open:w.value}]),path:i(le)},null,8,["class","path"]),d("div",{ref_key:"inputRef",ref:v,class:"input-text",contenteditable:"","pointer-events":F.value?"none":"auto",placeholder:"Ask AI anything",onKeydown:xe(P,["enter"])},null,40,ct)])]),d("div",ut,[d("div",{class:"icons",onClick:L},[h(N,{class:"icon",path:i(Re)},null,8,["path"])]),d("div",null,[h(N,{class:"icon clickable",path:k.value==="assistant"?i(ie):i(re),onClick:n[0]||(n[0]=g=>O())},null,8,["path"])])])])],4)):S("",!0)])}}});const Tt=Z(dt,[["__scopeId","data-v-9d2d7cb6"]]),pt=K({__name:"PathInput",props:{runtime:{}},setup(o){const e=o,s=()=>{const t=He(e.runtime.path);t&&t!==e.runtime.path&&(e.runtime.path=t)};return(t,r)=>(p(),W(i(Ce),{value:t.runtime.path,"onUpdate:value":r[0]||(r[0]=f=>t.runtime.path=f),type:"text",onBlur:s},Fe({_:2},[t.runtime instanceof i(We)?{name:"addonBefore",fn:u(()=>[C(" https://[your-subdomain].abstra.app/_hooks/ ")]),key:"0"}:{name:"addonBefore",fn:u(()=>[C(" https://[your-subdomain].abstra.app/ ")]),key:"1"}]),1032,["value"]))}}),ht={key:1},ft=K({__name:"RuntimeCommonSettings",props:{runtime:{}},setup(o){const e=he({pathError:null});return(s,t)=>(p(),b(oe,null,[s.runtime instanceof i($e)||s.runtime instanceof i(Te)?S("",!0):(p(),W(i(we),{key:0,label:"URL path"},{default:u(()=>[h(pt,{runtime:s.runtime},null,8,["runtime"])]),_:1})),e.pathError?(p(),b("div",ht,z(e.pathError),1)):S("",!0)],64))}});const Ht=Z(ft,[["__scopeId","data-v-60a397e0"]]);let X={};function vt(o){return o in X?"\n\n```python\n"+o+" = "+X[o]+"\n```":""}ze.registerHoverProvider("python",{provideHover:function(o,e){const s=o.getWordAtPosition(e);if(!!s)return{contents:[{value:vt(s.word)}]}}});const gt=(o,e,s={})=>{var A;const t=q.create(o,{language:"python",value:e,minimap:{enabled:!1},readOnly:(A=s.readOnly)!=null?A:!1,contextmenu:!s.readOnly,automaticLayout:!s.readOnly,tabSize:4,fixedOverflowWidgets:!0,theme:s.theme?s.theme:"vs",fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:s.readOnly?0:5,scrollBeyondLastLine:!s.readOnly,renderLineHighlight:s.readOnly?"none":"all",scrollbar:{useShadows:!1,alwaysConsumeMouseWheel:!1}}),r=t.getContribution("editor.contrib.messageController");t.onDidAttemptReadOnlyEdit(()=>{r.showMessage("Cannot edit during preview execution",t.getPosition())});const f=t.createDecorationsCollection([]),_=(y,I)=>{f.set(y.map(v=>({range:new Ke(v.lineno,1,v.lineno,1),options:{isWholeLine:!0,className:I}}))),X=y.reduce((v,k)=>({...v,...k.locals}),{})};return{editor:t,highlight:(y,I)=>v=>{var $,E;const P=((E=($=v.debug)==null?void 0:$.stack)!=null?E:[]).filter(L=>L.filename.endsWith(I));_(P,y)},clearHighlights:()=>{f.clear(),X={}},setReadOnly:y=>{t.updateOptions({readOnly:y})}}},_t=(o,e,s)=>{const t=q.createModel(e),r=q.createModel(s),f=q.createDiffEditor(o,{minimap:{enabled:!1},readOnly:!0,contextmenu:!1,automaticLayout:!0,renderWhitespace:"none",guides:{indentation:!1},fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:0,scrollBeyondLastLine:!1,renderLineHighlight:"none"});return f.setModel({original:t,modified:r}),{diffEditor:f}};class mt{constructor(e,s){M(this,"_script");M(this,"_localEditorCode");M(this,"_monacoEditor");M(this,"_diffEditor");M(this,"_viewMode");M(this,"_alertMessage");M(this,"_conflictingChanges");this._localEditorCode=e,this._script=s,this._monacoEditor=null,this._diffEditor=null,this._viewMode=j("editor"),this._alertMessage=j(""),this._conflictingChanges=j(!1)}get alertMessage(){return this._alertMessage.value}set alertMessage(e){this._alertMessage.value=e}get conflictingChanges(){return this._conflictingChanges.value}set conflictingChanges(e){this._conflictingChanges.value=e}get viewMode(){return this._viewMode.value}set viewMode(e){this._viewMode.value=e}get abstraIDECode(){return this._script.codeContent}get localEditorCode(){return this._localEditorCode}set monacoEditor(e){this._monacoEditor=e}set diffEditor(e){this._diffEditor=e}finishPreview(){var e;this._viewMode.value="editor",this._script.codeContent=this._localEditorCode,(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.alertMessage=""}updateCodeWhileEditing(e){var r;const s=e!==this._localEditorCode;if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1;return}const t=!this._script.hasChanges("code_content");if(t){(r=this._monacoEditor)==null||r.setValue(e),this._script.codeContent=e,this._script.updateInitialState("code_content",e);return}if(!t&&s){this.alertMessage="You have conflicting changes with your local editor code",this.conflictingChanges=!0;return}}updateCodeWhileDiff(e){var s,t;if(e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1,this.viewMode="editor",this._localEditorCode=e;return}if(e!==this._localEditorCode){(t=(s=this._diffEditor)==null?void 0:s.getModel())==null||t.modified.setValue(e),this._localEditorCode=e;return}}updateCodeWhilePreview(e){if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="";return}this.alertMessage="The changes on your code will be shown after the preview stops running"}updateCode(e){switch(this._viewMode.value){case"editor":return this.updateCodeWhileEditing(e);case"diff":return this.updateCodeWhileDiff(e);case"preview":return this.updateCodeWhilePreview(e)}}keepAbstraIDECode(){var e;(e=this._monacoEditor)==null||e.setValue(this._script.codeContent),this._script.save("code_content"),this._script.updateInitialState("code_content",this._script.codeContent),this._localEditorCode=this._script.codeContent,this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}keepLocalEditor(){var e;(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}}const yt={class:"container"},Ct=K({__name:"SourceCode",props:{script:{},workspace:{},broker:{}},emits:["update-file"],setup(o,{expose:e,emit:s}){const t=o,r=()=>{!t.script.file||t.workspace.openFile(t.script.file)},f=()=>{l.value.viewMode="diff",J()},_=m(null),F=m(null);let R,O,A,y;const{result:I}=ue(()=>fetch("/_editor/api/workspace/root").then(n=>n.text())),v=m(t.script.file);se(()=>t.script.file,()=>v.value=t.script.file);const{result:k,refetch:P}=ue(()=>Ne.checkFile(v.value)),$=()=>{E.value.valid?s("update-file",Le(v.value)):s("update-file",v.value),P()},E=Q(()=>{var a;const n=Pe(v.value);return n.valid?((a=k.value)==null?void 0:a.exists)&&t.script.hasChanges("file")?{valid:!0,help:"This file already exists"}:t.script.hasChanges("file")?{valid:!0,help:"The original file will be renamed"}:n:n}),L=()=>{!t.workspace||!I.value||t.workspace.openFile(".")},w=m(!1),V=async()=>{var a;if(!t.script.file)return;const n=await t.workspace.readFile(t.script.file);if(n===null){w.value=!0;return}w.value=!1,(a=l.value)==null||a.updateCode(n)},l=j(null);let T;_e(()=>{G(),T=setInterval(V,1e3)}),me(()=>{clearInterval(T)}),se(()=>t.broker,()=>{O(),U()});const U=()=>{var n,a,g;(n=t.broker)==null||n.on("start",()=>{y(!0),l.value.viewMode="preview"}),(a=t.broker)==null||a.on("form",A("executing-line",t.script.file)),(g=t.broker)==null||g.on("program:end",x=>{var D;(D=l.value)==null||D.finishPreview(),y(!1),x.exception?A("error-line",t.script.file)(x):O()})},G=async()=>{await ge(),t.workspace.readFile(t.script.file).then(n=>{if(n===null)return;t.script.codeContent=n,t.script.updateInitialState("code_content",n),l.value=new mt(n,t.script);const a=gt(_.value,n);O=a.clearHighlights,A=a.highlight,y=a.setReadOnly,U(),R=a.editor,l.value.monacoEditor=R,R.onDidChangeModelContent(()=>{t.script.codeContent=R.getValue()})})},J=async()=>{const n=await t.workspace.readFile(t.script.file);if(!n)return;const a=t.script.codeContent,g=_t(F.value,a,n);l.value.diffEditor=g.diffEditor};return e({restartEditor:()=>{var n;O(),y(!1),(n=l.value)==null||n.finishPreview()}}),(n,a)=>{var x,D,ne,ae;const g=ye("icon");return p(),b(oe,null,[h(i(we),{"validate-status":E.value.valid?"success":"error",help:E.value.valid?E.value.help:E.value.reason},{default:u(()=>[h(i(Ce),{value:n.script.file,"onUpdate:value":a[0]||(a[0]=B=>n.script.file=B),onBlur:$},{addonBefore:u(()=>[i(I)?(p(),b("span",{key:0,class:"clickable",onClick:L},[h(g,{path:i(Ae)},null,8,["path"]),d("span",null,z(i(I)),1)])):S("",!0)]),addonAfter:u(()=>[d("span",{class:"clickable",onClick:r},[C(" Open in editor "),h(g,{path:i(Oe),width:"22"},null,8,["path"])])]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),(x=l.value)!=null&&x.alertMessage?(p(),W(i(Ve),{key:0,type:"warning","show-icon":""},{message:u(()=>{var B;return[C(z((B=l.value)==null?void 0:B.alertMessage),1)]}),action:u(()=>[l.value.conflictingChanges&&l.value.viewMode!=="diff"?(p(),W(i(de),{key:0,gap:"small"},{default:u(()=>[h(i(Y),{type:"primary",onClick:f},{default:u(()=>[C("Compare")]),_:1}),h(i(ee),null,{title:u(()=>[C("Keep the local editor version")]),default:u(()=>[h(i(Y),{onClick:a[1]||(a[1]=B=>l.value.keepLocalEditor())},{default:u(()=>[C("Discard")]),_:1})]),_:1})]),_:1})):S("",!0),l.value.conflictingChanges&&l.value.viewMode==="diff"?(p(),W(i(de),{key:1,gap:"small"},{default:u(()=>[h(i(ee),null,{title:u(()=>[C("Keep your current changes")]),default:u(()=>[h(i(Y),{onClick:a[2]||(a[2]=B=>l.value.keepAbstraIDECode())},{default:u(()=>[C("Keep left")]),_:1})]),_:1}),h(i(ee),null,{title:u(()=>[C("Keep the local editor version")]),default:u(()=>[h(i(Y),{onClick:a[3]||(a[3]=B=>l.value.keepLocalEditor())},{default:u(()=>[C("Keep right")]),_:1})]),_:1})]),_:1})):S("",!0)]),_:1})):S("",!0),d("div",yt,[d("div",{id:"code",ref_key:"codeComponent",ref:_,class:H(["code-container",{hide:((D=l.value)==null?void 0:D.viewMode)==="diff",blur:w.value}])},null,2),w.value?(p(),W(i(Ue),{key:0,class:"not-found-popup"},{title:u(()=>[C("File not found")]),_:1})):S("",!0)]),((ne=l.value)==null?void 0:ne.viewMode)==="diff"?(p(),b("div",{key:1,id:"code",ref_key:"codeDiffComponent",ref:F,class:H(["code-container",{hide:((ae=l.value)==null?void 0:ae.viewMode)!=="diff"}])},null,2)):S("",!0)],64)}}});const Pt=Z(Ct,[["__scopeId","data-v-975dd1bf"]]);export{be as L,Ht as R,Pt as S,Tt as a};
//# sourceMappingURL=SourceCode.f41bd402.js.map
