import{d as F,J as M,r as z,H as te,a as i,b as r,eu as y,f as e,w as t,bg as q,aJ as g,eC as P,ew as A,e as h,u as o,eB as X,c as N,t as W,K as ce,ez as ae,eD as ne,eE as oe,x as le,c4 as Z,bZ as pe,eA as me,eF as _e}from"./outputWidgets.51b6bae1.js";import{B as fe}from"./BaseLayout.e30e99fa.js";import{T as be}from"./tables.e98378f2.js";import{a as se}from"./asyncComputed.04a1cbef.js";import{p as j}from"./popupNotifcation.b955383b.js";import{L as ve}from"./CircularLoading.0e31148f.js";import{w as ye,Q as ge}from"./icons.368bb45e.js";import{A as ee}from"./index.a23c5517.js";import{P as he}from"./project.9be720b8.js";import"./router.0e749ad8.js";import{O as ke}from"./organization.96a804b9.js";import"./index.34206fda.js";import{T as Ce,A as G}from"./TabPane.c04f3b85.js";import{B as we,a as De,c as xe}from"./index.8de9b030.js";import"./gateway.29ac3ff5.js";import"./activeRecord.d956865b.js";import"./pubsub.933450ea.js";import"./string.0c00d7b9.js";import"./Title.32186eec.js";import"./index.a9533207.js";(function(){try{var d=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},p=new Error().stack;p&&(d._sentryDebugIds=d._sentryDebugIds||{},d._sentryDebugIds[p]="4fac8f6c-ea68-495f-99e8-c7885416cf49",d._sentryDebugIdIdentifier="sentry-dbid-4fac8f6c-ea68-495f-99e8-c7885416cf49")}catch{}})();const Ie={class:"table-data"},Te={key:1},$e=["onClick"],Be=h("a",null,"Delete",-1),Ee=F({__name:"TableData",props:{table:{}},setup(d){var E;const p=d,{result:l,loading:s,refetch:T}=se(()=>p.table.select()),w=M(()=>{var f;return[...(f=p.table)==null?void 0:f.getColumns().map(I=>({title:I.name,dataIndex:I.name})),{title:"Actions",key:"action",fixed:"right",width:100,align:"center"}]}),m=M(()=>{var c;return((c=l.value)==null?void 0:c.map(f=>({key:f.id,...f})))||[]}),D=z(!1),a=z({}),u=()=>{D.value=!0},x=()=>{a.value={},D.value=!1};let k=te((E=p.table)==null?void 0:E.getUnprotectedColumns().reduce((c,f)=>({...c,[f.name]:""}),{}));async function _(){if(!(!p.table||!k))try{if(a.value.id){await p.table.updateRow(a.value.id,a.value);return}else await p.table.insertRow(a.value);a.value={},T(),x()}catch(c){c instanceof Error&&j("Database error",c.message)}}const $=async c=>{if(!(!l.value||!l.value.find(f=>f.id===c)))try{await p.table.deleteRow(c),T()}catch(f){f instanceof Error&&j("Database error",f.message)}},R=c=>{var f;a.value=W.exports.pick(W.exports.cloneDeep((f=m.value)==null?void 0:f.filter(I=>c===I.key)[0]),p.table.getColumns().map(I=>I.name)),u()};return(c,f)=>{const I=i("a-divider"),b=i("a-popconfirm"),n=i("a-button"),v=i("a-table"),B=i("a-input"),K=i("a-form-item"),H=i("a-form"),J=i("a-space"),U=i("a-drawer");return r(),y("div",Ie,[e(v,{columns:w.value,"data-source":m.value,bordered:"",loading:o(s),scroll:{x:2e3,y:720}},{bodyCell:t(({column:S,text:L,record:O})=>[w.value.map(V=>V.title).includes(S.dataIndex)?(r(),y(q,{key:0},[g(P(L),1)],64)):A("",!0),S.key==="action"?(r(),y("div",Te,[h("span",null,[h("a",{onClick:V=>R(O.id)},"Edit",8,$e)]),e(I,{type:"vertical"}),e(b,{title:"Sure to delete?",onConfirm:V=>$(O.id)},{default:t(()=>[Be]),_:2},1032,["onConfirm"])])):A("",!0)]),footer:t(()=>[e(n,{type:"primary",onClick:u},{default:t(()=>[g("+ Add New Data")]),_:1})]),_:1},8,["columns","data-source","loading"]),e(U,{title:"Data",width:720,open:D.value,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:x},{extra:t(()=>[e(J,null,{default:t(()=>[e(n,{onClick:x},{default:t(()=>[g("Cancel")]),_:1}),e(n,{type:"primary",onClick:_},{default:t(()=>[g("Submit")]),_:1})]),_:1})]),default:t(()=>[e(H,{model:a.value,layout:"vertical"},{default:t(()=>[(r(!0),y(q,null,X(c.table.getUnprotectedColumns(),S=>(r(),N(K,{key:S.id,label:S.name},{default:t(()=>[a.value?(r(),N(B,{key:0,value:a.value[S.name],"onUpdate:value":L=>a.value[S.name]=L},null,8,["value","onUpdate:value"])):A("",!0)]),_:2},1032,["label"]))),128))]),_:1},8,["model"])]),_:1},8,["open"])])}}});const re=d=>(ne("data-v-1baac613"),d=d(),oe(),d),Se={class:"table-settings"},Ne={key:0},Ae=re(()=>h("span",null," protected ",-1)),Re=[Ae],Ue={key:1},ze=["onClick"],qe=re(()=>h("a",null,"Delete",-1)),Pe=F({__name:"TableColumns",props:{table:{},loading:{type:Boolean}},emits:["refresh"],setup(d,{emit:p}){var I;const l=d,s=z(l.loading);ce(()=>l.loading,()=>{s.value=l.loading});const T=["varchar","int","boolean","json","date","timestamp","uuid"],w=ae();(I=l.table)==null||I.onUpdate(()=>{var b;w.replace({name:"tableEditor",params:{tableName:(b=l.table)==null?void 0:b.name}})});const D=[...[{title:"Name",dataIndex:"name"},{title:"Type",dataIndex:"type"},{title:"Default Value",dataIndex:"default"},{title:"Nullable",dataIndex:"nullable"},{title:"Primary Key",dataIndex:"primaryKey"}],{title:"Actions",key:"action"}],a=z({name:"",type:"",nullable:!0,unique:!1}),u=()=>{a.value={name:"",type:"",nullable:!0,unique:!1}},x=M(()=>{var b;return(b=l.table)==null?void 0:b.getColumns().map(n=>({name:n.name,type:n.type,default:n.default,nullable:n.nullable,primaryKey:n.primaryKey,id:n.id,unique:n.unique}))}),k=z(!1),_=()=>{k.value=!0},$=()=>{k.value=!1};function R(b){var n,v;(v=(n=l.table)==null?void 0:n.getColumn(b))==null||v.delete(),s.value=!0,setTimeout(()=>{p("refresh")},2e3)}async function E(){var b;if(!!l.table&&!(!a.value.name||!a.value.type)){if(a.value.id){const n=(b=l.table)==null?void 0:b.getColumn(a.value.id);if(!n)return;const{success:v,error:B}=await n.update(a.value);v||j("Database error",B)}else{const{success:n,error:v}=await l.table.addColumn(a.value);n||j("Database error",v)}u(),s.value=!0,$(),setTimeout(()=>{p("refresh")},2e3)}}const c=b=>{var n,v,B;return(B=(v=(n=l.table)==null?void 0:n.getColumn(b))==null?void 0:v.protected)!=null?B:!1},f=b=>{var v;const n=W.exports.cloneDeep((v=x.value)==null?void 0:v.filter(B=>B.id===b));!n||(a.value=n[0],_())};return(b,n)=>{const v=i("a-divider"),B=i("a-popconfirm"),K=i("a-button"),H=i("a-table"),J=i("a-input"),U=i("a-form-item"),S=i("a-select-option"),L=i("a-select"),O=i("a-switch"),V=i("a-form"),ie=i("a-space"),ue=i("a-drawer");return r(),y("div",Se,[e(H,{columns:D,"data-source":x.value,bordered:"",loading:s.value,pagination:!1},{bodyCell:t(({column:C,text:de,record:Q})=>[C.key!=="action"?(r(),y(q,{key:0},[g(P(de),1)],64)):(r(),y(q,{key:1},[c(Q.id)?(r(),y("div",Ne,Re)):(r(),y("div",Ue,[h("span",null,[h("a",{onClick:()=>f(Q.id)},"Edit",8,ze)]),e(v,{type:"vertical"}),e(B,{title:"Sure to delete?",onConfirm:et=>R(Q.id)},{default:t(()=>[qe]),_:2},1032,["onConfirm"])]))],64))]),footer:t(()=>[e(K,{type:"primary",onClick:_},{default:t(()=>[g("+ Add New Column")]),_:1})]),_:1},8,["data-source","loading"]),e(ue,{title:"Column",width:720,open:k.value,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:$},{extra:t(()=>[e(ie,null,{default:t(()=>[e(K,{onClick:$},{default:t(()=>[g("Cancel")]),_:1}),e(K,{type:"primary",onClick:E},{default:t(()=>[g("Submit")]),_:1})]),_:1})]),default:t(()=>[e(V,{model:a.value,layout:"vertical"},{default:t(()=>[e(U,{key:"name",label:"Name"},{default:t(()=>[e(J,{value:a.value.name,"onUpdate:value":n[0]||(n[0]=C=>a.value.name=C)},null,8,["value"])]),_:1}),e(U,{key:"type",label:"Type"},{default:t(()=>[e(L,{value:a.value.type,"onUpdate:value":n[1]||(n[1]=C=>a.value.type=C),"default-active-first-option":""},{default:t(()=>[(r(),y(q,null,X(T,C=>e(S,{key:C,value:C},{default:t(()=>[g(P(C),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1}),e(U,{key:"nullable",label:"Nullable"},{default:t(()=>[e(O,{checked:a.value.nullable,"onUpdate:checked":n[2]||(n[2]=C=>a.value.nullable=C)},null,8,["checked"])]),_:1}),e(U,{key:"unique",label:"Unique"},{default:t(()=>[e(O,{checked:a.value.unique,"onUpdate:checked":n[3]||(n[3]=C=>a.value.unique=C)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])])}}});const je=le(Pe,[["__scopeId","data-v-1baac613"]]),Y=d=>(ne("data-v-06f57b7a"),d=d(),oe(),d),Ke={class:"table-settings"},Le=Y(()=>h("h2",{class:"title"},"Table settings",-1)),Oe=Y(()=>h("div",{class:"subtitle"},"Edit table metadata",-1)),Ve={key:0,class:"table-presenter"},Me={class:"table-property-item"},Fe={class:"property-item"},He={key:1},Je={class:"change-warning"},Qe={class:"section-title"},Ze=Y(()=>h("div",{class:"section-body"}," Changing the table's name can possibly result in the break of running applications. ",-1)),Ge={class:"table-name-value-input"},We={key:0,class:"error"},Xe=F({__name:"TableSettings",props:{table:{}},emits:["refresh"],setup(d,{emit:p}){const l=d,s=te({error:"",editing:!1,loading:!1}),T=()=>s.editing=!0,w=()=>{l.table.resetChanges(),s.editing=!1,s.error=""},m=async()=>{s.error="",s.loading=!0;try{await D()}catch(u){u instanceof Error&&(j("Database error",u.message),s.error=u.message)}s.error||(s.editing=!1),s.loading=!1},D=async()=>{if(!l.table.name){s.error="Table name cannot be empty";return}try{await l.table.save(),p("refresh")}catch(u){u instanceof Error&&(j("Database error",u.message),s.error=u.message)}},a=u=>{l.table.name=u.target.value};return(u,x)=>{var _;const k=i("icon");return r(),y("div",Ke,[Le,Oe,s.editing?(r(),y("div",He,[h("div",Je,[h("div",Qe,[e(k,{path:o(ye),width:"12",height:"12",fill:"#D35249"},null,8,["path"]),g(" Be careful ")]),Ze]),e(o(ee),{direction:"vertical"},{default:t(()=>[h("div",Ge,[e(o(pe),{value:u.table.name,type:"text",onInput:a,onBlur:x[0]||(x[0]=$=>u.table.fixTraillingName())},null,8,["value"])]),s.error?(r(),y("div",We,[e(k,{path:o(ge),fill:"#D35249",width:"12",height:"12"},null,8,["path"]),g(" "+P(s.error),1)])):A("",!0),e(o(ee),null,{default:t(()=>[e(o(Z),{onClick:w},{default:t(()=>[g("Cancel")]),_:1}),e(o(Z),{type:"primary",disabled:!u.table.hasChangesDeep("name"),onClick:m},{default:t(()=>[g(" Save Changes "),s.loading?(r(),N(ve,{key:0,size:"16"})):A("",!0)]),_:1},8,["disabled"])]),_:1})]),_:1})])):(r(),y("div",Ve,[h("div",Me,[h("div",Fe,"Name: "+P((_=u.table)==null?void 0:_.name),1)]),e(o(Z),{onClick:T},{default:t(()=>[g("Edit Name")]),_:1})]))])}}});const Ye=le(Xe,[["__scopeId","data-v-06f57b7a"]]),kt=F({__name:"TableEditor",setup(d){const p=ae(),l=me(),s=l.params.tableId,T=l.params.projectId,w=z("data"),{result:m,loading:D,refetch:a}=se(()=>Promise.all([he.get(T).then(async k=>{const _=await ke.get(k.organizationId);return{project:k,organization:_}}),be.get(T,s)]).then(([{project:k,organization:_},$])=>_e({project:k,organization:_,table:$}))),u=M(()=>!D.value&&m.value?[{label:"My organizations",path:"/organizations"},{label:m.value.organization.name,path:`/organizations/${m.value.organization.id}`},{label:m.value.project.name,path:`/projects/${m.value.project.id}/tables`}]:void 0);function x(){p.push({name:"tables",params:{projectId:T}})}return(k,_)=>{const $=i("router-link");return r(),N(fe,null,{navbar:t(()=>{var R;return[e(o(xe),{title:(R=o(m))==null?void 0:R.table.name,style:{padding:"5px 10px"},onBack:x},{footer:t(()=>[e(o(Ce),{"active-key":w.value,"onUpdate:activeKey":_[0]||(_[0]=E=>w.value=E)},{default:t(()=>[e(o(G),{key:"data",tab:"Data"}),e(o(G),{key:"columns",tab:"Columns"}),e(o(G),{key:"settings",tab:"Settings"})]),_:1},8,["active-key"])]),breadcrumb:t(()=>[u.value?(r(),N(o(we),{key:0},{default:t(()=>[(r(!0),y(q,null,X(u.value,(E,c)=>(r(),N(o(De),{key:c},{default:t(()=>[e($,{to:E.path},{default:t(()=>[g(P(E.label),1)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1})):A("",!0)]),_:1},8,["title"])]}),content:t(()=>[o(m)&&w.value==="data"?(r(),N(Ee,{key:0,loading:o(D),table:o(m).table},null,8,["loading","table"])):A("",!0),o(m)&&w.value==="columns"?(r(),N(je,{key:1,table:o(m).table,loading:o(D),onRefresh:_[1]||(_[1]=R=>o(a)())},null,8,["table","loading"])):A("",!0),o(m)&&w.value==="settings"?(r(),N(Ye,{key:2,table:o(m).table,loading:o(D),onRefresh:_[2]||(_[2]=R=>o(a)())},null,8,["table","loading"])):A("",!0)]),_:1})}}});export{kt as default};
//# sourceMappingURL=TableEditor.5998cd4f.js.map
