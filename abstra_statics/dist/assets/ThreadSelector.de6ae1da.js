import{d as O,H as S,eM as D,r as P,o as V,J as E,G as B,b as v,ev as L,f as u,w as c,u as d,ae as M,ar as x,e as A,c as R,I as U,bG as b,ex as k,eD as W,aD as G,eE as q,eF as z,v as H}from"./outputWidgets.809f1c57.js";import{W as I}from"./workspaces.e780abe0.js";import"./envVars.af90a51f.js";import{e as K}from"./toggleHighContrast.da595f42.js";import{v as Q}from"./string.c0f7416e.js";import{D as X}from"./icons.8975fdbd.js";import{f as y}from"./index.80dbf5e3.js";import{A as Y,F as Z}from"./Form.023148df.js";import{A as tt}from"./index.172b9854.js";import{A as F}from"./index.ee508a43.js";import{A as et}from"./index.6c6ae89c.js";(function(){try{var r=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(r._sentryDebugIds=r._sentryDebugIds||{},r._sentryDebugIds[e]="bd4f8bf8-9dd6-456e-82ac-21e5491f7b5a",r._sentryDebugIdIdentifier="sentry-dbid-bd4f8bf8-9dd6-456e-82ac-21e5491f7b5a")}catch{}})();class at{async list(e){const a=new URLSearchParams({stage:e});return await(await fetch(`/_editor/api/stage_runs?${a}`)).json()}async listPast(e){const a=new URLSearchParams({stage:e});return await(await fetch(`/_editor/api/stage_runs/past?${a}`)).json()}async fork(e,a){return(await fetch("/_editor/api/stage_runs/fork",{method:"POST",body:JSON.stringify({stage_run_id:e,custom_thread_data:a}),headers:{"Content-Type":"application/json"}})).json()}}const _=new at;class g{constructor(e){this.dto=e}static async list(e){return(await _.list(e)).map(l=>new g(l))}static async listPast(e){return(await _.listPast(e)).map(l=>new g(l))}async fork(e){const a=await _.fork(this.id,e);return new g(a)}get id(){return this.dto.id}get data(){return this.dto.data}get assignee(){return this.dto.assignee}get stage(){return this.dto.stage}get status(){return this.dto.status}get createdAt(){return new Date(this.dto.createdAt)}}const nt=r=>(q("data-v-b546d951"),r=r(),z(),r),st=nt(()=>A("span",null," Fix with AI ",-1)),ot=O({__name:"ThreadSelector",props:{stage:{},executionConfig:{}},emits:["fix-invalid-json","update:execution-config","update:show-thread-modal"],setup(r,{emit:e}){const a=r,l=S(()=>a.executionConfig.attached?"Select a thread to continue the workflow":"Choose a thread to copy the data from"),w=S(()=>a.executionConfig.attached?"Select thread":"Use this thread data"),m=S(()=>{if(!t.threadData)return{valid:!0,parsed:{}};const n=Q(t.threadData);return n.valid&&!D.exports.isObject(n.parsed)?{valid:!1,message:"Thread data must be an object."}:n});function T(){m.value.valid||e("fix-invalid-json",t.threadData,m.value.message)}const C=P(null),j=n=>{const s=t.waitingStageRuns.find(f=>f.id===n),i=t.pastStageRuns.find(f=>f.id===n),o=s!=null?s:i;if(!o)throw new Error("Stage run not found");const h=JSON.stringify(o.data,null,2);p.setValue(h),t.threadData=h,t.selectedStageRunId=n,e("update:execution-config",{...a.executionConfig,stageRunId:n,pendingFork:!!i})},N=()=>{e("update:execution-config",{...a.executionConfig,stageRunId:null,pendingFork:!1})},J=()=>{e("update:show-thread-modal",!1),I.writeTestData(t.threadData)},$=async()=>{const n=[...t.waitingStageRuns,...t.pastStageRuns].find(i=>i.id===a.executionConfig.stageRunId),s=await(n==null?void 0:n.fork(t.threadData));if(s){e("update:execution-config",{...a.executionConfig,pendingFork:!1,stageRunId:s==null?void 0:s.id});const i={value:s.id,label:`Started ${y(new Date(s.createdAt),{addSuffix:!0})} (${s.status})`};t.options[0].options.unshift(i),t.waitingStageRuns.push(s),t.threadData=JSON.stringify(s.data,null,2),t.selectedStageRunId=s.id,p.setValue(t.threadData)}};let p;V(async()=>{var i;t.threadData=await I.readTestData(),t.selectedStageRunId=(i=a.executionConfig.stageRunId)!=null?i:void 0;const n=await g.list(a.stage.id),s=await g.listPast(a.stage.id);t.waitingStageRuns=n.filter(o=>o.status==="waiting"),t.pastStageRuns=[...s,...n.filter(o=>o.status!=="waiting")],t.options=[],t.waitingStageRuns.length>0&&t.options.push({label:"Waiting threads",options:t.waitingStageRuns.map(o=>({value:o.id,label:`Started ${y(o.createdAt,{addSuffix:!0})} (${o.status})`}))}),t.pastStageRuns.length>0&&t.options.push({label:"Past threads",options:t.pastStageRuns.map(o=>({value:o.id,label:`Started ${y(o.createdAt,{addSuffix:!0})} (${o.status})`}))}),p=K.create(C.value,{language:"json",value:t.threadData,fontFamily:"monospace",lineNumbers:"off",minimap:{enabled:!1},scrollbar:{vertical:"hidden",horizontal:"visible"}}),p.onDidChangeModelContent(()=>{const o=p.getValue();if(t.threadData=o,a.executionConfig.attached&&t.selectedStageRunId){const h=[...t.waitingStageRuns,...t.pastStageRuns].find(f=>f.id===t.selectedStageRunId);if(!h){e("update:execution-config",{...a.executionConfig,pendingFork:!0});return}try{const f=JSON.parse(o);D.exports.isEqual(h.data,f)?e("update:execution-config",{...a.executionConfig,pendingFork:!1}):e("update:execution-config",{...a.executionConfig,pendingFork:!0})}catch{e("update:execution-config",{...a.executionConfig,pendingFork:!0})}}})}),E(()=>a.executionConfig.stageRunId,n=>{n?t.selectedStageRunId=n:t.selectedStageRunId=void 0});const t=B({waitingStageRuns:[],pastStageRuns:[],options:[],loading:!1,threadData:"{}",selectedStageRunId:void 0});return(n,s)=>(v(),L(G,null,[u(d(Z),{layout:"vertical"},{default:c(()=>[u(d(Y),{label:l.value},{default:c(()=>[u(d(M),{placeholder:"No thread selected","filter-option":"",style:{width:"100%"},"allow-clear":!0,options:t.options,value:t.selectedStageRunId,"not-found-content":"There are no threads",onSelect:s[0]||(s[0]=i=>j(i)),onClear:s[1]||(s[1]=i=>N())},null,8,["options","value"])]),_:1},8,["label"])]),_:1}),u(d(tt),{orientation:"left"},{default:c(()=>[x("Data")]),_:1}),A("div",{ref_key:"dataJson",ref:C,class:"data-container"},null,512),m.value.valid===!1?(v(),R(d(et),{key:0,type:"error",message:"Invalid JSON",description:m.value.message},{action:c(()=>[u(d(b),{onClick:T},{default:c(()=>[u(d(F),{align:"center",gap:"small"},{default:c(()=>[u(U,{path:d(X)},null,8,["path"]),st]),_:1})]),_:1})]),_:1},8,["description"])):k("",!0),u(d(F),{justify:"end",gap:"middle",style:{"margin-top":"12px"}},{default:c(()=>[n.executionConfig.attached&&n.executionConfig.pendingFork?(v(),R(d(b),{key:0,onClick:$},{default:c(()=>[x("Fork")]),_:1})):k("",!0),u(d(b),{type:"primary",disabled:n.executionConfig.attached&&n.executionConfig.pendingFork,onClick:J},{default:c(()=>[x(W(w.value),1)]),_:1},8,["disabled"])]),_:1})],64))}});const wt=H(ot,[["__scopeId","data-v-b546d951"]]);export{wt as T};
//# sourceMappingURL=ThreadSelector.de6ae1da.js.map
