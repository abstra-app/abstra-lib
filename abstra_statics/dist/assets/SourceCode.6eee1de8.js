var be=Object.defineProperty;var Me=(o,e,t)=>e in o?be(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var E=(o,e,t)=>(Me(o,typeof e!="symbol"?e+"":e,t),t);import{u as te}from"./uuid.4939677b.js";import{G as he,d as N,r as _,S as ie,H as q,b as h,ev as w,e as d,ez as $,eE as fe,eF as ve,v as Q,eB as Se,J as ge,a4 as _e,o as me,L as ye,a as Ce,f as p,u as i,I as L,ar as m,eD as P,ex as b,ew as Ie,a$ as se,eC as xe,c as A,eT as De,eV as Fe,eI as Oe,w as r,bO as we,F as Y,b3 as U,bV as J}from"./outputWidgets.c849273f.js";import{k as le,l as re,n as ce,d as Re,o as Ae,q as We}from"./icons.5de06bbc.js";import{l as Be}from"./NavbarControls.ba003e1f.js";import{H as $e,J as He}from"./jobs.d7cdb02e.js";import{S as Te}from"./scripts.116ad04f.js";import{n as Le,v as Pe,a as Ne}from"./validations.f7f35132.js";import{A as ke}from"./FormItem.8767aead.js";import{W as Ve}from"./workspaces.d3b33248.js";import{a as ue}from"./asyncComputed.53ec0023.js";import{l as ze,e as j,R as Ke}from"./toggleHighContrast.26f55f0a.js";import{A as de}from"./index.d9979e5f.js";import{A as Ue}from"./index.df190dd4.js";import{C as Je}from"./Card.d04ea65c.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[e]="e21b4284-bf89-4eaa-a889-b8367bc95d14",o._sentryDebugIdIdentifier="sentry-dbid-e21b4284-bf89-4eaa-a889-b8367bc95d14")}catch{}})();class Ee{constructor(){E(this,"logState",he({log:[]}));E(this,"_listeners",{})}static create(){return new Ee}get logs(){return this.logState.log}log(e,t){if(e.type!=="restart"&&e.log.trim()==="")return;const s=t?this.logs.find(l=>l.id===t):null;return s?Object.assign(s,e):this.logs.push({...e,id:t||te()}),this.notifyListeners(e),t}clear(){this.logState.log=[]}listen(e){const t=te();return this._listeners[t]=e,t}unlisten(e){delete this._listeners[e]}notifyListeners(e){Object.values(this._listeners).forEach(t=>t(e))}}class Ye{static async*sendMessage(e,t){var f;const l=(f=(await fetch("/_editor/api/ai/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e,runtime:t})})).body)==null?void 0:f.getReader();if(!l)throw new Error("No response body");for(;;){const g=await l.read();if(g.done)break;yield new TextDecoder().decode(g.value)}}}const je=o=>(fe("data-v-59ca7295"),o=o(),ve(),o),qe=je(()=>d("div",{class:"text"}," Changes were made in your code. Click Restart to refresh the preview window. ",-1)),pe="ignoreCodeChangesWarning",Ge=N({__name:"ChangesWarning",props:{hasChanges:{type:Boolean}},setup(o){var f;const e=o,t=_((f=ie.get(pe))!=null?f:!1),s=q(()=>e.hasChanges&&!t.value),l=()=>{ie.set(pe,!0),t.value=!0};return(g,I)=>(h(),w("div",{class:$(["changes-warning",{visible:s.value}])},[qe,d("div",{class:"no-more-alert",onClick:l},"Do not show again")],2))}});const Qe=Q(Ge,[["__scopeId","data-v-59ca7295"]]),Xe=o=>(fe("data-v-5747cc18"),o=o(),ve(),o),Ze={class:"smart-console"},et={class:"header"},tt={class:"left"},st={class:"right"},ot={class:"changes-container"},nt=["unseen-severity"],at={class:"cli"},it={class:"left"},lt=Xe(()=>d("div",{class:"entry ai-output"}," Hello there! I'm both an output console and AI assistant. You can ask me anything. ",-1)),rt={key:1,class:"local-entry"},ct={class:"input"},ut=["pointer-events","onKeydown"],dt={class:"right"},pt=N({__name:"SmartConsole",props:{inputEnabled:{type:Boolean},formCode:{},runtime:{},logService:{}},emits:["eval-request","clear-terminal","enter"],setup(o,{emit:e}){const t=o,s=_(""),l=_(null),f=Se(),g=_({type:"seen"}),I=_(!1),x=_(!1),H=()=>{k.value=k.value==="assistant"?"debugger":"assistant"};function D(c){switch(c.type){case"ai-input":return{role:"user",content:c.log};case"ai-output":return{role:"assistant",content:c.log};case"stderr":case"stdout":return{role:"user",content:c.log};case"restart":return{role:"user",content:"-- new session --"};case"files-changed":return{role:"user",content:"-- files changed --"};default:throw new Error(`Unknown log type: ${c.type}`)}}const y=q(()=>t.logService.logs.some(c=>c.type==="files-changed"));function M(){C.value=!C.value,C.value&&(g.value={type:"seen"})}ge(f,()=>{t.logService.clear(),e("clear-terminal")});const v=_(null),k=_("assistant"),T=async c=>{var S;if(c.preventDefault(),s.value=((S=v.value)==null?void 0:S.innerText)||"",c.shiftKey){document.execCommand("insertLineBreak");return}v.value&&(v.value.innerText=""),k.value==="assistant"?await X():await O()},X=async()=>{var S;if(e("enter",s.value),t.logService.log({type:"ai-input",log:s.value}),s.value="",!x.value){t.logService.log({type:"stderr",log:"Please login to use the AI assistant."});return}I.value=!0;const c={role:"user",content:(S=t.formCode)!=null?S:""};try{const n=te();let a="";const F=Ye.sendMessage([c,...t.logService.logs.map(B=>D(B)),{role:"user",content:s.value}],t.runtime);for await(const B of F)a+=B,t.logService.log({type:"ai-output",log:a},n)}catch(n){t.logService.log({type:"ai-output",log:"Sorry, I don't know how to answer that."}),console.error(n),Fe(n)}finally{I.value=!1}},O=async()=>{s.value&&(t.logService.log({type:"eval-input",log:`>>> ${s.value}`}),e("eval-request",s.value),s.value="")},Z=()=>{t.logService.clear()};t.logService.listen(async c=>{C.value||(g.value={type:"unseen",count:g.value.type==="unseen"?g.value.count+1:1,severity:c.type==="stderr"?"error":"info"}),c.type!=="restart"&&(await _e(),l.value&&(l.value.scrollTop=l.value.scrollHeight))});const C=_(!1),V=_(400),u=q(()=>({height:`${V.value}px`})),W=_(!1),ee=()=>W.value=!0,z=c=>{!W.value||(V.value=document.body.clientHeight-c.clientY)},K=()=>W.value=!1;return me(()=>{document.addEventListener("mousemove",z),document.addEventListener("mouseup",K),Be.get().then(c=>{x.value=!!c.logged})}),ye(()=>{document.removeEventListener("mousemove",z),document.removeEventListener("mouseup",K)}),(c,S)=>{const n=Ce("Markdown");return h(),w("div",Ze,[d("div",et,[d("div",tt,[p(L,{path:k.value==="assistant"?i(le):i(re)},null,8,["path"]),m(" Smart Console ")]),d("div",st,[d("div",ot,[p(Qe,{"has-changes":y.value},null,8,["has-changes"])]),d("div",{class:"toggle-button",onClick:M},[p(L,{class:$(["icon",{open:C.value}]),path:i(ce),fill:"#fff"},null,8,["class","path"]),g.value.type==="unseen"?(h(),w("div",{key:0,class:"unseen-count","unseen-severity":g.value.severity},P(g.value.count),9,nt)):b("",!0)])])]),C.value?(h(),w("div",{key:0,class:"terminal",style:Ie(u.value)},[d("div",{class:"resize-handler",onMousedown:ee},null,32),d("div",at,[d("div",it,[d("div",{ref_key:"entriesContainer",ref:l,class:"entries"},[lt,(h(!0),w(se,null,xe(t.logService.logs,(a,F)=>(h(),w("div",{key:F,class:$([a.type,"entry"])},[a.type==="ai-output"?(h(),A(n,{key:0,source:a.log},null,8,["source"])):(h(),w("div",rt,P(a.type==="restart"?"-- restarted --":a.log),1))],2))),128))],512),d("div",ct,[p(L,{class:$(["icon",{open:C.value}]),path:i(ce)},null,8,["class","path"]),d("div",{ref_key:"inputRef",ref:v,class:"input-text",contenteditable:"","pointer-events":I.value?"none":"auto",placeholder:"Ask AI anything",onKeydown:De(T,["enter"])},null,40,ut)])]),d("div",dt,[d("div",{class:"icons",onClick:Z},[p(L,{class:"icon",path:i(Re)},null,8,["path"])]),d("div",null,[p(L,{class:"icon clickable",path:k.value==="assistant"?i(le):i(re),onClick:S[0]||(S[0]=a=>H())},null,8,["path"])])])])],4)):b("",!0)])}}});const Ht=Q(pt,[["__scopeId","data-v-5747cc18"]]),ht=N({__name:"PathInput",props:{runtime:{}},setup(o){const e=o,t=()=>{const s=Le(e.runtime.path);s&&s!==e.runtime.path&&(e.runtime.path=s)};return(s,l)=>(h(),A(i(we),{value:s.runtime.path,"onUpdate:value":l[0]||(l[0]=f=>s.runtime.path=f),type:"text",onBlur:t},Oe({_:2},[s.runtime instanceof i($e)?{name:"addonBefore",fn:r(()=>[m(" https://[your-subdomain].abstra.app/_hooks/ ")]),key:"0"}:{name:"addonBefore",fn:r(()=>[m(" https://[your-subdomain].abstra.app/ ")]),key:"1"}]),1032,["value"]))}}),ft={key:1},vt=N({__name:"RuntimeCommonSettings",props:{runtime:{}},setup(o){const e=he({pathError:null});return(t,s)=>(h(),w(se,null,[t.runtime instanceof i(He)||t.runtime instanceof i(Te)?b("",!0):(h(),A(i(ke),{key:0,label:"URL path"},{default:r(()=>[p(ht,{runtime:t.runtime},null,8,["runtime"])]),_:1})),e.pathError?(h(),w("div",ft,P(e.pathError),1)):b("",!0)],64))}});const Tt=Q(vt,[["__scopeId","data-v-60a397e0"]]);let G={};function gt(o){return o in G?"\n\n```python\n"+o+" = "+G[o]+"\n```":""}ze.registerHoverProvider("python",{provideHover:function(o,e){const t=o.getWordAtPosition(e);if(!!t)return{contents:[{value:gt(t.word)}]}}});const _t=(o,e,t={})=>{var D;const s=j.create(o,{language:"python",value:e,minimap:{enabled:!1},readOnly:(D=t.readOnly)!=null?D:!1,contextmenu:!t.readOnly,automaticLayout:!t.readOnly,tabSize:4,fixedOverflowWidgets:!0,theme:t.theme?t.theme:"vs",fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:t.readOnly?0:5,scrollBeyondLastLine:!t.readOnly,renderLineHighlight:t.readOnly?"none":"all",scrollbar:{useShadows:!1,alwaysConsumeMouseWheel:!1}}),l=s.getContribution("editor.contrib.messageController");s.onDidAttemptReadOnlyEdit(()=>{l.showMessage("Cannot edit during preview execution",s.getPosition())});const f=s.createDecorationsCollection([]),g=(y,M)=>{f.set(y.map(v=>({range:new Ke(v.lineno,1,v.lineno,1),options:{isWholeLine:!0,className:M}}))),G=y.reduce((v,k)=>({...v,...k.locals}),{})};return{editor:s,highlight:(y,M)=>v=>{const k=v.filter(T=>T.filename.endsWith(M));g(k,y)},clearHighlights:()=>{f.clear(),G={}},setReadOnly:y=>{s.updateOptions({readOnly:y})}}},mt=(o,e,t)=>{const s=j.createModel(e),l=j.createModel(t),f=j.createDiffEditor(o,{minimap:{enabled:!1},readOnly:!0,contextmenu:!1,automaticLayout:!0,renderWhitespace:"none",guides:{indentation:!1},fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:0,scrollBeyondLastLine:!1,renderLineHighlight:"none"});return f.setModel({original:s,modified:l}),{diffEditor:f}};class yt{constructor(e,t){E(this,"_script");E(this,"_localEditorCode");E(this,"_monacoEditor");E(this,"_diffEditor");E(this,"_viewMode");E(this,"_alertMessage");E(this,"_conflictingChanges");this._localEditorCode=e,this._script=t,this._monacoEditor=null,this._diffEditor=null,this._viewMode=Y("editor"),this._alertMessage=Y(""),this._conflictingChanges=Y(!1)}get alertMessage(){return this._alertMessage.value}set alertMessage(e){this._alertMessage.value=e}get conflictingChanges(){return this._conflictingChanges.value}set conflictingChanges(e){this._conflictingChanges.value=e}get viewMode(){return this._viewMode.value}set viewMode(e){this._viewMode.value=e}get abstraIDECode(){return this._script.codeContent}get localEditorCode(){return this._localEditorCode}set monacoEditor(e){this._monacoEditor=e}set diffEditor(e){this._diffEditor=e}finishPreview(){var e;this._viewMode.value="editor",this._script.codeContent=this._localEditorCode,(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.alertMessage=""}updateCodeWhileEditing(e){var l;const t=e!==this._localEditorCode;if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1;return}const s=!this._script.hasChanges("code_content");if(s){(l=this._monacoEditor)==null||l.setValue(e),this._script.codeContent=e,this._script.updateInitialState("code_content",e);return}if(!s&&t){this.alertMessage="You have conflicting changes with your local editor code",this.conflictingChanges=!0;return}}updateCodeWhileDiff(e){var t,s;if(e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1,this.viewMode="editor",this._localEditorCode=e;return}if(e!==this._localEditorCode){(s=(t=this._diffEditor)==null?void 0:t.getModel())==null||s.modified.setValue(e),this._localEditorCode=e;return}}updateCodeWhilePreview(e){if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="";return}this.alertMessage="The changes on your code will be shown after the preview stops running"}updateCode(e){switch(this._viewMode.value){case"editor":return this.updateCodeWhileEditing(e);case"diff":return this.updateCodeWhileDiff(e);case"preview":return this.updateCodeWhilePreview(e)}}keepAbstraIDECode(){var e;(e=this._monacoEditor)==null||e.setValue(this._script.codeContent),this._script.save("code_content"),this._script.updateInitialState("code_content",this._script.codeContent),this._localEditorCode=this._script.codeContent,this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}keepLocalEditor(){var e;(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}}const Ct={class:"container"},wt=N({__name:"SourceCode",props:{script:{},workspace:{}},emits:["update-file"],setup(o,{expose:e,emit:t}){const s=o,l=()=>{!s.script.file||s.workspace.openFile(s.script.file)},f=()=>{u.value.viewMode="diff",c()},g=_(null),I=_(null);let x,H,D,y;const{result:M}=ue(()=>fetch("/_editor/api/workspace/root").then(n=>n.text())),v=_(s.script.file);ge(()=>s.script.file,()=>v.value=s.script.file);const{result:k,refetch:T}=ue(()=>Ve.checkFile(v.value)),X=()=>{O.value.valid?t("update-file",Ne(v.value)):t("update-file",v.value),T()},O=q(()=>{var a;const n=Pe(v.value);return n.valid?((a=k.value)==null?void 0:a.exists)&&s.script.hasChanges("file")?{valid:!0,help:"This file already exists"}:s.script.hasChanges("file")?{valid:!0,help:"The original file will be renamed"}:n:n}),Z=()=>{!s.workspace||!M.value||s.workspace.openFile(".")},C=_(!1),V=async()=>{var a;if(!s.script.file)return;const n=await s.workspace.readFile(s.script.file);if(n===null){C.value=!0;return}C.value=!1,(a=u.value)==null||a.updateCode(n)},u=Y(null);let W;me(()=>{K(),W=setInterval(V,1e3)}),ye(()=>{clearInterval(W)});const ee=()=>{y(!0),u.value.viewMode="preview"},z=(n,a)=>{if(a)return D("error-line",s.script.file)(n);D("executing-line",s.script.file)(n)},K=async()=>{await _e(),s.workspace.readFile(s.script.file).then(n=>{if(n===null)return;s.script.codeContent=n,s.script.updateInitialState("code_content",n),u.value=new yt(n,s.script);const a=_t(g.value,n);H=a.clearHighlights,D=a.highlight,y=a.setReadOnly,x=a.editor,u.value.monacoEditor=x,x.onDidChangeModelContent(()=>{s.script.codeContent=x.getValue()})})},c=async()=>{const n=await s.workspace.readFile(s.script.file);if(!n)return;const a=s.script.codeContent,F=mt(I.value,a,n);u.value.diffEditor=F.diffEditor};return e({startPreviewMode:ee,setHighlight:z,restartEditor:()=>{var n;H(),y(!1),(n=u.value)==null||n.finishPreview()}}),(n,a)=>{var B,oe,ne,ae;const F=Ce("icon");return h(),w(se,null,[p(i(ke),{"validate-status":O.value.valid?"success":"error",help:O.value.valid?O.value.help:O.value.reason},{default:r(()=>[p(i(we),{value:n.script.file,"onUpdate:value":a[0]||(a[0]=R=>n.script.file=R),onBlur:X},{addonBefore:r(()=>[i(M)?(h(),w("span",{key:0,class:"clickable",onClick:Z},[p(i(U),{placement:"bottomLeft","overlay-style":{maxWidth:"none"}},{title:r(()=>[m(P(i(M)),1)]),default:r(()=>[p(F,{path:i(Ae)},null,8,["path"])]),_:1})])):b("",!0)]),addonAfter:r(()=>[d("span",{class:"clickable",onClick:l},[m(" Open in editor "),p(F,{path:i(We),width:"22"},null,8,["path"])])]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),(B=u.value)!=null&&B.alertMessage?(h(),A(i(Ue),{key:0,type:"warning","show-icon":""},{message:r(()=>{var R;return[m(P((R=u.value)==null?void 0:R.alertMessage),1)]}),action:r(()=>[u.value.conflictingChanges&&u.value.viewMode!=="diff"?(h(),A(i(de),{key:0,gap:"small"},{default:r(()=>[p(i(J),{type:"primary",onClick:f},{default:r(()=>[m("Compare")]),_:1}),p(i(U),null,{title:r(()=>[m("Keep the local editor version")]),default:r(()=>[p(i(J),{onClick:a[1]||(a[1]=R=>u.value.keepLocalEditor())},{default:r(()=>[m("Discard")]),_:1})]),_:1})]),_:1})):b("",!0),u.value.conflictingChanges&&u.value.viewMode==="diff"?(h(),A(i(de),{key:1,gap:"small"},{default:r(()=>[p(i(U),null,{title:r(()=>[m("Keep your current changes")]),default:r(()=>[p(i(J),{onClick:a[2]||(a[2]=R=>u.value.keepAbstraIDECode())},{default:r(()=>[m("Keep left")]),_:1})]),_:1}),p(i(U),null,{title:r(()=>[m("Keep the local editor version")]),default:r(()=>[p(i(J),{onClick:a[3]||(a[3]=R=>u.value.keepLocalEditor())},{default:r(()=>[m("Keep right")]),_:1})]),_:1})]),_:1})):b("",!0)]),_:1})):b("",!0),d("div",Ct,[d("div",{id:"code",ref_key:"codeComponent",ref:g,class:$(["code-container",{hide:((oe=u.value)==null?void 0:oe.viewMode)==="diff",blur:C.value}])},null,2),C.value?(h(),A(i(Je),{key:0,class:"not-found-popup"},{title:r(()=>[m("File not found")]),_:1})):b("",!0)]),((ne=u.value)==null?void 0:ne.viewMode)==="diff"?(h(),w("div",{key:1,id:"code",ref_key:"codeDiffComponent",ref:I,class:$(["code-container",{hide:((ae=u.value)==null?void 0:ae.viewMode)!=="diff"}])},null,2)):b("",!0)],64)}}});const Lt=Q(wt,[["__scopeId","data-v-26ce8cc2"]]);export{Ee as L,Tt as R,Lt as S,Ht as a};
//# sourceMappingURL=SourceCode.6eee1de8.js.map
