class m{constructor(i,n,s,e){this.x=i,this.y=n,this.width=s,this.height=e}shrink(i){return new m(this.x+i,this.y+i,this.width-2*i,this.height-2*i)}static from(i){return new m(i.x,i.y,i.width,i.height)}}const b=200,a=32,M=40,W=12;function T(t,i,n){const s=(t-i)/6e4;return Math.floor(s*n)}function _(t,i){return t.minWidth?t.minWidth(i):0}const lt=(t,i={})=>{const n=(s,e)=>{s.fillStyle=i.color??"#000000",s.font=i.font??`${W}px sans-serif`,s.textBaseline=i.baseline??"hanging",s.textAlign=i.align??"left",s.save(),s.beginPath(),s.rect(e.x,e.y,e.width,e.height),s.clip();const o=i.align==="center"?e.x+e.width/2:e.x,l=i.baseline==="middle"?e.y+e.height/2:e.y;s.fillText(t,o,l),s.restore()};return n.minWidth=s=>(s.font=i.font??`${W}px sans-serif`,s.measureText(t).width),n},rt=(t,i=4)=>{const n=(s,e)=>{let o=e.x;for(let l=0;l<t.length;l++){const h=t[l],f=_(h,s),r=l===t.length-1?Math.max(f,e.width-(o-e.x)):f,c=new m(o,e.y,r,e.height);h(s,c),o+=r+i}};return n.minWidth=s=>t.reduce((e,o)=>e+_(o,s),0)+Math.max(0,t.length-1)*i,n},ht=(t,i)=>{const n=typeof i=="number"?{top:i,right:i,bottom:i,left:i}:i,s=n.top??0,e=n.right??0,o=n.bottom??0,l=n.left??0,h=(f,r)=>{t(f,new m(r.x+l,r.y+s,Math.max(0,r.width-l-e),Math.max(0,r.height-s-o)))};return h.minWidth=f=>_(t,f)+l+e,h},ft=(t,i=16,n)=>{let s;typeof i=="number"?s={size:i,color:n}:s=i;const e=s.size??16,o=s.color??"#000",l=s.filled??!0,h=s.strokeWidth??16,f=(r,c)=>{const d=c.x,g=c.y+(c.height-e)/2;r.save(),r.translate(d,g);const p=e/256;r.scale(p,p);const I=new Path2D(t);l?(r.fillStyle=o,r.fill(I)):(r.strokeStyle=o,r.lineWidth=h,r.lineCap="round",r.lineJoin="round",r.stroke(I)),r.restore()};return f.minWidth=()=>e,f},dt=(t,i,n,s)=>(e,o)=>{e.fillStyle="#999999",e.font="10px sans-serif",e.textAlign="left",e.textBaseline="top";for(const l of t){const h=T(l.getTime(),i,n);if(h<o.x-50||h>o.x+o.width+50)continue;let f="";s>=60?f=l.toLocaleString([],{month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}):f=l.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),e.fillText(f,h,4)}},ct=(t,i,n)=>(s,e)=>{s.strokeStyle="#e8e8e8",s.lineWidth=1,s.beginPath();for(const o of t){const l=T(o.getTime(),i,n);l<e.x-100||l>e.x+e.width+100||(s.moveTo(l,e.y),s.lineTo(l,e.y+e.height))}s.setLineDash([4,4]),s.stroke(),s.setLineDash([])},at=(t,i,n,s)=>(e,o)=>{e.strokeStyle="#ccc",e.lineWidth=1;const l=3;for(const h of t){if(s[h.sourceStageId]===void 0||s[h.targetStageId]===void 0)continue;const f=T(h.sourceTime,i,n),r=T(h.targetTime,i,n),c=o.y+s[h.sourceStageId]+M/2,d=o.y+s[h.targetStageId]+M/2,g=Math.min(f,r)-l;Math.max(f,r)+l<o.x||g>o.x+o.width||(e.beginPath(),e.moveTo(f,c),e.lineTo(r,d),e.stroke(),e.fillStyle="#ccc",e.beginPath(),e.arc(f,c,l,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(r,d,l,0,2*Math.PI),e.fill())}},ut=[1,50,10,100];function G(t){return t===3?"#ff4d4f":t===2?"#52c41a":t===1?"#1890ff":"#d9d9d9"}const gt=(t,i,n,s)=>(e,o)=>{if(!t||t.count===0)return;e.strokeStyle="#f0f0f0",e.setLineDash([4,4]),e.beginPath(),e.moveTo(o.x,o.y+o.height),e.lineTo(o.x+o.width,o.y+o.height),e.stroke(),e.setLineDash([]);let l=null;const h=r=>{if(r.end<o.x||r.start>o.x+o.width)return;const c=24,d=o.y+(o.height-c)/2;e.fillStyle=r.color,e.globalAlpha=.8,e.fillRect(r.start,d,Math.max(1,r.end-r.start),c),e.globalAlpha=1},f=t.count;for(let r=0;r<f;r++){const c=t.starts[r],d=t.ends[r],g=t.ids[r],p=T(c,i,n),I=T(d,i,n),H=Math.min(p,I),q=Math.max(1,Math.abs(I-p)),C=H+q;if(H>o.x+o.width)break;if(C<o.x)continue;if(g===s){const ot=o.y+(o.height-24)/2;e.save(),e.strokeStyle="#000",e.lineWidth=2,e.strokeRect(H,ot,q,24),e.restore()}const z=t.statuses[r],$=ut[z]??0;H<=(l?.end??-1/0)+1?(l.end=Math.max(l.end,C),$>l.priority&&(l.priority=$,l.color=G(z))):(l&&h(l),l={start:H,end:C,priority:$,color:G(z)})}l&&h(l)},mt=(t,i,n)=>(s,e)=>{const o=Math.min(t,i),l=Math.abs(i-t);s.save(),s.fillStyle="rgba(24, 144, 255, 0.2)",s.strokeStyle="rgba(24, 144, 255, 0.5)",s.lineWidth=1,s.fillRect(e.x+o,e.y,l,n),s.strokeRect(e.x+o+.5,e.y+.5,l,n),s.restore()},yt=t=>{if(!t.visible)return(e,o)=>{};const i=t.color??"#ff4d4f",n=t.label,s=(e,o)=>{if(e.save(),e.beginPath(),e.moveTo(o.x+t.x,o.y),e.lineTo(o.x+t.x,o.y+o.height),e.strokeStyle=i,e.lineWidth=1,e.stroke(),n){e.font="bold 11px sans-serif";const l=e.measureText(n).width,h=4,f=l+h*2,r=12+h*2;let c=o.x+t.x+6;c+f>o.x+o.width&&(c=o.x+t.x-6-f);const d=o.y+6;e.fillStyle="rgba(255, 255, 255, 0.9)",e.strokeStyle="#ffccc7",e.lineWidth=1,e.beginPath(),e.roundRect?e.roundRect(c,d,f,r,4):e.rect(c,d,f,r),e.fill(),e.stroke(),e.fillStyle=i,e.textAlign="left",e.textBaseline="top",e.fillText(n,c+h,d+h)}e.restore()};return s.minWidth=()=>1,s},wt=t=>(i,n)=>{if(!t.visible)return;i.save(),i.font=`${W}px sans-serif`;const s=W*1.4,e=8;let o=0;t.title&&(o=Math.max(o,i.measureText(t.title).width)),t.items&&t.items.forEach(c=>o=Math.max(o,i.measureText(c).width)),o+=e*2;let l=e*2;t.title&&(l+=s),t.items&&(l+=t.items.length*s),t.title&&t.items&&t.items.length>0&&(l+=4);let h=t.x+10,f=t.y+10;h+o>n.x+n.width&&(h=t.x-o-10),f+l>n.y+n.height&&(f=t.y-l-10),i.shadowColor="rgba(0, 0, 0, 0.2)",i.shadowBlur=10,i.fillStyle="rgba(255, 255, 255, 0.95)",i.strokeStyle="#e8e8e8",i.beginPath(),i.roundRect?i.roundRect(h,f,o,l,4):i.rect(h,f,o,l),i.fill(),i.stroke(),i.shadowColor="transparent";let r=f+e;t.title&&(i.fillStyle="#000000",i.font=`bold ${W}px sans-serif`,i.textAlign="left",i.textBaseline="top",i.fillText(t.title,h+e,r),r+=s+4),t.items&&(i.fillStyle="#666666",i.font=`${W}px sans-serif`,t.items.forEach(c=>{i.fillText(c,h+e,r),r+=s})),i.restore()},bt=t=>(i,n)=>{i.fillStyle="rgba(0, 0, 0, 0.05)",i.fillRect(t.trackRect.x,t.trackRect.y,t.trackRect.width,t.trackRect.height),i.fillStyle="rgba(0, 0, 0, 0.2)",i.beginPath(),i.roundRect?i.roundRect(t.thumbRect.x,t.thumbRect.y,t.thumbRect.width,t.thumbRect.height,4):i.rect(t.thumbRect.x,t.thumbRect.y,t.thumbRect.width,t.thumbRect.height),i.fill()},vt=(t,i,n)=>(s,e)=>{if(!t||t.length===0)return;const o=Date.now(),l=.15+.1*Math.sin(o/200);s.save(),s.fillStyle=`rgba(0, 150, 255, ${l})`,s.beginPath(),s.rect(e.x,e.y,e.width,e.height),s.clip();for(const h of t){const f=T(h.start,i,n),r=T(h.end,i,n),c=Math.min(f,r),d=Math.max(1,Math.abs(r-f));s.fillRect(e.x+c,e.y,d,e.height)}s.restore()},Mt={pending:0,running:1,finished:2,failed:3};class St{starts;ends;statuses;ids;count;maxDuration;constructor(i=1e3){this.starts=new Float64Array(i),this.ends=new Float64Array(i),this.statuses=new Uint8Array(i),this.ids=new Array(i),this.count=0,this.maxDuration=0}resize(i){const n=new Float64Array(i),s=new Float64Array(i),e=new Uint8Array(i);n.set(this.starts),s.set(this.ends),e.set(this.statuses),this.starts=n,this.ends=s,this.statuses=e,this.ids.length=i}add(i,n,s,e){this.count>=this.starts.length&&this.resize(this.starts.length*2);const o=this.count;this.starts[o]=n,this.ends[o]=s,this.statuses[o]=Mt[e]??0,this.ids[o]=i;const l=s-n;l>this.maxDuration&&(this.maxDuration=l),this.count++}clear(){this.count=0,this.maxDuration=0}findStartIndex(i){let n=0,s=this.count-1,e=this.count;for(;n<=s;){const o=n+s>>>1;this.ends[o]>=i?(e=o,s=o-1):n=o+1}return e}findEndIndex(i){let n=0,s=this.count-1,e=-1;for(;n<=s;){const o=n+s>>>1;this.starts[o]<=i?(e=o,n=o+1):s=o-1}return e}}const N=new Map;let P=[];const k=new Map,K=new Map,Q=new Map,F=new Map;let tt={},S=null,R=null,u=1,X=0,Y=0,A=0,E=0,D=0,V=null,et=null,y=0;const v={lines:[],moments:[],stages:[],timelineInterval:60};let B={active:!1,start:0,end:0},U={visible:!1,x:0,label:""},j={visible:!1,x:0,y:0,title:"",items:[]},it=[],O=null;function pt(){const t=[];for(const[i,n]of k)t.push({stageId:i,starts:n.starts.slice(0,n.count),ends:n.ends.slice(0,n.count),statuses:n.statuses.slice(0,n.count),ids:n.ids.slice(0,n.count),count:n.count,maxDuration:n.maxDuration});O=t}function At(t,i,n){n&&(P=[],k.clear(),F.clear()),i&&Object.entries(i).forEach(([s,e])=>{F.set(s,e)}),t.forEach(s=>N.set(s.id,s)),P=Array.from(N.values()).sort((s,e)=>s.createdAt-e.createdAt),k.clear(),P.forEach(s=>{k.has(s.stageId)||k.set(s.stageId,new St(100)),k.get(s.stageId).add(s.id,s.createdAt,s.updatedAt,s.status)}),t.forEach(s=>{s.triggerTaskId&&K.set(s.triggerTaskId,s),s.sentTasks&&s.sentTasks.forEach(e=>Q.set(e,s))}),pt()}function st(){let t=1440;y>60?t=1:y>20?t=10:y>5?t=60:y>1?t=360:y>.2?t=1440:t=1440*7,v.timelineInterval=t;const i=t*6e4,n=Math.floor(A/i)*i-i,s=Math.ceil(E/i)*i+i,e=[];for(let o=n;o<=s;o+=i)e.push(new Date(o));v.moments=e}function J(t){st();const i=[],n=new Set,s=(o,l,h)=>{const f=`${o.id}-${l.id}`;if(n.has(f))return;const r=F.get(h);let c=o.updatedAt,d=l.createdAt;r&&(c=r.start,r.end?d=r.end:d=l.createdAt),i.push({sourceTime:c,targetTime:d,sourceStageId:o.stageId,targetStageId:l.stageId}),n.add(f)};for(const o of P)if(o.sentTasks&&o.sentTasks.forEach(l=>{const h=K.get(l);h&&s(o,h,l)}),o.triggerTaskId){const l=Q.get(o.triggerTaskId);l&&s(l,o,o.triggerTaskId)}v.lines=i;const e={lines:i,taskLines:i};O&&(e.buffers=O),self.postMessage(e)}let w=null,x=null,L={start:0,end:0},Z=0;function Tt(t,i){const n=Math.ceil((t.end-t.start)/6e4*i),s=Math.max(100,v.stages.length*M);(!w||w.width<n||w.height<s)&&(w=new OffscreenCanvas(n*u,s*u),x=w.getContext("2d")),(w.width!==Math.ceil(n*u)||w.height!==Math.ceil(s*u))&&(w.width=n*u,w.height=s*u,x=w.getContext("2d"));const e=x;e.setTransform(u,0,0,u,0,0),e.clearRect(0,0,n,s);const o=m.from({x:0,y:0,width:n,height:s});ct(v.moments,t.start,i)(e,o),at(v.lines,t.start,i,tt)(e,o),v.stages.forEach((l,h)=>{const f=m.from({x:0,y:h*M,width:n,height:M}),r=k.get(l.id);gt(r,t.start,i,et)(e,f)})}function It(t){switch(t){case"forms":case"form":return"M 120 104 A 40 40 0 1 1 40 104 A 40 40 0 0 1 120 104 M 160 80 L 248 80 M 160 128 L 248 128 M 184 176 L 248 176 M 16 192 C 23.1 164.4 50.18 144 80 144 S 136.9 164.4 144 192";case"hooks":case"hook":return"M 208 168 A 16 16 0 1 1 176 168 A 16 16 0 0 1 208 168 M 144 64 A 16 16 0 1 1 112 64 A 16 16 0 0 1 144 64 M 80 168 A 16 16 0 1 1 48 168 A 16 16 0 0 1 80 168 M 32 144 A 40 40 0 1 0 104 168 H 192 M 164.66 48 A 40 40 0 1 0 107 98.07 L 64 168 M 192 208 A 40 40 0 1 0 171 133.93 L 128 64";case"jobs":case"job":return"M 216 136 A 88 88 0 1 1 40 136 A 88 88 0 0 1 216 136 M 128 136 L 168 96 M 104 16 L 152 16";case"scripts":case"script":return"M 200 176 V 64 A 24 24 0 0 0 176 40 H 40 M 104 104 L 168 104 M 104 136 L 168 136 M 24 80 S 16 74 16 64 A 24 24 0 0 1 64 64 V 192 A 24 24 0 0 0 112 192 C 112 182 104 176 104 176 H 216 S 224 182 224 192 A 24 24 0 0 1 200 216 H 88";case"components":case"component":return"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z";default:return"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v-6h-2v6zm0-8h2V7h-2v2z"}}function nt(){if(!R||!S)return;const t=R;if(X>0&&Y>0){const d=Math.floor(X*u),g=Math.floor(Y*u);(S.width!==d||S.height!==g)&&(S.width=d,S.height=g)}t.setTransform(u,0,0,u,0,0),t.clearRect(0,0,S.width/u,S.height/u);const i=S.width/u,n=S.height/u,s=i-b,e=(E-A)/6e4;y=s/e,(y<=0||!isFinite(y))&&(y=.01),st();const o=m.from({x:b,y:0,width:s,height:a});if(t.save(),t.beginPath(),t.rect(b,0,s,n),t.clip(),dt(v.moments,A,y,v.timelineInterval||60)(t,o),t.restore(),t.fillStyle="#fff",t.fillRect(0,a,b,n-a),t.fillStyle="#f0f0f0",t.fillRect(b-1,a,1,n-a),V){const d=v.stages.findIndex(g=>g.id===V);d!==-1&&(t.save(),t.beginPath(),t.rect(0,a,i,n-a),t.clip(),t.translate(0,a-D),R.fillStyle="rgba(0, 0, 0, 0.1)",R.fillRect(0,d*M,i,M),R.restore())}const l=(E-A)*1,h=A-l,f=E+l;if((Math.abs(Z-y)>.001||A<L.start||E>L.end||!w)&&(L={start:h,end:f},Z=y,Tt(L,y)),w){const d=T(L.start,A,y),g=a-D;t.save(),t.beginPath(),t.rect(b,a,s,n-a),t.clip(),t.drawImage(w,b+d,g,w.width/u,w.height/u),t.restore()}t.save(),t.beginPath(),t.rect(b,a,s,n-a),t.clip(),B.active&&mt(B.start,B.end,n-a)(t,m.from({x:b,y:a,width:s,height:n-a})),vt(it,A,y)(t,m.from({x:b,y:a,width:s,height:n-a})),U.visible&&yt(U)(t,m.from({x:b,y:a,width:s,height:n-a})),t.restore(),t.save(),t.beginPath(),t.rect(0,a,b,n-a),t.clip(),t.translate(0,a-D),v.stages.forEach((d,g)=>{const p=m.from({x:0,y:g*M,width:b,height:M});rt([ht(ft(It(d.type||d.typeName),{size:16,color:"#666",filled:!1}),{left:8,right:8}),lt(d.title,{baseline:"middle",color:"#000000"})],0)(t,p),t.fillStyle="#f0f0f0",t.fillRect(0,(g+1)*M-1,b,1)}),t.restore();const r=n-a,c=Math.max(r,v.stages.length*M);if(c>r){const d=Math.max(30,r/c*r),g=c-r,p=Math.min(1,Math.max(0,D/g)),I=a+p*(r-d);bt({trackRect:m.from({x:i-10,y:a,width:10,height:r}),thumbRect:m.from({x:i-7,y:I,width:4,height:d})})(t,m.from({x:0,y:0,width:0,height:0}))}j.visible&&wt(j)(t,m.from({x:0,y:0,width:i,height:n})),requestAnimationFrame(nt)}self.onmessage=t=>{const{type:i,payload:n}=t.data;if(i==="initCanvas")S=n.canvas,u=n.pixelRatio,R=S.getContext("2d"),requestAnimationFrame(nt);else if(i==="data")At(n.executions,n.tasks,n.reset),J();else if(i==="stagesList"){v.stages=n;const s={};n.forEach((e,o)=>s[e.id]=o*M),tt=s,J()}else i==="view"&&(n.viewStart!==void 0&&(A=n.viewStart),n.viewEnd!==void 0&&(E=n.viewEnd),n.viewportWidth!==void 0&&(X=n.viewportWidth),n.viewportHeight!==void 0&&(Y=n.viewportHeight),n.scrollTop!==void 0&&(D=n.scrollTop),n.selection!==void 0&&(B=n.selection),n.cursor!==void 0&&(U=n.cursor),n.tooltip!==void 0&&(j=n.tooltip),n.hoveredStageId!==void 0&&(V=n.hoveredStageId),n.rootId!==void 0&&(et=n.rootId),n.pendingChunks!==void 0&&(it=n.pendingChunks))};
//# sourceMappingURL=timeline.worker-CTtnDIl5.js.map
