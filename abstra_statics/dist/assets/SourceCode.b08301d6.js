var be=Object.defineProperty;var Ee=(o,e,s)=>e in o?be(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var M=(o,e,s)=>(Ee(o,typeof e!="symbol"?e+"":e,s),s);import{u as te}from"./uuid.5d0c4d2c.js";import{E as he,d as K,r as m,F as X,b as h,et as k,e as d,ex as H,eC as fe,eD as ve,t as ee,ez as Me,G as se,a1 as ge,o as _e,J as me,a as ye,f as p,u as i,I as N,ao as y,eB as z,ev as S,eu as Se,bo as oe,eA as Ie,c as B,eN as xe,eT as De,eG as Fe,w as l,bF as Ce,D as q,bp as Y,bM as j}from"./outputWidgets.c7dcc302.js";import{k as ie,l as re,n as le,o as Re,q as Ae,u as Oe}from"./icons.b61c445b.js";import{S as ce}from"./storage.ee8fed7f.js";import{l as We}from"./NavbarControls.57b57946.js";import{H as Be,J as $e}from"./jobs.3225b1f7.js";import{S as Te}from"./scripts.2312dfa1.js";import{n as He,v as Le,a as Pe}from"./validations.94bb62eb.js";import{A as we}from"./FormItem.e17f5a0a.js";import{W as Ne}from"./workspaces.2639d2d4.js";import{a as ue}from"./asyncComputed.2f92c176.js";import{l as ze,e as Q,R as Ke}from"./toggleHighContrast.205e10fc.js";import{A as de}from"./index.91f601e6.js";import{A as Ve}from"./index.d6544e82.js";import{C as Ue}from"./Card.318fde53.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[e]="81614796-d9df-42c1-825d-9f66379e6624",o._sentryDebugIdIdentifier="sentry-dbid-81614796-d9df-42c1-825d-9f66379e6624")}catch{}})();class ke{constructor(){M(this,"logState",he({log:[]}));M(this,"_listeners",{})}static create(){return new ke}get logs(){return this.logState.log}log(e,s){if(e.type!=="restart"&&e.log.trim()==="")return;const t=s?this.logs.find(r=>r.id===s):null;return t?Object.assign(t,e):this.logs.push({...e,id:s||te()}),this.notifyListeners(e),s}clear(){this.logState.log=[]}listen(e){const s=te();return this._listeners[s]=e,s}unlisten(e){delete this._listeners[e]}notifyListeners(e){Object.values(this._listeners).forEach(s=>s(e))}}class Ge{static async*sendMessage(e,s){var f;const r=(f=(await fetch("/_editor/api/ai/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e,runtime:s})})).body)==null?void 0:f.getReader();if(!r)throw new Error("No response body");for(;;){const _=await r.read();if(_.done)break;yield new TextDecoder().decode(_.value)}}}const Je=o=>(fe("data-v-59ca7295"),o=o(),ve(),o),Ye=Je(()=>d("div",{class:"text"}," Changes were made in your code. Click Restart to refresh the preview window. ",-1)),pe="ignoreCodeChangesWarning",je=K({__name:"ChangesWarning",props:{hasChanges:{type:Boolean}},setup(o){var f;const e=o,s=m((f=ce.get(pe))!=null?f:!1),t=X(()=>e.hasChanges&&!s.value),r=()=>{ce.set(pe,!0),s.value=!0};return(_,F)=>(h(),k("div",{class:H(["changes-warning",{visible:t.value}])},[Ye,d("div",{class:"no-more-alert",onClick:r},"Do not show again")],2))}});const qe=ee(je,[["__scopeId","data-v-59ca7295"]]),Qe=o=>(fe("data-v-9d2d7cb6"),o=o(),ve(),o),Xe={class:"smart-console"},Ze={class:"header"},et={class:"left"},tt={class:"right"},st={class:"changes-container"},ot=["unseen-severity"],nt={class:"cli"},at={class:"left"},it=Qe(()=>d("div",{class:"entry ai-output"}," Hello there! I'm both an output console and AI assistant. You can ask me anything. ",-1)),rt={key:1,class:"local-entry"},lt={class:"input"},ct=["pointer-events","onKeydown"],ut={class:"right"},dt=K({__name:"SmartConsole",props:{inputEnabled:{type:Boolean},formCode:{},runtime:{},logService:{}},emits:["eval-request","clear-terminal","restart","enter"],setup(o,{emit:e}){const s=o,t=m(""),r=m(null),f=Me(),_=m({type:"seen"}),F=m(!1),R=m(!1),O=()=>{b.value=b.value==="assistant"?"debugger":"assistant"};function A(u){switch(u.type){case"ai-input":return{role:"user",content:u.log};case"ai-output":return{role:"assistant",content:u.log};case"stderr":case"stdout":return{role:"user",content:u.log};case"restart":return{role:"user",content:"-- new session --"};case"files-changed":return{role:"user",content:"-- files changed --"};default:throw new Error(`Unknown log type: ${u.type}`)}}const C=X(()=>s.logService.logs.some(u=>u.type==="files-changed"));function I(){w.value=!w.value,w.value&&(_.value={type:"seen"})}se(f,()=>{s.logService.clear(),e("clear-terminal")});const v=m(null),b=m("assistant"),L=async u=>{var n;if(u.preventDefault(),t.value=((n=v.value)==null?void 0:n.innerText)||"",u.shiftKey){document.execCommand("insertLineBreak");return}v.value&&(v.value.innerText=""),b.value==="assistant"?await $():await E()},$=async()=>{var n;if(e("enter",t.value),s.logService.log({type:"ai-input",log:t.value}),t.value="",!R.value){s.logService.log({type:"stderr",log:"Please login to use the AI assistant."});return}F.value=!0;const u={role:"user",content:(n=s.formCode)!=null?n:""};try{const a=te();let g="";const x=Ge.sendMessage([u,...s.logService.logs.map(D=>A(D)),{role:"user",content:t.value}],s.runtime);for await(const D of x)g+=D,s.logService.log({type:"ai-output",log:g},a)}catch(a){s.logService.log({type:"ai-output",log:"Sorry, I don't know how to answer that."}),console.error(a),De(a)}finally{F.value=!1}},E=async()=>{t.value&&(s.logService.log({type:"eval-input",log:`>>> ${t.value}`}),e("eval-request",t.value),t.value="")},P=()=>{s.logService.clear()};s.logService.listen(async u=>{w.value||(_.value={type:"unseen",count:_.value.type==="unseen"?_.value.count+1:1,severity:u.type==="stderr"?"error":"info"}),u.type!=="restart"&&(await ge(),r.value&&(r.value.scrollTop=r.value.scrollHeight))});const w=m(!1),V=m(400),c=X(()=>({height:`${V.value}px`})),T=m(!1),U=()=>T.value=!0,G=u=>{!T.value||(V.value=document.body.clientHeight-u.clientY)},J=()=>T.value=!1;return _e(()=>{document.addEventListener("mousemove",G),document.addEventListener("mouseup",J),We.get().then(u=>{R.value=!!u.logged})}),me(()=>{document.removeEventListener("mousemove",G),document.removeEventListener("mouseup",J)}),(u,n)=>{const a=ye("Markdown");return h(),k("div",Xe,[d("div",Ze,[d("div",et,[p(N,{path:b.value==="assistant"?i(ie):i(re)},null,8,["path"]),y(" Smart Console ")]),d("div",tt,[d("div",st,[p(qe,{"has-changes":C.value},null,8,["has-changes"])]),d("div",{class:"toggle-button",onClick:I},[p(N,{class:H(["icon",{open:w.value}]),path:i(le),fill:"#fff"},null,8,["class","path"]),_.value.type==="unseen"?(h(),k("div",{key:0,class:"unseen-count","unseen-severity":_.value.severity},z(_.value.count),9,ot)):S("",!0)])])]),w.value?(h(),k("div",{key:0,class:"terminal",style:Se(c.value)},[d("div",{class:"resize-handler",onMousedown:U},null,32),d("div",nt,[d("div",at,[d("div",{ref_key:"entriesContainer",ref:r,class:"entries"},[it,(h(!0),k(oe,null,Ie(s.logService.logs,(g,x)=>(h(),k("div",{key:x,class:H([g.type,"entry"])},[g.type==="ai-output"?(h(),B(a,{key:0,source:g.log},null,8,["source"])):(h(),k("div",rt,z(g.type==="restart"?"-- restarted --":g.log),1))],2))),128))],512),d("div",lt,[p(N,{class:H(["icon",{open:w.value}]),path:i(le)},null,8,["class","path"]),d("div",{ref_key:"inputRef",ref:v,class:"input-text",contenteditable:"","pointer-events":F.value?"none":"auto",placeholder:"Ask AI anything",onKeydown:xe(L,["enter"])},null,40,ct)])]),d("div",ut,[d("div",{class:"icons",onClick:P},[p(N,{class:"icon",path:i(Re)},null,8,["path"])]),d("div",null,[p(N,{class:"icon clickable",path:b.value==="assistant"?i(ie):i(re),onClick:n[0]||(n[0]=g=>O())},null,8,["path"])])])])],4)):S("",!0)])}}});const Tt=ee(dt,[["__scopeId","data-v-9d2d7cb6"]]),pt=K({__name:"PathInput",props:{runtime:{}},setup(o){const e=o,s=()=>{const t=He(e.runtime.path);t&&t!==e.runtime.path&&(e.runtime.path=t)};return(t,r)=>(h(),B(i(Ce),{value:t.runtime.path,"onUpdate:value":r[0]||(r[0]=f=>t.runtime.path=f),type:"text",onBlur:s},Fe({_:2},[t.runtime instanceof i(Be)?{name:"addonBefore",fn:l(()=>[y(" https://[your-subdomain].abstra.app/_hooks/ ")]),key:"0"}:{name:"addonBefore",fn:l(()=>[y(" https://[your-subdomain].abstra.app/ ")]),key:"1"}]),1032,["value"]))}}),ht={key:1},ft=K({__name:"RuntimeCommonSettings",props:{runtime:{}},setup(o){const e=he({pathError:null});return(s,t)=>(h(),k(oe,null,[s.runtime instanceof i($e)||s.runtime instanceof i(Te)?S("",!0):(h(),B(i(we),{key:0,label:"URL path"},{default:l(()=>[p(pt,{runtime:s.runtime},null,8,["runtime"])]),_:1})),e.pathError?(h(),k("div",ht,z(e.pathError),1)):S("",!0)],64))}});const Ht=ee(ft,[["__scopeId","data-v-60a397e0"]]);let Z={};function vt(o){return o in Z?"\n\n```python\n"+o+" = "+Z[o]+"\n```":""}ze.registerHoverProvider("python",{provideHover:function(o,e){const s=o.getWordAtPosition(e);if(!!s)return{contents:[{value:vt(s.word)}]}}});const gt=(o,e,s={})=>{var A;const t=Q.create(o,{language:"python",value:e,minimap:{enabled:!1},readOnly:(A=s.readOnly)!=null?A:!1,contextmenu:!s.readOnly,automaticLayout:!s.readOnly,tabSize:4,fixedOverflowWidgets:!0,theme:s.theme?s.theme:"vs",fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:s.readOnly?0:5,scrollBeyondLastLine:!s.readOnly,renderLineHighlight:s.readOnly?"none":"all",scrollbar:{useShadows:!1,alwaysConsumeMouseWheel:!1}}),r=t.getContribution("editor.contrib.messageController");t.onDidAttemptReadOnlyEdit(()=>{r.showMessage("Cannot edit during preview execution",t.getPosition())});const f=t.createDecorationsCollection([]),_=(C,I)=>{f.set(C.map(v=>({range:new Ke(v.lineno,1,v.lineno,1),options:{isWholeLine:!0,className:I}}))),Z=C.reduce((v,b)=>({...v,...b.locals}),{})};return{editor:t,highlight:(C,I)=>v=>{var $,E;const L=((E=($=v.debug)==null?void 0:$.stack)!=null?E:[]).filter(P=>P.filename.endsWith(I));_(L,C)},clearHighlights:()=>{f.clear(),Z={}},setReadOnly:C=>{t.updateOptions({readOnly:C})}}},_t=(o,e,s)=>{const t=Q.createModel(e),r=Q.createModel(s),f=Q.createDiffEditor(o,{minimap:{enabled:!1},readOnly:!0,contextmenu:!1,automaticLayout:!0,renderWhitespace:"none",guides:{indentation:!1},fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:0,scrollBeyondLastLine:!1,renderLineHighlight:"none"});return f.setModel({original:t,modified:r}),{diffEditor:f}};class mt{constructor(e,s){M(this,"_script");M(this,"_localEditorCode");M(this,"_monacoEditor");M(this,"_diffEditor");M(this,"_viewMode");M(this,"_alertMessage");M(this,"_conflictingChanges");this._localEditorCode=e,this._script=s,this._monacoEditor=null,this._diffEditor=null,this._viewMode=q("editor"),this._alertMessage=q(""),this._conflictingChanges=q(!1)}get alertMessage(){return this._alertMessage.value}set alertMessage(e){this._alertMessage.value=e}get conflictingChanges(){return this._conflictingChanges.value}set conflictingChanges(e){this._conflictingChanges.value=e}get viewMode(){return this._viewMode.value}set viewMode(e){this._viewMode.value=e}get abstraIDECode(){return this._script.codeContent}get localEditorCode(){return this._localEditorCode}set monacoEditor(e){this._monacoEditor=e}set diffEditor(e){this._diffEditor=e}finishPreview(){var e;this._viewMode.value="editor",this._script.codeContent=this._localEditorCode,(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.alertMessage=""}updateCodeWhileEditing(e){var r;const s=e!==this._localEditorCode;if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1;return}const t=!this._script.hasChanges("code_content");if(t){(r=this._monacoEditor)==null||r.setValue(e),this._script.codeContent=e,this._script.updateInitialState("code_content",e);return}if(!t&&s){this.alertMessage="You have conflicting changes with your local editor code",this.conflictingChanges=!0;return}}updateCodeWhileDiff(e){var s,t;if(e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1,this.viewMode="editor",this._localEditorCode=e;return}if(e!==this._localEditorCode){(t=(s=this._diffEditor)==null?void 0:s.getModel())==null||t.modified.setValue(e),this._localEditorCode=e;return}}updateCodeWhilePreview(e){if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="";return}this.alertMessage="The changes on your code will be shown after the preview stops running"}updateCode(e){switch(this._viewMode.value){case"editor":return this.updateCodeWhileEditing(e);case"diff":return this.updateCodeWhileDiff(e);case"preview":return this.updateCodeWhilePreview(e)}}keepAbstraIDECode(){var e;(e=this._monacoEditor)==null||e.setValue(this._script.codeContent),this._script.save("code_content"),this._script.updateInitialState("code_content",this._script.codeContent),this._localEditorCode=this._script.codeContent,this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}keepLocalEditor(){var e;(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}}const yt={class:"container"},Ct=K({__name:"SourceCode",props:{script:{},workspace:{},broker:{}},emits:["update-file"],setup(o,{expose:e,emit:s}){const t=o,r=()=>{!t.script.file||t.workspace.openFile(t.script.file)},f=()=>{c.value.viewMode="diff",J()},_=m(null),F=m(null);let R,O,A,C;const{result:I}=ue(()=>fetch("/_editor/api/workspace/root").then(n=>n.text())),v=m(t.script.file);se(()=>t.script.file,()=>v.value=t.script.file);const{result:b,refetch:L}=ue(()=>Ne.checkFile(v.value)),$=()=>{E.value.valid?s("update-file",Pe(v.value)):s("update-file",v.value),L()},E=X(()=>{var a;const n=Le(v.value);return n.valid?((a=b.value)==null?void 0:a.exists)&&t.script.hasChanges("file")?{valid:!0,help:"This file already exists"}:t.script.hasChanges("file")?{valid:!0,help:"The original file will be renamed"}:n:n}),P=()=>{!t.workspace||!I.value||t.workspace.openFile(".")},w=m(!1),V=async()=>{var a;if(!t.script.file)return;const n=await t.workspace.readFile(t.script.file);if(n===null){w.value=!0;return}w.value=!1,(a=c.value)==null||a.updateCode(n)},c=q(null);let T;_e(()=>{G(),T=setInterval(V,1e3)}),me(()=>{clearInterval(T)}),se(()=>t.broker,()=>{O(),U()});const U=()=>{var n,a,g;(n=t.broker)==null||n.on("start",()=>{C(!0),c.value.viewMode="preview"}),(a=t.broker)==null||a.on("form",A("executing-line",t.script.file)),(g=t.broker)==null||g.on("program:end",x=>{var D;(D=c.value)==null||D.finishPreview(),C(!1),x.exception?A("error-line",t.script.file)(x):O()})},G=async()=>{await ge(),t.workspace.readFile(t.script.file).then(n=>{if(n===null)return;t.script.codeContent=n,t.script.updateInitialState("code_content",n),c.value=new mt(n,t.script);const a=gt(_.value,n);O=a.clearHighlights,A=a.highlight,C=a.setReadOnly,U(),R=a.editor,c.value.monacoEditor=R,R.onDidChangeModelContent(()=>{t.script.codeContent=R.getValue()})})},J=async()=>{const n=await t.workspace.readFile(t.script.file);if(!n)return;const a=t.script.codeContent,g=_t(F.value,a,n);c.value.diffEditor=g.diffEditor};return e({restartEditor:()=>{var n;O(),C(!1),(n=c.value)==null||n.finishPreview()}}),(n,a)=>{var x,D,ne,ae;const g=ye("icon");return h(),k(oe,null,[p(i(we),{"validate-status":E.value.valid?"success":"error",help:E.value.valid?E.value.help:E.value.reason},{default:l(()=>[p(i(Ce),{value:n.script.file,"onUpdate:value":a[0]||(a[0]=W=>n.script.file=W),onBlur:$},{addonBefore:l(()=>[i(I)?(h(),k("span",{key:0,class:"clickable",onClick:P},[p(i(Y),{placement:"bottomLeft","overlay-style":{maxWidth:"none"}},{title:l(()=>[y(z(i(I)),1)]),default:l(()=>[p(g,{path:i(Ae)},null,8,["path"])]),_:1})])):S("",!0)]),addonAfter:l(()=>[d("span",{class:"clickable",onClick:r},[y(" Open in editor "),p(g,{path:i(Oe),width:"22"},null,8,["path"])])]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),(x=c.value)!=null&&x.alertMessage?(h(),B(i(Ve),{key:0,type:"warning","show-icon":""},{message:l(()=>{var W;return[y(z((W=c.value)==null?void 0:W.alertMessage),1)]}),action:l(()=>[c.value.conflictingChanges&&c.value.viewMode!=="diff"?(h(),B(i(de),{key:0,gap:"small"},{default:l(()=>[p(i(j),{type:"primary",onClick:f},{default:l(()=>[y("Compare")]),_:1}),p(i(Y),null,{title:l(()=>[y("Keep the local editor version")]),default:l(()=>[p(i(j),{onClick:a[1]||(a[1]=W=>c.value.keepLocalEditor())},{default:l(()=>[y("Discard")]),_:1})]),_:1})]),_:1})):S("",!0),c.value.conflictingChanges&&c.value.viewMode==="diff"?(h(),B(i(de),{key:1,gap:"small"},{default:l(()=>[p(i(Y),null,{title:l(()=>[y("Keep your current changes")]),default:l(()=>[p(i(j),{onClick:a[2]||(a[2]=W=>c.value.keepAbstraIDECode())},{default:l(()=>[y("Keep left")]),_:1})]),_:1}),p(i(Y),null,{title:l(()=>[y("Keep the local editor version")]),default:l(()=>[p(i(j),{onClick:a[3]||(a[3]=W=>c.value.keepLocalEditor())},{default:l(()=>[y("Keep right")]),_:1})]),_:1})]),_:1})):S("",!0)]),_:1})):S("",!0),d("div",yt,[d("div",{id:"code",ref_key:"codeComponent",ref:_,class:H(["code-container",{hide:((D=c.value)==null?void 0:D.viewMode)==="diff",blur:w.value}])},null,2),w.value?(h(),B(i(Ue),{key:0,class:"not-found-popup"},{title:l(()=>[y("File not found")]),_:1})):S("",!0)]),((ne=c.value)==null?void 0:ne.viewMode)==="diff"?(h(),k("div",{key:1,id:"code",ref_key:"codeDiffComponent",ref:F,class:H(["code-container",{hide:((ae=c.value)==null?void 0:ae.viewMode)!=="diff"}])},null,2)):S("",!0)],64)}}});const Lt=ee(Ct,[["__scopeId","data-v-bc11ab08"]]);export{ke as L,Ht as R,Lt as S,Tt as a};
//# sourceMappingURL=SourceCode.b08301d6.js.map
