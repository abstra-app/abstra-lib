var Se=Object.defineProperty;var fe=(i,t,e)=>t in i?Se(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var S=(i,t,e)=>(fe(i,typeof t!="symbol"?t+"":t,e),e);import{_ as ye}from"./SaveButton.vue_vue_type_script_setup_true_lang.b9066a0b.js";import{W as Tt}from"./envVars.0cabe2da.js";import{L as ve}from"./LoadingContainer.398c6723.js";import{d as W,a0 as rt,D as f,b as c,ey as y,dq as we,eA as T,eD as Ie,e as _,c as v,w as h,ez as ht,u as r,aG as B,bi as j,f as g,au as w,bk as Te,E as J,eR as _e,eM as Ee,r as K,B as F,o as qt,R as Ne,O as xe,eI as Z,bB as q,eJ as D,aK as Pe,cG as pt,bI as Ce,eC as Xt,eH as tt,cF as ke,ah as Ae,y as et,eE as De,eF as be,cA as X,cC as Ge}from"./outputWidgets.bf420cfc.js";import{A as E}from"./Text.2b6f61f8.js";import{v as te,a as ee,n as _t,b as Me,c as Re,d as Oe,e as $e}from"./validations.6855f849.js";import{F as Qt}from"./PhArrowSquareOut.vue.0632a7ab.js";import{s as St,w as H}from"./metadata.e043b417.js";import"./index.f939000c.js";import{A as Y}from"./index.e4f3e62e.js";import{A as Yt}from"./index.9f125050.js";import{A as Zt,F as Ve}from"./Form.047bc96f.js";import{C as ft}from"./Card.c57028e1.js";import{B as Ke}from"./Badge.eb471ada.js";import{M as He}from"./Modal.0e2b0a23.js";import{W as Fe}from"./api.8cb538b5.js";import{u as ze}from"./uuid.570b1df9.js";import{a as Le}from"./asyncComputed.609c9010.js";import{U as Ue}from"./UnsavedChangesHandler.9ac5808d.js";import{A as Be}from"./index.2974f044.js";import"./runnerData.b3d1b2d2.js";import"./url.484d3a29.js";import"./record.80621348.js";import"./pubsub.a5d3a405.js";import"./Base.71da3116.js";import"./string.0a8edefa.js";import"./PhCheckCircle.vue.9b95d522.js";import"./PhKanban.vue.40631932.js";import"./PhScroll.vue.064356c2.js";import"./PhWebhooksLogo.vue.fadd0d69.js";import"./hasIn.465ef8c2.js";import"./TabPane.22052690.js";import"./isNumeric.75337b1e.js";import"./ExclamationCircleOutlined.32a6af48.js";(function(){try{var i=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(i._sentryDebugIds=i._sentryDebugIds||{},i._sentryDebugIds[t]="4c8f40ba-89b5-4ef4-bd78-7b2fe8e06f01",i._sentryDebugIdIdentifier="sentry-dbid-4c8f40ba-89b5-4ef4-bd78-7b2fe8e06f01")}catch{}})();const We=["width","height","fill","transform"],Qe={key:0},Ye=_("path",{d:"M208.49,152.49l-72,72a12,12,0,0,1-17,0l-72-72a12,12,0,0,1,17-17L116,187V40a12,12,0,0,1,24,0V187l51.51-51.52a12,12,0,0,1,17,17Z"},null,-1),Ze=[Ye],Je={key:1},je=_("path",{d:"M200,144l-72,72L56,144Z",opacity:"0.2"},null,-1),qe=_("path",{d:"M207.39,140.94A8,8,0,0,0,200,136H136V40a8,8,0,0,0-16,0v96H56a8,8,0,0,0-5.66,13.66l72,72a8,8,0,0,0,11.32,0l72-72A8,8,0,0,0,207.39,140.94ZM128,204.69,75.31,152H180.69Z"},null,-1),Xe=[je,qe],ts={key:2},es=_("path",{d:"M205.66,149.66l-72,72a8,8,0,0,1-11.32,0l-72-72A8,8,0,0,1,56,136h64V40a8,8,0,0,1,16,0v96h64a8,8,0,0,1,5.66,13.66Z"},null,-1),ss=[es],is={key:3},as=_("path",{d:"M204.24,148.24l-72,72a6,6,0,0,1-8.48,0l-72-72a6,6,0,0,1,8.48-8.48L122,201.51V40a6,6,0,0,1,12,0V201.51l61.76-61.75a6,6,0,0,1,8.48,8.48Z"},null,-1),ns=[as],os={key:4},rs=_("path",{d:"M205.66,149.66l-72,72a8,8,0,0,1-11.32,0l-72-72a8,8,0,0,1,11.32-11.32L120,196.69V40a8,8,0,0,1,16,0V196.69l58.34-58.35a8,8,0,0,1,11.32,11.32Z"},null,-1),ls=[rs],ds={key:5},us=_("path",{d:"M202.83,146.83l-72,72a4,4,0,0,1-5.66,0l-72-72a4,4,0,0,1,5.66-5.66L124,206.34V40a4,4,0,0,1,8,0V206.34l65.17-65.17a4,4,0,0,1,5.66,5.66Z"},null,-1),cs=[us],hs={name:"PhArrowDown"},Jt=W({...hs,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(i){const t=i,e=rt("weight","regular"),s=rt("size","1em"),a=rt("color","currentColor"),o=rt("mirrored",!1),n=f(()=>{var m;return(m=t.weight)!=null?m:e}),d=f(()=>{var m;return(m=t.size)!=null?m:s}),l=f(()=>{var m;return(m=t.color)!=null?m:a}),u=f(()=>t.mirrored!==void 0?t.mirrored?"scale(-1, 1)":void 0:o?"scale(-1, 1)":void 0);return(m,P)=>(c(),y("svg",Ie({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:d.value,height:d.value,fill:l.value,transform:u.value},m.$attrs),[we(m.$slots,"default"),n.value==="bold"?(c(),y("g",Qe,Ze)):n.value==="duotone"?(c(),y("g",Je,Xe)):n.value==="fill"?(c(),y("g",ts,ss)):n.value==="light"?(c(),y("g",is,ns)):n.value==="regular"?(c(),y("g",os,ls)):n.value==="thin"?(c(),y("g",ds,cs)):T("",!0)],16,We))}});function se(i,t,e,s={}){i.strokeStyle=s.color||"black",i.lineWidth=e/3,i.lineJoin="round",i.lineCap="round";const a=Math.atan2(t.p2.y-t.p1.y,t.p2.x-t.p1.x);i.beginPath(),i.moveTo(t.p1.x,t.p1.y),i.lineTo(t.p2.x,t.p2.y),i.moveTo(t.p2.x-e*Math.cos(a-Math.PI/6),t.p2.y-e*Math.sin(a-Math.PI/6)),i.lineTo(t.p2.x,t.p2.y),i.lineTo(t.p2.x-e*Math.cos(a+Math.PI/6),t.p2.y-e*Math.sin(a+Math.PI/6)),i.stroke()}function ps(i){return fs(i.p1,i.p2)}function $(i,t){return{dx:t.x-i.x,dy:t.y-i.y,referential:i.referential}}function st(i,t){return{referential:i.referential,x:i.x+t.dx,y:i.y+t.dy}}function gs(i,t){return{referential:i.referential,dx:i.dx*t,dy:i.dy*t}}function it(i,t,e){const{x:s,y:a,width:o,height:n}=e,{dx:d,dy:l}=t,{x:u,y:m}=i,P=(s-u)/d,C=(s+o-u)/d,G=(a-m)/l,M=(a+n-m)/l,O=Math.max(Math.min(P,C),Math.min(G,M));return{x:u+O*d,y:m+O*l,referential:i.referential}}function ms(i,t){const e=Et(i),s=Et(t),a=it(s,$(s,e),i),o=it(e,$(e,s),t);return{p1:a,p2:o}}function Ss(i,t,e=!1){return e?t.x<=i.x&&t.x+t.width>=i.x&&t.y<=i.y&&t.y+t.height>=i.y:t.x<i.x&&t.x+t.width>i.x&&t.y<i.y&&t.y+t.height>i.y}function Et(i){return{x:i.x+i.width/2,y:i.y+i.height/2,referential:i.referential}}const ut=i=>i.reduce((t,e)=>{const s=t?Math.min(t.x,e.x):e.x,a=t?Math.min(t.y,e.y):e.y,o=t?Math.max(t.x+t.width,e.x+e.width):e.x+e.width,n=t?Math.max(t.y+t.height,e.y+e.height):e.y+e.height;return{x:s,y:a,width:o-s,height:n-a,referential:e.referential}},null);function fs(i,t){return Math.sqrt((i.x-t.x)**2+(i.y-t.y)**2)}function ie(i,t){const{p1:e,p2:s}=i,a=Math.atan2(s.y-e.y,s.x-e.x),o=t*Math.sin(a),d={dx:t*Math.cos(a),dy:o,referential:e.referential},l=st(e,d),u=st(s,gs(d,-1));return{p1:l,p2:u}}function jt(i,t){return{referential:i.referential,x:i.x-t,y:i.y-t,width:i.width+2*t,height:i.height+2*t}}const ae="#ababab",xt="#e55b70",ct=15,Pt=10;function gt(i,t){const e=i.getStageRect(t.id);return e?{x:e.x+e.width/2,y:e.y+e.height/2,referential:"screen"}:i.camera.worldPoint2screen({...t.position,referential:"world"})}function at(i,t){const e=i.getStageRect(t.id);if(e)return e;{const s=gt(i,t);return{x:s.x-100/2,y:s.y-100/2,width:100,height:100,referential:"screen"}}}function ne(i,t){const e=i.model.getStage(t.sourceStageId),s=i.model.getStage(t.targetStageId);if(!e)throw new Error(`Source node ${t.sourceStageId} not found`);if(!s)throw new Error(`Target node ${t.targetStageId} not found`);const a=gt(i,e),o=gt(i,s),n=it(a,$(a,o),at(i,s));return{p1:it(n,$(n,a),at(i,e)),p2:n}}function ys(i,t){const e=i.model.getTransition(t);if(!e)throw new Error(`Transition ${t} not found`);const s=ne(i,e);return{x:Math.min(s.p1.x,s.p2.x),y:Math.min(s.p1.y,s.p2.y),width:Math.abs(s.p1.x-s.p2.x),height:Math.abs(s.p1.y-s.p2.y),referential:"screen"}}function vs(i,t){const e=i.selection.has(t),s=Pt*i.camera.zoom,a=i.model.getStage(t.sourceStageId),o=i.model.getStage(t.targetStageId);if(!a)throw new Error(`Source node ${t.sourceStageId} not found`);if(!o)throw new Error(`Target node ${t.targetStageId} not found`);const n=jt(at(i,a),ct*i.camera.zoom),d=jt(at(i,o),ct*i.camera.zoom),l=ms(n,d);ps(l)<ct*i.camera.zoom||se(i.ctx,l,s,{color:e?xt:ae})}function ws(i){if(i.mouseState.state!=="ADDING_TRANSITION")throw new Error("Invalid state");for(const t of i.selection.selectedStages())if(i.mouseState.snappedTarget)oe(i,{id:"",sourceStageId:t.id,targetStageId:i.mouseState.snappedTarget.id,props:{conditionValue:null}});else{const e=gt(i,t),s=it(i.mouseState.mousePos,$(i.mouseState.mousePos,e),at(i,t)),a=i.mouseState.mousePos,n=ie({p1:s,p2:a},ct*i.camera.zoom);se(i.ctx,n,Pt*i.camera.zoom,{color:ae})}}function oe(i,t){const e=i.model.getStage(t.sourceStageId),s=i.model.getStage(t.targetStageId);if(!e)throw new Error(`Source node ${t.sourceStageId} not found`);if(!s)throw new Error(`Target node ${t.targetStageId} not found`);vs(i,t);const a=i.getTransitionRect(t.id);a&&i.ctx.clearRect(a.x,a.y,a.width,a.height)}function re(i,t){const e=ne(i,t),s=ie(e,Pt*i.camera.zoom*Math.sin(Math.PI/6));return{x:(e.p1.x+s.p2.x)/2,y:(e.p1.y+s.p2.y)/2,referential:"screen"}}function Is(i,t){var a;const e=i.model.getStage(t.sourceStageId);if(!e)throw new Error(`Source node ${t.sourceStageId} not found`);const s=e.type;if(!s.includes("conditions")&&!s.includes("iterators"))throw new Error("Source node is not a flow controller");return(a=e.props)==null?void 0:a.variableName}function Ts(i,t){var a;const e=i.model.getStage(t.sourceStageId);if(!e)throw new Error(`Source node ${t.sourceStageId} not found`);const s=e.type;if(!s.includes("conditions")&&!s.includes("iterators"))throw new Error("Source node is not a flow controller");return(a=e.props)==null?void 0:a.itemName}const _s={class:"menu-item"},Es={class:"menu-item"},Ns={class:"menu-item"},xs={class:"menu-item"},Ps={class:"menu-item"},Cs=W({__name:"selection",props:{gui:{}},emits:["add-transition","duplicate-stages","revert-transitions","edit-stage","edit-transition","delete"],setup(i,{emit:t}){const e=i,s=f(()=>e.gui.selection.selectedIds().length===e.gui.selection.selectedStages().length),a=f(()=>e.gui.selection.selectedIds().length===e.gui.selection.selectedTransitions().length),o=f(()=>e.gui.selection.selectedIds().length>1||e.gui.selection.selectedIds().length===1&&e.gui.selection.selectedTransitions().length>0),n=f(()=>e.gui.selection.selectedIds().length===1),d=f(()=>e.gui.selection.selectedTransitions().some(R=>R.type.includes("iterators"))),l=f(()=>e.gui.selection.selectedIds().length>0&&(e.gui.mouseState.state==="IDLE"||e.gui.mouseState.state==="HOVERING_STAGE"||e.gui.mouseState.state==="HOVERING_TRANSITION"));function u(){const N=e.gui.selection.selectedStages(),R=N.map(k=>e.gui.getStageRect(k.id)),I=e.gui.selection.selectedTransitions();return(I.length>1||N.length>0)&&R.push(...I.map(k=>ys(e.gui,k.id))),ut(R)}const m=f(()=>{const N=u();if(!N)if(a.value&&n.value){const I=e.gui.selection.selectedTransitions()[0],k=re(e.gui,I);return{menu:{transform:`translate(${k.x+50}px, ${k.y-10}px) scale(${e.gui.camera.zoom}) `,transformOrigin:"top left"},hull:{}}}else return{menu:{display:"none"},hull:{display:"none"}};const R={x:N.x+N.width+10,y:N.y,referential:"screen"};return{menu:{transform:`translate(${R.x}px, ${R.y}px)`,transformOrigin:"top left"},hull:{position:"absolute",top:`${N.y}px`,left:`${N.x}px`,width:`${N.width}px`,height:`${N.height}px`,pointerEvents:"none",border:`1px dashed ${xt}`,boxSizing:"border-box"}}}),P=()=>t("add-transition"),C=()=>{s.value?t("edit-stage"):a.value&&t("edit-transition")},G=()=>t("duplicate-stages"),M=()=>t("delete"),O=()=>t("revert-transitions");return(N,R)=>(c(),y(B,null,[l.value?(c(),v(r(Te),{key:0,class:"selection-menu",style:ht(m.value.menu)},{default:h(()=>[s.value?(c(),v(r(j),{key:0,onClick:P},{default:h(()=>[_("div",_s,[g(r(E),null,{default:h(()=>[w("Add transition")]),_:1}),g(r(E),{keyboard:""},{default:h(()=>[w("T")]),_:1})])]),_:1})):T("",!0),n.value&&!d.value?(c(),v(r(j),{key:1,onClick:C},{default:h(()=>[_("div",Es,[g(r(E),null,{default:h(()=>[w("Edit")]),_:1}),g(r(E),{keyboard:""},{default:h(()=>[w("Enter")]),_:1})])]),_:1})):T("",!0),s.value?(c(),v(r(j),{key:2,onClick:G},{default:h(()=>[_("div",Ns,[g(r(E),null,{default:h(()=>[w("Duplicate")]),_:1}),g(r(E),{keyboard:""},{default:h(()=>[w("D")]),_:1})])]),_:1})):T("",!0),g(r(j),{onClick:M},{default:h(()=>[_("div",xs,[g(r(E),null,{default:h(()=>[w("Delete")]),_:1}),g(r(E),{keyboard:""},{default:h(()=>[w("Del")]),_:1})])]),_:1}),a.value?(c(),v(r(j),{key:3,onClick:O},{default:h(()=>[_("div",Ps,[g(r(E),null,{default:h(()=>[w("Revert")]),_:1}),g(r(E),{keyboard:""},{default:h(()=>[w("R")]),_:1})])]),_:1})):T("",!0)]),_:1},8,["style"])):T("",!0),o.value?(c(),y("div",{key:1,class:"selection-hull",style:ht(m.value.hull)},null,4)):T("",!0)],64))}});const ks=J(Cs,[["__scopeId","data-v-4441a0a3"]]),lt=32;function Nt(i){return{x:Math.round(i.x/lt)*lt,y:Math.round(i.y/lt)*lt,referential:"world"}}function As(i,t){const e=i.camera.screenPoint2world(t),s=Nt(e);return i.camera.worldPoint2screen(s)}function Ds(i,t){const e={...t.position,referential:"world"},s=i.camera.worldPoint2screen(e);return i.mouseState.state==="MOVING"&&i.selection.has(t)?As(i,st(s,$(i.mouseState.initialMousePos,i.mouseState.mousePos))):s}function bs(i,t,e){const s=i.getStageRect(t.id);return s?Ss(e,s):!1}const Gs={key:1,class:"title-text"},Ms={key:0},Rs={key:1},Os={key:0,style:{"margin-top":"8px"}},$s={style:{width:"24px",height:"24px"}},Vs={style:{width:"24px",height:"24px"}},Ks=W({__name:"stage",props:{stage:{},gui:{},workspace:{}},emits:["change"],setup(i,{emit:t}){var Ut,Bt,Wt;const e=i;_e(p=>({"1ac587af":r(xt)}));const s=Ee();function a(p){return p.type!=="conditions"&&p.type!=="iterators"}const o=()=>{const p=s.resolve({path:`/_editor/${e.stage.type.slice(0,-1)}/${e.stage.id}`});window.open(p.href,"_blank")},n=K(!0),d=F.exports.debounce(async p=>{Tt.checkFile(p).then(x=>{n.value=x.exists})},500),l=f(()=>{const p=te(b.value);return p.valid?n.value?{valid:!0,help:"This file already exists, stage will point to it."}:{valid:!0,help:"File doesn't exist yet. It will be created."}:p}),u=K("idle"),m=async()=>{if(u.value="creating",e.stage.type==="conditions"||e.stage.type==="iterators")return;t("change","filename",b.value),await e.workspace.initFile(b.value,e.stage.type),n.value=!0;const p=await Tt.checkFile(b.value);n.value=p.exists,u.value="idle"},P=p=>{p!==void 0&&t("change","title",p)},C=()=>{const p=_t(V.value);V.value=p,I(p)},G=()=>{const p=_t(nt.value);nt.value=p,k(p)},M=f(()=>{if(e.stage.type!=="conditions"&&e.stage.type!=="iterators")return{validateStatus:"success",help:""};const p=ee(V.value);return p.valid?{validateStatus:"success",help:""}:{validateStatus:"error",help:p.reason}}),O=f(()=>M.value.validateStatus==="error"),N=f(()=>!n.value),R=f(()=>{if(O.value)return"red";if(N.value)return"gold"}),I=p=>{!p||(t("change","variableName",p),t("change","title",p))},k=p=>{!p||t("change","itemName",p)},z=K(e.stage.title),b=K((Ut=e.stage.props.filename)!=null?Ut:""),V=K((Bt=e.stage.props.variableName)!=null?Bt:""),nt=K((Wt=e.stage.props.itemName)!=null?Wt:""),he=f(()=>e.gui.selection.has(e.stage)),ot=f(()=>e.gui.mouseState.state==="STAGE_QUICK_EDIT"&&e.gui.mouseState.stage.id===e.stage.id),zt=f(()=>e.stage.type==="conditions"||e.stage.type==="iterators"),pe=f(()=>{const p=Ds(e.gui,e.stage);return{transform:`translate(${p.x}px, ${p.y}px) scale(${e.gui.camera.zoom}) translate(-50%, -50%)`,transformOrigin:"top left"}}),ge=()=>{e.stage.type==="conditions"||e.stage.type==="iterators"||d(b.value)};let Lt;qt(()=>{Lt=setInterval(ge,1e3)}),Ne(()=>{clearInterval(Lt)}),xe(()=>e.stage.props.filename,()=>{t("change","filename",b.value)});const me=()=>{u.value="prompting",b.value=Me(e.stage.title),t("change","filename",b.value)};return(p,x)=>(c(),y("div",{class:Xt(["stage-card",{selected:he.value,editing:ot.value}]),style:ht(pe.value),tabindex:"0"},[ot.value?(c(),v(r(ft),{key:0,class:"card editing"},{title:h(()=>[g(r(Y),{justify:"space-between",align:"center"},{default:h(()=>[g(r(Y),{align:"center"},{default:h(()=>[g(r(Y),null,{default:h(()=>[(c(),v(Z(r(St)(p.stage.type))))]),_:1}),a(p.stage)?(c(),v(r(q),{key:0,value:z.value,"onUpdate:value":x[0]||(x[0]=A=>z.value=A),bordered:!1,class:"title-input",onInput:x[1]||(x[1]=A=>P(A.target.value))},null,8,["value"])):(c(),y("span",Gs,D(p.stage.title),1))]),_:1}),zt.value?T("",!0):(c(),v(r(Pe),{key:0},{title:h(()=>[p.gui.model.stageHasNonPositionChanges(p.stage.id)?(c(),y("span",Rs,"Save to allow edit in "+D(p.stage.type)+" editor",1)):(c(),y("span",Ms," Edit more in "+D(p.stage.type)+" editor ",1))]),default:h(()=>[p.gui.model.stageHasNonPositionChanges(p.stage.id)?(c(),v(r(Qt),{key:1,style:{opacity:"0.5",cursor:"default"}})):(c(),v(r(Qt),{key:0,onClick:o}))]),_:1}))]),_:1})]),default:h(()=>[zt.value?(c(),v(r(pt),{key:0,direction:"vertical",size:4,style:{width:"100%"}},{default:h(()=>[g(r(Zt),{"validate-status":M.value.validateStatus},{default:h(()=>[g(r(E),null,{default:h(()=>[w("Variable name")]),_:1}),g(r(q),{value:V.value,"onUpdate:value":x[2]||(x[2]=A=>V.value=A),onChange:x[3]||(x[3]=A=>I(A.target.value)),onBlur:C},null,8,["value"]),p.stage.type==="iterators"?(c(),y("div",Os,[g(r(E),null,{default:h(()=>[w("Item name")]),_:1}),g(r(q),{value:nt.value,"onUpdate:value":x[4]||(x[4]=A=>nt.value=A),onChange:x[5]||(x[5]=A=>k(A.target.value)),onBlur:G},null,8,["value"])])):T("",!0),M.value.validateStatus==="error"?(c(),v(r(Yt),{key:1,type:"error","show-icon":"",message:M.value.help,style:{"margin-top":"10px"}},null,8,["message"])):T("",!0)]),_:1},8,["validate-status"])]),_:1})):T("",!0),n.value?T("",!0):(c(),v(r(Yt),{key:1,type:"warning","show-icon":""},{message:h(()=>[g(r(E),null,{default:h(()=>[w(" Python file is missing. ")]),_:1})]),action:h(()=>[g(r(Ce),{size:"small",onClick:me},{default:h(()=>[w("Create")]),_:1})]),_:1}))]),_:1})):T("",!0),!ot.value&&(O.value||N.value)?(c(),v(r(Ke),{key:1,count:"!",color:R.value},{default:h(()=>[g(r(ft),{class:"card",style:{"max-width":"300px"}},{default:h(()=>[g(r(Y),{align:"center",gap:"small"},{default:h(()=>[_("span",$s,[(c(),v(Z(r(St)(p.stage.type)),{size:"22"}))]),g(r(E),{content:p.stage.title,ellipsis:!0,style:{width:"100%"}},null,8,["content"])]),_:1})]),_:1})]),_:1},8,["color"])):T("",!0),!ot.value&&!O.value&&!N.value?(c(),v(r(ft),{key:2,class:"card"},{default:h(()=>[g(r(Y),{align:"center",gap:"small"},{default:h(()=>[_("span",Vs,[(c(),v(Z(r(St)(p.stage.type)),{size:"22"}))]),g(r(E),{content:p.stage.title,ellipsis:!0,style:{width:"100%"}},null,8,["content"])]),_:1})]),_:1})):T("",!0),g(r(He),{open:u.value==="prompting"||u.value==="creating",closable:!1,"confirm-loading":u.value==="creating",onOk:m,onCancel:x[7]||(x[7]=A=>u.value="idle")},{default:h(()=>[g(r(Ve),{layout:"vertical",disabled:u.value=="creating"},{default:h(()=>[g(r(Zt),{label:"You're creating a new file. What should it be called?","validate-status":l.value.valid?"success":"error",help:l.value.valid?l.value.help:l.value.reason},{default:h(()=>[g(r(q),{value:b.value,"onUpdate:value":x[6]||(x[6]=A=>b.value=A)},null,8,["value"])]),_:1},8,["validate-status","help"])]),_:1},8,["disabled"])]),_:1},8,["open","confirm-loading"])],6))}});const Hs=J(Ks,[["__scopeId","data-v-17fe0cc0"]]),Fs={key:2},zs={key:3},Ls={key:4,style:{"line-height":"80%"}},Us=W({__name:"transition",props:{transition:{},gui:{}},emits:["change"],setup(i,{emit:t}){const e=i,s=I=>{t("change","type",String(I))},a=I=>{!I||t("change","condition",I)},o=e.gui.model.getStage(e.transition.sourceStageId);if(!o)throw new Error(`No source stage found for transition ${e.transition.id}`);const n=H.stages.find(I=>I.typeName===o.type),d=f(()=>{const I=n==null?void 0:n.transitions.find(k=>k.typeName===e.transition.type);if(!I)throw new Error(`No metadata found for transition ${e.transition.type}`);return I.title}),l=f(()=>!M.value&&!G.value?"":Is(e.gui,e.transition)),u=f(()=>{var I;return G.value&&((I=e.transition.props)==null?void 0:I.conditionValue)||""}),m=f(()=>M.value?Ts(e.gui,e.transition):""),P=f(()=>e.gui.mouseState.state!=="CHANGING_TRANSITION_TYPE"?!1:e.gui.mouseState.transition.id===e.transition.id),C=f(()=>e.gui.mouseState.state!=="TRANSITION_QUICK_EDIT"?!1:e.gui.mouseState.transition.id===e.transition.id),G=f(()=>e.transition.type.includes("conditions")),M=f(()=>e.transition.type.includes("iterators")),O=f(()=>e.gui.selection.has(e.transition)),N=f(()=>e.gui.mouseState.state!=="CHANGING_TRANSITION_TYPE"?"":e.gui.mouseState.newType),R=f(()=>{const I=re(e.gui,e.transition);return{transform:`translate(${I.x}px, ${I.y}px) scale(${e.gui.camera.zoom}) translate(-50%, -50%)`,transformOrigin:"top left",padding:C.value?"6px":"0"}});return(I,k)=>(c(),y("div",{class:Xt(["transition-card",{selected:O.value}]),style:ht(R.value),tabindex:"0"},[P.value?(c(),v(r(pt),{key:0,class:"editing"},{default:h(()=>[g(r(Ae),{class:"selector","default-value":N.value,"onUpdate:value":s},{default:h(()=>{var z,b;return[(c(!0),y(B,null,tt((b=(z=r(n))==null?void 0:z.transitions)!=null?b:[],V=>(c(),v(r(ke),{key:V.typeName},{default:h(()=>[(c(),v(Z(V.icon))),w(" "+D(V.title),1)]),_:2},1024))),128))]}),_:1},8,["default-value"])]),_:1})):C.value&&G.value?(c(),v(r(pt),{key:1,class:"editing"},{default:h(()=>[g(r(q),{style:{width:"200px"},"default-value":u.value,onChange:k[0]||(k[0]=z=>a(z.target.value))},{addonBefore:h(()=>[w("= ")]),_:1},8,["default-value"])]),_:1})):G.value?(c(),y("span",Fs,[g(r(E),{code:""},{default:h(()=>[w(D(l.value),1)]),_:1}),w(" = "+D(u.value),1)])):M.value?(c(),y("span",zs,[w(" for "),g(r(E),{code:""},{default:h(()=>[w(D(m.value),1)]),_:1}),w(" in "),g(r(E),{code:""},{default:h(()=>[w(D(l.value),1)]),_:1})])):(c(),y("span",Ls,D(d.value),1))],6))}});const Bs=J(Us,[["__scopeId","data-v-9c905ba1"]]);class Ct{static get isMac(){return navigator.userAgent.includes("Mac OS X")}static get buildPlatform(){return{}.CURRENT_PLATFORM||"web"}}const yt=i=>Ct.isMac&&i.ctrlKey,L=i=>Ct.isMac?i.metaKey:i.ctrlKey,le=i=>i.altKey,U=i=>i.shiftKey,vt={alt:le,"arrow-up":i=>i.code==="ArrowUp","arrow-down":i=>i.code==="ArrowDown","arrow-left":i=>i.code==="ArrowLeft","arrow-right":i=>i.code==="ArrowRight",ctrl:L,delete:i=>Ct.isMac?i.code==="Backspace":i.code==="Delete",enter:i=>i.code==="Enter",escape:i=>i.code==="Escape",shift:U,space:i=>i.code==="Space",a:i=>i.code==="KeyA",b:i=>i.code==="KeyB",c:i=>i.code==="KeyC",d:i=>i.code==="KeyD",f:i=>i.code==="KeyF",g:i=>i.code==="KeyG",h:i=>i.code==="KeyH",k:i=>i.code==="KeyK",p:i=>i.code==="KeyP",v:i=>i.code==="KeyV",x:i=>i.code==="KeyX",z:i=>i.code==="KeyZ",0:i=>i.code==="Digit0","[":i=>i.code==="BracketLeft","]":i=>i.code==="BracketRight"};class Ws{constructor(t){S(this,"pressedKeys");S(this,"evt");this.evt=t,this.pressedKeys={};const e=s=>a=>{Object.keys(vt).forEach(o=>{vt[o](a)&&this.setPressed(o,s)})};this.evt||(window.addEventListener("keydown",e(!0)),window.addEventListener("keyup",e(!1)))}setPressed(t,e){this.pressedKeys[t]=e}isPressed(t){var e;return this.evt?vt[t](this.evt):(e=this.pressedKeys[t])!=null?e:!1}}new Ws;class Qs{constructor(t){S(this,"selected");this.model=t,this.selected=et([])}deselect(t){this.selected.value=this.selected.value.filter(e=>e.type==="stage"?!t.includes(e.stage.id):!t.includes(e.transition.id))}select(t,e=!1){e||(this.selected.value=[]),t.forEach(s=>{const a=this.model.getStage(s);a&&(this.selected.value=[...this.selected.value,{type:"stage",stage:a}]);const o=this.model.getTransition(s);if(o&&(this.selected.value=[...this.selected.value,{type:"transition",transition:o}]),!a&&!o)throw new Error(`Could not find stage or transition with id ${s}`)})}clear(){this.selected.value=[]}selectedStages(){return this.selected.value.map(t=>t.type==="stage"?this.model.getStage(t.stage.id):null).filter(Boolean)}selectedTransitions(){return this.selected.value.map(t=>t.type==="transition"?this.model.getTransition(t.transition.id):null).filter(Boolean)}selectedIds(){return this.selected.value.map(t=>t.type==="stage"?t.stage.id:t.transition.id)}has(t){return this.selected.value.some(e=>e.type==="stage"?e.stage.id===t.id:e.transition.id===t.id)}isEmpty(){return this.selected.value.length===0}selectAllStages(){this.select(this.model.getState().stages.map(t=>t.id))}}const dt={left:100,right:100,top:100,bottom:100},wt=1,It=.5;class kt{constructor(t){S(this,"_state");S(this,"projectedElement");this._state=K({x:0,y:0,zoom:1}),this.projectedElement=t}get x(){return this._state.value.x}set x(t){if(Number.isNaN(t))throw new Error("x is NaN");this._state.value.x=t}get y(){return this._state.value.y}set y(t){if(Number.isNaN(t))throw new Error("y is NaN");this._state.value.y=t}static create(t){return new kt(t)}get zoom(){return this._state.value.zoom}set zoom(t){if(t<=0)throw new Error("Zoom must be positive");this._state.value.zoom=t}fit(t){const e={x:t.x+t.width/2,y:t.y+t.height/2,referential:"world"},s=this.screenRect2world(this.canvasRect);this.x=e.x-s.width/2,this.y=e.y-s.height/2;const a=this.canvasRect.width-dt.left-dt.right,o=this.canvasRect.height-dt.top-dt.bottom,n=Math.min(a/t.width,o/t.height)/this.zoom;this.zoomIn(Math.min(wt/this.zoom,Math.max(It/this.zoom,n)),this.worldPoint2screen(e))}screenPoint2world(t){return{x:t.x/this.zoom+this.x,y:t.y/this.zoom+this.y,referential:"world"}}worldPoint2screen(t){return{x:(t.x-this.x)*this.zoom,y:(t.y-this.y)*this.zoom,referential:"screen"}}screenDelta2world(t){return{dx:t.dx/this.zoom,dy:t.dy/this.zoom,referential:"world"}}worldDelta2screen(t){return{dx:t.dx*this.zoom,dy:t.dy*this.zoom,referential:"screen"}}screenRect2world(t){const e=this.screenPoint2world({x:t.x,y:t.y,referential:t.referential}),s=this.screenPoint2world({x:t.x+t.width,y:t.y+t.height,referential:t.referential});return{x:e.x,y:e.y,width:s.x-e.x,height:s.y-e.y,referential:e.referential}}worldRect2screen(t){const e=this.worldPoint2screen({x:t.x,y:t.y,referential:t.referential}),s=this.worldPoint2screen({x:t.x+t.width,y:t.y+t.height,referential:t.referential});return{x:e.x,y:e.y,width:s.x-e.x,height:s.y-e.y,referential:e.referential}}zoomIn(t,e){const s=this.screenPoint2world(e);this.zoom*t>wt?this.zoom=wt:this.zoom*t<It?this.zoom=It:this.zoom*=t;const a=this.worldPoint2screen(s),o=$(e,a),n=this.screenDelta2world({dx:o.dx,dy:o.dy,referential:"screen"});this.x+=n.dx,this.y+=n.dy}translate(t){this.x+=t.dx,this.y+=t.dy}get canvasRect(){if(!this.projectedElement)throw new Error("No canvas element");const t=this.projectedElement.getBoundingClientRect();return{x:t.x,y:t.y,width:t.width,height:t.height,referential:"screen"}}}class At{constructor(t,e){S(this,"_mouseState");S(this,"selection");S(this,"canvas");S(this,"ctx");S(this,"camera");S(this,"model");this.canvas=t,this.model=e,this.selection=new Qs(e),this.camera=kt.create(t),this._mouseState=et({state:"IDLE",mousePos:{x:0,y:0,referential:"screen"}});const s=t.getContext("2d");if(!s)throw new Error("Unable to get canvas context");this.ctx=s}static create(t,e){const s=new At(t,e);return s.init(),s}get mouseState(){return this._mouseState.value}set mouseState(t){this._mouseState.value=t}async deleteSelection(){this.model.delete(this.selection.selectedIds()),this.clearSelection(),this.goToIdle()}fixSize(){const{width:t,height:e}=this.canvas.getBoundingClientRect();this.canvas.width=t*devicePixelRatio,this.canvas.height=e*devicePixelRatio,this.ctx.scale(devicePixelRatio,devicePixelRatio)}computeCursor(){switch(this.mouseState.state){case"HOVERING_STAGE":this.canvas.style.cursor="pointer";break;case"HOVERING_TRANSITION":this.canvas.style.cursor="pointer";break;case"JUST_CLICKED_STAGE":this.canvas.style.cursor="default";break;case"JUST_CLICKED_TRANSITION":this.canvas.style.cursor="default";break;case"MOVING":this.canvas.style.cursor="move";break;case"PANNING":this.canvas.style.cursor="grabbing";break;case"ADDING_TRANSITION":this.canvas.style.cursor="crosshair";break;case"IDLE":default:this.canvas.style.cursor="grab"}}computePan(t){if(this.mouseState.state!=="PANNING")throw new Error(`Invalid state ${this.mouseState} on computePan`);const e=$(t,this.mouseState.mousePos),s=this.camera.screenDelta2world(e);this.camera.translate(s),this.mouseState={state:"PANNING",initialMousePos:this.mouseState.initialMousePos,mousePos:t}}setUpCanvasKeyDown(){let t=null;addEventListener("mousemove",e=>t=e),this.canvas.addEventListener("keydown",e=>{if(!!t)if(e.key==="f"||e.key==="F")this.dragstart("forms",t);else if(e.key==="h"||e.key==="H")this.dragstart("hooks",t);else if(e.key==="j"||e.key==="J")this.dragstart("jobs",t);else if(e.key==="c"||e.key==="C")this.dragstart("conditions",t);else if(e.key==="i"||e.key==="I")this.dragstart("iterators",t);else if(e.key==="s"||e.key==="S"){if(L(e))return;this.dragstart("scripts",t)}else(e.key==="z"||e.key==="Z")&&L(e)?(U(e)?this.model.history.redo():this.model.history.undo(),e.preventDefault()):(e.key==="a"||e.key==="A")&&L(e)?(this.selection.selectAllStages(),e.preventDefault()):(e.key==="Delete"||e.key==="Backspace")&&this.deleteSelection()})}setupMousemove(){const t=e=>{const s=this.getScreenPointerFromEvent(e);this.mouseState.state==="PANNING"?this.computePan(s):this.mouseState.state==="JUST_CLICKED_STAGE"?this.computeStartMoving(s,le(e),this.mouseState.stage):this.mouseState.state==="MOVING"?this.computeKeepMoving(s):this.mouseState.state==="ADDING_TRANSITION"?this.computeKeepLinking(s):this.mouseState.state==="ADDING_NEW_STAGES"&&this.computeKeepAdding(s),this.computeCursor()};addEventListener("mousemove",t)}setupMouseup(){const t=()=>{this.computeMouseRelease(),this.computeCursor()};addEventListener("mouseup",t)}computeMouseRelease(){this.mouseState.state!=="CHANGING_TRANSITION_TYPE"&&(this.mouseState.state==="PANNING"&&this.goToIdle(),this.mouseState.state==="MOVING"&&!this.mouseState.duplicating&&this.computeFinishMoving(),this.mouseState.state==="MOVING"&&this.mouseState.duplicating&&this.computeFinishDuplicating(),this.mouseState.state==="JUST_CLICKED_STAGE"&&this.computeStartHoveringStage(this.mouseState.stage))}setupDragover(){const t=e=>{if(e.preventDefault(),this.mouseState.state!=="ADDING_NEW_STAGES")return;const s=this.getScreenPointerFromEvent(e);this.computeKeepAdding(s)};this.canvas.addEventListener("dragover",t)}setupDrop(){const t=e=>{e.stopPropagation();const s=this.getScreenPointerFromEvent(e);this.computeFinishAdding(s)};this.canvas.addEventListener("drop",t)}setupWheel(){var e;const t=s=>{if(!this.camera)return;const a=this.getScreenPointerFromEvent(s);if(L(s)||yt(s))this.computeZoomIn(a,s.deltaY>0?.9:1.1),s.preventDefault();else{const o=U(s)?{dx:s.deltaY,dy:0}:{dx:s.deltaX,dy:s.deltaY},n=this.camera.screenDelta2world({dx:o.dx,dy:o.dy,referential:"screen"});this.camera.translate(n)}s.stopPropagation()};(e=this.canvas.parentElement)==null||e.addEventListener("wheel",t)}setupMousedown(){const t=e=>{const s=this.getScreenPointerFromEvent(e);this.computeStartClicking(s)};this.canvas.addEventListener("mousedown",t)}computeZoomIn(t,e){this.camera.zoomIn(e,t)}computeStartMoving(t,e,s){if(this.mouseState.state!=="JUST_CLICKED_STAGE")throw new Error(`Invalid state ${this.mouseState.state} on computeStartMoving`);this.mouseState={state:"MOVING",duplicating:e,initialMousePos:this.mouseState.mousePos,mousePos:t,pivot:s}}computeKeepMoving(t){if(this.mouseState.state!=="MOVING")throw new Error(`Invalid state ${this.mouseState.state} on computeKeepMoving`);const e=this.mouseState.duplicating;this.mouseState={state:"MOVING",duplicating:e,initialMousePos:this.mouseState.initialMousePos,mousePos:t,pivot:this.mouseState.pivot}}computeFinishMoving(){if(this.mouseState.state!=="MOVING")throw new Error(`Invalid state ${this.mouseState.state} on computeFinishMoving`);const t=this.camera.screenPoint2world(this.mouseState.initialMousePos),e=this.camera.screenPoint2world(this.mouseState.mousePos),s=$(t,e);this.model.move(this.selection.selectedStages().map(o=>({id:o.id,position:Nt(st({...o.position,referential:"world"},s))})));const a=this.mouseState.pivot;this.goToIdle(),a&&this.computeStartHoveringStage(a)}createTransition(){if(this.mouseState.state!=="IDLE"&&this.mouseState.state!=="HOVERING_STAGE")throw new Error(`Invalid state ${this.mouseState.state} on createTransition`);this.mouseState={state:"ADDING_TRANSITION",mousePos:this.mouseState.mousePos,initialMousePos:this.mouseState.mousePos,snappedTarget:null}}computeKeepLinking(t){if(this.mouseState.state!=="ADDING_TRANSITION")throw new Error(`Invalid state ${this.mouseState.state} on computeKeepLinking`);const e=this.model.getState().stages.find(s=>bs(this,s,t));e?this.mouseState={state:"ADDING_TRANSITION",initialMousePos:this.mouseState.initialMousePos,mousePos:t,snappedTarget:e}:this.mouseState={state:"ADDING_TRANSITION",initialMousePos:this.mouseState.initialMousePos,mousePos:t,snappedTarget:null}}computeFinishLinking(){if(this.mouseState.state!=="ADDING_TRANSITION"||!this.mouseState.snappedTarget)throw new Error(`Invalid state ${this.mouseState.state} on computeFinishLinking`);const t=this.mouseState.snappedTarget,e=this.selection.selectedStages().map(s=>({sourceStageId:s.id,targetStageId:t.id}));this.model.addTransitions(e),this.selection.select([this.mouseState.snappedTarget.id]),this.goToIdle(),this.computeStartHoveringStage(t)}duplicateSelection(){if(this.mouseState.state!=="HOVERING_STAGE"&&this.mouseState.state!=="HOVERING_TRANSITION"&&this.mouseState.state!=="IDLE")throw new Error(`Invalid state ${this.mouseState.state} on duplicateSelection`);const t=this.model.duplicateStages([...this.selection.selectedStages()]),e=Et(ut(t.stages.map(a=>({x:a.position.x,y:a.position.y,width:1,height:1,referential:"world"})))),s=this.camera.worldPoint2screen(e);return this.mouseState={state:"MOVING",duplicating:!0,initialMousePos:s,mousePos:this.mouseState.mousePos},t}duplicateThenSelect(){const e=this.duplicateSelection().stages.map(s=>s.id);this.selection.select(e)}computeFinishDuplicating(){if(this.mouseState.state!=="MOVING"||!this.mouseState.duplicating)throw new Error(`Invalid state ${this.mouseState.state} on computeFinishDuplicating`);const t=this.camera.screenPoint2world(this.mouseState.initialMousePos),e=this.camera.screenPoint2world(this.mouseState.mousePos),s=$(t,e);this.model.move(this.selection.selectedStages().map(a=>({id:a.id,position:st({...a.position,referential:"world"},s)}))),this.goToIdle()}computeKeepAdding(t){if(this.mouseState.state!=="ADDING_NEW_STAGES")throw new Error(`Invalid state ${this.mouseState.state} on computeKeepAdding`);this.mouseState={state:"ADDING_NEW_STAGES",mousePos:t,stages:this.mouseState.stages.map(e=>({...e,position:Nt(this.camera.screenPoint2world(t))}))}}computeFinishAdding(t){if(this.mouseState.state!=="ADDING_NEW_STAGES")return;this.computeKeepAdding(t);const e=this.model.addStages(this.mouseState.stages);this.selection.select(e.map(s=>s.id)),this.goToIdle()}getScreenPointerFromEvent(t){const e=this.canvas.getBoundingClientRect();return{x:t.pageX-e.x,y:t.pageY-e.y,referential:"screen"}}computeStartClicking(t){this.mouseState.state==="MOVING"&&this.mouseState.duplicating||(this.mouseState.state==="ADDING_NEW_STAGES"?this.computeFinishAdding(t):this.mouseState.state==="STAGE_QUICK_EDIT"?this.goToIdle():this.mouseState.state==="CHANGING_TRANSITION_TYPE"?(this.model.updateTransitionType(this.mouseState.transition.id,this.mouseState.newType),this.clearSelection(),this.goToIdle()):this.mouseState.state==="TRANSITION_QUICK_EDIT"?this.model.updateTransitionProps(this.mouseState.transition.id,this.mouseState.draftProps):(this.clearSelection(),this.mouseState={state:"PANNING",initialMousePos:t,mousePos:t}))}stageMouseDown(t,e){if(this.mouseState.state==="HOVERING_STAGE"){if(this.selection.has(e)||this.selection.select([e.id],U(t)),t.button!==0)return;this.mouseState={state:"JUST_CLICKED_STAGE",mousePos:this.getScreenPointerFromEvent(t),stage:e};return}if(this.mouseState.state==="ADDING_TRANSITION"){this.computeFinishLinking();return}if(this.mouseState.state==="STAGE_QUICK_EDIT"){if(this.mouseState.stage.id===e.id)return;this.saveChangesOnChangingEditingEntity(),this.selection.select([e.id],U(t)),this.mouseState={state:"JUST_CLICKED_STAGE",mousePos:this.getScreenPointerFromEvent(t),stage:e}}(this.mouseState.state==="TRANSITION_QUICK_EDIT"||this.mouseState.state==="CHANGING_TRANSITION_TYPE")&&(this.saveChangesOnChangingEditingEntity(),this.selection.select([e.id],U(t)),this.mouseState={state:"JUST_CLICKED_STAGE",mousePos:this.getScreenPointerFromEvent(t),stage:e})}computeStartHoveringStage(t){this.mouseState.state!=="IDLE"&&this.mouseState.state!=="JUST_CLICKED_STAGE"||(this.mouseState={state:"HOVERING_STAGE",stage:t,mousePos:this.mouseState.mousePos})}computeFinishHoveringStage(t){this.mouseState.state==="HOVERING_STAGE"&&this.mouseState.stage.id===t.id&&this.goToIdle()}saveChangesOnChangingEditingEntity(){this.mouseState.state==="STAGE_QUICK_EDIT"&&(this.model.updateStageTitle(this.mouseState.stage.id,this.mouseState.stage.title),this.model.updateStageProps(this.mouseState.stage.id,this.mouseState.draftProps),this.goToIdle()),this.mouseState.state==="TRANSITION_QUICK_EDIT"&&(this.model.updateTransitionProps(this.mouseState.transition.id,this.mouseState.draftProps),this.goToIdle()),this.mouseState.state==="CHANGING_TRANSITION_TYPE"&&(this.model.updateTransitionType(this.mouseState.transition.id,this.mouseState.newType),this.goToIdle())}computeStartEditingStage(t){var e,s,a,o;if(!(this.mouseState.state==="STAGE_QUICK_EDIT"&&this.mouseState.stage.id===t.id)){if(this.saveChangesOnChangingEditingEntity(),this.mouseState.state!=="IDLE"&&this.mouseState.state!=="HOVERING_STAGE")throw new Error(`Invalid state ${this.mouseState.state} on computeStartEditingStage`);this.mouseState={state:"STAGE_QUICK_EDIT",stage:t,mousePos:this.mouseState.mousePos,draftProps:{path:(e=t.props)==null?void 0:e.path,filename:(s=t.props)==null?void 0:s.filename,variableName:(a=t.props)==null?void 0:a.variableName,itemName:(o=t.props)==null?void 0:o.itemName}},this.clearSelection()}}computeStartEditingStageSelection(){if(this.selection.selectedStages().length!==1)return;const t=this.selection.selectedStages()[0];this.computeStartEditingStage(t)}computeStartChangingTransitionSelection(){if(this.selection.selectedTransitions().length!==1)return;const t=this.selection.selectedTransitions()[0];this.computeStartChangingTransition(t)}computeChangeStage(t,e){var a;const s=this.mouseState.state==="STAGE_QUICK_EDIT"?this.mouseState.stage:(a=this.selection.selectedStages()[0])!=null?a:null;if(!s)throw new Error("Couldn't find the stage");t==="title"?this.model.updateStageTitle(s.id,e):this.model.updateStageProps(s.id,{...s.props,[t]:e})}computeChangeTransition(t,e){this.mouseState.state==="TRANSITION_QUICK_EDIT"&&t==="condition"&&(this.mouseState.draftProps={conditionValue:e}),this.mouseState.state==="CHANGING_TRANSITION_TYPE"&&t==="type"&&(this.mouseState.newType=e)}computeKeyDownStage(t){if(t.key==="Enter"&&this.mouseState.state==="STAGE_QUICK_EDIT"){this.model.updateStageProps(this.mouseState.stage.id,this.mouseState.draftProps),this.goToIdle();return}this.mouseState.state==="STAGE_QUICK_EDIT"||this.mouseState.state==="TRANSITION_QUICK_EDIT"||(t.key==="t"||t.key==="T"?this.createTransition():t.key==="Enter"?this.selection.selectedStages().length===1&&this.computeStartEditingStage(this.selection.selectedStages()[0]):t.key==="d"||t.key==="D"?this.duplicateThenSelect():t.key==="Delete"||t.key==="Backspace"?this.deleteSelection():(t.key==="a"||t.key==="A")&&(L(t)||yt(t))?(this.selection.select(this.model.getState().stages.map(e=>e.id)),t.preventDefault()):t.key==="Escape"&&(this.clearSelection(),this.goToIdle()))}transitionMouseDown(t,e){if(t.button===0&&!(this.mouseState.state==="MOVING"&&this.mouseState.duplicating)){if(this.mouseState.state==="TRANSITION_QUICK_EDIT"||this.mouseState.state==="CHANGING_TRANSITION_TYPE"){if(this.mouseState.transition.id===e.id)return;this.saveChangesOnChangingEditingEntity()}this.mouseState.state==="STAGE_QUICK_EDIT"&&this.saveChangesOnChangingEditingEntity(),this.selection.select([e.id],U(t)),this.computeStartHoveringTransition(e)}}computeStartHoveringTransition(t){if(!(this.mouseState.state==="CHANGING_TRANSITION_TYPE"||this.mouseState.state==="TRANSITION_QUICK_EDIT"||this.mouseState.state==="STAGE_QUICK_EDIT"||this.mouseState.state==="MOVING"||this.mouseState.state==="HOVERING_TRANSITION")){if(this.mouseState.state!=="IDLE")throw new Error(`Invalid state ${this.mouseState.state} on computeStartHoveringTransition`);this.mouseState={state:"HOVERING_TRANSITION",transition:t,mousePos:this.mouseState.mousePos}}}computeFinishHoveringTransition(t){if(!(this.mouseState.state==="CHANGING_TRANSITION_TYPE"||this.mouseState.state==="STAGE_QUICK_EDIT"||this.mouseState.state==="TRANSITION_QUICK_EDIT"||this.mouseState.state==="MOVING"||this.mouseState.state==="IDLE")){if(this.mouseState.state!=="HOVERING_TRANSITION")throw new Error(`Invalid state ${this.mouseState.state} on computeFinishHoveringTransition`);this.mouseState.transition.id===t.id&&this.goToIdle()}}computeAddTransition(){if(this.mouseState.state!=="IDLE")throw new Error(`Invalid state ${this.mouseState.state} on computeAddTransition`);this.mouseState={state:"ADDING_TRANSITION",mousePos:this.mouseState.mousePos,initialMousePos:this.mouseState.mousePos,snappedTarget:null}}revertTransitions(){this.selection.selectedTransitions().forEach(e=>this.model.revertTransition(e.id))}computeStartChangingTransition(t){var s;if(this.saveChangesOnChangingEditingEntity(),this.mouseState.state==="CHANGING_TRANSITION_TYPE")return;if(this.mouseState.state!=="HOVERING_TRANSITION"&&this.mouseState.state!=="IDLE")throw new Error(`Invalid state ${this.mouseState.state} on computeStartChangingTransition`);const e=this.model.getStage(t.sourceStageId);(e==null?void 0:e.type)!=="iterators"&&((e==null?void 0:e.type)==="conditions"?this.mouseState={state:"TRANSITION_QUICK_EDIT",transition:t,mousePos:this.mouseState.mousePos,draftProps:{conditionValue:(s=t.props)==null?void 0:s.conditionValue}}:this.mouseState={state:"CHANGING_TRANSITION_TYPE",transition:t,mousePos:this.mouseState.mousePos,newType:t.type})}computeKeyDownTransition(t){if(t.key==="Enter"&&this.mouseState.state==="TRANSITION_QUICK_EDIT"){this.model.updateTransitionProps(this.mouseState.transition.id,this.mouseState.draftProps),this.goToIdle();return}if(t.key==="Enter"&&this.mouseState.state==="CHANGING_TRANSITION_TYPE"){this.model.updateTransitionType(this.mouseState.transition.id,this.mouseState.newType),this.goToIdle();return}this.mouseState.state==="STAGE_QUICK_EDIT"||this.mouseState.state==="TRANSITION_QUICK_EDIT"||(t.key==="Enter"?this.selection.selectedTransitions().length===1&&this.computeStartChangingTransition(this.selection.selectedTransitions()[0]):t.key==="Delete"||t.key==="Backspace"?this.deleteSelection():t.key==="a"&&(L(t)||yt(t))?(this.selection.select(this.model.getState().stages.map(e=>e.id)),t.preventDefault()):t.key==="r"||t.key==="R"?this.revertTransitions():t.key==="Escape"&&(this.clearSelection(),this.goToIdle()))}getStageRect(t){var o,n,d,l;this.mouseState,this.camera.x,this.camera.y,this.camera.zoom;const e=(o=this.canvas.parentElement)==null?void 0:o.querySelector(`.items-container [data-type="stage"][data-id="${t}"]`),s=(n=e==null?void 0:e.getBoundingClientRect)==null?void 0:n.call(e),a=(l=(d=e==null?void 0:e.parentElement)==null?void 0:d.getBoundingClientRect)==null?void 0:l.call(d);return!a||!s?null:{x:s.x-a.x,y:s.y-a.y,width:s.width,height:s.height,referential:"screen"}}getTransitionRect(t){var o,n,d,l;const e=(o=this.canvas.parentElement)==null?void 0:o.querySelector(`.items-container [data-type="transition"][data-id="${t}"]`),s=(n=e==null?void 0:e.getBoundingClientRect)==null?void 0:n.call(e),a=(l=(d=e==null?void 0:e.parentElement)==null?void 0:d.getBoundingClientRect)==null?void 0:l.call(d);return!a||!s?null:{x:s.x-a.x,y:s.y-a.y,width:s.width,height:s.height,referential:"screen"}}renderAddTransition(){this.mouseState.state==="ADDING_TRANSITION"&&ws(this)}debug(){this.ctx.fillText(JSON.stringify(this.mouseState,null,2),10,10),this.ctx.fillText(JSON.stringify(this.selection.selectedIds(),null,2),10,30),this.ctx.fillText(`zoom: ${this.camera.zoom}`,10,50);const t=50,e=this.model.getState().stages.map(a=>({height:2*t,referential:"world",width:2*t,x:a.position.x-t,y:a.position.y-t})),s=ut(e);!s||this.ctx.fillText(JSON.stringify(s,null,2),10,70)}renderTransitions(){this.model.getState().transitions.forEach(t=>{oe(this,t)})}render(){try{this.fixSize(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderTransitions(),this.renderAddTransition()}finally{requestAnimationFrame(()=>this.render())}}fitCamera(){const e=this.model.getState().stages.map(a=>({height:100,referential:"world",width:100,x:a.position.x-50,y:a.position.y-50})),s=ut(e);!s||this.camera.fit(s)}init(){this.setUpCanvasKeyDown(),this.setupMousemove(),this.setupDragover(),this.setupMousedown(),this.setupDrop(),this.setupMouseup(),this.setupWheel(),this.render(),this.fitCamera()}clearSelection(){this.selection.clear()}dragstart(t,e){const s=this.getScreenPointerFromEvent(e);this.clearSelection(),this.mouseState={state:"ADDING_NEW_STAGES",mousePos:s,stages:[{type:t,position:this.camera.screenPoint2world(s)}]}}goToIdle(){this.mouseState={state:"IDLE",mousePos:this.mouseState.mousePos}}}const de=i=>(De("data-v-1acf9439"),i=i(),be(),i),Ys={class:"empty-hint"},Zs={key:0,class:"drag-hint"},Js=de(()=>_("div",{class:"title"},"Start here",-1)),js={key:1,class:"drop-hint"},qs=de(()=>_("div",{class:"title"},"Drop here",-1)),Xs={key:2,class:"stages-hint"},ti={class:"header"},ei={class:"title"},si={class:"description"},ii=W({__name:"EmptyHint",props:{gui:{}},setup(i){const t=i,e=f(()=>t.gui.model.getState().stages.length===0&&t.gui.mouseState.state!=="ADDING_NEW_STAGES"),s=f(()=>t.gui.model.getState().stages.length===0&&t.gui.mouseState.state==="ADDING_NEW_STAGES");return(a,o)=>(c(),y("div",Ys,[e.value?(c(),y("div",Zs,[Js,g(r(Jt),{size:32,class:"arrow"})])):T("",!0),s.value?(c(),y("div",js,[qs,g(r(Jt),{size:32,class:"arrow"})])):T("",!0),e.value?(c(),y("div",Xs,[(c(!0),y(B,null,tt(r(H).stages,n=>(c(),y("div",{key:n.key,class:"stage-hint"},[_("div",ti,[(c(),v(Z(n.icon))),_("span",ei,D(n.title),1)]),_("div",si,D(n.description),1)]))),128))])):T("",!0)]))}});const ai=J(ii,[["__scopeId","data-v-1acf9439"]]),ni={class:"canvas-container"},oi={key:0,class:"items-container"},ri=W({__name:"CanvasGui",props:{model:{},workspace:{}},setup(i,{expose:t}){const e=i,s=K(null),a=et(null);t({gui:a}),qt(()=>{if(!s.value)throw new Error("canvas is null");a.value=At.create(s.value,e.model)});const o=f(()=>e.model.getState());return(n,d)=>(c(),y("div",ni,[_("canvas",{ref_key:"canvas",ref:s,class:"workflow-canvas",tabindex:"0"},null,512),a.value?(c(),y("div",oi,[(c(!0),y(B,null,tt(o.value.stages,l=>(c(),v(Hs,{key:l.id,gui:a.value,workspace:n.workspace,"data-type":"stage","data-id":l.id,stage:l,onChange:d[0]||(d[0]=(u,m)=>{var P;return(P=a.value)==null?void 0:P.computeChangeStage(u,m)}),onMousedown:u=>{var m;return(m=a.value)==null?void 0:m.stageMouseDown(u,l)},onMouseenter:()=>{var u;return(u=a.value)==null?void 0:u.computeStartHoveringStage(l)},onMouseleave:()=>{var u;return(u=a.value)==null?void 0:u.computeFinishHoveringStage(l)},onKeydown:d[1]||(d[1]=u=>{var m;return(m=a.value)==null?void 0:m.computeKeyDownStage(u)}),onDblclick:()=>{var u;return(u=a.value)==null?void 0:u.computeStartEditingStage(l)}},null,8,["gui","workspace","data-id","stage","onMousedown","onMouseenter","onMouseleave","onDblclick"]))),128)),(c(!0),y(B,null,tt(o.value.transitions,l=>(c(),v(Bs,{key:l.id,gui:a.value,"data-type":"transition","data-id":l.id,transition:l,onChange:d[2]||(d[2]=(u,m)=>{var P;return(P=a.value)==null?void 0:P.computeChangeTransition(u,m)}),onMousedown:u=>{var m;return(m=a.value)==null?void 0:m.transitionMouseDown(u,l)},onMouseenter:()=>{var u;return(u=a.value)==null?void 0:u.computeStartHoveringTransition(l)},onMouseleave:()=>{var u;return(u=a.value)==null?void 0:u.computeFinishHoveringTransition(l)},onDblclick:()=>{var u;return(u=a.value)==null?void 0:u.computeStartChangingTransition(l)},onKeydown:d[3]||(d[3]=u=>{var m;return(m=a.value)==null?void 0:m.computeKeyDownTransition(u)})},null,8,["gui","data-id","transition","onMousedown","onMouseenter","onMouseleave","onDblclick"]))),128)),g(ks,{gui:a.value,onAddTransition:d[4]||(d[4]=()=>{var l;return(l=a.value)==null?void 0:l.computeAddTransition()}),onEditStage:d[5]||(d[5]=()=>{var l;return(l=a.value)==null?void 0:l.computeStartEditingStageSelection()}),onEditTransition:d[6]||(d[6]=()=>{var l;return(l=a.value)==null?void 0:l.computeStartChangingTransitionSelection()}),onRevertTransitions:d[7]||(d[7]=()=>{var l;return(l=a.value)==null?void 0:l.revertTransitions()}),onDuplicateStages:d[8]||(d[8]=()=>{var l;return(l=a.value)==null?void 0:l.duplicateThenSelect()}),onDelete:d[9]||(d[9]=()=>{var l;return(l=a.value)==null?void 0:l.deleteSelection()})},null,8,["gui"])])):T("",!0),a.value&&o.value.stages.length===0?(c(),v(ai,{key:1,gui:a.value},null,8,["gui"])):T("",!0)]))}});const li=J(ri,[["__scopeId","data-v-cdfe38b9"]]);function Dt(){return Math.random().toString(36).slice(2,9)}class Q{constructor(t){this.changes=t}apply(t){return this.changes.reduce((e,s)=>s.apply(e),t)}reverse(){return new Q(this.changes.map(t=>t.reverse()).reverse())}}class ue{constructor(t){S(this,"removed");this.stageId=t,this.removed=null}apply(t){const e=t.stages.find(a=>a.id===this.stageId)||null;if(!e)throw new Error(`Stage ${this.stageId} not found`);const s=t.transitions.filter(a=>a.sourceStageId===this.stageId||a.targetStageId===this.stageId);return this.removed={stage:e,transitions:s},{stages:t.stages.filter(a=>a.id!==e.id),transitions:t.transitions.filter(a=>!s.find(o=>o.id===a.id))}}reverse(){if(!this.removed)throw new Error("Cannot reverse change that was not applied");const t=new bt(this.removed.stage.type,this.removed.stage.title,this.removed.stage.position,this.removed.stage.id,this.removed.stage.props),e=this.removed.transitions.map(s=>new mt(s.sourceStageId,s.targetStageId,s.type,s.id));return new Q([t,...e])}}class bt{constructor(t,e,s,a,o){S(this,"addedStage");this.stageType=t,this.nodeTitle=e,this.position=s,this.id=a,this.props=o,this.addedStage=null}assertStageDoesNotExist(t){if(t.stages.find(e=>e.id===this.id))throw new Error(`Stage ${this.id} already exists`)}assertValidStageType(){if(!H.stages.find(t=>t.typeName===this.stageType))throw new Error(`Invalid stage type ${this.stageType}`)}assertTransitionDoesNotExist(t){if(t.transitions.find(e=>e.sourceStageId===this.id||e.targetStageId===this.id))throw new Error("Stage already has transitions")}makePath(t){switch(this.stageType){case"forms":return`new-form-${t}`;case"hooks":return`new-hook-${t}`;default:return null}}makeFilename(t){switch(this.stageType){case"forms":return`new_form_${t}.py`;case"hooks":return`new_hook_${t}.py`;case"jobs":return`new_job_${t}.py`;case"scripts":return`new_script_${t}.py`;default:return null}}makeVariableName(){switch(this.stageType){case"conditions":return"my_condition";case"iterators":return"my_list";default:return null}}makeItemName(){switch(this.stageType){case"iterators":return"item";default:return null}}apply(t){var a,o,n;const e=Dt(),s=(a=this.props)!=null?a:{path:this.makePath(e),filename:this.makeFilename(e),variableName:this.makeVariableName(),itemName:this.makeItemName()};return this.nodeTitle=(o=this.makeVariableName())!=null?o:this.nodeTitle,this.assertStageDoesNotExist(t),this.assertValidStageType(),this.assertTransitionDoesNotExist(t),this.addedStage={id:(n=this.id)!=null?n:ze(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:s},{transitions:t.transitions,stages:[...t.stages,this.addedStage]}}reverse(){if(!this.addedStage)throw new Error("Cannot reverse change that was not applied");return new ue(this.addedStage.id)}}class di extends Q{constructor(t){super(t.map(e=>new bt(e.type,e.title,e.position,e.id)))}}class Gt{constructor(t,e){S(this,"oldTitle");this.stageId=t,this.newTitle=e,this.oldTitle=""}apply(t){const e=t.stages.find(s=>s.id===this.stageId);if(!e)throw new Error(`Stage ${this.stageId} not found`);return this.oldTitle=e.title,{stages:t.stages.map(s=>s.id===this.stageId?{...s,title:this.newTitle}:s),transitions:t.transitions}}reverse(){return new Gt(this.stageId,this.oldTitle)}}class ce{constructor(t){S(this,"removedTransition");this.transitionId=t,this.removedTransition=null}apply(t){const e=t.transitions.find(s=>s.id===this.transitionId);if(!e)throw new Error(`Transition ${this.transitionId} not found`);return this.removedTransition=e!=null?e:null,{stages:t.stages,transitions:t.transitions.filter(s=>s.id!==this.transitionId)}}reverse(){if(!this.removedTransition)throw new Error("Cannot reverse change that was not applied");return new mt(this.removedTransition.sourceStageId,this.removedTransition.targetStageId,this.removedTransition.type,this.removedTransition.id)}}class mt{constructor(t,e,s,a){S(this,"addedTransition");this.sourceStageId=t,this.targetStageId=e,this.transitionType=s,this.transitionId=a,this.addedTransition=null}assertSourceStageExists(t){if(!t.stages.find(e=>e.id===this.sourceStageId))throw new Error(`Stage ${this.sourceStageId} not found`)}assertTargetStageExists(t){if(!t.stages.find(e=>e.id===this.targetStageId))throw new Error(`Stage ${this.targetStageId} not found`)}assertTransitionDoesNotExist(t){if(t.transitions.find(e=>e.id===this.transitionId))throw new Error(`Transition ${this.transitionId} already exists`)}assertNotSelfTransition(){if(this.sourceStageId===this.targetStageId)throw new Error("Self transitions are not allowed")}assertNoDuplicatedTransitionStages(t){if(t.transitions.find(e=>e.sourceStageId===this.sourceStageId&&e.targetStageId===this.targetStageId))throw X.error({message:"Invalid transition",description:"Transition already exists"}),new Error("Transition already exists")}assertValidTransitionType(t){const e=t.stages.find(o=>o.id===this.sourceStageId);if(!H.stages.find(o=>o.typeName===e.type).transitions.map(o=>o.typeName).includes(this.transitionType))throw new Error(`Invalid transition type ${this.transitionType}`)}assertNotStartingOnlyTargetStage(t){const e=t.stages.find(a=>a.id===this.targetStageId);if(H.stages.find(a=>a.typeName===e.type).startingOnly)throw X.error({message:"Invalid transition",description:"Cannot transition to starting-only stage"}),new Error("Cannot transition to starting-only stage")}assertNoStageWithSameId(t){if(t.stages.find(e=>e.id===this.transitionId))throw new Error(`Stage with id ${this.transitionId} already exists`)}apply(t){var e;return this.assertSourceStageExists(t),this.assertTargetStageExists(t),this.assertTransitionDoesNotExist(t),this.assertNotSelfTransition(),this.assertNoDuplicatedTransitionStages(t),this.assertValidTransitionType(t),this.assertNotStartingOnlyTargetStage(t),this.assertNoStageWithSameId(t),this.addedTransition={id:(e=this.transitionId)!=null?e:Dt(),sourceStageId:this.sourceStageId,targetStageId:this.targetStageId,type:this.transitionType,props:{conditionValue:null}},{stages:t.stages,transitions:[...t.transitions,this.addedTransition]}}reverse(){if(!this.addedTransition)throw new Error("Cannot reverse change that was not applied");return new ce(this.addedTransition.id)}}class Mt{constructor(t){S(this,"transitionId");this.transitionId=t}assertValidTransitionType(t){const e=t.transitions.find(n=>n.id===this.transitionId),s=t.stages.find(n=>n.id===e.targetStageId);if(!H.stages.find(n=>n.typeName===s.type).transitions.map(n=>n.typeName).includes(e.type))throw new Error(`Invalid transition type ${e.type}`)}apply(t){if(this.assertValidTransitionType(t),!t.transitions.find(s=>s.id===this.transitionId))throw new Error(`Transition ${this.transitionId} not found`);return{stages:t.stages,transitions:t.transitions.map(s=>s.id===this.transitionId?{...s,sourceStageId:s.targetStageId,targetStageId:s.sourceStageId}:s)}}reverse(){return new Mt(this.transitionId)}}class ui extends Q{constructor(t){super(t.map(e=>new mt(e.sourceStageId,e.targetStageId,e.type,e.id)))}}class Rt{constructor(t){S(this,"oldPositions");this.newPositions=t,this.oldPositions=null}assertStagesExists(t){this.newPositions.forEach(({id:e})=>{if(!t.stages.find(s=>s.id===e))throw new Error(`Stage ${e} not found`)})}assertIsNumber(){this.newPositions.forEach(({position:t})=>{if(Number.isNaN(t.x)||Number.isNaN(t.y)||!Number.isFinite(t.x)||!Number.isFinite(t.y))throw new Error("Position must be a number")})}apply(t){return this.assertIsNumber(),this.assertStagesExists(t),this.oldPositions=t.stages.map(s=>({id:s.id,position:s.position})),{stages:t.stages.map(s=>{var o,n;const a=(n=(o=this.newPositions.find(d=>d.id===s.id))==null?void 0:o.position)!=null?n:s.position;return{...s,position:{x:a.x,y:a.y}}}),transitions:t.transitions}}reverse(){if(!this.oldPositions)throw new Error("Cannot reverse change that was not applied");return new Rt(this.oldPositions)}}class Ot{constructor(t,e){S(this,"stageId");S(this,"newTitle");S(this,"oldTitle");this.stageId=t,this.newTitle=e,this.oldTitle=""}assertStageExists(t){if(!t.stages.find(e=>e.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}apply(t){return this.assertStageExists(t),this.oldTitle=t.stages.find(e=>e.id===this.stageId).title,{stages:t.stages.map(e=>e.id===this.stageId?{...e,title:this.newTitle}:e),transitions:t.transitions}}reverse(){return new Ot(this.stageId,this.oldTitle)}}class $t{constructor(t,e){S(this,"stageId");S(this,"newProps");S(this,"oldProps");this.stageId=t,this.newProps=e,this.oldProps={path:null,filename:null,variableName:null,itemName:null}}assertStageExists(t){if(!t.stages.find(e=>e.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}assertValidVariableName(){if(!this.newProps.variableName)return;const t=this.newProps.variableName,e=ee(t);if(!e.valid){X.error({message:"Invalid variable name",description:e.reason});return}this.newProps.variableName=_t(t)}assertValidPath(){if(!this.newProps.path)return;const t=Re(this.newProps.path);if(!t.valid){X.error({message:"Invalid path",description:t.reason});return}this.newProps.path=Oe(this.newProps.path)}assertValidFilename(){if(!this.newProps.filename)return;const t=te(this.newProps.filename);if(!t.valid){X.error({message:"Invalid filename",description:t.reason});return}this.newProps.filename=$e(this.newProps.filename)}apply(t){return this.assertStageExists(t),this.assertValidVariableName(),this.assertValidPath(),this.assertValidFilename(),this.oldProps=t.stages.find(e=>e.id===this.stageId).props,{stages:t.stages.map(e=>e.id===this.stageId?{...e,props:this.newProps}:e),transitions:t.transitions}}reverse(){return new $t(this.stageId,this.oldProps)}}class Vt{constructor(t,e){S(this,"newType");S(this,"transitionId");this.newType=e,this.transitionId=t}apply(t){return{transitions:t.transitions.map(e=>e.id===this.transitionId?{...e,type:this.newType}:e),stages:t.stages}}reverse(){return new Vt(this.transitionId,this.newType)}}class Kt{constructor(t,e){S(this,"newProps");S(this,"transitionId");this.newProps=e,this.transitionId=t}apply(t){return{transitions:t.transitions.map(e=>e.id===this.transitionId?{...e,props:this.newProps}:e),stages:t.stages}}reverse(){return new Kt(this.transitionId,this.newProps)}}class ci{constructor(t){S(this,"change");this.duplicatedStages=t,this.change=null}assertStagesExists(t){this.duplicatedStages.forEach(e=>{if(!t.stages.find(s=>s.id===e.id))throw new Error(`Stage ${e.id} not found`)})}apply(t){this.assertStagesExists(t);const e=this.duplicatedStages.map(Dt),s=this.duplicatedStages.map((n,d)=>new bt(n.type,`${n.title} - Copy`,{x:n.position.x,y:n.position.y},e[d])),o=t.transitions.filter(n=>{const d=this.duplicatedStages.find(u=>u.id===n.sourceStageId),l=this.duplicatedStages.find(u=>u.id===n.targetStageId);return d&&l}).map(n=>{const d=e[this.duplicatedStages.findIndex(u=>u.id===n.sourceStageId)],l=e[this.duplicatedStages.findIndex(u=>u.id===n.targetStageId)];return new mt(d,l,n.type)});return this.change=new Q([...s,...o]),this.change.apply(t)}reverse(){if(!this.change)throw new Error("Cannot reverse change that was not applied");return this.change.reverse()}}class hi extends Q{constructor(t,e){super([...e.map(s=>new ce(s)),...t.map(s=>new ue(s))])}}class Ht{constructor(t,e){S(this,"oldTransitionState");this.transitionId=t,this.newType=e,this.oldTransitionState=null}assertTransitionExists(t){if(!t.transitions.find(e=>e.id===this.transitionId))throw new Error(`Transition ${this.transitionId} not found`)}assertValidTransitionType(t){const e=t.transitions.find(n=>n.id===this.transitionId),s=t.stages.find(n=>n.id===e.sourceStageId);if(!H.stages.find(n=>n.typeName===s.type).transitions.map(n=>n.typeName).includes(this.newType))throw new Error(`Invalid transition type ${this.newType}`)}apply(t){this.assertTransitionExists(t),this.assertValidTransitionType(t);const e=t.transitions.find(s=>s.id===this.transitionId);return this.oldTransitionState=e,{stages:t.stages,transitions:t.transitions.map(s=>s.id===this.transitionId?{...s,type:this.newType}:s)}}reverse(){if(!this.oldTransitionState)throw new Error("Cannot reverse change that was not applied");return new Ht(this.transitionId,this.oldTransitionState.type)}}class pi{constructor(t){S(this,"currentState");S(this,"serverState");S(this,"undoStack");S(this,"redoStack");this.undoStack=[],this.redoStack=[],this.currentState=et(Object.freeze(t)),this.serverState=et(Object.freeze(t))}apply(t){return this.currentState.value=t.apply(this.currentState.value),this.undoStack.push(t),this.redoStack=[],this.currentState.value}undo(){const t=this.undoStack.pop();if(t){const e=t.reverse();this.currentState.value=e.apply(this.currentState.value),this.redoStack.push(t)}return this.currentState.value}redo(){const t=this.redoStack.pop();return t&&(this.currentState.value=t.apply(this.currentState.value),this.undoStack.push(t)),this.currentState.value}getState(){return this.currentState.value}setServerState(t){this.serverState.value=t}getServerState(){return this.serverState.value}hasStageChanges(){return!F.exports.isEqual(this.currentState.value.stages,this.serverState.value.stages)}hasChanges(){const t={...this.currentState.value,stages:[...this.currentState.value.stages].sort((s,a)=>s.id.localeCompare(a.id)),transitions:[...this.currentState.value.transitions].sort((s,a)=>s.id.localeCompare(a.id))},e={...this.serverState.value,stages:[...this.serverState.value.stages].sort((s,a)=>s.id.localeCompare(a.id)),transitions:[...this.serverState.value.transitions].sort((s,a)=>s.id.localeCompare(a.id))};return!F.exports.isEqual(t,e)}stageHasChanges(t){const e=this.currentState.value.stages.find(a=>a.id===t),s=this.serverState.value.stages.find(a=>a.id===t);return!F.exports.isEqual(e,s)}stageHasNonPositionChanges(t){const e=this.currentState.value.stages.find(a=>a.id===t),s=this.serverState.value.stages.find(a=>a.id===t);return!F.exports.isEqual(F.exports.omit(e,"position"),F.exports.omit(s,"position"))}}class Ft{constructor(t,e){S(this,"api");S(this,"history");this.api=t,this.history=new pi(e)}static async create(){const t=new Fe,e=await t.load();return new Ft(t,e)}move(t){this.history.apply(new Rt(t))}revertTransition(t){this.history.apply(new Mt(t))}delete(t){const e=this.history.getState(),s=e.stages.filter(o=>t.includes(o.id)).map(o=>o.id),a=e.transitions.filter(o=>t.includes(o.id)).map(o=>o.id);this.history.apply(new hi(s,a))}addStages(t){return this.history.apply(new di(t.map(e=>{var s;return{...e,title:(s=e.title)!=null?s:`New ${e.type.slice(0,-1)}`}}))),this.history.getState().stages.slice(-t.length)}updateStageTitle(t,e){this.history.apply(new Ot(t,e))}updateStageProps(t,e){this.history.apply(new $t(t,e))}updateTransitionType(t,e){this.history.apply(new Vt(t,e))}updateTransitionProps(t,e){this.history.apply(new Kt(t,e))}duplicateStages(t){const e=this.history.getState(),s=this.history.apply(new ci(t));return{stages:s.stages.filter(a=>!e.stages.find(o=>o.id===a.id)),transitions:s.transitions.filter(a=>!e.transitions.find(o=>o.id===a.id))}}ensureTransitionWithType(t){var n;const e=this.getStage(t.sourceStageId);if(!e)throw new Error(`Source stage ${t.sourceStageId} not found`);const s=e.type,a=H.stages.find(d=>d.typeName===s),o=a==null?void 0:a.transitions[0].typeName;if(!o)throw new Error(`No default transition type for ${s}`);return{sourceStageId:t.sourceStageId,targetStageId:t.targetStageId,type:(n=t.type)!=null?n:o}}addTransitions(t){this.history.apply(new ui(t.map(e=>this.ensureTransitionWithType(e))))}changeTransitionType(t,e){const s=new Ht(t,e);this.history.apply(s)}renameStage(t,e){const s=new Gt(t,e);this.history.apply(s)}async reload(){const t=await this.api.load();return this.history.setServerState(t),t}hasChanges(){return this.history.hasChanges()}stageHasChanges(t){return this.history.stageHasChanges(t)}stageHasNonPositionChanges(t){return this.history.stageHasNonPositionChanges(t)}async hasBackendChanges(){const t=await this.api.load(),e=this.history.getServerState(),s={...e,stages:[...e.stages].sort((o,n)=>o.id.localeCompare(n.id)),transitions:[...e.transitions].sort((o,n)=>o.id.localeCompare(n.id))},a={...t,stages:[...t.stages].sort((o,n)=>o.id.localeCompare(n.id)),transitions:[...t.transitions].sort((o,n)=>o.id.localeCompare(n.id))};return!F.exports.isEqual(a,s)}async save(){if(this.history.hasChanges()){const t=await this.api.update(this.history.getState());this.history.setServerState(t)}}async forceSave(){const t=await this.api.update(this.history.getState());this.history.setServerState(t)}getStage(t){var e;return(e=this.history.getState().stages.find(s=>s.id===t))!=null?e:null}getTransition(t){var e;return(e=this.history.getState().transitions.find(s=>s.id===t))!=null?e:null}getState(){return this.history.getState()}}const gi={key:1,class:"workflow-editor"},mi={class:"workflow-toolbar"},Si=["onDragstart"],fi=W({__name:"WorkflowEditor",setup(i){const t=K(null),e=f(()=>{var n;return(n=t.value)==null?void 0:n.gui}),{result:s,loading:a}=Le(()=>Promise.all([Tt.get(),Ft.create()]).then(([n,d])=>({workspace:n,workflow:d}))),o=(n,d)=>{var l,u;(l=d.dataTransfer)==null||l.setData("type",n),(u=e.value)==null||u.dragstart(n,d)};return(n,d)=>{var l,u,m;return c(),y(B,null,[r(a)?(c(),v(ve,{key:0})):(c(),y("div",gi,[((l=r(s))==null?void 0:l.workflow)&&((u=r(s))==null?void 0:u.workspace)?(c(),v(li,{key:0,ref_key:"canvasGui",ref:t,model:r(s).workflow,workspace:r(s).workspace},null,8,["model","workspace"])):T("",!0),g(r(Y),null,{default:h(()=>{var P;return[_("div",mi,[(c(!0),y(B,null,tt(r(H).stages,C=>(c(),v(r(Ge),{key:C.typeName,placement:"top"},{title:h(()=>[g(r(pt),null,{default:h(()=>[g(r(E),null,{default:h(()=>[w(D(C.title),1)]),_:2},1024),g(r(E),{keyboard:""},{default:h(()=>[w(D(C.key),1)]),_:2},1024)]),_:2},1024)]),content:h(()=>[w(D(C.description),1)]),default:h(()=>[_("span",{draggable:"true",onDragstart:G=>o(C.typeName,G)},[(c(),v(Z(C.icon),{width:"18",height:"18",class:"toolbar-item"}))],40,Si)]),_:2},1024))),128)),g(r(Be),{type:"vertical"}),(P=r(s))!=null&&P.workflow?(c(),v(ye,{key:0,model:r(s).workflow,disabled:void 0,type:"primary"},null,8,["model"])):T("",!0)])]}),_:1})])),g(Ue,{"has-changes":(m=r(s))==null?void 0:m.workflow.hasChanges()},null,8,["has-changes"])],64)}}});const Xi=J(fi,[["__scopeId","data-v-5f9a6808"]]);export{Xi as default};
//# sourceMappingURL=WorkflowEditor.69281c14.js.map
