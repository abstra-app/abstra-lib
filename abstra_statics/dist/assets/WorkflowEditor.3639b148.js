var ft=Object.defineProperty;var vt=(t,e,a)=>e in t?ft(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var ke=(t,e,a)=>(vt(t,typeof e!="symbol"?e+"":e,a),a);import{g as ht,W as yt,w as mt}from"./controller.7cc675e0.js";import{o as ue,u as kt}from"./omniChatStore.e75391e4.js";import{a as Ee}from"./asyncComputed.25ef9b6f.js";import{d as N,af as J,g as x,o as l,K as k,O as j,F as S,e5 as be,a as M,e as wt,f as D,b as c,w as d,u as n,aL as G,ea as ge,c as w,da as Q,d5 as ae,az as T,eb as Z,d3 as We,ei as K,cH as _t,bM as he,Q as le,h as $e,bu as xe,aP as Ge,ec as Fe,N as ne,J as Ce,a8 as Pe,bE as ye,cs as we,cr as Re,cE as qe,eA as bt,B as de,ej as Ke,bs as $t,bq as Ze,bK as Ct,au as De,e3 as At,d2 as It,bH as Mt,eO as St,eP as xt,eo as Dt,aj as Et,ep as zt,eq as Ft}from"./index.b206749e.js";import{u as ee,P as Pt,_ as Tt,g as Je,a as Bt,b as Ht,c as fe,N as Lt,d as Vt,M as Nt,e as jt}from"./vue-flow-core.3a3c4574.js";import"./linters.685d7420.js";import{W as ve}from"./workspaces.8265e3ea.js";import{U as Ut,G as Zt}from"./UnsavedChangesHandler.1fe73ec7.js";import{w as _e,s as Ot}from"./metadata.4da44987.js";import{A as Yt}from"./index.cb506875.js";import{A as ze}from"./index.c5a1bef9.js";import{_ as Xt,a as Wt}from"./vue-flow-minimap.6ac95ccb.js";import{G as Gt}from"./PhArrowCounterClockwise.vue.9c8263d6.js";import{u as Rt,C as qt}from"./useCodebase.2959dbf9.js";import{T as Kt}from"./TasksManager.15820cab.js";import{n as Jt}from"./string.85c3fa28.js";import{a as Qt,b as ea,n as ta}from"./validations.bb82afdf.js";import{u as aa}from"./editor.6e737c3b.js";import"./index.a840e301.js";import{A as na}from"./index.f18f4c8a.js";import{t as Qe}from"./index.53ce869a.js";import{B as oa}from"./Badge.af487828.js";import{G as Oe}from"./PhArrowDown.vue.4b2b8c26.js";import"./uuid.2c1ecfa1.js";import"./record.4d42220b.js";import"./runnerData.d89a3126.js";import"./url.4ceef8c0.js";import"./colorHelpers.04ce44d3.js";import"./ExclamationCircleOutlined.d6b71cc0.js";import"./PhWebhooksLogo.vue.1b189475.js";import"./files.6977d443.js";import"./tasksController.ae5e1ee7.js";import"./gateway.1276fb48.js";import"./popupNotifcation.8dcf06ee.js";import"./scripts.f1d7a212.js";import"./polling.7167caed.js";import"./ant-design.5914d305.js";import"./PhArrowSquareOut.vue.5b92aa7e.js";import"./AbstraButton.vue_vue_type_script_setup_true_lang.f2a138eb.js";import"./Card.d349b35c.js";import"./TabPane.20cc8405.js";import"./CollapsePanel.e379cb4c.js";import"./userStore.992b13a9.js";import"./workspaceStore.f1a29afc.js";(function(){try{var t=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[e]="4c384e46-f005-41b8-8a6e-14332c175618",t._sentryDebugIdIdentifier="sentry-dbid-4c384e46-f005-41b8-8a6e-14332c175618")}catch{}})();const sa=["width","height","fill","transform"],la={key:0},ia=M("path",{d:"M244,56v48a12,12,0,0,1-12,12H184a12,12,0,1,1,0-24H201.1l-19-17.38c-.13-.12-.26-.24-.38-.37A76,76,0,1,0,127,204h1a75.53,75.53,0,0,0,52.15-20.72,12,12,0,0,1,16.49,17.45A99.45,99.45,0,0,1,128,228h-1.37A100,100,0,1,1,198.51,57.06L220,76.72V56a12,12,0,0,1,24,0Z"},null,-1),ra=[ia],ua={key:1},da=M("path",{d:"M216,128a88,88,0,1,1-88-88A88,88,0,0,1,216,128Z",opacity:"0.2"},null,-1),ca=M("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1,0-16H211.4L184.81,71.64l-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,0,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60L224,85.8V56a8,8,0,1,1,16,0Z"},null,-1),pa=[da,ca],ga={key:2},fa=M("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1-5.66-13.66l17-17-10.55-9.65-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,1,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60l10.93,10L226.34,50.3A8,8,0,0,1,240,56Z"},null,-1),va=[fa],ha={key:3},ya=M("path",{d:"M238,56v48a6,6,0,0,1-6,6H184a6,6,0,0,1,0-12h32.55l-30.38-27.8c-.06-.06-.12-.13-.19-.19a82,82,0,1,0-1.7,117.65,6,6,0,0,1,8.24,8.73A93.46,93.46,0,0,1,128,222h-1.28A94,94,0,1,1,194.37,61.4L226,90.35V56a6,6,0,1,1,12,0Z"},null,-1),ma=[ya],ka={key:4},wa=M("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1,0-16H211.4L184.81,71.64l-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,0,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60L224,85.8V56a8,8,0,1,1,16,0Z"},null,-1),_a=[wa],ba={key:5},$a=M("path",{d:"M236,56v48a4,4,0,0,1-4,4H184a4,4,0,0,1,0-8h37.7L187.53,68.69l-.13-.12a84,84,0,1,0-1.75,120.51,4,4,0,0,1,5.5,5.82A91.43,91.43,0,0,1,128,220h-1.26A92,92,0,1,1,193,62.84l35,32.05V56a4,4,0,1,1,8,0Z"},null,-1),Ca=[$a],Aa={name:"PhArrowClockwise"},Ia=N({...Aa,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(t){const e=t,a=J("weight","regular"),o=J("size","1em"),s=J("color","currentColor"),v=J("mirrored",!1),g=x(()=>{var i;return(i=e.weight)!=null?i:a}),_=x(()=>{var i;return(i=e.size)!=null?i:o}),y=x(()=>{var i;return(i=e.color)!=null?i:s}),u=x(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:v?"scale(-1, 1)":void 0);return(i,f)=>(l(),k("svg",be({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:_.value,height:_.value,fill:y.value,transform:u.value},i.$attrs),[j(i.$slots,"default"),g.value==="bold"?(l(),k("g",la,ra)):g.value==="duotone"?(l(),k("g",ua,pa)):g.value==="fill"?(l(),k("g",ga,va)):g.value==="light"?(l(),k("g",ha,ma)):g.value==="regular"?(l(),k("g",ka,_a)):g.value==="thin"?(l(),k("g",ba,Ca)):S("",!0)],16,sa))}}),Ma=["width","height","fill","transform"],Sa={key:0},xa=M("path",{d:"M234.29,47.91A20,20,0,0,0,216,36H40A20,20,0,0,0,25.2,69.45l.12.14L92,140.75V216a20,20,0,0,0,31.1,16.64l32-21.33A20,20,0,0,0,164,194.66V140.75l66.67-71.16.12-.14A20,20,0,0,0,234.29,47.91Zm-91,79.89A12,12,0,0,0,140,136v56.52l-24,16V136a12,12,0,0,0-3.25-8.2L49.23,60H206.77Z"},null,-1),Da=[xa],Ea={key:1},za=M("path",{d:"M221.9,61.38,152,136v58.65a8,8,0,0,1-3.56,6.66l-32,21.33A8,8,0,0,1,104,216V136L34.1,61.38A8,8,0,0,1,40,48H216A8,8,0,0,1,221.9,61.38Z",opacity:"0.2"},null,-1),Fa=M("path",{d:"M230.6,49.53A15.81,15.81,0,0,0,216,40H40A16,16,0,0,0,28.19,66.76l.08.09L96,139.17V216a16,16,0,0,0,24.87,13.32l32-21.34A16,16,0,0,0,160,194.66V139.17l67.74-72.32.08-.09A15.8,15.8,0,0,0,230.6,49.53ZM40,56h0Zm106.18,74.58A8,8,0,0,0,144,136v58.66L112,216V136a8,8,0,0,0-2.16-5.47L40,56H216Z"},null,-1),Pa=[za,Fa],Ta={key:2},Ba=M("path",{d:"M227.81,66.76l-.08.09L160,139.17v55.49A16,16,0,0,1,152.87,208l-32,21.34A16,16,0,0,1,96,216V139.17L28.27,66.85l-.08-.09A16,16,0,0,1,40,40H216a16,16,0,0,1,11.84,26.76Z"},null,-1),Ha=[Ba],La={key:3},Va=M("path",{d:"M228.77,50.34A13.8,13.8,0,0,0,216,42H40A14,14,0,0,0,29.67,65.42l.06.07L98,138.38V216a14,14,0,0,0,21.77,11.64l32-21.33A14,14,0,0,0,158,194.66V138.38l68.33-73A13.82,13.82,0,0,0,228.77,50.34Zm-11.26,6.94L147.62,131.9A6,6,0,0,0,146,136v58.66a2,2,0,0,1-.89,1.67l-32,21.33A2,2,0,0,1,110,216V136a6,6,0,0,0-1.62-4.1L38.53,57.32A2,2,0,0,1,40,54H216a1.9,1.9,0,0,1,1.83,1.19A1.86,1.86,0,0,1,217.51,57.28Z"},null,-1),Na=[Va],ja={key:4},Ua=M("path",{d:"M230.6,49.53A15.81,15.81,0,0,0,216,40H40A16,16,0,0,0,28.19,66.76l.08.09L96,139.17V216a16,16,0,0,0,24.87,13.32l32-21.34A16,16,0,0,0,160,194.66V139.17l67.74-72.32.08-.09A15.8,15.8,0,0,0,230.6,49.53ZM40,56h0Zm106.18,74.58A8,8,0,0,0,144,136v58.66L112,216V136a8,8,0,0,0-2.16-5.47L40,56H216Z"},null,-1),Za=[Ua],Oa={key:5},Ya=M("path",{d:"M227,51.15A11.85,11.85,0,0,0,216,44H40a12,12,0,0,0-8.88,20.07l.05.05L100,137.59V216a12,12,0,0,0,18.66,10l32-21.33a12,12,0,0,0,5.35-10V137.59l68.86-73.52A11.85,11.85,0,0,0,227,51.15Zm-8,7.5-69.9,74.62A4,4,0,0,0,148,136v58.65a4,4,0,0,1-1.78,3.33l-32,21.33A4,4,0,0,1,108,216V136a4,4,0,0,0-1.08-2.74L37.05,58.67A4,4,0,0,1,40,52H216a4,4,0,0,1,3,6.65Z"},null,-1),Xa=[Ya],Wa={name:"PhFunnel"},Ga=N({...Wa,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(t){const e=t,a=J("weight","regular"),o=J("size","1em"),s=J("color","currentColor"),v=J("mirrored",!1),g=x(()=>{var i;return(i=e.weight)!=null?i:a}),_=x(()=>{var i;return(i=e.size)!=null?i:o}),y=x(()=>{var i;return(i=e.color)!=null?i:s}),u=x(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:v?"scale(-1, 1)":void 0);return(i,f)=>(l(),k("svg",be({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:_.value,height:_.value,fill:y.value,transform:u.value},i.$attrs),[j(i.$slots,"default"),g.value==="bold"?(l(),k("g",Sa,Da)):g.value==="duotone"?(l(),k("g",Ea,Pa)):g.value==="fill"?(l(),k("g",Ta,Ha)):g.value==="light"?(l(),k("g",La,Na)):g.value==="regular"?(l(),k("g",ja,Za)):g.value==="thin"?(l(),k("g",Oa,Xa)):S("",!0)],16,Ma))}});class et{static get isMac(){return navigator.userAgent.includes("Mac OS X")}static get buildPlatform(){return{}.CURRENT_PLATFORM||"web"}}const R=t=>et.isMac?t.metaKey:t.ctrlKey,Ra=t=>t.shiftKey;class qa{async listConnections(){return(await fetch("/_editor/api/agents/connections")).json()}async getIsUsageMode(){const e=await fetch("/_editor/api/agents/is-usage-mode");try{return(await e.json()).is_usage_mode}catch{return!1}}}const Ye=new qa;class Ae{constructor(e){this.dto=e}static async listConnections(){return(await Ye.listConnections()).map(a=>new Ae(a))}static async getIsUsageMode(){return await Ye.getIsUsageMode()}get agentConnection(){return this.dto.agentConnection}get agent(){return this.dto.agent}}const tt=wt("agents-usage-mode",()=>{const t=D(!1);return(async()=>{t.value=await Ae.getIsUsageMode()})(),{agentUsageMode:t}}),Ka=["onDragstart"],Ja={style:{display:"flex","flex-direction":"column","max-width":"250px"}},Qa=N({__name:"BottomToolbar",props:{controller:{}},emits:["drag-start"],setup(t,{emit:e}){const a=tt(),o=x(()=>a.agentUsageMode?_e.stages:_e.stages.filter(s=>!["agents","clients"].includes(s.typeName)));return(s,v)=>(l(),k(G,null,[c(n(Q),{class:"toolbar",align:"center"},{default:d(()=>[(l(!0),k(G,null,ge(o.value,g=>(l(),w(n(_t),{key:g.key,placement:"top"},{title:d(()=>[c(n(Q),{gap:"small"},{default:d(()=>[c(n(ae),null,{default:d(()=>[T(Z(g.title),1)]),_:2},1024),c(n(ae),{keyboard:""},{default:d(()=>[T(Z(g.key),1)]),_:2},1024)]),_:2},1024)]),content:d(()=>[M("div",Ja,[c(n(ae),null,{default:d(()=>[T(Z(g.description),1)]),_:2},1024),g.beta?(l(),w(n(ze),{key:0,type:"warning",class:"beta-alert"},{description:d(()=>[c(n(ae),null,{default:d(()=>[T(" This is a beta feature, "),c(n(We),{href:"https://abstra.io/docs/concepts/agents/",target:"_blank"},{default:d(()=>[T(" click here ")]),_:1}),T(" to learn more about it ")]),_:1})]),_:1})):S("",!0)])]),default:d(()=>[M("div",{draggable:!0,class:"toolbar__item",onDragstart:_=>e("drag-start",_.dataTransfer,g.typeName)},[(l(),w(K(g.icon),{size:18}))],40,Ka)]),_:2},1024))),128)),c(n(Yt),{type:"vertical"}),c(n(he),{disabled:!s.controller.hasChanges(),onClick:v[0]||(v[0]=g=>s.controller.save())},{default:d(()=>[c(n(Q),{align:"center",gap:"small"},{default:d(()=>[c(n(Zt),{size:16}),T(" Save ")]),_:1})]),_:1},8,["disabled"])]),_:1}),c(Ut,{"has-changes":s.controller.hasChanges()},null,8,["has-changes"])],64))}});const en=le(Qa,[["__scopeId","data-v-d855dff0"]]);function at(){let t;const e={draggedType:D(null),isDragOver:D(!1),isAdding:D(!1),isDragging:D(!1),mousePosition:D(null)},{draggedType:a,isDragOver:o,isDragging:s,isAdding:v}=e,g=A=>{t=A,document.addEventListener("mousemove",b)},{screenToFlowCoordinate:_}=ee();$e(v,A=>{document.body.style.userSelect=A?"none":""});function y(A,H){v.value=!0,A?(A.setData("application/vueflow",H),A.effectAllowed="move",a.value=H,s.value=!0,document.addEventListener("drop",f)):(a.value=H,document.addEventListener("click",C))}function u(A){A.preventDefault(),a.value&&(o.value=!0,A.dataTransfer&&(A.dataTransfer.dropEffect="move"))}function i(){o.value=!1}function f(){v.value=!1,s.value=!1,o.value=!1,a.value=null,document.removeEventListener("drop",f)}function b(A){const H={x:A.pageX-200,y:A.pageY-80};e.mousePosition.value=H}function p(A){if(!a.value)throw new Error("No dragged type");return _({x:A.clientX-70,y:A.clientY-25})}function C(A){if(!t)return;if(!a.value)throw new Error("No dragged type");const H=p(A);t.addStages([{type:a.value,position:H}]),f()}function B(){document.removeEventListener("mousemove",b)}return{init:g,tearDown:B,draggedType:a,isDragOver:o,isAdding:v,isDragging:s,mousePosition:e.mousePosition,onDragStart:y,onDragLeave:i,onDragOver:u,onDrop:C}}const tn={name:"ControlButton",compatConfig:{MODE:3}},an=(t,e)=>{const a=t.__vccOpts||t;for(const[o,s]of e)a[o]=s;return a},nn={class:"vue-flow__controls-button"};function on(t,e,a,o,s,v){return l(),k("button",nn,[j(t.$slots,"default")])}const pe=an(tn,[["render",on]]),sn={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32"},ln=M("path",{d:"M32 18.133H18.133V32h-4.266V18.133H0v-4.266h13.867V0h4.266v13.867H32z"},null,-1),rn=[ln];function un(t,e){return l(),k("svg",sn,rn)}const dn={render:un},cn={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 5"},pn=M("path",{d:"M0 0h32v4.2H0z"},null,-1),gn=[pn];function fn(t,e){return l(),k("svg",cn,gn)}const vn={render:fn},hn={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 30"},yn=M("path",{d:"M3.692 4.63c0-.53.4-.938.939-.938h5.215V0H4.708C2.13 0 0 2.054 0 4.63v5.216h3.692V4.631zM27.354 0h-5.2v3.692h5.17c.53 0 .984.4.984.939v5.215H32V4.631A4.624 4.624 0 0 0 27.354 0zm.954 24.83c0 .532-.4.94-.939.94h-5.215v3.768h5.215c2.577 0 4.631-2.13 4.631-4.707v-5.139h-3.692v5.139zm-23.677.94a.919.919 0 0 1-.939-.94v-5.138H0v5.139c0 2.577 2.13 4.707 4.708 4.707h5.138V25.77H4.631z"},null,-1),mn=[yn];function kn(t,e){return l(),k("svg",hn,mn)}const wn={render:kn},_n={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},bn=M("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0 8 0 4.571 3.429 4.571 7.619v3.048H3.048A3.056 3.056 0 0 0 0 13.714v15.238A3.056 3.056 0 0 0 3.048 32h18.285a3.056 3.056 0 0 0 3.048-3.048V13.714a3.056 3.056 0 0 0-3.048-3.047zM12.19 24.533a3.056 3.056 0 0 1-3.047-3.047 3.056 3.056 0 0 1 3.047-3.048 3.056 3.056 0 0 1 3.048 3.048 3.056 3.056 0 0 1-3.048 3.047zm4.724-13.866H7.467V7.619c0-2.59 2.133-4.724 4.723-4.724 2.591 0 4.724 2.133 4.724 4.724v3.048z"},null,-1),$n=[bn];function Cn(t,e){return l(),k("svg",_n,$n)}const An={render:Cn},In={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},Mn=M("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0c-4.114 1.828-1.37 2.133.305 2.438 1.676.305 4.42 2.59 4.42 5.181v3.048H3.047A3.056 3.056 0 0 0 0 13.714v15.238A3.056 3.056 0 0 0 3.048 32h18.285a3.056 3.056 0 0 0 3.048-3.048V13.714a3.056 3.056 0 0 0-3.048-3.047zM12.19 24.533a3.056 3.056 0 0 1-3.047-3.047 3.056 3.056 0 0 1 3.047-3.048 3.056 3.056 0 0 1 3.048 3.048 3.056 3.056 0 0 1-3.048 3.047z"},null,-1),Sn=[Mn];function xn(t,e){return l(),k("svg",In,Sn)}const Dn={render:xn},En={name:"Controls",compatConfig:{MODE:3}},zn=N({...En,props:{showZoom:{type:Boolean,default:!0},showFitView:{type:Boolean,default:!0},showInteractive:{type:Boolean,default:!0},fitViewParams:{},position:{default:()=>Pt.BottomLeft}},emits:["zoomIn","zoomOut","fitView","interactionChange"],setup(t,{emit:e}){const{nodesDraggable:a,nodesConnectable:o,elementsSelectable:s,setInteractive:v,zoomIn:g,zoomOut:_,fitView:y,viewport:u,minZoom:i,maxZoom:f}=ee(),b=xe(()=>a.value||o.value||s.value),p=xe(()=>u.value.zoom<=i.value),C=xe(()=>u.value.zoom>=f.value);function B(){g(),e("zoomIn")}function A(){_(),e("zoomOut")}function H(){y(t.fitViewParams),e("fitView")}function L(){v(!b.value),e("interactionChange",!b.value)}return(I,E)=>(l(),w(n(Tt),{class:"vue-flow__controls",position:I.position},{default:d(()=>[j(I.$slots,"top"),I.showZoom?(l(),k(G,{key:0},[j(I.$slots,"control-zoom-in",{},()=>[c(pe,{class:"vue-flow__controls-zoomin",disabled:C.value,onClick:B},{default:d(()=>[j(I.$slots,"icon-zoom-in",{},()=>[(l(),w(K(n(dn))))])]),_:3},8,["disabled"])]),j(I.$slots,"control-zoom-out",{},()=>[c(pe,{class:"vue-flow__controls-zoomout",disabled:p.value,onClick:A},{default:d(()=>[j(I.$slots,"icon-zoom-out",{},()=>[(l(),w(K(n(vn))))])]),_:3},8,["disabled"])])],64)):S("",!0),I.showFitView?j(I.$slots,"control-fit-view",{key:1},()=>[c(pe,{class:"vue-flow__controls-fitview",onClick:H},{default:d(()=>[j(I.$slots,"icon-fit-view",{},()=>[(l(),w(K(n(wn))))])]),_:3})]):S("",!0),I.showInteractive?j(I.$slots,"control-interactive",{key:2},()=>[I.showInteractive?(l(),w(pe,{key:0,class:"vue-flow__controls-interactive",onClick:L},{default:d(()=>[b.value?j(I.$slots,"icon-unlock",{key:0},()=>[(l(),w(K(n(Dn))))]):S("",!0),b.value?S("",!0):j(I.$slots,"icon-lock",{key:1},()=>[(l(),w(K(n(An))))])]),_:3})):S("",!0)]):S("",!0),j(I.$slots,"default")]),_:3},8,["position"]))}}),Fn=N({__name:"ControlButtons",props:{workflow:{}},setup(t){return(e,a)=>(l(),w(n(zn),{position:"top-left","show-interactive":!1},{default:d(()=>[c(n(pe),{title:"Undo",disabled:!e.workflow.history.canUndo(),onClick:a[0]||(a[0]=o=>e.workflow.history.undo())},{default:d(()=>[c(n(Gt))]),_:1},8,["disabled"]),c(n(pe),{title:"Redo",disabled:!e.workflow.history.canRedo(),onClick:a[1]||(a[1]=o=>e.workflow.history.redo())},{default:d(()=>[c(n(Ia))]),_:1},8,["disabled"])]),_:1}))}});class Y{constructor(e){ke(this,"angle");e=Y.normalize(e),this.angle=e}static normalize(e){const a=Math.PI;return((e+a)%(2*a)+2*a)%(2*a)-a}static fromRadians(e){return new Y(Y.normalize(e))}static fromDegrees(e){const a=e*Math.PI/180;return new Y(a)}static fromPoints(e,a){const o=a.x-e.x,s=a.y-e.y,v=Math.atan2(s,o);return new Y(v)}get degrees(){return this.angle*180/Math.PI}get radians(){return this.angle}get isZero(){return this.angle===0}get isPositive(){return this.angle>0}get complementary(){return new Y(Math.PI/2-this.angle)}get perpendicular(){return new Y(Math.PI/2+this.angle)}get sin(){return Math.sin(this.angle)}get cos(){return Math.cos(this.angle)}divide(e){if(e===0)throw new Error("Division by zero is not allowed");return new Y(this.angle/e)}multiply(e){return new Y(this.angle*e)}}class q{constructor(e,a){ke(this,"dx");ke(this,"dy");this.dx=e,this.dy=a}static fromPoints(e,a){const o=a.x-e.x,s=a.y-e.y;return new q(o,s)}static fromAngleAndLength(e,a){const o=a*e.cos,s=a*e.sin;return new q(o,s)}get x(){return this.dx}get y(){return this.dy}get length(){return Math.sqrt(this.dx*this.dx+this.dy*this.dy)}get m(){return this.dy/this.dx}get opposite(){return new q(-this.dx,-this.dy)}divide(e){if(e===0)throw new Error("Division by zero is not allowed");return new q(this.dx/e,this.dy/e)}add(e){return new q(this.dx+e.dx,this.dy+e.dy)}subtract(e){return new q(this.dx-e.dx,this.dy-e.dy)}}function Pn(t,e,a=1e-10){const o=e.center.x-e.width/2,s=e.center.x+e.width/2,v=e.center.y-e.height/2,g=e.center.y+e.height/2;return t.x>=o-a&&t.x<=s+a&&t.y>=v-a&&t.y<=g+a}function Xe(t,e,a,o=1e-10){const s=a.center.x-a.width/2,v=a.center.x+a.width/2,g=a.center.y-a.height/2,_=a.center.y+a.height/2,y=e.x-t.x,u=e.y-t.y;let i=1/0,f=null;if(Pn(t,a,o))return null;if(Math.abs(y)>o){const b=(s-t.x)/y;if(b>0&&b<i){const p=t.y+b*u;p>=g-o&&p<=_+o&&(i=b,f={x:s,y:p})}}if(Math.abs(y)>o){const b=(v-t.x)/y;if(b>0&&b<i){const p=t.y+b*u;p>=g-o&&p<=_+o&&(i=b,f={x:v,y:p})}}if(Math.abs(u)>o){const b=(g-t.y)/u;if(b>0&&b<i){const p=t.x+b*y;p>=s-o&&p<=v+o&&(i=b,f={x:p,y:g})}}if(Math.abs(u)>o){const b=(_-t.y)/u;if(b>0&&b<i){const p=t.x+b*y;p>=s-o&&p<=v+o&&(i=b,f={x:p,y:_})}}return f}function Tn(t,e,a=0,o=0){a=Math.abs(a),t.height+=a*2,t.width+=a*2,e.height+=a*2,e.width+=a*2;const s=Y.fromPoints(t.center,e.center),v=o*s.perpendicular.cos,g=o*s.perpendicular.sin,_={x:t.center.x+v,y:t.center.y+g},y={x:e.center.x+v,y:e.center.y+g};let u=Xe(_,y,e);u||(u=e.center);let i=Xe(y,_,t);return i||(i=t.center),{sourceX:i.x,sourceY:i.y,targetX:u.x,targetY:u.y}}function Bn(t,e=0){const a=Y.fromPoints({x:t.sourceX,y:t.sourceY},{x:t.targetX,y:t.targetY}),o=Math.sqrt(Math.pow(t.targetX-t.sourceX,2)+Math.pow(t.targetY-t.sourceY,2)),s=Y.fromRadians(Math.atan(2*e/o)).multiply(4),v=o/2/s.divide(2).sin,g=new q(t.sourceX+t.targetX,t.sourceY+t.targetY).divide(2),_=v*(1+(s.isPositive?-1:1)*s.divide(2).cos),y=q.fromAngleAndLength(a.perpendicular,_),u=e>0===s.isPositive?g.add(y):g.subtract(y);return{sourceX:t.sourceX,sourceY:t.sourceY,targetX:t.targetX,targetY:t.targetY,labelX:u.x,labelY:u.y,radius:v,largeArcFlag:s.isPositive?0:1,sweepFlag:0}}function nt(t,e,a=0,o=0){const v={center:{x:t.computedPosition.x+t.dimensions.width/2,y:t.computedPosition.y+t.dimensions.height/2},width:t.dimensions.width,height:t.dimensions.height},_={center:{x:e.computedPosition.x+e.dimensions.width/2,y:e.computedPosition.y+e.dimensions.height/2},width:e.dimensions.width,height:e.dimensions.height};return Tn(v,_,a,o)}function ot(t,e,a=0){return nt(t,e,10,a)}function Hn(t,e,a=0){a=Math.abs(a);const o=ot(t,e,a/2);if(a===0)return Je(o);const s=Bn(o,a);return[`M${s.sourceX},${s.sourceY} A${s.radius},${s.radius} 0 ${s.largeArcFlag},${s.sweepFlag} ${s.targetX},${s.targetY}`,s.labelX,s.labelY,0,0]}const Ln=N({__name:"TaskMenu",props:{isConnecting:{type:Boolean},isEditing:{type:Boolean},menuOptions:{}},setup(t){return(e,a)=>(l(),w(n(Q),{vertical:"",gap:"small",style:ne({marginBottom:`-${16*e.menuOptions.length}%`})},{default:d(()=>[(l(!0),k(G,null,ge(e.menuOptions,o=>(l(),w(n(Ge),{key:o.label,title:o.tooltip,placement:"right"},{default:d(()=>[c(n(he),{class:Fe([{"warning-button":o.warning}]),disabled:o.disabled,style:ne({backgroundColor:o.disabled?"#f5f5f5":void 0}),onClick:s=>o.click(s)},{default:d(()=>[c(n(Q),{gap:"small",style:{width:"100%"},justify:"space-between",align:"center"},{default:d(()=>[T(Z(o.label)+" ",1),o.key?(l(),w(n(ae),{key:0,keyboard:"",disabled:o.disabled},{default:d(()=>[T(Z(o.key),1)]),_:2},1032,["disabled"])):S("",!0)]),_:2},1024)]),_:2},1032,["class","disabled","style","onClick"])]),_:2},1032,["title"]))),128))]),_:1},8,["style"]))}});const Vn=N({__name:"TaskEdge",props:{id:{},sourceNode:{},targetNode:{},source:{},target:{},type:{},label:{type:[String,Object,Function]},style:{},selected:{type:Boolean},sourcePosition:{},targetPosition:{},sourceHandleId:{},targetHandleId:{},animated:{type:Boolean},updatable:{type:Boolean},markerStart:{},markerEnd:{},curvature:{},interactionWidth:{},data:{},events:{},labelStyle:{},labelShowBg:{type:Boolean},labelBgStyle:{},labelBgPadding:{},labelBgBorderRadius:{},sourceX:{},sourceY:{},targetX:{},targetY:{},controller:{}},setup(t){const e=t,a=[{label:"Edit task type",key:"E",click:()=>s.value="editing"},{label:"Delete",key:"Del",click:()=>b(e.data.id)}],o=D(e.data.props.taskType||""),s=D("idle"),v=()=>{s.value!=="idle"&&(o.value!==e.data.props.taskType&&e.controller.updateTransitionProps(e.data.id,{taskType:o.value}),s.value="idle")},{onEdgeClick:g,onPaneClick:_,getSelectedEdges:y}=ee();g(p=>{p.edge.id===e.id&&s.value==="idle"&&(s.value="selected")}),_(()=>v());const u=x(()=>e.controller.edgeIsLonely(e.id)?0:20),i=x(()=>Hn(e.sourceNode,e.targetNode,u.value)),f=p=>{if(!!y.value.map(C=>C.id).includes(e.data.id)&&(p.key==="Enter"&&v(),(p.key==="e"||p.key==="E")&&(s.value="editing"),p.key==="Backspace"||p.key==="Delete")){if(s.value==="editing")return;b(e.data.id)}},{removeEdges:b}=ee();return Ce(()=>window.addEventListener("keydown",f)),Pe(()=>window.removeEventListener("keydown",f)),(p,C)=>(l(),k(G,null,[c(n(Bt),{path:i.value[0],"marker-end":p.markerEnd},null,8,["path","marker-end"]),c(n(Ht),null,{default:d(()=>[s.value==="idle"?(l(),k("div",{key:0,style:ne({transform:`translate(-50%, -50%) translate(${i.value[1]}px,${i.value[2]}px)`}),class:"nodrag nopan edge-label"},[e.data.props.taskType?(l(),w(n(ae),{key:1},{default:d(()=>[T(Z(e.data.props.taskType),1)]),_:1})):(l(),w(n(Ga),{key:0,size:16}))],4)):s.value==="selected"?(l(),k("div",{key:1,style:ne({transform:`translate(-50%, -120%) translate(${i.value[1]}px,${i.value[2]}px)`}),class:"nodrag nopan edge-input-container"},[c(Ln,{"is-connecting":!0,"is-editing":!0,"menu-options":a})],4)):s.value==="editing"?(l(),k("div",{key:2,style:ne({transform:`translate(-50%, -50%) translate(${i.value[1]}px,${i.value[2]}px)`}),class:"nodrag nopan edge-input-container"},[c(n(ye),{value:o.value,"onUpdate:value":C[0]||(C[0]=B=>o.value=B),placeholder:"Task type"},null,8,["value"])],4)):S("",!0)]),_:1})],64))}});const Nn=le(Vn,[["__scopeId","data-v-dd919c09"]]),jn={key:0},Un=M("defs",null,[M("marker",{id:"arrowhead",markerWidth:"8",markerHeight:"8",refX:"0",refY:"4",orient:"auto",markerUnits:"strokeWidth"},[M("path",{d:"M0,0 L8,4 L0,8",fill:"none",stroke:"#222","stroke-width":"1"})])],-1),Zn=["d"],On=N({__name:"LineFloating",props:{targetX:{},targetY:{},sourcePosition:{},targetPosition:{},sourceNode:{}},setup(t){const e=t,a=D(!0),{onNodeMouseEnter:o,onNodeMouseLeave:s}=ee();o(y=>{y.node.id===e.sourceNode.id&&(a.value=!1)}),s(y=>{y.node.id===e.sourceNode.id&&(a.value=!0)});const v=x(()=>({id:"connection-target",computedPosition:{x:e.targetX,y:e.targetY},dimensions:{width:1,height:1}})),g=x(()=>ot(e.sourceNode,v.value)),_=x(()=>Je(g.value));return(y,u)=>a.value?(l(),k("g",jn,[Un,M("path",{fill:"none",stroke:"#222","stroke-width":1,class:"animated",d:_.value[0],"marker-end":"url(#arrowhead)"},null,8,Zn)])):S("",!0)}}),Yn=N({__name:"CreateStageFile",props:{filename:{},creatingFileStatus:{},fileExists:{type:Boolean}},emits:["create-file","cancel","update-filename"],setup(t,{emit:e}){const a=t,o=x(()=>{const s=Qt(a.filename);return s.valid?a.fileExists?{valid:!0,help:"This file already exists, stage will point to it."}:{valid:!0,help:"File doesn't exist yet. It will be created."}:s});return(s,v)=>(l(),w(n(qe),{open:s.creatingFileStatus==="prompting"||s.creatingFileStatus==="creating",closable:!1,"confirm-loading":s.creatingFileStatus==="creating",onOk:v[1]||(v[1]=g=>e("create-file",s.filename)),onCancel:v[2]||(v[2]=g=>e("cancel"))},{default:d(()=>[c(n(Re),{layout:"vertical",disabled:s.creatingFileStatus=="creating"},{default:d(()=>[c(n(we),{label:"You're creating a new file. What should it be called?","validate-status":o.value.valid?"success":"error",help:o.value.valid?o.value.help:o.value.reason},{default:d(()=>[c(n(ye),{value:s.filename,onChange:v[0]||(v[0]=g=>e("update-filename",g.target.value||""))},null,8,["value"])]),_:1},8,["validate-status","help"])]),_:1},8,["disabled"])]),_:1},8,["open","confirm-loading"]))}}),Xn={name:"NodeToolbar",compatConfig:{MODE:3},inheritAttrs:!1},Wn=N({...Xn,props:{nodeId:null,isVisible:{type:Boolean},position:{default:fe.Top},offset:{default:10},align:{default:"center"}},setup(t){const e=t,a=J(Lt,null),{viewportRef:o,viewport:s,getSelectedNodes:v,findNode:g}=ee();function _(p,C,B,A,H){let L=.5;H==="start"?L=0:H==="end"&&(L=1);let I=[(p.x+p.width*L)*C.zoom+C.x,p.y*C.zoom+C.y-A],E=[-100*L,-100];switch(B){case fe.Right:I=[(p.x+p.width)*C.zoom+C.x+A,(p.y+p.height*L)*C.zoom+C.y],E=[0,-100*L];break;case fe.Bottom:I[1]=(p.y+p.height)*C.zoom+C.y+A,E[1]=0;break;case fe.Left:I=[p.x*C.zoom+C.x-A,(p.y+p.height*L)*C.zoom+C.y],E=[-100,-100*L];break}return`translate(${I[0]}px, ${I[1]}px) translate(${E[0]}%, ${E[1]}%)`}const y=x(()=>(Array.isArray(e.nodeId)?e.nodeId:[e.nodeId||a||""]).reduce((p,C)=>{const B=g(C);return B&&p.push(B),p},[])),u=x(()=>typeof e.isVisible=="boolean"?e.isVisible:y.value.length===1&&y.value[0].selected&&v.value.length===1),i=x(()=>Vt(y.value)),f=x(()=>Math.max(...y.value.map(p=>(p.computedPosition.z||1)+1))),b=x(()=>({position:"absolute",transform:_(i.value,s.value,e.position,e.offset,e.align),zIndex:f.value}));return(p,C)=>(l(),w(bt,{to:n(o),disabled:!n(o)},[n(u)&&n(y).length?(l(),k("div",be({key:0},p.$attrs,{style:n(b),class:"vue-flow__node-toolbar"}),[j(p.$slots,"default")],16)):S("",!0)],8,["to","disabled"]))}}),Gn=N({__name:"NodeMenu",props:{isConnecting:{type:Boolean},isEditing:{type:Boolean},menuOptions:{}},setup(t){return(e,a)=>(l(),w(n(Wn),{"is-visible":e.isConnecting||e.isEditing?!1:void 0,position:n(fe).Right},{default:d(()=>[c(n(Q),{vertical:"",gap:"small",style:ne({marginBottom:`-${16*e.menuOptions.length}%`})},{default:d(()=>[(l(!0),k(G,null,ge(e.menuOptions,o=>(l(),w(n(Ge),{key:o.label,title:o.tooltip,placement:"right"},{default:d(()=>[c(n(he),{class:Fe([{"warning-button":o.warning}]),disabled:o.disabled,style:ne({backgroundColor:o.disabled?"#f5f5f5":void 0,width:"100%"}),onClick:s=>o.click(s)},{default:d(()=>[c(n(Q),{gap:"small",style:{width:"100%"},justify:"space-between",align:"center"},{default:d(()=>[T(Z(o.label)+" ",1),o.key?(l(),w(n(ae),{key:0,keyboard:"",disabled:o.disabled},{default:d(()=>[T(Z(o.key),1)]),_:2},1032,["disabled"])):S("",!0)]),_:2},1024)]),_:2},1032,["class","disabled","style","onClick"])]),_:2},1032,["title"]))),128))]),_:1},8,["style"])]),_:1},8,["is-visible","position"]))}});const Rn=N({__name:"AgentItems",props:{stageProps:{}},emits:["update:stage-props"],setup(t,{emit:e}){var W;const a=t,o=D(!1),v=tt().agentUsageMode,g=de.object({title:de.string(),clientStageId:de.string().uuid(),inputSchemas:de.any(),outputSchemas:de.any()});$e(()=>a.stageProps.projectId,()=>{o.value=!0,I()});const _=aa(),y=()=>{var F;const $=(F=_.cloudProject)==null?void 0:F.id;return $?`https://cloud.abstra.io/projects/${$}/agents`:""},u=de.array(g),i=D((W=a.stageProps.projectId)!=null?W:""),f=D(!1),b=$=>p.loading.value||!p.result.value?null:p.result.value.find(F=>F.agentConnection.id===$),p=Ee(async()=>Ae.listConnections()),C=x(()=>p.loading.value||!p.result.value?[]:p.result.value.map($=>({label:$.agentConnection.connectionName,key:$.agentConnection.id,value:$.agent.projectId}))),{result:B,loading:A,refetch:H,error:L}=Ee(async()=>{const $=a.stageProps.projectId;if(!$)return[];const O=await(await fetch(`/_editor/api/services/roles/client/entrypoints/${$}`)).json();return u.parse(O)}),I=Ke.exports.debounce(()=>{o.value=!1,H()},500),E=x(()=>A.value||!B.value?[]:B.value.map($=>({label:$.title,value:$.clientStageId})));function U($){e("update:stage-props",{...a.stageProps,projectId:$,clientStageId:null})}function ie($){const F=b($.key);!F||(U(F.agent.projectId),i.value=F.agent.projectId,f.value=!1)}function m($){const F=$.target;i.value=F.value,U(F.value),f.value=!0}function z($){f.value=$}function P($){const F=String($);!B.value||e("update:stage-props",{...a.stageProps,clientStageId:F})}return($,F)=>(l(),k(G,null,[c(n(we),{label:"Project ID"},{default:d(()=>{var O;return[n(v)?(l(),w(n(Ct),{key:0,trigger:"click",visible:f.value,onVisibleChange:z},{overlay:d(()=>[c(n($t),{onClick:ie},{default:d(()=>[(l(!0),k(G,null,ge(C.value,te=>(l(),w(n(Ze),{key:te.key},{default:d(()=>[T(Z(te.label),1)]),_:2},1024))),128)),c(n(Ze),null,{default:d(()=>[c(n(We),{class:"cloud-link",href:y(),target:"_blank"},{default:d(()=>[T(" Connect to Agents ")]),_:1},8,["href"])]),_:1})]),_:1})]),default:d(()=>[c(n(ye),{value:i.value,"onUpdate:value":F[0]||(F[0]=te=>i.value=te),autofocus:"","allow-clear":"",onInput:m},null,8,["value"])]),_:1},8,["visible"])):(l(),w(n(ye),{key:1,value:(O=$.stageProps.projectId)!=null?O:"",placeholder:"Project ID",autofocus:"","onUpdate:value":U},null,8,["value"]))]}),_:1}),c(n(we),{label:"Client entrypoint"},{default:d(()=>{var O;return[o.value||n(A)?(l(),w(n(De),{key:0,disabled:"",loading:""})):n(L)?(l(),w(n(ze),{key:1,type:"error",message:"Invalid project id"})):$.stageProps.projectId?n(B).length===0?(l(),w(n(ze),{key:3,type:"warning",message:"The project has no entrypoints"})):(l(),w(n(De),{key:4,class:"entrypoint-select",options:E.value,value:(O=$.stageProps.clientStageId)!=null?O:void 0,"onUpdate:value":P},null,8,["options","value"])):(l(),w(n(De),{key:2,disabled:""}))]}),_:1})],64))}});const qn=le(Rn,[["__scopeId","data-v-f4d2a34d"]]),Kn=N({__name:"StageNode",props:{stage:{},node:{},initialFileCheck:{type:Boolean},controller:{}},setup(t){var Ue;const e=t,{useToken:a}=Qe,o=At(),{token:s}=a(),v=s.value.colorText,g=[{label:"Add transition",key:"C",click:r=>He(r)},{label:"Rename",key:"R",click:()=>X.value=!0},{label:"Go to editor",key:"Enter",click:()=>Be()},{label:"Tasks",key:"M",click:()=>y.value=!0},{label:"Delete",key:"Del",click:()=>i.value=!0}],_=x(()=>{let r=[...g];return u.value||r.unshift({label:"Create missing file",warning:!0,click:()=>z()}),e.controller.hasChanges()&&(r=r.map(h=>h.label==="Go to editor"?{...h,disabled:!0,tooltip:"Save it to allow editing"}:h.label==="Tasks"?{...h,disabled:!0,tooltip:"Save it to allow managing tasks"}:h)),(e.stage.type==="agents"||e.stage.type==="clients")&&(r=r.filter(h=>!["Create missing file","Go to editor","Tasks"].includes(h.label))),e.stage.type==="agents"&&(r=r.map(h=>h.label==="Rename"?{...h,label:"Edit"}:h)),r}),y=D(!1),u=D(!0);$e(()=>e.initialFileCheck,r=>{L.value||(u.value=r)});const i=D(!1),f=()=>{i.value=!1,te(e.stage)},b=new qt,{deleteFile:p}=Rt({api:b,router:o}),C=async()=>{if(i.value=!1,"filename"in e.stage.props&&e.stage.props.filename){const r=e.stage.props.filename;(await ve.checkFile(r)).exists&&await p([r])}te(e.stage)},B=r=>{E.value=r,I()},A=r=>{e.controller.updateStageProps(e.stage.id,r)},H=()=>{var r;U.value="idle",(e.stage.type==="forms"||e.stage.type==="jobs"||e.stage.type==="hooks"||e.stage.type==="scripts")&&(E.value=(r=e.stage.props.filename)!=null?r:"",I())},L=x(()=>e.controller.getUnsavedFilenameStages().some(r=>r.id===e.stage.id)),I=Ke.exports.debounce(async()=>{if(L.value){u.value=!0;return}const r=E.value;if(!r){u.value=!0;return}ve.checkFile(r).then(h=>{u.value=h.exists})},500),E=D((e.stage.type==="forms"||e.stage.type==="hooks"||e.stage.type==="scripts"||e.stage.type==="jobs")&&(Ue=e.stage.props.filename)!=null?Ue:""),U=D("idle"),ie=async()=>{U.value="creating",await ve.initFile(E.value,e.stage.type),u.value=!0;const r=await ve.checkFile(E.value);if(u.value=r.exists,U.value="idle",e.stage.type==="forms"||e.stage.type==="hooks")e.controller.updateStageProps(e.stage.id,{path:e.stage.props.path,filename:E.value});else if(e.stage.type==="scripts"||e.stage.type==="jobs")e.controller.updateStageProps(e.stage.id,{filename:E.value});else throw new Error(`Invalid stage type: ${e.stage.type}`)},m=x(()=>["forms","hooks","scripts","jobs"].includes(e.stage.type)?!u.value:e.stage.type==="agents"?!e.stage.props.clientStageId||!e.stage.props.projectId:!1),z=()=>{U.value="prompting"},{startConnection:P,updateConnection:W,onNodeClick:$,addEdges:F,endConnection:O,removeNodes:te,onPaneClick:lt,getSelectedNodes:it,flowToScreenCoordinate:Te,onNodeMouseEnter:rt,onNodeMouseLeave:ut,getNodes:dt,onNodesChange:ct,applyNodeChanges:pt}=ee(),oe=D(!1),X=D(!1),se=D(e.stage.title),Ie=D(!0),me=x(()=>{const h=`${e.stage.type==="scripts"?"tasklet":e.stage.type.slice(0,-1)}_${Jt(se.value,!1,!0)}.py`;return h!==E.value?h:null}),Me=D(!1),Se=D(!1);ct(async r=>{var V;const h=[];for(const re of r)re.type==="remove"?X.value||((V=e.controller)==null||V.delete([re.id]),h.push(re)):h.push(re);pt(h)});const Be=()=>{const r=e.stage.type==="scripts"?"tasklet":e.stage.type.slice(0,-1);Se.value?window.open(`/_editor/${r}/${e.stage.id}`,"_blank"):o.push({path:`/_editor/${r}/${e.stage.id}`})},He=(r,h=!0)=>{P({nodeId:e.stage.id,type:"source",handleId:e.stage.id},{x:h?r.pageX:r.pageX-90,y:h?r.pageY-50:r.pageY-20}),document.addEventListener("mousemove",Le),oe.value=!0},Le=r=>{oe.value&&!Me.value&&W({x:r.pageX,y:r.pageY-52})};$(r=>{if(r.node.id===e.stage.id&&I(),oe.value&&r.node.id!==e.stage.id){const h={sourceStageId:e.stage.id,targetStageId:r.node.id,type:"task",id:ht(),props:{taskType:null}};try{e.controller.connect([h]),document.removeEventListener("mousemove",Le),F({id:h.id,source:e.stage.id,target:r.node.id,type:"task",markerEnd:{type:Nt.Arrow,width:24,height:24},data:h}),O(),oe.value=!1}catch(V){console.error(V)}}}),rt(r=>{if(oe.value&&r.node.id!==e.stage.id){Me.value=!0;const h=dt.value.find(re=>re.id===e.stage.id);if(!h)return;const V=nt(h,r.node,10);W(Te({x:V.targetX,y:V.targetY-52}))}}),ut(()=>{Me.value=!1});const gt=()=>{if(!u.value){const r=ea(se.value+".py");E.value=r;let h={filename:r,path:null};if(["forms","hooks"].includes(e.stage.type)){const V=ta(se.value);h={...h,path:V}}e.controller.updateStageProps(e.stage.id,h)}},Ve=async()=>{e.stage.title!==se.value&&(e.controller.updateStageTitle(e.stage.id,se.value),Ie.value&&me.value&&(E.value=me.value,e.controller.updateStageProps(e.stage.id,{...e.stage.props,filename:E.value})),gt()),I()};lt(()=>{X.value&&Ve(),X.value=!1,oe.value=!1,O()});const Ne=r=>{if(Se.value=R(r),!!it.value.map(h=>h.id).includes(e.stage.id)&&U.value==="idle"){if(r.key==="Enter")if(X.value)X.value=!1,Ve();else{if(e.controller.hasChanges()||e.stage.type==="agents"||e.stage.type==="clients")return;Be()}if(!X.value){if(r.key==="c"||r.key==="C"){const h=Te(e.stage.position);He({pageX:h.x,pageY:h.y},!1)}if((r.key==="r"||r.key==="R")&&(X.value=!0),r.key==="m"||r.key==="M"){if(e.controller.hasChanges())return;y.value=!0}(r.key==="Backspace"||r.key==="Delete")&&("filename"in e.stage.props&&e.stage.props.filename?i.value=!0:te(e.stage))}}},je=r=>{Se.value=R(r)};return Ce(()=>{L.value||(u.value=e.initialFileCheck),window.addEventListener("keydown",Ne),window.addEventListener("keyup",je)}),Pe(()=>{window.removeEventListener("keydown",Ne),window.removeEventListener("keyup",je)}),(r,h)=>(l(),k(G,null,[c(Gn,{"is-connecting":oe.value,"is-editing":X.value,"menu-options":_.value},null,8,["is-connecting","is-editing","menu-options"]),c(n(qe),{open:i.value,title:"Delete file"},{footer:d(()=>[c(n(Q),{justify:"space-between",gap:"small"},{default:d(()=>[c(n(he),{onClick:f},{default:d(()=>[T("Delete only stage")]),_:1}),c(n(he),{type:"primary",danger:"",onClick:C},{default:d(()=>[T("Yes, delete file")]),_:1})]),_:1})]),default:d(()=>[T(" Do you also want to delete the file associated with the stage "+Z(r.stage.title)+"? ",1)]),_:1},8,["open"]),M("div",{class:"stage",onDblclick:h[2]||(h[2]=V=>X.value=!0)},[c(n(Q),{vertical:X.value,class:"point",gap:"small",align:"center",style:{padding:"4px 0"}},{default:d(()=>[(l(),w(K(n(Ot)(r.stage.type)),{size:18,color:n(v)},null,8,["color"])),X.value?(l(),w(n(Re),{key:1,layout:"vertical"},{default:d(()=>[c(n(we),{label:"Title"},{default:d(()=>[c(n(ye),{value:se.value,"onUpdate:value":h[0]||(h[0]=V=>se.value=V),class:"nodrag nopan",autofocus:""},null,8,["value"])]),_:1}),me.value?(l(),w(n(Mt),{key:0,checked:Ie.value,"onUpdate:checked":h[1]||(h[1]=V=>Ie.value=V),style:{"margin-bottom":"12px"}},{default:d(()=>[T(" Update filename to "),c(n(ae),{code:""},{default:d(()=>[T(Z(me.value),1)]),_:1})]),_:1},8,["checked"])):S("",!0),r.stage.type==="agents"?(l(),w(qn,{key:1,"stage-props":r.stage.props,"onUpdate:stageProps":A},null,8,["stage-props"])):S("",!0)]),_:1})):(l(),w(n(It),{key:0,class:"title"},{default:d(()=>[T(Z(r.stage.title),1)]),_:1}))]),_:1},8,["vertical"])],32),m.value?(l(),w(n(oa),{key:0,count:"!",color:"gold",style:{position:"absolute",top:"-4px",right:"-4px","z-index":"1"}})):S("",!0),U.value==="prompting"||U.value==="creating"?(l(),w(Yn,{key:1,filename:E.value,"file-exists":u.value,"creating-file-status":U.value,onCreateFile:ie,onCancel:H,onUpdateFilename:B},null,8,["filename","file-exists","creating-file-status"])):S("",!0),c(n(na),{visible:y.value,"onUpdate:visible":h[3]||(h[3]=V=>y.value=V),title:"Tasks",width:"500",onClose:h[4]||(h[4]=V=>y.value=!1)},{default:d(()=>[c(Kt,{"stage-id":r.stage.id},null,8,["stage-id"])]),_:1},8,["visible"])],64))}});const ce=le(Kn,[["__scopeId","data-v-811be10f"]]),st=t=>(St("data-v-f4278104"),t=t(),xt(),t),Jn={class:"empty-hint"},Qn={key:0,class:"drag-hint"},eo=st(()=>M("div",{class:"title"},"Start here",-1)),to={key:1,class:"drop-hint"},ao=st(()=>M("div",{class:"title"},"Drop here",-1)),no={key:2,class:"stages-hint"},oo={class:"header"},so={class:"title"},lo={class:"description"},io=N({__name:"EmptyHint",props:{showDragHint:{type:Boolean}},setup(t){return(e,a)=>(l(),k("div",Jn,[e.showDragHint?(l(),k("div",Qn,[eo,c(n(Oe),{size:32,class:"arrow"})])):S("",!0),e.showDragHint?S("",!0):(l(),k("div",to,[ao,c(n(Oe),{size:32,class:"arrow"})])),e.showDragHint?(l(),k("div",no,[(l(!0),k(G,null,ge(n(_e).stages,o=>(l(),k("div",{key:o.key,class:"stage-hint"},[M("div",oo,[(l(),w(K(o.icon))),M("span",so,Z(o.title),1)]),M("div",lo,Z(o.description),1)]))),128))])):S("",!0)]))}});const ro=le(io,[["__scopeId","data-v-f4278104"]]),uo=N({__name:"Workflow",props:{workflow:{},editable:{type:Boolean},showDragHint:{type:Boolean},checkFileStatus:{type:Boolean},initialFileCheckStatus:{}},setup(t){const e=t;Dt(u=>({aea56c2e:n(g),"124ca7b4":n(v)}));const a=at(),{useToken:o}=Qe,{token:s}=o(),v=s.value.colorPrimaryBorder,g=s.value.colorBgElevated,{onInit:_}=ee();_(u=>{u.fitView()});const y=u=>{var i;return!e.checkFileStatus||!e.initialFileCheckStatus?!0:u&&(i=e.initialFileCheckStatus[u])!=null?i:!1};return Ce(()=>{const u=ue.subscribe("stageCreated",()=>{e.workflow.refetch()}),i=ue.subscribe("stageEdited",()=>{e.workflow.refetch()}),f=ue.subscribe("transitionCreated",()=>{e.workflow.refetch()});Et(()=>{ue.unsubscribe(u),ue.unsubscribe(f),ue.unsubscribe(i)})}),(u,i)=>u.workflow?(l(),w(n(jt),{key:0,nodes:u.workflow.vueFlowNodes.value,edges:u.workflow.vueFlowEdges.value,"max-zoom":1.25,class:"vue-flow-root","select-nodes-on-drag":!1,"zoom-on-double-click":!1,multi:"","multi-selection-key-code":"Shift","nodes-draggable":u.editable,"pan-on-scroll":n(et).isMac,"elements-selectable":u.editable,"snap-to-grid":"","apply-default":!1,"delete-key-code":[],onDragover:n(a).onDragOver,onDragleave:n(a).onDragLeave},{"connection-line":d(f=>[c(On,zt(Ft(f)),null,16)]),"edge-task":d(f=>[c(Nn,be(f,{controller:u.workflow}),null,16,["controller"])]),"node-forms":d(f=>[c(ce,{stage:f.data,node:f,controller:u.workflow,"initial-file-check":y(f.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-hooks":d(f=>[c(ce,{stage:f.data,node:f,controller:u.workflow,"initial-file-check":y(f.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-scripts":d(f=>[c(ce,{stage:f.data,node:f,controller:u.workflow,"initial-file-check":y(f.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-jobs":d(f=>[c(ce,{stage:f.data,node:f,controller:u.workflow,"initial-file-check":y(f.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-agents":d(f=>[c(ce,{stage:f.data,node:f,controller:u.workflow,"initial-file-check":!0},null,8,["stage","node","controller"])]),"node-clients":d(f=>[c(ce,{stage:f.data,node:f,controller:u.workflow,"initial-file-check":!0},null,8,["stage","node","controller"])]),default:d(()=>[c(n(Xt)),u.editable&&!u.workflow.vueFlowNodes.value.length?(l(),w(ro,{key:0,"show-drag-hint":u.showDragHint},null,8,["show-drag-hint"])):S("",!0),c(n(Wt),{pannable:"",zoomable:""}),u.editable?(l(),w(Fn,{key:1,workflow:u.workflow},null,8,["workflow"])):S("",!0)]),_:1},8,["nodes","edges","nodes-draggable","pan-on-scroll","elements-selectable","onDragover","onDragleave"])):S("",!0)}});const co=le(uo,[["__scopeId","data-v-87cb53b9"]]),po=N({__name:"WorkflowEditor",setup(t){const e=kt(),{init:a,tearDown:o,onDragStart:s,onDrop:v,isDragging:g,isAdding:_,draggedType:y,mousePosition:u}=at(),{result:i}=Ee(async()=>await yt.init(mt,!0)),f=D(null),b=async()=>{if(!i.value)return;const m=i.value.vueFlowNodes.value.map(z=>{var P,W,$,F,O;return((P=z.data)==null?void 0:P.type)==="forms"||((W=z.data)==null?void 0:W.type)==="hooks"||(($=z.data)==null?void 0:$.type)==="scripts"||((F=z.data)==null?void 0:F.type)==="jobs"?(O=z.data)==null?void 0:O.props.filename:null});f.value=await ve.checkFiles(m.filter(z=>typeof z=="string"))};$e(()=>i.value,()=>{i.value&&(a(i.value),b())});const{onNodeDragStop:p,onEdgesChange:C,getSelectedElements:B,getNodes:A,addSelectedNodes:H,zoomIn:L,fitView:I,zoomOut:E,applyEdgeChanges:U}=ee();p(m=>{var z;(z=i.value)==null||z.move(m.nodes.map(P=>({id:P.id,position:P.position})))}),C(m=>{var z;for(const P of m)P.type==="remove"&&((z=i.value)==null||z.delete([P.id]));U(m)});const ie=m=>{var z,P;e.isInputFocused||!i.value||((m.key==="z"||m.key==="Z")&&R(m)&&(Ra(m)?i.value.history.redo():(z=i.value)==null||z.history.undo(),m.preventDefault()),R(m)&&(m.key==="s"||m.key==="S")&&((P=i.value)==null||P.save(),m.preventDefault()),!(R(m)&&(m.key==="f"||m.key==="F"))&&(B.value.length||(m.key==="f"||m.key==="F"?s(null,"forms"):m.key==="h"||m.key==="H"?s(null,"hooks"):m.key==="j"||m.key==="J"?s(null,"jobs"):m.key==="t"||m.key==="T"?s(null,"scripts"):(m.key==="a"||m.key==="A")&&R(m)?(H(A.value),m.preventDefault()):m.key==="0"&&R(m)?(I(),m.preventDefault()):(m.key==="="||m.key==="+")&&R(m)?(m.preventDefault(),L()):m.key==="-"&&R(m)&&(m.preventDefault(),E()))))};return Ce(()=>{window.addEventListener("keydown",ie)}),Pe(()=>{window.removeEventListener("keydown",ie),o()}),(m,z)=>n(i)?(l(),k("div",{key:0,class:Fe(["workflow-container",{dragging:n(_)}]),onDrop:z[0]||(z[0]=(...P)=>n(v)&&n(v)(...P))},[c(co,{workflow:n(i),editable:"","show-drag-hint":!n(_),"check-file-status":!0,"initial-file-check-status":f.value},null,8,["workflow","show-drag-hint","initial-file-check-status"]),c(en,{controller:n(i),onDragStart:n(s)},null,8,["controller","onDragStart"]),(l(!0),k(G,null,ge(n(_e).stages,P=>{var W,$;return l(),k("div",{key:P.key},[n(_)&&!n(g)&&P.typeName===n(y)?(l(),k("div",{key:0,class:"dragging-node",style:ne({left:`${(W=n(u))==null?void 0:W.x}px`,top:`${($=n(u))==null?void 0:$.y}px`,position:"absolute",cursor:n(_)?"grabbing":"grab"})},[(l(),w(K(P.icon),{size:18}))],4)):S("",!0)])}),128))],34)):S("",!0)}});const os=le(po,[["__scopeId","data-v-aa8dbb66"]]);export{os as default};
//# sourceMappingURL=WorkflowEditor.3639b148.js.map
