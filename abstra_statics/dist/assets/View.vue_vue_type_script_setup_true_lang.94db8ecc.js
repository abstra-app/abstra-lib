var T=Object.defineProperty;var j=(i,e,t)=>e in i?T(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var s=(i,e,t)=>(j(i,typeof e!="symbol"?e+"":e,t),t);import{k as C}from"./router.ed823a0a.js";import{l as I}from"./fetch.5b7828a4.js";import{E as x}from"./record.63a637c8.js";import{$ as R,r as S,eL as $,d as F,w as L,U as O,ax as P,ac as B,u as a,a as v,eI as M,b as o,h as p,aY as G,o as u,g as y,t as f,f as g,i as c,cD as N,df as W,cJ as z,cE as J,M as Z}from"./jwt-decode.esm.fbcfeaec.js";import{S as U}from"./SaveButton.b37608e0.js";import{C as H}from"./CrudView.a7272ae3.js";import{a as K}from"./asyncComputed.5a2bb5ad.js";import{o as w}from"./omniChatStore.81aa62c1.js";import{G as Y}from"./PhPencil.vue.e528a6ad.js";import{u as q}from"./useCodebaseEvents.c1fc4662.js";import{A as Q}from"./index.4d74f393.js";(function(){try{var i=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(i._sentryDebugIds=i._sentryDebugIds||{},i._sentryDebugIds[e]="18a2c6d5-4656-41e2-a6f9-07f6067987d6",i._sentryDebugIdIdentifier="sentry-dbid-18a2c6d5-4656-41e2-a6f9-07f6067987d6")}catch{}})();class b{constructor(e){s(this,"data");s(this,"deleted");s(this,"wasDeleted",e=>this.deleted.value.includes(e));s(this,"wasUpdated",e=>this.data.hasChangesDeep(e));s(this,"set",(e,t)=>{this.data.set(e,t),this.deleted.value=this.deleted.value.filter(n=>n!==e)});s(this,"get",e=>{if(!this.deleted.value.includes(e))return this.data.get(e)});s(this,"delete",e=>{this.deleted.value=[...this.deleted.value,e]});s(this,"values",()=>{const e={},t=Object.keys(this.data.changes).concat(Object.keys(this.data.initialState));for(const n of t)this.deleted.value.includes(n)||(e[n]=this.data.get(n));return e});s(this,"commit",()=>{this.data=x.from(this.values()),this.deleted.value=[]});this.data=x.from(e),this.deleted=R([])}static from(e){const t=e.reduce((n,{name:l,value:m})=>(n[l]=m,n),{});return new b(t)}get changes(){const e=this.deleted.value.map(t=>({name:t,change:"delete"}));for(const t of Object.keys(this.data.changes))if(!this.deleted.value.includes(t)){if(this.data.initialState[t]===void 0){e.push({name:t,value:this.data.get(t),change:"create"});continue}this.data.hasChangesDeep(t)&&e.push({name:t,value:this.data.get(t),change:"update"})}return e}}class X{constructor(){s(this,"urlPath","env-vars")}async list(e){return await C.get(`projects/${e}/${this.urlPath}`)}async update(e,t){await C.patch(`projects/${e}/${this.urlPath}`,t)}}const A=new X;class he{constructor(e){this.projectId=e}async get(){const e=await A.list(this.projectId);return b.from(e.map(t=>({...t,value:""})))}async update(e){await A.update(this.projectId,e)}}class ve{constructor(e=I){this.fetch=e}async get(){const e=await this.fetch("/_editor/api/env-vars");if(!e.ok)throw new Error("Failed to list env vars");const t=await e.json();return b.from(t)}async update(e){await this.fetch("/_editor/api/env-vars",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}}class V{constructor(e,t,n){s(this,"envVarRepo");s(this,"envVars");s(this,"state",S({type:"idle"}));s(this,"mode");s(this,"validate",e=>{const t=/^[A-Za-z_][A-Za-z0-9_]*$/,{key:n,value:l}=e;if(l.trim()!==l)throw new Error("Environment variable values cannot have leading or trailing whitespace.");if(!t.test(n))throw new Error(`Invalid key: \u2018${n}\u2019. A key must begin with a letter or an underscore, and may only include letters, numbers, and underscores.`)});s(this,"create",e=>{this.validate(e),this.envVars.set(e.key,e.value),this.state.value={type:"idle"}});s(this,"delete",e=>{this.envVars.delete(e),this.state.value={type:"idle"}});s(this,"startUpdating",e=>{this.state.value={type:"updating",name:e,value:this.envVars.get(e)||""}});s(this,"confirmUpdate",()=>{this.state.value.type==="updating"&&(this.envVars.set(this.state.value.name,this.state.value.value),this.state.value={type:"idle"})});s(this,"cancelUpdate",()=>{this.state.value={type:"idle"}});s(this,"refetch",async()=>{if(!this.isLocalEditor)return;const e=await this.envVarRepo.get();Object.entries(e.values()).forEach(([t,n])=>{this.envVars.wasDeleted(t)||this.envVars.get(t)===void 0&&this.envVars.set(t,n)})});s(this,"columns",()=>[{title:"Key"},{title:"Value"},{title:""}]);s(this,"rows",()=>Object.entries(this.envVars.values()).map(([e])=>({key:e,cells:[{type:"text",text:e,contentType:this.wasUpdated(e)?"warning":"default"},{type:"text",text:"*********",contentType:this.wasUpdated(e)?"warning":"default"},{type:"actions",actions:[{icon:$,label:"Delete",onClick:()=>this.delete(e),dangerous:!0},{icon:Y,label:"Update",onClick:()=>this.startUpdating(e)}]}]})));s(this,"save",async()=>{await this.envVarRepo.update(this.envVars.changes),this.envVars.commit()});s(this,"hasChanges",()=>this.envVars.changes.length>0);s(this,"table",()=>({columns:this.columns(),rows:this.rows()}));this.envVarRepo=e,this.envVars=t,this.mode=n}static async create(e,t){const n=await e.get();return new V(e,n,t)}get isLocalEditor(){return this.mode==="editor"}get saveMessage(){return this.isLocalEditor?"Save":"Save and Apply"}get creationFields(){return[{label:"Variable name",key:"key"},{label:"Variable value",key:"value",type:"multiline-text"}]}get isUpdating(){return this.state.value.type==="updating"}wasUpdated(e){return this.envVars.wasUpdated(e)}}const pe=F({__name:"View",props:{envVarRepository:{},mode:{},hideTitle:{type:Boolean}},setup(i){const e=i,{result:t,loading:n,refetch:l}=K(async()=>await V.create(e.envVarRepository,e.mode)),m=q();L(m.lastEvent,async d=>{var r;d&&d.filepath&&d.filepath.endsWith(".env")&&await((r=t.value)==null?void 0:r.refetch())});const D={columns:[],rows:[]};return O(()=>{const d=w.subscribe("envVarCreated",()=>{l()}),r=w.subscribe("envVarEdited",()=>{l()});P(()=>{w.unsubscribe(d),w.unsubscribe(r)})}),(d,r)=>{var k,_;return u(),B(G,null,[a(t)?(u(),v(H,{key:0,"entity-name":a(c).translate("i18n_envvarsview_entity_name"),loading:a(n),title:e.hideTitle?"":a(c).translate("i18n_envvarsview_title"),description:e.hideTitle?"":a(c).translate("i18n_envvarsview_description"),"empty-title":a(c).translate("i18n_envvarsview_empty_title"),table:a(t).table()||D,"create-button-text":a(c).translate("i18n_envvarsview_create_button"),create:a(t).create,fields:a(t).creationFields||[],live:a(t).isLocalEditor},M({_:2},[(k=a(t))!=null&&k.isLocalEditor?{name:"secondary",fn:o(()=>[i.mode=="editor"?(u(),v(U,{key:0,model:a(t),disabled:!a(t).hasChanges()},{"with-changes":o(()=>[y(f(a(t).saveMessage),1)]),_:1},8,["model","disabled"])):p("",!0)]),key:"0"}:void 0,(_=a(t))!=null&&_.isLocalEditor?{name:"extra",fn:o(()=>[g(a(Q),{"show-icon":"",style:{"margin-top":"20px"}},{message:o(()=>[y(f(a(c).translate("i18n_envvarsview_local_helper_message")),1)]),_:1})]),key:"1"}:void 0,a(t)?{name:"more",fn:o(()=>[i.mode=="console"?(u(),v(U,{key:0,model:a(t),disabled:!a(t).hasChanges()},{"with-changes":o(()=>[y(f(a(t).saveMessage),1)]),_:1},8,["model","disabled"])):p("",!0)]),key:"2"}:void 0]),1032,["entity-name","loading","title","description","empty-title","table","create-button-text","create","fields","live"])):p("",!0),a(t)?(u(),v(a(Z),{key:1,open:a(t).isUpdating,title:a(c).translate("i18n_envvarsview_update_modal_title"),onCancel:r[1]||(r[1]=h=>{var E;return(E=a(t))==null?void 0:E.cancelUpdate()}),onOk:r[2]||(r[2]=()=>{var h;return(h=a(t))==null?void 0:h.confirmUpdate()})},{default:o(()=>[a(t).state.value.type==="updating"?(u(),v(a(N),{key:0,layout:"vertical"},{default:o(()=>[g(a(J),null,{default:o(()=>[g(a(W),null,{default:o(()=>[y(f(a(t).state.value.name),1)]),_:1}),g(a(z),{value:a(t).state.value.value,"onUpdate:value":r[0]||(r[0]=h=>a(t).state.value.value=h)},null,8,["value"])]),_:1})]),_:1})):p("",!0)]),_:1},8,["open","title"])):p("",!0)],64)}}});export{he as C,ve as E,pe as _};
//# sourceMappingURL=View.vue_vue_type_script_setup_true_lang.94db8ecc.js.map
