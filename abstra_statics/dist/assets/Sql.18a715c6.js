import{_ as K}from"./AbstraButton.vue_vue_type_script_setup_true_lang.9c0844e1.js";import{_ as te}from"./ScrollArea.vue_vue_type_script_setup_true_lang.e8269806.js";import{a0 as J,Z as C,r as S,w as se,d as ne,ei as ae,en as oe,U as le,ac as I,f as r,e as v,b as u,u as s,aY as O,o as _,t as w,i as E,a as L,S as re,ej as F,h as B,dj as h,g as z,eD as ie,d0 as ue,cC as ce,M as de,cQ as G,_ as me}from"./jwt-decode.esm.32f71954.js";import{G as fe}from"./PhClockCounterClockwise.vue.15ff64b9.js";import{I as pe}from"./PhDatabase.vue.425a706f.js";import{G as ye}from"./PhDownloadSimple.vue.2759a067.js";import{F as _e}from"./PhKey.vue.07ccc3ef.js";import{l as D,e as ge}from"./toggleHighContrast.7b4a31db.js";import{_ as he}from"./TablesTabs.vue_vue_type_script_setup_true_lang.744da918.js";import{A as ve,C as Ce}from"./router.29e08ea4.js";import{a as qe}from"./project.b14b799c.js";import"./tables.94d324c3.js";import{u as be}from"./useTables.64fe45b0.js";import"./Card.e1ec3051.js";import"./index.2400150a.js";import"./record.41c9caee.js";import"./string.ff0b4ef9.js";(function(){try{var e=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},n=new Error().stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="369cc2da-2361-41c0-9b6b-187f750f01fd",e._sentryDebugIdIdentifier="sentry-dbid-369cc2da-2361-41c0-9b6b-187f750f01fd")}catch{}})();const W=e=>{if(e==null)return"";const n=String(e);return n.includes(";")||n.includes(`
`)||n.includes('"')?`"${n.replace(/"/g,'""')}"`:n},we=e=>{let n=e.columns.map(W).join(";")+`
`;e.rows.forEach(m=>{n+=m.map(W).join(";")+`
`});const a=document.createElement("a");a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(n),a.target="_blank",a.download=`${e.fileName}.csv`,a.click()},A=new J(C.array(C.object({projectId:C.string(),lastQuery:C.string()})),"lastQueries"),j=new J(C.array(C.object({id:C.string(),query:C.string(),timestamp:C.number(),projectId:C.string()})),"queryHistory");function Ee(e,n){var $;const a=e.toUpperCase(),m=/\b(FROM|JOIN|UPDATE|INTO)\s+\w*$/i.test(a)||/\bDELETE\s+FROM\s+\w*$/i.test(a),t=/\b(SELECT|WHERE|ON|SET|AND|OR|BY)\s+[\w.]*$/i.test(a)||/\w+\.\w*$/.test(e),c=e.match(/(\w+)\.\w*$/),N=c&&($=n.find(T=>T.name.toUpperCase()===c[1].toUpperCase()))!=null?$:null,q=/\b(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP|FROM|WHERE|JOIN)\b/.test(a);return{textBeforeCursor:e,isTableContext:m,isColumnContext:t,specificTable:N,hasSqlKeyword:q}}function $e(e,n,a){const m=[];if(e.specificTable)e.specificTable.getColumns().forEach(t=>{m.push({label:t.name,kind:D.CompletionItemKind.Field,insertText:t.name,detail:`${t.type}`,documentation:`Column from ${e.specificTable.name}`,range:a})});else if(e.isTableContext)n.forEach(t=>{m.push({label:t.name,kind:D.CompletionItemKind.Class,insertText:t.name,detail:"Table",documentation:`${t.getColumns().length} columns`,range:a})});else if(e.isColumnContext)n.forEach(t=>{t.getColumns().forEach(c=>{m.push({label:`${t.name}.${c.name}`,kind:D.CompletionItemKind.Field,insertText:`${t.name}.${c.name}`,detail:`${c.type}`,documentation:`${t.name}.${c.name}`,range:a})})});else{if(!e.hasSqlKeyword)return[];n.forEach(t=>{m.push({label:t.name,kind:D.CompletionItemKind.Class,insertText:t.name,detail:"Table",range:a}),t.getColumns().forEach(c=>{m.push({label:`${t.name}.${c.name}`,kind:D.CompletionItemKind.Field,insertText:`${t.name}.${c.name}`,detail:`${c.type}`,range:a})})})}return m}function ke(e,n){const a=S(""),m=S([]),t=S([]),c=S(!1),N=()=>{const l=A.get();if(!l)A.set([{projectId:e,lastQuery:a.value}]);else{const o=l.findIndex(d=>d.projectId===e);o===-1?l.push({projectId:e,lastQuery:a.value}):l[o].lastQuery=a.value,A.set(l)}},q=()=>{var o;const l=A.get();return(o=l==null?void 0:l.find(d=>d.projectId===e))==null?void 0:o.lastQuery},$=l=>{if(!l.trim())return;const o=j.get()||[],d={id:`${Date.now()}-${Math.random()}`,query:l.trim(),timestamp:Date.now(),projectId:e},y=o.filter(x=>x.projectId===e),g=o.filter(x=>x.projectId!==e),k=[d,...y].slice(0,50);j.set([...k,...g])},T=()=>(j.get()||[]).filter(o=>o.projectId===e).sort((o,d)=>d.timestamp-o.timestamp),M=()=>{const o=(j.get()||[]).filter(d=>d.projectId!==e);j.set(o)},P=async()=>{c.value=!0;const l=await qe.executeQuery(e,a.value,[]);if(N(),$(a.value),c.value=!1,!l)return{returns:{result:[],fields:[]},errors:[]};const{returns:o,errors:d}=l;return t.value=o.fields.map(y=>({title:y.name,key:y.name,dataIndex:y.name})),m.value=o.result.map((y,g)=>{const k={key:`${g+1}`};return Object.entries(y).forEach(([x,R])=>{k[x]=R!=null?String(R):""}),k}),{returns:o,errors:d}};let H=null;const U=()=>{!n.value||n.value.length===0||(H&&H.dispose(),H=D.registerCompletionItemProvider("sql",{provideCompletionItems:(l,o)=>{const d=l.getWordUntilPosition(o),y={startLineNumber:o.lineNumber,endLineNumber:o.lineNumber,startColumn:d.startColumn,endColumn:d.endColumn},g=l.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:o.lineNumber,endColumn:o.column}),k=Ee(g,n.value);return{suggestions:$e(k,n.value,y)}}}))};return se(n,()=>{n.value&&n.value.length>0&&U()},{immediate:!0}),{sql:a,data:m,columns:t,loading:c,runSql:P,getLastQuery:q,setLastQuery:N,getHistory:T,clearHistory:M}}const xe={class:"sql-main-card"},Se={class:"data-dictionary"},Te={class:"dictionary-header"},Ie=["onClick"],Ne={class:"column-name"},Le={class:"column-type"},De={class:"sql-editor-container"},He={key:1,class:"history-list"},Qe=["onClick"],je={class:"history-query"},Re={class:"history-timestamp"},Ke=ne({__name:"Sql",setup(e){const n=ae(),a=n.params.projectId,m=S(null);let t=null;const{tables:c,loading:N}=be(a),{sql:q,data:$,columns:T,loading:M,runSql:P,getLastQuery:H,setLastQuery:U,getHistory:l,clearHistory:o}=ke(a,c),d=S([]),y=S(!1),g=S([]),k=async()=>{const{errors:f}=await P();g.value=l();for(const p of f)G.error({message:E.translate("i18n_sql_execution_failed"),description:p});f.length||G.success({message:E.translate("i18n_sql_execution_succeeded")})},x=()=>{const f=T.value.map(Q=>Q.dataIndex),p=T.value.map(Q=>Q.title),i=$.value.map(Q=>f.map(ee=>Q[ee])),V=`data-${new Date().toISOString()}`;we({fileName:V,columns:p,rows:i})},R=(f,p)=>{if(!t)return;const i=t.getSelection();if(!i)return;const b=`${f}.${p}`;t.executeEdits("",[{range:i,text:b}]),t.focus()},Y=f=>{t&&(t.setValue(f),q.value=f),y.value=!1},Z=()=>{o(),g.value=[]},X=oe.exports.debounce(U,1e3);return le(()=>{g.value=l(),t=ge.create(m.value,{language:"sql",value:q.value,fontFamily:"monospace",lineNumbers:"on",minimap:{enabled:!1},scrollbar:{vertical:"hidden",horizontal:"visible"},fontSize:14,scrollBeyondLastLine:!1,lineHeight:20,suggestOnTriggerCharacters:!0,quickSuggestions:{other:!0,comments:!1,strings:!1}}),t.onDidChangeModelContent(()=>{!t||(q.value=t.getValue(),X())});const f=n.query.filter;if(f&&typeof f=="string"&&f.trim())q.value=f,t.setValue(f);else{const p=H();p&&(q.value=p,t.setValue(p))}}),(f,p)=>(_(),I(O,null,[r(he),v("div",xe,[r(s(h),{gap:"middle",style:{width:"100%",height:"100%"}},{default:u(()=>[v("div",Se,[v("div",Te,[r(s(pe),{size:16}),v("span",null,w(s(E).translate("i18n_sql_tables")),1)]),s(N)?(_(),L(s(re),{key:0,style:{width:"100%",padding:"20px"}})):(_(),L(s(Ce),{key:1,activeKey:d.value,"onUpdate:activeKey":p[0]||(p[0]=i=>d.value=i),ghost:""},{default:u(()=>[(_(!0),I(O,null,F(s(c),i=>(_(),L(s(ve),{key:i.id,header:i.name},{default:u(()=>[(_(!0),I(O,null,F(i.getColumns(),b=>(_(),I("div",{key:b.id,class:"column-item",onClick:V=>R(i.name,b.name)},[b.primaryKey?(_(),L(s(_e),{key:0,size:12,style:{color:"#faad14"}})):B("",!0),v("span",Ne,w(b.name),1),v("span",Le,w(b.type),1)],8,Ie))),128))]),_:2},1032,["header"]))),128))]),_:1},8,["activeKey"]))]),r(s(h),{vertical:"",style:{flex:"1"},gap:"middle"},{default:u(()=>[v("div",De,[v("div",{ref_key:"sqlEditor",ref:m,class:"sql-editor"},null,512),r(s(h),{justify:"flex-end",class:"bottom-controls",gap:"small",align:"center"},{default:u(()=>[r(s(h),{gap:"small"},{default:u(()=>[r(K,{size:"small",type:"text",onClick:p[1]||(p[1]=i=>y.value=!0)},{default:u(()=>[r(s(h),{gap:"4",align:"center"},{default:u(()=>[r(s(fe),{size:14}),z(" "+w(s(E).translate("i18n_sql_history")),1)]),_:1})]),_:1})]),_:1}),r(s(h),{gap:"small",align:"center"},{default:u(()=>[r(K,{size:"small",type:"primary",loading:s(M),onClick:k},{default:u(()=>[r(s(h),{gap:"4",align:"center"},{default:u(()=>[z(w(s(E).translate("i18n_sql_run"))+" ",1),r(s(ie),{size:12})]),_:1})]),_:1},8,["loading"])]),_:1})]),_:1})]),r(te,{"outer-style":{width:"100%",height:"calc(100% - 220px)"}},{default:u(()=>[r(s(ue),{scroll:{x:100},"data-source":s($),columns:s(T)},null,8,["data-source","columns"])]),_:1},8,["outer-style"]),s($).length?(_(),L(s(h),{key:0,justify:"end"},{default:u(()=>[r(K,{onClick:x},{default:u(()=>[r(s(h),{align:"center",gap:"small"},{default:u(()=>[z(w(s(E).translate("i18n_sql_export_to_csv"))+" ",1),r(s(ye))]),_:1})]),_:1})]),_:1})):B("",!0)]),_:1})]),_:1})]),r(s(de),{open:y.value,"onUpdate:open":p[2]||(p[2]=i=>y.value=i),title:s(E).translate("i18n_sql_query_history"),width:"800px",footer:null},{default:u(()=>[r(s(h),{vertical:"",gap:"middle"},{default:u(()=>[r(s(h),{justify:"end"},{default:u(()=>[r(K,{danger:"",size:"small",onClick:Z},{default:u(()=>[z(w(s(E).translate("i18n_sql_clear_history")),1)]),_:1})]),_:1}),g.value.length?(_(),I("div",He,[(_(!0),I(O,null,F(g.value,i=>(_(),I("div",{key:i.id,class:"history-item",onClick:b=>Y(i.query)},[v("div",je,w(i.query),1),v("div",Re,w(new Date(i.timestamp).toLocaleString()),1)],8,Qe))),128))])):(_(),L(s(ce),{key:0,description:s(E).translate("i18n_sql_no_query_history")},null,8,["description"]))]),_:1})]),_:1},8,["open","title"])],64))}});const st=me(Ke,[["__scopeId","data-v-7c902b8a"]]);export{st as default};
//# sourceMappingURL=Sql.18a715c6.js.map
