var be=Object.defineProperty;var Ee=(o,e,s)=>e in o?be(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var S=(o,e,s)=>(Ee(o,typeof e!="symbol"?e+"":e,s),s);import{u as te}from"./uuid.05e7a402.js";import{G as he,d as V,r as m,S as ie,H as X,b as h,ev as k,e as d,ez as L,eE as fe,eF as ve,v as ee,eB as Se,J as se,a4 as ge,o as _e,L as me,a as ye,f as p,u as i,I as N,ar as y,eD as z,ex as M,ew as Me,a$ as oe,eC as Ie,c as B,eT as xe,eU as De,eI as Fe,w as l,bO as Ce,F as G,b3 as j,bV as q}from"./outputWidgets.8b20995a.js";import{k as re,l as le,n as ce,d as Oe,o as Re,q as Ae}from"./icons.30a80c64.js";import{l as We}from"./NavbarControls.4b6fbd71.js";import{H as Be,J as $e}from"./jobs.866af9c5.js";import{S as He}from"./scripts.aa4d7a37.js";import{n as Le,v as Te,a as Pe}from"./validations.7353adea.js";import{A as we}from"./FormItem.3282d189.js";import{W as Ne}from"./workspaces.bd8cddda.js";import{a as ue}from"./asyncComputed.104c37b3.js";import{l as ze,e as Q,R as Ve}from"./toggleHighContrast.a507a9b3.js";import{A as de}from"./index.c64b5cfb.js";import{A as Ke}from"./index.b2033868.js";import{C as Ue}from"./Card.44e6c996.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[e]="fc8bef4f-915d-4ad2-a5e3-1e4268cb0827",o._sentryDebugIdIdentifier="sentry-dbid-fc8bef4f-915d-4ad2-a5e3-1e4268cb0827")}catch{}})();class ke{constructor(){S(this,"logState",he({log:[]}));S(this,"_listeners",{})}static create(){return new ke}get logs(){return this.logState.log}log(e,s){if(e.type!=="restart"&&e.log.trim()==="")return;const t=s?this.logs.find(r=>r.id===s):null;return t?Object.assign(t,e):this.logs.push({...e,id:s||te()}),this.notifyListeners(e),s}clear(){this.logState.log=[]}listen(e){const s=te();return this._listeners[s]=e,s}unlisten(e){delete this._listeners[e]}notifyListeners(e){Object.values(this._listeners).forEach(s=>s(e))}}class Je{static async*sendMessage(e,s){var f;const r=(f=(await fetch("/_editor/api/ai/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e,runtime:s})})).body)==null?void 0:f.getReader();if(!r)throw new Error("No response body");for(;;){const _=await r.read();if(_.done)break;yield new TextDecoder().decode(_.value)}}}const Ye=o=>(fe("data-v-59ca7295"),o=o(),ve(),o),je=Ye(()=>d("div",{class:"text"}," Changes were made in your code. Click Restart to refresh the preview window. ",-1)),pe="ignoreCodeChangesWarning",qe=V({__name:"ChangesWarning",props:{hasChanges:{type:Boolean}},setup(o){var f;const e=o,s=m((f=ie.get(pe))!=null?f:!1),t=X(()=>e.hasChanges&&!s.value),r=()=>{ie.set(pe,!0),s.value=!0};return(_,F)=>(h(),k("div",{class:L(["changes-warning",{visible:t.value}])},[je,d("div",{class:"no-more-alert",onClick:r},"Do not show again")],2))}});const Ge=ee(qe,[["__scopeId","data-v-59ca7295"]]),Qe=o=>(fe("data-v-9d2d7cb6"),o=o(),ve(),o),Xe={class:"smart-console"},Ze={class:"header"},et={class:"left"},tt={class:"right"},st={class:"changes-container"},ot=["unseen-severity"],nt={class:"cli"},at={class:"left"},it=Qe(()=>d("div",{class:"entry ai-output"}," Hello there! I'm both an output console and AI assistant. You can ask me anything. ",-1)),rt={key:1,class:"local-entry"},lt={class:"input"},ct=["pointer-events","onKeydown"],ut={class:"right"},dt=V({__name:"SmartConsole",props:{inputEnabled:{type:Boolean},formCode:{},runtime:{},logService:{}},emits:["eval-request","clear-terminal","restart","enter"],setup(o,{emit:e}){const s=o,t=m(""),r=m(null),f=Se(),_=m({type:"seen"}),F=m(!1),O=m(!1),A=()=>{b.value=b.value==="assistant"?"debugger":"assistant"};function R(u){switch(u.type){case"ai-input":return{role:"user",content:u.log};case"ai-output":return{role:"assistant",content:u.log};case"stderr":case"stdout":return{role:"user",content:u.log};case"restart":return{role:"user",content:"-- new session --"};case"files-changed":return{role:"user",content:"-- files changed --"};default:throw new Error(`Unknown log type: ${u.type}`)}}const C=X(()=>s.logService.logs.some(u=>u.type==="files-changed"));function I(){w.value=!w.value,w.value&&(_.value={type:"seen"})}se(f,()=>{s.logService.clear(),e("clear-terminal")});const v=m(null),b=m("assistant"),T=async u=>{var n;if(u.preventDefault(),t.value=((n=v.value)==null?void 0:n.innerText)||"",u.shiftKey){document.execCommand("insertLineBreak");return}v.value&&(v.value.innerText=""),b.value==="assistant"?await $():await E()},$=async()=>{var n;if(e("enter",t.value),s.logService.log({type:"ai-input",log:t.value}),t.value="",!O.value){s.logService.log({type:"stderr",log:"Please login to use the AI assistant."});return}F.value=!0;const u={role:"user",content:(n=s.formCode)!=null?n:""};try{const a=te();let g="";const x=Je.sendMessage([u,...s.logService.logs.map(D=>R(D)),{role:"user",content:t.value}],s.runtime);for await(const D of x)g+=D,s.logService.log({type:"ai-output",log:g},a)}catch(a){s.logService.log({type:"ai-output",log:"Sorry, I don't know how to answer that."}),console.error(a),De(a)}finally{F.value=!1}},E=async()=>{t.value&&(s.logService.log({type:"eval-input",log:`>>> ${t.value}`}),e("eval-request",t.value),t.value="")},P=()=>{s.logService.clear()};s.logService.listen(async u=>{w.value||(_.value={type:"unseen",count:_.value.type==="unseen"?_.value.count+1:1,severity:u.type==="stderr"?"error":"info"}),u.type!=="restart"&&(await ge(),r.value&&(r.value.scrollTop=r.value.scrollHeight))});const w=m(!1),K=m(400),c=X(()=>({height:`${K.value}px`})),H=m(!1),U=()=>H.value=!0,J=u=>{!H.value||(K.value=document.body.clientHeight-u.clientY)},Y=()=>H.value=!1;return _e(()=>{document.addEventListener("mousemove",J),document.addEventListener("mouseup",Y),We.get().then(u=>{O.value=!!u.logged})}),me(()=>{document.removeEventListener("mousemove",J),document.removeEventListener("mouseup",Y)}),(u,n)=>{const a=ye("Markdown");return h(),k("div",Xe,[d("div",Ze,[d("div",et,[p(N,{path:b.value==="assistant"?i(re):i(le)},null,8,["path"]),y(" Smart Console ")]),d("div",tt,[d("div",st,[p(Ge,{"has-changes":C.value},null,8,["has-changes"])]),d("div",{class:"toggle-button",onClick:I},[p(N,{class:L(["icon",{open:w.value}]),path:i(ce),fill:"#fff"},null,8,["class","path"]),_.value.type==="unseen"?(h(),k("div",{key:0,class:"unseen-count","unseen-severity":_.value.severity},z(_.value.count),9,ot)):M("",!0)])])]),w.value?(h(),k("div",{key:0,class:"terminal",style:Me(c.value)},[d("div",{class:"resize-handler",onMousedown:U},null,32),d("div",nt,[d("div",at,[d("div",{ref_key:"entriesContainer",ref:r,class:"entries"},[it,(h(!0),k(oe,null,Ie(s.logService.logs,(g,x)=>(h(),k("div",{key:x,class:L([g.type,"entry"])},[g.type==="ai-output"?(h(),B(a,{key:0,source:g.log},null,8,["source"])):(h(),k("div",rt,z(g.type==="restart"?"-- restarted --":g.log),1))],2))),128))],512),d("div",lt,[p(N,{class:L(["icon",{open:w.value}]),path:i(ce)},null,8,["class","path"]),d("div",{ref_key:"inputRef",ref:v,class:"input-text",contenteditable:"","pointer-events":F.value?"none":"auto",placeholder:"Ask AI anything",onKeydown:xe(T,["enter"])},null,40,ct)])]),d("div",ut,[d("div",{class:"icons",onClick:P},[p(N,{class:"icon",path:i(Oe)},null,8,["path"])]),d("div",null,[p(N,{class:"icon clickable",path:b.value==="assistant"?i(re):i(le),onClick:n[0]||(n[0]=g=>A())},null,8,["path"])])])])],4)):M("",!0)])}}});const $t=ee(dt,[["__scopeId","data-v-9d2d7cb6"]]),pt=V({__name:"PathInput",props:{runtime:{}},setup(o){const e=o,s=()=>{const t=Le(e.runtime.path);t&&t!==e.runtime.path&&(e.runtime.path=t)};return(t,r)=>(h(),B(i(Ce),{value:t.runtime.path,"onUpdate:value":r[0]||(r[0]=f=>t.runtime.path=f),type:"text",onBlur:s},Fe({_:2},[t.runtime instanceof i(Be)?{name:"addonBefore",fn:l(()=>[y(" https://[your-subdomain].abstra.app/_hooks/ ")]),key:"0"}:{name:"addonBefore",fn:l(()=>[y(" https://[your-subdomain].abstra.app/ ")]),key:"1"}]),1032,["value"]))}}),ht={key:1},ft=V({__name:"RuntimeCommonSettings",props:{runtime:{}},setup(o){const e=he({pathError:null});return(s,t)=>(h(),k(oe,null,[s.runtime instanceof i($e)||s.runtime instanceof i(He)?M("",!0):(h(),B(i(we),{key:0,label:"URL path"},{default:l(()=>[p(pt,{runtime:s.runtime},null,8,["runtime"])]),_:1})),e.pathError?(h(),k("div",ht,z(e.pathError),1)):M("",!0)],64))}});const Ht=ee(ft,[["__scopeId","data-v-60a397e0"]]);let Z={};function vt(o){return o in Z?"\n\n```python\n"+o+" = "+Z[o]+"\n```":""}ze.registerHoverProvider("python",{provideHover:function(o,e){const s=o.getWordAtPosition(e);if(!!s)return{contents:[{value:vt(s.word)}]}}});const gt=(o,e,s={})=>{var R;const t=Q.create(o,{language:"python",value:e,minimap:{enabled:!1},readOnly:(R=s.readOnly)!=null?R:!1,contextmenu:!s.readOnly,automaticLayout:!s.readOnly,tabSize:4,fixedOverflowWidgets:!0,theme:s.theme?s.theme:"vs",fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:s.readOnly?0:5,scrollBeyondLastLine:!s.readOnly,renderLineHighlight:s.readOnly?"none":"all",scrollbar:{useShadows:!1,alwaysConsumeMouseWheel:!1}}),r=t.getContribution("editor.contrib.messageController");t.onDidAttemptReadOnlyEdit(()=>{r.showMessage("Cannot edit during preview execution",t.getPosition())});const f=t.createDecorationsCollection([]),_=(C,I)=>{f.set(C.map(v=>({range:new Ve(v.lineno,1,v.lineno,1),options:{isWholeLine:!0,className:I}}))),Z=C.reduce((v,b)=>({...v,...b.locals}),{})};return{editor:t,highlight:(C,I)=>v=>{var $,E;const T=((E=($=v.debug)==null?void 0:$.stack)!=null?E:[]).filter(P=>P.filename.endsWith(I));_(T,C)},clearHighlights:()=>{f.clear(),Z={}},setReadOnly:C=>{t.updateOptions({readOnly:C})}}},_t=(o,e,s)=>{const t=Q.createModel(e),r=Q.createModel(s),f=Q.createDiffEditor(o,{minimap:{enabled:!1},readOnly:!0,contextmenu:!1,automaticLayout:!0,renderWhitespace:"none",guides:{indentation:!1},fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:0,scrollBeyondLastLine:!1,renderLineHighlight:"none"});return f.setModel({original:t,modified:r}),{diffEditor:f}};class mt{constructor(e,s){S(this,"_script");S(this,"_localEditorCode");S(this,"_monacoEditor");S(this,"_diffEditor");S(this,"_viewMode");S(this,"_alertMessage");S(this,"_conflictingChanges");this._localEditorCode=e,this._script=s,this._monacoEditor=null,this._diffEditor=null,this._viewMode=G("editor"),this._alertMessage=G(""),this._conflictingChanges=G(!1)}get alertMessage(){return this._alertMessage.value}set alertMessage(e){this._alertMessage.value=e}get conflictingChanges(){return this._conflictingChanges.value}set conflictingChanges(e){this._conflictingChanges.value=e}get viewMode(){return this._viewMode.value}set viewMode(e){this._viewMode.value=e}get abstraIDECode(){return this._script.codeContent}get localEditorCode(){return this._localEditorCode}set monacoEditor(e){this._monacoEditor=e}set diffEditor(e){this._diffEditor=e}finishPreview(){var e;this._viewMode.value="editor",this._script.codeContent=this._localEditorCode,(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.alertMessage=""}updateCodeWhileEditing(e){var r;const s=e!==this._localEditorCode;if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1;return}const t=!this._script.hasChanges("code_content");if(t){(r=this._monacoEditor)==null||r.setValue(e),this._script.codeContent=e,this._script.updateInitialState("code_content",e);return}if(!t&&s){this.alertMessage="You have conflicting changes with your local editor code",this.conflictingChanges=!0;return}}updateCodeWhileDiff(e){var s,t;if(e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1,this.viewMode="editor",this._localEditorCode=e;return}if(e!==this._localEditorCode){(t=(s=this._diffEditor)==null?void 0:s.getModel())==null||t.modified.setValue(e),this._localEditorCode=e;return}}updateCodeWhilePreview(e){if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="";return}this.alertMessage="The changes on your code will be shown after the preview stops running"}updateCode(e){switch(this._viewMode.value){case"editor":return this.updateCodeWhileEditing(e);case"diff":return this.updateCodeWhileDiff(e);case"preview":return this.updateCodeWhilePreview(e)}}keepAbstraIDECode(){var e;(e=this._monacoEditor)==null||e.setValue(this._script.codeContent),this._script.save("code_content"),this._script.updateInitialState("code_content",this._script.codeContent),this._localEditorCode=this._script.codeContent,this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}keepLocalEditor(){var e;(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}}const yt={class:"container"},Ct=V({__name:"SourceCode",props:{script:{},workspace:{},broker:{}},emits:["update-file"],setup(o,{expose:e,emit:s}){const t=o,r=()=>{!t.script.file||t.workspace.openFile(t.script.file)},f=()=>{c.value.viewMode="diff",Y()},_=m(null),F=m(null);let O,A,R,C;const{result:I}=ue(()=>fetch("/_editor/api/workspace/root").then(n=>n.text())),v=m(t.script.file);se(()=>t.script.file,()=>v.value=t.script.file);const{result:b,refetch:T}=ue(()=>Ne.checkFile(v.value)),$=()=>{E.value.valid?s("update-file",Pe(v.value)):s("update-file",v.value),T()},E=X(()=>{var a;const n=Te(v.value);return n.valid?((a=b.value)==null?void 0:a.exists)&&t.script.hasChanges("file")?{valid:!0,help:"This file already exists"}:t.script.hasChanges("file")?{valid:!0,help:"The original file will be renamed"}:n:n}),P=()=>{!t.workspace||!I.value||t.workspace.openFile(".")},w=m(!1),K=async()=>{var a;if(!t.script.file)return;const n=await t.workspace.readFile(t.script.file);if(n===null){w.value=!0;return}w.value=!1,(a=c.value)==null||a.updateCode(n)},c=G(null);let H;_e(()=>{J(),H=setInterval(K,1e3)}),me(()=>{clearInterval(H)}),se(()=>t.broker,()=>{A(),U()});const U=()=>{var n,a,g;(n=t.broker)==null||n.on("execution:start",()=>{C(!0),c.value.viewMode="preview"}),(a=t.broker)==null||a.on("form:render-page",R("executing-line",t.script.file)),(g=t.broker)==null||g.on("execution:ended",x=>{var D;(D=c.value)==null||D.finishPreview(),C(!1),x.exception?R("error-line",t.script.file)(x):A()})},J=async()=>{await ge(),t.workspace.readFile(t.script.file).then(n=>{if(n===null)return;t.script.codeContent=n,t.script.updateInitialState("code_content",n),c.value=new mt(n,t.script);const a=gt(_.value,n);A=a.clearHighlights,R=a.highlight,C=a.setReadOnly,U(),O=a.editor,c.value.monacoEditor=O,O.onDidChangeModelContent(()=>{t.script.codeContent=O.getValue()})})},Y=async()=>{const n=await t.workspace.readFile(t.script.file);if(!n)return;const a=t.script.codeContent,g=_t(F.value,a,n);c.value.diffEditor=g.diffEditor};return e({restartEditor:()=>{var n;A(),C(!1),(n=c.value)==null||n.finishPreview()}}),(n,a)=>{var x,D,ne,ae;const g=ye("icon");return h(),k(oe,null,[p(i(we),{"validate-status":E.value.valid?"success":"error",help:E.value.valid?E.value.help:E.value.reason},{default:l(()=>[p(i(Ce),{value:n.script.file,"onUpdate:value":a[0]||(a[0]=W=>n.script.file=W),onBlur:$},{addonBefore:l(()=>[i(I)?(h(),k("span",{key:0,class:"clickable",onClick:P},[p(i(j),{placement:"bottomLeft","overlay-style":{maxWidth:"none"}},{title:l(()=>[y(z(i(I)),1)]),default:l(()=>[p(g,{path:i(Re)},null,8,["path"])]),_:1})])):M("",!0)]),addonAfter:l(()=>[d("span",{class:"clickable",onClick:r},[y(" Open in editor "),p(g,{path:i(Ae),width:"22"},null,8,["path"])])]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),(x=c.value)!=null&&x.alertMessage?(h(),B(i(Ke),{key:0,type:"warning","show-icon":""},{message:l(()=>{var W;return[y(z((W=c.value)==null?void 0:W.alertMessage),1)]}),action:l(()=>[c.value.conflictingChanges&&c.value.viewMode!=="diff"?(h(),B(i(de),{key:0,gap:"small"},{default:l(()=>[p(i(q),{type:"primary",onClick:f},{default:l(()=>[y("Compare")]),_:1}),p(i(j),null,{title:l(()=>[y("Keep the local editor version")]),default:l(()=>[p(i(q),{onClick:a[1]||(a[1]=W=>c.value.keepLocalEditor())},{default:l(()=>[y("Discard")]),_:1})]),_:1})]),_:1})):M("",!0),c.value.conflictingChanges&&c.value.viewMode==="diff"?(h(),B(i(de),{key:1,gap:"small"},{default:l(()=>[p(i(j),null,{title:l(()=>[y("Keep your current changes")]),default:l(()=>[p(i(q),{onClick:a[2]||(a[2]=W=>c.value.keepAbstraIDECode())},{default:l(()=>[y("Keep left")]),_:1})]),_:1}),p(i(j),null,{title:l(()=>[y("Keep the local editor version")]),default:l(()=>[p(i(q),{onClick:a[3]||(a[3]=W=>c.value.keepLocalEditor())},{default:l(()=>[y("Keep right")]),_:1})]),_:1})]),_:1})):M("",!0)]),_:1})):M("",!0),d("div",yt,[d("div",{id:"code",ref_key:"codeComponent",ref:_,class:L(["code-container",{hide:((D=c.value)==null?void 0:D.viewMode)==="diff",blur:w.value}])},null,2),w.value?(h(),B(i(Ue),{key:0,class:"not-found-popup"},{title:l(()=>[y("File not found")]),_:1})):M("",!0)]),((ne=c.value)==null?void 0:ne.viewMode)==="diff"?(h(),k("div",{key:1,id:"code",ref_key:"codeDiffComponent",ref:F,class:L(["code-container",{hide:((ae=c.value)==null?void 0:ae.viewMode)!=="diff"}])},null,2)):M("",!0)],64)}}});const Lt=ee(Ct,[["__scopeId","data-v-3e84d416"]]);export{ke as L,Ht as R,Lt as S,$t as a};
//# sourceMappingURL=SourceCode.f63ff4ea.js.map
