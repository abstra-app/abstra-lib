import{f as a,eG as ye,r as oe,H as ie,F as me,d as j,b as s,c,w as t,ev as v,eC as O,ar as y,eD as S,u as e,cM as ve,aD as P,cE as M,v as Y,ex as k,bg as he,eK as ue,e as U,eJ as V,aH as ke,cm as de,eE as Se,eF as be,o as we,L as Ae,a as Re,ae as G,dm as xe,cD as H,bG as ne}from"./outputWidgets.18a31a4b.js";import{a as ce}from"./asyncComputed.619182b9.js";import{A as Ie,s as J}from"./api.107d7ac1.js";import{t as Ce}from"./ant-design.b4c55a9c.js";import{A as z}from"./Text.2f7556a1.js";import"./index.9718bce7.js";import{A as I}from"./index.e66e1d37.js";import{r as De,t as Fe}from"./icons.d20708b7.js";import{A as pe}from"./index.7bcb0088.js";import{f as Oe}from"./index.a3ee989a.js";import{A as se}from"./Paragraph.42f17176.js";import{A as B}from"./Title.c00241dd.js";import"./index.4cb561d3.js";import{T as Pe,A as $e}from"./Timeline.81633edc.js";import{A as fe,C as _e}from"./CollapsePanel.2197e349.js";import{A as Te}from"./Link.4f092391.js";import{A as ge}from"./index.2a47a75e.js";import{A as Ee}from"./index.ee9c35c5.js";import{A as Le}from"./contracts.generated.90d804f5.js";import"./workspaces.cfa1b9b9.js";import{S as Ne}from"./scripts.9333c3cc.js";import"./envVars.7d7b88db.js";import"./index.9287d3b8.js";import{F as Ke,A as qe}from"./Form.99377304.js";import{D as Ve}from"./DownOutlined.71c4cad8.js";import{E as Be}from"./ExpandOutlined.d7ab43fa.js";import{C as Me}from"./Card.590c44d7.js";(function(){try{var l=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},n=new Error().stack;n&&(l._sentryDebugIds=l._sentryDebugIds||{},l._sentryDebugIds[n]="5a3c77a5-0b50-49f2-937f-a1a11f9e8465",l._sentryDebugIdIdentifier="sentry-dbid-5a3c77a5-0b50-49f2-937f-a1a11f9e8465")}catch{}})();var ze={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM641.7 520.8L442.3 677.6c-7.4 5.8-18.3.6-18.3-8.8V355.3c0-9.4 10.9-14.7 18.3-8.8l199.4 156.7a11.2 11.2 0 010 17.6z"}}]},name:"play-square",theme:"filled"};const Ue=ze;function le(l){for(var n=1;n<arguments.length;n++){var o=arguments[n]!=null?Object(arguments[n]):{},r=Object.keys(o);typeof Object.getOwnPropertySymbols=="function"&&(r=r.concat(Object.getOwnPropertySymbols(o).filter(function(_){return Object.getOwnPropertyDescriptor(o,_).enumerable}))),r.forEach(function(_){je(l,_,o[_])})}return l}function je(l,n,o){return n in l?Object.defineProperty(l,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):l[n]=o,l}var Z=function(n,o){var r=le({},n,o.attrs);return a(ye,le({},r,{icon:Ue}),null)};Z.displayName="PlaySquareFilled";Z.inheritAttrs=!1;const re=Z;function Q(l){switch(l.status){case"waiting":return{color:"blue",text:"Waiting"};case"running":return{color:"processing",text:"Running"};case"finished":return{color:"success",text:"Success"};case"failed":return{color:"error",text:"Failed"};case"abandoned":return{color:"warning",text:"Abandoned"}}}function Ge(){const l=oe({state:"closed"});function n(){l.value={state:"closed"}}function o(){l.value={state:"visualizations"}}function r($,w){l.value={state:"stage-run",stageRun:w}}const _=ie(()=>"stageRun"in l.value?l.value.stageRun:null);return{closeDrawer:n,openVisualizationEditor:o,inspectStageRun:r,drawerState:l,selectedStageRunForDrawer:_}}const N="kanban-selected-stage-ids",K=10;function He({kanbanRepository:l,storage:n,filterFactory:o}){const r=me([]),_=ce(async()=>{try{const u=await l.getData({selection:r.value,filter:o()}),i=await n.get(N)||[];for(const d of u.not_found_stages)n.set(N,i.filter(h=>h!==d)),r.value=r.value.filter(h=>h.stage_id!==d);return u}catch{return r.value=[],await n.set(N,[]),{columns:[],next_stage_options:[]}}});function $(u){const i=u.selected_stage.id,d=r.value.find(h=>h.stage_id===i);return d!=null&&d.limit?d.limit<u.total_count:!1}async function w(u){var d;const i=r.value.find(h=>h.stage_id===u);i&&(i.limit=((d=i.limit)!=null?d:0)+K,await _.refetch())}async function f(u){const i=r.value.find(d=>d.stage_id===u);i&&i.limit&&i.limit>K&&(i.limit-=K,await _.refetch())}async function A(){const u=await n.get(N)||[];r.value=u.map(i=>({stage_id:i,limit:K,offset:0}))}async function m(u,i){u?r.value=[...r.value.slice(0,i),{stage_id:u,limit:K,offset:0}]:r.value=r.value.slice(0,i),await n.set(N,r.value.map(d=>d.stage_id)),await _.refetch()}function T(u,i){var R;const d=(R=u.stages)==null?void 0:R.find(E=>E.id===u.selected_stage.id);if((d==null?void 0:d.type)!=="form")return null;const h=(i==null?void 0:i.status)==="waiting"?{[Ie]:i.id}:{};return{path:`/${d.path}`,query:h}}let D=null;const b=async()=>{await A(),_.refetch(),D=setInterval(()=>{_.refetch()},1e3)},C=()=>{D&&clearInterval(D)},F=ie(()=>{var i,d,h;const u=(d=(i=_.result.value)==null?void 0:i.columns)!=null?d:[];return(h=u[u.length-1])==null?void 0:h.selected_stage});return{kanbanAsyncComputed:_,selection:r,seeMore:w,hasPagination:$,seeLess:f,setNewSelectedStageId:m,launchLink:T,lastSelectedStage:F,setup:b,tearDown:C}}const W=j({__name:"StageRunData",props:{data:{}},setup(l){return(n,o)=>(s(),c(e(M),{direction:"vertical",style:{"max-height":"200px",overflow:"hidden"}},{default:t(()=>[(s(!0),v(P,null,O(n.data,r=>(s(),v("div",{key:r.key},[a(e(z),{strong:""},{default:t(()=>[y(S(r.key),1)]),_:2},1024),a(e(ve),{"tree-data":e(Ce)(r.value),style:{"pointer-events":"none"}},null,8,["tree-data"])]))),128))]),_:1}))}}),Je={key:0},We={key:1,class:"terminal"},Ye=j({__name:"ExecutionInspector",props:{logs:{}},setup(l){return(n,o)=>n.logs.length===0?(s(),v("span",Je)):(s(),v("div",We,[a(e(I),{vertical:""},{default:t(()=>[(s(!0),v(P,null,O(n.logs,r=>(s(),v("pre",{key:r.executionId,class:"log-text"},S(r.payload.text),1))),128))]),_:1})]))}});const Ze=Y(Ye,[["__scopeId","data-v-032cbeba"]]),Qe=l=>(Se("data-v-e10d3de6"),l=l(),be(),l),Xe={key:1},et={key:1},tt=Qe(()=>U("span",null,"[Deleted Stage]",-1)),at=["onClick"],nt=j({__name:"StageRunInspector",props:{stageRun:{},kanbanRepository:{},stageRunRepository:{}},emits:["close"],setup(l,{emit:n}){const o=l;function r(f){return Object.entries(f).map(([A,m])=>({key:A,value:m,type:typeof m}))}const{result:_,loading:$}=ce(()=>{var f;return o.kanbanRepository.getLogs((f=o.stageRun)==null?void 0:f.id)}),w=(f,A)=>{var m;f.stopPropagation(),(m=o.stageRunRepository)==null||m.fork(A),n("close")};return(f,A)=>(s(),c(e(Ee),{open:"",title:"Thread details",size:"large",onClose:A[0]||(A[0]=m=>n("close"))},{extra:t(()=>[a(e(se),null,{default:t(()=>[a(e(pe),{style:{"font-weight":"600"}},{default:t(()=>{var m;return[y(S(e(Q)({status:(m=f.stageRun)==null?void 0:m.status}).text),1)]}),_:1}),y(" "+S(e(Oe)(new Date(f.stageRun.created_at),{addSuffix:!0})),1)]),_:1})]),default:t(()=>{var m,T,D;return[(m=f.stageRun)!=null&&m.assignee?(s(),c(e(se),{key:0},{default:t(()=>{var b;return[y(" Assignee: "+S((b=f.stageRun)==null?void 0:b.assignee),1)]}),_:1})):k("",!0),((T=f.stageRun)==null?void 0:T.content)&&((D=f.stageRun)==null?void 0:D.content.length)>0?(s(),v("div",Xe,[a(e(B),{level:4},{default:t(()=>[y("Current data")]),_:1}),a(W,{data:f.stageRun.content},null,8,["data"])])):k("",!0),a(e(B),{level:4,style:{"margin-bottom":"30px"}},{default:t(()=>[y(" Timeline ")]),_:1}),e($)?(s(),c(e(he),{key:2})):e(_)?(s(),c(e(Pe),{key:3},{default:t(()=>[(s(!0),v(P,null,O(e(_),({stage:b,stage_run:C,logs:F})=>(s(),c(e($e),{key:C.id},{default:t(()=>[a(e(_e),{ghost:"","expand-icon-position":"end"},{default:t(()=>[a(e(fe),{class:"panel"},ue({header:t(()=>[b?(s(),c(e(I),{key:0,align:"center",gap:15},{default:t(()=>[a(V,{path:e(J)(b.type)},null,8,["path"]),F.length?(s(),v("span",et,S(b.title),1)):(s(),c(e(ke),{key:0,placement:"right",title:"No logs"},{default:t(()=>[y(S(b.title),1)]),_:2},1024))]),_:2},1024)):(s(),c(e(I),{key:1,align:"center",gap:15},{default:t(()=>[a(V,{path:e(Fe)},null,8,["path"]),tt]),_:1}))]),default:t(()=>[r(C.data).length||F.length?(s(),c(e(I),{key:0,vertical:""},{default:t(()=>[r(C.data).length?(s(),c(e(I),{key:0,gap:0,vertical:""},{default:t(()=>[a(e(B),{level:5},{default:t(()=>[y(" Output data ")]),_:1}),a(W,{data:r(C.data)},null,8,["data"])]),_:2},1024)):k("",!0),F.length?(s(),c(e(I),{key:1,vertical:"",gap:0},{default:t(()=>[a(e(ge)),a(e(B),{level:5},{default:t(()=>[y(" Logs ")]),_:1}),a(Ze,{logs:F},null,8,["logs"])]),_:2},1024)):k("",!0)]),_:2},1024)):(s(),c(e(de),{key:1,description:"No logs"}))]),_:2},[f.stageRunRepository&&b?{name:"extra",fn:t(()=>[U("span",{onClick:u=>w(u,C.id)},[a(e(I),{gap:"small"},{default:t(()=>[a(V,{path:e(De),width:"22"},null,8,["path"]),a(e(Te),null,{default:t(()=>[y("Fork")]),_:1})]),_:1})],8,at)]),key:"0"}:void 0]),1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):k("",!0)]}),_:1}))}});const st=Y(nt,[["__scopeId","data-v-e10d3de6"]]),q="Show All",lt=[q,...Le];function rt(){const l=oe(q);return{filterStatus:l,filterFactory:()=>l.value==q?{}:{status:l.value},labelOption:r=>r==q?q:Q({status:r}).text}}const ot={style:{width:"100%",padding:"20px"}},it={class:"stages-container"},ut={class:"stages-content"},dt=["onClick"],ct=j({__name:"Kanban",props:{storage:{},kanbanRepository:{},stageRunRepository:{}},setup(l){const n=l,o=async(h,R,E)=>{h.stopPropagation();const x=await Ne.get(R);!x||await x.run(E)},{filterFactory:r,filterStatus:_,labelOption:$}=rt(),{kanbanAsyncComputed:w,launchLink:f,setNewSelectedStageId:A,lastSelectedStage:m,setup:T,tearDown:D,seeMore:b,hasPagination:C}=He({kanbanRepository:n.kanbanRepository,storage:n.storage,filterFactory:r});we(T),Ae(D);const{closeDrawer:F,inspectStageRun:u,drawerState:i,selectedStageRunForDrawer:d}=Ge();return(h,R)=>{const E=Re("router-link");return s(),v("div",ot,[a(e(I),{vertical:"",style:{height:"100%"}},{default:t(()=>[a(e(_e),{ghost:""},{default:t(()=>[a(e(fe),{header:"Filters"},{default:t(()=>[a(e(Ke),null,{default:t(()=>[a(e(qe),{label:"Status"},{default:t(()=>[a(e(G),{value:e(_),"onUpdate:value":R[0]||(R[0]=x=>xe(_)?_.value=x:null),style:{width:"300px"}},{default:t(()=>[(s(!0),v(P,null,O(e(lt),x=>(s(),c(e(H),{key:x,value:x},{default:t(()=>[y(S(e($)(x)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),U("div",it,[U("div",ut,[a(e(M),{align:"start"},{default:t(()=>{var x,X,ee;return[(s(!0),v(P,null,O((X=(x=e(w).result.value)==null?void 0:x.columns)!=null?X:[],(p,te)=>(s(),c(e(M),{key:te,direction:"vertical"},{default:t(()=>[a(e(G),{style:{width:"250px"},"allow-clear":"",value:p.selected_stage.id,"onUpdate:value":g=>e(A)(g,te)},{suffixIcon:t(()=>[a(e(z),{type:"secondary",style:{"font-size":"small","margin-right":"2px"}},{default:t(()=>[y(S(p.total_count),1)]),_:2},1024),a(e(ge),{type:"vertical"}),a(e(Ve))]),default:t(()=>[(s(!0),v(P,null,O(p.stages,g=>(s(),c(e(H),{key:g.id,value:g.id},{default:t(()=>[a(e(I),{gap:"5"},{default:t(()=>[a(V,{path:e(J)(g.type),style:{"flex-shrink":"0",width:"24px"}},null,8,["path"]),a(e(z),{ellipsis:""},{default:t(()=>[y(S(g.title),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"]),p.selected_stage.id?(s(),c(e(M),{key:0,direction:"vertical",style:{width:"100%"}},{default:t(()=>[(s(!0),v(P,null,O(p.stage_run_cards,g=>{var ae;return s(),c(e(Me),{key:g.id,size:"small",style:{"max-width":"250px",cursor:"pointer"},"body-style":{display:((ae=g.content)==null?void 0:ae.length)>0?"block":"none"},onClick:L=>e(u)(p,g)},ue({title:t(()=>[a(e(pe),null,{default:t(()=>[y(S(e(Q)({status:g.status}).text),1)]),_:2},1024)]),default:t(()=>[a(W,{data:g.content},null,8,["data"]),y(" "+S(g.assignee),1)]),extra:t(()=>[a(e(Be),{onClick:L=>e(u)(p,g)},null,8,["onClick"])]),_:2},[g.status==="waiting"?{name:"actions",fn:t(()=>[e(f)(p,g)?(s(),c(E,{key:0,to:e(f)(p,g),target:"_blank",onClick:R[1]||(R[1]=L=>L.stopPropagation())},{default:t(()=>[a(e(re))]),_:2},1032,["to"])):k("",!0),p.selected_stage.type==="script"?(s(),v("span",{key:1,onClick:L=>o(L,p.selected_stage.id,g.id)},[a(e(re))],8,dt)):k("",!0)]),key:"0"}:void 0]),1032,["body-style","onClick"])}),128)),p.stage_run_cards.length===0?(s(),c(e(de),{key:0})):k("",!0),e(C)(p)?(s(),c(e(ne),{key:1,style:{width:"100%"},onClick:g=>e(b)(p.selected_stage.id)},{default:t(()=>[y("See more")]),_:2},1032,["onClick"])):k("",!0),p.selected_stage.can_be_started&&e(f)(p)!==null?(s(),c(E,{key:2,target:"_blank",to:e(f)(p)},{default:t(()=>[a(e(ne),{style:{width:"100%"}},{default:t(()=>[y(" Start ")]),_:1})]),_:2},1032,["to"])):k("",!0)]),_:2},1024)):k("",!0)]),_:2},1024))),128)),e(w).result.value&&e(w).result.value.next_stage_options.length>0?(s(),c(e(G),{key:(ee=e(m))==null?void 0:ee.id,style:{width:"100%","min-width":"200px"},"allow-clear":"","onUpdate:value":R[2]||(R[2]=p=>e(A)(p,e(w).result.value.columns.length))},{default:t(()=>[(s(!0),v(P,null,O(e(w).result.value.next_stage_options,p=>(s(),c(e(H),{key:p.id,value:p.id},{default:t(()=>[a(e(I),{gap:"middle"},{default:t(()=>[a(V,{path:e(J)(p.type)},null,8,["path"]),a(e(z),null,{default:t(()=>[y(S(p.title),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1})):k("",!0)]}),_:1})])])]),_:1}),e(i).state==="stage-run"&&e(d)?(s(),c(st,{key:0,"kanban-repository":n.kanbanRepository,"stage-run":e(d),"stage-run-repository":n.stageRunRepository,onClose:e(F)},null,8,["kanban-repository","stage-run","stage-run-repository","onClose"])):k("",!0)])}}});const qt=Y(ct,[["__scopeId","data-v-8215af9d"]]);class Vt{constructor(n,o=localStorage){this.contextKey=n,this.storage=o}makeKey(n){return`${this.contextKey}:${n}`}async get(n){const o=this.storage.getItem(this.makeKey(n));return o?JSON.parse(o):null}async set(n,o){this.storage.setItem(this.makeKey(n),JSON.stringify(o))}}export{qt as K,Vt as L};
//# sourceMappingURL=repository.f95752e7.js.map
