var x=Object.defineProperty;var B=(i,e,o)=>e in i?x(i,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[e]=o;var P=(i,e,o)=>(B(i,typeof e!="symbol"?e+"":e,o),o);import{C as T}from"./ContentLayout.129025ab.js";import{l as $}from"./fetch.1ec4f78f.js";import{E as D}from"./record.188928bf.js";import{d as _,a0 as V,y as C,b as n,eq as v,dv as E,es as k,ev as N,e as b,c as y,eG as L,w as a,ak as m,f as l,u as t,bz as z,eA as M,cw as O,eC as R,aw as H,cv as U,af as G,eB as F,aA as J,cI as K,cu as Q,ct as Z,cQ as w,cL as W,cM as X,cK as j,cJ as Y,e$ as ee}from"./outputWidgets.f7b80e9f.js";import{E as te}from"./repository.aad2edb4.js";import{a as q}from"./asyncComputed.bd2b6e70.js";import"./workspaces.9eccf428.js";import{l as A}from"./editor.ad087ecd.js";import{S as se}from"./SaveButton.07724c04.js";import{I as oe}from"./PhGlobe.vue.ae716db1.js";import{F as re}from"./PhArrowSquareOut.vue.f5352ec6.js";import{A as ae}from"./index.28e83ea9.js";import{i as le}from"./metadata.e0926a4e.js";import{A as ne}from"./index.288a68e3.js";import{A as ie}from"./index.9a5a7c1a.js";import"./pubsub.10df5fd2.js";import"./gateway.58b63376.js";import"./popupNotifcation.6f5b518c.js";import"./runnerData.5347d4ed.js";import"./url.882128c4.js";import"./index.8b4fa436.js";import"./UnsavedChangesHandler.016666b4.js";import"./ExclamationCircleOutlined.7d0f10bf.js";import"./PhCheckCircle.vue.902dac5a.js";import"./PhKanban.vue.34c60c18.js";import"./PhScroll.vue.26add44e.js";import"./PhWebhooksLogo.vue.4f41bfe0.js";(function(){try{var i=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(i._sentryDebugIds=i._sentryDebugIds||{},i._sentryDebugIds[e]="d6e45c2f-33ff-4ac8-811d-00f5657440cb",i._sentryDebugIdIdentifier="sentry-dbid-d6e45c2f-33ff-4ac8-811d-00f5657440cb")}catch{}})();const ce=["width","height","fill","transform"],ue={key:0},de=b("path",{d:"M208,76H180V56A52,52,0,0,0,76,56V76H48A20,20,0,0,0,28,96V208a20,20,0,0,0,20,20H208a20,20,0,0,0,20-20V96A20,20,0,0,0,208,76ZM100,56a28,28,0,0,1,56,0V76H100ZM204,204H52V100H204Z"},null,-1),pe=[de],fe={key:1},ge=b("path",{d:"M216,96V208a8,8,0,0,1-8,8H48a8,8,0,0,1-8-8V96a8,8,0,0,1,8-8H208A8,8,0,0,1,216,96Z",opacity:"0.2"},null,-1),he=b("path",{d:"M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80ZM96,56a32,32,0,0,1,64,0V80H96ZM208,208H48V96H208V208Z"},null,-1),me=[ge,he],ve={key:2},ye=b("path",{d:"M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80ZM96,56a32,32,0,0,1,64,0V80H96Z"},null,-1),Ce=[ye],be={key:3},_e=b("path",{d:"M208,82H174V56a46,46,0,0,0-92,0V82H48A14,14,0,0,0,34,96V208a14,14,0,0,0,14,14H208a14,14,0,0,0,14-14V96A14,14,0,0,0,208,82ZM94,56a34,34,0,0,1,68,0V82H94ZM210,208a2,2,0,0,1-2,2H48a2,2,0,0,1-2-2V96a2,2,0,0,1,2-2H208a2,2,0,0,1,2,2Z"},null,-1),we=[_e],Ve={key:4},Ae=b("path",{d:"M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80ZM96,56a32,32,0,0,1,64,0V80H96ZM208,208H48V96H208V208Z"},null,-1),He=[Ae],ke={key:5},Me=b("path",{d:"M208,84H172V56a44,44,0,0,0-88,0V84H48A12,12,0,0,0,36,96V208a12,12,0,0,0,12,12H208a12,12,0,0,0,12-12V96A12,12,0,0,0,208,84ZM92,56a36,36,0,0,1,72,0V84H92ZM212,208a4,4,0,0,1-4,4H48a4,4,0,0,1-4-4V96a4,4,0,0,1,4-4H208a4,4,0,0,1,4,4Z"},null,-1),Re=[Me],Se={name:"PhLockSimple"},Pe=_({...Se,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(i){const e=i,o=V("weight","regular"),p=V("size","1em"),g=V("color","currentColor"),h=V("mirrored",!1),s=C(()=>{var r;return(r=e.weight)!=null?r:o}),f=C(()=>{var r;return(r=e.size)!=null?r:p}),u=C(()=>{var r;return(r=e.color)!=null?r:g}),c=C(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:h?"scale(-1, 1)":void 0);return(r,d)=>(n(),v("svg",N({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:f.value,height:f.value,fill:u.value,transform:c.value},r.$attrs),[E(r.$slots,"default"),s.value==="bold"?(n(),v("g",ue,pe)):s.value==="duotone"?(n(),v("g",fe,me)):s.value==="fill"?(n(),v("g",ve,Ce)):s.value==="light"?(n(),v("g",be,we)):s.value==="regular"?(n(),v("g",Ve,He)):s.value==="thin"?(n(),v("g",ke,Re)):k("",!0)],16,ce))}});class S{constructor(e){P(this,"record");this.record=D.from(e)}get id(){return this.record.get("id")}get type(){return this.record.get("type")}get title(){return this.record.get("title")}get isPublic(){return this.record.get("is_public")}set isPublic(e){e&&this.record.set("required_roles",[]),this.record.set("is_public",e)}get requiredRoles(){return this.record.get("required_roles")}set requiredRoles(e){e.length!==0&&this.record.set("is_public",!1),this.record.set("required_roles",e)}makePublic(){this.isPublic=!0}makeProtected(){this.isPublic=!1,this.requiredRoles=[]}require(e){e.length!==0&&(this.isPublic=!1),this.requiredRoles=e}get visibility(){return this.isPublic?"public":"private"}hasChanges(){return this.record.hasChanges("is_public")||this.record.hasChangesDeep("required_roles")}get changes(){return this.record.changes}get initialState(){return this.record.initialState}toUpdateDTO(){return{id:this.id,is_public:this.isPublic,required_roles:this.requiredRoles}}commit(){this.record.commit()}static from(e){return new S(e)}}class Ze{constructor(e=$){this.fetch=e}async list(){return(await(await this.fetch("/_editor/api/access-control",{method:"GET",headers:{"Content-Type":"application/json"}})).json()).map(S.from)}async update(e){const o=e.reduce((g,h)=>(h.hasChanges()&&g.push({id:h.id,...h.changes}),g),[]);return await(await fetch("/_editor/api/access-control",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).json()}}const je=b("span",null," Project Roles ",-1),qe=_({__name:"RoleSelector",props:{value:{},roleOptions:{},disabled:{type:Boolean}},emits:["update:value"],setup(i,{emit:e}){const o=i,p=()=>{var f,u;if(!((f=A.asyncComputed.result.value)!=null&&f.logged))return;const s=(u=A.asyncComputed.result.value)==null?void 0:u.info.projectId;window.open(`https://cloud.abstra.io/projects/${s}/access-control?selected-panel=roles`,"__roles")},g=s=>{e("update:value",s)},h=_({props:{vnodes:{type:Object,required:!0}},render(){return this.vnodes}});return(s,f)=>(n(),y(t(G),{value:s.value,mode:"multiple",disabled:s.disabled,"show-arrow":"","onUpdate:value":g},L({dropdownRender:a(({menuNode:u})=>{var c;return[l(t(h),{vnodes:u},null,8,["vnodes"]),l(t(ae),{style:{margin:"4px 0"}}),(c=t(A).asyncComputed.result.value)!=null&&c.logged?(n(),y(t(z),{key:0,type:"default",style:{display:"flex","align-items":"center","justify-content":"center",width:"100%",gap:"4px"},onClick:p},{default:a(()=>[l(t(re),{size:"16"}),m(" Manage roles in Cloud Console ")]),_:1})):k("",!0)]}),default:a(()=>[l(t(U),null,{label:a(()=>[je]),default:a(()=>[(n(!0),v(H,null,M(s.roleOptions,u=>(n(),y(t(O),{key:u,value:u},{default:a(()=>[m(R(u),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:2},[o.disabled?void 0:{name:"placeholder",fn:a(()=>[m(" Leave empty to allow all listed users ")]),key:"0"}]),1032,["value","disabled"]))}}),Ie=_({__name:"AccessControlItem",props:{accessControl:{},roles:{}},emits:["update:access-control"],setup(i,{emit:e}){const o=i,p=C(()=>o.roles.map(s=>s.name)),g=s=>{s?o.accessControl.makePublic():o.accessControl.makeProtected(),e("update:access-control",o.accessControl)},h=s=>{o.accessControl.require(s),s.length!==0&&(o.accessControl.isPublic=!1),e("update:access-control",o.accessControl)};return(s,f)=>(n(),y(t(w),{justify:"space-between",align:"center",gap:"small"},{default:a(()=>[(n(),y(F(t(le)(s.accessControl.type)),{style:{"flex-shrink":"0",width:"22px",height:"18px"}})),l(t(K),{style:{width:"300px","text-overflow":"ellipsis",overflow:"hidden","white-space":"nowrap"}},{default:a(()=>[l(t(J),{title:s.accessControl.title,placement:"left",open:s.accessControl.title.length>36?void 0:!1},{default:a(()=>[m(R(s.accessControl.title),1)]),_:1},8,["title","open"])]),_:1}),l(t(w),{gap:"large",align:"center"},{default:a(()=>[l(qe,{disabled:s.accessControl.visibility==="public",style:{width:"320px"},value:s.accessControl.requiredRoles||[],"role-options":p.value||[],"onUpdate:value":f[0]||(f[0]=u=>h(u))},null,8,["disabled","value","role-options"]),l(t(Q),{value:s.accessControl.visibility},{default:a(()=>[l(t(Z),{value:"public",onChange:f[1]||(f[1]=u=>g(!0))},{default:a(()=>[l(t(w),{align:"center",gap:"small"},{default:a(()=>[m(" Public "),l(t(oe),{size:14})]),_:1})]),_:1}),l(t(Z),{value:"private",onChange:f[2]||(f[2]=u=>g(!1))},{default:a(()=>[l(t(w),{align:"center",gap:"small"},{default:a(()=>[m(" Private "),l(t(Pe),{size:14})]),_:1})]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}))}}),xe=_({__name:"DanglingRolesAlert",props:{danglingRoles:{}},setup(i){return(e,o)=>(n(),y(t(ie),{type:"warning","show-icon":"",closable:"",style:{margin:"5px"}},{description:a(()=>[l(t(W),null,{default:a(()=>[m("The following roles are not defined in the Cloud Console:")]),_:1}),(n(!0),v(H,null,M(e.danglingRoles,p=>(n(),y(t(ne),{key:p,style:{margin:"2px"},color:"red"},{default:a(()=>[m(R(p),1)]),_:2},1024))),128))]),_:1}))}}),Be=_({__name:"View",props:{accessControls:{},roles:{},loading:{type:Boolean}},emits:["update:access-controls","save"],setup(i,{emit:e}){const o=i,p=c=>{const r=o.accessControls.findIndex(d=>d.id===c.id);r!==-1&&(o.accessControls[r]=c,e("update:access-controls",[...o.accessControls]))},g=C(()=>{var c;return((c=o.accessControls)==null?void 0:c.filter(r=>r.hasChanges()))||[]}),h=C(()=>g.value.length>0),f={save:async()=>{e("save")},hasChanges:()=>h.value},u=C(()=>{const c=[...new Set(o.accessControls.flatMap(d=>d.requiredRoles)||[])],r=o.roles.map(d=>d.name)||[];return(c==null?void 0:c.filter(d=>!r.includes(d)))||[]});return(c,r)=>(n(),v(H,null,[!c.loading&&u.value.length>0?(n(),y(xe,{key:0,"dangling-roles":u.value},null,8,["dangling-roles"])):k("",!0),l(se,{model:f}),l(t(w),{vertical:"",gap:"small",style:{"margin-top":"10px"}},{default:a(()=>[(n(!0),v(H,null,M(c.accessControls,d=>(n(),y(t(w),{key:d.id},{default:a(()=>[l(Ie,{"access-control":d,roles:c.roles,"onUpdate:accessControl":p},null,8,["access-control","roles"])]),_:2},1024))),128))]),_:1})],64))}}),dt=_({__name:"AccessControlEditor",setup(i){const e=new Ze,o=C(()=>{const r=A.asyncComputed.result.value,d=r!=null&&r.logged?r==null?void 0:r.info.projectId:"";return d?`https://cloud.abstra.io/projects/${d}/access-control?selected-panel=users`:""}),{result:p,refetch:g}=q(async()=>await e.list()),h=C(()=>{var r;return((r=p.value)==null?void 0:r.filter(d=>d.hasChanges()))||[]}),s=async()=>{await e.update(h.value),await g()},f=new te,{result:u,loading:c}=q(()=>f.list(100,0));return(r,d)=>(n(),y(T,null,{default:a(()=>[l(t(X),null,{default:a(()=>[m("Access Control")]),_:1}),l(t(j),null,{default:a(()=>[m(" Set your project\u2019s pages as public, accessible to all users, or restricted to users with specific roles. ")]),_:1}),l(t(j),null,{default:a(()=>[m(" Manage users and roles on the cloud's "),l(t(Y),{href:o.value,target:"_users"},{default:a(()=>[m("Access Control tab")]),_:1},8,["href"]),m(". Settings applied here will be enforced only in the cloud environment. ")]),_:1}),t(p)?(n(),y(Be,{key:0,"access-controls":t(p),"onUpdate:accessControls":d[0]||(d[0]=I=>ee(p)?p.value=I:null),roles:t(u)||[],loading:t(c),onSave:s},null,8,["access-controls","roles","loading"])):k("",!0)]),_:1}))}});export{dt as default};
//# sourceMappingURL=AccessControlEditor.ffc4e3d5.js.map
