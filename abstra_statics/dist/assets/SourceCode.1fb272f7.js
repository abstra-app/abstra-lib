var fe=Object.defineProperty;var me=(n,s,e)=>s in n?fe(n,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[s]=e;var G=(n,s,e)=>(me(n,typeof s!="symbol"?s+"":s,e),e);import{u as Y}from"./uuid.389de0bb.js";import{F as re,d as B,r as p,S as ee,G as N,b as h,ev as m,e as a,ez as z,eE as le,eF as ie,v as K,eB as _e,H as Q,a3 as ce,o as ue,K as de,a as pe,f as _,u as c,I as T,aq as P,eD as W,ex as L,ew as ye,bq as X,eC as we,c as U,eP as Ce,eV as be,eH as ke,w as H,bH as he}from"./outputWidgets.64a2583c.js";import{g as te,k as se,l as ne,n as Se,o as xe,q as Ie}from"./icons.873ac310.js";import{l as Ee}from"./NavbarControls.05d4d406.js";import{H as Fe,J as Oe,S as Re,v as He,n as Le}from"./validations.9a599612.js";import{A as ve}from"./FormItem.ab6cb002.js";import{W as Ae}from"./workspaces.b0d1f5a0.js";import{a as ae}from"./asyncComputed.559326e2.js";import{l as Te,e as Be,R as Me}from"./toggleHighContrast.38c7d29d.js";import{A as De}from"./index.1e9dc113.js";(function(){try{var n=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},s=new Error().stack;s&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[s]="59f65966-3ce7-4489-9370-6298cba4feb8",n._sentryDebugIdIdentifier="sentry-dbid-59f65966-3ce7-4489-9370-6298cba4feb8")}catch{}})();class ge{constructor(){G(this,"logState",re({log:[]}));G(this,"_listeners",{})}static create(){return new ge}get logs(){return this.logState.log}log(s,e){if(s.type!=="restart"&&s.log.trim()==="")return;const t=e?this.logs.find(o=>o.id===e):null;return t?Object.assign(t,s):this.logs.push({...s,id:e||Y()}),this.notifyListeners(s),e}clear(){this.logState.log=[]}listen(s){const e=Y();return this._listeners[e]=s,e}unlisten(s){delete this._listeners[s]}notifyListeners(s){Object.values(this._listeners).forEach(e=>e(s))}}class $e{static async*sendMessage(s,e){var r;const o=(r=(await fetch("/_editor/api/ai/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:s,runtime:e})})).body)==null?void 0:r.getReader();if(!o)throw new Error("No response body");for(;;){const i=await o.read();if(i.done)break;yield new TextDecoder().decode(i.value)}}}const ze=n=>(le("data-v-59ca7295"),n=n(),ie(),n),Ne=ze(()=>a("div",{class:"text"}," Changes were made in your code. Click Restart to refresh the preview window. ",-1)),oe="ignoreCodeChangesWarning",Pe=B({__name:"ChangesWarning",props:{hasChanges:{type:Boolean}},setup(n){var r;const s=n,e=p((r=ee.get(oe))!=null?r:!1),t=N(()=>s.hasChanges&&!e.value),o=()=>{ee.set(oe,!0),e.value=!0};return(i,y)=>(h(),m("div",{class:z(["changes-warning",{visible:t.value}])},[Ne,a("div",{class:"no-more-alert",onClick:o},"Do not show again")],2))}});const We=K(Pe,[["__scopeId","data-v-59ca7295"]]),Ve=n=>(le("data-v-fa74f10a"),n=n(),ie(),n),Ke={class:"smart-console"},Ue={class:"header"},qe={class:"left"},je={class:"right"},Je={class:"changes-container"},Ge=["unseen-severity"],Ye={class:"cli"},Qe={class:"left"},Xe=Ve(()=>a("div",{class:"entry ai-output"}," Hello there! I'm both an output console and AI assistant. You can ask me anything. ",-1)),Ze={key:1,class:"local-entry"},et={class:"input"},tt=["pointer-events","onKeydown"],st={class:"right"},nt=B({__name:"SmartConsole",props:{inputEnabled:{type:Boolean},formCode:{},runtime:{},logService:{}},emits:["eval-request","clear-terminal","restart","enter"],setup(n,{emit:s}){const e=n,t=p(""),o=p(null),r=_e(),i=p({type:"seen"}),y=p(!1),E=p(!1),x=()=>{e.logService.clear(),s("restart")},v=()=>{C.value=C.value==="assistant"?"debugger":"assistant"};function F(l){switch(l.type){case"ai-input":return{role:"user",content:l.log};case"ai-output":return{role:"assistant",content:l.log};case"stderr":case"stdout":return{role:"user",content:l.log};case"restart":return{role:"user",content:"-- new session --"};case"files-changed":return{role:"user",content:"-- files changed --"};default:throw new Error(`Unknown log type: ${l.type}`)}}const w=N(()=>e.logService.logs.some(l=>l.type==="files-changed"));function O(){k.value=!k.value,k.value&&(i.value={type:"seen"})}Q(r,()=>{e.logService.clear(),s("clear-terminal")});const g=p(null),C=p("assistant"),f=async l=>{var I;if(l.preventDefault(),t.value=((I=g.value)==null?void 0:I.innerText)||"",l.shiftKey){document.execCommand("insertLineBreak");return}g.value&&(g.value.innerText=""),C.value==="assistant"?await A():await M()},A=async()=>{var I;if(s("enter",t.value),e.logService.log({type:"ai-input",log:t.value}),t.value="",!E.value){e.logService.log({type:"stderr",log:"Please login to use the AI assistant."});return}y.value=!0;const l={role:"user",content:(I=e.formCode)!=null?I:""};try{const R=Y();let S="";const j=$e.sendMessage([l,...e.logService.logs.map(J=>F(J)),{role:"user",content:t.value}],e.runtime);for await(const J of j)S+=J,e.logService.log({type:"ai-output",log:S},R)}catch(R){e.logService.log({type:"ai-output",log:"Sorry, I don't know how to answer that."}),console.error(R),be(R)}finally{y.value=!1}},M=async()=>{t.value&&(e.logService.log({type:"eval-input",log:`>>> ${t.value}`}),s("eval-request",t.value),t.value="")},D=()=>{e.logService.clear()};e.logService.listen(async l=>{k.value||(i.value={type:"unseen",count:i.value.type==="unseen"?i.value.count+1:1,severity:l.type==="stderr"?"error":"info"}),l.type!=="restart"&&(await ce(),o.value&&(o.value.scrollTop=o.value.scrollHeight))});const k=p(!1),q=p(400),u=N(()=>({height:`${q.value}px`})),d=p(!1),b=()=>d.value=!0,$=l=>{!d.value||(q.value=document.body.clientHeight-l.clientY)},Z=()=>d.value=!1;return ue(()=>{document.addEventListener("mousemove",$),document.addEventListener("mouseup",Z),Ee.get().then(l=>{E.value=!!l.logged})}),de(()=>{document.removeEventListener("mousemove",$),document.removeEventListener("mouseup",Z)}),(l,I)=>{const R=pe("Markdown");return h(),m("div",Ke,[a("div",Ue,[a("div",qe,[_(T,{path:C.value==="assistant"?c(te):c(se)},null,8,["path"]),P(" Smart Console ")]),a("div",je,[a("div",Je,[_(We,{"has-changes":w.value},null,8,["has-changes"]),a("button",{class:"header-button",onClick:x},"Restart")]),a("div",{class:"toggle-button",onClick:O},[_(T,{class:z(["icon",{open:k.value}]),path:c(ne),fill:"#fff"},null,8,["class","path"]),i.value.type==="unseen"?(h(),m("div",{key:0,class:"unseen-count","unseen-severity":i.value.severity},W(i.value.count),9,Ge)):L("",!0)])])]),k.value?(h(),m("div",{key:0,class:"terminal",style:ye(u.value)},[a("div",{class:"resize-handler",onMousedown:b},null,32),a("div",Ye,[a("div",Qe,[a("div",{ref_key:"entriesContainer",ref:o,class:"entries"},[Xe,(h(!0),m(X,null,we(e.logService.logs,(S,j)=>(h(),m("div",{key:j,class:z([S.type,"entry"])},[S.type==="ai-output"?(h(),U(R,{key:0,source:S.log},null,8,["source"])):(h(),m("div",Ze,W(S.type==="restart"?"-- restarted --":S.log),1))],2))),128))],512),a("div",et,[_(T,{class:z(["icon",{open:k.value}]),path:c(ne)},null,8,["class","path"]),a("div",{ref_key:"inputRef",ref:g,class:"input-text",contenteditable:"","pointer-events":y.value?"none":"auto",placeholder:"Ask AI anything",onKeydown:Ce(f,["enter"])},null,40,tt)])]),a("div",st,[a("div",{class:"icons",onClick:D},[_(T,{class:"icon",path:c(Se)},null,8,["path"])]),a("div",null,[_(T,{class:"icon clickable",path:C.value==="assistant"?c(te):c(se),onClick:I[0]||(I[0]=S=>v())},null,8,["path"])])])])],4)):L("",!0)])}}});const Ct=K(nt,[["__scopeId","data-v-fa74f10a"]]),at=B({__name:"PathInput",props:{runtime:{}},setup(n){const s=n,e=p(!1),t=async()=>{e.value=!0;const r=await(await fetch("/_editor/api/utils/normalize_path",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:s.runtime.path})})).text();r&&r!==s.runtime.path&&(s.runtime.path=r),e.value=!1};return(o,r)=>(h(),U(c(he),{value:o.runtime.path,"onUpdate:value":r[0]||(r[0]=i=>o.runtime.path=i),type:"text",disabled:e.value,onBlur:t},ke({_:2},[o.runtime instanceof c(Fe)?{name:"addonBefore",fn:H(()=>[P(" https://[your-subdomain].abstra.app/_hooks/ ")]),key:"0"}:{name:"addonBefore",fn:H(()=>[P(" https://[your-subdomain].abstra.app/ ")]),key:"1"}]),1032,["value","disabled"]))}}),ot={key:1},rt=B({__name:"RuntimeCommonSettings",props:{runtime:{}},setup(n){const s=re({pathError:null});return(e,t)=>(h(),m(X,null,[e.runtime instanceof c(Oe)||e.runtime instanceof c(Re)?L("",!0):(h(),U(c(ve),{key:0,label:"URL path"},{default:H(()=>[_(at,{runtime:e.runtime},null,8,["runtime"])]),_:1})),s.pathError?(h(),m("div",ot,W(s.pathError),1)):L("",!0)],64))}});const bt=K(rt,[["__scopeId","data-v-60a397e0"]]);let V={};function lt(n){return n in V?"\n\n```python\n"+n+" = "+V[n]+"\n```":""}Te.registerHoverProvider("python",{provideHover:function(n,s){const e=n.getWordAtPosition(s);if(!!e)return{contents:[{value:lt(e.word)}]}}});const it=(n,s,e={})=>{var x;const t=Be.create(n,{language:"python",value:s,minimap:{enabled:!1},readOnly:(x=e.readOnly)!=null?x:!1,contextmenu:!e.readOnly,automaticLayout:!e.readOnly,tabSize:4,fixedOverflowWidgets:!0,theme:e.theme?e.theme:"vs",fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:e.readOnly?0:5,scrollBeyondLastLine:!e.readOnly,renderLineHighlight:e.readOnly?"none":"all",scrollbar:{useShadows:!1,alwaysConsumeMouseWheel:!1}}),o=t.getContribution("editor.contrib.messageController");t.onDidAttemptReadOnlyEdit(()=>{o.showMessage("Use an external text editor",t.getPosition())});const r=t.createDecorationsCollection([]),i=(v,F)=>{r.set(v.map(w=>({range:new Me(w.lineno,1,w.lineno,1),options:{isWholeLine:!0,className:F}}))),V=v.reduce((w,O)=>({...w,...O.locals}),{})};return{editor:t,highlight:(v,F)=>w=>{var C,f;const g=((f=(C=w.debug)==null?void 0:C.stack)!=null?f:[]).filter(A=>A.filename.endsWith(F));i(g,v)},clearHighlights:()=>{r.clear(),V={}}}},ct=B({__name:"SourceCode",props:{script:{},workspace:{},broker:{}},emits:["update-file"],setup(n,{expose:s,emit:e}){const t=n,o=()=>{!t.script.file||t.workspace.openFile(t.script.file)},r=p(null);let i,y,E;const{result:x}=ae(()=>fetch("/_editor/api/workspace/root").then(u=>u.text())),v=p(t.script.file);Q(()=>t.script.file,()=>v.value=t.script.file);const{result:F,refetch:w}=ae(()=>Ae.checkFile(v.value)),O=()=>{g.value.valid?e("update-file",Le(v.value)):e("update-file",v.value),w()},g=N(()=>{var d;const u=He(v.value);return u.valid?((d=F.value)==null?void 0:d.exists)&&t.script.hasChanges("file")?{valid:!0,help:"This file already exists"}:t.script.hasChanges("file")?{valid:!0,help:"The original file will be renamed"}:u:u}),C=()=>{!t.workspace||!x.value||t.workspace.openFile(".")},f=p(""),A=async()=>{var b;const u=await t.workspace.readFile(t.script.file);if(!(u!==i.getValue())){f.value="";return}if(t.script.hasChanges("file")){f.value="The changes on your code will be shown after renaming the file";return}if((b=t.broker)!=null&&b.isConnected()){f.value="The changes on your code will be shown after the preview stops running";return}!t.script.file||(i.setValue(u),f.value="")};let M;ue(()=>{k(),M=setInterval(A,1e3)}),de(()=>{clearInterval(M)}),Q(()=>t.broker,()=>{y(),D()});const D=()=>{var u,d;(u=t.broker)==null||u.on("form",E("executing-line",t.script.file)),(d=t.broker)==null||d.on("program:end",b=>{b.exception?E("error-line",t.script.file)(b):y()})},k=async()=>{await ce(),t.workspace.readFile(t.script.file).then(u=>{const d=it(r.value,u,{readOnly:!0});i=d.editor,y=d.clearHighlights,E=d.highlight,D()})};return s({restartEditor:()=>{y()}}),(u,d)=>{const b=pe("icon");return h(),m(X,null,[_(c(ve),{"validate-status":g.value.valid?"success":"error",help:g.value.valid?g.value.help:g.value.reason},{default:H(()=>[_(c(he),{value:u.script.file,"onUpdate:value":d[0]||(d[0]=$=>u.script.file=$),onBlur:O},{addonBefore:H(()=>[c(x)?(h(),m("span",{key:0,class:"clickable",onClick:C},[_(b,{path:c(xe)},null,8,["path"]),a("span",null,W(c(x)),1)])):L("",!0)]),addonAfter:H(()=>[a("span",{class:"clickable",onClick:o},[P(" Open in editor "),_(b,{path:c(Ie),width:"22"},null,8,["path"])])]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),f.value?(h(),U(c(De),{key:0,message:f.value,type:"warning","show-icon":""},null,8,["message"])):L("",!0),a("div",{id:"code",ref_key:"codeComponent",ref:r,class:"code-container"},null,512)],64)}}});const kt=K(ct,[["__scopeId","data-v-5b064ecd"]]);export{ge as L,bt as R,kt as S,Ct as a};
//# sourceMappingURL=SourceCode.1fb272f7.js.map
