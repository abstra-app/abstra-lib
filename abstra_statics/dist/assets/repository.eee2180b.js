import{f as n,eG as ye,r as le,H as ie,F as me,d as B,b as r,ev as h,w as a,a$ as P,eC as F,eD as R,u as e,v as Y,c as d,cF as K,ar as y,cN as he,ex as v,bv as ve,eI as ue,e as H,eH as q,cn as ce,o as ke,L as be,a as Se,ae as U,dm as we,cE as z,bV as ne}from"./outputWidgets.5f19dc20.js";import{a as de}from"./asyncComputed.7644a573.js";import{A as Ae,s as J}from"./api.5cb63b62.js";import{r as Re}from"./icons.74432c33.js";import{A as I}from"./index.2552162f.js";import{t as xe}from"./ant-design.380befc1.js";import{A as G}from"./Text.eb392bbf.js";import{A as pe}from"./index.eb482644.js";import{f as Ce}from"./index.2f407357.js";import{A as se}from"./Paragraph.9c092968.js";import"./index.03780873.js";import{A as V}from"./Title.c51aa78c.js";import"./index.390c35ee.js";import{T as Ie,A as De}from"./Timeline.4ca3d5e2.js";import{A as fe,C as ge}from"./CollapsePanel.ca79916a.js";import{A as Pe}from"./Link.cc14adfa.js";import{A as Fe}from"./index.26b1b85e.js";import{A as Oe}from"./index.19effcbb.js";import{A as Te}from"./contracts.generated.a2ddb1e6.js";import"./workspaces.5f14b5c2.js";import{S as $e}from"./scripts.ef6025e1.js";import"./envVars.d7f42df5.js";import{F as Ee,A as Le}from"./Form.3af0c76b.js";import{E as Ne}from"./ExpandOutlined.feebc6a6.js";import{C as je}from"./Card.ed384c1f.js";import{l as _e}from"./index.1493f413.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[t]="5faa6f30-6080-468a-822a-f1678a68d86d",s._sentryDebugIdIdentifier="sentry-dbid-5faa6f30-6080-468a-822a-f1678a68d86d")}catch{}})();var Ke={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM641.7 520.8L442.3 677.6c-7.4 5.8-18.3.6-18.3-8.8V355.3c0-9.4 10.9-14.7 18.3-8.8l199.4 156.7a11.2 11.2 0 010 17.6z"}}]},name:"play-square",theme:"filled"};const Ve=Ke;function re(s){for(var t=1;t<arguments.length;t++){var o=arguments[t]!=null?Object(arguments[t]):{},l=Object.keys(o);typeof Object.getOwnPropertySymbols=="function"&&(l=l.concat(Object.getOwnPropertySymbols(o).filter(function(g){return Object.getOwnPropertyDescriptor(o,g).enumerable}))),l.forEach(function(g){qe(s,g,o[g])})}return s}function qe(s,t,o){return t in s?Object.defineProperty(s,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):s[t]=o,s}var Z=function(t,o){var l=re({},t,o.attrs);return n(ye,re({},l,{icon:Ve}),null)};Z.displayName="PlaySquareFilled";Z.inheritAttrs=!1;const oe=Z;function Q(s){switch(s.status){case"waiting":return{color:"blue",text:"Waiting"};case"running":return{color:"processing",text:"Running"};case"finished":return{color:"success",text:"Success"};case"failed":return{color:"error",text:"Failed"};case"abandoned":return{color:"warning",text:"Abandoned"}}}function Be(){const s=le({state:"closed"});function t(){s.value={state:"closed"}}function o(){s.value={state:"visualizations"}}function l(T,k){s.value={state:"stage-run",stageRun:k}}const g=ie(()=>"stageRun"in s.value?s.value.stageRun:null);return{closeDrawer:t,openVisualizationEditor:o,inspectStageRun:l,drawerState:s,selectedStageRunForDrawer:g}}const M="kanban-selected-stage-ids",N=10;function Ue({kanbanRepository:s,storage:t,filterFactory:o}){const l=me([]),g=de(async()=>{try{return await s.getData({selection:l.value,filter:o()})}catch{return l.value=[],await t.set(M,[]),{columns:[],next_stage_options:[]}}});function T(u){const i=u.selected_stage.id,f=l.value.find(S=>S.stage_id===i);return f!=null&&f.limit?f.limit<u.total_count:!1}async function k(u){var f;const i=l.value.find(S=>S.stage_id===u);i&&(i.limit=((f=i.limit)!=null?f:0)+N,await g.refetch())}async function p(u){const i=l.value.find(f=>f.stage_id===u);i&&i.limit&&i.limit>N&&(i.limit-=N,await g.refetch())}async function b(){const u=await t.get(M)||[];l.value=u.map(i=>({stage_id:i,limit:N,offset:0}))}async function m(u,i){u?l.value=[...l.value.slice(0,i),{stage_id:u,limit:N,offset:0}]:l.value=l.value.slice(0,i),await t.set(M,l.value.map(f=>f.stage_id)),await g.refetch()}function $(u,i){var w;const f=(w=u.stages)==null?void 0:w.find(E=>E.id===u.selected_stage.id);if((f==null?void 0:f.type)!=="form")return null;const S=(i==null?void 0:i.status)==="waiting"?{[Ae]:i.id}:{};return{path:`/${f.path}`,query:S}}let D=null;const x=async()=>{await b(),g.refetch(),D=setInterval(()=>{g.refetch()},1e3)},C=()=>{D&&clearInterval(D)},O=ie(()=>{var i,f,S;const u=(f=(i=g.result.value)==null?void 0:i.columns)!=null?f:[];return(S=u[u.length-1])==null?void 0:S.selected_stage});return{kanbanAsyncComputed:g,selection:l,seeMore:k,hasPagination:T,seeLess:p,setNewSelectedStageId:m,launchLink:$,lastSelectedStage:O,setup:x,tearDown:C}}const ze={key:0},Me={key:1,class:"terminal"},He=B({__name:"ExecutionInspector",props:{logs:{}},setup(s){return(t,o)=>t.logs.length===0?(r(),h("span",ze)):(r(),h("div",Me,[n(e(I),{vertical:""},{default:a(()=>[(r(!0),h(P,null,F(t.logs,l=>(r(),h("pre",{key:l.executionId,class:"log-text"},R(l.payload.text),1))),128))]),_:1})]))}});const Je=Y(He,[["__scopeId","data-v-032cbeba"]]),W=B({__name:"StageRunData",props:{data:{}},setup(s){return(t,o)=>(r(),d(e(K),{direction:"vertical",style:{"max-height":"200px","overflow-y":"hidden"}},{default:a(()=>[(r(!0),h(P,null,F(t.data,l=>(r(),d(e(K),{key:l.key},{default:a(()=>[n(e(G),{strong:""},{default:a(()=>[y(R(l.key),1)]),_:2},1024),n(e(he),{"tree-data":e(xe)(l.value)},null,8,["tree-data"])]),_:2},1024))),128))]),_:1}))}}),Ge={key:1},We=["onClick"],Ye=B({__name:"StageRunInspector",props:{stageRun:{},kanbanRepository:{},stageRunRepository:{}},emits:["close"],setup(s,{emit:t}){const o=s;function l(p){return Object.entries(p).map(([b,m])=>({key:b,value:m,type:typeof m}))}const{result:g,loading:T}=de(()=>{var p;return o.kanbanRepository.getLogs((p=o.stageRun)==null?void 0:p.id)}),k=(p,b)=>{var m;p.stopPropagation(),(m=o.stageRunRepository)==null||m.fork(b),t("close")};return(p,b)=>(r(),d(e(Oe),{open:"",title:"Thread details",size:"large",onClose:b[0]||(b[0]=m=>t("close"))},{extra:a(()=>[n(e(se),null,{default:a(()=>[n(e(pe),{style:{"font-weight":"600"}},{default:a(()=>{var m;return[y(R(e(Q)({status:(m=p.stageRun)==null?void 0:m.status}).text),1)]}),_:1}),y(" "+R(e(Ce)(new Date(p.stageRun.created_at),{addSuffix:!0})),1)]),_:1})]),default:a(()=>{var m,$,D;return[(m=p.stageRun)!=null&&m.assignee?(r(),d(e(se),{key:0},{default:a(()=>{var x;return[y(" Assignee: "+R((x=p.stageRun)==null?void 0:x.assignee),1)]}),_:1})):v("",!0),(($=p.stageRun)==null?void 0:$.content)&&((D=p.stageRun)==null?void 0:D.content.length)>0?(r(),h("div",Ge,[n(e(V),{level:4},{default:a(()=>[y("Current data")]),_:1}),n(W,{data:p.stageRun.content},null,8,["data"])])):v("",!0),n(e(V),{level:4,style:{"margin-bottom":"30px"}},{default:a(()=>[y(" Timeline ")]),_:1}),e(T)?(r(),d(e(ve),{key:2})):e(g)?(r(),d(e(Ie),{key:3},{default:a(()=>[(r(!0),h(P,null,F(e(g),({stage:x,stage_run:C,logs:O})=>(r(),d(e(De),{key:C.id},{default:a(()=>[n(e(ge),{ghost:"","expand-icon-position":"end"},{default:a(()=>[n(e(fe),{class:"panel"},ue({header:a(()=>[n(e(I),{align:"center",gap:15},{default:a(()=>[n(q,{path:e(J)(x.type)},null,8,["path"]),y(" "+R(x.title),1)]),_:2},1024)]),default:a(()=>[l(C.data).length||O.length?(r(),d(e(I),{key:0,vertical:""},{default:a(()=>[l(C.data).length?(r(),d(e(I),{key:0,gap:0,vertical:""},{default:a(()=>[n(e(V),{level:5},{default:a(()=>[y(" Input data ")]),_:1}),n(W,{data:l(C.data)},null,8,["data"])]),_:2},1024)):v("",!0),O.length?(r(),d(e(I),{key:1,vertical:"",gap:0},{default:a(()=>[n(e(Fe)),n(e(V),{level:5},{default:a(()=>[y(" Logs ")]),_:1}),n(Je,{logs:O},null,8,["logs"])]),_:2},1024)):v("",!0)]),_:2},1024)):(r(),d(e(ce),{key:1,description:"No logs"}))]),_:2},[p.stageRunRepository?{name:"extra",fn:a(()=>[H("span",{onClick:u=>k(u,C.id)},[n(e(I),{gap:"small"},{default:a(()=>[n(q,{path:e(Re),width:"22"},null,8,["path"]),n(e(Pe),null,{default:a(()=>[y("Fork")]),_:1})]),_:1})],8,We)]),key:"0"}:void 0]),1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):v("",!0)]}),_:1}))}});const Ze=Y(Ye,[["__scopeId","data-v-aaf1d2a0"]]),j="Show All",Qe=[j,...Te];function Xe(){const s=le(j);return{filterStatus:s,filterFactory:()=>s.value==j?{}:{status:s.value},labelOption:l=>l==j?j:Q({status:l}).text}}const et={style:{width:"100%",padding:"20px"}},tt={class:"stages-container"},at={class:"stages-content"},nt=["onClick"],st=B({__name:"Kanban",props:{storage:{},kanbanRepository:{},stageRunRepository:{}},setup(s){const t=s,o=async(S,w,E)=>{S.stopPropagation();const A=await $e.get(w);!A||await A.run(E)},{filterFactory:l,filterStatus:g,labelOption:T}=Xe(),{kanbanAsyncComputed:k,launchLink:p,setNewSelectedStageId:b,lastSelectedStage:m,setup:$,tearDown:D,seeMore:x,hasPagination:C}=Ue({kanbanRepository:t.kanbanRepository,storage:t.storage,filterFactory:l});ke($),be(D);const{closeDrawer:O,inspectStageRun:u,drawerState:i,selectedStageRunForDrawer:f}=Be();return(S,w)=>{const E=Se("router-link");return r(),h("div",et,[n(e(I),{vertical:"",style:{height:"100%"}},{default:a(()=>[n(e(ge),{ghost:""},{default:a(()=>[n(e(fe),{header:"Filters"},{default:a(()=>[n(e(Ee),null,{default:a(()=>[n(e(Le),{label:"Status"},{default:a(()=>[n(e(U),{value:e(g),"onUpdate:value":w[0]||(w[0]=A=>we(g)?g.value=A:null),style:{width:"300px"}},{default:a(()=>[(r(!0),h(P,null,F(e(Qe),A=>(r(),d(e(z),{key:A,value:A},{default:a(()=>[y(R(e(T)(A)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),H("div",tt,[H("div",at,[n(e(K),{align:"start"},{default:a(()=>{var A,X,ee;return[(r(!0),h(P,null,F((X=(A=e(k).result.value)==null?void 0:A.columns)!=null?X:[],(c,te)=>(r(),d(e(K),{key:te,direction:"vertical"},{default:a(()=>[n(e(U),{style:{width:"100%","min-width":"250px"},"allow-clear":"",value:c.selected_stage.id,"onUpdate:value":_=>e(b)(_,te)},{default:a(()=>[(r(!0),h(P,null,F(c.stages,_=>(r(),d(e(z),{key:_.id,value:_.id},{default:a(()=>[n(e(I),{gap:"middle"},{default:a(()=>[n(q,{path:e(J)(_.type)},null,8,["path"]),n(e(G),null,{default:a(()=>[y(R(_.title),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"]),c.selected_stage.id?(r(),d(e(K),{key:0,direction:"vertical",style:{width:"100%"}},{default:a(()=>[(r(!0),h(P,null,F(c.stage_run_cards,_=>{var ae;return r(),d(e(je),{key:_.id,size:"small",style:{"max-width":"250px",cursor:"pointer"},"body-style":{display:((ae=_.content)==null?void 0:ae.length)>0?"block":"none"},onClick:L=>e(u)(c,_)},ue({title:a(()=>[n(e(pe),null,{default:a(()=>[y(R(e(Q)({status:_.status}).text),1)]),_:2},1024)]),default:a(()=>[n(W,{data:_.content},null,8,["data"]),y(" "+R(_.assignee),1)]),extra:a(()=>[n(e(Ne),{onClick:L=>e(u)(c,_)},null,8,["onClick"])]),_:2},[_.status==="waiting"?{name:"actions",fn:a(()=>[e(p)(c,_)?(r(),d(E,{key:0,to:e(p)(c,_),target:"_blank",onClick:w[1]||(w[1]=L=>L.stopPropagation())},{default:a(()=>[n(e(oe))]),_:2},1032,["to"])):v("",!0),c.selected_stage.type==="script"?(r(),h("span",{key:1,onClick:L=>o(L,c.selected_stage.id,_.id)},[n(e(oe))],8,nt)):v("",!0)]),key:"0"}:void 0]),1032,["body-style","onClick"])}),128)),c.stage_run_cards.length===0?(r(),d(e(ce),{key:0})):v("",!0),e(C)(c)?(r(),d(e(ne),{key:1,style:{width:"100%"},onClick:_=>e(x)(c.selected_stage.id)},{default:a(()=>[y("See more")]),_:2},1032,["onClick"])):v("",!0),c.selected_stage.can_be_started&&e(p)(c)!==null?(r(),d(E,{key:2,target:"_blank",to:e(p)(c)},{default:a(()=>[n(e(ne),{style:{width:"100%"}},{default:a(()=>[y(" Start ")]),_:1})]),_:2},1032,["to"])):v("",!0)]),_:2},1024)):v("",!0)]),_:2},1024))),128)),e(k).result.value&&e(k).result.value.next_stage_options.length>0?(r(),d(e(U),{key:(ee=e(m))==null?void 0:ee.id,style:{width:"100%","min-width":"200px"},"allow-clear":"","onUpdate:value":w[2]||(w[2]=c=>e(b)(c,e(k).result.value.columns.length))},{default:a(()=>[(r(!0),h(P,null,F(e(k).result.value.next_stage_options,c=>(r(),d(e(z),{key:c.id,value:c.id},{default:a(()=>[n(e(I),{gap:"middle"},{default:a(()=>[n(q,{path:e(J)(c.type)},null,8,["path"]),n(e(G),null,{default:a(()=>[y(R(c.title),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1})):v("",!0)]}),_:1})])])]),_:1}),e(i).state==="stage-run"&&e(f)?(r(),d(Ze,{key:0,"kanban-repository":t.kanbanRepository,"stage-run":e(f),"stage-run-repository":t.stageRunRepository,onClose:e(O)},null,8,["kanban-repository","stage-run","stage-run-repository","onClose"])):v("",!0)])}}});const Ft=Y(st,[["__scopeId","data-v-aea0e511"]]);class Ot{constructor(t=_e){this.fetch=t}async getData(t){return(await this.fetch("/_editor/api/kanban",{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}})).json()}async getLogs(t){return(await this.fetch(`/_editor/api/kanban/logs/${t}`)).json()}}class Tt{constructor(t,o=_e){this.authProvider=t,this.fetch=o}get headers(){return{"Content-Type":"application/json",...this.authProvider.authHeaders()}}async getData(t){return(await this.fetch("/_kanban/",{method:"POST",body:JSON.stringify(t),headers:this.headers})).json()}async getLogs(t){return(await this.fetch(`/_kanban/logs/${t}`,{headers:this.headers})).json()}}class $t{constructor(t,o=localStorage){this.contextKey=t,this.storage=o}makeKey(t){return`${this.contextKey}:${t}`}async get(t){const o=this.storage.getItem(this.makeKey(t));return o?JSON.parse(o):null}async set(t,o){this.storage.setItem(this.makeKey(t),JSON.stringify(o))}}export{Ot as E,Ft as K,$t as L,Tt as P};
//# sourceMappingURL=repository.eee2180b.js.map
