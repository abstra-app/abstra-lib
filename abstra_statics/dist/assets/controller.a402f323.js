var j=Object.defineProperty;var C=(d,t,e)=>t in d?j(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var o=(d,t,e)=>(C(d,typeof t!="symbol"?t+"":t,e),e);import{B as r,cF as u,E as v,ej as c,g as I}from"./index.fd66f361.js";import"./linters.25176e5c.js";import{W as T}from"./workspaces.5564e380.js";import{M as $,d as b}from"./index.f303a37e.js";import{u as E}from"./uuid.0988391e.js";import{v as D,n as V,a as A,b as W}from"./validations.9d3f6d16.js";import{w as R}from"./metadata.79a32911.js";(function(){try{var d=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(d._sentryDebugIds=d._sentryDebugIds||{},d._sentryDebugIds[t]="a4731b39-9cca-4d33-8bd0-3575bea124a7",d._sentryDebugIdIdentifier="sentry-dbid-a4731b39-9cca-4d33-8bd0-3575bea124a7")}catch{}})();const _=r.object({type:r.enum(["forms","hooks"]),id:r.string(),title:r.string(),position:r.object({x:r.number(),y:r.number()}),props:r.object({path:r.string().nullable(),filename:r.string().nullable()})}),z=r.object({type:r.literal("scripts"),id:r.string(),title:r.string(),position:r.object({x:r.number(),y:r.number()}),props:r.object({filename:r.string().nullable()})}),L=r.object({type:r.literal("jobs"),id:r.string(),title:r.string(),position:r.object({x:r.number(),y:r.number()}),props:r.object({filename:r.string().nullable()})}),M=r.union([z,_,L]),U=r.object({id:r.string(),type:r.literal("task"),sourceStageId:r.string(),targetStageId:r.string(),props:r.object({taskType:r.string().nullable()})}),k=r.object({stages:r.array(M),transitions:r.array(U)}),q={"Content-Type":"application/json"};class O{async load(){const t=await fetch("/_editor/api/workflows");if(t.ok){const e=await t.json(),s=k.safeParse(e);if(s.success)return s.data;throw console.error(s.error.errors),new Error("Failed to parse initial data")}else throw new Error("Failed to fetch initial data")}async update(t){const e=await fetch("/_editor/api/workflows",{method:"PUT",headers:q,body:JSON.stringify(t)});if(e.ok){const s=await e.json(),i=k.safeParse(s);if(i.success)return i.data;throw new Error("Failed to parse updated data:",s)}else throw new Error("Failed to update workflow")}}const at=new O;function Y(){return Math.random().toString(36).slice(2,9)}class g{constructor(t){this.changes=t}apply(t){return this.changes.reduce((e,s)=>s.apply(e),t)}reverse(){return new g(this.changes.map(t=>t.reverse()).reverse())}}class x{constructor(t){o(this,"removed");this.stageId=t,this.removed=null}apply(t){const e=t.stages.find(i=>i.id===this.stageId)||null;if(!e)throw new Error(`Stage ${this.stageId} not found`);const s=t.transitions.filter(i=>i.sourceStageId===this.stageId||i.targetStageId===this.stageId);return this.removed={stage:e,transitions:s},{stages:t.stages.filter(i=>i.id!==e.id),transitions:t.transitions.filter(i=>!s.find(n=>n.id===i.id))}}reverse(){if(!this.removed)throw new Error("Cannot reverse change that was not applied");const t=new P(this.removed.stage.type,this.removed.stage.title,this.removed.stage.position,this.removed.stage.id,this.removed.stage.props),e=this.removed.transitions.map(s=>new S(s.sourceStageId,s.targetStageId,s.type,s.id));return new g([t,...e])}}class P{constructor(t,e,s,i,n){o(this,"addedStage");this.stageType=t,this.nodeTitle=e,this.position=s,this.id=i,this.props=n,this.addedStage=null}assertStageDoesNotExist(t){if(t.stages.find(e=>e.id===this.id))throw new Error(`Stage ${this.id} already exists`)}assertValidStageType(){if(!R.stages.find(t=>t.typeName===this.stageType))throw new Error(`Invalid stage type ${this.stageType}`)}assertTransitionDoesNotExist(t){if(t.transitions.find(e=>e.sourceStageId===this.id||e.targetStageId===this.id))throw new Error("Stage already has transitions")}makePath(t){switch(this.stageType){case"forms":return`new-form-${t}`;case"hooks":return`new-hook-${t}`;default:return null}}makeFilename(t){switch(this.stageType){case"forms":return`form_${t}.py`;case"hooks":return`hook_${t}.py`;case"jobs":return`job_${t}.py`;case"scripts":return`tasklet_${t}.py`;default:return null}}apply(t){var s,i;const e=Y();switch(this.assertStageDoesNotExist(t),this.assertValidStageType(),this.assertTransitionDoesNotExist(t),this.stageType){case"forms":case"hooks":{const n={path:this.makePath(e),filename:this.makeFilename(e),...this.props};this.addedStage={id:(s=this.id)!=null?s:E(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:n};break}case"jobs":case"scripts":{const n={filename:this.makeFilename(e),...this.props};this.addedStage={id:(i=this.id)!=null?i:E(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:n};break}default:throw new Error(`Invalid stage type ${this.stageType}`)}if(!this.addedStage)throw new Error("Stage not created");return{transitions:t.transitions,stages:[...t.stages,this.addedStage]}}reverse(){if(!this.addedStage)throw new Error("Cannot reverse change that was not applied");return new x(this.addedStage.id)}}class G extends g{constructor(t){super(t.map(e=>new P(e.type,e.title,e.position,e.id)))}}class N{constructor(t){o(this,"removedTransition");this.transitionId=t,this.removedTransition=null}apply(t){const e=t.transitions.find(s=>s.id===this.transitionId);if(!e)throw new Error(`Transition ${this.transitionId} not found`);return this.removedTransition=e!=null?e:null,{stages:t.stages,transitions:t.transitions.filter(s=>s.id!==this.transitionId)}}reverse(){if(!this.removedTransition)throw new Error("Cannot reverse change that was not applied");return new S(this.removedTransition.sourceStageId,this.removedTransition.targetStageId,this.removedTransition.type,this.removedTransition.id)}}class S{constructor(t,e,s,i){o(this,"addedTransition");this.sourceStageId=t,this.targetStageId=e,this.transitionType=s,this.transitionId=i,this.addedTransition=null}assertSourceStageExists(t){if(!t.stages.find(e=>e.id===this.sourceStageId))throw new Error(`Stage ${this.sourceStageId} not found`)}assertTargetStageExists(t){if(!t.stages.find(e=>e.id===this.targetStageId))throw new Error(`Stage ${this.targetStageId} not found`)}assertTransitionDoesNotExist(t){if(t.transitions.find(e=>e.id===this.transitionId))throw new Error(`Transition ${this.transitionId} already exists`)}assertNotSelfTransition(){if(this.sourceStageId===this.targetStageId)throw new Error("Self transitions are not allowed")}assertNoDuplicatedTransitionStages(t){if(t.transitions.find(e=>e.sourceStageId===this.sourceStageId&&e.targetStageId===this.targetStageId))throw u.error({message:"Invalid transition",description:"Transition already exists"}),new Error("Transition already exists")}assertNoStageWithSameId(t){if(t.stages.find(e=>e.id===this.transitionId))throw new Error(`Stage with id ${this.transitionId} already exists`)}apply(t){return this.assertSourceStageExists(t),this.assertTargetStageExists(t),this.assertTransitionDoesNotExist(t),this.assertNotSelfTransition(),this.assertNoDuplicatedTransitionStages(t),this.assertNoStageWithSameId(t),this.addedTransition={id:this.transitionId,sourceStageId:this.sourceStageId,targetStageId:this.targetStageId,type:this.transitionType,props:{taskType:null}},{stages:t.stages,transitions:[...t.transitions,this.addedTransition]}}reverse(){if(!this.addedTransition)throw new Error("Cannot reverse change that was not applied");return new N(this.addedTransition.id)}}class H extends g{constructor(t){super(t.map(e=>new S(e.sourceStageId,e.targetStageId,e.type,e.id)))}}class f{constructor(t){o(this,"oldPositions");this.newPositions=t,this.oldPositions=null}assertStagesExists(t){this.newPositions.forEach(({id:e})=>{if(!t.stages.find(s=>s.id===e))throw new Error(`Stage ${e} not found`)})}assertIsNumber(){this.newPositions.forEach(({position:t})=>{if(Number.isNaN(t.x)||Number.isNaN(t.y)||!Number.isFinite(t.x)||!Number.isFinite(t.y))throw new Error("Position must be a number")})}apply(t){return this.assertIsNumber(),this.assertStagesExists(t),this.oldPositions=t.stages.map(s=>({id:s.id,position:s.position})),{stages:t.stages.map(s=>{var n,a;const i=(a=(n=this.newPositions.find(l=>l.id===s.id))==null?void 0:n.position)!=null?a:s.position;return{...s,position:{x:i.x,y:i.y}}}),transitions:t.transitions}}reverse(){if(!this.oldPositions)throw new Error("Cannot reverse change that was not applied");return new f(this.oldPositions)}}class w{constructor(t,e){o(this,"stageId");o(this,"newTitle");o(this,"oldTitle");this.stageId=t,this.newTitle=e,this.oldTitle=""}assertStageExists(t){if(!t.stages.find(e=>e.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}apply(t){return this.assertStageExists(t),this.oldTitle=t.stages.find(e=>e.id===this.stageId).title,{stages:t.stages.map(e=>e.id===this.stageId?{...e,title:this.newTitle}:e),transitions:t.transitions}}reverse(){return new w(this.stageId,this.oldTitle)}}class m{constructor(t,e){o(this,"stageId");o(this,"newProps");o(this,"oldProps");this.stageId=t,this.newProps=e}assertStageExists(t){if(!t.stages.find(e=>e.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}assertValidPath(){if(!("path"in this.newProps)||!this.newProps.path)return;const t=D(this.newProps.path);if(!t.valid){u.error({message:"Invalid path",description:t.reason});return}this.newProps.path=V(this.newProps.path)}assertValidFilename(){if(!("filename"in this.newProps)||!this.newProps.filename)return;const t=A(this.newProps.filename);if(!t.valid){u.error({message:"Invalid filename",description:t.reason});return}this.newProps.filename=W(this.newProps.filename)}apply(t){return this.assertStageExists(t),this.assertValidPath(),this.assertValidFilename(),this.oldProps=t.stages.find(e=>e.id===this.stageId).props,{stages:t.stages.map(e=>e.id===this.stageId?{...e,props:this.newProps}:e),transitions:t.transitions}}reverse(){return new m(this.stageId,this.oldProps)}}class y{constructor(t,e){o(this,"newProps");o(this,"transitionId");o(this,"oldProps");this.newProps=e,this.transitionId=t,this.oldProps=e}apply(t){return{transitions:t.transitions.map(e=>e.id===this.transitionId?(this.oldProps=e.props,{...e,props:this.newProps}):e),stages:t.stages}}reverse(){return new y(this.transitionId,this.oldProps)}}class B extends g{constructor(t,e){super([...e.map(s=>new N(s)),...t.map(s=>new x(s))])}}class J{constructor(t,e){o(this,"currentState");o(this,"serverState");o(this,"undoStack");o(this,"redoStack");o(this,"save");this.undoStack=[],this.redoStack=[],this.currentState=v(Object.freeze(t)),this.serverState=v(Object.freeze(t)),this.save=e}apply(t){return this.currentState.value=t.apply(this.currentState.value),this.undoStack.push(t),this.redoStack=[],this.save(),this.currentState.value}canUndo(){return this.undoStack.length>0}undo(){const t=this.undoStack.pop();if(t){const e=t.reverse();this.currentState.value=e.apply(this.currentState.value),this.redoStack.push(t)}return this.save(),this.currentState.value}canRedo(){return this.redoStack.length>0}redo(){const t=this.redoStack.pop();return t&&(this.currentState.value=t.apply(this.currentState.value),this.undoStack.push(t)),this.currentState.value}getState(){return this.currentState.value}setServerState(t){this.serverState.value=t}getServerState(){return this.serverState.value}hasStageChanges(){return!c.exports.isEqual(this.currentState.value.stages,this.serverState.value.stages)}hasChanges(){const t={...this.currentState.value,stages:[...this.currentState.value.stages].sort((s,i)=>s.id.localeCompare(i.id)),transitions:[...this.currentState.value.transitions].sort((s,i)=>s.id.localeCompare(i.id))},e={...this.serverState.value,stages:[...this.serverState.value.stages].sort((s,i)=>s.id.localeCompare(i.id)),transitions:[...this.serverState.value.transitions].sort((s,i)=>s.id.localeCompare(i.id))};return!c.exports.isEqual(t,e)}stageHasChanges(t){const e=this.currentState.value.stages.find(i=>i.id===t),s=this.serverState.value.stages.find(i=>i.id===t);return!c.exports.isEqual(e,s)}stageHasNonPositionChanges(t){const e=this.currentState.value.stages.find(i=>i.id===t),s=this.serverState.value.stages.find(i=>i.id===t);return!c.exports.isEqual(c.exports.omit(e,"position"),c.exports.omit(s,"position"))}}const X=2;class F{constructor(t,e,s){o(this,"api");o(this,"editable");o(this,"history");o(this,"vueFlowNodes");o(this,"vueFlowEdges");this.editable=s,this.api=t,this.history=new J(e,c.exports.debounce(()=>this.save(),1e3)),this.vueFlowNodes=I(()=>this.computeVueFlowNodes()),this.vueFlowEdges=I(()=>this.computeVueFlowEdges())}static async init(t,e){const s=await t.load();return new F(t,s,e)}async refetch(){const t=await this.api.load();this.history.setServerState(t),this.history.currentState.value=t}inflateYFactor(){return this.editable?1:X}computeVueFlowNodes(){return this.history.getState().stages.map(e=>({id:e.id,type:e.type,data:e,position:{x:e.position.x,y:e.position.y*this.inflateYFactor()}}))}computeVueFlowEdges(){return this.history.getState().transitions.map(e=>({id:e.id,source:e.sourceStageId,target:e.targetStageId,type:"task",label:"task",markerEnd:{type:$.Arrow,width:24,height:24},data:e}))}getStage(t){var e;return(e=this.history.getState().stages.find(s=>s.id===t))!=null?e:null}getUnsavedFilenameStages(){const t=this.history.getState(),e=this.history.getServerState(),s=t.stages.map(a=>a.id),i=e.stages.map(a=>a.id),n=s.filter(a=>{if(!i.includes(a))return!0;const l=t.stages.find(p=>p.id===a),h=e.stages.find(p=>p.id===a);if(!l||!h)return!1;if("filename"in l.props&&"filename"in h.props)return l.props.filename!==h.props.filename});return t.stages.filter(a=>n.includes(a.id))}getUnsavedNewStages(){const t=this.history.getState(),e=this.history.getServerState(),s=t.stages.map(a=>a.id),i=e.stages.map(a=>a.id),n=s.filter(a=>!i.includes(a));return t.stages.filter(a=>n.includes(a.id))}updateStageTitle(t,e){this.history.apply(new w(t,e))}updateStageProps(t,e){this.history.apply(new m(t,e))}addStages(t){const e=t[0].type.slice(0,-1),s=e==="script"?"tasklet":e;return this.history.apply(new G(t.map(i=>{var n;return{...i,title:(n=i.title)!=null?n:`New ${s}`}}))),this.history.getState().stages.slice(-t.length)}connect(t){this.history.apply(new H(t))}move(t){this.history.apply(new f(t))}delete(t){const e=this.history.getState(),s=e.stages.filter(n=>t.includes(n.id)).map(n=>n.id),i=e.transitions.filter(n=>t.includes(n.id)).map(n=>n.id);this.history.apply(new B(s,i))}updateTransitionProps(t,e){this.history.apply(new y(t,e))}hasChanges(){return this.history.hasChanges()}edgeIsLonely(t){const e=this.history.getState(),s=e.transitions.find(a=>a.id===t);if(!s)return!0;const{sourceStageId:i,targetStageId:n}=s;for(const a of e.transitions)if(a.id!==t&&(a.sourceStageId===i&&a.targetStageId===n||a.sourceStageId===n&&a.targetStageId===i))return!1;return!0}async save(){const t=this.getUnsavedNewStages();if(this.history.hasChanges()){const e=await this.api.update(this.history.getState());this.history.setServerState(e)}t.forEach(async e=>{"filename"in e.props&&e.props.filename&&((await T.checkFile(e.props.filename)).exists||T.initFile(e.props.filename,e.type))})}autoLayout(t={}){if(!this.editable)return;const e=this.history.getState();if(e.stages.length===0)return;const{direction:s="LR",distanceX:i=200,distanceY:n=80}=t,a=new b.graphlib.Graph;a.setDefaultEdgeLabel(()=>({})),a.setGraph({rankdir:s,nodesep:i,ranksep:n});for(const h of e.stages)a.setNode(h.id,{width:250,height:50});for(const h of e.transitions)a.setEdge(h.sourceStageId,h.targetStageId);b.layout(a);const l=e.stages.map(h=>{const p=a.node(h.id);return{id:h.id,position:{x:p.x,y:p.y}}});this.move(l)}}export{O as E,F as W,Y as g,at as w};
//# sourceMappingURL=controller.a402f323.js.map
