import{k as j,A as ut,C as dt}from"./router.cc3a61f0.js";import{d as W,at as z,c as T,o as g,ac as y,ae as gt,h as k,ew as ft,e as H,v as pt,r as V,al as L,eH as ht,w as F,a as S,b as v,aY as et,eB as at,ad as mt,t as $,u as d,dj as G,bV as xt,df as R,g as D,_ as ot,f as b,i as w,b0 as q,ez as yt,d6 as vt,cM as O}from"./jwt-decode.esm.a6723498.js";import{B as _t}from"./build.d297a390.js";import{c as nt}from"./string.0fcb2f7e.js";import"./tables.10e48acd.js";import{u as wt}from"./polling.235055c7.js";import{t as bt}from"./ant-design.e466d69a.js";import{I as tt}from"./PhCopy.vue.d2d06834.js";import{b as At}from"./index.26eeb37b.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[t]="34c17f9b-96fb-4f27-a7d0-4238ff5dbb3d",o._sentryDebugIdIdentifier="sentry-dbid-34c17f9b-96fb-4f27-a7d0-4238ff5dbb3d")}catch{}})();const kt=["width","height","fill","transform"],Ht={key:0},St=H("path",{d:"M72,104a16,16,0,1,1,16,16A16,16,0,0,1,72,104Zm96,16a16,16,0,1,0-16-16A16,16,0,0,0,168,120Zm68-40V192a36,36,0,0,1-36,36H56a36,36,0,0,1-36-36V80A36,36,0,0,1,56,44h60V16a12,12,0,0,1,24,0V44h60A36,36,0,0,1,236,80Zm-24,0a12,12,0,0,0-12-12H56A12,12,0,0,0,44,80V192a12,12,0,0,0,12,12H200a12,12,0,0,0,12-12Zm-12,82a30,30,0,0,1-30,30H86a30,30,0,0,1,0-60h84A30,30,0,0,1,200,162Zm-80-6v12h16V156ZM86,168H96V156H86a6,6,0,0,0,0,12Zm90-6a6,6,0,0,0-6-6H160v12h10A6,6,0,0,0,176,162Z"},null,-1),Zt=[St],Ct={key:1},Et=H("path",{d:"M200,56H56A24,24,0,0,0,32,80V192a24,24,0,0,0,24,24H200a24,24,0,0,0,24-24V80A24,24,0,0,0,200,56ZM164,184H92a20,20,0,0,1,0-40h72a20,20,0,0,1,0,40Z",opacity:"0.2"},null,-1),Vt=H("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Zm4,28H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24Z"},null,-1),It=[Et,Vt],Pt={key:2},jt=H("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48ZM172,96a12,12,0,1,1-12,12A12,12,0,0,1,172,96ZM96,184H80a16,16,0,0,1,0-32H96ZM84,120a12,12,0,1,1,12-12A12,12,0,0,1,84,120Zm60,64H112V152h32Zm32,0H160V152h16a16,16,0,0,1,0,32Z"},null,-1),Tt=[jt],$t={key:3},Dt=H("path",{d:"M200,50H134V16a6,6,0,0,0-12,0V50H56A30,30,0,0,0,26,80V192a30,30,0,0,0,30,30H200a30,30,0,0,0,30-30V80A30,30,0,0,0,200,50Zm18,142a18,18,0,0,1-18,18H56a18,18,0,0,1-18-18V80A18,18,0,0,1,56,62H200a18,18,0,0,1,18,18ZM74,108a10,10,0,1,1,10,10A10,10,0,0,1,74,108Zm88,0a10,10,0,1,1,10,10A10,10,0,0,1,162,108Zm2,30H92a26,26,0,0,0,0,52h72a26,26,0,0,0,0-52Zm-22,12v28H114V150ZM78,164a14,14,0,0,1,14-14h10v28H92A14,14,0,0,1,78,164Zm86,14H154V150h10a14,14,0,0,1,0,28Z"},null,-1),Mt=[Dt],zt={key:4},Lt=H("path",{d:"M200,48H136V16a8,8,0,0,0-16,0V48H56A32,32,0,0,0,24,80V192a32,32,0,0,0,32,32H200a32,32,0,0,0,32-32V80A32,32,0,0,0,200,48Zm16,144a16,16,0,0,1-16,16H56a16,16,0,0,1-16-16V80A16,16,0,0,1,56,64H200a16,16,0,0,1,16,16Zm-52-56H92a28,28,0,0,0,0,56h72a28,28,0,0,0,0-56Zm-24,16v24H116V152ZM80,164a12,12,0,0,1,12-12h8v24H92A12,12,0,0,1,80,164Zm84,12h-8V152h8a12,12,0,0,1,0,24ZM72,108a12,12,0,1,1,12,12A12,12,0,0,1,72,108Zm88,0a12,12,0,1,1,12,12A12,12,0,0,1,160,108Z"},null,-1),Ot=[Lt],Rt={key:5},Bt=H("path",{d:"M200,52H132V16a4,4,0,0,0-8,0V52H56A28,28,0,0,0,28,80V192a28,28,0,0,0,28,28H200a28,28,0,0,0,28-28V80A28,28,0,0,0,200,52Zm20,140a20,20,0,0,1-20,20H56a20,20,0,0,1-20-20V80A20,20,0,0,1,56,60H200a20,20,0,0,1,20,20ZM76,108a8,8,0,1,1,8,8A8,8,0,0,1,76,108Zm88,0a8,8,0,1,1,8,8A8,8,0,0,1,164,108Zm0,32H92a24,24,0,0,0,0,48h72a24,24,0,0,0,0-48Zm-20,8v32H112V148ZM76,164a16,16,0,0,1,16-16h12v32H92A16,16,0,0,1,76,164Zm88,16H152V148h12a16,16,0,0,1,0,32Z"},null,-1),Nt=[Bt],Ft={name:"PhRobot"},qt=W({...Ft,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(o){const t=o,a=z("weight","regular"),i=z("size","1em"),f=z("color","currentColor"),n=z("mirrored",!1),l=T(()=>{var r;return(r=t.weight)!=null?r:a}),c=T(()=>{var r;return(r=t.size)!=null?r:i}),m=T(()=>{var r;return(r=t.color)!=null?r:f}),x=T(()=>t.mirrored!==void 0?t.mirrored?"scale(-1, 1)":void 0:n?"scale(-1, 1)":void 0);return(r,E)=>(g(),y("svg",ft({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:c.value,height:c.value,fill:m.value,transform:x.value},r.$attrs),[gt(r.$slots,"default"),l.value==="bold"?(g(),y("g",Ht,Zt)):l.value==="duotone"?(g(),y("g",Ct,It)):l.value==="fill"?(g(),y("g",Pt,Tt)):l.value==="light"?(g(),y("g",$t,Mt)):l.value==="regular"?(g(),y("g",zt,Ot)):l.value==="thin"?(g(),y("g",Rt,Nt)):k("",!0)],16,kt))}}),Gt=["running","lock-failed","failed","finished","abandoned"];class B{constructor(t){this.dto=t}static from(t){return new B(t)}get entries(){return this.dto.sort((t,a)=>t.sequence-a.sequence).filter(t=>t.event!=="form-message")}}class N{constructor(t){this.dto=t}static from(t){return new N(t)}get id(){return this.dto.id}get shortId(){return this.dto.id.slice(0,8)}get createdAt(){return new Date(this.dto.createdAt)}get updatedAt(){return new Date(this.dto.updatedAt)}get status(){return this.dto.status}get context(){return this.dto.context}get buildId(){var t;return(t=this.dto.buildId)!=null?t:""}get stageId(){return this.dto.stageId}get duration_seconds(){return this.status==="running"?"-":`${(this.updatedAt.getTime()-this.createdAt.getTime())/1e3} s`}get stageRunId(){return this.dto.stageRunId}get projectId(){return this.dto.projectId}}class ue{async list({projectId:t,...a}){var n,l;const i={...a,offset:(n=a.offset)==null?void 0:n.toString(),limit:(l=a.limit)==null?void 0:l.toString()};Object.keys(i).forEach(c=>i[c]===void 0&&delete i[c]);const f=await j.get(`projects/${t}/executions`,i);return{executions:f.executions.map(c=>N.from(c)),totalCount:f.totalCount}}async fetchLogs(t,a,i){const f={};(i==null?void 0:i.limit)!==void 0&&(f.limit=i.limit.toString()),(i==null?void 0:i.offset)!==void 0&&(f.offset=i.offset.toString());const n=Object.keys(f).length>0?`?${new URLSearchParams(f).toString()}`:"",l=await j.get(`projects/${t}/executions/${a}/logs${n}`);return{logs:B.from(l.logs),totalCount:l.totalCount}}async fetchThreadData(t,a){return(await j.get(`projects/${t}/executions/${a}/thread-data`)).response}async getExecutionTasks(t,a){return await j.get(`projects/${t}/executions/${a}/tasks`)}async fetchStages(){throw new Error("Method not implemented.")}async stopExecution(t){await j.post(`executions/${t}/stop`,{})}}class de{async list(t){var c,m;const a={...t,offset:(c=t.offset)==null?void 0:c.toString(),limit:(m=t.limit)==null?void 0:m.toString()};Object.keys(a).forEach(x=>a[x]===void 0&&delete a[x]);const i=Object.fromEntries(Object.entries(a!=null?a:{}).filter(([,x])=>x!=null)),f=Object.keys(i).length>0?`?${new URLSearchParams(i).toString()}`:"",l=await(await fetch(`/_editor/api/executions${f}`)).json();return{executions:l.executions.map(x=>N.from(x)),totalCount:l.totalCount}}async fetchLogs(t,a,i){const n=await(await fetch(`/_editor/api/logs/${a}`)).json();return{logs:B.from(n),totalCount:n.length}}async fetchThreadData(){return{}}async getExecutionTasks(t,a){return await(await fetch(`/_editor/api/executions/${a}/tasks`)).json()}async fetchStages(){return await(await fetch("/_editor/api/executions/stages")).json()}async stopExecution(t){const a=await fetch(`/_editor/api/executions/${t}/stop`,{method:"POST"});if(!a.ok)throw new Error(`Failed to stop execution: ${a.statusText}`)}}const M=300,ge=pt("logs",()=>{const o=V(null),t=V(null),a=V(""),i=V(!1),f=V(),n=L({openedExecutionIds:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],executionData:{}}),l=L({currentIndex:1,pageSize:10,totalCount:0}),c=L({dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0}),m=L({builds:[],stages:[],statuses:Gt.map(e=>({label:nt(e),value:e}))}),x=wt({task:()=>Q(),interval:1e4}),r=async e=>{var u;o.value=e.executionRepository,t.value=e.buildRepository,a.value=e.projectId,i.value=(u=e.pool)!=null?u:!1,f.value=e.onFilterChange,Object.assign(c,e.filters||{}),Object.assign(l,e.pagination||{}),e.openedExecutionId&&(n.openedExecutionIds=[e.openedExecutionId]),await Promise.all([_(),J()]),U(),i.value&&x.startPolling()},E=()=>{x.endPolling()},_=async()=>{var e,u,s,p;if(!!o.value){n.loadingExecutions=!0;try{const{executions:h,totalCount:A}=await o.value.list({projectId:a.value,buildId:c.buildId,status:c.status,limit:l.pageSize,offset:(l.currentIndex-1)*l.pageSize,stageId:c.stageId,startDate:(u=(e=c.dateRange)==null?void 0:e[0])==null?void 0:u.toISOString(),endDate:(p=(s=c.dateRange)==null?void 0:s[1])==null?void 0:p.toISOString(),search:c.search});n.executions=h,l.totalCount=A}finally{n.loadingExecutions=!1}}},Z=async()=>{if(!t.value){m.builds=[];return}const u=(await t.value.list(a.value)).map(s=>({label:`[${s.id.slice(0,8)}] ${s.createdAt.toLocaleString()} ${s.latest?"(Latest)":""}`,value:s.id}));m.builds=u},I=async()=>{var p;if(!o.value)return;if(!t.value){const A=(await o.value.fetchStages()).map(C=>({label:C.title,value:C.id}));m.stages=A!=null?A:[];return}const e=(p=c.buildId)!=null?p:m.builds.length>0?m.builds[0].value:void 0;if(!e){console.warn("No buildId available for fetching stage options"),m.stages=[];return}const u=await _t.get(e),s=u==null?void 0:u.runtimes.map(h=>({label:h.title,value:h.id}));m.stages=s!=null?s:[]},J=async()=>{try{await Z(),await I()}catch(e){console.error("Error fetching options:",e)}},P=async(e,u)=>{if(!o.value)return;const s=n.executionData[e],p=u||{limit:M,offset:0},[h,A,C]=await Promise.all([o.value.fetchLogs(a.value,e,p),o.value.fetchThreadData(a.value,e),o.value.getExecutionTasks(a.value,e)]),ct={currentIndex:1,pageSize:M,totalCount:h.totalCount,loading:!1};n.executionData[e]={logs:h.logs,threadData:A,tasks:{triggerTask:C.triggerTask?{type:C.triggerTask.type,payload:C.triggerTask.payload}:null,sentTasks:C.sentTasks.map(K=>({type:K.type,payload:K.payload}))},logsPagination:(s==null?void 0:s.logsPagination)||ct},n.executionData[e].logsPagination&&(n.executionData[e].logsPagination.totalCount=h.totalCount,n.executionData[e].logsPagination.loading=!1)},U=()=>{n.openedExecutionIds.forEach(async e=>{n.executionData[e]||await P(e,{limit:M,offset:0})})},Q=async()=>{n.openedExecutionIds.map(e=>{const u=n.executions.find(p=>p.id===e);if(!u||u.status!=="running")return;const s=n.executionData[e];if(s!=null&&s.logsPagination){const{currentIndex:p,pageSize:h}=s.logsPagination,A=(p-1)*h;return P(e,{limit:h,offset:A})}else return P(e,{limit:M,offset:0})})},Y=()=>{n.waitingDebounce=!0,l.currentIndex=1,st(),f.value&&f.value(c)},st=ht.exports.debounce(async()=>{await _(),n.waitingDebounce=!1},500),it=async e=>{let u=n.executions;return e&&(u=u.filter(p=>p.stageId===e)),u.length===0?null:u.reduce((p,h)=>p.createdAt>h.createdAt?p:h).id},X=async(e,u)=>{const s=n.executionData[e];if(!(s!=null&&s.logsPagination))return;const{pageSize:p}=s.logsPagination;s.logsPagination.loading=!0,s.logsPagination.currentIndex=u;const h=(u-1)*p;await P(e,{limit:p,offset:h})},rt=(e,u)=>{const s=n.executionData[e];!(s!=null&&s.logsPagination)||(s.logsPagination.pageSize=u,s.logsPagination.currentIndex=1,X(e,1))},lt=async e=>{!o.value||(await o.value.stopExecution(e),await _())};return F(()=>c.buildId,()=>{I()}),F(c,()=>{n.openedExecutionIds=[],Y()}),F([()=>l.currentIndex,()=>l.pageSize],()=>{n.openedExecutionIds=[],_()}),{state:T(()=>({currentPage:n,pagination:l,filters:c,filterOptions:m})),currentPage:n,pagination:l,filters:c,filterOptions:m,init:r,teardown:E,fetchPage:_,fetchBuildOptions:Z,fetchStageOptions:I,fetchOptions:J,fetchExecutionDetails:P,fetchEmptyLogs:U,refetch:Q,handleFilterChange:Y,getNewestExecutionId:it,fetchExecutionLogsPage:X,setExecutionLogsPageSize:rt,stopExecution:lt,polling:x}}),Wt={key:0,class:"cli"},Jt={key:0},Ut=W({__name:"LogContainer",props:{logs:{},pagination:{}},emits:["page-change"],setup(o){return(t,a)=>(g(),S(d(G),{vertical:"",gap:"small"},{default:v(()=>[o.logs.entries.length?(g(),y("div",Wt,[(g(!0),y(et,null,at(o.logs.entries,i=>(g(),y("p",{key:i.createdAt,style:mt({margin:0,"white-space":"pre-wrap",color:i.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},[i.payload.text?(g(),y("span",Jt,$(i.payload.text.trim()),1)):k("",!0)],4))),128))])):k("",!0),o.pagination?(g(),S(d(G),{key:1,vertical:"",gap:"small",align:"end"},{default:v(()=>[o.pagination.totalCount>d(M)?(g(),S(d(xt),{key:0,current:o.pagination.currentIndex,"page-size":o.pagination.pageSize,total:o.pagination.totalCount,"show-size-changer":!1,"show-quick-jumper":!1,size:"small",onChange:a[0]||(a[0]=i=>t.$emit("page-change",i))},null,8,["current","page-size","total"])):k("",!0)]),_:1})):o.logs.entries.length?k("",!0):(g(),S(d(R),{key:2,type:"secondary"},{default:v(()=>[...a[1]||(a[1]=[D("Empty",-1)])]),_:1}))]),_:1}))}});const fe=ot(Ut,[["__scopeId","data-v-ee1d10cd"]]),Qt={key:0},Yt=["onClick"],Xt=["onClick"],Kt=W({__name:"ExecutionContext",props:{data:{},showFixWithAi:{type:Boolean},isSmartChatIdle:{type:Boolean}},emits:["ask-ai"],setup(o,{emit:t}){const a=o,i=t,f=V(!1),n=r=>{if(r==="legacyThreadData")return w.translate("i18n_executioncontext_thread_data");const E=nt(r);return E.replace(/([A-Z])/g," $1").trim(),E},l=r=>r==null?!0:Array.isArray(r)?r.length===0:typeof r=="object"?Object.keys(r).length===0:!1,c=r=>{typeof r=="object"&&r!==null&&"payload"in r?(navigator.clipboard.writeText(JSON.stringify(r.payload)),O.success({content:w.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),O.error({content:w.translate("i18n_executioncontext_no_payload")}))},m=r=>{f.value=!0,r.stopPropagation(),a.isSmartChatIdle!==!1&&(i("ask-ai"),setTimeout(()=>{f.value=!1},1e3))},x=r=>{typeof r=="object"?(navigator.clipboard.writeText(JSON.stringify(r)),O.success({content:w.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),O.error({content:w.translate("i18n_executioncontext_failed_copy_request")}))};return(r,E)=>(g(),S(d(dt),{bordered:!1,style:{"background-color":"transparent",width:"100%"}},{default:v(()=>[b(d(ut),{key:"execution-context"},{header:v(()=>[b(d(G),{justify:"space-between"},{default:v(()=>[b(d(R),null,{default:v(()=>[D($(d(w).translate("i18n_executioncontext_header")),1)]),_:1}),b(d(q),{title:o.isSmartChatIdle?"":d(w).translate("i18n_executioncontext_wait_or_stop"),placement:"left"},{default:v(()=>[o.showFixWithAi?(g(),y("div",{key:0,class:yt(["ask-to-ai",{disabled:!o.isSmartChatIdle||f.value}]),onClick:m},[D($(d(w).translate("i18n_executioncontext_fix_with_ai"))+" ",1),b(d(qt),{size:16})],2)):k("",!0)]),_:1},8,["title"])]),_:1})]),default:v(()=>[b(d(At),{direction:"vertical",style:{"border-radius":"5px",padding:"10px",color:"#fff",width:"100%","font-family":"monospace","max-height":"600px",overflow:"auto",border:"1px solid #e8e8e8"}},{default:v(()=>[Object.keys(o.data).length?(g(!0),y(et,{key:1},at(Object.entries(o.data),([_,Z])=>(g(),y("div",{key:_,class:"tree"},[_!=="legacyThreadData"||!l(Z)?(g(),y("div",Qt,[b(d(R),{strong:""},{default:v(()=>[D($(n(_)),1)]),_:2},1024),_==="request"?(g(),S(d(q),{key:0,title:d(w).translate("i18n_executioncontext_copy_request_tooltip")},{default:v(()=>[H("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:I=>x(Z)},[b(d(tt))],8,Yt)]),_:2},1032,["title"])):k("",!0),_==="triggerTask"?(g(),S(d(q),{key:1,title:d(w).translate("i18n_executioncontext_copy_payload_tooltip")},{default:v(()=>[H("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:I=>c(Z)},[b(d(tt))],8,Xt)]),_:2},1032,["title"])):k("",!0),b(d(vt),{"tree-data":d(bt)(Z),selectable:!1},null,8,["tree-data"])])):k("",!0)]))),128)):(g(),S(d(R),{key:0,type:"secondary"},{default:v(()=>[D($(d(w).translate("i18n_executioncontext_empty")),1)]),_:1}))]),_:1})]),_:1})]),_:1}))}});const pe=ot(Kt,[["__scopeId","data-v-f7630ec7"]]);export{pe as E,fe as L,ue as R,de as a,ge as u};
//# sourceMappingURL=ExecutionContext.3ff3685a.js.map
