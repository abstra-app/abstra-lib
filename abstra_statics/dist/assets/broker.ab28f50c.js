var ae=Object.defineProperty;var le=(s,e,n)=>e in s?ae(s,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[e]=n;var l=(s,e,n)=>(le(s,typeof e!="symbol"?e+"":e,n),n);import{d as S,b as f,c as w,x as E,z as H,N,D as I,q as x,a as ue,t as y,B as ce,r as U,w as re,S as de,U as T,a2 as he,K as F,R as fe,v as Y,a3 as Z,a4 as me,a5 as pe,o as ve,X as ge,G as ee,e as R,F as te,L as ne,a6 as we,a7 as ye}from"./registerWidgets.dc0b6768.js";import{p as j}from"./passwordlessManager.914ef4f9.js";import{k as be,n as ke}from"./icons.79ac4c38.js";import{_ as _e}from"./ActionButton.vue_vue_type_script_setup_true_lang.97b43c01.js";import{P as Ee}from"./Passwordless.451bc665.js";import{e as Ie,R as Pe}from"./executeJs.be5526ce.js";import{l as $}from"./log.709af14c.js";import{W as Le}from"./WidgetsFrame.300273f9.js";import{L as De}from"./CircularLoading.8d483ca6.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[e]="2a99e7ec-0bea-4143-b573-8e62a640e6d1",s._sentryDebugIdIdentifier="sentry-dbid-2a99e7ec-0bea-4143-b573-8e62a640e6d1")}catch{}})();const Se={key:0,class:"hint"},xe={class:"icon",viewBox:"0 0 24 24",style:{width:"20px",height:"20px"}},Ae=["d"],Ce={class:"hint-content"},We=S({__name:"WidgetHint",props:{hint:null},setup(s){return(e,n)=>s.hint?(f(),w("div",Se,[(f(),w("svg",xe,[E("path",{d:H(be)},null,8,Ae)])),E("div",Ce,N(s.hint),1)])):I("",!0)}});const Be=x(We,[["__scopeId","data-v-419a518f"]]),Fe={class:"outline-button"},Re=S({__name:"OutlineButton",props:{iconPath:null,noShadow:{type:Boolean},status:null},setup(s){return(e,n)=>{const t=ue("icon");return f(),w("button",Fe,[s.iconPath?(f(),y(t,{key:0,path:s.iconPath,fill:"#fff",class:"icon"},null,8,["path"])):I("",!0),ce(e.$slots,"default",{},void 0,!0)])}}});const je=x(Re,[["__scopeId","data-v-d16448de"]]),$e=S({__name:"FormAutoFill",props:{broker:null,form:null},setup(s){const e=s,n=window.__runs||(window.__runs={previous:[],current:[]});e.broker.on("start",()=>{n.previous=n.current,n.current=[]});const t=U(null);function r(){for(const h in n.current){const c=n.previous[h],a=n.current[h];if(!c||c.type!==a.type||c.type=="form"&&!T.exports.isEqual(c.widgets,a.widgets)||c.type=="form-response"&&!T.exports.isEqual(c.payload,a.payload))return null}const i=n.previous[n.current.length];if((i==null?void 0:i.type)!=="form-response")return null;t.value=i}function d(){const i=t.value;i&&e.broker.send(i)}return e.broker.on("form",i=>{n.current.push(i),r()}),e.broker.on("form-response",i=>{n.current.push(i),t.value=null}),(i,h)=>t.value?(f(),y(je,{key:0,"icon-path":H(ke),class:"form-auto-fill-btn",onClick:d},{default:re(()=>[de(" Repeat last answer ")]),_:1},8,["icon-path"])):I("",!0)}});const Oe=x($e,[["__scopeId","data-v-9590d96b"]]);class k{constructor(e,n){l(this,"element",null);this.name=e,this.isDefault=n}static fromDto(e){return typeof e=="string"?new k(e,!1):new k(e.name,e.is_default)}setElement(e){e instanceof HTMLElement&&(this.element=e)}get isFocused(){return this.element===document.activeElement}focusOnButton(){var e;(e=this.element)==null||e.focus()}addKeydownListener(e){var n;(n=this.element)==null||n.addEventListener("keydown",e)}}class V{constructor(e){this.form=e}static from(e){return new V(e)}get startAction(){var e;return[k.fromDto((e=this.form.startButtonText)!=null?e:"Start")]}get restartAction(){var n;const e=(n=this.form.restartButtonText)!=null?n:"Restart";return this.form.allowRestart?[k.fromDto(e)]:[]}fromPageActionsDto(e){return e.filter(n=>!!n).map(n=>k.fromDto(n))}}async function Ne(s){window.should_ask_before_leave=!1,window.location.href=s.url}const Ue={redirect:Ne,"execute-js":Ie};class M{constructor(e,n){l(this,"loading",!1);l(this,"endedByPage",!1);l(this,"reactivePollInterval",null);l(this,"programEnded",!1);l(this,"widgetError",()=>{this.newPageDefinition({widgets:[{type:"error"}],actions:[],fullWidth:!1,hasError:!1,steps:null})});l(this,"widgetEnd",()=>{this.endedByPage||this.newPageDefinition({widgets:[{type:"end"}],actions:this.pageActionFactory.restartAction,fullWidth:!1,hasError:!1,steps:null})});l(this,"sendUser",e=>{this.broker.send({type:"auth:saved-jwt",jwt:e.jwt}),this.broker.send({type:"metadata",payload:{authenticated_user:e.claims.email}})});l(this,"sendBrowserTryDisconnect",()=>{this.broker.send({type:"browser:try-disconnect"})});l(this,"newPageDefinitionListener",()=>{});l(this,"updatePageDefinitionListener",()=>{});l(this,"onReactivePollListener",()=>{});l(this,"onErrorListener",()=>{});l(this,"onExitListener",()=>{});l(this,"onStartAuthListener");l(this,"onEndAuthListener");l(this,"onBadAuthListener");this.broker=e,this.pageActionFactory=n}static create(e,n){const t=new M(e,n);return t.broker.onClose(()=>{if(t.programEnded)return;const r="Connection with service closed before program ended";$.log({log:r,type:"stderr"}),t.widgetError(),t.error(r)}),t.broker.on("form",({widgets:r,actions:d,buttonText:i,endProgram:h,reactivePollingInterval:c,steps:a})=>{t.loading=!1,t.newPageDefinition({widgets:r,actions:t.pageActionFactory.fromPageActionsDto(i?[i]:d!=null?d:[]),fullWidth:r.some(v=>"fullWidth"in v&&v.fullWidth),hasError:!1,steps:a}),c&&(t.reactivePollInterval=setInterval(t.onReactivePollListener,c*1e3)),h&&(t.endedByPage=!0,t.broker.send({type:"form-response",payload:{},secrets:[]}))}),t.broker.on("action",async({action:r})=>{var h;let d=null,i;try{const{type:c}=r;d=(h=await Ue[c](r))!=null?h:null}catch(c){i=c.message}t.broker.send({type:"action-response",value:d,errorMessage:i})}),t.broker.on("auth:require-info",()=>{t.newPageDefinition({widgets:[],actions:[],fullWidth:!1,hasError:!1,steps:null}),t.onStartAuthListener&&t.onStartAuthListener()}),t.broker.on("auth:valid-jwt",()=>{t.onEndAuthListener&&t.onEndAuthListener()}),t.broker.on("auth:invalid-jwt",()=>{console.warn("invalid jwt"),t.onBadAuthListener&&t.onBadAuthListener()}),t.broker.on("stdout",r=>{$.log(r)}),t.broker.on("stderr",r=>{$.log(r)}),t.broker.on("program:connection-error",r=>{t.widgetError(),t.error(r)}),t.broker.on("program:end",r=>{t.programEnded=!0,r.exitCode||r.exception?(t.widgetError(),t.error(r)):(t.widgetEnd(),t.exit(r))}),t.broker.on("program:disconnect",r=>{t.exit(r)}),t.broker.on("not-enough-credits",()=>{t.error({error:"not-enough-credits"}),t.programEnded=!0}),t.broker.on("session-id",async r=>{t.broker.setSessionId(r.sessionId)}),t.broker.on("heartbeat",()=>{t.broker.resetHeartbeatCounter()}),t.broker.on("user-response-event",({widgets:r,validation:d})=>{t.updatePageDefinition({widgets:r,validation:{message:d.message,status:d.status},fullWidth:r.some(i=>"fullWidth"in i&&i.fullWidth)})}),t}next(e,n,t,r){if((he(Object.values(e))||!t)&&(n==null?void 0:n.name)!=="Back"){this.updatePageDefinition({hasError:!0});return}this.reactivePollInterval&&clearInterval(this.reactivePollInterval);const i={};Object.keys(e).forEach(h=>{i[h]=e[h].value}),this.loading=!0,this.broker.send({type:"form-response",payload:i,action:n==null?void 0:n.name,secrets:r}),this.newPageDefinition({widgets:[],fullWidth:!1,hasError:!1,actions:[],steps:null})}sendUserEvent(e,n){const t={};Object.keys(e).forEach(r=>{t[r]=e[r].value}),this.broker.send({type:"user-event",payload:t,secrets:n})}init(e){this.broker.resetState(),this.newPageDefinition({widgets:[],actions:[],fullWidth:!1,hasError:!1,steps:null}),this.broker.connect(e!=null?e:{})}newPageDefinition(e){this.newPageDefinitionListener(e)}updatePageDefinition(e){this.loading||this.updatePageDefinitionListener(e)}listenToNewPageDefinition(e){this.newPageDefinitionListener=e}listenToPageDefinitionUpdate(e){this.updatePageDefinitionListener=e}onReactivePoll(e){this.onReactivePollListener=e}error(e){this.reactivePollInterval&&clearInterval(this.reactivePollInterval),this.onErrorListener(e)}onError(e){this.onErrorListener=e}exit(e){this.reactivePollInterval&&clearInterval(this.reactivePollInterval),this.onExitListener(e)}onExit(e){this.onExitListener=e}onStartAuth(e){this.onStartAuthListener=e}onEndAuth(e){this.onEndAuthListener=e}onBadAuth(e){this.onBadAuthListener=e}}const Te={key:0,class:"form-wrapper"},He=["id"],Ve={key:0,class:"span-error"},Me={key:1,class:"loading-wrapper"},qe={class:"span-error"},ze={class:"buttons"},Je=S({__name:"FormRunner",props:{form:{type:Object,required:!0},params:Object,isPreview:Boolean,enableAutoFocus:{type:Boolean,required:!0},broker:{type:Object,required:!0}},emits:["log","error","exit","navigate","logout","start"],setup(s,{expose:e,emit:n}){const t=s,r=U(null),d=F(()=>V.from(t.form)),i=o=>n("navigate",o),h=()=>{a.value={widgets:[{type:"start"}],actions:d.value.startAction,fullWidth:!1,hasError:!1,steps:null}};fe(()=>t.form,()=>{var o;((o=a.value.widgets[0])==null?void 0:o.type)=="start"&&h()});const c=Y({user:null,authenticating:!1}),a=U({widgets:[],fullWidth:!1,hasError:!1,actions:[],steps:null}),v=Y({responses:{},formState:"idle"}),A=F(()=>a.value.widgets.reduce((o,u)=>("key"in u&&(o[u.key]=v.responses[u.key]),o),{})),C=F(()=>a.value.widgets.filter(o=>"secret"in o).reduce((o,u)=>"key"in u&&"secret"in u?[...o,{key:u.key,secret:u.secret}]:o,[]));q();function q(){c.user=j.getUser()}const oe=()=>{j.removeUser(),q(),n("logout")},m=M.create(t.broker,d.value);m.onError(o=>{var u;if(n("error",o),v.formState="error",o.error==="not-enough-credits"){(u=r.value)==null||u.open(),h();return}}),m.onExit(o=>{n("exit",o),v.formState="over"}),m.onStartAuth(()=>{c.user?m.sendUser(c.user):c.authenticating=!0}),m.onEndAuth(()=>{c.authenticating=!1}),m.onBadAuth(()=>{j.removeUser(),c.user=null,c.authenticating=!0}),m.onReactivePoll(()=>{m.sendUserEvent(A.value,C.value)});const ie=o=>{c.user=o,m.sendUser(o)};m.listenToNewPageDefinition(o=>{var u,g;a.value=o,Z.init(t.enableAutoFocus,()=>P()),v.responses=me((g=(u=a.value)==null?void 0:u.widgets)!=null?g:[])}),m.listenToPageDefinitionUpdate(o=>{var u,g;a.value={...a.value,...o},v.responses=pe((g=(u=a.value)==null?void 0:u.widgets)!=null?g:[],v.responses)});const z=o=>{var u;if(!(v.formState!=="running"||t.isPreview||!((u=window.should_ask_before_leave)==null||u)))return m.sendBrowserTryDisconnect(),o.preventDefault(),o.returnValue="Are you sure?",""};ve(async()=>{window.addEventListener("beforeunload",z),h(),Z.init(t.enableAutoFocus,o=>P(o)),t.form.autoStart&&W()}),ge(()=>{t.broker.close(),window.removeEventListener("beforeunload",z)});const P=o=>{var u,g;if(v.formState!=="running")return W();m.next(A.value,o,(g=(u=a.value.validation)==null?void 0:u.status)!=null?g:!0,C.value)},W=async()=>{m.init(t.params),v.formState="running",n("start")},L=o=>ye(o.type)?v.responses[o.key]:null;function J(o,u,g){if(m.sendUserEvent(A.value,g),u===a.value.widgets.length-1&&["multiple-choice-input","cards-input"].includes(a.value.widgets[u].type)&&a.value.actions.filter(D=>!!D).length===0&&o.value!==null&&(!T.exports.isArray(o.value)||o.value.length)){P();return}}return e({run:W}),(o,u)=>(f(),y(Le,{class:ee([{preview:s.isPreview},"runner"]),"main-color":s.form.mainColor,theme:s.form.theme,"font-family":s.form.fontFamily,runtime:"form"},{default:re(()=>{var g,D;return[s.isPreview?(f(),y(Oe,{key:0,class:"auto-fill-btn",broker:s.broker,form:s.form,style:{"z-index":1}},null,8,["broker","form"])):I("",!0),R(Pe,{ref_key:"runtimeCommonsRef",ref:r,runtime:s.form,"full-width":a.value.fullWidth,"steps-info":a.value.steps,"is-preview":s.isPreview,"user-email":(g=c.user)==null?void 0:g.claims.email,type:"forms",onLogout:oe,onNavigate:i},null,8,["runtime","full-width","steps-info","is-preview","user-email"]),E("main",null,[c.authenticating?(f(),y(Ee,{key:1,class:"form-auth",onDone:ie})):(f(),w("div",{key:0,class:ee(["form",{"full-width":a.value.fullWidth}])},[a.value.widgets.length>0?(f(),w("div",Te,[(f(!0),w(te,null,ne(a.value.widgets,(p,_)=>{var G,K,X,Q;return f(),w("div",{id:p.type+_,key:(G=p.key)!=null?G:p.type+_,class:"widget"},[(f(),y(we(p.type),{data:p,response:L(p),form:s.form,page:a.value,"has-error":((K=L(p))==null?void 0:K.isInvalid())&&a.value.hasError,runtime:"form","session-id":s.broker.getSessionId(),onChange:B=>J(B,_,H(C)),onSetInitialValue:B=>J(B,_)},null,40,["data","response","form","page","has-error","session-id","onChange","onSetInitialValue"])),R(Be,{hint:"hint"in p?p.hint:null},null,8,["hint"]),((X=L(p))==null?void 0:X.isInvalid())&&a.value.hasError?(f(),w("span",Ve,N((Q=L(p))==null?void 0:Q.errorMessages().join(`
`)),1)):I("",!0)],8,He)}),128))])):(f(),w("div",Me,[R(De)])),E("span",qe,N((D=a.value.validation)==null?void 0:D.message),1),E("div",ze,[(f(!0),w(te,null,ne(a.value.actions,p=>(f(),y(_e,{key:p.name,action:p,onNext:_=>P(p)},null,8,["action","onNext"]))),128))])],2))])]}),_:1},8,["class","main-color","theme","font-family"]))}});const it=x(Je,[["__scopeId","data-v-c4b73db3"]]);function Ge(s){return s.type==="form"&&s.payload?{...s,type:"form-response"}:s.type==="user-event"&&s.widgets?{...s,type:"user-response-event"}:s}const Ke=[WebSocket.CLOSING,WebSocket.CLOSED];function se(s,e){const n=s[e.type];if(!n){console.warn("no callback for",e.type);return}n.forEach(t=>t(e))}const b=class{constructor(e){l(this,"formPath",null);l(this,"sessionId",null);l(this,"isLocal");l(this,"isPreview");l(this,"ws",null);l(this,"callbacks",{"form-response":[],"user-response-event":[],start:[],"auth:info":[],"auth:saved-jwt":[],"auth:restart":[],"auth:validate-token":[],"auth:resend-token":[],heartbeat:[],metadata:[],"executed-by":[],"action-response":[],"user-event":[],"program:end":[],"program:disconnect":[],"program:connection-error":[],stderr:[],stdout:[],form:[],action:[],"not-enough-credits":[],"auth:require-info":[],"auth:expecting-token":[],"auth:token-expired":[],"auth:invalid-token":[],"auth:invalid-jwt":[],"auth:valid-token":[],"auth:valid-jwt":[],"browser:disconnect":[],"session-id":[],"browser:try-disconnect":[]});l(this,"onCloseCallbacks",[]);l(this,"heartbeatCounter",0);l(this,"heartbeatInterval");l(this,"params",{});var n,t;"formPath"in e&&(this.formPath=(n=e.formPath)!=null?n:null),"sessionId"in e&&(this.sessionId=(t=e.sessionId)!=null?t:null),this.isLocal=e.isLocal,this.isPreview=e.isPreview}static create(e){return b._instance&&b._instance.close(),b._instance=new b(e),b._instance}get url(){const e=this.isLocal||this.sessionId?"sessionId":"formPath";return`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}/_socket?${e}=${this[e]}&isPreview=${this.isPreview}`}setSessionId(e){var n;(n=this.sessionId)!=null||(this.sessionId=e)}getSessionId(){return this.sessionId}resetState(){this.close(),this.isLocal||(this.sessionId=null)}resetHeartbeatCounter(){this.heartbeatCounter=0}on(e,n){this.callbacks[e].push(n)}clearWSEvents(){!this.ws||(clearInterval(this.heartbeatInterval),this.ws.onclose=()=>{},this.ws.onerror=()=>{},this.ws.onmessage=()=>{})}async connect(e,n=1){if(!(n>3))return this.params=e!=null?e:this.params,new Promise(t=>{this.clearWSEvents(),this.ws=new WebSocket(this.url),this.ws.onopen=()=>{t(),this.resetHeartbeatCounter(),this.send({type:"start",params:this.params})};let r=!1;const d=()=>{r||(r=!0,this.sessionId&&setTimeout(()=>this.connect(),1500))};this.ws.onclose=i=>{if(i.code===1006||!i.wasClean)return d();clearInterval(this.heartbeatInterval),this.onCloseCallbacks.forEach(h=>h())},this.ws.onerror=()=>d(),this.ws.onmessage=i=>{const h=JSON.parse(i.data);se(this.callbacks,Ge(h))},this.heartbeatInterval=setInterval(()=>{if(!(!this.ws||this.ws.readyState!==this.ws.OPEN)){if(this.heartbeatCounter++,this.heartbeatCounter>3)return this.ws.onclose=()=>{},clearInterval(this.heartbeatInterval),d();this.send({type:"heartbeat"})}},2e3)}).catch(()=>{this.connect(this.params,n+1)})}onClose(e){this.onCloseCallbacks.push(e)}close(){if(!this.ws){console.warn("no websocket to close");return}this.clearWSEvents(),this.ws.close()}async send(e){if(!this.ws){console.warn("no websocket to send");return}Ke.includes(this.ws.readyState)&&await this.connect(),this.ws.send(JSON.stringify(e)),se(this.callbacks,e)}};let O=b;l(O,"_instance");export{it as F,O as R};
//# sourceMappingURL=broker.ab28f50c.js.map
