import{_ as R}from"./AbstraButton.vue_vue_type_script_setup_true_lang.8cfc5bc5.js";import{O as G,L as C,r as k,w as ee,d as te,eb as se,ej as ne,J as ae,a5 as T,f as l,e as v,b as c,u as n,aR as j,o as g,a as I,S as oe,ec as V,h as U,ed as O,dc as _,g as K,ex as re,cV as le,cv as ie,M as ue,cJ as B,eh as ce,ei as de,_ as me}from"./jwt-decode.esm.b29e2f2b.js";import{G as fe}from"./PhClockCounterClockwise.vue.c776f15a.js";import{I as pe}from"./PhDatabase.vue.d31d160c.js";import{G as ye}from"./PhDownloadSimple.vue.0b798eee.js";import{F as ge}from"./PhKey.vue.d789d145.js";import{l as L,e as he}from"./toggleHighContrast.f760e4f8.js";import{_ as _e}from"./TablesTabs.vue_vue_type_script_setup_true_lang.1fc5a07f.js";import{A as ve,C as Ce}from"./router.ba22ba9c.js";import{a as we}from"./project.7372eb48.js";import"./tables.a98d5c4d.js";import{u as Ee}from"./useTables.1ce0cd28.js";import"./Card.c5ff282d.js";import"./index.85a6a6e9.js";import"./record.5ca2ba5e.js";import"./string.85f1bdbf.js";(function(){try{var e=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},s=new Error().stack;s&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[s]="eafaaba6-d80d-4104-9b99-064003a5366e",e._sentryDebugIdIdentifier="sentry-dbid-eafaaba6-d80d-4104-9b99-064003a5366e")}catch{}})();const J=e=>{if(e==null)return"";const s=String(e);return s.includes(";")||s.includes(`
`)||s.includes('"')?`"${s.replace(/"/g,'""')}"`:s},be=e=>{let s=e.columns.map(J).join(";")+`
`;e.rows.forEach(m=>{s+=m.map(J).join(";")+`
`});const a=document.createElement("a");a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(s),a.target="_blank",a.download=`${e.fileName}.csv`,a.click()},z=new G(C.array(C.object({projectId:C.string(),lastQuery:C.string()})),"lastQueries"),Q=new G(C.array(C.object({id:C.string(),query:C.string(),timestamp:C.number(),projectId:C.string()})),"queryHistory");function Se(e,s){var b;const a=e.toUpperCase(),m=/\b(FROM|JOIN|UPDATE|INTO)\s+\w*$/i.test(a)||/\bDELETE\s+FROM\s+\w*$/i.test(a),t=/\b(SELECT|WHERE|ON|SET|AND|OR|BY)\s+[\w.]*$/i.test(a)||/\w+\.\w*$/.test(e),u=e.match(/(\w+)\.\w*$/),q=u&&(b=s.find(x=>x.name.toUpperCase()===u[1].toUpperCase()))!=null?b:null,w=/\b(SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP|FROM|WHERE|JOIN)\b/.test(a);return{textBeforeCursor:e,isTableContext:m,isColumnContext:t,specificTable:q,hasSqlKeyword:w}}function $e(e,s,a){const m=[];if(e.specificTable)e.specificTable.getColumns().forEach(t=>{m.push({label:t.name,kind:L.CompletionItemKind.Field,insertText:t.name,detail:`${t.type}`,documentation:`Column from ${e.specificTable.name}`,range:a})});else if(e.isTableContext)s.forEach(t=>{m.push({label:t.name,kind:L.CompletionItemKind.Class,insertText:t.name,detail:"Table",documentation:`${t.getColumns().length} columns`,range:a})});else if(e.isColumnContext)s.forEach(t=>{t.getColumns().forEach(u=>{m.push({label:`${t.name}.${u.name}`,kind:L.CompletionItemKind.Field,insertText:`${t.name}.${u.name}`,detail:`${u.type}`,documentation:`${t.name}.${u.name}`,range:a})})});else{if(!e.hasSqlKeyword)return[];s.forEach(t=>{m.push({label:t.name,kind:L.CompletionItemKind.Class,insertText:t.name,detail:"Table",range:a}),t.getColumns().forEach(u=>{m.push({label:`${t.name}.${u.name}`,kind:L.CompletionItemKind.Field,insertText:`${t.name}.${u.name}`,detail:`${u.type}`,range:a})})})}return m}function ke(e,s){const a=k(""),m=k([]),t=k([]),u=k(!1),q=()=>{const r=z.get();if(!r)z.set([{projectId:e,lastQuery:a.value}]);else{const o=r.findIndex(d=>d.projectId===e);o===-1?r.push({projectId:e,lastQuery:a.value}):r[o].lastQuery=a.value,z.set(r)}},w=()=>{var o;const r=z.get();return(o=r==null?void 0:r.find(d=>d.projectId===e))==null?void 0:o.lastQuery},b=r=>{if(!r.trim())return;const o=Q.get()||[],d={id:`${Date.now()}-${Math.random()}`,query:r.trim(),timestamp:Date.now(),projectId:e},y=o.filter($=>$.projectId===e),h=o.filter($=>$.projectId!==e),S=[d,...y].slice(0,50);Q.set([...S,...h])},x=()=>(Q.get()||[]).filter(o=>o.projectId===e).sort((o,d)=>d.timestamp-o.timestamp),A=()=>{const o=(Q.get()||[]).filter(d=>d.projectId!==e);Q.set(o)},F=async()=>{u.value=!0;const r=await we.executeQuery(e,a.value,[]);if(q(),b(a.value),u.value=!1,!r)return{returns:{result:[],fields:[]},errors:[]};const{returns:o,errors:d}=r;return t.value=o.fields.map(y=>({title:y.name,key:y.name,dataIndex:y.name})),m.value=o.result.map((y,h)=>{const S={key:`${h+1}`};return Object.entries(y).forEach(([$,D])=>{S[$]=D!=null?String(D):""}),S}),{returns:o,errors:d}};let N=null;const M=()=>{!s.value||s.value.length===0||(N&&N.dispose(),N=L.registerCompletionItemProvider("sql",{provideCompletionItems:(r,o)=>{const d=r.getWordUntilPosition(o),y={startLineNumber:o.lineNumber,endLineNumber:o.lineNumber,startColumn:d.startColumn,endColumn:d.endColumn},h=r.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:o.lineNumber,endColumn:o.column}),S=Se(h,s.value);return{suggestions:$e(S,s.value,y)}}}))};return ee(s,()=>{s.value&&s.value.length>0&&M()},{immediate:!0}),{sql:a,data:m,columns:t,loading:u,runSql:F,getLastQuery:w,setLastQuery:q,getHistory:x,clearHistory:A}}const xe=e=>(ce("data-v-59f41177"),e=e(),de(),e),Te={class:"sql-main-card"},qe={class:"data-dictionary"},Ie={class:"dictionary-header"},Le=xe(()=>v("span",null,"Tables",-1)),Ne=["onClick"],He={class:"column-name"},Qe={class:"column-type"},De={class:"sql-editor-container"},Re={key:1,class:"history-list"},je=["onClick"],Oe={class:"history-query"},Ke={class:"history-timestamp"},ze=te({__name:"Sql",setup(e){const s=se(),a=s.params.projectId,m=k(null);let t=null;const{tables:u,loading:q}=Ee(a),{sql:w,data:b,columns:x,loading:A,runSql:F,getLastQuery:N,setLastQuery:M,getHistory:r,clearHistory:o}=ke(a,u),d=k([]),y=k(!1),h=k([]),S=async()=>{const{errors:f}=await F();h.value=r();for(const p of f)B.error({message:"SQL Execution Failed",description:p});f.length||B.success({message:"SQL Execution Succeeded"})},$=()=>{const f=x.value.map(H=>H.dataIndex),p=x.value.map(H=>H.title),i=b.value.map(H=>f.map(Z=>H[Z])),P=`data-${new Date().toISOString()}`;be({fileName:P,columns:p,rows:i})},D=(f,p)=>{if(!t)return;const i=t.getSelection();if(!i)return;const E=`${f}.${p}`;t.executeEdits("",[{range:i,text:E}]),t.focus()},W=f=>{t&&(t.setValue(f),w.value=f),y.value=!1},Y=()=>{o(),h.value=[]},X=ne.exports.debounce(M,1e3);return ae(()=>{h.value=r(),t=he.create(m.value,{language:"sql",value:w.value,fontFamily:"monospace",lineNumbers:"on",minimap:{enabled:!1},scrollbar:{vertical:"hidden",horizontal:"visible"},fontSize:14,scrollBeyondLastLine:!1,lineHeight:20,suggestOnTriggerCharacters:!0,quickSuggestions:{other:!0,comments:!1,strings:!1}}),t.onDidChangeModelContent(()=>{!t||(w.value=t.getValue(),X())});const f=s.query.filter;if(f&&typeof f=="string"&&f.trim())w.value=f,t.setValue(f);else{const p=N();p&&(w.value=p,t.setValue(p))}}),(f,p)=>(g(),T(j,null,[l(_e),v("div",Te,[l(n(_),{gap:"middle",style:{width:"100%",height:"100%"}},{default:c(()=>[v("div",qe,[v("div",Ie,[l(n(pe),{size:16}),Le]),n(q)?(g(),I(n(oe),{key:0,style:{width:"100%",padding:"20px"}})):(g(),I(n(Ce),{key:1,activeKey:d.value,"onUpdate:activeKey":p[0]||(p[0]=i=>d.value=i),ghost:""},{default:c(()=>[(g(!0),T(j,null,V(n(u),i=>(g(),I(n(ve),{key:i.id,header:i.name},{default:c(()=>[(g(!0),T(j,null,V(i.getColumns(),E=>(g(),T("div",{key:E.id,class:"column-item",onClick:P=>D(i.name,E.name)},[E.primaryKey?(g(),I(n(ge),{key:0,size:12,style:{color:"#faad14"}})):U("",!0),v("span",He,O(E.name),1),v("span",Qe,O(E.type),1)],8,Ne))),128))]),_:2},1032,["header"]))),128))]),_:1},8,["activeKey"]))]),l(n(_),{vertical:"",style:{flex:"1"},gap:"middle"},{default:c(()=>[v("div",De,[v("div",{ref_key:"sqlEditor",ref:m,class:"sql-editor"},null,512),l(n(_),{justify:"flex-end",class:"bottom-controls",gap:"small",align:"center"},{default:c(()=>[l(n(_),{gap:"small"},{default:c(()=>[l(R,{size:"small",type:"text",onClick:p[1]||(p[1]=i=>y.value=!0)},{default:c(()=>[l(n(_),{gap:"4",align:"center"},{default:c(()=>[l(n(fe),{size:14}),K(" History ")]),_:1})]),_:1})]),_:1}),l(n(_),{gap:"small",align:"center"},{default:c(()=>[l(R,{size:"small",type:"primary",loading:n(A),onClick:S},{default:c(()=>[l(n(_),{gap:"4",align:"center"},{default:c(()=>[K(" Run "),l(n(re),{size:12})]),_:1})]),_:1},8,["loading"])]),_:1})]),_:1})]),l(n(le),{style:{width:"100%"},scroll:{x:100},"data-source":n(b),columns:n(x)},null,8,["data-source","columns"]),n(b).length?(g(),I(n(_),{key:0,justify:"end"},{default:c(()=>[l(R,{onClick:$},{default:c(()=>[l(n(_),{align:"center",gap:"small"},{default:c(()=>[K(" Export to CSV "),l(n(ye))]),_:1})]),_:1})]),_:1})):U("",!0)]),_:1})]),_:1})]),l(n(ue),{open:y.value,"onUpdate:open":p[2]||(p[2]=i=>y.value=i),title:"Query History",width:"800px",footer:null},{default:c(()=>[l(n(_),{vertical:"",gap:"middle"},{default:c(()=>[l(n(_),{justify:"end"},{default:c(()=>[l(R,{danger:"",size:"small",onClick:Y},{default:c(()=>[K("Clear History")]),_:1})]),_:1}),h.value.length?(g(),T("div",Re,[(g(!0),T(j,null,V(h.value,i=>(g(),T("div",{key:i.id,class:"history-item",onClick:E=>W(i.query)},[v("div",Oe,O(i.query),1),v("div",Ke,O(new Date(i.timestamp).toLocaleString()),1)],8,je))),128))])):(g(),I(n(ie),{key:0,description:"No query history"}))]),_:1})]),_:1},8,["open"])],64))}});const nt=me(ze,[["__scopeId","data-v-59f41177"]]);export{nt as default};
//# sourceMappingURL=Sql.9e57ccd0.js.map
