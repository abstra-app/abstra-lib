import{a as j}from"./router-Bh5EUIsF.js";import{d as lt,r as C,V as O,ac as ut,N as B,c as dt,a as K,b as k,f as p,u,E as M,w,k as b,e as _,Q as q,Z as tt,P as gt,t as z,c4 as ft,T as V,g as R,aK as et,h as v,A as N,i as x,J as pt,m as X,bB as ht,bp as L}from"./jwt-decode.esm-BRRA-bKi.js";import{a as yt}from"./build-DGO78UwG.js";import{c as at}from"./string-BUHbcr79.js";import"./tables-Cb0rOdcm.js";import{u as mt}from"./polling-D7gWgnWW.js";import{t as xt}from"./ant-design-DPnaazIl.js";import{I as Y}from"./PhCopy.vue-DgCitwRx.js";import{G as wt}from"./PhRobot.vue-DH6ce0WX.js";import{S as bt}from"./index-87ABxo4B.js";(function(){try{var n=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},a=new Error().stack;a&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[a]="f7fc4bd2-bf42-4d3c-903e-9cb851af5f50",n._sentryDebugIdIdentifier="sentry-dbid-f7fc4bd2-bf42-4d3c-903e-9cb851af5f50")}catch{}})();const vt=["running","lock-failed","failed","finished","abandoned"];class W{constructor(a){this.dto=a}static from(a){return new W(a)}get entries(){return this.dto.sort((a,t)=>a.sequence-t.sequence).filter(a=>a.event!=="form-message")}}class F{constructor(a){this.dto=a}static from(a){return new F(a)}get id(){return this.dto.id}get shortId(){return this.dto.id.slice(0,8)}get createdAt(){return new Date(this.dto.createdAt)}get updatedAt(){return new Date(this.dto.updatedAt)}get status(){return this.dto.status}get context(){return this.dto.context}get buildId(){return this.dto.buildId??""}get stageId(){return this.dto.stageId}get duration_seconds(){return`${(((this.dto.updatedAt?new Date(this.dto.updatedAt).getTime():Date.now())-this.createdAt.getTime())/1e3).toFixed(3)} s`}get stageRunId(){return this.dto.stageRunId}get projectId(){return this.dto.projectId}}class Bt{async list({projectId:a,...t}){const s={...t,offset:t.offset?.toString(),limit:t.limit?.toString(),payloadMatchCase:t.payloadMatchCase?"true":void 0,payloadMatchWholeWord:t.payloadMatchWholeWord?"true":void 0};Object.keys(s).forEach(o=>s[o]===void 0&&delete s[o]);const r=await j.get(`projects/${a}/executions`,s);return{executions:r.executions.map(o=>F.from(o)),totalCount:r.totalCount}}async fetchLogs(a,t,s){const r={};s?.limit!==void 0&&(r.limit=s.limit.toString()),s?.offset!==void 0&&(r.offset=s.offset.toString());const o=Object.keys(r).length>0?`?${new URLSearchParams(r).toString()}`:"",g=await j.get(`projects/${a}/executions/${t}/logs${o}`);return{logs:W.from(g.logs),totalCount:g.totalCount}}async fetchThreadData(a,t){return(await j.get(`projects/${a}/executions/${t}/thread-data`)).response}async get(a,t){const{executions:s}=await this.list({projectId:a,limit:1,search:t}),r=s.find(o=>o.id===t);if(r)return r;throw new Error(`Execution ${t} not found`)}async getExecutionTasks(a,t){return await j.get(`projects/${a}/executions/${t}/tasks`)}async fetchStages(){throw new Error("Method not implemented.")}async stopExecution(a,t){await j.post(`projects/${a}/executions/${t}/stop`,{})}async clear(){throw new Error("Method not implemented.")}}class Nt{async list(a){const t={...a,offset:a.offset?.toString(),limit:a.limit?.toString()};Object.keys(t).forEach(i=>t[i]===void 0&&delete t[i]);const s=Object.fromEntries(Object.entries(t??{}).filter(([,i])=>i!=null)),r=Object.keys(s).length>0?`?${new URLSearchParams(s).toString()}`:"",g=await(await fetch(`/_editor/api/executions${r}`)).json();return{executions:g.executions.map(i=>F.from(i)),totalCount:g.totalCount}}async fetchLogs(a,t,s){const o=await(await fetch(`/_editor/api/logs/${t}`)).json();return{logs:W.from(o),totalCount:o.length}}async fetchThreadData(){return{}}async get(a,t){const{executions:s}=await this.list({limit:1,search:t}),r=s.find(o=>o.id===t);if(r)return r;throw new Error(`Execution ${t} not found`)}async getExecutionTasks(a,t){return await(await fetch(`/_editor/api/executions/${t}/tasks`)).json()}async fetchStages(){return await(await fetch("/_editor/api/executions/stages")).json()}async stopExecution(a,t){if(!(await fetch(`/_editor/api/executions/${t}/stop`,{method:"POST"})).ok)throw new Error(`Failed to stop execution ${t}`)}async clear(){await fetch("/_editor/api/executions/clear",{method:"DELETE"})}}const $=300,Mt=lt("logs",()=>{const n=C(null),a=C(null),t=C(""),s=C(!1),r=C(),o=O({openedExecutionIds:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],executionData:{}}),g=O({currentIndex:1,pageSize:10,totalCount:0}),i=O({dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0,payload:{value:void 0,matchCase:!1,matchWholeWord:!1}}),y=O({builds:[],stages:[],statuses:vt.map(e=>({label:at(e),value:e}))}),I=mt({task:()=>Z(),interval:1e4}),d=async e=>{n.value=e.executionRepository,a.value=e.buildRepository,t.value=e.projectId,s.value=e.pool??!1,r.value=e.onFilterChange,Object.assign(i,e.filters||{}),Object.assign(g,e.pagination||{}),e.openedExecutionId&&(o.openedExecutionIds=[e.openedExecutionId]),await Promise.all([m(),G()]),J(),s.value&&I.startPolling()},D=()=>{I.endPolling()},m=async()=>{if(n.value){o.loadingExecutions=!0;try{const{executions:e,totalCount:c}=await n.value.list({projectId:t.value,buildId:i.buildId,status:i.status,limit:g.pageSize,offset:(g.currentIndex-1)*g.pageSize,stageId:i.stageId,startDate:i.dateRange?.[0]?.startOf("day").toISOString(),endDate:i.dateRange?.[1]?.endOf("day").toISOString(),search:i.search,payloadValue:i.payload.value,payloadMatchCase:i.payload.matchCase,payloadMatchWholeWord:i.payload.matchWholeWord});o.executions=e,g.totalCount=c}finally{o.loadingExecutions=!1}}},E=async()=>{if(!a.value){y.builds=[];return}const c=(await a.value.list(t.value)).map(l=>({label:`[${l.id.slice(0,8)}] ${l.createdAt.toLocaleString()} ${l.latest?"(Latest)":""}`,value:l.id,abstraVersion:l.abstraVersion}));y.builds=c},P=async()=>{if(y.stages=[],!n.value)return;if(!a.value){const h=(await n.value.fetchStages()).map(S=>({label:S.title,value:S.id}));y.stages=h??[];return}const e=i.buildId??(y.builds.length>0?y.builds[0].value:void 0);if(!e){console.warn("No buildId available for fetching stage options"),y.stages=[];return}const l=(await yt.get(e))?.runtimes.map(f=>({label:f.title,value:f.id}));y.stages=l??[]},G=async()=>{try{await E(),await P()}catch(e){console.error("Error fetching options:",e)}},T=async(e,c)=>{if(!n.value)return;const l=o.executionData[e],f=c||{limit:$,offset:0},[h,S,A]=await Promise.all([n.value.fetchLogs(t.value,e,f),n.value.fetchThreadData(t.value,e),n.value.getExecutionTasks(t.value,e)]),ct={currentIndex:1,pageSize:$,totalCount:h.totalCount,loading:!1};o.executionData[e]={logs:h.logs,threadData:S,tasks:{triggerTask:A.triggerTask?{type:A.triggerTask.type,payload:A.triggerTask.payload}:null,sentTasks:A.sentTasks.map(H=>({type:H.type,payload:H.payload}))},logsPagination:l?.logsPagination||ct},o.executionData[e].logsPagination&&(o.executionData[e].logsPagination.totalCount=h.totalCount,o.executionData[e].logsPagination.loading=!1)},J=()=>{o.openedExecutionIds.forEach(async e=>{o.executionData[e]||await T(e,{limit:$,offset:0})})},Z=async()=>{o.openedExecutionIds.map(e=>{const c=o.executions.find(f=>f.id===e);if(!c||c.status!=="running")return;const l=o.executionData[e];if(l?.logsPagination){const{currentIndex:f,pageSize:h}=l.logsPagination,S=(f-1)*h;return T(e,{limit:h,offset:S})}else return T(e,{limit:$,offset:0})})},Q=()=>{o.waitingDebounce=!0,g.currentIndex=1,ot(),r.value&&r.value(i)},ot=ut.debounce(async()=>{await m(),o.waitingDebounce=!1},500),nt=async e=>{let c=o.executions;return e&&(c=c.filter(f=>f.stageId===e)),c.length===0?null:c.reduce((f,h)=>f.createdAt>h.createdAt?f:h).id},U=async(e,c)=>{const l=o.executionData[e];if(!l?.logsPagination)return;const{pageSize:f}=l.logsPagination;l.logsPagination.loading=!0,l.logsPagination.currentIndex=c;const h=(c-1)*f;await T(e,{limit:f,offset:h})},st=(e,c)=>{const l=o.executionData[e];l?.logsPagination&&(l.logsPagination.pageSize=c,l.logsPagination.currentIndex=1,U(e,1))},it=async e=>{if(n.value)try{await n.value.stopExecution(t.value,e)}catch(c){throw console.error("Failed to stop execution",c),c}finally{await m()}},rt=async()=>{n.value&&(await n.value.clear(),await m())};return B(()=>i.buildId,()=>{P()}),B(i,()=>{o.openedExecutionIds=[],Q()}),B([()=>g.currentIndex,()=>g.pageSize],()=>{o.openedExecutionIds=[],m()}),{state:dt(()=>({currentPage:o,pagination:g,filters:i,filterOptions:y})),currentPage:o,pagination:g,filters:i,filterOptions:y,init:d,teardown:D,fetchPage:m,fetchBuildOptions:E,fetchStageOptions:P,fetchOptions:G,fetchExecutionDetails:T,fetchEmptyLogs:J,refetch:Z,handleFilterChange:Q,getNewestExecutionId:nt,fetchExecutionLogsPage:U,setExecutionLogsPageSize:st,stopExecution:it,clear:rt,polling:I}}),_t={key:0,class:"cli"},Et={key:0},kt=K({__name:"LogContainer",props:{logs:{},pagination:{}},emits:["page-change"],setup(n){return(a,t)=>(p(),k(u(M),{vertical:"",gap:"small"},{default:w(()=>[n.logs.entries.length?(p(),b("div",_t,[(p(!0),b(q,null,tt(n.logs.entries,s=>(p(),b("p",{key:s.createdAt,style:gt({margin:0,"white-space":"pre-wrap",color:s.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},[s.payload.text?(p(),b("span",Et,z(s.payload.text.trim()),1)):_("",!0)],4))),128))])):_("",!0),n.pagination?(p(),k(u(M),{key:1,vertical:"",gap:"small",align:"end"},{default:w(()=>[n.pagination.totalCount>u($)?(p(),k(u(ft),{key:0,current:n.pagination.currentIndex,"page-size":n.pagination.pageSize,total:n.pagination.totalCount,"show-size-changer":!1,"show-quick-jumper":!1,size:"small",onChange:t[0]||(t[0]=s=>a.$emit("page-change",s))},null,8,["current","page-size","total"])):_("",!0)]),_:1})):n.logs.entries.length?_("",!0):(p(),k(u(V),{key:2,type:"secondary"},{default:w(()=>[...t[1]||(t[1]=[R("Empty",-1)])]),_:1}))]),_:1}))}}),qt=et(kt,[["__scopeId","data-v-ee1d10cd"]]),St={key:0},Ct=["onClick"],It=["onClick"],Dt=K({__name:"ExecutionContext",props:{data:{},showFixWithAi:{type:Boolean},isSmartChatIdle:{type:Boolean}},emits:["ask-ai"],setup(n,{emit:a}){const t=n,s=a,r=C(!1),o=d=>{if(d==="legacyThreadData")return x.translate("i18n_executioncontext_thread_data");const D=at(d);return D.replace(/([A-Z])/g," $1").trim(),D},g=d=>d==null?!0:Array.isArray(d)?d.length===0:typeof d=="object"?Object.keys(d).length===0:!1,i=d=>{typeof d=="object"&&d!==null&&"payload"in d?(navigator.clipboard.writeText(JSON.stringify(d.payload)),L.success({content:x.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),L.error({content:x.translate("i18n_executioncontext_no_payload")}))},y=d=>{r.value=!0,d.stopPropagation(),t.isSmartChatIdle!==!1&&(s("ask-ai"),setTimeout(()=>{r.value=!1},1e3))},I=d=>{typeof d=="object"?(navigator.clipboard.writeText(JSON.stringify(d)),L.success({content:x.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),L.error({content:x.translate("i18n_executioncontext_failed_copy_request")}))};return(d,D)=>(p(),b(q,null,[v(u(M),{justify:"end"},{default:w(()=>[v(u(N),{title:n.isSmartChatIdle?"":u(x).translate("i18n_executioncontext_wait_or_stop"),placement:"left"},{default:w(()=>[n.showFixWithAi?(p(),b("div",{key:0,class:pt(["ask-to-ai",{disabled:!n.isSmartChatIdle||r.value}]),onClick:y},[R(z(u(x).translate("i18n_executioncontext_fix_with_ai"))+" ",1),v(u(wt),{size:16})],2)):_("",!0)]),_:1},8,["title"])]),_:1}),v(u(bt),{direction:"vertical",style:{"border-radius":"5px",padding:"10px",color:"#fff",width:"100%","font-family":"monospace","max-height":"600px",overflow:"auto",border:"1px solid #e8e8e8"}},{default:w(()=>[Object.keys(n.data).length?(p(!0),b(q,{key:1},tt(Object.entries(n.data),([m,E])=>(p(),b("div",{key:m,class:"tree"},[m!=="legacyThreadData"||!g(E)?(p(),b("div",St,[v(u(V),{strong:""},{default:w(()=>[R(z(o(m)),1)]),_:2},1024),m==="request"?(p(),k(u(N),{key:0,title:u(x).translate("i18n_executioncontext_copy_request_tooltip")},{default:w(()=>[X("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:P=>I(E)},[v(u(Y))],8,Ct)]),_:2},1032,["title"])):_("",!0),m==="triggerTask"?(p(),k(u(N),{key:1,title:u(x).translate("i18n_executioncontext_copy_payload_tooltip")},{default:w(()=>[X("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:P=>i(E)},[v(u(Y))],8,It)]),_:2},1032,["title"])):_("",!0),v(u(ht),{"tree-data":u(xt)(E),selectable:!1},null,8,["tree-data"])])):_("",!0)]))),128)):(p(),k(u(V),{key:0,type:"secondary"},{default:w(()=>[R(z(u(x).translate("i18n_executioncontext_empty")),1)]),_:1}))]),_:1})],64))}}),Vt=et(Dt,[["__scopeId","data-v-629427b0"]]);export{Vt as E,qt as L,Bt as R,Nt as a,Mt as u};
//# sourceMappingURL=ExecutionContext-HycJ3Wz6.js.map
