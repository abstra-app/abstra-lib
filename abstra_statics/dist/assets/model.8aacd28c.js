var zt=Object.defineProperty;var Vt=(n,e,t)=>e in n?zt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var u=(n,e,t)=>(Vt(n,typeof e!="symbol"?e+"":e,t),t);import{d as B,B as D,f,o as l,et as p,dA as Ee,ev as _,ey as ke,a as v,b as S,eE as Lt,c as I,w as g,eu as Te,u as c,aD as de,bi as ae,ar as E,cQ as C,bk as Ft,R as X,e as F,c_ as Zt,ez as O,cV as q,eL as Bt,eM as Gt,eK as G,Z as wt,a0 as Kt,g as Ut,eD as le,bx as re,aH as Wt,cj as pt,bG as jt,ex as ue,ci as Yt,ct as qt,eC as Ie,cB as Jt,am as Qt,Q as ce,eH as Xt,eI as es,cu as J}from"./vue-router.dc261a27.js";import{W as Me}from"./workspaces.f05359a3.js";import{v as Tt,a as It,n as xe,b as ts,c as ss,d as is,e as ns}from"./validations.c8d2c697.js";import{F as mt}from"./PhArrowSquareOut.vue.6476059c.js";import{s as be,w as K}from"./metadata.91634a8a.js";import"./index.36c0d369.js";import{B as oe}from"./Badge.1d11bb47.js";import{A as ze}from"./index.897a5e3c.js";import{A as ft}from"./index.ac84a20a.js";import{C as De}from"./Card.62f9333e.js";import"./api.a2966b31.js";import{u as as}from"./uuid.5dd2ed5a.js";(function(){try{var n=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[e]="ad3ad18e-2e4a-452d-80d7-2df18e7ac523",n._sentryDebugIdIdentifier="sentry-dbid-ad3ad18e-2e4a-452d-80d7-2df18e7ac523")}catch{}})();var rs={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M168 504.2c1-43.7 10-86.1 26.9-126 17.3-41 42.1-77.7 73.7-109.4S337 212.3 378 195c42.4-17.9 87.4-27 133.9-27s91.5 9.1 133.8 27A341.5 341.5 0 01755 268.8c9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47a8 8 0 003 14.1l175.7 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c0-6.7-7.7-10.5-12.9-6.3l-56.4 44.1C765.8 155.1 646.2 92 511.8 92 282.7 92 96.3 275.6 92 503.8a8 8 0 008 8.2h60c4.4 0 7.9-3.5 8-7.8zm756 7.8h-60c-4.4 0-7.9 3.5-8 7.8-1 43.7-10 86.1-26.9 126-17.3 41-42.1 77.8-73.7 109.4A342.45 342.45 0 01512.1 856a342.24 342.24 0 01-243.2-100.8c-9.9-9.9-19.2-20.4-27.8-31.4l60.2-47a8 8 0 00-3-14.1l-175.7-43c-5-1.2-9.9 2.6-9.9 7.7l-.7 181c0 6.7 7.7 10.5 12.9 6.3l56.4-44.1C258.2 868.9 377.8 932 512.2 932c229.2 0 415.5-183.7 419.8-411.8a8 8 0 00-8-8.2z"}}]},name:"sync",theme:"outlined"};const os=rs,ls=["width","height","fill","transform"],ds={key:0},us=v("path",{d:"M208.49,152.49l-72,72a12,12,0,0,1-17,0l-72-72a12,12,0,0,1,17-17L116,187V40a12,12,0,0,1,24,0V187l51.51-51.52a12,12,0,0,1,17,17Z"},null,-1),cs=[us],hs={key:1},gs=v("path",{d:"M200,144l-72,72L56,144Z",opacity:"0.2"},null,-1),ps=v("path",{d:"M207.39,140.94A8,8,0,0,0,200,136H136V40a8,8,0,0,0-16,0v96H56a8,8,0,0,0-5.66,13.66l72,72a8,8,0,0,0,11.32,0l72-72A8,8,0,0,0,207.39,140.94ZM128,204.69,75.31,152H180.69Z"},null,-1),ms=[gs,ps],fs={key:2},ys=v("path",{d:"M205.66,149.66l-72,72a8,8,0,0,1-11.32,0l-72-72A8,8,0,0,1,56,136h64V40a8,8,0,0,1,16,0v96h64a8,8,0,0,1,5.66,13.66Z"},null,-1),vs=[ys],Ss={key:3},ws=v("path",{d:"M204.24,148.24l-72,72a6,6,0,0,1-8.48,0l-72-72a6,6,0,0,1,8.48-8.48L122,201.51V40a6,6,0,0,1,12,0V201.51l61.76-61.75a6,6,0,0,1,8.48,8.48Z"},null,-1),Ts=[ws],Is={key:4},xs=v("path",{d:"M205.66,149.66l-72,72a8,8,0,0,1-11.32,0l-72-72a8,8,0,0,1,11.32-11.32L120,196.69V40a8,8,0,0,1,16,0V196.69l58.34-58.35a8,8,0,0,1,11.32,11.32Z"},null,-1),_s=[xs],Ps={key:5},Es=v("path",{d:"M202.83,146.83l-72,72a4,4,0,0,1-5.66,0l-72-72a4,4,0,0,1,5.66-5.66L124,206.34V40a4,4,0,0,1,8,0V206.34l65.17-65.17a4,4,0,0,1,5.66,5.66Z"},null,-1),ks=[Es],Ns={name:"PhArrowDown"},yt=B({...Ns,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(n){const e=n,t=D("weight","regular"),s=D("size","1em"),i=D("color","currentColor"),a=D("mirrored",!1),r=f(()=>{var d;return(d=e.weight)!=null?d:t}),o=f(()=>{var d;return(d=e.size)!=null?d:s}),y=f(()=>{var d;return(d=e.color)!=null?d:i}),w=f(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:a?"scale(-1, 1)":void 0);return(d,m)=>(l(),p("svg",ke({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:o.value,height:o.value,fill:y.value,transform:w.value},d.$attrs),[Ee(d.$slots,"default"),r.value==="bold"?(l(),p("g",ds,cs)):r.value==="duotone"?(l(),p("g",hs,ms)):r.value==="fill"?(l(),p("g",fs,vs)):r.value==="light"?(l(),p("g",Ss,Ts)):r.value==="regular"?(l(),p("g",Is,_s)):r.value==="thin"?(l(),p("g",Ps,ks)):_("",!0)],16,ls))}}),Cs=["width","height","fill","transform"],$s={key:0},Ms=v("path",{d:"M236,144a68.07,68.07,0,0,1-68,68H80a12,12,0,0,1,0-24h88a44,44,0,0,0,0-88H61l27.52,27.51a12,12,0,0,1-17,17l-48-48a12,12,0,0,1,0-17l48-48a12,12,0,1,1,17,17L61,76H168A68.08,68.08,0,0,1,236,144Z"},null,-1),bs=[Ms],Ds={key:1},As=v("path",{d:"M80,40v96L32,88Z",opacity:"0.2"},null,-1),Hs=v("path",{d:"M168,80H88V40a8,8,0,0,0-13.66-5.66l-48,48a8,8,0,0,0,0,11.32l48,48A8,8,0,0,0,88,136V96h80a48,48,0,0,1,0,96H80a8,8,0,0,0,0,16h88a64,64,0,0,0,0-128ZM72,116.69,43.31,88,72,59.31Z"},null,-1),Os=[As,Hs],Rs={key:2},zs=v("path",{d:"M232,144a64.07,64.07,0,0,1-64,64H80a8,8,0,0,1,0-16h88a48,48,0,0,0,0-96H88v40a8,8,0,0,1-13.66,5.66l-48-48a8,8,0,0,1,0-11.32l48-48A8,8,0,0,1,88,40V80h80A64.07,64.07,0,0,1,232,144Z"},null,-1),Vs=[zs],Ls={key:3},Fs=v("path",{d:"M230,144a62.07,62.07,0,0,1-62,62H80a6,6,0,0,1,0-12h88a50,50,0,0,0,0-100H46.49l37.75,37.76a6,6,0,1,1-8.48,8.48l-48-48a6,6,0,0,1,0-8.48l48-48a6,6,0,0,1,8.48,8.48L46.49,82H168A62.07,62.07,0,0,1,230,144Z"},null,-1),Zs=[Fs],Bs={key:4},Gs=v("path",{d:"M232,144a64.07,64.07,0,0,1-64,64H80a8,8,0,0,1,0-16h88a48,48,0,0,0,0-96H51.31l34.35,34.34a8,8,0,0,1-11.32,11.32l-48-48a8,8,0,0,1,0-11.32l48-48A8,8,0,0,1,85.66,45.66L51.31,80H168A64.07,64.07,0,0,1,232,144Z"},null,-1),Ks=[Gs],Us={key:5},Ws=v("path",{d:"M228,144a60.07,60.07,0,0,1-60,60H80a4,4,0,0,1,0-8h88a52,52,0,0,0,0-104H41.66l41.17,41.17a4,4,0,0,1-5.66,5.66l-48-48a4,4,0,0,1,0-5.66l48-48a4,4,0,0,1,5.66,5.66L41.66,84H168A60.07,60.07,0,0,1,228,144Z"},null,-1),js=[Ws],Ys={name:"PhArrowUUpLeft"},qs=B({...Ys,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(n){const e=n,t=D("weight","regular"),s=D("size","1em"),i=D("color","currentColor"),a=D("mirrored",!1),r=f(()=>{var d;return(d=e.weight)!=null?d:t}),o=f(()=>{var d;return(d=e.size)!=null?d:s}),y=f(()=>{var d;return(d=e.color)!=null?d:i}),w=f(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:a?"scale(-1, 1)":void 0);return(d,m)=>(l(),p("svg",ke({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:o.value,height:o.value,fill:y.value,transform:w.value},d.$attrs),[Ee(d.$slots,"default"),r.value==="bold"?(l(),p("g",$s,bs)):r.value==="duotone"?(l(),p("g",Ds,Os)):r.value==="fill"?(l(),p("g",Rs,Vs)):r.value==="light"?(l(),p("g",Ls,Zs)):r.value==="regular"?(l(),p("g",Bs,Ks)):r.value==="thin"?(l(),p("g",Us,js)):_("",!0)],16,Cs))}}),Js=["width","height","fill","transform"],Qs={key:0},Xs=v("path",{d:"M167.51,127.51,195,100H88a44,44,0,0,0,0,88h88a12,12,0,0,1,0,24H88A68,68,0,0,1,88,76H195L167.51,48.49a12,12,0,1,1,17-17l48,48a12,12,0,0,1,0,17l-48,48a12,12,0,0,1-17-17Z"},null,-1),ei=[Xs],ti={key:1},si=v("path",{d:"M224,88l-48,48V40Z",opacity:"0.2"},null,-1),ii=v("path",{d:"M172.94,143.39a8,8,0,0,0,8.72-1.73l48-48a8,8,0,0,0,0-11.32l-48-48A8,8,0,0,0,168,40V80H88a64,64,0,0,0,0,128h88a8,8,0,0,0,0-16H88a48,48,0,0,1,0-96h80v40A8,8,0,0,0,172.94,143.39ZM184,59.31,212.69,88,184,116.69Z"},null,-1),ni=[si,ii],ai={key:2},ri=v("path",{d:"M168,136V96H88a48,48,0,0,0,0,96h88a8,8,0,0,1,0,16H88A64,64,0,0,1,88,80h80V40a8,8,0,0,1,13.66-5.66l48,48a8,8,0,0,1,0,11.32l-48,48A8,8,0,0,1,168,136Z"},null,-1),oi=[ri],li={key:3},di=v("path",{d:"M171.76,131.76,209.51,94H88a50,50,0,0,0,0,100h88a6,6,0,0,1,0,12H88A62,62,0,0,1,88,82H209.51L171.76,44.24a6,6,0,0,1,8.48-8.48l48,48a6,6,0,0,1,0,8.48l-48,48a6,6,0,0,1-8.48-8.48Z"},null,-1),ui=[di],ci={key:4},hi=v("path",{d:"M170.34,130.34,204.69,96H88a48,48,0,0,0,0,96h88a8,8,0,0,1,0,16H88A64,64,0,0,1,88,80H204.69L170.34,45.66a8,8,0,0,1,11.32-11.32l48,48a8,8,0,0,1,0,11.32l-48,48a8,8,0,0,1-11.32-11.32Z"},null,-1),gi=[hi],pi={key:5},mi=v("path",{d:"M173.17,133.17,214.34,92H88a52,52,0,0,0,0,104h88a4,4,0,0,1,0,8H88A60,60,0,0,1,88,84H214.34L173.17,42.83a4,4,0,0,1,5.66-5.66l48,48a4,4,0,0,1,0,5.66l-48,48a4,4,0,0,1-5.66-5.66Z"},null,-1),fi=[mi],yi={name:"PhArrowUUpRight"},vi=B({...yi,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(n){const e=n,t=D("weight","regular"),s=D("size","1em"),i=D("color","currentColor"),a=D("mirrored",!1),r=f(()=>{var d;return(d=e.weight)!=null?d:t}),o=f(()=>{var d;return(d=e.size)!=null?d:s}),y=f(()=>{var d;return(d=e.color)!=null?d:i}),w=f(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:a?"scale(-1, 1)":void 0);return(d,m)=>(l(),p("svg",ke({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:o.value,height:o.value,fill:y.value,transform:w.value},d.$attrs),[Ee(d.$slots,"default"),r.value==="bold"?(l(),p("g",Qs,ei)):r.value==="duotone"?(l(),p("g",ti,ni)):r.value==="fill"?(l(),p("g",ai,oi)):r.value==="light"?(l(),p("g",li,ui)):r.value==="regular"?(l(),p("g",ci,gi)):r.value==="thin"?(l(),p("g",pi,fi)):_("",!0)],16,Js))}}),Si=["width","height","fill","transform"],wi={key:0},Ti=v("path",{d:"M128,20A108,108,0,1,0,236,128,108.12,108.12,0,0,0,128,20Zm0,192a84,84,0,1,1,84-84A84.09,84.09,0,0,1,128,212Zm68-84a12,12,0,0,1-12,12H128a12,12,0,0,1-12-12V72a12,12,0,0,1,24,0v44h44A12,12,0,0,1,196,128Z"},null,-1),Ii=[Ti],xi={key:1},_i=v("path",{d:"M224,128a96,96,0,1,1-96-96A96,96,0,0,1,224,128Z",opacity:"0.2"},null,-1),Pi=v("path",{d:"M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"},null,-1),Ei=[_i,Pi],ki={key:2},Ni=v("path",{d:"M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm56,112H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v48h48a8,8,0,0,1,0,16Z"},null,-1),Ci=[Ni],$i={key:3},Mi=v("path",{d:"M128,26A102,102,0,1,0,230,128,102.12,102.12,0,0,0,128,26Zm0,192a90,90,0,1,1,90-90A90.1,90.1,0,0,1,128,218Zm62-90a6,6,0,0,1-6,6H128a6,6,0,0,1-6-6V72a6,6,0,0,1,12,0v50h50A6,6,0,0,1,190,128Z"},null,-1),bi=[Mi],Di={key:4},Ai=v("path",{d:"M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"},null,-1),Hi=[Ai],Oi={key:5},Ri=v("path",{d:"M128,28A100,100,0,1,0,228,128,100.11,100.11,0,0,0,128,28Zm0,192a92,92,0,1,1,92-92A92.1,92.1,0,0,1,128,220Zm60-92a4,4,0,0,1-4,4H128a4,4,0,0,1-4-4V72a4,4,0,0,1,8,0v52h52A4,4,0,0,1,188,128Z"},null,-1),zi=[Ri],Vi={name:"PhClock"},Li=B({...Vi,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(n){const e=n,t=D("weight","regular"),s=D("size","1em"),i=D("color","currentColor"),a=D("mirrored",!1),r=f(()=>{var d;return(d=e.weight)!=null?d:t}),o=f(()=>{var d;return(d=e.size)!=null?d:s}),y=f(()=>{var d;return(d=e.color)!=null?d:i}),w=f(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:a?"scale(-1, 1)":void 0);return(d,m)=>(l(),p("svg",ke({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:o.value,height:o.value,fill:y.value,transform:w.value},d.$attrs),[Ee(d.$slots,"default"),r.value==="bold"?(l(),p("g",wi,Ii)):r.value==="duotone"?(l(),p("g",xi,Ei)):r.value==="fill"?(l(),p("g",ki,Ci)):r.value==="light"?(l(),p("g",$i,bi)):r.value==="regular"?(l(),p("g",Di,Hi)):r.value==="thin"?(l(),p("g",Oi,zi)):_("",!0)],16,Si))}});function vt(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?Object(arguments[e]):{},s=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(s=s.concat(Object.getOwnPropertySymbols(t).filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable}))),s.forEach(function(i){Fi(n,i,t[i])})}return n}function Fi(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}var Le=function(e,t){var s=vt({},e,t.attrs);return S(Lt,vt({},s,{icon:os}),null)};Le.displayName="SyncOutlined";Le.inheritAttrs=!1;const Zi=Le;function xt(n,e,t,s={}){n.strokeStyle=s.color||"black",n.lineWidth=t/3,n.lineJoin="round",n.lineCap="round";const i=Math.atan2(e.p2.y-e.p1.y,e.p2.x-e.p1.x);n.beginPath(),n.moveTo(e.p1.x,e.p1.y),n.lineTo(e.p2.x,e.p2.y),n.moveTo(e.p2.x-t*Math.cos(i-Math.PI/6),e.p2.y-t*Math.sin(i-Math.PI/6)),n.lineTo(e.p2.x,e.p2.y),n.lineTo(e.p2.x-t*Math.cos(i+Math.PI/6),e.p2.y-t*Math.sin(i+Math.PI/6)),n.stroke()}function Bi(n){return Ui(n.p1,n.p2)}function Z(n,e){return{dx:e.x-n.x,dy:e.y-n.y,referential:n.referential}}function Q(n,e){return{referential:n.referential,x:n.x+e.dx,y:n.y+e.dy}}function Gi(n,e){return{referential:n.referential,dx:n.dx*e,dy:n.dy*e}}function he(n,e,t){const{x:s,y:i,width:a,height:r}=t,{dx:o,dy:y}=e,{x:w,y:d}=n,m=(s-w)/o,T=(s+a-w)/o,P=(i-d)/y,A=(i+r-d)/y,L=Math.max(Math.min(m,T),Math.min(P,A));return{x:w+L*o,y:d+L*y,referential:n.referential}}function Ki(n,e){const t=Ve(n),s=Ve(e),i=he(s,Z(s,t),n),a=he(t,Z(t,s),e);return{p1:i,p2:a}}function Ve(n){return{x:n.x+n.width/2,y:n.y+n.height/2,referential:n.referential}}const Se=n=>n.reduce((e,t)=>{const s=e?Math.min(e.x,t.x):t.x,i=e?Math.min(e.y,t.y):t.y,a=e?Math.max(e.x+e.width,t.x+t.width):t.x+t.width,r=e?Math.max(e.y+e.height,t.y+t.height):t.y+t.height;return{x:s,y:i,width:a-s,height:r-i,referential:t.referential}},null);function Ui(n,e){return Math.sqrt((n.x-e.x)**2+(n.y-e.y)**2)}function _t(n,e){const{p1:t,p2:s}=n,i=Math.atan2(s.y-t.y,s.x-t.x),a=e*Math.sin(i),o={dx:e*Math.cos(i),dy:a,referential:t.referential},y=Q(t,o),w=Q(s,Gi(o,-1));return{p1:y,p2:w}}function St(n,e){return{referential:n.referential,x:n.x-e,y:n.y-e,width:n.width+2*e,height:n.height+2*e}}const Pt="#ababab",Fe="#e55b70",we=15,Ze=10;function _e(n,e){const t=n.getStageRect(e.id);return t?{x:t.x+t.width/2,y:t.y+t.height/2,referential:"screen"}:n.camera.worldPoint2screen({...e.position,referential:"world"})}function ge(n,e){const t=n.getStageRect(e.id);if(t)return t;{const s=_e(n,e);return{x:s.x-100/2,y:s.y-100/2,width:100,height:100,referential:"screen"}}}function Et(n,e){const t=n.model.getStage(e.sourceStageId),s=n.model.getStage(e.targetStageId);if(!t)throw new Error(`Source node ${e.sourceStageId} not found`);if(!s)throw new Error(`Target node ${e.targetStageId} not found`);const i=_e(n,t),a=_e(n,s),r=he(i,Z(i,a),ge(n,s));return{p1:he(r,Z(r,i),ge(n,t)),p2:r}}function Wi(n,e){const t=n.model.getTransition(e);if(!t)throw new Error(`Transition ${e} not found`);const s=Et(n,t);return{x:Math.min(s.p1.x,s.p2.x),y:Math.min(s.p1.y,s.p2.y),width:Math.abs(s.p1.x-s.p2.x),height:Math.abs(s.p1.y-s.p2.y),referential:"screen"}}function ji(n,e){const t=n.selection.has(e),s=Ze*n.camera.zoom,i=n.model.getStage(e.sourceStageId),a=n.model.getStage(e.targetStageId);if(!i)throw new Error(`Source node ${e.sourceStageId} not found`);if(!a)throw new Error(`Target node ${e.targetStageId} not found`);const r=St(ge(n,i),we*n.camera.zoom),o=St(ge(n,a),we*n.camera.zoom),y=Ki(r,o);Bi(y)<we*n.camera.zoom||xt(n.ctx,y,s,{color:t?Fe:Pt})}function Yi(n){for(const e of n.selection.selectedStages())if(n.mouseState.snappedTarget)kt(n,{id:"",sourceStageId:e.id,targetStageId:n.mouseState.snappedTarget.id,props:{conditionValue:null}});else{const t=_e(n,e),s=he(n.mouseState.mousePos,Z(n.mouseState.mousePos,t),ge(n,e)),i=n.mouseState.mousePos,r=_t({p1:s,p2:i},we*n.camera.zoom);xt(n.ctx,r,Ze*n.camera.zoom,{color:Pt})}}function kt(n,e){const t=n.model.getStage(e.sourceStageId),s=n.model.getStage(e.targetStageId);if(!t)throw new Error(`Source node ${e.sourceStageId} not found`);if(!s)throw new Error(`Target node ${e.targetStageId} not found`);ji(n,e);const i=n.getTransitionRect(e.id);i&&n.ctx.clearRect(i.x,i.y,i.width,i.height)}function Nt(n,e){const t=Et(n,e),s=_t(t,Ze*n.camera.zoom*Math.sin(Math.PI/6));return{x:(t.p1.x+s.p2.x)/2,y:(t.p1.y+s.p2.y)/2,referential:"screen"}}function qi(n,e){var i;const t=n.model.getStage(e.sourceStageId);if(!t)throw new Error(`Source node ${e.sourceStageId} not found`);const s=t.type;if(!s.includes("conditions")&&!s.includes("iterators"))throw new Error("Source node is not a flow controller");return(i=t.props)==null?void 0:i.variableName}function Ji(n,e){var i;const t=n.model.getStage(e.sourceStageId);if(!t)throw new Error(`Source node ${e.sourceStageId} not found`);const s=t.type;if(!s.includes("conditions")&&!s.includes("iterators"))throw new Error("Source node is not a flow controller");return(i=t.props)==null?void 0:i.itemName}const Qi={class:"menu-item"},Xi={class:"menu-item"},en={class:"menu-item"},tn={class:"menu-item"},sn={class:"menu-item"},nn=B({__name:"selection",props:{gui:{}},emits:["add-transition","duplicate-stages","revert-transitions","edit-stage","edit-transition","delete"],setup(n,{emit:e}){const t=n,s=f(()=>t.gui.selection.selectedIds().length===t.gui.selection.selectedStages().length),i=f(()=>t.gui.selection.selectedIds().length===t.gui.selection.selectedTransitions().length),a=f(()=>t.gui.selection.selectedIds().length>1||t.gui.selection.selectedIds().length===1&&t.gui.selection.selectedTransitions().length>0),r=f(()=>t.gui.selection.selectedIds().length===1),o=f(()=>t.gui.selection.selectedTransitions().some(R=>R.type.includes("iterators"))),y=f(()=>t.gui.selection.selectedIds().length>0&&t.gui.mouseState.showMenu);function w(){const N=t.gui.selection.selectedStages(),R=N.map($=>t.gui.getStageRect($.id)),x=t.gui.selection.selectedTransitions();return(x.length>1||N.length>0)&&R.push(...x.map($=>Wi(t.gui,$.id))),Se(R)}const d=f(()=>{const N=w();if(!N)if(i.value&&r.value){const x=t.gui.selection.selectedTransitions()[0],$=Nt(t.gui,x);return{menu:{transform:`translate(${$.x+50}px, ${$.y-10}px) scale(${t.gui.camera.zoom}) `,transformOrigin:"top left"},hull:{}}}else return{menu:{display:"none"},hull:{display:"none"}};const R={x:N.x+N.width+10,y:N.y,referential:"screen"};return{menu:{transform:`translate(${R.x}px, ${R.y}px)`,transformOrigin:"top left"},hull:{position:"absolute",top:`${N.y}px`,left:`${N.x}px`,width:`${N.width}px`,height:`${N.height}px`,pointerEvents:"none",border:`1px dashed ${Fe}`,boxSizing:"border-box"}}}),m=()=>e("add-transition"),T=()=>{s.value?e("edit-stage"):i.value&&e("edit-transition")},P=()=>e("duplicate-stages"),A=()=>e("delete"),L=()=>e("revert-transitions");return(N,R)=>(l(),p(de,null,[y.value?(l(),I(c(Ft),{key:0,class:"selection-menu",style:Te(d.value.menu)},{default:g(()=>[s.value?(l(),I(c(ae),{key:0,onClick:m},{default:g(()=>[v("div",Qi,[S(c(C),null,{default:g(()=>[E("Add transition")]),_:1}),S(c(C),{keyboard:""},{default:g(()=>[E("T")]),_:1})])]),_:1})):_("",!0),r.value&&!o.value?(l(),I(c(ae),{key:1,onClick:T},{default:g(()=>[v("div",Xi,[S(c(C),null,{default:g(()=>[E("Edit")]),_:1}),S(c(C),{keyboard:""},{default:g(()=>[E("Enter")]),_:1})])]),_:1})):_("",!0),s.value?(l(),I(c(ae),{key:2,onClick:P},{default:g(()=>[v("div",en,[S(c(C),null,{default:g(()=>[E("Duplicate")]),_:1}),S(c(C),{keyboard:""},{default:g(()=>[E("D")]),_:1})])]),_:1})):_("",!0),S(c(ae),{onClick:A},{default:g(()=>[v("div",tn,[S(c(C),null,{default:g(()=>[E("Delete")]),_:1}),S(c(C),{keyboard:""},{default:g(()=>[E("Del")]),_:1})])]),_:1}),i.value?(l(),I(c(ae),{key:3,onClick:L},{default:g(()=>[v("div",sn,[S(c(C),null,{default:g(()=>[E("Revert")]),_:1}),S(c(C),{keyboard:""},{default:g(()=>[E("R")]),_:1})])]),_:1})):_("",!0)]),_:1},8,["style"])):_("",!0),a.value?(l(),p("div",{key:1,class:"selection-hull",style:Te(d.value.hull)},null,4)):_("",!0)],64))}});const an=X(nn,[["__scopeId","data-v-54ac313a"]]),rn=1e3,on=["finished","failed","waiting","running"],Ta=({kanbanRepository:n})=>{const e=F([]),t=F([]),s=async()=>{try{return await n.countByStatus()}catch(y){return Zt(y),console.error(y),e.value}},i=async()=>{t.value=await n.getStages(),await r()};let a=null;const r=async()=>{const y=async()=>{try{e.value=await s()}finally{a=setTimeout(y,rn)}};y()};return{stageRunsCount:e,setup:i,tearDown:()=>{a&&clearTimeout(a)}}},ln={class:"base-badge"},dn={class:"base-badge",style:{"background-color":"#2db7f5",color:"#fff","box-shadow":"0 0 0 1px #ffffff"}},un=B({__name:"badges",props:{counter:{}},setup(n){return(e,t)=>(l(),I(c(q),{gap:"small",style:{"margin-top":"10px"}},{default:g(()=>[e.counter.finished>0?(l(),I(c(oe),{key:0,count:e.counter.finished,"number-style":{backgroundColor:"#33b891"}},null,8,["count"])):_("",!0),e.counter.failed>0?(l(),I(c(oe),{key:1,count:e.counter.failed,"number-style":{backgroundColor:"#fa675c"}},null,8,["count"])):_("",!0),e.counter.waiting>0?(l(),I(c(oe),{key:2},{count:g(()=>[v("div",ln,[E(O(e.counter.waiting>99?"99+":e.counter.waiting)+" ",1),S(c(Li),{size:12})])]),_:1})):_("",!0),e.counter.running>0?(l(),I(c(oe),{key:3},{count:g(()=>[v("div",dn,[E(O(e.counter.running>99?"99+":e.counter.running)+" ",1),S(c(Zi),{spin:!0,style:{"font-size":"10px"}})])]),_:1})):_("",!0)]),_:1}))}});const cn=X(un,[["__scopeId","data-v-6123b676"]]),ye=12;function Pe(n){return{x:Math.round(n.x/ye)*ye,y:Math.round(n.y/ye)*ye,referential:"world"}}function hn(n,e){const t=n.camera.screenPoint2world(e),s=Pe(t);return n.camera.worldPoint2screen(s)}function gn(n,e){const t={...e.position,referential:"world"},s=n.camera.worldPoint2screen(t);return n.selection.has(e)?hn(n,Q(s,Z(n.mouseState.initialMousePos,n.mouseState.mousePos))):s}const pn={key:1,class:"title-text"},mn={key:0},fn={key:1},yn={key:0,style:{"margin-top":"8px"}},vn={style:{width:"24px",height:"24px"}},Sn={style:{width:"24px",height:"24px"}},wn=B({__name:"stage",props:{stage:{},gui:{},viewOnly:{type:Boolean},stageRunCount:{}},emits:["change"],setup(n,{emit:e}){var lt,dt,ut;const t=n;Bt(h=>({"3ea13526":c(Fe)}));const s=Gt();function i(h){return h.type!=="conditions"&&h.type!=="iterators"}const a=()=>{const h=s.resolve({path:`/_editor/${t.stage.type.slice(0,-1)}/${t.stage.id}`});window.open(h.href,"_blank")},r=F(!0),o=G.exports.debounce(async h=>{Me.checkFile(h).then(k=>{r.value=k.exists})},500),y=f(()=>{const h=Tt(H.value);return h.valid?r.value?{valid:!0,help:"This file already exists, stage will point to it."}:{valid:!0,help:"File doesn't exist yet. It will be created."}:h}),w=F("idle"),d=async()=>{if(w.value="creating",t.stage.type==="conditions"||t.stage.type==="iterators")return;e("change","filename",H.value),await Me.initFile(H.value,t.stage.type),r.value=!0;const h=await Me.checkFile(H.value);r.value=h.exists,w.value="idle"},m=h=>{h!==void 0&&e("change","title",h)},T=()=>{const h=xe(ne.value);ne.value=h,x(h)},P=()=>{const h=xe(me.value);me.value=h,$(h)},A=f(()=>{if(t.stage.type!=="conditions"&&t.stage.type!=="iterators")return{validateStatus:"success",help:""};const h=It(ne.value);return h.valid?{validateStatus:"success",help:""}:{validateStatus:"error",help:h.reason}}),L=f(()=>A.value.validateStatus==="error"),N=f(()=>!r.value),R=f(()=>{if(L.value)return"red";if(N.value)return"gold"}),x=h=>{!h||e("change","variableName",h)},$=h=>{!h||e("change","itemName",h)},j=f(()=>{let h={};return on.map(k=>{var ct,ht,gt;const b=(gt=(ht=(ct=t.stageRunCount)==null?void 0:ct.find(Rt=>Rt.status===k))==null?void 0:ht.count)!=null?gt:0;h[k]=b}),h}),Y=F(t.stage.title),H=F((lt=t.stage.props.filename)!=null?lt:""),ne=F((dt=t.stage.props.variableName)!=null?dt:""),me=F((ut=t.stage.props.itemName)!=null?ut:""),Dt=f(()=>t.gui.selection.has(t.stage)),fe=f(()=>{var h;return t.gui.mouseState.state==="STAGE_QUICK_EDIT"&&((h=t.gui.mouseState.stage)==null?void 0:h.id)===t.stage.id}),$e=f(()=>t.stage.type==="conditions"||t.stage.type==="iterators"),At=f(()=>{const h=gn(t.gui,t.stage);return{transform:`translate(${h.x}px, ${h.y}px) scale(${t.gui.camera.zoom}) translate(-50%, -50%)`,transformOrigin:"top left"}}),Ht=()=>{t.stage.type==="conditions"||t.stage.type==="iterators"||t.viewOnly||o(H.value)};let ot;wt(()=>{ot=setInterval(Ht,1e3)}),Kt(()=>{clearInterval(ot)}),Ut(()=>t.stage.props.filename,()=>{e("change","filename",H.value)});const Ot=()=>{w.value="prompting",H.value=ts(Y.value),e("change","filename",H.value)};return(h,k)=>(l(),p("div",{class:ue(["stage-card",{selected:Dt.value,editing:fe.value,pointer:!h.viewOnly}]),style:Te(At.value),tabindex:"0"},[fe.value?(l(),I(c(De),{key:0,class:ue(["card","editing",{bodyLess:!$e.value&&r.value}])},{title:g(()=>[S(c(q),{justify:"space-between",align:"center"},{default:g(()=>[S(c(q),{align:"center"},{default:g(()=>[S(c(q),null,{default:g(()=>[(l(),I(le(c(be)(h.stage.type))))]),_:1}),i(h.stage)?(l(),I(c(re),{key:0,value:Y.value,"onUpdate:value":k[0]||(k[0]=b=>Y.value=b),bordered:!1,class:"title-input",onInput:k[1]||(k[1]=b=>m(b.target.value))},null,8,["value"])):(l(),p("span",pn,O(h.stage.title),1))]),_:1}),$e.value?_("",!0):(l(),I(c(Wt),{key:0},{title:g(()=>[h.gui.model.stageHasNonPositionChanges(h.stage.id)?(l(),p("span",fn,"Save to allow edit in "+O(h.stage.type)+" editor",1)):(l(),p("span",mn," Edit more in "+O(h.stage.type)+" editor ",1))]),default:g(()=>[h.gui.model.stageHasNonPositionChanges(h.stage.id)?(l(),I(c(mt),{key:1,style:{opacity:"0.5",cursor:"default"}})):(l(),I(c(mt),{key:0,onClick:a}))]),_:1}))]),_:1})]),default:g(()=>[$e.value?(l(),I(c(ze),{key:0,direction:"vertical",size:4,style:{width:"100%"}},{default:g(()=>[S(c(pt),{"validate-status":A.value.validateStatus},{default:g(()=>[S(c(C),null,{default:g(()=>[E("Variable name")]),_:1}),S(c(re),{value:ne.value,"onUpdate:value":k[2]||(k[2]=b=>ne.value=b),onChange:k[3]||(k[3]=b=>x(b.target.value)),onBlur:T},null,8,["value"]),h.stage.type==="iterators"?(l(),p("div",yn,[S(c(C),null,{default:g(()=>[E("Item name")]),_:1}),S(c(re),{value:me.value,"onUpdate:value":k[4]||(k[4]=b=>me.value=b),onChange:k[5]||(k[5]=b=>$(b.target.value)),onBlur:P},null,8,["value"])])):_("",!0),A.value.validateStatus==="error"?(l(),I(c(ft),{key:1,type:"error","show-icon":"",message:A.value.help,style:{"margin-top":"10px"}},null,8,["message"])):_("",!0)]),_:1},8,["validate-status"])]),_:1})):_("",!0),r.value?_("",!0):(l(),I(c(ft),{key:1,type:"warning","show-icon":""},{message:g(()=>[S(c(C),null,{default:g(()=>[E(" Python file is missing. ")]),_:1})]),action:g(()=>[S(c(jt),{size:"small",onClick:Ot},{default:g(()=>[E("Create")]),_:1})]),_:1}))]),_:1},8,["class"])):_("",!0),!fe.value&&(L.value||N.value)?(l(),I(c(oe),{key:1,count:"!",color:R.value},{default:g(()=>[S(c(De),{class:"card",style:{"max-width":"300px"}},{default:g(()=>[S(c(q),{align:"center",gap:"small"},{default:g(()=>[v("span",vn,[(l(),I(le(c(be)(h.stage.type)),{size:"22"}))]),S(c(C),{content:h.stage.title,ellipsis:!0,style:{width:"100%"}},null,8,["content"])]),_:1})]),_:1})]),_:1},8,["color"])):_("",!0),!fe.value&&!L.value&&!N.value?(l(),I(c(De),{key:2,class:"card"},{default:g(()=>[S(c(q),{align:"center",gap:"small"},{default:g(()=>[v("span",Sn,[(l(),I(le(c(be)(h.stage.type)),{size:"22"}))]),S(c(C),{content:h.stage.title,ellipsis:!0,style:{width:"100%"}},null,8,["content"])]),_:1}),h.viewOnly?(l(),I(cn,{key:0,counter:j.value},null,8,["counter"])):_("",!0)]),_:1})):_("",!0),S(c(qt),{open:w.value==="prompting"||w.value==="creating",closable:!1,"confirm-loading":w.value==="creating",onOk:d,onCancel:k[7]||(k[7]=b=>w.value="idle")},{default:g(()=>[S(c(Yt),{layout:"vertical",disabled:w.value=="creating"},{default:g(()=>[S(c(pt),{label:"You're creating a new file. What should it be called?","validate-status":y.value.valid?"success":"error",help:y.value.valid?y.value.help:y.value.reason},{default:g(()=>[S(c(re),{value:H.value,"onUpdate:value":k[6]||(k[6]=b=>H.value=b)},null,8,["value"])]),_:1},8,["validate-status","help"])]),_:1},8,["disabled"])]),_:1},8,["open","confirm-loading"])],6))}});const Tn=X(wn,[["__scopeId","data-v-733a02b2"]]),In={key:2},xn={key:3},_n={key:4,style:{"line-height":"80%"}},Pn=B({__name:"transition",props:{transition:{},gui:{},viewOnly:{type:Boolean}},emits:["change"],setup(n,{emit:e}){const t=n,s=x=>{e("change","type",String(x))},i=x=>{!x||e("change","conditionValue",x)},a=t.gui.model.getStage(t.transition.sourceStageId);if(!a)throw new Error(`No source stage found for transition ${t.transition.id}`);const r=K.stages.find(x=>x.typeName===a.type),o=f(()=>{const x=r==null?void 0:r.transitions.find($=>$.typeName===t.transition.type);if(!x)throw new Error(`No metadata found for transition ${t.transition.type}`);return x.title}),y=f(()=>!A.value&&!P.value?"":qi(t.gui,t.transition)),w=f(()=>{var x;return P.value&&((x=t.transition.props)==null?void 0:x.conditionValue)||""}),d=f(()=>A.value?Ji(t.gui,t.transition):""),m=f(()=>{var x;return t.gui.mouseState.state!=="CHANGING_TRANSITION_TYPE"?!1:((x=t.gui.mouseState.transition)==null?void 0:x.id)===t.transition.id}),T=f(()=>{var x;return t.gui.mouseState.state!=="TRANSITION_QUICK_EDIT"?!1:((x=t.gui.mouseState.transition)==null?void 0:x.id)===t.transition.id}),P=f(()=>t.transition.type.includes("conditions")),A=f(()=>t.transition.type.includes("iterators")),L=f(()=>t.gui.selection.has(t.transition)),N=f(()=>{var x,$;return t.gui.mouseState.state!=="CHANGING_TRANSITION_TYPE"?"":($=t.gui.mouseState.transitionDraft.type)!=null?$:(x=t.gui.mouseState.transition)==null?void 0:x.type}),R=f(()=>{const x=Nt(t.gui,t.transition);return{transform:`translate(${x.x}px, ${x.y}px) scale(${t.gui.camera.zoom}) translate(-50%, -50%)`,transformOrigin:"top left",padding:T.value?"6px":"0"}});return(x,$)=>(l(),p("div",{class:ue(["transition-card",{selected:L.value,pointer:!x.viewOnly}]),style:Te(R.value),tabindex:"0"},[m.value?(l(),I(c(ze),{key:0,class:"editing"},{default:g(()=>[S(c(Qt),{class:"selector","default-value":N.value,"onUpdate:value":s},{default:g(()=>{var j,Y;return[(l(!0),p(de,null,Ie((Y=(j=c(r))==null?void 0:j.transitions)!=null?Y:[],H=>(l(),I(c(Jt),{key:H.typeName},{default:g(()=>[(l(),I(le(H.icon))),E(" "+O(H.title),1)]),_:2},1024))),128))]}),_:1},8,["default-value"])]),_:1})):T.value&&P.value?(l(),I(c(ze),{key:1,class:"editing"},{default:g(()=>[S(c(re),{style:{width:"200px"},"default-value":w.value,onChange:$[0]||($[0]=j=>i(j.target.value))},{addonBefore:g(()=>[E("= ")]),_:1},8,["default-value"])]),_:1})):P.value?(l(),p("span",In,[S(c(C),{code:""},{default:g(()=>[E(O(y.value),1)]),_:1}),E(" = "+O(w.value),1)])):A.value?(l(),p("span",xn,[E(" for "),S(c(C),{code:""},{default:g(()=>[E(O(d.value),1)]),_:1}),E(" in "),S(c(C),{code:""},{default:g(()=>[E(O(y.value),1)]),_:1})])):(l(),p("span",_n,O(o.value),1))],6))}});const En=X(Pn,[["__scopeId","data-v-c354a0ec"]]);class Be{static get isMac(){return navigator.userAgent.includes("Mac OS X")}static get buildPlatform(){return{}.CURRENT_PLATFORM||"web"}}const Ae=n=>Be.isMac&&n.ctrlKey,U=n=>Be.isMac?n.metaKey:n.ctrlKey,kn=n=>n.altKey,V=n=>n.shiftKey,He={alt:kn,"arrow-up":n=>n.code==="ArrowUp","arrow-down":n=>n.code==="ArrowDown","arrow-left":n=>n.code==="ArrowLeft","arrow-right":n=>n.code==="ArrowRight",ctrl:U,delete:n=>Be.isMac?n.code==="Backspace":n.code==="Delete",enter:n=>n.code==="Enter",escape:n=>n.code==="Escape",shift:V,space:n=>n.code==="Space",a:n=>n.code==="KeyA",b:n=>n.code==="KeyB",c:n=>n.code==="KeyC",d:n=>n.code==="KeyD",f:n=>n.code==="KeyF",g:n=>n.code==="KeyG",h:n=>n.code==="KeyH",k:n=>n.code==="KeyK",p:n=>n.code==="KeyP",v:n=>n.code==="KeyV",x:n=>n.code==="KeyX",z:n=>n.code==="KeyZ",0:n=>n.code==="Digit0","[":n=>n.code==="BracketLeft","]":n=>n.code==="BracketRight"};class Nn{constructor(e){u(this,"pressedKeys");u(this,"evt");this.evt=e,this.pressedKeys={};const t=s=>i=>{Object.keys(He).forEach(a=>{He[a](i)&&this.setPressed(a,s)})};this.evt||(window.addEventListener("keydown",t(!0)),window.addEventListener("keyup",t(!1)))}setPressed(e,t){this.pressedKeys[e]=t}isPressed(e){var t;return this.evt?He[e](this.evt):(t=this.pressedKeys[e])!=null?t:!1}}new Nn;class Cn{constructor(e){u(this,"selected");this.model=e,this.selected=ce([])}deselect(e){this.selected.value=this.selected.value.filter(t=>t.type==="stage"?!e.includes(t.stage.id):!e.includes(t.transition.id))}select(e,t=!1){t||(this.selected.value=[]),e.forEach(s=>{const i=this.model.getStage(s);i&&(this.selected.value=[...this.selected.value,{type:"stage",stage:i}]);const a=this.model.getTransition(s);if(a&&(this.selected.value=[...this.selected.value,{type:"transition",transition:a}]),!i&&!a)throw new Error(`Could not find stage or transition with id ${s}`)})}clear(){this.selected.value=[]}selectedStages(){return this.selected.value.map(e=>e.type==="stage"?this.model.getStage(e.stage.id):null).filter(Boolean)}selectedTransitions(){return this.selected.value.map(e=>e.type==="transition"?this.model.getTransition(e.transition.id):null).filter(Boolean)}selectedIds(){return this.selected.value.map(e=>e.type==="stage"?e.stage.id:e.transition.id)}has(e){return this.selected.value.some(t=>t.type==="stage"?t.stage.id===e.id:t.transition.id===e.id)}isEmpty(){return this.selected.value.length===0}selectAllStages(){this.select(this.model.getState().stages.map(e=>e.id))}}const ve={left:100,right:100,top:100,bottom:100},Oe=1,Re=.5;class Ge{constructor(e){u(this,"_state");u(this,"projectedElement");this._state=F({x:0,y:0,zoom:1}),this.projectedElement=e}get x(){return this._state.value.x}set x(e){if(Number.isNaN(e))throw new Error("x is NaN");this._state.value.x=e}get y(){return this._state.value.y}set y(e){if(Number.isNaN(e))throw new Error("y is NaN");this._state.value.y=e}static create(e){return new Ge(e)}get zoom(){return this._state.value.zoom}set zoom(e){if(e<=0)throw new Error("Zoom must be positive");this._state.value.zoom=e}fit(e){const t={x:e.x+e.width/2,y:e.y+e.height/2,referential:"world"},s=this.screenRect2world(this.canvasRect);this.x=t.x-s.width/2,this.y=t.y-s.height/2;const i=this.canvasRect.width-ve.left-ve.right,a=this.canvasRect.height-ve.top-ve.bottom,r=Math.min(i/e.width,a/e.height)/this.zoom;this.zoomIn(Math.min(Oe/this.zoom,Math.max(Re/this.zoom,r)),this.worldPoint2screen(t))}screenPoint2world(e){return{x:e.x/this.zoom+this.x,y:e.y/this.zoom+this.y,referential:"world"}}worldPoint2screen(e){return{x:(e.x-this.x)*this.zoom,y:(e.y-this.y)*this.zoom,referential:"screen"}}screenDelta2world(e){return{dx:e.dx/this.zoom,dy:e.dy/this.zoom,referential:"world"}}worldDelta2screen(e){return{dx:e.dx*this.zoom,dy:e.dy*this.zoom,referential:"screen"}}screenRect2world(e){const t=this.screenPoint2world({x:e.x,y:e.y,referential:e.referential}),s=this.screenPoint2world({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:s.x-t.x,height:s.y-t.y,referential:t.referential}}worldRect2screen(e){const t=this.worldPoint2screen({x:e.x,y:e.y,referential:e.referential}),s=this.worldPoint2screen({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:s.x-t.x,height:s.y-t.y,referential:t.referential}}zoomIn(e,t){const s=this.screenPoint2world(t);this.zoom*e>Oe?this.zoom=Oe:this.zoom*e<Re?this.zoom=Re:this.zoom*=e;const i=this.worldPoint2screen(s),a=Z(t,i),r=this.screenDelta2world({dx:a.dx,dy:a.dy,referential:"screen"});this.x+=r.dx,this.y+=r.dy}translate(e){this.x+=e.dx,this.y+=e.dy}get canvasRect(){if(!this.projectedElement)throw new Error("No canvas element");const e=this.projectedElement.getBoundingClientRect();return{x:e.x,y:e.y,width:e.width,height:e.height,referential:"screen"}}}class z{constructor(e,t,s,i,a){u(this,"state");u(this,"mousePos");u(this,"initialMousePos");u(this,"camera");u(this,"selection");u(this,"model");u(this,"stage",null);u(this,"transition",null);u(this,"stageDraft",{});u(this,"transitionDraft",{});u(this,"pivot");u(this,"editing",!1);u(this,"snappedTarget",null);u(this,"showMenu",!1);this.state=e,this.mousePos=t,this.initialMousePos=t,this.camera=s,this.selection=i,this.model=a}computeCursorStyle(){return"grab"}onMouseMove(e,t){return this}onMouseUp(){return this}onDragover(e){return this}onDrop(e){return this}onMouseDown(e,t,s,i,a){return this}onHoverEnter(e,t){return this}onHoverLeave(){return this}saveChanges(){return this}setStageDraft(e,t){}setTransitionDraft(e,t){}}const $n="PANNING";class ee extends z{constructor(t,s,i,a,r){super($n,t,i,a,r);u(this,"initialMousePos");this.initialMousePos=s}static create(t,s,i,a,r){return new ee(t,s,i,a,r)}computeCursorStyle(){return"grabbing"}onMouseMove(t){const s=Z(t,this.mousePos),i=this.camera.screenDelta2world(s);return this.camera.translate(i),this.mousePos=t,this}onMouseUp(){return M.create(this.mousePos,this.camera,this.selection,this.model)}onMouseDown(t){return this.initialMousePos=t,this.mousePos=t,this.selection.clear(),this}}const Mn="MOVING";class pe extends z{constructor(t,s,i,a,r,o){super(Mn,t,a,r,o);u(this,"initialMousePos");u(this,"duplicating");this.initialMousePos=s,this.duplicating=i,this.pivot=r.selectedStages().length===1?r.selectedStages()[0]:void 0}static create(t,s,i,a,r,o){return new pe(t,s,i,a,r,o)}computeCursorStyle(){return"move"}onMouseMove(t){return pe.create(t,this.initialMousePos,this.duplicating,this.camera,this.selection,this.model)}onMouseUp(){const t=this.camera.screenPoint2world(this.initialMousePos),s=this.camera.screenPoint2world(this.mousePos),i=Z(t,s);return this.duplicating?(this.model.move(this.selection.selectedStages().map(a=>({id:a.id,position:Q({...a.position,referential:"world"},i)}))),M.create(this.mousePos,this.camera,this.selection,this.model)):(this.model.move(this.selection.selectedStages().map(a=>({id:a.id,position:Pe(Q({...a.position,referential:"world"},i))}))),this.pivot?se.create(this.mousePos,this.pivot,this.camera,this.selection,this.model):M.create(this.mousePos,this.camera,this.selection,this.model))}onMouseDown(t,s,i,a){return this.duplicating?this:(this.selection.clear(),ee.create(t,this.initialMousePos,this.camera,this.selection,this.model))}getScreenPos(t){const s={...t.position,referential:"world"},i=this.camera.worldPoint2screen(s),a=Q(i,Z(this.initialMousePos,this.mousePos)),r=this.camera.screenPoint2world(a),o=Pe(r);return this.camera.worldPoint2screen(o)}}const bn="JUST_CLICKED_STAGE";class te extends z{constructor(t,s,i,a,r){super(bn,t,i,a,r);u(this,"stage");this.stage=s}static create(t,s,i,a,r){return new te(t,s,i,a,r)}computeCursorStyle(){return"default"}onMouseMove(t,s){return s?this:pe.create(t,this.mousePos,!1,this.camera,this.selection,this.model)}onMouseUp(){return se.create(this.mousePos,this.stage,this.camera,this.selection,this.model)}}const Dn="HOVERING_STAGE";class se extends z{constructor(t,s,i,a,r){super(Dn,t,i,a,r);u(this,"stage");this.stage=s,this.showMenu=!0}static create(t,s,i,a,r){return new se(t,s,i,a,r)}computeCursorStyle(){return"pointer"}onMouseDown(t,s,i,a,r){return!this.selection.has(i)&&!r&&this.selection.select([i.id],V(s)),s.button!==0?this:te.create(t,i,this.camera,this.selection,this.model)}onHoverLeave(){return M.create(this.mousePos,this.camera,this.selection,this.model)}}const An="JUST_CLICKED_TRANSITION";class ie extends z{constructor(t,s,i,a,r){super(An,t,i,a,r);u(this,"transition");this.transition=s}static create(t,s,i,a,r){return new ie(t,s,i,a,r)}computeCursorStyle(){return"default"}onMouseUp(){return Ne.create(this.mousePos,this.transition,this.camera,this.selection,this.model)}}const Hn="HOVERING_TRANSITION";class Ne extends z{constructor(t,s,i,a,r){super(Hn,t,i,a,r);u(this,"initialMousePos");u(this,"transition");this.transition=s,this.initialMousePos=t,this.showMenu=!0}static create(t,s,i,a,r){return new Ne(t,s,i,a,r)}computeCursorStyle(){return"pointer"}onMouseDown(t,s,i,a,r){return a&&!this.selection.has(a)&&!r?(this.selection.select([a.id],V(s)),ie.create(t,a,this.camera,this.selection,this.model)):(this.selection.clear(),ee.create(t,t,this.camera,this.selection,this.model))}onHoverLeave(){return M.create(this.mousePos,this.camera,this.selection,this.model)}}const On="IDLE";class M extends z{constructor(e,t,s,i){super(On,e,t,s,i),this.showMenu=!0}static create(e,t,s,i){return new M(e,t,s,i)}onMouseDown(e){return this.selection.clear(),ee.create(e,e,this.camera,this.selection,this.model)}onHoverEnter(e,t){return e?se.create(this.mousePos,e,this.camera,this.selection,this.model):t?Ne.create(this.mousePos,t,this.camera,this.selection,this.model):this}}const Rn="ADDING_STAGES";class Ke extends z{constructor(t,s,i,a,r){super(Rn,t,i,a,r);u(this,"stages");u(this,"keepAdding",t=>{this.mousePos=t,this.stages=this.stages.map(s=>({...s,position:Pe(this.camera.screenPoint2world(t))}))});u(this,"finishAdding",t=>{this.keepAdding(t);const s=this.model.addStages(this.stages);this.selection.select(s.map(i=>i.id))});this.stages=s}static create(t,s,i,a,r){return new Ke(t,s,i,a,r)}computeCursorStyle(){return"grab"}onMouseMove(t){return this.keepAdding(t),this}onDragover(t){return this.keepAdding(t),this}onDrop(t){return this.finishAdding(t),M.create(this.mousePos,this.camera,this.selection,this.model)}onMouseDown(t){return this.finishAdding(t),M.create(this.mousePos,this.camera,this.selection,this.model)}}const zn="ADDING_TRANSITION";class Ue extends z{constructor(t,s,i,a,r,o){super(zn,t,a,r,o);u(this,"initialMousePos");u(this,"snappedTarget");this.initialMousePos=s,this.snappedTarget=i}static create(t,s,i,a,r,o){return new Ue(t,s,i,a,r,o)}computeCursorStyle(){return"crosshair"}onMouseMove(t){return this.mousePos=t,this}onMouseDown(t,s,i){if(i){const a=this.snappedTarget;if(!a)return this;const r=this.selection.selectedStages().map(o=>({sourceStageId:o.id,targetStageId:a.id}));return this.model.addTransitions(r),this.selection.select([a.id]),se.create(t,i,this.camera,this.selection,this.model)}return this.selection.clear(),ee.create(t,t,this.camera,this.selection,this.model)}onHoverEnter(t){return t&&(this.snappedTarget=t),this}onHoverLeave(){return this.snappedTarget=null,this}}const Vn="CHANGING_TRANSITION_TYPE";class We extends z{constructor(t,s,i,a,r){super(Vn,t,i,a,r);u(this,"initialMousePos");u(this,"transition");this.transition=s,this.initialMousePos=t,this.editing=!0}static create(t,s,i,a,r){return new We(t,s,i,a,r)}onMouseDown(t,s,i,a){return a&&this.transition.id===a.id?this:(this.saveChanges(),i?(this.selection.select([i.id],V(s)),te.create(t,i,this.camera,this.selection,this.model)):a?(this.selection.select([a.id],V(s)),ie.create(t,a,this.camera,this.selection,this.model)):(this.selection.clear(),M.create(this.mousePos,this.camera,this.selection,this.model)))}saveChanges(){return this.transitionDraft.type&&this.model.updateTransitionType(this.transition.id,this.transitionDraft.type),M.create(this.mousePos,this.camera,this.selection,this.model)}setTransitionDraft(t,s){this.transitionDraft={...this.transitionDraft,[t]:s}}}const Ln="STAGE_QUICK_EDIT";class je extends z{constructor(t,s,i,a,r){super(Ln,t,i,a,r);u(this,"initialMousePos");u(this,"stage");this.stage=s,this.initialMousePos=t,this.editing=!0}static create(t,s,i,a,r){return new je(t,s,i,a,r)}onMouseDown(t,s,i,a){return i&&this.stage.id===i.id?this:(this.saveChanges(),i?(this.selection.select([i.id],V(s)),te.create(t,i,this.camera,this.selection,this.model)):a?(this.selection.select([a.id],V(s)),ie.create(t,a,this.camera,this.selection,this.model)):(this.selection.clear(),M.create(this.mousePos,this.camera,this.selection,this.model)))}saveChanges(){return this.stageDraft.title&&this.model.updateStageTitle(this.stage.id,this.stageDraft.title),this.stageDraft.props&&this.model.updateStageProps(this.stage.id,{...this.stage.props,...this.stageDraft.props}),M.create(this.mousePos,this.camera,this.selection,this.model)}setStageDraft(t,s){if(t==="title"){this.stageDraft={...this.stageDraft,title:s};return}let i=s;(t==="variableName"||t==="itemName")&&(i=xe(s)),this.stageDraft={...this.stageDraft,props:{...this.stageDraft.props,[t]:i}}}}const Fn="TRANSITION_QUICK_EDIT";class Ye extends z{constructor(t,s,i,a,r){super(Fn,t,i,a,r);u(this,"initialMousePos");u(this,"transition");this.transition=s,this.initialMousePos=t,this.editing=!0}static create(t,s,i,a,r){return new Ye(t,s,i,a,r)}onMouseDown(t,s,i,a){return a&&this.transition.id===a.id?this:(this.saveChanges(),i?(this.selection.select([i.id],V(s)),te.create(t,i,this.camera,this.selection,this.model)):a?(this.selection.select([a.id],V(s)),ie.create(t,a,this.camera,this.selection,this.model)):(this.selection.clear(),M.create(this.mousePos,this.camera,this.selection,this.model)))}saveChanges(){return this.transitionDraft.conditionValue&&this.model.updateTransitionProps(this.transition.id,{conditionValue:this.transitionDraft.conditionValue}),M.create(this.mousePos,this.camera,this.selection,this.model)}setTransitionDraft(t,s){this.transitionDraft={...this.transitionDraft,[t]:s}}}const Zn=2;class qe{constructor(e,t){u(this,"_mouseState");u(this,"selection");u(this,"canvas");u(this,"ctx");u(this,"camera");u(this,"model");u(this,"viewOnly",!1);this.canvas=e,this.model=t,this.selection=new Cn(t),this.camera=Ge.create(e),this._mouseState=ce(M.create({x:0,y:0,referential:"screen"},this.camera,this.selection,this.model));const s=e.getContext("2d");if(!s)throw new Error("Unable to get canvas context");this.ctx=s}static create(e,t,s){const i=new qe(e,t);return s&&(i.viewOnly=!0),i.init(),i}get mouseState(){return this._mouseState.value}set mouseState(e){this._mouseState.value=e,this.canvas.style.cursor=e.computeCursorStyle()}goToIdle(){this.mouseState=M.create(this.mouseState.mousePos,this.camera,this.selection,this.model)}fixSize(){const{width:e,height:t}=this.canvas.getBoundingClientRect();this.canvas.width=e*devicePixelRatio,this.canvas.height=t*devicePixelRatio,this.ctx.scale(devicePixelRatio,devicePixelRatio)}setUpGlobalKeyDown(){let e=null;addEventListener("mousemove",t=>e=t),window.addEventListener("keydown",t=>{if(!!e&&!this.mouseState.editing)if(t.key==="t"||t.key==="T")this.selection.selectedStages().length&&this.startAddingTransition();else if(t.key==="f"||t.key==="F")this.dragstart("forms",e);else if(t.key==="h"||t.key==="H")this.dragstart("hooks",e);else if(t.key==="j"||t.key==="J")this.dragstart("jobs",e);else if(t.key==="c"||t.key==="C")this.dragstart("conditions",e);else if(t.key==="i"||t.key==="I")this.dragstart("iterators",e);else if(t.key==="s"||t.key==="S"){if(U(t))return;this.dragstart("scripts",e)}else(t.key==="z"||t.key==="Z")&&U(t)?(V(t)?this.model.history.redo():this.model.history.undo(),t.preventDefault()):(t.key==="a"||t.key==="A")&&U(t)?(this.selection.selectAllStages(),t.preventDefault()):(t.key==="Delete"||t.key==="Backspace")&&this.deleteSelection()})}setupMousemove(){const e=t=>{const s=this.getScreenPointerFromEvent(t);this.mouseState=this.mouseState.onMouseMove(s,this.viewOnly)};addEventListener("mousemove",e)}setupMouseup(){const e=()=>{this.mouseState=this.mouseState.onMouseUp()};addEventListener("mouseup",e)}setupDragover(){const e=t=>{t.preventDefault();const s=this.getScreenPointerFromEvent(t);this.mouseState=this.mouseState.onDragover(s)};this.canvas.addEventListener("dragover",e)}setupDrop(){const e=t=>{t.stopPropagation();const s=this.getScreenPointerFromEvent(t);this.mouseState=this.mouseState.onDrop(s)};this.canvas.addEventListener("drop",e)}setupWheel(){var t;const e=s=>{if(!this.camera)return;const i=this.getScreenPointerFromEvent(s);if(U(s)||Ae(s))this.computeZoomIn(i,s.deltaY>0?.9:1.1),s.preventDefault();else{const a=V(s)?{dx:s.deltaY,dy:0}:{dx:s.deltaX,dy:s.deltaY},r=this.camera.screenDelta2world({dx:a.dx,dy:a.dy,referential:"screen"});this.camera.translate(r)}s.stopPropagation()};(t=this.canvas.parentElement)==null||t.addEventListener("wheel",e)}setupMousedown(){const e=t=>{const s=this.getScreenPointerFromEvent(t);this.mouseState=this.mouseState.onMouseDown(s,t)};this.canvas.addEventListener("mousedown",e)}computeZoomIn(e,t){this.camera.zoomIn(t,e)}startEditingSelection(){if(this.selection.selectedStages().length!==1)return;const e=this.selection.selectedStages()[0];this.startEditingStage(e)}duplicateSelection(){const e=this.model.duplicateStages([...this.selection.selectedStages()]),t=Ve(Se(e.stages.map(i=>({x:i.position.x,y:i.position.y,width:1,height:1,referential:"world"})))),s=this.camera.worldPoint2screen(t);return this.mouseState=pe.create(this.mouseState.mousePos,s,!0,this.camera,this.selection,this.model),e}duplicateThenSelect(){const t=this.duplicateSelection().stages.map(s=>s.id);this.selection.select(t)}getScreenPointerFromEvent(e){const t=this.canvas.getBoundingClientRect();return{x:e.pageX-t.x,y:e.pageY-t.y,referential:"screen"}}async deleteSelection(){this.model.delete(this.selection.selectedIds()),this.clearSelection(),this.goToIdle()}startHoveringStage(e){this.mouseState=this.mouseState.onHoverEnter(e)}stageMouseDown(e,t){const s=this.getScreenPointerFromEvent(e);this.mouseState=this.mouseState.onMouseDown(s,e,t,void 0,this.viewOnly)}finishHoveringStage(){this.mouseState=this.mouseState.onHoverLeave()}startEditingStage(e){var t;this.viewOnly||this.mouseState.editing&&((t=this.mouseState.stage)==null?void 0:t.id)===e.id||(this.mouseState=je.create(this.mouseState.mousePos,e,this.camera,this.selection,this.model))}startChangingTransitionSelection(){if(this.selection.selectedTransitions().length!==1)return;const e=this.selection.selectedTransitions()[0];this.startChangingTransition(e)}computeChangeStage(e,t){this.mouseState.setStageDraft(e,t)}computeKeyDownStage(e){if(!this.viewOnly){if(e.key==="Enter"&&this.mouseState.state==="STAGE_QUICK_EDIT"){this.mouseState=this.mouseState.saveChanges();return}this.mouseState.editing||(e.key==="t"||e.key==="T"?this.startAddingTransition():e.key==="Enter"?this.selection.selectedStages().length===1&&this.startEditingStage(this.selection.selectedStages()[0]):e.key==="d"||e.key==="D"?this.duplicateThenSelect():e.key==="Delete"||e.key==="Backspace"?this.deleteSelection():(e.key==="a"||e.key==="A")&&(U(e)||Ae(e))?(this.selection.select(this.model.getState().stages.map(t=>t.id)),e.preventDefault()):e.key==="Escape"&&(this.clearSelection(),this.goToIdle()))}}transitionMouseDown(e,t){this.viewOnly||(this.mouseState=this.mouseState.onMouseDown(this.getScreenPointerFromEvent(e),e,void 0,t,this.viewOnly))}startHoveringTransition(e){this.mouseState=this.mouseState.onHoverEnter(void 0,e)}finishHoveringTransition(){this.mouseState=this.mouseState.onHoverLeave()}computeChangeTransition(e,t){this.mouseState.setTransitionDraft(e,t)}startAddingTransition(){this.mouseState=Ue.create(this.mouseState.mousePos,this.mouseState.mousePos,null,this.camera,this.selection,this.model)}revertTransitions(){this.selection.selectedTransitions().forEach(t=>this.model.revertTransition(t.id))}startChangingTransition(e){var s;if(this.viewOnly||this.mouseState.editing&&((s=this.mouseState.transition)==null?void 0:s.id)===e.id)return;this.mouseState=this.mouseState.saveChanges();const t=this.model.getStage(e.sourceStageId);(t==null?void 0:t.type)!=="iterators"&&((t==null?void 0:t.type)==="conditions"?this.mouseState=Ye.create(this.mouseState.mousePos,e,this.camera,this.selection,this.model):this.mouseState=We.create(this.mouseState.mousePos,e,this.camera,this.selection,this.model))}computeKeyDownTransition(e){if(e.key==="Enter"&&this.mouseState.state==="TRANSITION_QUICK_EDIT"||this.mouseState.state==="CHANGING_TRANSITION_TYPE"){this.mouseState=this.mouseState.saveChanges();return}this.mouseState.editing||(e.key==="Enter"?this.selection.selectedTransitions().length===1&&this.startChangingTransition(this.selection.selectedTransitions()[0]):e.key==="Delete"||e.key==="Backspace"?this.deleteSelection():e.key==="a"&&(U(e)||Ae(e))?(this.selection.select(this.model.getState().stages.map(t=>t.id)),e.preventDefault()):e.key==="r"||e.key==="R"?this.revertTransitions():e.key==="Escape"&&(this.clearSelection(),this.goToIdle()))}getStageRect(e){var a,r,o,y;this.mouseState,this.camera.x,this.camera.y,this.camera.zoom;const t=(a=this.canvas.parentElement)==null?void 0:a.querySelector(`.items-container [data-type="stage"][data-id="${e}"]`),s=(r=t==null?void 0:t.getBoundingClientRect)==null?void 0:r.call(t),i=(y=(o=t==null?void 0:t.parentElement)==null?void 0:o.getBoundingClientRect)==null?void 0:y.call(o);return!i||!s?null:{x:s.x-i.x,y:s.y-i.y,width:s.width,height:s.height,referential:"screen"}}getTransitionRect(e){var a,r,o,y;const t=(a=this.canvas.parentElement)==null?void 0:a.querySelector(`.items-container [data-type="transition"][data-id="${e}"]`),s=(r=t==null?void 0:t.getBoundingClientRect)==null?void 0:r.call(t),i=(y=(o=t==null?void 0:t.parentElement)==null?void 0:o.getBoundingClientRect)==null?void 0:y.call(o);return!i||!s?null:{x:s.x-i.x,y:s.y-i.y,width:s.width,height:s.height,referential:"screen"}}renderAddTransition(){this.mouseState.state==="ADDING_TRANSITION"&&Yi(this)}debug(){this.ctx.fillText(`mouseState: ${JSON.stringify(this.mouseState,null,2)}`,10,10),this.ctx.fillText(`stageDraft: ${JSON.stringify(this.mouseState.stageDraft,null,2)}`,10,30),this.ctx.fillText(`selection: ${JSON.stringify(this.selection.selectedIds(),null,2)}`,10,50),this.ctx.fillText(`zoom: ${this.camera.zoom}`,10,90),this.ctx.fillText(`stage: ${JSON.stringify(this.mouseState.stage,null,2)}`,10,110),this.ctx.fillText(`transition: ${JSON.stringify(this.mouseState.transition,null,2)}`,10,130);const e=50,t=this.model.getState().stages.map(i=>({height:2*e,referential:"world",width:2*e,x:i.position.x-e,y:i.position.y-e})),s=Se(t);!s||this.ctx.fillText(`hull: ${JSON.stringify(s,null,2)}`,10,70)}renderTransitions(){this.model.getState().transitions.forEach(e=>{kt(this,e)})}render(){try{this.fixSize(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderTransitions(),this.renderAddTransition()}finally{requestAnimationFrame(()=>this.render())}}inflateStagesYPosition(){const t=this.model.getState().stages.map(s=>({id:s.id,position:{x:s.position.x,y:s.position.y*Zn}}));this.model.move(t)}fitCamera(){const t=this.model.getState().stages.map(i=>({height:100,referential:"world",width:100,x:i.position.x-50,y:i.position.y-50})),s=Se(t);!s||this.camera.fit(s)}init(){this.viewOnly||this.setUpGlobalKeyDown(),this.viewOnly&&this.inflateStagesYPosition(),this.setupMousemove(),this.setupDragover(),this.setupMousedown(),this.setupDrop(),this.setupMouseup(),this.setupWheel(),this.render(),this.fitCamera()}clearSelection(){this.selection.clear()}dragstart(e,t){const s=this.getScreenPointerFromEvent(t);this.clearSelection();const i=[{type:e,position:this.camera.screenPoint2world(s)}];this.mouseState=Ke.create(s,i,this.camera,this.selection,this.model)}}const Ct=n=>(Xt("data-v-372252af"),n=n(),es(),n),Bn={class:"empty-hint"},Gn={key:0,class:"drag-hint"},Kn=Ct(()=>v("div",{class:"title"},"Start here",-1)),Un={key:1,class:"drop-hint"},Wn=Ct(()=>v("div",{class:"title"},"Drop here",-1)),jn={key:2,class:"stages-hint"},Yn={class:"header"},qn={class:"title"},Jn={class:"description"},Qn=B({__name:"EmptyHint",props:{gui:{}},setup(n){const e=n,t=f(()=>e.gui.model.getState().stages.length===0&&e.gui.mouseState.state!=="ADDING_NEW_STAGES"),s=f(()=>e.gui.model.getState().stages.length===0&&e.gui.mouseState.state==="ADDING_NEW_STAGES");return(i,a)=>(l(),p("div",Bn,[t.value?(l(),p("div",Gn,[Kn,S(c(yt),{size:32,class:"arrow"})])):_("",!0),s.value?(l(),p("div",Un,[Wn,S(c(yt),{size:32,class:"arrow"})])):_("",!0),t.value?(l(),p("div",jn,[(l(!0),p(de,null,Ie(c(K).stages,r=>(l(),p("div",{key:r.key,class:"stage-hint"},[v("div",Yn,[(l(),I(le(r.icon))),v("span",qn,O(r.title),1)]),v("div",Jn,O(r.description),1)]))),128))])):_("",!0)]))}});const Xn=X(Qn,[["__scopeId","data-v-372252af"]]),ea={class:"canvas-container"},ta={key:2,class:"items-container"},sa=B({__name:"CanvasGui",props:{model:{},viewOnly:{type:Boolean},stageRunsCount:{}},setup(n,{expose:e}){const t=n,s=F(null),i=ce(null);e({gui:i}),wt(()=>{if(!s.value)throw new Error("canvas is null");i.value=qe.create(s.value,t.model,t.viewOnly)});const a=f(()=>t.model.getState());return(r,o)=>{var y,w;return l(),p("div",ea,[r.viewOnly?_("",!0):(l(),I(c(qs),{key:0,size:20,class:ue(["icon undo",{disabled:!((y=i.value)!=null&&y.model.history.canUndo())}]),onClick:o[0]||(o[0]=d=>{var m;return(m=i.value)==null?void 0:m.model.history.undo()})},null,8,["class"])),r.viewOnly?_("",!0):(l(),I(c(vi),{key:1,size:20,class:ue(["icon redo",{disabled:!((w=i.value)!=null&&w.model.history.canRedo())}]),onClick:o[1]||(o[1]=d=>{var m;return(m=i.value)==null?void 0:m.model.history.redo()})},null,8,["class"])),v("canvas",{ref_key:"canvas",ref:s,class:"workflow-canvas",tabindex:"0"},null,512),i.value?(l(),p("div",ta,[(l(!0),p(de,null,Ie(a.value.stages,d=>{var m;return l(),I(Tn,{key:d.id,gui:i.value,"data-type":"stage","data-id":d.id,stage:d,"view-only":r.viewOnly,"stage-run-count":(m=r.stageRunsCount)==null?void 0:m.filter(T=>T.stage===d.id),onChange:o[2]||(o[2]=(T,P)=>{var A;return(A=i.value)==null?void 0:A.computeChangeStage(T,P)}),onMousedown:T=>{var P;return(P=i.value)==null?void 0:P.stageMouseDown(T,d)},onMouseenter:T=>{var P;return(P=i.value)==null?void 0:P.startHoveringStage(d)},onMouseleave:o[3]||(o[3]=T=>{var P;return(P=i.value)==null?void 0:P.finishHoveringStage()}),onKeydown:o[4]||(o[4]=T=>{var P;return(P=i.value)==null?void 0:P.computeKeyDownStage(T)}),onDblclick:T=>{var P;return(P=i.value)==null?void 0:P.startEditingStage(d)}},null,8,["gui","data-id","stage","view-only","stage-run-count","onMousedown","onMouseenter","onDblclick"])}),128)),(l(!0),p(de,null,Ie(a.value.transitions,d=>(l(),I(En,{key:d.id,gui:i.value,"data-type":"transition","data-id":d.id,transition:d,"view-only":r.viewOnly,onChange:o[5]||(o[5]=(m,T)=>{var P;return(P=i.value)==null?void 0:P.computeChangeTransition(m,T)}),onMousedown:m=>{var T;return(T=i.value)==null?void 0:T.transitionMouseDown(m,d)},onMouseenter:m=>{var T;return(T=i.value)==null?void 0:T.startHoveringTransition(d)},onMouseleave:o[6]||(o[6]=m=>{var T;return(T=i.value)==null?void 0:T.finishHoveringTransition()}),onDblclick:m=>{var T;return(T=i.value)==null?void 0:T.startChangingTransition(d)},onKeydown:o[7]||(o[7]=m=>{var T;return(T=i.value)==null?void 0:T.computeKeyDownTransition(m)})},null,8,["gui","data-id","transition","view-only","onMousedown","onMouseenter","onDblclick"]))),128)),r.viewOnly?_("",!0):(l(),I(an,{key:0,gui:i.value,onAddTransition:o[8]||(o[8]=d=>{var m;return(m=i.value)==null?void 0:m.startAddingTransition()}),onEditStage:o[9]||(o[9]=d=>{var m;return(m=i.value)==null?void 0:m.startEditingSelection()}),onEditTransition:o[10]||(o[10]=d=>{var m;return(m=i.value)==null?void 0:m.startChangingTransitionSelection()}),onRevertTransitions:o[11]||(o[11]=d=>{var m;return(m=i.value)==null?void 0:m.revertTransitions()}),onDuplicateStages:o[12]||(o[12]=d=>{var m;return(m=i.value)==null?void 0:m.duplicateThenSelect()}),onDelete:o[13]||(o[13]=d=>{var m;return(m=i.value)==null?void 0:m.deleteSelection()})},null,8,["gui"]))])):_("",!0),i.value&&a.value.stages.length===0?(l(),I(Xn,{key:3,gui:i.value},null,8,["gui"])):_("",!0)])}}});const Ia=X(sa,[["__scopeId","data-v-5f36b283"]]);function Je(){return Math.random().toString(36).slice(2,9)}class W{constructor(e){this.changes=e}apply(e){return this.changes.reduce((t,s)=>s.apply(t),e)}reverse(){return new W(this.changes.map(e=>e.reverse()).reverse())}}class $t{constructor(e){u(this,"removed");this.stageId=e,this.removed=null}apply(e){const t=e.stages.find(i=>i.id===this.stageId)||null;if(!t)throw new Error(`Stage ${this.stageId} not found`);const s=e.transitions.filter(i=>i.sourceStageId===this.stageId||i.targetStageId===this.stageId);return this.removed={stage:t,transitions:s},{stages:e.stages.filter(i=>i.id!==t.id),transitions:e.transitions.filter(i=>!s.find(a=>a.id===i.id))}}reverse(){if(!this.removed)throw new Error("Cannot reverse change that was not applied");const e=new Qe(this.removed.stage.type,this.removed.stage.title,this.removed.stage.position,this.removed.stage.id,this.removed.stage.props),t=this.removed.transitions.map(s=>new Ce(s.sourceStageId,s.targetStageId,s.type,s.id));return new W([e,...t])}}class Qe{constructor(e,t,s,i,a){u(this,"addedStage");this.stageType=e,this.nodeTitle=t,this.position=s,this.id=i,this.props=a,this.addedStage=null}assertStageDoesNotExist(e){if(e.stages.find(t=>t.id===this.id))throw new Error(`Stage ${this.id} already exists`)}assertValidStageType(){if(!K.stages.find(e=>e.typeName===this.stageType))throw new Error(`Invalid stage type ${this.stageType}`)}assertTransitionDoesNotExist(e){if(e.transitions.find(t=>t.sourceStageId===this.id||t.targetStageId===this.id))throw new Error("Stage already has transitions")}makePath(e){switch(this.stageType){case"forms":return`new-form-${e}`;case"hooks":return`new-hook-${e}`;default:return null}}makeFilename(e){switch(this.stageType){case"forms":return`new_form_${e}.py`;case"hooks":return`new_hook_${e}.py`;case"jobs":return`new_job_${e}.py`;case"scripts":return`new_script_${e}.py`;default:return null}}makeVariableName(){switch(this.stageType){case"conditions":return"my_condition";case"iterators":return"my_list";default:return null}}makeItemName(){switch(this.stageType){case"iterators":return"item";default:return null}}apply(e){var i,a,r;const t=Je(),s=(i=this.props)!=null?i:{path:this.makePath(t),filename:this.makeFilename(t),variableName:this.makeVariableName(),itemName:this.makeItemName()};return this.nodeTitle=(a=this.makeVariableName())!=null?a:this.nodeTitle,this.assertStageDoesNotExist(e),this.assertValidStageType(),this.assertTransitionDoesNotExist(e),this.addedStage={id:(r=this.id)!=null?r:as(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:s},{transitions:e.transitions,stages:[...e.stages,this.addedStage]}}reverse(){if(!this.addedStage)throw new Error("Cannot reverse change that was not applied");return new $t(this.addedStage.id)}}class ia extends W{constructor(e){super(e.map(t=>new Qe(t.type,t.title,t.position,t.id)))}}class Xe{constructor(e,t){u(this,"oldTitle");this.stageId=e,this.newTitle=t,this.oldTitle=""}apply(e){const t=e.stages.find(s=>s.id===this.stageId);if(!t)throw new Error(`Stage ${this.stageId} not found`);return this.oldTitle=t.title,{stages:e.stages.map(s=>s.id===this.stageId?{...s,title:this.newTitle}:s),transitions:e.transitions}}reverse(){return new Xe(this.stageId,this.oldTitle)}}class Mt{constructor(e){u(this,"removedTransition");this.transitionId=e,this.removedTransition=null}apply(e){const t=e.transitions.find(s=>s.id===this.transitionId);if(!t)throw new Error(`Transition ${this.transitionId} not found`);return this.removedTransition=t!=null?t:null,{stages:e.stages,transitions:e.transitions.filter(s=>s.id!==this.transitionId)}}reverse(){if(!this.removedTransition)throw new Error("Cannot reverse change that was not applied");return new Ce(this.removedTransition.sourceStageId,this.removedTransition.targetStageId,this.removedTransition.type,this.removedTransition.id)}}class Ce{constructor(e,t,s,i){u(this,"addedTransition");this.sourceStageId=e,this.targetStageId=t,this.transitionType=s,this.transitionId=i,this.addedTransition=null}assertSourceStageExists(e){if(!e.stages.find(t=>t.id===this.sourceStageId))throw new Error(`Stage ${this.sourceStageId} not found`)}assertTargetStageExists(e){if(!e.stages.find(t=>t.id===this.targetStageId))throw new Error(`Stage ${this.targetStageId} not found`)}assertTransitionDoesNotExist(e){if(e.transitions.find(t=>t.id===this.transitionId))throw new Error(`Transition ${this.transitionId} already exists`)}assertNotSelfTransition(){if(this.sourceStageId===this.targetStageId)throw new Error("Self transitions are not allowed")}assertNoDuplicatedTransitionStages(e){if(e.transitions.find(t=>t.sourceStageId===this.sourceStageId&&t.targetStageId===this.targetStageId))throw J.error({message:"Invalid transition",description:"Transition already exists"}),new Error("Transition already exists")}assertValidTransitionType(e){const t=e.stages.find(a=>a.id===this.sourceStageId);if(!K.stages.find(a=>a.typeName===t.type).transitions.map(a=>a.typeName).includes(this.transitionType))throw new Error(`Invalid transition type ${this.transitionType}`)}assertNotStartingOnlyTargetStage(e){const t=e.stages.find(i=>i.id===this.targetStageId);if(K.stages.find(i=>i.typeName===t.type).startingOnly)throw J.error({message:"Invalid transition",description:"Cannot transition to starting-only stage"}),new Error("Cannot transition to starting-only stage")}assertNoStageWithSameId(e){if(e.stages.find(t=>t.id===this.transitionId))throw new Error(`Stage with id ${this.transitionId} already exists`)}apply(e){var t;return this.assertSourceStageExists(e),this.assertTargetStageExists(e),this.assertTransitionDoesNotExist(e),this.assertNotSelfTransition(),this.assertNoDuplicatedTransitionStages(e),this.assertValidTransitionType(e),this.assertNotStartingOnlyTargetStage(e),this.assertNoStageWithSameId(e),this.addedTransition={id:(t=this.transitionId)!=null?t:Je(),sourceStageId:this.sourceStageId,targetStageId:this.targetStageId,type:this.transitionType,props:{conditionValue:null}},{stages:e.stages,transitions:[...e.transitions,this.addedTransition]}}reverse(){if(!this.addedTransition)throw new Error("Cannot reverse change that was not applied");return new Mt(this.addedTransition.id)}}class et{constructor(e){u(this,"transitionId");this.transitionId=e}assertValidTransitionType(e){const t=e.transitions.find(r=>r.id===this.transitionId),s=e.stages.find(r=>r.id===t.targetStageId);if(!K.stages.find(r=>r.typeName===s.type).transitions.map(r=>r.typeName).includes(t.type))throw J.error({message:"Error reverting",description:"This revert leads to some invalid transition"}),new Error("Invalid transition type")}apply(e){if(this.assertValidTransitionType(e),!e.transitions.find(s=>s.id===this.transitionId))throw new Error(`Transition ${this.transitionId} not found`);return{stages:e.stages,transitions:e.transitions.map(s=>s.id===this.transitionId?{...s,sourceStageId:s.targetStageId,targetStageId:s.sourceStageId}:s)}}reverse(){return new et(this.transitionId)}}class na extends W{constructor(e){super(e.map(t=>new Ce(t.sourceStageId,t.targetStageId,t.type,t.id)))}}class tt{constructor(e){u(this,"oldPositions");this.newPositions=e,this.oldPositions=null}assertStagesExists(e){this.newPositions.forEach(({id:t})=>{if(!e.stages.find(s=>s.id===t))throw new Error(`Stage ${t} not found`)})}assertIsNumber(){this.newPositions.forEach(({position:e})=>{if(Number.isNaN(e.x)||Number.isNaN(e.y)||!Number.isFinite(e.x)||!Number.isFinite(e.y))throw new Error("Position must be a number")})}apply(e){return this.assertIsNumber(),this.assertStagesExists(e),this.oldPositions=e.stages.map(s=>({id:s.id,position:s.position})),{stages:e.stages.map(s=>{var a,r;const i=(r=(a=this.newPositions.find(o=>o.id===s.id))==null?void 0:a.position)!=null?r:s.position;return{...s,position:{x:i.x,y:i.y}}}),transitions:e.transitions}}reverse(){if(!this.oldPositions)throw new Error("Cannot reverse change that was not applied");return new tt(this.oldPositions)}}class st{constructor(e,t){u(this,"stageId");u(this,"newTitle");u(this,"oldTitle");this.stageId=e,this.newTitle=t,this.oldTitle=""}assertStageExists(e){if(!e.stages.find(t=>t.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}apply(e){return this.assertStageExists(e),this.oldTitle=e.stages.find(t=>t.id===this.stageId).title,{stages:e.stages.map(t=>t.id===this.stageId?{...t,title:this.newTitle}:t),transitions:e.transitions}}reverse(){return new st(this.stageId,this.oldTitle)}}class it{constructor(e,t){u(this,"stageId");u(this,"newProps");u(this,"oldProps");this.stageId=e,this.newProps=t,this.oldProps={path:null,filename:null,variableName:null,itemName:null}}assertStageExists(e){if(!e.stages.find(t=>t.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}assertValidVariableName(){if(!this.newProps.variableName)return;const e=this.newProps.variableName,t=It(e);if(!t.valid){J.error({message:"Invalid variable name",description:t.reason});return}this.newProps.variableName=xe(e)}assertValidPath(){if(!this.newProps.path)return;const e=ss(this.newProps.path);if(!e.valid){J.error({message:"Invalid path",description:e.reason});return}this.newProps.path=is(this.newProps.path)}assertValidFilename(){if(!this.newProps.filename)return;const e=Tt(this.newProps.filename);if(!e.valid){J.error({message:"Invalid filename",description:e.reason});return}this.newProps.filename=ns(this.newProps.filename)}apply(e){return this.assertStageExists(e),this.assertValidVariableName(),this.assertValidPath(),this.assertValidFilename(),this.oldProps=e.stages.find(t=>t.id===this.stageId).props,{stages:e.stages.map(t=>{var s;return t.id===this.stageId?{...t,title:(s=this.newProps.variableName)!=null?s:t.title,props:this.newProps}:t}),transitions:e.transitions}}reverse(){return new it(this.stageId,this.oldProps)}}class nt{constructor(e,t){u(this,"newType");u(this,"transitionId");u(this,"oldType");this.newType=t,this.transitionId=e,this.oldType=t}apply(e){return{transitions:e.transitions.map(t=>t.id===this.transitionId?(this.oldType=t.type,{...t,type:this.newType}):t),stages:e.stages}}reverse(){return new nt(this.transitionId,this.oldType)}}class at{constructor(e,t){u(this,"newProps");u(this,"transitionId");u(this,"oldProps");this.newProps=t,this.transitionId=e,this.oldProps=t}apply(e){return{transitions:e.transitions.map(t=>t.id===this.transitionId?(this.oldProps=t.props,{...t,props:this.newProps}):t),stages:e.stages}}reverse(){return new at(this.transitionId,this.oldProps)}}class aa{constructor(e){u(this,"change");this.duplicatedStages=e,this.change=null}assertStagesExists(e){this.duplicatedStages.forEach(t=>{if(!e.stages.find(s=>s.id===t.id))throw new Error(`Stage ${t.id} not found`)})}apply(e){this.assertStagesExists(e);const t=this.duplicatedStages.map(Je),s=this.duplicatedStages.map((r,o)=>new Qe(r.type,`${r.title} - Copy`,{x:r.position.x,y:r.position.y},t[o])),a=e.transitions.filter(r=>{const o=this.duplicatedStages.find(w=>w.id===r.sourceStageId),y=this.duplicatedStages.find(w=>w.id===r.targetStageId);return o&&y}).map(r=>{const o=t[this.duplicatedStages.findIndex(w=>w.id===r.sourceStageId)],y=t[this.duplicatedStages.findIndex(w=>w.id===r.targetStageId)];return new Ce(o,y,r.type)});return this.change=new W([...s,...a]),this.change.apply(e)}reverse(){if(!this.change)throw new Error("Cannot reverse change that was not applied");return this.change.reverse()}}class ra extends W{constructor(e,t){super([...t.map(s=>new Mt(s)),...e.map(s=>new $t(s))])}}class rt{constructor(e,t){u(this,"oldTransitionState");this.transitionId=e,this.newType=t,this.oldTransitionState=null}assertTransitionExists(e){if(!e.transitions.find(t=>t.id===this.transitionId))throw new Error(`Transition ${this.transitionId} not found`)}assertValidTransitionType(e){const t=e.transitions.find(r=>r.id===this.transitionId),s=e.stages.find(r=>r.id===t.sourceStageId);if(!K.stages.find(r=>r.typeName===s.type).transitions.map(r=>r.typeName).includes(this.newType))throw new Error(`Invalid transition type ${this.newType}`)}apply(e){this.assertTransitionExists(e),this.assertValidTransitionType(e);const t=e.transitions.find(s=>s.id===this.transitionId);return this.oldTransitionState=t,{stages:e.stages,transitions:e.transitions.map(s=>s.id===this.transitionId?{...s,type:this.newType}:s)}}reverse(){if(!this.oldTransitionState)throw new Error("Cannot reverse change that was not applied");return new rt(this.transitionId,this.oldTransitionState.type)}}class oa{constructor(e){u(this,"currentState");u(this,"serverState");u(this,"undoStack");u(this,"redoStack");this.undoStack=[],this.redoStack=[],this.currentState=ce(Object.freeze(e)),this.serverState=ce(Object.freeze(e))}apply(e){return this.currentState.value=e.apply(this.currentState.value),this.undoStack.push(e),this.redoStack=[],this.currentState.value}canUndo(){return this.undoStack.length>0}undo(){const e=this.undoStack.pop();if(e){const t=e.reverse();this.currentState.value=t.apply(this.currentState.value),this.redoStack.push(e)}return this.currentState.value}canRedo(){return this.redoStack.length>0}redo(){const e=this.redoStack.pop();return e&&(this.currentState.value=e.apply(this.currentState.value),this.undoStack.push(e)),this.currentState.value}getState(){return this.currentState.value}setServerState(e){this.serverState.value=e}getServerState(){return this.serverState.value}hasStageChanges(){return!G.exports.isEqual(this.currentState.value.stages,this.serverState.value.stages)}hasChanges(){const e={...this.currentState.value,stages:[...this.currentState.value.stages].sort((s,i)=>s.id.localeCompare(i.id)),transitions:[...this.currentState.value.transitions].sort((s,i)=>s.id.localeCompare(i.id))},t={...this.serverState.value,stages:[...this.serverState.value.stages].sort((s,i)=>s.id.localeCompare(i.id)),transitions:[...this.serverState.value.transitions].sort((s,i)=>s.id.localeCompare(i.id))};return!G.exports.isEqual(e,t)}stageHasChanges(e){const t=this.currentState.value.stages.find(i=>i.id===e),s=this.serverState.value.stages.find(i=>i.id===e);return!G.exports.isEqual(t,s)}stageHasNonPositionChanges(e){const t=this.currentState.value.stages.find(i=>i.id===e),s=this.serverState.value.stages.find(i=>i.id===e);return!G.exports.isEqual(G.exports.omit(t,"position"),G.exports.omit(s,"position"))}}class bt{constructor(e,t){u(this,"api");u(this,"history");this.api=e,this.history=new oa(t)}static async create(e){const t=await e.load();return new bt(e,t)}move(e){this.history.apply(new tt(e))}revertTransition(e){this.history.apply(new et(e))}delete(e){const t=this.history.getState(),s=t.stages.filter(a=>e.includes(a.id)).map(a=>a.id),i=t.transitions.filter(a=>e.includes(a.id)).map(a=>a.id);this.history.apply(new ra(s,i))}addStages(e){return this.history.apply(new ia(e.map(t=>{var s;return{...t,title:(s=t.title)!=null?s:`New ${t.type.slice(0,-1)}`}}))),this.history.getState().stages.slice(-e.length)}updateStageTitle(e,t){this.history.apply(new st(e,t))}updateStageProps(e,t){this.history.apply(new it(e,t))}updateTransitionType(e,t){this.history.apply(new nt(e,t))}updateTransitionProps(e,t){this.history.apply(new at(e,t))}duplicateStages(e){const t=this.history.getState(),s=this.history.apply(new aa(e));return{stages:s.stages.filter(i=>!t.stages.find(a=>a.id===i.id)),transitions:s.transitions.filter(i=>!t.transitions.find(a=>a.id===i.id))}}ensureTransitionWithType(e){var r;const t=this.getStage(e.sourceStageId);if(!t)throw new Error(`Source stage ${e.sourceStageId} not found`);const s=t.type,i=K.stages.find(o=>o.typeName===s),a=i==null?void 0:i.transitions[0].typeName;if(!a)throw new Error(`No default transition type for ${s}`);return{sourceStageId:e.sourceStageId,targetStageId:e.targetStageId,type:(r=e.type)!=null?r:a}}addTransitions(e){this.history.apply(new na(e.map(t=>this.ensureTransitionWithType(t))))}changeTransitionType(e,t){const s=new rt(e,t);this.history.apply(s)}renameStage(e,t){const s=new Xe(e,t);this.history.apply(s)}async reload(){const e=await this.api.load();return this.history.setServerState(e),e}hasChanges(){return this.history.hasChanges()}stageHasChanges(e){return this.history.stageHasChanges(e)}stageHasNonPositionChanges(e){return this.history.stageHasNonPositionChanges(e)}async hasBackendChanges(){const e=await this.api.load(),t=this.history.getServerState(),s={...t,stages:[...t.stages].sort((a,r)=>a.id.localeCompare(r.id)),transitions:[...t.transitions].sort((a,r)=>a.id.localeCompare(r.id))},i={...e,stages:[...e.stages].sort((a,r)=>a.id.localeCompare(r.id)),transitions:[...e.transitions].sort((a,r)=>a.id.localeCompare(r.id))};return!G.exports.isEqual(i,s)}async save(){if(this.history.hasChanges()){const e=await this.api.update(this.history.getState());this.history.setServerState(e)}}async forceSave(){const e=await this.api.update(this.history.getState());this.history.setServerState(e)}getStage(e){var t;return(t=this.history.getState().stages.find(s=>s.id===e))!=null?t:null}getTransition(e){var t;return(t=this.history.getState().transitions.find(s=>s.id===e))!=null?t:null}getState(){return this.history.getState()}}export{Ia as C,Li as I,Zi as S,bt as W,Ta as a};
//# sourceMappingURL=model.8aacd28c.js.map
