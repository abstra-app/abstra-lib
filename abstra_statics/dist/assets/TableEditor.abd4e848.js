import{d as O,r as N,G as q,F as te,b as s,eu as T,f as t,w as a,b6 as R,az as S,eC as P,ew as D,e as C,u as e,cB as ae,bX as L,cI as le,cG as j,eB as V,c as h,bQ as z,eJ as M,a as H,ad as J,cF as ne,bx as oe,t as X,H as pe,ez as ue,eD as re,eE as se,eA as fe,eI as me}from"./outputWidgets.3acae187.js";import{p as ie,T as ve}from"./tables.5c764b7f.js";import{B as ye}from"./BaseLayout.550facf6.js";import{a as W}from"./asyncComputed.4acb40f3.js";import{p as F}from"./popupNotifcation.8ea6ea7e.js";import{A as de}from"./index.72042afd.js";import{F as Y,A as x}from"./Form.01134ed5.js";import{A as Z}from"./index.f9c001fe.js";import"./router.330b5ee2.js";import{P as be}from"./project.7c8c0251.js";import"./index.330e6f4e.js";import{O as ge}from"./organization.9885f7c0.js";import{H as _e,I as he,J as ke,K as Ce,L as we,w as De,M as $e}from"./icons.238cb834.js";import{A as K}from"./index.9597db41.js";import{L as Ie}from"./CircularLoading.d4dcde9f.js";import{T as Se,A as G}from"./TabPane.7427d21f.js";import{B as Ue,a as Te,c as xe}from"./index.ec1e7f1e.js";import"./record.8667ddd6.js";import"./pubsub.bc590f31.js";import"./gateway.d73b54c4.js";import"./index.30e21000.js";import"./Title.b0254e64.js";(function(){try{var b=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},y=new Error().stack;y&&(b._sentryDebugIds=b._sentryDebugIds||{},b._sentryDebugIds[y]="919c6c56-a633-43eb-92b7-cce9242d7708",b._sentryDebugIdIdentifier="sentry-dbid-919c6c56-a633-43eb-92b7-cce9242d7708")}catch{}})();const Ae={class:"table-data",style:{width:"calc(100% - 80px)"}},Ee={key:1},Be=["onClick"],Ne=C("a",null,"Delete",-1),Le=O({__name:"TableData",props:{table:{}},setup(b){var I;const y=b,u=N(1),o=N(5),g=q(()=>{var f,l;return{total:(l=(f=w.value)==null?void 0:f.total)!=null?l:0,current:u.value,pageSize:o.value,onChange:async(n,A)=>{u.value=n,o.value=A,await U()}}}),{result:w,loading:i,refetch:U}=W(()=>y.table.select({},(u.value-1)*o.value,o.value)),$=q(()=>{var l;return[...(l=y.table)==null?void 0:l.getColumns().map(n=>({title:n.name,dataIndex:n.name})),{title:"Actions",key:"action",fixed:"right",width:100,align:"center"}]}),c=q(()=>{var f;return((f=w.value)==null?void 0:f.rows.map(l=>({key:l.id,...l})))||[]}),p=N(!1),r=N({}),v=()=>{p.value=!0},m=()=>{r.value={},p.value=!1};let E=te((I=y.table)==null?void 0:I.getUnprotectedColumns().reduce((f,l)=>({...f,[l.name]:""}),{}));async function B(){if(!(!y.table||!E))try{r.value.id?await y.table.updateRow(r.value.id,r.value):await y.table.insertRow(r.value),r.value={},U(),m()}catch(f){f instanceof Error&&F("Database error",f.message)}}const d=async f=>{if(!(!w.value||!w.value.rows.find(l=>l.id===f)))try{await y.table.deleteRow(f),U()}catch(l){l instanceof Error&&F("Database error",l.message)}},k=f=>{var l;r.value=M.exports.pick(M.exports.cloneDeep((l=c.value)==null?void 0:l.filter(n=>f===n.key)[0]),y.table.getColumns().map(n=>n.name)),v()};return(f,l)=>(s(),T("div",Ae,[t(e(le),{columns:$.value,"data-source":c.value,pagination:g.value,bordered:"",loading:e(i),scroll:{x:2e3,y:720}},{bodyCell:a(({column:n,text:A,record:_})=>[$.value.map(Q=>Q.title).includes(n.dataIndex)?(s(),T(R,{key:0},[S(P(A),1)],64)):D("",!0),n.key==="action"?(s(),T("div",Ee,[C("span",null,[C("a",{onClick:Q=>k(_.id)},"Edit",8,Be)]),t(e(de),{type:"vertical"}),t(e(ae),{title:"Sure to delete?",onConfirm:Q=>d(_.id)},{default:a(()=>[Ne]),_:2},1032,["onConfirm"])])):D("",!0)]),footer:a(()=>[t(e(L),{type:"primary",onClick:v},{default:a(()=>[S("+ Add New Data")]),_:1})]),_:1},8,["columns","data-source","pagination","loading"]),t(e(Z),{title:"Data",width:720,open:p.value,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:m},{extra:a(()=>[t(e(j),null,{default:a(()=>[t(e(L),{onClick:m},{default:a(()=>[S("Cancel")]),_:1}),t(e(L),{type:"primary",onClick:B},{default:a(()=>[S("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(Y),{model:r.value,layout:"vertical"},{default:a(()=>[(s(!0),T(R,null,V(f.table.getUnprotectedColumns(),n=>(s(),h(e(x),{key:n.id,label:n.name},{default:a(()=>[r.value?(s(),h(e(z),{key:0,value:r.value[n.name],"onUpdate:value":A=>r.value[n.name]=A},null,8,["value","onUpdate:value"])):D("",!0)]),_:2},1032,["label"]))),128))]),_:1},8,["model"])]),_:1},8,["open"])]))}});const qe=O({__name:"NewColumn",props:{open:{type:Boolean},table:{}},emits:["created","cancel"],setup(b,{emit:y}){const u=b,o=N({name:"",type:"varchar",default:"''",nullable:!0,unique:!1}),g=N({error:"success",message:"",fakeLoading:!1}),w=()=>{g.value.fakeLoading=!0,i()},i=M.exports.debounce(async()=>{var r;const p=`select (${o.value.default})::${o.value.type} `;(r=u.table)==null||r.executeQuery(p,[]).then(v=>{g.value.error=v.errors.length>0?"error":"success",g.value.message=v.errors[0]||"",g.value.fakeLoading=!1})},500),U=()=>{o.value={name:"",type:"varchar",default:"''",nullable:!0,unique:!1}};function $(){y("cancel")}async function c(){if(!!u.table&&!(!o.value.name||!o.value.type))try{await u.table.addColumn(o.value),U(),y("created")}catch(p){p instanceof Error&&F("Database error",p.message)}}return(p,r)=>{const v=H("icon");return s(),h(e(Z),{title:"New column",width:720,open:u.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:$},{extra:a(()=>[t(e(j),null,{default:a(()=>[t(e(L),{onClick:$},{default:a(()=>[S("Cancel")]),_:1}),t(e(L),{type:"primary",onClick:c},{default:a(()=>[S("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(Y),{model:o.value,layout:"vertical"},{default:a(()=>[t(e(x),{key:"name",label:"Name",required:!0},{default:a(()=>[t(e(z),{value:o.value.name,"onUpdate:value":r[0]||(r[0]=m=>o.value.name=m)},null,8,["value"])]),_:1}),t(e(x),{key:"type",label:"Type",required:!0},{default:a(()=>[t(e(J),{value:o.value.type,"onUpdate:value":r[1]||(r[1]=m=>o.value.type=m),"default-active-first-option":"",onChange:w},{default:a(()=>[(s(!0),T(R,null,V(e(ie),m=>(s(),h(e(ne),{key:m,value:m},{default:a(()=>[S(P(m),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),t(e(x),{key:"default-value",label:"Default value","validate-status":g.value.error,help:g.value.message},{default:a(()=>[t(e(z),{value:o.value.default,"onUpdate:value":r[2]||(r[2]=m=>o.value.default=m),onInput:w},{suffix:a(()=>[g.value.fakeLoading?(s(),h(e(oe),{key:0})):D("",!0),!g.value.fakeLoading&&g.value.error==="success"?(s(),h(v,{key:1,path:e(_e)},null,8,["path"])):D("",!0),!g.value.fakeLoading&&g.value.error==="error"?(s(),h(v,{key:2,path:e(he)},null,8,["path"])):D("",!0)]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),t(e(x),{key:"nullable",label:"Nullable"},{default:a(()=>[t(e(K),{checked:o.value.nullable,"onUpdate:checked":r[3]||(r[3]=m=>o.value.nullable=m)},null,8,["checked"])]),_:1}),t(e(x),{key:"unique",label:"Unique"},{default:a(()=>[t(e(K),{checked:o.value.unique,"onUpdate:checked":r[4]||(r[4]=m=>o.value.unique=m)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])}}}),ze={class:"types-container"},Re={class:"fullwidth-input"},Pe={class:"fullwidth-input"},Fe={class:"using-container"},Oe={class:"fullwidth-input"},Ke=O({__name:"UpdateColumn",props:{open:{type:Boolean},table:{},column:{}},emits:["updated","cancel"],setup(b,{emit:y}){const u=b,{result:o,loading:g}=W(async()=>u.table.select({},10,0).then(({total:l})=>l));function w(){y("cancel")}const i=N({error:"success",message:"",fakeLoading:!1}),U=()=>{i.value.fakeLoading=!0,$()},$=M.exports.debounce(async()=>{var n;const l=`select (${u.column.default})::${u.column.type} `;(n=u.table)==null||n.executeQuery(l,[]).then(A=>{i.value.error=A.errors.length>0?"error":"success",i.value.message=A.errors[0]||"",i.value.fakeLoading=!1})},500),c=()=>o.value===0||g.value?!1:u.column.record.hasChangesDeep("type"),p=N({type:"default"});function r(l,n){return n==="varchar"||l==="int"&&n==="boolean"||l==="boolean"&&n==="int"}const v=()=>{U(),m.value||(p.value={type:"user-defined",using:I.value,mandatory:!0})},m=q(()=>p.value.type==="default"&&r(u.column.record.initialState.type,u.column.type)),E=q(()=>!r(u.column.record.initialState.type,u.column.type));function B(l){l?p.value={type:"default"}:p.value={type:"user-defined",using:I.value,mandatory:!1}}function d(l){if(p.value.type==="default")throw new Error("Can't change using when using default casting");p.value.using=l!=null?l:""}const k=()=>E.value?!0:c()&&p.value.type==="user-defined",I=q(()=>`${u.column.record.initialState.name}::${u.column.type}`);async function f(){if(!u.column)return;let l=p.value.type==="default"?I.value:p.value.using;o.value===0&&(l=`${u.column.name}::text::${u.column.type}`);try{await u.column.update(l),y("updated")}catch(n){n instanceof Error&&F("Database error",n.message)}}return(l,n)=>{const A=H("icon");return s(),h(e(Z),{title:"Edit column",width:720,open:u.open,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:w},{extra:a(()=>[t(e(j),null,{default:a(()=>[t(e(L),{onClick:w},{default:a(()=>[S("Cancel")]),_:1}),t(e(L),{type:"primary",onClick:f},{default:a(()=>[S("Submit")]),_:1})]),_:1})]),default:a(()=>[t(e(Y),{model:l.column,layout:"vertical"},{default:a(()=>[t(e(x),{key:"name",label:"Name"},{default:a(()=>[t(e(z),{value:l.column.name,"onUpdate:value":n[0]||(n[0]=_=>l.column.name=_)},null,8,["value"])]),_:1}),C("div",ze,[C("span",Re,[t(e(x),{key:"type",label:"Current Type"},{default:a(()=>[t(e(J),{value:l.column.record.initialState.type,"onUpdate:value":n[1]||(n[1]=_=>l.column.record.initialState.type=_),"default-active-first-option":"",disabled:""},null,8,["value"])]),_:1})]),t(A,{class:"right-arrow",path:e(ke)},null,8,["path"]),C("span",Pe,[t(e(x),{key:"new-type",label:"New Type"},{default:a(()=>[t(e(J),{value:l.column.type,"onUpdate:value":n[2]||(n[2]=_=>l.column.type=_),"default-active-first-option":"",onChange:n[3]||(n[3]=_=>v())},{default:a(()=>[(s(!0),T(R,null,V(e(ie),_=>(s(),h(e(ne),{key:_,value:_},{default:a(()=>[S(P(_),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})])]),t(e(x),{key:"default-value",label:"Default value","validate-status":i.value.error,help:i.value.message},{default:a(()=>[t(e(z),{value:l.column.default,"onUpdate:value":n[4]||(n[4]=_=>l.column.default=_),onInput:U},{suffix:a(()=>[i.value.fakeLoading?(s(),h(e(oe),{key:0,size:"small"})):D("",!0),!i.value.fakeLoading&&i.value.error==="success"?(s(),h(A,{key:1,path:e(Ce),width:"18",height:"18"},null,8,["path"])):D("",!0),!i.value.fakeLoading&&i.value.error==="error"?(s(),h(A,{key:2,path:e(we),width:"18",height:"18"},null,8,["path"])):D("",!0)]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),C("div",Fe,[c()?(s(),h(e(x),{key:"default-casting",label:"Use default casting"},{default:a(()=>[t(e(K),{checked:m.value,disabled:E.value,"onUpdate:checked":n[5]||(n[5]=_=>B(!!_))},null,8,["checked","disabled"])]),_:1})):D("",!0),C("span",Oe,[c()?(s(),h(e(x),{key:"using",label:"Using"},{default:a(()=>[t(e(z),{value:p.value.type==="user-defined"?p.value.using:I.value,disabled:!k(),onInput:n[6]||(n[6]=_=>d(_.target.value))},null,8,["value","disabled"])]),_:1})):D("",!0)])]),t(e(x),{key:"nullable",label:"Nullable"},{default:a(()=>[t(e(K),{checked:l.column.nullable,"onUpdate:checked":n[7]||(n[7]=_=>l.column.nullable=_)},null,8,["checked"])]),_:1}),t(e(x),{key:"unique",label:"Unique"},{default:a(()=>[t(e(K),{checked:l.column.unique,"onUpdate:checked":n[8]||(n[8]=_=>l.column.unique=_)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])}}});const je=X(Ke,[["__scopeId","data-v-ed537625"]]),ce=b=>(re("data-v-fbf27701"),b=b(),se(),b),Me={class:"table-settings"},Ve={key:0},He=ce(()=>C("span",null," protected ",-1)),Qe=[He],Ge={key:1},Je=["onClick"],Xe=ce(()=>C("a",null,"Delete",-1)),We=O({__name:"TableColumns",props:{table:{},loading:{type:Boolean}},emits:["refresh"],setup(b,{emit:y}){var B;const u=b,o=N(u.loading);pe(()=>u.loading,()=>{o.value=u.loading});const g=ue();(B=u.table)==null||B.onUpdate(()=>{var d;g.replace({name:"tableEditor",params:{tableName:(d=u.table)==null?void 0:d.name}})});const i=[...[{title:"Name",dataIndex:"name",sorter:(d,k)=>d.name.localeCompare(k.name)},{title:"Type",dataIndex:"type",sorter:(d,k)=>d.type.localeCompare(k.type)},{title:"Default Value",dataIndex:"default",sorter:(d,k)=>{var I,f,l,n;return(n=(l=d.default)==null?void 0:l.localeCompare((f=(I=k.default)==null?void 0:I.toString())!=null?f:""))!=null?n:0}},{title:"Nullable",dataIndex:"nullable",sorter:(d,k)=>d.nullable.toString().localeCompare(k.nullable.toString())},{title:"Primary Key",dataIndex:"primaryKey",sorter:(d,k)=>d.primaryKey.toString().localeCompare(k.primaryKey.toString())}],{title:"Actions",key:"action"}],U=q(()=>{var d;return(d=u.table)==null?void 0:d.getColumns()});function $(){r.value={type:"idle"}}function c(){$(),o.value=!0,setTimeout(()=>{y("refresh")},500)}function p(){r.value={type:"creating"}}const r=N({type:"idle"});function v(d){var k,I;(I=(k=u.table)==null?void 0:k.getColumn(d))==null||I.delete(),o.value=!0,setTimeout(()=>{y("refresh")},500)}const m=d=>{var k,I,f;return(f=(I=(k=u.table)==null?void 0:k.getColumn(d))==null?void 0:I.protected)!=null?f:!1},E=d=>{if(!u.table)throw new Error("Table not found");r.value={type:"editing",column:u.table.getColumn(d)}};return(d,k)=>(s(),T("div",Me,[t(e(le),{columns:i,"data-source":U.value,bordered:"",loading:o.value,pagination:!1},{bodyCell:a(({column:I,text:f,record:l})=>[I.key!=="action"?(s(),T(R,{key:0},[S(P(f),1)],64)):(s(),T(R,{key:1},[m(l.id)?(s(),T("div",Ve,Qe)):(s(),T("div",Ge,[C("span",null,[C("a",{onClick:()=>E(l.id)},"Edit",8,Je)]),t(e(de),{type:"vertical"}),t(e(ae),{title:"Sure to delete?",onConfirm:n=>v(l.id)},{default:a(()=>[Xe]),_:2},1032,["onConfirm"])]))],64))]),footer:a(()=>[t(e(L),{type:"primary",onClick:p},{default:a(()=>[S("+ Add New Column")]),_:1})]),_:1},8,["data-source","loading"]),d.table&&r.value.type==="creating"?(s(),h(qe,{key:0,open:"",table:u.table,onClose:$,onCancel:$,onCreated:c},null,8,["table"])):D("",!0),d.table&&r.value.type==="editing"?(s(),h(je,{key:1,column:r.value.column,open:"",table:d.table,onUpdated:c,onClose:$,onCancel:$},null,8,["column","table"])):D("",!0)]))}});const Ye=X(We,[["__scopeId","data-v-fbf27701"]]),ee=b=>(re("data-v-06f57b7a"),b=b(),se(),b),Ze={class:"table-settings"},et=ee(()=>C("h2",{class:"title"},"Table settings",-1)),tt=ee(()=>C("div",{class:"subtitle"},"Edit table metadata",-1)),at={key:0,class:"table-presenter"},lt={class:"table-property-item"},nt={class:"property-item"},ot={key:1},ut={class:"change-warning"},rt={class:"section-title"},st=ee(()=>C("div",{class:"section-body"}," Changing the table's name can possibly result in the break of running applications. ",-1)),it={class:"table-name-value-input"},dt={key:0,class:"error"},ct=O({__name:"TableSettings",props:{table:{}},emits:["refresh"],setup(b,{emit:y}){const u=b,o=te({error:"",editing:!1,loading:!1}),g=()=>o.editing=!0,w=()=>{u.table.resetChanges(),o.editing=!1,o.error=""},i=async()=>{o.error="",o.loading=!0;try{await U()}catch(c){c instanceof Error&&(F("Database error",c.message),o.error=c.message)}o.error||(o.editing=!1),o.loading=!1},U=async()=>{if(!u.table.name){o.error="Table name cannot be empty";return}try{await u.table.save(),y("refresh")}catch(c){c instanceof Error&&(F("Database error",c.message),o.error=c.message)}},$=c=>{u.table.name=c.target.value};return(c,p)=>{var v;const r=H("icon");return s(),T("div",Ze,[et,tt,o.editing?(s(),T("div",ot,[C("div",ut,[C("div",rt,[t(r,{path:e(De),width:"12",height:"12",fill:"#D35249"},null,8,["path"]),S(" Be careful ")]),st]),t(e(j),{direction:"vertical"},{default:a(()=>[C("div",it,[t(e(z),{value:c.table.name,type:"text",onInput:$,onBlur:p[0]||(p[0]=m=>c.table.fixTraillingName())},null,8,["value"])]),o.error?(s(),T("div",dt,[t(r,{path:e($e),fill:"#D35249",width:"12",height:"12"},null,8,["path"]),S(" "+P(o.error),1)])):D("",!0),t(e(j),null,{default:a(()=>[t(e(L),{onClick:w},{default:a(()=>[S("Cancel")]),_:1}),t(e(L),{type:"primary",disabled:!c.table.hasChangesDeep("name"),onClick:i},{default:a(()=>[S(" Save Changes "),o.loading?(s(),h(Ie,{key:0,size:"16"})):D("",!0)]),_:1},8,["disabled"])]),_:1})]),_:1})])):(s(),T("div",at,[C("div",lt,[C("div",nt,"Name: "+P((v=c.table)==null?void 0:v.name),1)]),t(e(L),{onClick:g},{default:a(()=>[S("Edit Name")]),_:1})]))])}}});const pt=X(ct,[["__scopeId","data-v-06f57b7a"]]),Lt=O({__name:"TableEditor",setup(b){const y=ue(),u=fe(),o=u.params.tableId,g=u.params.projectId,w=N("data"),{result:i,loading:U,refetch:$}=W(()=>Promise.all([be.get(g).then(async r=>{const v=await ge.get(r.organizationId);return{project:r,organization:v}}),ve.get(g,o)]).then(([{project:r,organization:v},m])=>me({project:r,organization:v,table:m}))),c=q(()=>!U.value&&i.value?[{label:"My organizations",path:"/organizations"},{label:i.value.organization.name,path:`/organizations/${i.value.organization.id}`},{label:i.value.project.name,path:`/projects/${i.value.project.id}/tables`}]:void 0);function p(){y.push({name:"tables",params:{projectId:g}})}return(r,v)=>{const m=H("router-link");return s(),h(ye,null,{navbar:a(()=>{var E;return[t(e(xe),{title:(E=e(i))==null?void 0:E.table.name,style:{padding:"5px 10px"},onBack:p},{footer:a(()=>[t(e(Se),{"active-key":w.value,"onUpdate:activeKey":v[0]||(v[0]=B=>w.value=B)},{default:a(()=>[t(e(G),{key:"data",tab:"Data"}),t(e(G),{key:"columns",tab:"Columns"}),t(e(G),{key:"settings",tab:"Settings"})]),_:1},8,["active-key"])]),breadcrumb:a(()=>[c.value?(s(),h(e(Ue),{key:0},{default:a(()=>[(s(!0),T(R,null,V(c.value,(B,d)=>(s(),h(e(Te),{key:d},{default:a(()=>[t(m,{to:B.path},{default:a(()=>[S(P(B.label),1)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1})):D("",!0)]),_:1},8,["title"])]}),content:a(()=>[e(i)&&w.value==="data"?(s(),h(Le,{key:0,loading:e(U),table:e(i).table},null,8,["loading","table"])):D("",!0),e(i)&&w.value==="columns"?(s(),h(Ye,{key:1,table:e(i).table,loading:e(U),onRefresh:v[1]||(v[1]=E=>e($)())},null,8,["table","loading"])):D("",!0),e(i)&&w.value==="settings"?(s(),h(pt,{key:2,table:e(i).table,loading:e(U),onRefresh:v[2]||(v[2]=E=>e($)())},null,8,["table","loading"])):D("",!0)]),_:1})}}});export{Lt as default};
//# sourceMappingURL=TableEditor.abd4e848.js.map
