var j=Object.defineProperty;var A=(i,e,t)=>e in i?j(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var a=(i,e,t)=>(A(i,typeof e!="symbol"?e+"":e,t),t);import{C as k}from"./gateway.b2447a0d.js";import{l as _}from"./fetch.9abdec80.js";import{E}from"./record.48f7790f.js";import{Q as F,e as O,er as R,d as I,aq as D,X as S,u as s,c as f,ej as T,w as o,R as m,aR as $,o as p,b as c,aF as h,bP as P,ec as C,cu as L,d8 as B,cA as N,cv as G,cH as M}from"./vue-router.663e4641.js";import{S as z}from"./SaveButton.5ad40658.js";import{C as H}from"./CrudView.a0f1d792.js";import{a as K}from"./asyncComputed.91dd9b14.js";import{u as Z}from"./polling.05952d58.js";import{G as q}from"./PhPencil.vue.45f1d7cc.js";import{A as J}from"./index.7341a9c9.js";(function(){try{var i=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(i._sentryDebugIds=i._sentryDebugIds||{},i._sentryDebugIds[e]="d6e1e932-8539-4617-ba7a-f9dfa2391d48",i._sentryDebugIdIdentifier="sentry-dbid-d6e1e932-8539-4617-ba7a-f9dfa2391d48")}catch{}})();class y{constructor(e){a(this,"data");a(this,"deleted");a(this,"wasDeleted",e=>this.deleted.value.includes(e));a(this,"wasUpdated",e=>this.data.hasChangesDeep(e));a(this,"set",(e,t)=>{this.data.set(e,t),this.deleted.value=this.deleted.value.filter(n=>n!==e)});a(this,"get",e=>{if(!this.deleted.value.includes(e))return this.data.get(e)});a(this,"delete",e=>{this.deleted.value=[...this.deleted.value,e]});a(this,"values",()=>{const e={},t=Object.keys(this.data.changes).concat(Object.keys(this.data.initialState));for(const n of t)this.deleted.value.includes(n)||(e[n]=this.data.get(n));return e});a(this,"commit",()=>{this.data=E.from(this.values()),this.deleted.value=[]});this.data=E.from(e),this.deleted=F([])}static from(e){const t=e.reduce((n,{name:r,value:d})=>(n[r]=d,n),{});return new y(t)}get changes(){const e=this.deleted.value.map(t=>({name:t,change:"delete"}));for(const t of Object.keys(this.data.changes))if(!this.deleted.value.includes(t)){if(this.data.initialState[t]===void 0){e.push({name:t,value:this.data.get(t),change:"create"});continue}this.data.hasChangesDeep(t)&&e.push({name:t,value:this.data.get(t),change:"update"})}return e}}class Q{constructor(){a(this,"urlPath","env-vars")}async list(e){return await k.get(`projects/${e}/${this.urlPath}`)}async update(e,t){await k.patch(`projects/${e}/${this.urlPath}`,t)}}const U=new Q;class le{constructor(e){this.projectId=e}async get(){const e=await U.list(this.projectId);return y.from(e.map(t=>({...t,value:""})))}async update(e){await U.update(this.projectId,e)}}class de{constructor(e=_){this.fetch=e}async get(){const e=await this.fetch("/_editor/api/env-vars");if(!e.ok)throw new Error("Failed to list env vars");const t=await e.json();return y.from(t)}async update(e){await this.fetch("/_editor/api/env-vars",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}}class g{constructor(e,t,n,r){a(this,"envVarRepo");a(this,"envVars");a(this,"state",O({type:"idle"}));a(this,"mode");a(this,"fileOpener");a(this,"openEnvFile",async()=>{var e;await((e=this.fileOpener)==null?void 0:e.openFile(".env"))});a(this,"validate",e=>{const t=/^[A-Za-z_][A-Za-z0-9_]*$/,n=/^[^\s]*$/,{key:r,value:d}=e;if(!t.test(r))throw new Error(`Invalid environment variable key: "${r}". Keys must start with a letter or underscore and can contain only letters, numbers, and underscores.`);if(!n.test(d))throw new Error(`Invalid environment variable value: "${d}". Values cannot contain spaces.`)});a(this,"create",e=>{this.validate(e),this.envVars.set(e.key,e.value),this.state.value={type:"idle"}});a(this,"delete",e=>{this.envVars.delete(e),this.state.value={type:"idle"}});a(this,"startUpdating",e=>{this.state.value={type:"updating",name:e,value:this.envVars.get(e)||""}});a(this,"confirmUpdate",()=>{this.state.value.type==="updating"&&(this.envVars.set(this.state.value.name,this.state.value.value),this.state.value={type:"idle"})});a(this,"cancelUpdate",()=>{this.state.value={type:"idle"}});a(this,"pollingFunction",async()=>{if(!this.isLocalEditor)return;const e=await this.envVarRepo.get();Object.entries(e.values()).forEach(([t,n])=>{this.envVars.wasDeleted(t)||this.envVars.get(t)===void 0&&this.envVars.set(t,n)})});a(this,"columns",()=>[{name:"Key"},{name:"Value"},{name:""}]);a(this,"rows",()=>Object.entries(this.envVars.values()).map(([e,t])=>({key:e,cells:[{type:"text",text:e,contentType:this.wasUpdated(e)?"warning":"default"},{type:"text",text:this.isLocalEditor?t:"*********",contentType:this.wasUpdated(e)?"warning":"default"},{type:"actions",actions:[{icon:R,label:"Delete",onClick:()=>this.delete(e),dangerous:!0},{icon:q,label:"Update",onClick:()=>this.startUpdating(e)}]}]})));a(this,"save",async()=>{await this.envVarRepo.update(this.envVars.changes),this.envVars.commit()});a(this,"hasChanges",()=>this.envVars.changes.length>0);a(this,"table",()=>({columns:this.columns(),rows:this.rows()}));this.envVarRepo=e,this.envVars=t,this.mode=n,this.fileOpener=r}static async create(e,t,n){const r=await e.get();return new g(e,r,t,n)}get isLocalEditor(){return this.mode==="editor"}get saveMessage(){return this.isLocalEditor?"Save":"Save and Apply"}get creationFields(){return[{label:"Variable name",key:"key"},{label:"Variable value",key:"value",type:"multiline-text"}]}get isUpdating(){return this.state.value.type==="updating"}wasUpdated(e){return this.envVars.wasUpdated(e)}}const ue=I({__name:"View",props:{envVarRepository:{},mode:{},fileOpener:{}},setup(i){const e=i,{result:t,loading:n}=K(async()=>{const v=await g.create(e.envVarRepository,e.mode,e.fileOpener);return r(),v}),{startPolling:r,endPolling:d}=Z({task:()=>{var v;return(v=t.value)==null?void 0:v.pollingFunction()},interval:2e3});D(()=>d());const x={columns:[],rows:[]};return(v,u)=>{var w,b;return p(),S($,null,[s(t)?(p(),f(H,{key:0,"entity-name":"Env var",loading:s(n),title:"Environment Variables",description:"Set environment variables for your project.","empty-title":"No environment variables set",table:s(t).table()||x,"create-button-text":"Add Environment Variable",create:s(t).create,fields:s(t).creationFields||[],live:s(t).isLocalEditor},T({_:2},[(w=s(t))!=null&&w.isLocalEditor?{name:"secondary",fn:o(()=>{var l;return[c(s(P),{onClick:(l=s(t))==null?void 0:l.openEnvFile},{default:o(()=>[h("Open .env")]),_:1},8,["onClick"])]}),key:"0"}:void 0,(b=s(t))!=null&&b.isLocalEditor?{name:"extra",fn:o(()=>[c(s(J),{"show-icon":"",style:{"margin-top":"20px"}},{message:o(()=>[h(" This is simply a helper to manage your environment variables locally. The variables set here will not be deployed to Cloud with your project. ")]),_:1})]),key:"1"}:void 0,s(t)?{name:"more",fn:o(()=>[c(z,{model:s(t),disabled:!s(t).hasChanges()},{"with-changes":o(()=>[h(C(s(t).saveMessage),1)]),_:1},8,["model","disabled"])]),key:"2"}:void 0]),1032,["loading","table","create","fields","live"])):m("",!0),s(t)?(p(),f(s(M),{key:1,open:s(t).isUpdating,title:"Update value",onCancel:u[1]||(u[1]=l=>{var V;return(V=s(t))==null?void 0:V.cancelUpdate()}),onOk:u[2]||(u[2]=()=>{var l;return(l=s(t))==null?void 0:l.confirmUpdate()})},{default:o(()=>[s(t).state.value.type==="updating"?(p(),f(s(L),{key:0,layout:"vertical"},{default:o(()=>[c(s(G),null,{default:o(()=>[c(s(B),null,{default:o(()=>[h(C(s(t).state.value.name),1)]),_:1}),c(s(N),{value:s(t).state.value.value,"onUpdate:value":u[0]||(u[0]=l=>s(t).state.value.value=l)},null,8,["value"])]),_:1})]),_:1})):m("",!0)]),_:1},8,["open"])):m("",!0)],64)}}});export{le as C,de as E,ue as _};
//# sourceMappingURL=View.vue_vue_type_script_setup_true_lang.5b4a37ba.js.map
