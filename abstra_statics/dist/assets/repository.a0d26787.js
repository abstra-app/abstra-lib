import{f as s,eG as ue,eP as he,r as ce,H as de,F as ke,d as U,b as l,c as p,w as t,ev as v,eC as P,ar as y,eD as b,u as e,cM as be,aD as F,cE as B,v as Y,ex as k,bg as Se,eK as pe,e as z,eJ as K,aH as we,cm as fe,eE as Ae,eF as Re,o as xe,L as Oe,a as De,ae as G,dm as Ie,cD as H,bG as se}from"./outputWidgets.0abdb3ec.js";import{a as _e}from"./asyncComputed.cc7c102c.js";import{A as Ce,s as J}from"./api.e516f7eb.js";import{t as Pe}from"./ant-design.ed3ff111.js";import{A as M}from"./Text.8f40354f.js";import"./index.dba890f7.js";import{A as O}from"./index.f72a61bb.js";import{r as Fe,t as $e}from"./icons.a6123414.js";import{A as ge}from"./index.17135acd.js";import{f as Ee}from"./index.d1e576ed.js";import{A as re}from"./Paragraph.a90cc3a1.js";import{A as V}from"./Title.a33fe5d1.js";import"./index.6aa3cca1.js";import{T as Te,A as Ne}from"./Timeline.dd89ba07.js";import{A as ye,C as me}from"./CollapsePanel.cdd83306.js";import{A as Le}from"./Link.29ff42e2.js";import{A as ve}from"./index.71f3cbbe.js";import{A as je}from"./index.a1e9f0b1.js";import{A as qe}from"./contracts.generated.1ade1c98.js";import"./workspaces.d6475eec.js";import{S as Ke}from"./scripts.795b15f0.js";import"./envVars.eba37578.js";import"./index.99147837.js";import{F as Ve,A as Be}from"./Form.074188fd.js";import{E as Me}from"./ExpandOutlined.21164ef7.js";import{C as ze}from"./Card.a36650a5.js";(function(){try{var n=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},a=new Error().stack;a&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[a]="deadd9d8-8c03-4ca8-935c-eaf14c00fc83",n._sentryDebugIdIdentifier="sentry-dbid-deadd9d8-8c03-4ca8-935c-eaf14c00fc83")}catch{}})();var Ue={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM641.7 520.8L442.3 677.6c-7.4 5.8-18.3.6-18.3-8.8V355.3c0-9.4 10.9-14.7 18.3-8.8l199.4 156.7a11.2 11.2 0 010 17.6z"}}]},name:"play-square",theme:"filled"};const Ge=Ue;function le(n){for(var a=1;a<arguments.length;a++){var o=arguments[a]!=null?Object(arguments[a]):{},r=Object.keys(o);typeof Object.getOwnPropertySymbols=="function"&&(r=r.concat(Object.getOwnPropertySymbols(o).filter(function(u){return Object.getOwnPropertyDescriptor(o,u).enumerable}))),r.forEach(function(u){He(n,u,o[u])})}return n}function He(n,a,o){return a in n?Object.defineProperty(n,a,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[a]=o,n}var Z=function(a,o){var r=le({},a,o.attrs);return s(ue,le({},r,{icon:he}),null)};Z.displayName="DownOutlined";Z.inheritAttrs=!1;const Je=Z;function oe(n){for(var a=1;a<arguments.length;a++){var o=arguments[a]!=null?Object(arguments[a]):{},r=Object.keys(o);typeof Object.getOwnPropertySymbols=="function"&&(r=r.concat(Object.getOwnPropertySymbols(o).filter(function(u){return Object.getOwnPropertyDescriptor(o,u).enumerable}))),r.forEach(function(u){We(n,u,o[u])})}return n}function We(n,a,o){return a in n?Object.defineProperty(n,a,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[a]=o,n}var Q=function(a,o){var r=oe({},a,o.attrs);return s(ue,oe({},r,{icon:Ge}),null)};Q.displayName="PlaySquareFilled";Q.inheritAttrs=!1;const ie=Q;function X(n){switch(n.status){case"waiting":return{color:"blue",text:"Waiting"};case"running":return{color:"processing",text:"Running"};case"finished":return{color:"success",text:"Success"};case"failed":return{color:"error",text:"Failed"};case"abandoned":return{color:"warning",text:"Abandoned"}}}function Ye(){const n=ce({state:"closed"});function a(){n.value={state:"closed"}}function o(){n.value={state:"visualizations"}}function r($,w){n.value={state:"stage-run",stageRun:w}}const u=de(()=>"stageRun"in n.value?n.value.stageRun:null);return{closeDrawer:a,openVisualizationEditor:o,inspectStageRun:r,drawerState:n,selectedStageRunForDrawer:u}}const L="kanban-selected-stage-ids",j=10;function Ze({kanbanRepository:n,storage:a,filterFactory:o}){const r=ke([]),u=_e(async()=>{try{const c=await n.getData({selection:r.value,filter:o()}),i=await a.get(L)||[];for(const d of c.not_found_stages)a.set(L,i.filter(h=>h!==d)),r.value=r.value.filter(h=>h.stage_id!==d);return c}catch{return r.value=[],await a.set(L,[]),{columns:[],next_stage_options:[]}}});function $(c){const i=c.selected_stage.id,d=r.value.find(h=>h.stage_id===i);return d!=null&&d.limit?d.limit<c.total_count:!1}async function w(c){var d;const i=r.value.find(h=>h.stage_id===c);i&&(i.limit=((d=i.limit)!=null?d:0)+j,await u.refetch())}async function _(c){const i=r.value.find(d=>d.stage_id===c);i&&i.limit&&i.limit>j&&(i.limit-=j,await u.refetch())}async function A(){const c=await a.get(L)||[];r.value=c.map(i=>({stage_id:i,limit:j,offset:0}))}async function m(c,i){c?r.value=[...r.value.slice(0,i),{stage_id:c,limit:j,offset:0}]:r.value=r.value.slice(0,i),await a.set(L,r.value.map(d=>d.stage_id)),await u.refetch()}function E(c,i){var R;const d=(R=c.stages)==null?void 0:R.find(T=>T.id===c.selected_stage.id);if((d==null?void 0:d.type)!=="form")return null;const h=(i==null?void 0:i.status)==="waiting"?{[Ce]:i.id}:{};return{path:`/${d.path}`,query:h}}let I=null;const S=async()=>{await A(),u.refetch(),I=setInterval(()=>{u.refetch()},1e3)},D=()=>{I&&clearInterval(I)},C=de(()=>{var i,d,h;const c=(d=(i=u.result.value)==null?void 0:i.columns)!=null?d:[];return(h=c[c.length-1])==null?void 0:h.selected_stage});return{kanbanAsyncComputed:u,selection:r,seeMore:w,hasPagination:$,seeLess:_,setNewSelectedStageId:m,launchLink:E,lastSelectedStage:C,setup:S,tearDown:D}}const W=U({__name:"StageRunData",props:{data:{}},setup(n){return(a,o)=>(l(),p(e(B),{direction:"vertical",style:{"max-height":"200px",overflow:"hidden"}},{default:t(()=>[(l(!0),v(F,null,P(a.data,r=>(l(),v("div",{key:r.key},[s(e(M),{strong:""},{default:t(()=>[y(b(r.key),1)]),_:2},1024),s(e(be),{"tree-data":e(Pe)(r.value),style:{"pointer-events":"none"}},null,8,["tree-data"])]))),128))]),_:1}))}}),Qe={key:0},Xe={key:1,class:"terminal"},et=U({__name:"ExecutionInspector",props:{logs:{}},setup(n){return(a,o)=>a.logs.length===0?(l(),v("span",Qe)):(l(),v("div",Xe,[s(e(O),{vertical:""},{default:t(()=>[(l(!0),v(F,null,P(a.logs,r=>(l(),v("pre",{key:r.executionId,class:"log-text"},b(r.payload.text),1))),128))]),_:1})]))}});const tt=Y(et,[["__scopeId","data-v-032cbeba"]]),at=n=>(Ae("data-v-e10d3de6"),n=n(),Re(),n),nt={key:1},st={key:1},rt=at(()=>z("span",null,"[Deleted Stage]",-1)),lt=["onClick"],ot=U({__name:"StageRunInspector",props:{stageRun:{},kanbanRepository:{},stageRunRepository:{}},emits:["close"],setup(n,{emit:a}){const o=n;function r(_){return Object.entries(_).map(([A,m])=>({key:A,value:m,type:typeof m}))}const{result:u,loading:$}=_e(()=>{var _;return o.kanbanRepository.getLogs((_=o.stageRun)==null?void 0:_.id)}),w=(_,A)=>{var m;_.stopPropagation(),(m=o.stageRunRepository)==null||m.fork(A),a("close")};return(_,A)=>(l(),p(e(je),{open:"",title:"Thread details",size:"large",onClose:A[0]||(A[0]=m=>a("close"))},{extra:t(()=>[s(e(re),null,{default:t(()=>[s(e(ge),{style:{"font-weight":"600"}},{default:t(()=>{var m;return[y(b(e(X)({status:(m=_.stageRun)==null?void 0:m.status}).text),1)]}),_:1}),y(" "+b(e(Ee)(new Date(_.stageRun.created_at),{addSuffix:!0})),1)]),_:1})]),default:t(()=>{var m,E,I;return[(m=_.stageRun)!=null&&m.assignee?(l(),p(e(re),{key:0},{default:t(()=>{var S;return[y(" Assignee: "+b((S=_.stageRun)==null?void 0:S.assignee),1)]}),_:1})):k("",!0),((E=_.stageRun)==null?void 0:E.content)&&((I=_.stageRun)==null?void 0:I.content.length)>0?(l(),v("div",nt,[s(e(V),{level:4},{default:t(()=>[y("Current data")]),_:1}),s(W,{data:_.stageRun.content},null,8,["data"])])):k("",!0),s(e(V),{level:4,style:{"margin-bottom":"30px"}},{default:t(()=>[y(" Timeline ")]),_:1}),e($)?(l(),p(e(Se),{key:2})):e(u)?(l(),p(e(Te),{key:3},{default:t(()=>[(l(!0),v(F,null,P(e(u),({stage:S,stage_run:D,logs:C})=>(l(),p(e(Ne),{key:D.id},{default:t(()=>[s(e(me),{ghost:"","expand-icon-position":"end"},{default:t(()=>[s(e(ye),{class:"panel"},pe({header:t(()=>[S?(l(),p(e(O),{key:0,align:"center",gap:15},{default:t(()=>[s(K,{path:e(J)(S.type)},null,8,["path"]),C.length?(l(),v("span",st,b(S.title),1)):(l(),p(e(we),{key:0,placement:"right",title:"No logs"},{default:t(()=>[y(b(S.title),1)]),_:2},1024))]),_:2},1024)):(l(),p(e(O),{key:1,align:"center",gap:15},{default:t(()=>[s(K,{path:e($e)},null,8,["path"]),rt]),_:1}))]),default:t(()=>[r(D.data).length||C.length?(l(),p(e(O),{key:0,vertical:""},{default:t(()=>[r(D.data).length?(l(),p(e(O),{key:0,gap:0,vertical:""},{default:t(()=>[s(e(V),{level:5},{default:t(()=>[y(" Output data ")]),_:1}),s(W,{data:r(D.data)},null,8,["data"])]),_:2},1024)):k("",!0),C.length?(l(),p(e(O),{key:1,vertical:"",gap:0},{default:t(()=>[s(e(ve)),s(e(V),{level:5},{default:t(()=>[y(" Logs ")]),_:1}),s(tt,{logs:C},null,8,["logs"])]),_:2},1024)):k("",!0)]),_:2},1024)):(l(),p(e(fe),{key:1,description:"No logs"}))]),_:2},[_.stageRunRepository&&S?{name:"extra",fn:t(()=>[z("span",{onClick:c=>w(c,D.id)},[s(e(O),{gap:"small"},{default:t(()=>[s(K,{path:e(Fe),width:"22"},null,8,["path"]),s(e(Le),null,{default:t(()=>[y("Fork")]),_:1})]),_:1})],8,lt)]),key:"0"}:void 0]),1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):k("",!0)]}),_:1}))}});const it=Y(ot,[["__scopeId","data-v-e10d3de6"]]),q="Show All",ut=[q,...qe];function ct(){const n=ce(q);return{filterStatus:n,filterFactory:()=>n.value==q?{}:{status:n.value},labelOption:r=>r==q?q:X({status:r}).text}}const dt={style:{width:"100%",padding:"20px"}},pt={class:"stages-container"},ft={class:"stages-content"},_t=["onClick"],gt=U({__name:"Kanban",props:{storage:{},kanbanRepository:{},stageRunRepository:{}},setup(n){const a=n,o=async(h,R,T)=>{h.stopPropagation();const x=await Ke.get(R);!x||await x.run(T)},{filterFactory:r,filterStatus:u,labelOption:$}=ct(),{kanbanAsyncComputed:w,launchLink:_,setNewSelectedStageId:A,lastSelectedStage:m,setup:E,tearDown:I,seeMore:S,hasPagination:D}=Ze({kanbanRepository:a.kanbanRepository,storage:a.storage,filterFactory:r});xe(E),Oe(I);const{closeDrawer:C,inspectStageRun:c,drawerState:i,selectedStageRunForDrawer:d}=Ye();return(h,R)=>{const T=De("router-link");return l(),v("div",dt,[s(e(O),{vertical:"",style:{height:"100%"}},{default:t(()=>[s(e(me),{ghost:""},{default:t(()=>[s(e(ye),{header:"Filters"},{default:t(()=>[s(e(Ve),null,{default:t(()=>[s(e(Be),{label:"Status"},{default:t(()=>[s(e(G),{value:e(u),"onUpdate:value":R[0]||(R[0]=x=>Ie(u)?u.value=x:null),style:{width:"300px"}},{default:t(()=>[(l(!0),v(F,null,P(e(ut),x=>(l(),p(e(H),{key:x,value:x},{default:t(()=>[y(b(e($)(x)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),z("div",pt,[z("div",ft,[s(e(B),{align:"start"},{default:t(()=>{var x,ee,te;return[(l(!0),v(F,null,P((ee=(x=e(w).result.value)==null?void 0:x.columns)!=null?ee:[],(f,ae)=>(l(),p(e(B),{key:ae,direction:"vertical"},{default:t(()=>[s(e(G),{style:{width:"250px"},"allow-clear":"",value:f.selected_stage.id,"onUpdate:value":g=>e(A)(g,ae)},{suffixIcon:t(()=>[s(e(M),{type:"secondary",style:{"font-size":"small","margin-right":"2px"}},{default:t(()=>[y(b(f.total_count),1)]),_:2},1024),s(e(ve),{type:"vertical"}),s(e(Je))]),default:t(()=>[(l(!0),v(F,null,P(f.stages,g=>(l(),p(e(H),{key:g.id,value:g.id},{default:t(()=>[s(e(O),{gap:"5"},{default:t(()=>[s(K,{path:e(J)(g.type),style:{"flex-shrink":"0",width:"24px"}},null,8,["path"]),s(e(M),{ellipsis:""},{default:t(()=>[y(b(g.title),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"]),f.selected_stage.id?(l(),p(e(B),{key:0,direction:"vertical",style:{width:"100%"}},{default:t(()=>[(l(!0),v(F,null,P(f.stage_run_cards,g=>{var ne;return l(),p(e(ze),{key:g.id,size:"small",style:{"max-width":"250px",cursor:"pointer"},"body-style":{display:((ne=g.content)==null?void 0:ne.length)>0?"block":"none"},onClick:N=>e(c)(f,g)},pe({title:t(()=>[s(e(ge),null,{default:t(()=>[y(b(e(X)({status:g.status}).text),1)]),_:2},1024)]),default:t(()=>[s(W,{data:g.content},null,8,["data"]),y(" "+b(g.assignee),1)]),extra:t(()=>[s(e(Me),{onClick:N=>e(c)(f,g)},null,8,["onClick"])]),_:2},[g.status==="waiting"?{name:"actions",fn:t(()=>[e(_)(f,g)?(l(),p(T,{key:0,to:e(_)(f,g),target:"_blank",onClick:R[1]||(R[1]=N=>N.stopPropagation())},{default:t(()=>[s(e(ie))]),_:2},1032,["to"])):k("",!0),f.selected_stage.type==="script"?(l(),v("span",{key:1,onClick:N=>o(N,f.selected_stage.id,g.id)},[s(e(ie))],8,_t)):k("",!0)]),key:"0"}:void 0]),1032,["body-style","onClick"])}),128)),f.stage_run_cards.length===0?(l(),p(e(fe),{key:0})):k("",!0),e(D)(f)?(l(),p(e(se),{key:1,style:{width:"100%"},onClick:g=>e(S)(f.selected_stage.id)},{default:t(()=>[y("See more")]),_:2},1032,["onClick"])):k("",!0),f.selected_stage.can_be_started&&e(_)(f)!==null?(l(),p(T,{key:2,target:"_blank",to:e(_)(f)},{default:t(()=>[s(e(se),{style:{width:"100%"}},{default:t(()=>[y(" Start ")]),_:1})]),_:2},1032,["to"])):k("",!0)]),_:2},1024)):k("",!0)]),_:2},1024))),128)),e(w).result.value&&e(w).result.value.next_stage_options.length>0?(l(),p(e(G),{key:(te=e(m))==null?void 0:te.id,style:{width:"100%","min-width":"200px"},"allow-clear":"","onUpdate:value":R[2]||(R[2]=f=>e(A)(f,e(w).result.value.columns.length))},{default:t(()=>[(l(!0),v(F,null,P(e(w).result.value.next_stage_options,f=>(l(),p(e(H),{key:f.id,value:f.id},{default:t(()=>[s(e(O),{gap:"middle"},{default:t(()=>[s(K,{path:e(J)(f.type)},null,8,["path"]),s(e(M),null,{default:t(()=>[y(b(f.title),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1})):k("",!0)]}),_:1})])])]),_:1}),e(i).state==="stage-run"&&e(d)?(l(),p(it,{key:0,"kanban-repository":a.kanbanRepository,"stage-run":e(d),"stage-run-repository":a.stageRunRepository,onClose:e(C)},null,8,["kanban-repository","stage-run","stage-run-repository","onClose"])):k("",!0)])}}});const Bt=Y(gt,[["__scopeId","data-v-8215af9d"]]);class Mt{constructor(a,o=localStorage){this.contextKey=a,this.storage=o}makeKey(a){return`${this.contextKey}:${a}`}async get(a){const o=this.storage.getItem(this.makeKey(a));return o?JSON.parse(o):null}async set(a,o){this.storage.setItem(this.makeKey(a),JSON.stringify(o))}}export{Bt as K,Mt as L};
//# sourceMappingURL=repository.a0d26787.js.map
