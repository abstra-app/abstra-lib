import{C as A}from"./router-CH1miZPV.js";import{d as ct,r as C,P as O,a9 as lt,H as B,c as ut,a as K,p as S,e as p,u as c,v as G,w,b,g as _,M,W as tt,K as dt,U as z,c5 as gt,ak as U,S as R,aN as et,j as v,A as F,ae as y,E as ft,h as X,bC as pt,bs as L}from"./jwt-decode.esm-BzAAEbOy.js";import{a as ht}from"./build-CxnTCqqp.js";import{c as at}from"./string-CV-lx7-z.js";import"./tables-BRpQmnHF.js";import{u as mt}from"./polling-DHdIJerT.js";import{t as xt}from"./ant-design-CouOWDZf.js";import{I as Y}from"./PhCopy.vue-CzXVZzr9.js";import{G as yt}from"./PhRobot.vue-_8qB9Hij.js";import{S as wt}from"./index-BImUgWmQ.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},a=new Error().stack;a&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[a]="1eb3f5ad-c316-4f34-a8b9-a75397e30351",o._sentryDebugIdIdentifier="sentry-dbid-1eb3f5ad-c316-4f34-a8b9-a75397e30351")}catch{}})();const bt=["running","lock-failed","failed","finished","abandoned"];class N{constructor(a){this.dto=a}static from(a){return new N(a)}get entries(){return this.dto.sort((a,e)=>a.sequence-e.sequence).filter(a=>a.event!=="form-message")}}class q{constructor(a){this.dto=a}static from(a){return new q(a)}get id(){return this.dto.id}get shortId(){return this.dto.id.slice(0,8)}get createdAt(){return new Date(this.dto.createdAt)}get updatedAt(){return new Date(this.dto.updatedAt)}get status(){return this.dto.status}get context(){return this.dto.context}get buildId(){return this.dto.buildId??""}get stageId(){return this.dto.stageId}get duration_seconds(){return`${(this.updatedAt.getTime()-this.createdAt.getTime())/1e3} s`}get stageRunId(){return this.dto.stageRunId}get projectId(){return this.dto.projectId}}class qt{async list({projectId:a,...e}){const s={...e,offset:e.offset?.toString(),limit:e.limit?.toString()};Object.keys(s).forEach(n=>s[n]===void 0&&delete s[n]);const i=await A.get(`projects/${a}/executions`,s);return{executions:i.executions.map(n=>q.from(n)),totalCount:i.totalCount}}async fetchLogs(a,e,s){const i={};s?.limit!==void 0&&(i.limit=s.limit.toString()),s?.offset!==void 0&&(i.offset=s.offset.toString());const n=Object.keys(i).length>0?`?${new URLSearchParams(i).toString()}`:"",g=await A.get(`projects/${a}/executions/${e}/logs${n}`);return{logs:N.from(g.logs),totalCount:g.totalCount}}async fetchThreadData(a,e){return(await A.get(`projects/${a}/executions/${e}/thread-data`)).response}async get(a,e){const{executions:s}=await this.list({projectId:a,limit:1,search:e}),i=s.find(n=>n.id===e);if(i)return i;throw new Error(`Execution ${e} not found`)}async getExecutionTasks(a,e){return await A.get(`projects/${a}/executions/${e}/tasks`)}async fetchStages(){throw new Error("Method not implemented.")}async clear(){throw new Error("Method not implemented.")}}class Bt{async list(a){const e={...a,offset:a.offset?.toString(),limit:a.limit?.toString()};Object.keys(e).forEach(r=>e[r]===void 0&&delete e[r]);const s=Object.fromEntries(Object.entries(e??{}).filter(([,r])=>r!=null)),i=Object.keys(s).length>0?`?${new URLSearchParams(s).toString()}`:"",g=await(await fetch(`/_editor/api/executions${i}`)).json();return{executions:g.executions.map(r=>q.from(r)),totalCount:g.totalCount}}async fetchLogs(a,e,s){const n=await(await fetch(`/_editor/api/logs/${e}`)).json();return{logs:N.from(n),totalCount:n.length}}async fetchThreadData(){return{}}async get(a,e){const{executions:s}=await this.list({limit:1,search:e}),i=s.find(n=>n.id===e);if(i)return i;throw new Error(`Execution ${e} not found`)}async getExecutionTasks(a,e){return await(await fetch(`/_editor/api/executions/${e}/tasks`)).json()}async fetchStages(){return await(await fetch("/_editor/api/executions/stages")).json()}async clear(){await fetch("/_editor/api/executions/clear",{method:"DELETE"})}}const T=300,Ft=ct("logs",()=>{const o=C(null),a=C(null),e=C(""),s=C(!1),i=C(),n=O({openedExecutionIds:[],loadingExecutions:!1,waitingDebounce:!1,executions:[],executionData:{}}),g=O({currentIndex:1,pageSize:10,totalCount:0}),r=O({dateRange:void 0,buildId:void 0,stageId:void 0,status:void 0,search:void 0}),m=O({builds:[],stages:[],statuses:bt.map(t=>({label:at(t),value:t}))}),I=mt({task:()=>Z(),interval:1e4}),l=async t=>{o.value=t.executionRepository,a.value=t.buildRepository,e.value=t.projectId,s.value=t.pool??!1,i.value=t.onFilterChange,Object.assign(r,t.filters||{}),Object.assign(g,t.pagination||{}),t.openedExecutionId&&(n.openedExecutionIds=[t.openedExecutionId]),await Promise.all([x(),W()]),J(),s.value&&I.startPolling()},D=()=>{I.endPolling()},x=async()=>{if(o.value){n.loadingExecutions=!0;try{const{executions:t,totalCount:d}=await o.value.list({projectId:e.value,buildId:r.buildId,status:r.status,limit:g.pageSize,offset:(g.currentIndex-1)*g.pageSize,stageId:r.stageId,startDate:r.dateRange?.[0]?.toISOString(),endDate:r.dateRange?.[1]?.toISOString(),search:r.search});n.executions=t,g.totalCount=d}finally{n.loadingExecutions=!1}}},E=async()=>{if(!a.value){m.builds=[];return}const d=(await a.value.list(e.value)).map(u=>({label:`[${u.id.slice(0,8)}] ${u.createdAt.toLocaleString()} ${u.latest?"(Latest)":""}`,value:u.id}));m.builds=d},P=async()=>{if(!o.value)return;if(!a.value){const h=(await o.value.fetchStages()).map(k=>({label:k.title,value:k.id}));m.stages=h??[];return}const t=r.buildId??(m.builds.length>0?m.builds[0].value:void 0);if(!t){console.warn("No buildId available for fetching stage options"),m.stages=[];return}const u=(await ht.get(t))?.runtimes.map(f=>({label:f.title,value:f.id}));m.stages=u??[]},W=async()=>{try{await E(),await P()}catch(t){console.error("Error fetching options:",t)}},j=async(t,d)=>{if(!o.value)return;const u=n.executionData[t],f=d||{limit:T,offset:0},[h,k,$]=await Promise.all([o.value.fetchLogs(e.value,t,f),o.value.fetchThreadData(e.value,t),o.value.getExecutionTasks(e.value,t)]),rt={currentIndex:1,pageSize:T,totalCount:h.totalCount,loading:!1};n.executionData[t]={logs:h.logs,threadData:k,tasks:{triggerTask:$.triggerTask?{type:$.triggerTask.type,payload:$.triggerTask.payload}:null,sentTasks:$.sentTasks.map(V=>({type:V.type,payload:V.payload}))},logsPagination:u?.logsPagination||rt},n.executionData[t].logsPagination&&(n.executionData[t].logsPagination.totalCount=h.totalCount,n.executionData[t].logsPagination.loading=!1)},J=()=>{n.openedExecutionIds.forEach(async t=>{n.executionData[t]||await j(t,{limit:T,offset:0})})},Z=async()=>{n.openedExecutionIds.map(t=>{const d=n.executions.find(f=>f.id===t);if(!d||d.status!=="running")return;const u=n.executionData[t];if(u?.logsPagination){const{currentIndex:f,pageSize:h}=u.logsPagination,k=(f-1)*h;return j(t,{limit:h,offset:k})}else return j(t,{limit:T,offset:0})})},H=()=>{n.waitingDebounce=!0,g.currentIndex=1,nt(),i.value&&i.value(r)},nt=lt.debounce(async()=>{await x(),n.waitingDebounce=!1},500),ot=async t=>{let d=n.executions;return t&&(d=d.filter(f=>f.stageId===t)),d.length===0?null:d.reduce((f,h)=>f.createdAt>h.createdAt?f:h).id},Q=async(t,d)=>{const u=n.executionData[t];if(!u?.logsPagination)return;const{pageSize:f}=u.logsPagination;u.logsPagination.loading=!0,u.logsPagination.currentIndex=d;const h=(d-1)*f;await j(t,{limit:f,offset:h})},st=(t,d)=>{const u=n.executionData[t];u?.logsPagination&&(u.logsPagination.pageSize=d,u.logsPagination.currentIndex=1,Q(t,1))},it=async()=>{o.value&&(await o.value.clear(),await x())};return B(()=>r.buildId,()=>{P()}),B(r,()=>{n.openedExecutionIds=[],H()}),B([()=>g.currentIndex,()=>g.pageSize],()=>{n.openedExecutionIds=[],x()}),{state:ut(()=>({currentPage:n,pagination:g,filters:r,filterOptions:m})),currentPage:n,pagination:g,filters:r,filterOptions:m,init:l,teardown:D,fetchPage:x,fetchBuildOptions:E,fetchStageOptions:P,fetchOptions:W,fetchExecutionDetails:j,fetchEmptyLogs:J,refetch:Z,handleFilterChange:H,getNewestExecutionId:ot,fetchExecutionLogsPage:Q,setExecutionLogsPageSize:st,clear:it,polling:I}}),vt={key:0,class:"cli"},_t={key:0},Et=K({__name:"LogContainer",props:{logs:{},pagination:{}},emits:["page-change"],setup(o){return(a,e)=>(p(),S(c(G),{vertical:"",gap:"small"},{default:w(()=>[o.logs.entries.length?(p(),b("div",vt,[(p(!0),b(M,null,tt(o.logs.entries,s=>(p(),b("p",{key:s.createdAt,style:dt({margin:0,"white-space":"pre-wrap",color:s.event==="unhandled-exception"?"rgb(255, 133, 133)":"inherit"})},[s.payload.text?(p(),b("span",_t,z(s.payload.text.trim()),1)):_("",!0)],4))),128))])):_("",!0),o.pagination?(p(),S(c(G),{key:1,vertical:"",gap:"small",align:"end"},{default:w(()=>[o.pagination.totalCount>c(T)?(p(),S(c(gt),{key:0,current:o.pagination.currentIndex,"page-size":o.pagination.pageSize,total:o.pagination.totalCount,"show-size-changer":!1,"show-quick-jumper":!1,size:"small",onChange:e[0]||(e[0]=s=>a.$emit("page-change",s))},null,8,["current","page-size","total"])):_("",!0)]),_:1})):o.logs.entries.length?_("",!0):(p(),S(c(U),{key:2,type:"secondary"},{default:w(()=>[...e[1]||(e[1]=[R("Empty",-1)])]),_:1}))]),_:1}))}}),Gt=et(Et,[["__scopeId","data-v-ee1d10cd"]]),St={key:0},kt=["onClick"],Ct=["onClick"],It=K({__name:"ExecutionContext",props:{data:{},showFixWithAi:{type:Boolean},isSmartChatIdle:{type:Boolean}},emits:["ask-ai"],setup(o,{emit:a}){const e=o,s=a,i=C(!1),n=l=>{if(l==="legacyThreadData")return y.translate("i18n_executioncontext_thread_data");const D=at(l);return D.replace(/([A-Z])/g," $1").trim(),D},g=l=>l==null?!0:Array.isArray(l)?l.length===0:typeof l=="object"?Object.keys(l).length===0:!1,r=l=>{typeof l=="object"&&l!==null&&"payload"in l?(navigator.clipboard.writeText(JSON.stringify(l.payload)),L.success({content:y.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),L.error({content:y.translate("i18n_executioncontext_no_payload")}))},m=l=>{i.value=!0,l.stopPropagation(),e.isSmartChatIdle!==!1&&(s("ask-ai"),setTimeout(()=>{i.value=!1},1e3))},I=l=>{typeof l=="object"?(navigator.clipboard.writeText(JSON.stringify(l)),L.success({content:y.translate("i18n_executioncontext_copied_to_clipboard")})):(navigator.clipboard.writeText(""),L.error({content:y.translate("i18n_executioncontext_failed_copy_request")}))};return(l,D)=>(p(),b(M,null,[v(c(G),{justify:"end"},{default:w(()=>[v(c(F),{title:o.isSmartChatIdle?"":c(y).translate("i18n_executioncontext_wait_or_stop"),placement:"left"},{default:w(()=>[o.showFixWithAi?(p(),b("div",{key:0,class:ft(["ask-to-ai",{disabled:!o.isSmartChatIdle||i.value}]),onClick:m},[R(z(c(y).translate("i18n_executioncontext_fix_with_ai"))+" ",1),v(c(yt),{size:16})],2)):_("",!0)]),_:1},8,["title"])]),_:1}),v(c(wt),{direction:"vertical",style:{"border-radius":"5px",padding:"10px",color:"#fff",width:"100%","font-family":"monospace","max-height":"600px",overflow:"auto",border:"1px solid #e8e8e8"}},{default:w(()=>[Object.keys(o.data).length?(p(!0),b(M,{key:1},tt(Object.entries(o.data),([x,E])=>(p(),b("div",{key:x,class:"tree"},[x!=="legacyThreadData"||!g(E)?(p(),b("div",St,[v(c(U),{strong:""},{default:w(()=>[R(z(n(x)),1)]),_:2},1024),x==="request"?(p(),S(c(F),{key:0,title:c(y).translate("i18n_executioncontext_copy_request_tooltip")},{default:w(()=>[X("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:P=>I(E)},[v(c(Y))],8,kt)]),_:2},1032,["title"])):_("",!0),x==="triggerTask"?(p(),S(c(F),{key:1,title:c(y).translate("i18n_executioncontext_copy_payload_tooltip")},{default:w(()=>[X("span",{style:{"margin-left":"5px",cursor:"pointer",color:"initial"},onClick:P=>r(E)},[v(c(Y))],8,Ct)]),_:2},1032,["title"])):_("",!0),v(c(pt),{"tree-data":c(xt)(E),selectable:!1},null,8,["tree-data"])])):_("",!0)]))),128)):(p(),S(c(U),{key:0,type:"secondary"},{default:w(()=>[R(z(c(y).translate("i18n_executioncontext_empty")),1)]),_:1}))]),_:1})],64))}}),Mt=et(It,[["__scopeId","data-v-629427b0"]]);export{Mt as E,Gt as L,qt as R,Bt as a,Ft as u};
//# sourceMappingURL=ExecutionContext-C2AiZXsX.js.map
