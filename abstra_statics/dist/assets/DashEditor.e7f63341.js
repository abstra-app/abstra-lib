var $t=Object.defineProperty;var Gt=(s,e,t)=>e in s?$t(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var v=(s,e,t)=>(Gt(s,typeof e!="symbol"?e+"":e,t),t);import{i as D,w as K,a as Ht,s as Bt,b as q,c as C,e as me,f as oe,h as $e,j as zt,k as Ut,r as Ft}from"./index.d2b139a4.js";import{R as Kt,T as jt,S as Vt,_ as Zt,a as tt,L as Jt}from"./UnsavedChangesHandler.vue_vue_type_script_setup_true_lang.f962abf4.js";import{r as k,d as z,b as y,c as _,y as S,W as fe,Z as pt,e as L,Q as Ge,R as He,t as U,L as G,a1 as ce,ad as Be,O as W,F as de,N as he,B as ue,A as R,E as M,w as gt,Y as ft,a as _e,af as Qt,H as ee,u as X,ae as ze,p as H,o as vt,ak as qt,G as Yt,al as Xt,am as es,x as re,V as ts,S as ss,J as rs,K as os,U as is}from"./registerWidgets.f8dfb33f.js";import{d as ns,D as as,w as B,r as Ue,i as xe,a as ls,v as cs,b as mt,p as st,c as ds,m as hs}from"./DashPlayer.53ab9cfb.js";import{L as us}from"./CircularLoading.fb5be9eb.js";import{p as ps,h as gs,v as Ie,x as Pe,y as fs,r as vs,z as ms}from"./icons.074088c2.js";import{a as ys}from"./asyncComputed.a78c0f7f.js";import{D as ws}from"./dashes.5b60cc03.js";import{W as Ss}from"./workspaces.9c133c0c.js";import{B as _s}from"./BackButton.f33d09fe.js";import{S as Es}from"./SaveButton.e18edb23.js";import{P as bs}from"./PreviewButton.77be653c.js";import{D as Is}from"./DocsButton.f9dc7504.js";import{u as Ee}from"./uuid.216f8ba6.js";import{P as Fe}from"./pubsub.4b58e722.js";import"./forms.037ed7b4.js";import"./activeRecord.b9bfe1cb.js";import"./hooks.686447c7.js";import"./jobs.40e041da.js";import"./executeJs.95fae432.js";import"./PlayerNavbar.76c6ee55.js";import"./Steps.5db1e50f.js";import"./Modal.b37564e2.js";import"./passwordlessManager.e17ec9bd.js";import"./Passwordless.7e4ecc5c.js";import"./WidgetsFrame.cdf1adec.js";import"./lottie.c7ecbe32.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[e]="30cf58a3-7f75-4095-814a-1d5e1c9a8c72",s._sentryDebugIdIdentifier="sentry-dbid-30cf58a3-7f75-4095-814a-1d5e1c9a8c72")}catch{}})();const T={left:20,right:20,top:20,bottom:200};class Ke{constructor(e){v(this,"_state");v(this,"_projectedElement",null);v(this,"grid");this.grid=e,this._state=k({x:0,y:0,zoom:1})}get x(){return this._state.value.x}set x(e){if(Number.isNaN(e))throw new Error("x is NaN");this._state.value.x=e}get y(){return this._state.value.y}set y(e){if(Number.isNaN(e))throw new Error("y is NaN");this._state.value.y=e}static create(e){return new Ke(e)}setProjectedCanvas(e){this._projectedElement=e,this.fit()}get projectedElement(){if(!this._projectedElement)throw new Error("Camera has no projected element");return this._projectedElement}updateGrid(e){this.grid=e}get zoom(){return this._state.value.zoom}set zoom(e){if(e<=0)throw new Error("Zoom must be positive");this._state.value.zoom=e}fit(){if(!this.grid.width)throw new Error(`Grid width is ${this.grid.width}}`);if(!this.grid.height)throw new Error(`Grid height is ${this.grid.height}`);const e=this.canvasRect,t=Math.max(e.width-T.left-T.right,1),r=Math.max(e.height-T.top-T.bottom,1);this.zoom=1;const o=Math.min(t/this.grid.width,r/this.grid.height);this.zoomIn(o,{x:e.x+e.width/2,y:e.y+e.height/2,referential:"screen"}),this.x=t>this.grid.width*o?-(e.x+e.width/2-o*this.grid.width/2)/o:-(e.x+T.left)/o,this.y=r<this.grid.height*o?-(e.y+T.top)/o:-(e.y+e.height/2-o*this.grid.height/2)/o}screenPoint2world(e){return{x:e.x/this.zoom+this.x,y:e.y/this.zoom+this.y,referential:"world"}}worldPoint2screen(e){return{x:(e.x-this.x)*this.zoom,y:(e.y-this.y)*this.zoom,referential:"screen"}}screenDelta2world(e){return{dx:e.dx/this.zoom,dy:e.dy/this.zoom,referential:"world"}}worldDelta2screen(e){return{dx:e.dx*this.zoom,dy:e.dy*this.zoom,referential:"screen"}}screenRect2world(e){const t=this.screenPoint2world({x:e.x,y:e.y,referential:e.referential}),r=this.screenPoint2world({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:r.x-t.x,height:r.y-t.y,referential:t.referential}}worldRect2screen(e){const t=this.worldPoint2screen({x:e.x,y:e.y,referential:e.referential}),r=this.worldPoint2screen({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:r.x-t.x,height:r.y-t.y,referential:t.referential}}zoomIn(e,t){const r=this.screenPoint2world(t);this.zoom*=e;const o=this.worldPoint2screen(r),i=ns(t,o),n=this.screenDelta2world({dx:i.dx,dy:i.dy,referential:"screen"});this.x+=n.dx,this.y+=n.dy,this.correct()}translate(e,t=!0){this.x+=e.dx,this.y+=e.dy,t&&this.correct()}get canvasRect(){if(!this._projectedElement)throw new Error("No canvas element");const e=this._projectedElement.getBoundingClientRect();return{x:e.x,y:e.y,width:e.width,height:e.height,referential:"screen"}}correctZoom(){const e=this.canvasRect,t=Math.max(e.width-T.left-T.right,0),r=Math.max(e.height-T.top-T.bottom,0),o=Math.min(t/this.grid.width,r/this.grid.height);this.zoom<o&&(this.zoom=o)}correct(){this.correctZoom();const e=this.worldRect2screen({x:0,y:0,width:this.grid.width,height:this.grid.height,referential:"world"}),t=this.canvasRect,r=e.x>t.x+T.left,o=e.x+e.width<t.x+t.width-T.right,i=e.x+e.width/2-(t.x+t.width/2),n=e.width>t.width,l=e.height>t.height,c=e.y+e.height<t.y+t.height-T.bottom,a=e.y>t.y+T.top,u=e.y+e.height/2-(t.y+t.height/2),p=this.screenDelta2world({dx:n?o&&r?0:r?e.x-t.x-T.right:o?e.x+e.width-(t.x+t.width)+T.left:0:i,dy:l?c&&a?0:a?e.y-t.y-T.top:c?e.y+e.height-(t.y+t.height)+T.bottom:0:u,referential:"screen"});this.x+=p.dx,this.y+=p.dy}}const Ps=s=>(Ge("data-v-fb3c93ab"),s=s(),He(),s),Rs={class:"dash-settings"},Ls={class:"dash-property"},Os=Ps(()=>S("label",{class:"property-label"},"Name",-1)),xs=z({__name:"DashSettings",props:{dash:{}},setup(s){return(e,t)=>(y(),_("div",Rs,[S("div",Ls,[Os,fe(S("input",{"onUpdate:modelValue":t[0]||(t[0]=r=>e.dash.title=r),class:"property-input",placeholder:"Enter a name"},null,512),[[pt,e.dash.title]])]),L(Kt,{runtime:e.dash},null,8,["runtime"])]))}});const Ns=U(xs,[["__scopeId","data-v-fb3c93ab"]]),As={class:"zoom-bar"},Ts={class:"zoom-value"},Cs=z({__name:"ZoomBar",props:{camera:{}},emits:["hover","leave"],setup(s,{emit:e}){const t=s,r=k(!1),o=k(null),i=()=>{var a;(a=t.camera)==null||a.zoomIn(1.1,{x:document.body.offsetWidth/2,y:document.body.offsetHeight/2,referential:"screen"})},n=()=>{var a;(a=t.camera)==null||a.zoomIn(.9,{x:document.body.offsetWidth/2,y:document.body.offsetHeight/2,referential:"screen"})},l=G(()=>{var c,a;return`${Math.floor(((a=(c=t.camera)==null?void 0:c.zoom)!=null?a:1)*100)}%`});return ce(()=>{var c;return(c=t.camera)==null?void 0:c.zoom},()=>{clearTimeout(o.value),r.value=!0,o.value=setTimeout(()=>r.value=!1,3e3)}),(c,a)=>fe((y(),_("div",{class:"zoom-bar-wrapper",onMouseover:a[0]||(a[0]=u=>e("hover")),onMouseleave:a[1]||(a[1]=u=>e("leave"))},[S("div",As,[S("span",{class:"zoom-control",onClick:n},"-"),S("span",Ts,W(l.value),1),S("span",{class:"zoom-control",onClick:i},"+")])],544)),[[Be,c.camera&&r.value]])}});const ks=U(Cs,[["__scopeId","data-v-f937a967"]]),rt={PandasDataFrame:"https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html",PlotlyFigure:"https://plotly.com/python-api-reference/generated/plotly.graph_objects.Figure.html","datetime.time":"https://docs.python.org/3/library/datetime.html#datetime.time","datetime.date":"https://docs.python.org/3/library/datetime.html#datetime.date","io.IOBase":"https://docs.python.org/3/library/io.html#io.IOBase","time.struct_time":"https://docs.python.org/3/library/time.html#time.struct_time"},Ds="#E286A3",Ws="#EF9542",Ms="#B462DB",$s="#40B6D3",Gs="#6FB96E",Hs=[Ds,Ws,Ms,$s,Gs];function ot(s){let e=s;return Object.keys(rt).forEach(t=>{if(s.includes(t)){const r=rt[t];e=e.replace(t,`<a href="${r}" target="_blank">${t}</a>`)}}),e}const ie={},Bs=s=>e=>{if(ie[e])return ie[e];const t=Object.keys(ie).length%s.length;return ie[e]=s[t],s[t]},it=Bs([...Hs]),zs=()=>{Object.keys(ie).forEach(s=>delete ie[s])};class Us{constructor(){v(this,"globalEventListeners",[])}addGlobalEventListener(e,t){addEventListener(e,t),this.globalEventListeners.find(r=>r.evt===e)||this.globalEventListeners.push({evt:e,handler:t})}removeGlobalEventListeners(){this.globalEventListeners.forEach(({evt:e,handler:t})=>{removeEventListener(e,t)}),this.globalEventListeners=[]}}const Fs={class:"param-types"},Ks=["innerHTML"],js={key:1,class:"prop-type"},Vs=["innerHTML"],Zs=z({__name:"ParamTypes",props:{param:{}},setup(s){return(e,t)=>(y(),_("div",Fs,[e.param&&e.param.typeDescription?(y(!0),_(de,{key:0},he(e.param.typeDescription,r=>(y(),_("div",{key:r,class:"prop-type"},[S("p",{class:"type",style:ue({color:R(it)(r)}),innerHTML:R(ot)(r)},null,12,Ks)]))),128)):e.param&&e.param.typeName?(y(),_("div",js,[S("p",{class:"type",style:ue({color:R(it)(e.param.typeName)}),innerHTML:R(ot)(e.param.typeName)},null,12,Vs)])):M("",!0)]))}});const nt=U(Zs,[["__scopeId","data-v-d6aed39d"]]),Js=["value","placeholder"],Qs=["value","placeholder"],qs=z({__name:"PythonPropInputRaw",props:{hasError:{type:Boolean},placeholder:{},value:{},paramName:{},isCode:{type:Boolean},commit:{type:Function}},emits:["input","change","clearSuggestions"],setup(s,{emit:e}){const t=s,r=gt({isActive:!1,hasChanges:!1}),o=c=>{e("input",c),r.hasChanges=!0},i=()=>{r.isActive=!1,e("clearSuggestions")},n=c=>{c.preventDefault();const a=c.target,u=a.selectionStart,p=a.selectionEnd,h=a.value;a.value=h.substring(0,u)+"	"+h.substring(p),a.selectionStart=a.selectionEnd=u+1,a.dispatchEvent(new Event("input"))},l=c=>{t.commit(c),r.hasChanges=!1};return ft(()=>{r.hasChanges&&t.commit(t.value)}),(c,a)=>{var p,h;const u=_e("icon");return y(),_("div",{class:ee(["input-container",{error:c.hasError}])},[L(u,{path:R(ps),class:"icon",fill:c.hasError?"#D35249":r.isActive?"#3482E5":void 0},null,8,["path","fill"]),c.isCode?(y(),_("textarea",{key:0,value:c.value,class:"prop-input",placeholder:(p=c.placeholder)!=null?p:void 0,onInput:a[0]||(a[0]=d=>o(d.target.value)),onClick:a[1]||(a[1]=d=>r.isActive=!0),onBlur:i,onKeydown:a[2]||(a[2]=Qt(d=>n(d),["tab"])),onChange:a[3]||(a[3]=d=>l(d.target.value))},null,40,Js)):(y(),_("input",{key:1,value:c.value,class:"prop-input",placeholder:(h=c.placeholder)!=null?h:void 0,onInput:a[4]||(a[4]=d=>o(d.target.value)),onClick:a[5]||(a[5]=d=>r.isActive=!0),onBlur:i,onChange:a[6]||(a[6]=d=>l(d.target.value))},null,40,Qs))],2)}}});const Ys=U(qs,[["__scopeId","data-v-d30fa88e"]]),Xs={class:"suggestions"},er=["onMousedown"],tr=z({__name:"PythonAutoCompleteSuggestions",props:{suggestions:{}},emits:["select"],setup(s,{emit:e}){return(t,r)=>fe((y(),_("div",Xs,[(y(!0),_(de,null,he(t.suggestions,o=>(y(),_("div",{key:o,class:"suggestion",onMousedown:i=>e("select",o)},W(o),41,er))),128))],512)),[[Be,t.suggestions.length]])}});const sr=U(tr,[["__scopeId","data-v-afec000d"]]),rr={class:"python-wrapper"},or=z({__name:"PythonPropInput",props:{hasError:{type:Boolean},placeholder:{},value:{},paramName:{},dashPlayerService:{},isCode:{type:Boolean},commit:{type:Function}},emits:["input"],setup(s,{emit:e}){const t=s,r=G(()=>t.dashPlayerService.suggestionsFor),o=G(()=>t.dashPlayerService.suggestions),i=a=>{l(t.paramName,a),e("input",a)},n=a=>{c(),e("input",a),t.commit(a)},l=async(a,u)=>{!u||t.dashPlayerService.getAutocompleteSuggestions(a,u)},c=async()=>{await ze(),t.dashPlayerService.clearSuggestions()};return(a,u)=>(y(),_("div",rr,[L(Ys,{value:a.value,commit:a.commit,"is-code":a.isCode,"param-name":a.paramName,"dash-player-service":a.dashPlayerService,onInput:i,onClearSuggestions:c},null,8,["value","commit","is-code","param-name","dash-player-service"]),r.value===a.paramName?(y(),X(sr,{key:0,suggestions:o.value,onSelect:n},null,8,["suggestions"])):M("",!0)]))}});const Re=U(or,[["__scopeId","data-v-63688ff1"]]),ir={name:"If Block",description:"A block of elements that is only rendered depending on a condition",params:[{typeName:"Boolean",argName:"condition",isKwarg:!1,default:null}],defaultEditProps:{condition:!0},thumbname:"IfBlock.svg"},ae={"if-block":ir},Z=s=>(Ge("data-v-718f02de"),s=s(),He(),s),nr={class:"wrapper"},ar={class:"title"},lr={key:0,class:"widget-prop"},cr=Z(()=>S("h2",null,"Error",-1)),dr=Z(()=>S("p",{class:"section-description"},"Some errors were found while computing the widget.",-1)),hr=["textContent"],ur={key:1,class:"section"},pr=Z(()=>S("h2",null,"VARIABLE",-1)),gr={key:0,class:"section-content"},fr={class:"widget-prop"},vr=Z(()=>S("p",{class:"prop-label"},"Bind a variable",-1)),mr=Z(()=>S("p",{class:"prop-description"},"Create a variable to be controlled by this widget.",-1)),yr={class:"input-container"},wr={key:0,class:"variable-error prop-error"},Sr=Z(()=>S("pre",null,"Variable not defined",-1)),_r={key:1,class:"prop-error",textContent:"SyntaxError: This field must be a variable name"},Er=["textContent"],br={key:2,class:"section"},Ir=Z(()=>S("h2",null,"EVENTS",-1)),Pr={key:0,class:"section-content"},Rr=Z(()=>S("p",{class:"section-description"}," Each event is a Python code that runs on specified situations ",-1)),Lr={class:"prop-label"},Or={class:"prop-description"},xr={class:"section"},Nr=Z(()=>S("h2",null,"PROPERTIES",-1)),Ar={key:0,class:"section-content"},Tr=Z(()=>S("p",{class:"section-description"}," Each property is a Python expression, make sure to use the correct syntax. ",-1)),Cr={class:"prop-label"},kr={class:"prop-description"},Dr=["textContent"],Wr=Z(()=>S("div",{class:"feedback"},null,-1)),Mr=[Wr],at=402,$r=z({__name:"WidgetEditor",props:{selectedWidgetErrors:{},layoutModel:{},selectedWidgets:{},dashPlayerService:{}},emits:["close","create-variable"],setup(s,{emit:e}){const t=s,r=k(null);ce(()=>t.selectedWidgetErrors,()=>{r.value=null});const o=m=>{g.openedSections.includes(m)?g.openedSections=g.openedSections.filter(b=>b!==m):g.openedSections.push(m)},i=m=>g.openedSections.includes(m),n=m=>D(m)?K[m.type].name:ae[m.type].name,l=G(()=>r.value===null?t.selectedWidgetErrors:r.value==="variable"?H.exports.omit(t.selectedWidgetErrors,"variable"):{...t.selectedWidgetErrors,props:H.exports.omit(t.selectedWidgetErrors.props,r.value)}),c=G(()=>a.value.type.includes("-input")&&a.value.type!=="click-input"),a=G(()=>t.selectedWidgets[0]),u=G(()=>{var I;if(!D(a.value))return;const b=((I=K[a.value.type].pythonAPI.params)!=null?I:[]).find(x=>x.argName==="initial_value");return b||null});function p(m){this.style.height="0",this.style.height=this.scrollHeight-24+"px"}const h=new Us,d=k(null),g=gt({isActive:!1,resizing:!1,width:at,openedSections:["properties","variable"]});vt(()=>{d.value&&(h.addGlobalEventListener("mouseup",()=>g.resizing=!1),h.addGlobalEventListener("mousemove",I=>f(I))),document.querySelectorAll(".widget-props-editor textarea").forEach(I=>{!I||(I.setAttribute("style","height:"+(I.scrollHeight-24)+"px;overflow-y:hidden;"),I.addEventListener("input",p,!1))})}),qt(()=>{zs(),h.removeGlobalEventListeners()});const f=m=>{g.resizing&&(g.width=Math.max(g.width-m.movementX,at))},E=G(()=>({width:`${g.width}px`})),w=m=>ae[m.type].params,O=G(()=>{const m=(x,F)=>x.argName===F.argName&&x.typeName===F.typeName,b=(x,F,P)=>P.findIndex(se=>m(x,se))===F,I=x=>!x.formOnly;return t.selectedWidgets.flatMap(x=>{var F;return D(x)?(F=K[x.type])==null?void 0:F.pythonAPI.params:w(x)}).filter(Boolean).filter(I).filter(b)}),J=G(()=>{const m=(I,x)=>I.key===x.key,b=(I,x,F)=>F.findIndex(P=>m(I,P))===x;return t.selectedWidgets.flatMap(I=>{var x;return D(I)?(x=K[I.type])==null?void 0:x.events:[]}).filter(Boolean).filter(b).filter(I=>I.key!=="change")}),Ot=m=>{t.layoutModel.updateVariable(m,a.value.id),r.value="variable"},xt=m=>b=>{t.layoutModel.updateProp({param:m,value:b},t.selectedWidgets.map(I=>I.id)),r.value=m.argName},Nt=m=>b=>{t.layoutModel.updateEvent({event:m,value:b},t.selectedWidgets.map(I=>I.id))},At=()=>{var m,b;return(b=(m=l.value.variable)==null?void 0:m.repr)==null?void 0:b.includes("SyntaxError")},Tt=()=>{var m,b;return(b=(m=l.value.variable)==null?void 0:m.repr)==null?void 0:b.includes("NameError")},Ct=m=>{!m||(t.dashPlayerService.sendVariableCreated(m),e("create-variable",m))},kt=()=>{var m,b;return((m=l.value.widget)==null?void 0:m.repr)&&!Object.values((b=l.value.props)!=null?b:{}).some(I=>I.repr)},Dt=()=>{var m;return(m=l.value.widget)==null?void 0:m.repr},be=m=>{var b,I;return(I=(b=l.value.props)==null?void 0:b[m])==null?void 0:I.repr},Wt=m=>H.exports.upperFirst(m.replace(/_/g," "));return(m,b)=>{var x,F;const I=_e("icon");return y(),_("div",{class:"widget-props-editor",style:ue(E.value)},[S("div",nr,[S("div",ar,[S("h1",null,W(n(a.value)),1),L(I,{path:R(gs),fill:"#414A58",class:"close-icon",width:"16",height:"16",onClick:b[0]||(b[0]=P=>e("close"))},null,8,["path"])]),kt()?(y(),_("div",lr,[cr,dr,S("pre",{class:"prop-error",textContent:W(Dt())},null,8,hr)])):M("",!0),c.value?(y(),_("div",ur,[S("div",{class:"section-header",onClick:b[1]||(b[1]=P=>o("variable"))},[L(I,{path:i("variable")?R(Ie):R(Pe),fill:"#414A58",class:"chevron-icon",width:"16",height:"16"},null,8,["path"]),pr]),i("variable")?(y(),_("div",gr,[S("div",fr,[vr,mr,S("div",yr,[L(Re,{placeholder:"variable_name","param-name":"variable","dash-player-service":m.dashPlayerService,value:(x=a.value.variable)!=null?x:"",commit:Ot,"is-code":!1,onInput:b[2]||(b[2]=P=>a.value.variable=P)},null,8,["dash-player-service","value"])]),Tt()&&a.value.variable?(y(),_("div",wr,[Sr,S("button",{onClick:b[3]||(b[3]=P=>Ct(a.value.variable))}," Create ")])):At()?(y(),_("pre",_r)):(F=l.value.variable)!=null&&F.repr?(y(),_("pre",{key:2,class:"prop-error",textContent:W(l.value.variable.repr)},null,8,Er)):M("",!0),L(nt,{param:u.value},null,8,["param"])])])):M("",!0)])):M("",!0),J.value.length?(y(),_("div",br,[S("div",{class:"section-header",onClick:b[4]||(b[4]=P=>o("events"))},[L(I,{path:i("events")?R(Ie):R(Pe),fill:"#414A58",class:"chevron-icon",width:"16",height:"16"},null,8,["path"]),Ir]),i("events")?(y(),_("div",Pr,[Rr,(y(!0),_(de,null,he(J.value,P=>(y(),_("div",{key:P.key,class:"widget-prop"},[S("label",Lr,"On "+W(P.key),1),S("p",Or,"Executed after "+W(P.key),1),L(Re,{"param-name":P.key,"dash-player-service":m.dashPlayerService,value:a.value.events[P.key],commit:Nt(P),"is-code":!0,onInput:se=>a.value.events[P.key]=se},null,8,["param-name","dash-player-service","value","commit","onInput"])]))),128))])):M("",!0)])):M("",!0),S("div",xr,[S("div",{class:"section-header",onClick:b[5]||(b[5]=P=>o("properties"))},[L(I,{path:i("properties")?R(Ie):R(Pe),fill:"#414A58",class:"chevron-icon",width:"16",height:"16"},null,8,["path"]),Nr]),i("properties")?(y(),_("div",Ar,[Tr,(y(!0),_(de,null,he(O.value,P=>{var se;return y(),_("div",{key:P.argName,class:"widget-prop"},[S("p",Cr,W(Wt(P.argName)),1),S("p",kr,W(P.description),1),L(Re,{"has-error":!!be(P.argName),placeholder:(se=P.default)!=null?se:void 0,"param-name":P.argName,"dash-player-service":m.dashPlayerService,value:a.value.props[P.argName],commit:xt(P),"is-code":!0,onInput:Mt=>a.value.props[P.argName]=Mt},null,8,["has-error","placeholder","param-name","dash-player-service","value","commit","onInput"]),be(P.argName)?(y(),_("pre",{key:0,class:"prop-error",textContent:W(be(P.argName))},null,8,Dr)):M("",!0),L(nt,{param:P},null,8,["param"])])}),128))])):M("",!0)])]),S("div",{ref_key:"handlerRef",ref:d,class:"handler",onMousedown:b[6]||(b[6]=Yt(P=>g.resizing=!0,["stop"]))},Mr,544)],4)}}});const Gr=U($r,[["__scopeId","data-v-718f02de"]]),yt=s=>(Ge("data-v-0d595f79"),s=s(),He(),s),Hr={class:"interact-menu"},Br={class:"icon-container"},zr=yt(()=>S("span",{class:"edit"},"Edit [Shift + P]",-1)),Ur={class:"icon-container"},Fr=yt(()=>S("span",null,"Interact [Shift + P]",-1)),Kr=z({__name:"InteractMenu",props:{isPreview:{type:Boolean}},emits:["changePreview"],setup(s,{emit:e}){return(t,r)=>{const o=_e("icon");return y(),_("div",Hr,[S("div",Br,[L(o,{class:ee(["icon",{active:!t.isPreview}]),path:R(fs),fill:"#5A677A",onClick:r[0]||(r[0]=i=>e("changePreview",!1))},null,8,["class","path"]),zr]),S("div",Ur,[L(o,{class:ee(["icon",{active:t.isPreview}]),path:R(vs),fill:"#5A677A",onClick:r[1]||(r[1]=i=>e("changePreview",!0))},null,8,["class","path"]),Fr])])}}});const jr=U(Kr,[["__scopeId","data-v-0d595f79"]]),Vr={class:"header"},Zr={key:0},Jr={key:1},Qr={key:2,class:"state"},qr={key:3,class:"state"},Yr={key:4,class:"state"},Xr={key:5},eo=z({__name:"RuntimeHeader",props:{dash:{},dashPlayerService:{}},setup(s){return(e,t)=>(y(),_("div",Vr,[e.dash.title?(y(),_("p",Zr,W(e.dash.title),1)):(y(),_("p",Jr,W(e.dash.path),1)),e.dashPlayerService.state.type==="RUNNING"?(y(),_("p",Qr,"\u{1F7E2} running")):e.dashPlayerService.state.type==="ERROR"?(y(),_("p",qr,"\u274C error")):e.dashPlayerService.state.type==="AUTHENTICATING"?(y(),_("p",Yr," \u{1F510} authenticating ")):e.dashPlayerService.state.type==="IDLE"?(y(),_("p",Xr,"\u23F3 loading")):M("",!0)]))}});const to=U(eo,[["__scopeId","data-v-eae88304"]]),so={key:0,class:"widget-metadata-card"},ro=["src"],oo={class:"metadata-title"},io={class:"metadata-description"},no={key:1,class:"collapsed-widget-metadata-card"},ao=["src"],lo=z({__name:"WidgetMetadataCard",props:{metadata:{},collapsed:{type:Boolean}},setup(s){const e=window.__baseURL?`${window.__baseURL}/media`:"",t=o=>o in ae?`${e}/${ae[o].thumbname}`:`${e}/widget-thumbs/${Ht(o)}.svg`,r=window.__vscodeTheme===2?"dark":"light";return(o,i)=>o.collapsed?(y(),_("div",no,[S("img",{class:"metadata-thumbnail",src:t(o.metadata.type),style:ue(R(r)==="dark"?{filter:"invert(1)"}:"")},null,12,ao)])):(y(),_("div",so,[S("img",{class:"metadata-thumbnail",src:t(o.metadata.type),style:ue(R(r)==="dark"?{filter:"invert(1)"}:"")},null,12,ro),S("div",oo,W(o.metadata.name),1),S("div",io,W(o.metadata.description),1)]))}});const co=U(lo,[["__scopeId","data-v-2b654c57"]]),ve={"click-input":-1,"text-output":0,"number-input":1,"text-input":2,"link-output":3,"multiple-choice-input":4,"file-input":5,"email-input":6,"markdown-output":7,"dropdown-input":8,"date-input":9,"cards-input":10,"textarea-input":11,"list-input":12,"file-output":13,"html-output":14,"pandas-output":15,"checkbox-input":16,"cnpj-input":17,"code-input":18,"progress-output":19,"pandas-row-selection-input":20,"image-input":21,"password-input":22,"currency-input":23,"iframe-output":24,"checklist-input":25,"image-output":26,"nps-input":27,"phone-input":28},ho=z({__name:"WidgetsMetadataList",emits:["dragstart","hover","leave"],setup(s,{emit:e}){const t=k(""),r=k(),o=k(!0),i=()=>{o.value=!1},n=()=>{o.value=!0,c()},l=async()=>{await ze(),r.value&&r.value.focus()},c=()=>{t.value=""},a=Object.values(K).concat(Object.entries(ae).map(([h,d])=>({type:h,...d}))).reduce((h,d)=>d.formOnly?h:{...h,[d.type]:d},{}),u=G(()=>t.value?Object.values(a).map(h=>({widget:h,score:Bt(h,t.value.split(" "))})).filter(({score:h})=>h>0).sort(({score:h},{score:d})=>d-h).map(({widget:h})=>h):Object.values(a).sort((h,d)=>{const g=h.type,f=d.type;if(g in ve){if(!(f in ve))return-1}else return 1;return ve[g]-ve[f]}));function p(h,d){e("dragstart",h,d)}return(h,d)=>{const g=_e("icon");return y(),_("div",{class:"widgets-metadata",onMouseover:i,onMouseleave:n},[S("div",Xt({class:["search",{collapsed:o.value}]},es(o.value?{click:l}:{},!0)),[L(g,{path:R(ms),class:"search-icon"},null,8,["path"]),o.value?M("",!0):fe((y(),_("input",{key:0,ref_key:"searchInput",ref:r,"onUpdate:modelValue":d[0]||(d[0]=f=>t.value=f),type:"search",class:"widgets-metadata-filter",placeholder:"Find widgets"},null,512)),[[pt,t.value]])],16),S("div",{class:ee(["widgets-metadata-list",{collapsed:o.value}])},[(y(!0),_(de,null,he(u.value,f=>(y(),X(co,{key:f.type,metadata:f,draggable:!0,collapsed:o.value,onDragstart:E=>p(E,f.type)},{default:re(()=>[ts(W(f.type),1)]),_:2},1032,["metadata","collapsed","onDragstart"]))),128))],2)],32)}}});const uo=U(ho,[["__scopeId","data-v-a17e6382"]]),po={class:"dash-layout-editor"},go=z({__name:"DashLayoutEditor",props:{dash:{},params:{},dashEditorService:{},workspace:{}},emits:["navigate","create-variable","change-preview"],setup(s,{emit:e}){const t=s,r=k(null),o=k(null),i=(w,O)=>t.dashEditorService.metadataDragStart(w,O),n=w=>e("navigate",w),l=w=>e("create-variable",w),c=w=>e("change-preview",w);t.dashEditorService.pubsub.subscribe("change-preview",c);const a=()=>{t.dashEditorService.hoverZoomBar()},u=()=>{t.dashEditorService.leaveZoomBar()};ce(t.dash.layout,()=>{t.dashEditorService.layoutModel.setLayout(t.dash.layout)}),t.dashEditorService.setupOnSave(),ce(t.dashEditorService.layoutModel,()=>t.dashEditorService.setupOnSave());const p=G(()=>t.dashEditorService.getWidgetsWithErrors()),h=G(()=>t.dashEditorService.getSelectedWidgetErrors()),d=k(null),g=k(null),f=k(null),E=k(null);return vt(()=>{t.dashEditorService.selection.setLayoutModel(t.dashEditorService.layoutModel),f.value&&E.value&&g.value&&o.value&&r.value&&d.value&&t.dashEditorService.setup(f.value,E.value,g.value,o.value,r.value,d.value)}),ft(()=>{t.dashEditorService.tearDown()}),ce(()=>t.dashEditorService.dashPlayerService.isAuthenticating(),w=>{w&&(t.dashEditorService.isPreview=!0)}),(w,O)=>(y(),_("div",po,[fe(L(uo,{onDragstart:i},null,512),[[Be,!w.dashEditorService.isPreview]]),S("div",{ref_key:"editor",ref:f,class:ee(["editor"])},[S("div",{ref_key:"listeners",ref:E,class:"listeners",tabindex:"0"},[L(as,{ref_key:"player",ref:r,class:ee(["player",{preview:w.dashEditorService.isPreview}]),style:{top:0,left:0,height:"unset"},"is-preview":!0,params:w.params,camera:w.dashEditorService.camera,"editing-mode":!w.dashEditorService.isPreview,"force-responsivity":"desktop","widgets-with-errors":p.value,"dash-player-service":w.dashEditorService.dashPlayerService,onNavigate:n},null,8,["class","params","camera","editing-mode","widgets-with-errors","dash-player-service"]),S("canvas",{ref_key:"canvas",ref:g,class:ee(["layout-canvas",{hide:w.dashEditorService.isPreview}])},null,2)],512),L(to,{ref_key:"runtimeHeader",ref:d,dash:w.dash,"dash-player-service":w.dashEditorService.dashPlayerService},null,8,["dash","dash-player-service"]),L(jr,{ref_key:"interactMenu",ref:o,class:"interact-menu","is-preview":w.dashEditorService.isPreview,onChangePreview:c},null,8,["is-preview"])],512),(w.dashEditorService.selection.selectedWidgetsIds.length>0||w.dashEditorService.selection.selectedSlottableId)&&!w.dashEditorService.isPreview&&w.dashEditorService.mouseState.state==="IDLE"?(y(),X(Gr,{key:0,"selected-widget-errors":h.value,"layout-model":w.dashEditorService.layoutModel,"selected-widgets":w.dashEditorService.selection.selectedSlottable?[w.dashEditorService.selection.selectedSlottable]:w.dashEditorService.selection.selectedWidgets,"dash-player-service":w.dashEditorService.dashPlayerService,onClose:O[0]||(O[0]=J=>w.dashEditorService.selection.resetSelection()),onCreateVariable:l},null,8,["selected-widget-errors","layout-model","selected-widgets","dash-player-service"])):M("",!0),L(ks,{camera:w.dashEditorService.camera,class:"zoom-bar",onHover:a,onLeave:u},null,8,["camera"])]))}});const fo=U(go,[["__scopeId","data-v-7be4625e"]]),vo="rgba(0, 128, 233, 0.05)";class pe{constructor(e,t){v(this,"context");this.canvas=e,this.context=this.canvas.getContext("2d"),t.slottableRenderer.setContext(this.context)}static create(e,t){return new pe(e,t)}render({mouseState:e,dashEditorService:t,hoverState:r,resizeHandlerRects:o,widgetsInRectangularSelection:i,selectedWidgets:n,computedState:l,isPreview:c,calculatedPositions:a,selectedSlottable:u}){const p=t.camera,h=t.dashPlayerService.layoutGrid,d=t.dashPlayerService.calculatePositions();if(t.dashPlayerService.state.type==="RUNNING"){if(!p)throw new Error("No camera value yet");this.renderFrame(h,p),this.renderGrid(h,p,e),this.renderWidgetShadow(l,h,p,a.widgets),this.renderInvisibleWidgets(p,a,h,d),this.renderWidgetHoverBorders(r,e,p,h,a.widgets),this.renderSelectionHull(e,p,h,n,a.widgets),this.renderWidgetsSelectionBorders(e,n,p,h,a.widgets),this.renderRectangularSelection(e),this.renderRectangularSelectionHovers(e,i,p,h,a.widgets),this.renderResizeHandlers(e,o),c||(t.slottableRenderer.slottables=a.slottables,t.slottableRenderer.renderSlottables(u))}}renderFrame(e,t){const r={x:0,y:0,width:e.width,height:e.height+e.navbarLength,referential:"world"};this.context.fillStyle="transparent",this.context.shadowColor="rgba(0,0,0,0.1)",this.context.shadowBlur=15;const o=t.worldRect2screen(r);this.context.fillRect(o.x,o.y,o.width,o.height),this.context.clearRect(o.x,o.y,o.width,o.height)}getGridDots(e,t){var u;const r=[];if(!e)return[];const o=t.worldPoint2screen({y:0,x:0,referential:"world"}),i=(u=t.projectedElement)==null?void 0:u.getBoundingClientRect(),n=e.margin*t.zoom,l=e.gap*t.zoom,c=e.cellHeight*t.zoom,a=(i.y+i.height-o.y-n)/(c+l);for(const p in Array(e.columns+1).fill(null))for(const h in Array(Math.ceil(a+1)).fill(null))r.push(t.worldPoint2screen({x:e.margin+parseInt(p)*(e.cellWidth+e.gap),y:e.margin+parseInt(h)*(e.cellHeight+e.gap)+e.navbarLength,referential:"world"}));return r}renderGrid(e,t,r){if(r.state==="MOVING"||r.state==="RESIZING"||r.state==="SLOTTABLE_RESIZING"||r.state==="MOVING_SLOTTABLE"||r.state==="DRAGGING_SLOTTABLE"||r.state==="DRAGGING"){this.context.fillStyle="rgba(0,0,0,0.1)";for(const o of this.getGridDots(e,t))this.context.beginPath(),this.context.ellipse(o.x,o.y,2,2,0,0,2*Math.PI),this.context.fill()}}renderWidgetShadow(e,t,r,o){this.context.fillStyle="rgba(0, 0, 0, 0.1)";for(const i in o){if(!e.operations.some(c=>c.path.includes(i)))continue;const n=o[i],l=r.worldRect2screen(B(n.position,t));this.context.fillRect(l.x,l.y,l.width,l.height)}}renderInvisibleWidgets(e,t,r,o){const n=t.widgets;for(const l in n){if(l in o.widgets)continue;const c=n[l],a=B(c.position,r),u={x:a.x+5,y:a.y+5,width:a.width-2*5,height:a.height-2*5,referential:"world"},p=e.worldRect2screen(u);this.context.fillStyle="rgba(0, 0, 0, 0.1)",this.context.fillRect(p.x,p.y,p.width,p.height),this.context.fillStyle="black",this.context.font="15px sans-serif",this.context.textAlign="center",this.context.textBaseline="middle",this.context.fillText(K[c.type].name,p.x+p.width/2,p.y+p.height/2)}}renderWidgetHoverBorders(e,t,r,o,i){if(this.context.strokeStyle="#ababab",e.state==="HOVERING_WIDGET"&&t.state==="IDLE"){const n=i[e.widgetId];if(!n)return;const l=r.worldRect2screen(B(n.position,o));this.context.strokeRect(l.x,l.y,l.width,l.height)}else(t.state==="MOVING"||t.state==="RESIZING"||t.state==="DRAGGING"||t.state==="SELECTING")&&Object.keys(i).forEach(n=>{const l=i[n],c=r.worldRect2screen(B(l.position,o));this.context.strokeRect(c.x,c.y,c.width,c.height)})}renderWidgetsSelectionBorders(e,t,r,o,i){if(e.state==="IDLE"||e.state==="SELECTING"){this.context.strokeStyle="#3482E5",this.context.lineWidth=2;for(const n of t){const l=i[n],c=r.worldRect2screen(B(l.position,o));this.context.strokeRect(c.x,c.y,c.width,c.height)}}}renderRectangularSelection(e){if(this.context.fillStyle=vo,e.state==="SELECTING"){const t=Math.min(e.initialMousePos.x,e.mousePos.x),r=Math.min(e.initialMousePos.y,e.mousePos.y),o=Math.abs(e.initialMousePos.x-e.mousePos.x),i=Math.abs(e.initialMousePos.y-e.mousePos.y),n={x:t,y:r,width:o,height:i};this.context.fillRect(n.x,n.y,o,i)}}renderRectangularSelectionHovers(e,t,r,o,i){if(this.context.strokeStyle="#3482E5",e.state==="SELECTING")for(const n of t){const l=i[n],c=r.worldRect2screen(B(l.position,o));this.context.strokeRect(c.x,c.y,c.width,c.height)}}renderSelectionHull(e,t,r,o,i){const n=Ue(Object.entries(i).filter(([c])=>o.has(c)).map(([c,a])=>B(a.position,r)).filter(c=>c!==null));if(e.state!=="IDLE"||!n)return;this.context.strokeStyle="#3482E5";const l=t.worldRect2screen(n);this.context.strokeRect(l.x,l.y,l.width,l.height)}static drawResizeHandler(e,t){e.fillStyle="white",e.strokeStyle="#3482E5",e.lineWidth=1,e.fillRect(t.x,t.y,t.width,t.height),e.strokeRect(t.x,t.y,t.width,t.height)}renderResizeHandlers(e,t){if(e.state!=="MOVING")for(const{rect:r}of t)pe.drawResizeHandler(this.context,r)}cursor(e,t){if(e.state==="MOVING")return"grabbing";if(e.state==="SELECTING")return"crosshair";if(e.state==="RESIZING")switch(e.side){case"bottom":case"top":return"ns-resize";case"left":case"right":return"ew-resize"}else{if(e.state==="START_PANNING")return"grab";if(e.state==="PANNING")return"grabbing";if(e.state==="JUST_CLICKED_TOGGLE")return"grabbing";if(t.state==="HOVERING_WIDGET")return"grab";if(t.state==="HOVERING_RESIZE_HANDLER")switch(t.side){case"bottom":case"top":return"ns-resize";case"left":case"right":return"ew-resize";case"top-left":case"bottom-right":return"nwse-resize";case"top-right":case"bottom-left":return"nesw-resize"}else return t.state==="HOVERING_TOGGLE"?"pointer":t.state==="HOVERING_SLOTTABLE_RESIZE_HANDLER"?"ns-resize":t.state==="HOVERING_SLOTTABLE_SELECTOR"?"pointer":"default"}}}const Ne=()=>document.body.classList.contains("vscode-dark"),Ae=window.__baseURL?`${window.__baseURL}/media`:"",mo=(s,e,t,r,o,i)=>{let n=[];return wt(e)||(i||(n=n.concat(_o(s,t,r,o))),i&&(n=n.concat(yo(s,t,r,o)).concat(wo(s,t,r,o)))),n.concat(Eo(s,t,r,e,o)).concat(Io(s,t,r,o))},wt=s=>{var e;return!((e=s.condition)==null||e)},yo=(s,e,t,r)=>{const{row:o,height:i}=s.position,{x:n,y:l,height:c,width:a}=e.getCell(0,o),u=i*c,p=a*e.columns,h={x:n,y:l,width:p,height:u,referential:"world"},d=3,g=2,f=t.worldRect2screen(h);return r.strokeStyle="#3482E5",r.lineWidth=g,r.strokeRect(f.x+d,f.y,f.width-2*d,f.height),[]},wo=(s,e,t,r)=>{const o=So(s,e,t);return pe.drawResizeHandler(r,o),[{type:"resizer",position:o,elementId:s.id}]},So=(s,e,t)=>{const{row:i,height:n}=s.position,{x:l,y:c,height:a,width:u}=e.getCell(0,i),p=n*a,h=u*e.columns,d=t.worldRect2screen({x:l,y:c,width:h,height:p,referential:"world"});return{x:d.x+d.width/2-20/2,y:d.y+d.height-6/2,width:20,height:6,referential:"screen"}},_o=(s,e,t,r)=>{const{row:o,height:i}=s.position,{x:n,y:l,height:c,width:a}=e.getCell(0,o),u=i*c,p=a*e.columns,h={x:n,y:l,width:p,height:u,referential:"world"},d=4,g=3,f=2,E=t.worldRect2screen(h);return r.strokeStyle="rgb(39, 67, 255, 0.13)",r.lineWidth=f,r.beginPath(),r.roundRect(E.x+g,E.y,E.width-2*g,E.height,d),r.stroke(),[]},Eo=(s,e,t,r,o)=>{const{row:i,height:n}=s.position,l=bo(i,n,e,t),c=new Image(l.width,l.height);return c.src=wt(r)?`${Ae}/chevron-down-${Ne()?"dark":"light"}.svg`:`${Ae}/chevron-up-${Ne()?"dark":"light"}.svg`,c.style.viewBox=`0 0 ${l.width} ${l.height}`,o.drawImage(c,l.x,l.y,l.width,l.height),[{type:"toggle",position:l,elementId:s.id}]},bo=(s,e,t,r)=>{const{y:o}=t.getCell(0,e),i=24,n=24,l={x:-30,y:o+t.cellHeight*s-n,width:i,height:n,referential:"world"};return r.worldRect2screen(l)},Io=(s,e,t,r)=>{const{row:o}=s.position,i=Po(o,e,t),n=new Image(i.width,i.height);return n.src=`${Ae}/drag-${Ne()?"dark":"light"}.svg`,r.drawImage(n,i.x,i.y,i.width,i.height),[{type:"selector",position:i,elementId:s.id}]},Po=(s,e,t)=>{const{y:r}=e.getCell(0,s),o={x:-30,y:r,width:24,height:24,referential:"world"};return t.worldRect2screen(o)},Ro={"if-block":mo};class je{constructor(e,t){v(this,"context",null);v(this,"_slottables",[]);v(this,"selectableElements",[]);v(this,"getSlottableRenderedElement",(e,t)=>{var r;return(r=this.selectableElements.find(o=>o.elementId===e&&o.type===t))!=null?r:null});v(this,"getRenderedElementUnderCursor",(e,t)=>this._slottables.find(r=>{var i,n;const o=(n=(i=this.getSlottableRenderedElement(r.id,e))==null?void 0:i.position)!=null?n:null;return o?xe(t,o):!1})||null);v(this,"getSelectorUnderCursor",e=>this.getRenderedElementUnderCursor("selector",e));v(this,"getToggleUnderCursor",e=>this.getRenderedElementUnderCursor("toggle",e));v(this,"getResizerUnderCursor",e=>this.getRenderedElementUnderCursor("resizer",e));this.layoutGrid=e,this.camera=t}static create(e,t){return new je(e,t)}setContext(e){this.context=e}set slottables(e){if(!this.context)throw new Error("No context set yet");this._slottables=Object.values(e)}renderSlottables(e){if(this.selectableElements=[],this._slottables.length!==0)for(const t of this._slottables)this.selectableElements=this.selectableElements.concat(this.renderSlottable(t,e===t.id))}renderSlottable(e,t){return Ro[e.type](e,e.props,this.layoutGrid,this.camera,this.context,t)}}const Lo=s=>e=>e[s],Oo=s=>[...new Set(s)];class Ve{constructor(){v(this,"_selectedWidgetsIds");v(this,"_selectedSlottableId");v(this,"layoutModel");this.layoutModel=null,this._selectedSlottableId=k(null),this._selectedWidgetsIds=k([])}static create(){return new Ve}setLayoutModel(e){this.layoutModel=e}get selectedWidgetsIds(){return this._selectedWidgetsIds.value}set selectedWidgetsIds(e){e.length!==0&&this.resetSelection(),this._selectedWidgetsIds.value=Oo(e)}get selectedWidgetId(){return this.selectedWidgetsIds[0]}get selectedWidget(){return this.layoutModel&&this.selectedWidgetId?this.layoutModel.getWidget(this.selectedWidgetId):null}get selectedWidgets(){return this.layoutModel?this.selectedWidgetsIds.map(e=>this.layoutModel.getWidget(e)):[]}addWidget(e){this.selectedWidgetsIds=[...this.selectedWidgetsIds,e]}addToSelectedWidgets(e){if(!this.layoutModel)return;const t=this.layoutModel.getWidgetOrSlottable(e);(!D(t)||this.selectedWidget&&!D(this.selectedWidget))&&this.clearWidgetSelection(),this.addWidget(e)}toggleWidgetSelection(e){this.selectedWidgetsIds.includes(e)?this.removeWidget(e):this.addWidget(e)}removeWidget(e){this.selectedWidgetsIds=this.selectedWidgetsIds.filter(t=>t!==e)}clearWidgetSelection(){this.selectedWidgetsIds=[]}selectAll(){!this.layoutModel||(this.selectedWidgetsIds=Object.keys(this.layoutModel.allWidgets))}get selectedSlottableId(){return this._selectedSlottableId.value}set selectedSlottableId(e){e&&this.resetSelection(),this._selectedSlottableId.value=e}get selectedSlottable(){return this.layoutModel&&this.selectedSlottableId?this.layoutModel.getSlottable(this.selectedSlottableId):null}has(e){return this.selectedWidgetsIds.includes(e)}resetSelection(){this.clearWidgetSelection(),this.selectedSlottableId=null}}class Ze{static get isMac(){return navigator.userAgent.includes("Mac OS X")}static get buildPlatform(){return{}.CURRENT_PLATFORM||"web"}}const xo=s=>Ze.isMac&&s.ctrlKey,le=s=>Ze.isMac?s.metaKey:s.ctrlKey,Te=s=>s.altKey,Q=s=>s.shiftKey,Le={alt:Te,"arrow-up":s=>s.code==="ArrowUp","arrow-down":s=>s.code==="ArrowDown","arrow-left":s=>s.code==="ArrowLeft","arrow-right":s=>s.code==="ArrowRight",ctrl:le,delete:s=>Ze.isMac?s.code==="Backspace":s.code==="Delete",enter:s=>s.code==="Enter",escape:s=>s.code==="Escape",shift:Q,space:s=>s.code==="Space",a:s=>s.code==="KeyA",b:s=>s.code==="KeyB",c:s=>s.code==="KeyC",d:s=>s.code==="KeyD",f:s=>s.code==="KeyF",g:s=>s.code==="KeyG",h:s=>s.code==="KeyH",k:s=>s.code==="KeyK",p:s=>s.code==="KeyP",v:s=>s.code==="KeyV",x:s=>s.code==="KeyX",z:s=>s.code==="KeyZ",0:s=>s.code==="Digit0","[":s=>s.code==="BracketLeft","]":s=>s.code==="BracketRight"};class No{constructor(e){v(this,"pressedKeys");v(this,"evt");this.evt=e,this.pressedKeys={};const t=r=>o=>{Object.keys(Le).forEach(i=>{Le[i](o)&&this.setPressed(i,r)})};this.evt||(window.addEventListener("keydown",t(!0)),window.addEventListener("keyup",t(!1)))}setPressed(e,t){this.pressedKeys[e]=t}isPressed(e){var t;return this.evt?Le[e](this.evt):(t=this.pressedKeys[e])!=null?t:!1}}const Ao=new No,To=s=>e=>H.exports.uniq(s.map(Lo(e))).length===1,Co=s=>s.some(e=>K[e.type].autoHeight);function ko(s,e){const t=To(s),r=Co(s),o=[],i=16,n=6;return t("colStart")&&o.push({rect:{x:e.x-n/2,y:e.y+e.height/2-i/2,width:n,height:i,referential:"screen"},side:"left"}),t("colEnd")&&o.push({rect:{x:e.x+e.width-n/2,y:e.y+e.height/2-i/2,width:n,height:i,referential:"screen"},side:"right"}),t("colStart")&&t("rowStart")&&!r&&o.push({rect:{x:e.x-n/2,y:e.y-n/2,width:n,height:n,referential:"screen"},side:"top-left"}),t("colEnd")&&t("rowStart")&&!r&&o.push({rect:{x:e.x+e.width-n/2,y:e.y-n/2,width:n,height:n,referential:"screen"},side:"top-right"}),t("colStart")&&t("rowEnd")&&!r&&o.push({rect:{x:e.x-n/2,y:e.y+e.height-n/2,width:n,height:n,referential:"screen"},side:"bottom-left"}),t("colEnd")&&t("rowEnd")&&!r&&o.push({rect:{x:e.x+e.width-n/2,y:e.y+e.height-n/2,width:n,height:n,referential:"screen"},side:"bottom-right"}),t("rowStart")&&!r&&o.push({rect:{x:e.x+e.width/2-i/2,y:e.y-n/2,width:i,height:n,referential:"screen"},side:"top"}),t("rowEnd")&&!r&&o.push({rect:{x:e.x+e.width/2-i/2,y:e.y+e.height-n/2,width:i,height:n,referential:"screen"},side:"bottom"}),o}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */var Do=globalThis&&globalThis.__extends||function(){var s=function(e,t){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,o){r.__proto__=o}||function(r,o){for(var i in o)o.hasOwnProperty(i)&&(r[i]=o[i])},s(e,t)};return function(e,t){s(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}}(),Wo=Object.prototype.hasOwnProperty;function Ce(s,e){return Wo.call(s,e)}function ke(s){if(Array.isArray(s)){for(var e=new Array(s.length),t=0;t<e.length;t++)e[t]=""+t;return e}if(Object.keys)return Object.keys(s);var r=[];for(var o in s)Ce(s,o)&&r.push(o);return r}function $(s){switch(typeof s){case"object":return JSON.parse(JSON.stringify(s));case"undefined":return null;default:return s}}function De(s){for(var e=0,t=s.length,r;e<t;){if(r=s.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Y(s){return s.indexOf("/")===-1&&s.indexOf("~")===-1?s:s.replace(/~/g,"~0").replace(/\//g,"~1")}function St(s){return s.replace(/~1/g,"/").replace(/~0/g,"~")}function We(s){if(s===void 0)return!0;if(s){if(Array.isArray(s)){for(var e=0,t=s.length;e<t;e++)if(We(s[e]))return!0}else if(typeof s=="object"){for(var r=ke(s),o=r.length,i=0;i<o;i++)if(We(s[r[i]]))return!0}}return!1}function lt(s,e){var t=[s];for(var r in e){var o=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof o<"u"&&t.push(r+": "+o)}return t.join(`
`)}var _t=function(s){Do(e,s);function e(t,r,o,i,n){var l=this.constructor,c=s.call(this,lt(t,{name:r,index:o,operation:i,tree:n}))||this;return c.name=r,c.index=o,c.operation=i,c.tree=n,Object.setPrototypeOf(c,l.prototype),c.message=lt(t,{name:r,index:o,operation:i,tree:n}),c}return e}(Error),N=_t,Mo=$,ne={add:function(s,e,t){return s[e]=this.value,{newDocument:t}},remove:function(s,e,t){var r=s[e];return delete s[e],{newDocument:t,removed:r}},replace:function(s,e,t){var r=s[e];return s[e]=this.value,{newDocument:t,removed:r}},move:function(s,e,t){var r=ye(t,this.path);r&&(r=$(r));var o=te(t,{op:"remove",path:this.from}).removed;return te(t,{op:"add",path:this.path,value:o}),{newDocument:t,removed:r}},copy:function(s,e,t){var r=ye(t,this.from);return te(t,{op:"add",path:this.path,value:$(r)}),{newDocument:t}},test:function(s,e,t){return{newDocument:t,test:ge(s[e],this.value)}},_get:function(s,e,t){return this.value=s[e],{newDocument:t}}},$o={add:function(s,e,t){return De(e)?s.splice(e,0,this.value):s[e]=this.value,{newDocument:t,index:e}},remove:function(s,e,t){var r=s.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(s,e,t){var r=s[e];return s[e]=this.value,{newDocument:t,removed:r}},move:ne.move,copy:ne.copy,test:ne.test,_get:ne._get};function ye(s,e){if(e=="")return s;var t={op:"_get",path:e};return te(s,t),t.value}function te(s,e,t,r,o,i){if(t===void 0&&(t=!1),r===void 0&&(r=!0),o===void 0&&(o=!0),i===void 0&&(i=0),t&&(typeof t=="function"?t(e,0,s,e.path):we(e,0)),e.path===""){var n={newDocument:s};if(e.op==="add")return n.newDocument=e.value,n;if(e.op==="replace")return n.newDocument=e.value,n.removed=s,n;if(e.op==="move"||e.op==="copy")return n.newDocument=ye(s,e.from),e.op==="move"&&(n.removed=s),n;if(e.op==="test"){if(n.test=ge(s,e.value),n.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",i,e,s);return n.newDocument=s,n}else{if(e.op==="remove")return n.removed=s,n.newDocument=null,n;if(e.op==="_get")return e.value=s,n;if(t)throw new N("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,s);return n}}else{r||(s=$(s));var l=e.path||"",c=l.split("/"),a=s,u=1,p=c.length,h=void 0,d=void 0,g=void 0;for(typeof t=="function"?g=t:g=we;;){if(d=c[u],d&&d.indexOf("~")!=-1&&(d=St(d)),o&&(d=="__proto__"||d=="prototype"&&u>0&&c[u-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&h===void 0&&(a[d]===void 0?h=c.slice(0,u).join("/"):u==p-1&&(h=e.path),h!==void 0&&g(e,0,s,h)),u++,Array.isArray(a)){if(d==="-")d=a.length;else{if(t&&!De(d))throw new N("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,s);De(d)&&(d=~~d)}if(u>=p){if(t&&e.op==="add"&&d>a.length)throw new N("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,s);var n=$o[e.op].call(e,a,d,s);if(n.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",i,e,s);return n}}else if(u>=p){var n=ne[e.op].call(e,a,d,s);if(n.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",i,e,s);return n}if(a=a[d],t&&u<p&&(!a||typeof a!="object"))throw new N("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,s)}}}function A(s,e,t,r,o){if(r===void 0&&(r=!0),o===void 0&&(o=!0),t&&!Array.isArray(e))throw new N("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(s=$(s));for(var i=new Array(e.length),n=0,l=e.length;n<l;n++)i[n]=te(s,e[n],t,!0,o,n),s=i[n].newDocument;return i.newDocument=s,i}function Go(s,e,t){var r=te(s,e);if(r.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",t,e,s);return r.newDocument}function we(s,e,t,r){if(typeof s!="object"||s===null||Array.isArray(s))throw new N("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,s,t);if(ne[s.op]){if(typeof s.path!="string")throw new N("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,s,t);if(s.path.indexOf("/")!==0&&s.path.length>0)throw new N('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,s,t);if((s.op==="move"||s.op==="copy")&&typeof s.from!="string")throw new N("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,s,t);if((s.op==="add"||s.op==="replace"||s.op==="test")&&s.value===void 0)throw new N("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,s,t);if((s.op==="add"||s.op==="replace"||s.op==="test")&&We(s.value))throw new N("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,s,t);if(t){if(s.op=="add"){var o=s.path.split("/").length,i=r.split("/").length;if(o!==i+1&&o!==i)throw new N("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,s,t)}else if(s.op==="replace"||s.op==="remove"||s.op==="_get"){if(s.path!==r)throw new N("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,s,t)}else if(s.op==="move"||s.op==="copy"){var n={op:"_get",path:s.from,value:void 0},l=Et([n],t);if(l&&l.name==="OPERATION_PATH_UNRESOLVABLE")throw new N("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,s,t)}}}else throw new N("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,s,t)}function Et(s,e,t){try{if(!Array.isArray(s))throw new N("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)A($(e),$(s),t||!0);else{t=t||we;for(var r=0;r<s.length;r++)t(s[r],r,e,void 0)}}catch(o){if(o instanceof N)return o;throw o}}function ge(s,e){if(s===e)return!0;if(s&&e&&typeof s=="object"&&typeof e=="object"){var t=Array.isArray(s),r=Array.isArray(e),o,i,n;if(t&&r){if(i=s.length,i!=e.length)return!1;for(o=i;o--!==0;)if(!ge(s[o],e[o]))return!1;return!0}if(t!=r)return!1;var l=Object.keys(s);if(i=l.length,i!==Object.keys(e).length)return!1;for(o=i;o--!==0;)if(!e.hasOwnProperty(l[o]))return!1;for(o=i;o--!==0;)if(n=l[o],!ge(s[n],e[n]))return!1;return!0}return s!==s&&e!==e}const Ho=Object.freeze(Object.defineProperty({__proto__:null,JsonPatchError:N,deepClone:Mo,getValueByPointer:ye,applyOperation:te,applyPatch:A,applyReducer:Go,validator:we,validate:Et,_areEquals:ge},Symbol.toStringTag,{value:"Module"}));/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2021 Joachim Wester
 * MIT license
 */var Je=new WeakMap,Bo=function(){function s(e){this.observers=new Map,this.obj=e}return s}(),zo=function(){function s(e,t){this.callback=e,this.observer=t}return s}();function Uo(s){return Je.get(s)}function Fo(s,e){return s.observers.get(e)}function Ko(s,e){s.observers.delete(e.callback)}function jo(s,e){e.unobserve()}function Vo(s,e){var t=[],r,o=Uo(s);if(!o)o=new Bo(s),Je.set(s,o);else{var i=Fo(o,e);r=i&&i.observer}if(r)return r;if(r={},o.value=$(s),e){r.callback=e,r.next=null;var n=function(){Me(r)},l=function(){clearTimeout(r.next),r.next=setTimeout(n)};typeof window<"u"&&(window.addEventListener("mouseup",l),window.addEventListener("keyup",l),window.addEventListener("mousedown",l),window.addEventListener("keydown",l),window.addEventListener("change",l))}return r.patches=t,r.object=s,r.unobserve=function(){Me(r),clearTimeout(r.next),Ko(o,r),typeof window<"u"&&(window.removeEventListener("mouseup",l),window.removeEventListener("keyup",l),window.removeEventListener("mousedown",l),window.removeEventListener("keydown",l),window.removeEventListener("change",l))},o.observers.set(e,new zo(e,r)),r}function Me(s,e){e===void 0&&(e=!1);var t=Je.get(s.object);Qe(t.value,s.object,s.patches,"",e),s.patches.length&&A(t.value,s.patches);var r=s.patches;return r.length>0&&(s.patches=[],s.callback&&s.callback(r)),r}function Qe(s,e,t,r,o){if(e!==s){typeof e.toJSON=="function"&&(e=e.toJSON());for(var i=ke(e),n=ke(s),l=!1,c=n.length-1;c>=0;c--){var a=n[c],u=s[a];if(Ce(e,a)&&!(e[a]===void 0&&u!==void 0&&Array.isArray(e)===!1)){var p=e[a];typeof u=="object"&&u!=null&&typeof p=="object"&&p!=null&&Array.isArray(u)===Array.isArray(p)?Qe(u,p,t,r+"/"+Y(a),o):u!==p&&(o&&t.push({op:"test",path:r+"/"+Y(a),value:$(u)}),t.push({op:"replace",path:r+"/"+Y(a),value:$(p)}))}else Array.isArray(s)===Array.isArray(e)?(o&&t.push({op:"test",path:r+"/"+Y(a),value:$(u)}),t.push({op:"remove",path:r+"/"+Y(a)}),l=!0):(o&&t.push({op:"test",path:r,value:s}),t.push({op:"replace",path:r,value:e}))}if(!(!l&&i.length==n.length))for(var c=0;c<i.length;c++){var a=i[c];!Ce(s,a)&&e[a]!==void 0&&t.push({op:"add",path:r+"/"+Y(a),value:$(e[a])})}}}function Zo(s,e,t){t===void 0&&(t=!1);var r=[];return Qe(s,e,r,"",t),r}const Jo=Object.freeze(Object.defineProperty({__proto__:null,unobserve:jo,observe:Vo,generate:Me,compare:Zo},Symbol.toStringTag,{value:"Module"}));Object.assign({},Ho,Jo,{JsonPatchError:_t,deepClone:$,escapePathComponent:Y,unescapePathComponent:St});function qe(s,e,t){const{selectedWidgets:r,dashEditorService:o}=s,i=o.dashPlayerService.layoutGrid,n=[...r,...t||[]],l=Math.min(...n.map(h=>{var d,g;return(g=(d=q(h,e))==null?void 0:d.colStart)!=null?g:null}).filter(h=>h!==null)),c=Math.max(...n.map(h=>{var d,g;return(g=(d=q(h,e))==null?void 0:d.colEnd)!=null?g:null}).filter(h=>h!==null)),a=Math.min(...n.map(h=>{var d,g;return(g=(d=q(h,e))==null?void 0:d.rowStart)!=null?g:null}).filter(h=>h!==null)),u=c>i.columns-1?i.columns-1-c:l<0?-l:0,p=a<0?-a:0;return n.flatMap(h=>{const d=q(h,e);if(u===0&&p===0)return[];if(!d||!D(d))return[];const g=V(j(h,C(e)),e);return[{op:"replace",path:`${g}/${h}/colStart`,backup:d,value:d.colStart+u},{op:"replace",path:`${g}/${h}/colEnd`,backup:d,value:d.colEnd+u},{op:"replace",path:`${g}/${h}/rowStart`,backup:d,value:d.rowStart+p},{op:"replace",path:`${g}/${h}/rowEnd`,backup:d,value:d.rowEnd+p}]})}const j=(s,e,t=null)=>{for(const r in e){const o=e[r];if(D(o)){if(r==s)return t}else{const i=j(s,o.slot,r);if(i)return i}}return null},Qo=(s,e)=>s.rowStart>=e.row&&s.rowStart<e.row+e.height,bt=(s,e)=>{var t;return(t=Object.keys(e.slottables).find(r=>Qo(s,e.slottables[r].position)))!=null?t:null},ct=(s,e)=>{const t=C(e),r=(i,n,l)=>{for(const c in n){if(c==i)return l;const a=n[c];if(D(a))continue;const u=r(i,a.slot,`${l}/${c}/slot`);if(u)return u}return null},o=r(s,t,me(e));if(!o)throw new Error("Widget not found in layout");return o},V=(s,e)=>s?`${me(e)}/${s}/slot`:me(e),Se=(s,e,t)=>{if(t){const o=e.slottables[t];return{...s,rowStart:s.rowStart-o.position.row,rowEnd:s.rowEnd-o.position.row}}const r=Object.values(e.slottables).reduce((o,i)=>o+(i.position.row<s.rowStart?i.position.height:0),0);return{...s,rowStart:s.rowStart-r,rowEnd:s.rowEnd-r}};function qo(s){const{dashEditorService:e,mouseState:t,workingLayout:r,calculatedPositions:o}=s,i=e.dashPlayerService.layoutGrid;if(t.state!=="MOVING_SLOTTABLE")return[];const n=i.cellAt(t.mousePos.x,t.mousePos.y),l=[],c=t.slottableId,a=r.getSlottable(c);if(!a)throw new Error("Slottable not found");const u=Rt(Pt(n,a.height),o,c);return l.push({op:"replace",path:`/slot/${c}/row`,backup:a.row,value:u.row}),l.push({op:"replace",path:`/slot/${c}/order`,backup:a.order,value:u.order}),l}function Yo(s,e){const{mouseState:t,selectedWidgets:r,calculatedPositions:o,workingLayout:i,dashEditorService:n}=s,l=n.dashPlayerService.layoutGrid;if(t.state!=="MOVING")return[];const c=l.cellAt(t.initialMousePos.x,t.initialMousePos.y),a=l.cellAt(t.mousePos.x,t.mousePos.y),u={deltaI:a.i-c.i,deltaJ:a.j-c.j},p=[];for(const h of r){const d=o.widgets[h],g={colStart:d.position.colStart+u.deltaI,colEnd:d.position.colEnd+u.deltaI,rowStart:d.position.rowStart+u.deltaJ,rowEnd:d.position.rowEnd+u.deltaJ},f=V(j(h,C(i.layout)),i.layout),E=bt(g,o),w=V(E,i.layout),O=oe(h,C(e));!O||!D(O)||(f===w?p.push({op:"replace",path:`${f}/${h}`,backup:O,value:{...O,...Se(g,o,E)}}):(p.push({op:"remove",path:`${f}/${h}`,backup:O}),p.push({op:"add",path:`${w}/${h}`,value:{...O,...Se(g,o,E)}})))}return p}function Xo(s,e,t,r){const o=[];for(const i of s.selectedWidgets){const n=V(j(i,C(r)),r),l=q(i,r);!D(l)||(o.push({op:"replace",path:`${n}/${i}/colStart`,backup:l,value:l.colStart+e}),o.push({op:"replace",path:`${n}/${i}/colEnd`,backup:l,value:l.colEnd+e}),o.push({op:"replace",path:`${n}/${i}/rowStart`,backup:l,value:l.rowStart+t}),o.push({op:"replace",path:`${n}/${i}/rowEnd`,backup:l,value:l.rowEnd+t}))}return o}function It(s,e,t,r){const{mouseState:o,dashEditorService:i}=s,n=i.dashPlayerService.layoutGrid,l=i.camera;if(!l)throw new Error("No camera value yet");if(o.state!=="RESIZING"&&o.state!=="SLOTTABLE_RESIZING")return null;const c=o.side,a=l.screenPoint2world(o.mousePos),u=c==="bottom"||c==="right"?"bottom-right":"top-left",p=n.snap(a,u),h=c.includes("left")?p.x:e.x,d=c.includes("top")?p.y:e.y,g=c.includes("right")?p.x:e.x+e.width,f=c.includes("bottom")?p.y:e.y+e.height,E=Math.abs(g-h),w=Math.abs(f-d);let O={x:Math.min(h,g),y:Math.min(d,f),width:E,height:w,referential:p.referential};return E<t&&(O={...O,width:t}),w<r&&(O={...O,height:r}),O}const ei=({selectedWidgets:s,calculatedPositions:e,dashEditorService:t})=>{const r=t.dashPlayerService.layoutGrid;return Ue(Object.entries(e.widgets).filter(([o])=>s.has(o)).map(([o,i])=>B(e.widgets[o].position,r)).filter(o=>o!==null))};function ti(s){const{mouseState:e,dashEditorService:t,calculatedPositions:r}=s,o=t.dashPlayerService.layoutGrid;if(e.state!=="SLOTTABLE_RESIZING")return[];const i=r.slottables[e.slottableId],n={colStart:0,rowStart:i.position.row,colEnd:o.columns,rowEnd:i.position.row+i.position.height},l=o.rectFromArea(n);if(!l)return[];const c=It(s,l,o.width,o.cellHeight);if(!c)return[];const a=o.areaFromRect(c);return[{op:"replace",path:`/slot/${e.slottableId}/height`,backup:i.position.height,value:a.rowEnd-a.rowStart+1}]}function si(s){const{mouseState:e,selectedWidgets:t,dashEditorService:r,workingLayout:o,calculatedPositions:i}=s,n=r.dashPlayerService.layoutGrid;if(e.state!=="RESIZING")return[];const l=e.side,c=ei(s);if(!c)return[];const a=Array.from(t).filter(h=>{const d=i.widgets[h];return ls(B(d.position,n),c,l)}),{minWidth:u,minHeight:p}=K[e.type].dashProperties;return a.flatMap(h=>{const d=i.widgets[h],g=B(d.position,n),f=It(s,g,u,p);if(!f)return[];const E=j(h,C(o.layout)),w=V(E,o.layout),O=n.areaFromRect(g),J=Se(n.areaFromRect(f),i,E);return[{op:"replace",path:`${w}/${h}/colStart`,backup:O.colStart,value:Math.max(J.colStart,0)},{op:"replace",path:`${w}/${h}/colEnd`,backup:O.colEnd,value:Math.min(J.colEnd,n.columns-1)},{op:"replace",path:`${w}/${h}/rowStart`,backup:O.rowStart,value:Math.max(J.rowStart,0)},{op:"replace",path:`${w}/${h}/rowEnd`,backup:O.rowEnd,value:J.rowEnd}]})}function ri(s){const{mouseState:e,dashEditorService:t,calculatedPositions:r}=s,o=t.dashPlayerService.layoutGrid;if(e.state!=="DRAGGING")return{operations:[]};const i=Object.values(K[e.type].pythonAPI.params).reduce((g,f)=>(f.isKwarg||!f.dashesInitialValue||(g[f.argName]=f.dashesInitialValue),g),{}),{initialWidth:n,initialHeight:l}=K[e.type].dashProperties,c=o.areaFromRect({x:e.x,y:e.y,width:n,height:l,referential:"world"}),a=bt(c,r),u=V(a,s.workingLayout.layout),p=Ee(),h={id:p,type:e.type,props:{...i},...Se(c,r,a),events:{}};return{operations:[{op:"add",path:`${u}/${p}`,value:h}],widgetId:p}}const Pt=({j:s},e)=>({row:s,height:e,order:0}),oi=(s,e)=>Object.keys(s).reduce((t,r)=>(r===e||(t[r]=s[r]),t),{}),Rt=(s,e,t)=>{const r=t?{...e,slottables:oi(e.slottables,t)}:e,o=Math.max(Object.values(r.slottables).reduce((n,l)=>l.position.row>=s.row?n:l.position.row+l.position.height<=s.row?n-l.position.height:n-(s.row-l.position.row),s.row),0),i=ii(s,r);return{...s,row:o,order:i}},dt=(s,e,t)=>Object.values(e.slottables).filter(r=>r.id!==t).find(r=>s.row>=r.position.row+r.position.height/2&&s.row<=r.position.row+r.position.height),ht=(s,e,t)=>Object.values(e.slottables).filter(r=>r.id!==t).filter(r=>r.position.row+r.position.height/2>s.row&&r.position.row<=s.row+s.height).reduce((r,o)=>!r||o.position.order<r.position.order?o:r,null),ii=(s,e)=>{var u,p;const t=dt(s,e),r=ht(s,e),o=t?ht(t.position,e,t.id):null,i=r?dt(r.position,e,r.id):null,n=[t,i].reduce((h,d)=>h?d&&h.position.order>d.position.order?d:h:d,null),l=[r,o].reduce((h,d)=>h?d&&h.position.order<d.position.order?d:h:d,null);if(!n&&!l)return 0;const c=(u=n==null?void 0:n.position.order)!=null?u:l.position.order-2,a=(p=l==null?void 0:l.position.order)!=null?p:n.position.order+2;return(c+a)/2};function ni(s){const{mouseState:e,dashEditorService:t,calculatedPositions:r}=s,o=t.dashPlayerService.layoutGrid;if(e.state!=="DRAGGING_SLOTTABLE")return{operations:[]};const i=o.cellAt(e.x,e.y),n=Ee(),l={id:n,type:e.type,props:{condition:"True"},slot:{},...Rt(Pt(i,1),r)};return{operations:[{op:"add",path:`/slot/${n}`,value:l}],widgetId:n}}function ai(s,e){const{mouseState:t,selectedWidgets:r}=s;if(t.state!=="MOVING"||!t.duplicating)return[];const o=[];for(const i of r){const n=V(j(i,C(e)),e),l=q(i,e);if(!l)continue;const c=Ee();o.push({op:"add",path:`${n}/${c}`,value:{...H.exports.cloneDeep(l),id:c}})}return o}function Lt(s,e,t){const r=s.selectedWidgets,o=r.keys().next().value,i=j(o,C(e)),n=i?$e(i,e).slot:C(e),c=Object.keys(n).filter(p=>!r.has(p)&&!(t!=null&&t.some(h=>p==h))&&D(n[p])).sort((p,h)=>cs(oe(p,C(e)),oe(h,C(e)))),a=[...r,...t||[]].map(p=>oe(p,C(e))).filter(p=>p!=null),u=[];return c.forEach(p=>{const h=oe(p,C(e));if(!h||!D(h))return;let d=0,g={...h};const f=()=>a.some(E=>mt(g,E));for(;f();)d++,g={...h,rowStart:h.rowStart+d,rowEnd:h.rowEnd+d};if(d){const E=V(i,e);u.push({op:"replace",path:`${E}/${p}/rowStart`,backup:h.rowStart,value:h.rowStart+d}),u.push({op:"replace",path:`${E}/${p}/rowEnd`,backup:h.rowEnd,value:h.rowEnd+d})}a.push(g)}),u}function li(s,e,t,r){const o=s.selectedWidgets;if(!o.size)return[];const i=[...o],n=[];return i.some(c=>{const a=j(c,C(r)),u=a?$e(a,r).slot:C(r),p=Object.keys(u).filter(d=>!o.has(d)&&D(u[d])),h=q(c,r);return p.some(d=>mt(h,u[d]))})&&o.forEach(c=>{const a=oe(c,C(r)),u=V(j(c,C(r)),r);!a||!D(a)||(n.push({op:"replace",path:`${u}/${c}/rowStart`,backup:a.rowStart,value:a.rowStart-t}),n.push({op:"replace",path:`${u}/${c}/rowEnd`,backup:a.rowEnd,value:a.rowEnd-t}),n.push({op:"replace",path:`${u}/${c}/colStart`,backup:a.colStart,value:a.colStart-e}),n.push({op:"replace",path:`${u}/${c}/colEnd`,backup:a.colEnd,value:a.colEnd-e}))}),n}function ci(s,e){const t=[],r=[];for(const o of e){const i=Ee();t.push({op:"add",path:`/slot/${i}`,value:{...H.exports.cloneDeep(o),id:i}}),r.push(i)}return{operations:t,widgetsId:r}}function di(s){const e=$(s.workingLayout.layout),t=ai(s,e);A(e,t);const r=qo(s);A(e,r);const o=Yo(s,e);A(e,o);const i=si(s);A(e,i);const n=ti(s);A(e,n);const l=ri(s);A(e,l.operations);const c=ni(s);A(e,c.operations);const a=qe(s,e,l.widgetId?[l.widgetId]:[]);A(e,a);const u=Lt(s,e,l.widgetId?[l.widgetId]:[]);return A(e,u),{layout:e,operations:[...t,...o,...r,...i,...n,...l.operations,...a,...u,...c.operations]}}function hi(s,e,t){const r=s.workingLayout.layout,o=Xo(s,e,t,r);A(r,o);const i=li(s,e,t,r);A(r,i);const n=qe(s,r);return A(r,n),[...o,...i,...n]}function ui(s,e){const t=s.workingLayout.layout,r=ci(s,e);A(t,r.operations);const o=qe(s,t,r.widgetsId);A(t,o);const i=Lt(s,t,r.widgetsId);return A(t,i),[...r.operations,...o,...i]}const pi=()=>window.location.href.startsWith("vscode-webview://"),gi=(s,e)=>{!pi()||window.vscode.postMessage({type:"usage-event",event:{type:s,payload:e}})},fi=async({operations:s,name:e})=>{gi("widgets_updated",{checkpoint:e,operations:$(s)})};class Ye{constructor(e,t){v(this,"pubsub");v(this,"checkpointHistory",{undos:[],redos:[]});v(this,"_save",null);this.workingLayout=e,this.dashEditorService=t,this.pubsub=new Fe}static create(e,t){return new Ye(e,t)}setWorkingLayout(e){this.workingLayout=e}undo(){if(this.dashEditorService.isPreview||!this.checkpointHistory.undos.length)return;const e=this.checkpointHistory.undos.pop();if(e)return A(this.workingLayout,e.operations),this.checkpointHistory.redos.push(Oe(e)),e}redo(){if(this.dashEditorService.isPreview)return;const e=this.checkpointHistory.redos.pop();if(e)return A(this.workingLayout,e.operations),this.checkpointHistory.undos.push(Oe(e)),e}execute(e){this.dashEditorService.isPreview||(A(this.workingLayout,e.operations),this.checkpointHistory.undos.push(Oe(e)),this.checkpointHistory.redos=[],this.save(),this.pubsub.publish("updated"),fi(e))}onSave(e){this._save=e}save(){var e;(e=this._save)==null||e.call(this)}}const Oe=s=>({selection:s.selection,name:`RE: ${s.name}`,operations:s.operations.slice().reverse().map(e=>vi(e))}),vi=s=>{switch(s.op){case"add":return{op:"remove",backup:s.value,path:s.path};case"remove":return{op:"add",path:s.path,value:s.backup};case"replace":return{op:"replace",backup:s.value,path:s.path,value:s.backup}}};class Xe{constructor(e,t){v(this,"operationQueue");v(this,"pubsub");this.layout=e,this.pubsub=new Fe,this.operationQueue=Ye.create(e,t)}getRootSlot(){return C(this.layout)}getRootSlotPath(){return me(this.layout)}setLayout(e){this.operationQueue.setWorkingLayout(e)}static create(e,t){return new Xe(e,t)}getWidget(e){return q(e,this.layout)}getWidgetOrSlottable(e){const t=zt(e,this.layout);if(!t)throw new Error(`Could not find widget or slottable with id ${e}`);return t}get widgets(){return this.getRootSlot()}get allWidgets(){const e=t=>Object.entries(t).reduce((r,[o,i])=>D(i)?{...r,[o]:i}:{...r,...e(i.slot)},{});return e(this.widgets)}getSlottable(e){return $e(e,this.layout)}redo(){let e=this.operationQueue.redo();for(;e&&e.operations.length===0;)e=this.operationQueue.redo();return this.operationQueue.save(),e}undo(){let e=this.operationQueue.undo();for(;e&&e.operations.length===0;)e=this.operationQueue.undo();return this.operationQueue.save(),e}updateVariable(e,t){const r=this.getWidget(t);if(!D(r))return;const o=V(j(t,this.getRootSlot()),this.layout);this.operationQueue.execute({name:"update variable",selection:new Set([t]),operations:[{op:"replace",backup:r.variable,value:e,path:`${o}/${t}/variable`}]})}updateProp({param:e,value:t},r){const o=n=>this.getWidgetOrSlottable(n).props,i=(n,l,c)=>{const a=ct(n,this.layout);return[{op:"replace",backup:o(n)[l],value:c,path:`${a}/${n}/props/${l}`}]};this.operationQueue.execute({name:"update props",operations:r.flatMap(n=>i(n,e.argName,t)),selection:new Set(r)})}updateEvent({event:e,value:t},r){const o=n=>this.getWidget(n).events,i=(n,l,c)=>{const a=V(j(n,this.getRootSlot()),this.layout);return[{op:"replace",backup:o(n)[l],value:c,path:`${a}/${n}/events/${l}`}]};this.operationQueue.execute({name:"update events",operations:r.flatMap(n=>i(n,e.key,t)),selection:new Set(r)})}delete(e){this.operationQueue.execute({name:"widgets deleted",operations:e.map(t=>{const r=ct(t,this.layout);return{op:"remove",backup:this.getWidgetOrSlottable(t),path:`${r}/${t}`}}),selection:new Set(e)})}onSave(e){this.operationQueue.onSave(e)}updateVersion(){this.layout.version!=="0.2"&&this.operationQueue.execute({name:"Version updated",operations:[{op:"replace",backup:this.layout.version,value:"0.2",path:"/version"},{op:"add",value:this.layout.widgets,path:"/slot"},{op:"remove",path:"/widgets",backup:this.layout.widgets}],selection:new Set})}}const mi=s=>({type:"copyAndPaste",selectedWidgets:s});function yi(s,e){return s.setData("text/plain",JSON.stringify(mi(e))),!0}function wi(s,e,t){const r=s.getData("text/plain");try{const o=r&&JSON.parse(r);if(!(o&&"type"in o&&o.type==="copyAndPaste"&&"selectedWidgets"in o&&Array.isArray(o.selectedWidgets)))return!1;const n=ui(e,o.selectedWidgets);return t.operationQueue.execute({name:"paste",operations:n,selection:e.selectedWidgets}),!0}catch{return!1}}class Si{constructor(e){v(this,"event");this.event=e}setData(e,t){var r;(r=this.event.clipboardData)==null||r.setData(e,t)}getData(e){var t,r;return(r=(t=this.event.clipboardData)==null?void 0:t.getData(e))!=null?r:null}getTransferItems(){var e,t;return Object.values((t=(e=this.event.clipboardData)==null?void 0:e.items)!=null?t:[]).map(Ei)}}class _i{constructor(e){v(this,"item");this.item=e}get type(){return this.item.type}getAsString(){return new Promise(e=>this.item.getAsString(t=>e(t)))}getJSONValue(){return this.getAsString().then(e=>{try{return e?JSON.parse(e):null}catch{return null}})}getAsFile(){return this.item.getAsFile()}}function Ei(s){return new _i(s)}function ut(s){return new Si(s)}function bi(s){var t;const e=(t=document.getSelection())==null?void 0:t.toString();return(s==null?void 0:s.selectionStart)!==void 0||!!e}class et{constructor(e,t,r){v(this,"dash");v(this,"zoom");v(this,"prevSlot");v(this,"_collapsedSlottables");v(this,"_isPreview");v(this,"camera");v(this,"slottableRenderer");v(this,"selection");v(this,"dashPlayerService");v(this,"layoutModel");v(this,"workspace");v(this,"_mouseState");v(this,"_hoverState");v(this,"pubsub");v(this,"editor");v(this,"listener");v(this,"canvas");v(this,"interactMenu");v(this,"dashPlayer");v(this,"runtimeHeader");v(this,"canvasService");v(this,"computedState");v(this,"throttledWidgetsChangedSend",H.exports.throttle(()=>{H.exports.isEqual(this.dash.rootSlot,this.prevSlot)||(this.prevSlot=H.exports.cloneDeep(this.dash.rootSlot),this.dashPlayerService.sendWidgetsChanged(this.dash.rootSlot))},500));v(this,"startPanning",()=>{this.mouseState.state!=="PANNING"&&(this.mouseState.state="START_PANNING")});v(this,"onKeyDownEvents",e=>({escape:()=>this.escapeEvent(),backspace:()=>this.backspaceEvent(),delete:()=>this.backspaceEvent(),z:()=>this.undoEvent(e),arrowup:()=>this.arrowUpEvent(),arrowdown:()=>this.arrowDownEvent(),arrowleft:()=>this.arrowLeftEvent(),arrowright:()=>this.arrowRightEvent(),a:()=>this.selectAllEvent(e),p:()=>this.togglePreviewEvent(e),space:()=>this.startPanning()}));v(this,"resizeEventListener",e=>function(t){e.centerCanvasHandler(t)});v(this,"copyEventListener",e=>function(t){e.copyHandler(t)});v(this,"pasteEventListener",e=>function(t){e.pasteHandler(t)});v(this,"mousemoveEventListener",e=>function(t){e.mouseMoveHandler(t)});v(this,"mouseupEventListener",e=>function(t){e.mouseup(t)});v(this,"updateHoverStateOnResizeHandler",e=>{for(const t of this.getResizeHandlerRects())if(xe(e,t.rect)){this.hoverState={state:"HOVERING_RESIZE_HANDLER",side:t.side};return}});v(this,"updateHoverStateOnWidget",e=>{var o;if(this.dashPlayerService.state.type!=="RUNNING")return;const{widgets:t}=this.calculatePositions(),r=(o=Object.keys(t).find(i=>xe(this.camera.screenPoint2world(e),B(t[i].position,this.dashPlayerService.layoutGrid))))!=null?o:null;r?this.hoverState={state:"HOVERING_WIDGET",widgetId:r}:this.hoverState={state:"NONE"}});window.__dashEditorService=this,this.zoom={active:!1,hoverZoomBar:!1},this._isPreview=k(!1),this.dashPlayerService=e,this.dashPlayerService.layoutGrid.calculatePositions=()=>this.isPreview?this.dashPlayerService.calculatePositions():this.calculatePositions(),this.camera=Ke.create(this.dashPlayerService.layoutGrid),this.slottableRenderer=je.create(this.dashPlayerService.layoutGrid,this.camera),this._collapsedSlottables=ss({}),this._mouseState={state:"IDLE"},this._hoverState={state:"NONE"},this.selection=Ve.create(),this.dash=t,this.workspace=r,this.pubsub=new Fe,this.layoutModel=Xe.create(H.exports.cloneDeep(this.dash.layout),this),this.layoutModel.updateVersion(),this.prevSlot=H.exports.cloneDeep(Ut(this.getRootWidgets(),K))}overloadCollapsedSlottablesCondition(e){return Object.entries(e).reduce((t,[r,o])=>r in this.collapsedSlottables?{...t,[r]:{condition:!0}}:{...t,[r]:o},{})}get collapsedSlottables(){return this._collapsedSlottables.value}set collapsedSlottables(e){this._collapsedSlottables.value=e}get isPreview(){return this._isPreview.value}set isPreview(e){this._isPreview.value=e}get mouseState(){return this._mouseState}set mouseState(e){this._mouseState=e}get hoverState(){return this._hoverState}set hoverState(e){this._hoverState=e}getWidgetsWithErrors(){const e=this.dashPlayerService.state;return e?e.type!=="RUNNING"?[]:Object.keys(this.layoutModel.widgets).reduce((t,r)=>{var l,c,a;const o=(l=e.errors.props)==null?void 0:l[r],i=(c=e.errors.variables)==null?void 0:c[r],n=(a=e.errors.widgets)==null?void 0:a[r];return!o&&!i&&!n||!Object.keys({...o,...i,...n}).length?t:t?[...t,r]:[r]},[]):[]}getSelectedWidgetErrors(){var r,o,i,n,l,c;const e={},t=this.dashPlayerService.state;return!t||t.type!=="RUNNING"?e:{props:(o=t.errors.props)==null?void 0:o[(r=this.selection.selectedSlottableId)!=null?r:this.selection.selectedWidgetId],widget:(n=t.errors.widgets)==null?void 0:n[(i=this.selection.selectedSlottableId)!=null?i:this.selection.selectedWidgetId],variable:(c=t.errors.variables)==null?void 0:c[(l=this.selection.selectedSlottableId)!=null?l:this.selection.selectedWidgetId]}}setupOnSave(){this.layoutModel.onSave(async()=>{!this.workspace||(this.dash.layout=this.layoutModel.layout,this.dashPlayerService.updateDashData(this.dash.makeRunnerData(this.workspace)),this.throttledWidgetsChangedSend())})}hoverZoomBar(){this.zoom.hoverZoomBar=!0}leaveZoomBar(){this.zoom.hoverZoomBar=!1}getRootWidgets(){return Object.keys(this.dash.rootSlot).reduce((e,t)=>{const r=this.dash.rootSlot[t];return r.position&&(e[t]=r),e},{})}static create(e,t,r){return new et(e,t,r)}async restart(){return this.dashPlayerService.start(),await this.dashPlayerService.wait("widgets-computed"),this.dashPlayerService.sendWidgetsChanged(this.dash.rootSlot),this.dashPlayerService.wait("widgets-computed")}metadataDragStart(e,t){if(!this.camera)return;const r=this.camera.screenPoint2world({x:e.pageX,y:e.pageY,referential:"screen"});this.selection.resetSelection(),t in ae?this.mouseState={state:"DRAGGING_SLOTTABLE",...r,type:t}:this.mouseState={state:"DRAGGING",...r,type:t}}fixPosition(e){if(!this.canvas)return;const{origin:t,element:r,ignoreZoom:o}=e;if(!this.camera||!r||!r.style)return;const i=this.camera.worldPoint2screen(t),n=this.canvas.getBoundingClientRect(),l=[`translate(${i.x-n.x}px, ${i.y-n.y}px)`,o?null:`scale(${this.camera.zoom})`].filter(c=>c).join(" ");Object.assign(r.style,{transform:l,transformOrigin:"top left"})}fixCanvasRectPosition(){var i,n,l,c,a,u,p,h,d,g;const e=this.camera.screenRect2world(this.camera.canvasRect),t=this.camera.screenDelta2world({dx:8,dy:8,referential:"screen"}),r=this.camera.screenRect2world({x:(i=this.interactMenu)==null?void 0:i.$el.getBoundingClientRect().x,y:(n=this.interactMenu)==null?void 0:n.$el.getBoundingClientRect().y,width:(l=this.interactMenu)==null?void 0:l.$el.getBoundingClientRect().width,height:(c=this.interactMenu)==null?void 0:c.$el.getBoundingClientRect().height,referential:"screen"});this.fixPosition({origin:{x:Math.min(this.dashPlayerService.layoutGrid.width+t.dx,e.x+e.width-r.width-t.dx),y:Math.max(e.y+t.dy,0),referential:"world"},element:(a=this.interactMenu)==null?void 0:a.$el,ignoreZoom:!0});const o=this.camera.screenRect2world({x:(u=this.runtimeHeader)==null?void 0:u.$el.getBoundingClientRect().x,y:(p=this.runtimeHeader)==null?void 0:p.$el.getBoundingClientRect().y,width:(h=this.runtimeHeader)==null?void 0:h.$el.getBoundingClientRect().width,height:(d=this.runtimeHeader)==null?void 0:d.$el.getBoundingClientRect().height,referential:"screen"});this.fixPosition({origin:{x:0,y:-o.height-t.dy,referential:"world"},element:(g=this.runtimeHeader)==null?void 0:g.$el,ignoreZoom:!0})}canvasMousedown(e){var o;if(!this.camera)return;const t={x:e.pageX,y:e.pageY,referential:"screen"};if(e.button==1||e.button==0&&Ao.isPressed("space")){this.mouseState={state:"PANNING",initialMousePos:t,mousePos:t};return}const r=this.camera.screenPoint2world(t);this.hoverState.state==="HOVERING_WIDGET"?this.mouseState={state:"JUST_CLICKED",pos:r,widgetId:this.hoverState.widgetId}:this.hoverState.state==="HOVERING_RESIZE_HANDLER"?this.mouseState={state:"RESIZING",side:this.hoverState.side,initialMousePos:t,mousePos:t,type:(o=this.selection.selectedWidget)==null?void 0:o.type}:this.hoverState.state==="HOVERING_TOGGLE"?this.mouseState={state:"JUST_CLICKED_TOGGLE",mousePos:t,slottable:this.hoverState.slottable}:this.hoverState.state==="HOVERING_SLOTTABLE_RESIZE_HANDLER"?this.mouseState={state:"SLOTTABLE_RESIZING",initialMousePos:t,mousePos:t,slottableId:this.hoverState.slottableId,side:"bottom"}:this.hoverState.state==="HOVERING_SLOTTABLE_SELECTOR"?this.mouseState={state:"JUST_CLICKED_SLOTTABLE_SELECTOR",slottableId:this.hoverState.slottableId,mousePos:t}:(Q(e)||this.selection.resetSelection(),this.mouseState={state:"SELECTING",initialMousePos:t,mousePos:t})}mouseMoveHandler(e){if(!this.camera)return;const t={x:e.pageX,y:e.pageY,referential:"screen"},r=this.camera.screenPoint2world(t);if(this.mouseState.state==="PANNING"){const o={dx:-e.movementX,dy:-e.movementY},i=this.camera.screenDelta2world({dx:o.dx,dy:o.dy,referential:"screen"});this.camera.translate(i),e.preventDefault(),e.stopPropagation();return}this.mouseState.state==="MOVING"&&(this.mouseState.mousePos=r,this.mouseState.duplicating=Te(e)),this.mouseState.state==="MOVING_SLOTTABLE"&&(this.mouseState.mousePos=r),this.mouseState.state==="JUST_CLICKED"&&st(this.mouseState.pos,r)*this.camera.zoom>5&&(this.selection.has(this.mouseState.widgetId)||(Q(e)?this.selection.addToSelectedWidgets(this.mouseState.widgetId):(this.selection.resetSelection(),this.selection.addToSelectedWidgets(this.mouseState.widgetId))),this.mouseState={state:"MOVING",initialMousePos:this.mouseState.pos,mousePos:r,duplicating:Te(e)}),this.mouseState.state==="JUST_CLICKED_SLOTTABLE_SELECTOR"&&st(this.mouseState.mousePos,r)*this.camera.zoom>5&&(this.mouseState={state:"MOVING_SLOTTABLE",initialMousePos:this.camera.screenPoint2world(this.mouseState.mousePos),mousePos:r,slottableId:this.mouseState.slottableId}),this.mouseState.state==="SELECTING"&&(this.mouseState.mousePos=t),this.mouseState.state==="RESIZING"&&(this.mouseState.mousePos=t),this.mouseState.state==="SLOTTABLE_RESIZING"&&(this.mouseState.mousePos=t),this.computeHoverState(t)}everySelectedWidgetInPreviewState(){const e=this.dashPlayerService.state;return e.type!=="RUNNING"?!1:this.selection.selectedWidgetsIds.every(t=>Object.keys(e.widgets).includes(t))}getRectangularHull(){const e=this.dashPlayerService.state;return e.type!=="RUNNING"?null:Ue(Object.entries(e.widgets).filter(([t])=>this.selection.has(t)).map(([t,r])=>B(r.position,this.dashPlayerService.layoutGrid)))}selectionRect(){if(this.mouseState.state!=="SELECTING")return null;const{x:e,y:t}=this.mouseState.initialMousePos,{x:r,y:o}=this.mouseState.mousePos;return{x:Math.min(e,r),y:Math.min(t,o),width:Math.abs(e-r),height:Math.abs(t-o),referential:"screen"}}pasteHandler(e){wi(ut(e),this.getInput(),this.layoutModel)&&e.preventDefault()}renderScreenPositioning(){var r;if(!this.camera||!this.workspace||!this.canvas)return;this.fixPosition({origin:{x:0,y:0,referential:"world"},element:(r=this.dashPlayer)==null?void 0:r.$el}),this.fixCanvasRectPosition();const e=this.canvas.getContext("2d");if(!e)return;const t=this.canvas.getBoundingClientRect();this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,e.clearRect(0,0,this.canvas.width,this.canvas.height),e.translate(-t.x,-t.y)}renderComputeCursor(){var e,t;!this.canvas||(this.canvas.style.cursor=(t=(e=this.canvasService)==null?void 0:e.cursor(this.mouseState,this.hoverState))!=null?t:"default")}renderPreviewState(){var o,i;if(this.dashPlayerService.state.type!=="RUNNING")return;const e=this.getInput(),t=di(e);(!H.exports.isEqual(t.operations,(o=this.computedState)==null?void 0:o.operations)||!H.exports.isEqual(t.layout,(i=this.computedState)==null?void 0:i.layout))&&(this.computedState=t),this.computedState&&this.canvasService&&this.canvasService.render({...e,computedState:this.computedState,isPreview:this.isPreview,calculatedPositions:this.calculatePositions(this.dash.makeRunnerData(this.workspace,this.computedState.layout).layout.slot)})}render(){try{this.renderScreenPositioning(),this.renderComputeCursor(),this.renderPreviewState()}catch(e){console.error(e)}finally{requestAnimationFrame(()=>this.render())}}onDragover(e){if(!this.camera)return;e.preventDefault();const t=this.camera.screenPoint2world({x:e.pageX,y:e.pageY,referential:"screen"});this.mouseState={...this.mouseState,...t}}canvasWheel(e){if(!this.camera)return;const t={x:e.pageX,y:e.pageY,referential:"screen"};if(le(e)||xo(e))this.camera.zoomIn(Math.exp(-Math.sign(e.deltaY)*.05),t),e.preventDefault();else{const r=Q(e)?{dx:e.deltaY,dy:0}:{dx:e.deltaX,dy:e.deltaY},o=this.camera.screenDelta2world({dx:r.dx,dy:r.dy,referential:"screen"});this.camera.translate(o)}e.stopPropagation()}togglePreviewEvent(e){Q(e)&&this.pubsub.publish("change-preview",!this.isPreview)}resetEditingState(e){this.mouseState={state:"IDLE"},this.computeHoverState(e)}escapeEvent(){this.mouseState.state==="IDLE"&&this.selection.resetSelection(),this.resetEditingState({referential:"screen",x:0,y:0})}backspaceEvent(){this.selection.selectedSlottableId?this.layoutModel.delete([this.selection.selectedSlottableId]):this.layoutModel.delete(this.selection.selectedWidgetsIds),this.selection.resetSelection()}undoEvent(e){if(le(e)&&Q(e)){e.preventDefault(),e.stopPropagation();const t=this.layoutModel.redo();if(t){if(t.operations.some(r=>r.op==="remove")){this.selection.resetSelection();return}this.selection.selectedWidgetsIds=[...Array.from(t.selection)]}return}else if(le(e)){e.preventDefault(),e.stopPropagation();const t=this.layoutModel.undo();if(t){if(t.operations.some(r=>r.op==="remove")){this.selection.resetSelection();return}this.selection.selectedWidgetsIds=[...Array.from(t.selection)]}return}}selectAllEvent(e){le(e)&&(e.preventDefault(),e.stopPropagation(),this.selection.selectAll())}move(e,t){const[r,o]={up:[0,-1],down:[0,1],left:[-1,0],right:[1,0]}[t],i=hi(e,r,o);this.layoutModel.operationQueue.execute({name:`move ${t}`,operations:i,selection:e.selectedWidgets})}arrowUpEvent(){this.move(this.getInput(),"up")}arrowDownEvent(){this.move(this.getInput(),"down")}arrowLeftEvent(){this.move(this.getInput(),"left")}arrowRightEvent(){this.move(this.getInput(),"right")}selectingOnMouseUp(e){Q(e)?this.widgetsInRectangularSelection().forEach(t=>{this.selection.toggleWidgetSelection(t)}):(this.selection.resetSelection(),this.widgetsInRectangularSelection().forEach(t=>{this.selection.addToSelectedWidgets(t)}))}toggleSlottable(e){this.collapsedSlottables={...this.collapsedSlottables,[e]:!this.collapsedSlottables[e]}}mouseup(e){var r;(r=this.computedState)!=null&&r.operations.length&&this.layoutModel.operationQueue.execute({name:"mouse up",operations:this.computedState.operations,selection:new Set(this.selection.selectedWidgetsIds)}),this.mouseState.state==="SELECTING"&&this.selectingOnMouseUp(e),this.mouseState.state==="JUST_CLICKED"&&(Q(e)?this.selection.toggleWidgetSelection(this.mouseState.widgetId):(this.selection.resetSelection(),this.selection.selectedSlottableId=null,this.selection.addToSelectedWidgets(this.mouseState.widgetId))),this.mouseState.state==="JUST_CLICKED_TOGGLE"&&this.toggleSlottable(this.mouseState.slottable),this.mouseState.state==="JUST_CLICKED_SLOTTABLE_SELECTOR"&&(this.selection.selectedSlottableId=this.mouseState.slottableId);const t={x:e.pageX,y:e.pageY,referential:"screen"};this.resetEditingState(t)}onKeydown(e){var t,r;(r=(t=this.onKeyDownEvents(e))[e.key.toLowerCase().trim()?e.key.toLowerCase():e.code.toLowerCase()])==null||r.call(t)}onKeyup(e){this.mouseState={state:"IDLE"}}copyHandler(e){bi(e==null?void 0:e.target)||yi(ut(e),this.selection.selectedWidgets)&&e.preventDefault()}centerCanvasHandler(e){var t;(t=this.camera)==null||t.correct()}addGlobalEventListeners(){addEventListener("resize",this.resizeEventListener(this)),addEventListener("copy",this.copyEventListener(this)),addEventListener("paste",this.pasteEventListener(this)),addEventListener("mousemove",this.mousemoveEventListener(this)),addEventListener("mouseup",this.mouseupEventListener(this))}removeGlobalEventListeners(){removeEventListener("resize",this.resizeEventListener(this)),removeEventListener("copy",this.copyEventListener(this)),removeEventListener("paste",this.pasteEventListener(this)),removeEventListener("mousemove",this.mousemoveEventListener(this)),removeEventListener("mouseup",this.mouseupEventListener(this))}async setup(e,t,r,o,i,n){var c,a;if(this.editor=e,this.listener=t,this.interactMenu=o,this.dashPlayer=i,this.runtimeHeader=n,this.canvas=r,this.camera.setProjectedCanvas(r),this.camera.correct(),t.addEventListener("wheel",u=>this.canvasWheel(u)),r.addEventListener("mousedown",u=>this.canvasMousedown(u)),r.addEventListener("drop",u=>this.mouseup(u)),r.addEventListener("dragover",u=>this.onDragover(u)),(c=r.parentElement)==null||c.addEventListener("keydown",u=>this.onKeydown(u)),(a=r.parentElement)==null||a.addEventListener("keyup",u=>this.onKeyup(u)),!r.getContext("2d"))throw new Error(`I can't get no context 2d ${r}`);this.canvasService=pe.create(r,this),this.addGlobalEventListeners(),ze(()=>{this.camera.fit(),this.render()})}tearDown(){this.removeGlobalEventListeners()}widgetsInRectangularSelection(){if(!this.camera)throw new Error("No camera value yet");if(this.dashPlayerService.state.type!=="RUNNING")return new Set;const{widgets:e}=this.calculatePositions(),t=this.selectionRect();return t?new Set(Object.keys(e).filter(r=>ds(this.camera.worldRect2screen(B(e[r].position,this.dashPlayerService.layoutGrid)),t))):new Set}calculatePositions(e){return this.dashPlayerService.state.type!=="RUNNING"?{widgets:{},slottables:{}}:this.dashPlayerService.calculatePositions(this.overloadCollapsedSlottablesCondition(this.dashPlayerService.state.props),e)}getInput(){switch(this.dashPlayerService.state.type){case"AUTHENTICATING":case"RUNNING":return{mouseState:this.mouseState,dashEditorService:this,workingLayout:this.layoutModel,hoverState:this.hoverState,resizeHandlerRects:this.getResizeHandlerRects(),widgetsInRectangularSelection:this.widgetsInRectangularSelection(),selectedWidgets:new Set(this.selection.selectedWidgetsIds),dash:this.dash,calculatedPositions:this.calculatePositions(),selectedSlottable:this.selection.selectedSlottableId};default:throw new Error(`Invalid state ${JSON.stringify(this.dashPlayerService.state.type)} for getInput`)}}getResizeHandlerRects(){if(!this.camera)throw new Error("No camera value yet");const e=this.getRectangularHull();return!e||!this.everySelectedWidgetInPreviewState()?[]:ko(this.selection.selectedWidgets,this.camera.worldRect2screen(e))}updateHoverStateOnToggle(e){const t=this.slottableRenderer.getToggleUnderCursor(e);t&&(this.hoverState={state:"HOVERING_TOGGLE",slottable:t.id})}updateHoverStateOnSlottableSelector(e){const t=this.slottableRenderer.getSelectorUnderCursor(e);t&&(this.hoverState={state:"HOVERING_SLOTTABLE_SELECTOR",slottableId:t.id})}updateHoverStateOnSlottableResizeHandler(e){const t=this.slottableRenderer.getResizerUnderCursor(e);t&&(this.hoverState={state:"HOVERING_SLOTTABLE_RESIZE_HANDLER",slottableId:t.id})}computeHoverState(e){!this.camera||(this.updateHoverStateOnWidget(e),this.updateHoverStateOnResizeHandler(e),this.updateHoverStateOnToggle(e),this.updateHoverStateOnSlottableSelector(e),this.updateHoverStateOnSlottableResizeHandler(e))}}const Ii={class:"dash-editor"},Pi=z({__name:"DashEditor",setup(s){const e=rs(),t=os(),r=({id:d,type:g})=>{g==="dash"?(e.push({name:"dashEditor",params:{dashId:d},query:t.query}),n()):e.push({name:"editor",params:{formId:d},query:t.query})},{loading:o,result:i,refetch:n}=ys(()=>Promise.all([Ss.get(),ws.get(t.params.dashPath)]).then(([d,g])=>is({workspace:d,dash:g,...u(d,g)}))),l=d=>{i.value&&(i.value.dashEditorService.isPreview=d)},c=d=>{var g;return(g=i.value)==null?void 0:g.dash.addVariableToCode(d)};function a(d,g){d.onRedirect(({url:f,queryParams:E})=>Ft("editor",e,f,E)),d.on("eval-return",f=>{f.repr&&g.log({type:"eval-output",log:f.repr})}),d.on("eval-error",f=>{g.log({type:"eval-output",log:f.repr})}),d.on("stderr",f=>{g.log({type:"stderr",log:f.log})}),d.on("stdout",f=>{g.log({type:"stdout",log:f.log})}),d.on("widgets-computed",f=>{var E;(E=f.errors)!=null&&E.general&&g.log({type:"stderr",log:f.errors.general.repr})}),d.on("program-start-failed",f=>{var E;g.log({type:"stderr",log:(E=f.error)!=null?E:""})})}function u(d,g){const f=hs(g.makeRunnerData(d)),E=Jt.create(),w=et.create(f,g,d);return a(f,E),{dashPlayerService:f,logService:E,dashEditorService:w}}function p(d){var g;(g=i.value)==null||g.dashPlayerService.sendEvalRequest(d)}const h=async()=>{!i.value||(i.value.dashEditorService.restart(),a(i.value.dashPlayerService,i.value.logService))};return(d,g)=>{var f,E,w;return y(),_("div",Ii,[R(o)||!((f=R(i))!=null&&f.dash)||!((E=R(i))!=null&&E.workspace)?(y(),X(us,{key:0,class:"loading",justify:"center"})):(y(),X(jt,{key:1},{left:re(()=>[L(_s,{link:"/_editor/dashes"})]),right:re(()=>[L(Is,{path:"dashes/overview"}),L(bs,{model:R(i).dash},null,8,["model"]),L(Es,{model:R(i).dash},null,8,["model"])]),default:re(()=>[L(tt,{title:"Layout editor"},{default:re(()=>{var O;return[(O=R(i))!=null&&O.dashPlayerService?(y(),X(fo,{key:0,workspace:R(i).workspace,dash:R(i).dash,"dash-editor-service":R(i).dashEditorService,params:R(t).query,onNavigate:r,onChangePreview:l,onCreateVariable:c},null,8,["workspace","dash","dash-editor-service","params"])):M("",!0)]}),_:1}),L(tt,{title:"Settings"},{default:re(()=>[L(Ns,{dash:R(i).dash},null,8,["dash"])]),_:1})]),_:1})),R(i)?(y(),X(Vt,{key:2,"log-service":R(i).logService,runtime:"dashes",onRestart:h,onEvalRequest:p},null,8,["log-service"])):M("",!0),L(Zt,{"has-changes":(w=R(i))==null?void 0:w.dash.hasChanges()},null,8,["has-changes"])])}}});const en=U(Pi,[["__scopeId","data-v-90133650"]]);export{en as default};
//# sourceMappingURL=DashEditor.e7f63341.js.map
