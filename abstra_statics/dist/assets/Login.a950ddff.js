import{L as C,O as R}from"./CircularLoading.6e4e89c9.js";import{d as L,f as B,o as v,K as y,a as f,b as t,ea as r,u as a,c as b,w as _,F as A,ef as o,bE as q,ee as D,cu as I,az as g,bM as h,ct as T,Q as x,eH as $,e3 as N,g as U,dA as V}from"./index.eb5bbacb.js";import{_ as K}from"./AbstraLogo.vue_vue_type_script_setup_true_lang.dc1a967d.js";import{T as S,A as z}from"./router.c0a4e348.js";import{i as F}from"./string.f7b672c0.js";import{a as k,E as M}from"./gateway.36e7a537.js";import{A as O}from"./index.13ce47dd.js";import"./Logo.8ca9a7e6.js";import"./Badge.887712fc.js";import"./popupNotifcation.3bb7ab8f.js";(function(){try{var l=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},s=new Error().stack;s&&(l._sentryDebugIds=l._sentryDebugIds||{},l._sentryDebugIds[s]="d120c0e7-0ef4-4552-9f15-4e0525c64e5a",l._sentryDebugIdIdentifier="sentry-dbid-d120c0e7-0ef4-4552-9f15-4e0525c64e5a")}catch{}})();const j={class:"form"},H={class:"header"},Q={class:"description"},G={class:"description"},J={class:"footer"},W={key:2,class:"loading"},X=L({__name:"Passwordless",emits:["done"],setup(l,{emit:s}){const e=B({stage:"collect-info",info:{email:""},token:"",invalid:!1,secsToAllowResend:0});function u(){const i=e.value.info.email,n=F(i);return e.value.invalid=!n,n}let d;const c=async()=>{if(!!u()){e.value.stage="loading";try{await k.authenticate(e.value.info.email),e.value.stage="collect-token",e.value.secsToAllowResend=120,clearInterval(d),d=setInterval(()=>{e.value.secsToAllowResend-=1,e.value.secsToAllowResend<=0&&clearInterval(d)},1e3)}catch{e.value.invalid=!0,e.value.stage="collect-info"}}},m=i=>{if(!i){e.value.info.email="";return}e.value.info.email=i.toLowerCase()},p=async()=>{var i;if(!!((i=e.value.info)!=null&&i.email)){e.value.stage="loading";try{const n=await k.verify(e.value.info.email,e.value.token);if(!n)throw new Error("[Passwordless] Login did not return an user");S.trackSession(),s("done",n),e.value.stage="done"}catch{e.value.invalid=!0,e.value.stage="collect-token"}}},E=()=>{e.value.info&&c()},P=()=>{e.value.stage="collect-info",e.value.info={email:""},e.value.token="",e.value.invalid=!1};return(i,n)=>(v(),y("div",j,[f("div",H,[t(K,{"hide-text":"",size:"large"}),f("h2",null,r(a(o).translate("i18n_auth_validate_your_email_login",null,{brandName:"Abstra"})),1)]),e.value.stage==="collect-info"?(v(),b(a(T),{key:0,class:"section"},{default:_(()=>[f("div",Q,r(a(o).translate("i18n_auth_info_description")),1),t(a(I),{"has-feedback":"","validate-status":e.value.invalid?"error":"",help:e.value.invalid?a(o).translate("i18n_auth_info_invalid_email"):""},{default:_(()=>[t(a(q),{type:"email",value:e.value.info.email,placeholder:a(o).translate("i18n_auth_enter_your_work_email"),onBlur:u,onKeyup:D(c,["enter"]),onChange:n[0]||(n[0]=w=>m(w.target.value))},null,8,["value","placeholder","onKeyup"])]),_:1},8,["validate-status","help"]),t(a(h),{type:"primary",onClick:c},{default:_(()=>[g(r(a(o).translate("i18n_auth_info_send_code")),1)]),_:1})]),_:1})):e.value.stage==="collect-token"?(v(),b(a(T),{key:1,class:"section"},{default:_(()=>[f("div",G,r(a(o).translate("i18n_auth_token_label",null,e.value.info)),1),t(a(I),{"has-feedback":"","validate-status":e.value.invalid?"error":""},{default:_(()=>[t(R,{value:e.value.token,"onUpdate:value":n[1]||(n[1]=w=>e.value.token=w),length:6,numeric:!0,size:"large",onCollectToken:p},null,8,["value"]),e.value.invalid?(v(),b(a(O),{key:0,message:a(o).translate("i18n_auth_token_invalid"),type:"error",style:{"margin-top":"24px"}},null,8,["message"])):A("",!0)]),_:1},8,["validate-status"]),t(a(h),{type:"primary",onClick:p},{default:_(()=>[g(r(a(o).translate("i18n_auth_token_verify_email")),1)]),_:1}),t(a(h),{onClick:P},{default:_(()=>[g(r(a(o).translate("i18n_auth_edit_email")),1)]),_:1}),t(a(h),{disabled:!!e.value.secsToAllowResend,onClick:E},{default:_(()=>[g(r(a(o).translate("i18n_auth_token_resend_email"))+" ("+r(e.value.secsToAllowResend)+" s) ",1)]),_:1},8,["disabled"]),f("div",J,r(a(o).translate("i18n_auth_token_footer_alternative_email")),1)]),_:1})):e.value.stage==="loading"?(v(),y("div",W,[t(C)])):A("",!0)]))}});const Y=x(X,[["__scopeId","data-v-35774a5f"]]),Z=async(l,s)=>{const e=k.getAuthor();if(!e)return{onboarded:!1};const{status:u}=await z.getInfo();if(u==="active")return{onboarded:!0};const d=new URLSearchParams({token:e.jwt,status:u,...l&&{redirect:l},...s&&{"prev-redirect":s}});return window.location.replace(`${M.onboarding}/setup?${d}`),{onboarded:!1}},ee={key:0,class:"login"},ae={key:1,class:"loading"},te=L({__name:"Login",setup(l){const s=$(),e=N();async function u(){const c=e.query.redirect,m=e.query["prev-redirect"],{onboarded:p}=await Z(c,m);!p||(c?await s.push({path:c,query:{...e.query,redirect:e.query["prev-redirect"],"prev-redirect":void 0}}):s.push({name:"home"}))}const d=U(()=>!k.getAuthor());return V(()=>{d.value||u()}),(c,m)=>d.value?(v(),y("div",ee,[t(Y,{onDone:u})])):(v(),y("div",ae,[t(C)]))}});const ve=x(te,[["__scopeId","data-v-d0df64e7"]]);export{ve as default};
//# sourceMappingURL=Login.a950ddff.js.map
