var $t=Object.defineProperty;var Gt=(s,e,t)=>e in s?$t(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var v=(s,e,t)=>(Gt(s,typeof e!="symbol"?e+"":e,t),t);import{r as Ht}from"./index.a757f6bb.js";import{T as Bt,a as st}from"./Tab.1738610f.js";import{r as k,d as z,b as y,c as E,x as w,W as fe,Z as pt,e as L,O as $e,Q as Ge,q as U,K as G,a2 as ce,ac as He,N as W,z as m,F as de,L as he,A as ue,D as M,v as gt,Y as ft,a as Ee,af as zt,G as ee,t as X,ae as Be,V as H,o as vt,al as Ut,E as Ft,am as jt,an as Kt,w as re,U as Vt,R as Zt,H as Jt,J as Qt,S as qt}from"./registerWidgets.08925b03.js";import{d as Yt,D as Xt,w as B,r as ze,i as Oe,a as es,v as ts,b as mt,p as rt,c as ss,m as rs}from"./DashPlayer.f4fe4ac0.js";import{R as os,S as is,_ as ns,L as as}from"./UnsavedChangesHandler.vue_vue_type_script_setup_true_lang.65003e11.js";import{L as ls}from"./CircularLoading.f7d06bfa.js";import{i as D,w as j,g as cs,s as ds,a as Q,b as C,c as me,f as oe,e as Ue,h as hs,j as us,k as ps}from"./runnerData.08bef8a6.js";import{p as gs,i as fs,x as Ie,y as Pe,z as vs,t as ms,A as ys}from"./icons.7d877907.js";import{a as ws}from"./asyncComputed.fdfb8cdb.js";import{D as Ss}from"./dashes.11baca41.js";import{W as Es}from"./workspaces.4a948e86.js";import{B as _s}from"./BackButton.793fdf19.js";import{S as bs}from"./SaveButton.b581708a.js";import{P as Is}from"./PreviewButton.073374ca.js";import{D as Ps}from"./DocsButton.33f7f9b6.js";import{u as _e}from"./uuid.b8bcda35.js";import{P as Fe}from"./pubsub.7723f722.js";import"./executeJs.47243443.js";import"./PlayerNavbar.69c3e338.js";import"./WidgetsFrame.eb09d539.js";import"./colors.6a512de1.js";import"./Modal.b942b0e2.js";import"./passwordlessManager.c2cb8449.js";import"./Passwordless.5b6366b4.js";import"./forms.fed50698.js";import"./activeRecord.030cb164.js";import"./hooks.ca034225.js";import"./jobs.204bede4.js";import"./login.d0976588.js";import"./lottie.028476ab.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[e]="ca960040-951c-4c56-afd7-111bfb0a76c3",s._sentryDebugIdIdentifier="sentry-dbid-ca960040-951c-4c56-afd7-111bfb0a76c3")}catch{}})();const T={left:20,right:20,top:20,bottom:200};class je{constructor(e){v(this,"_state");v(this,"_projectedElement",null);v(this,"grid");this.grid=e,this._state=k({x:0,y:0,zoom:1})}get x(){return this._state.value.x}set x(e){if(Number.isNaN(e))throw new Error("x is NaN");this._state.value.x=e}get y(){return this._state.value.y}set y(e){if(Number.isNaN(e))throw new Error("y is NaN");this._state.value.y=e}static create(e){return new je(e)}setProjectedCanvas(e){this._projectedElement=e,this.fit()}get projectedElement(){if(!this._projectedElement)throw new Error("Camera has no projected element");return this._projectedElement}updateGrid(e){this.grid=e}get zoom(){return this._state.value.zoom}set zoom(e){if(e<=0)throw new Error("Zoom must be positive");this._state.value.zoom=e}fit(){if(!this.grid.width)throw new Error(`Grid width is ${this.grid.width}}`);if(!this.grid.height)throw new Error(`Grid height is ${this.grid.height}`);const e=this.canvasRect,t=Math.max(e.width-T.left-T.right,1),r=Math.max(e.height-T.top-T.bottom,1);this.zoom=1;const o=Math.min(t/this.grid.width,r/this.grid.height);this.zoomIn(o,{x:e.x+e.width/2,y:e.y+e.height/2,referential:"screen"}),this.x=t>this.grid.width*o?-(e.x+e.width/2-o*this.grid.width/2)/o:-(e.x+T.left)/o,this.y=r<this.grid.height*o?-(e.y+T.top)/o:-(e.y+e.height/2-o*this.grid.height/2)/o}screenPoint2world(e){return{x:e.x/this.zoom+this.x,y:e.y/this.zoom+this.y,referential:"world"}}worldPoint2screen(e){return{x:(e.x-this.x)*this.zoom,y:(e.y-this.y)*this.zoom,referential:"screen"}}screenDelta2world(e){return{dx:e.dx/this.zoom,dy:e.dy/this.zoom,referential:"world"}}worldDelta2screen(e){return{dx:e.dx*this.zoom,dy:e.dy*this.zoom,referential:"screen"}}screenRect2world(e){const t=this.screenPoint2world({x:e.x,y:e.y,referential:e.referential}),r=this.screenPoint2world({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:r.x-t.x,height:r.y-t.y,referential:t.referential}}worldRect2screen(e){const t=this.worldPoint2screen({x:e.x,y:e.y,referential:e.referential}),r=this.worldPoint2screen({x:e.x+e.width,y:e.y+e.height,referential:e.referential});return{x:t.x,y:t.y,width:r.x-t.x,height:r.y-t.y,referential:t.referential}}zoomIn(e,t){const r=this.screenPoint2world(t);this.zoom*=e;const o=this.worldPoint2screen(r),i=Yt(t,o),n=this.screenDelta2world({dx:i.dx,dy:i.dy,referential:"screen"});this.x+=n.dx,this.y+=n.dy,this.correct()}translate(e,t=!0){this.x+=e.dx,this.y+=e.dy,t&&this.correct()}get canvasRect(){if(!this._projectedElement)throw new Error("No canvas element");const e=this._projectedElement.getBoundingClientRect();return{x:e.x,y:e.y,width:e.width,height:e.height,referential:"screen"}}correctZoom(){const e=this.canvasRect,t=Math.max(e.width-T.left-T.right,0),r=Math.max(e.height-T.top-T.bottom,0),o=Math.min(t/this.grid.width,r/this.grid.height);this.zoom<o&&(this.zoom=o)}correct(){this.correctZoom();const e=this.worldRect2screen({x:0,y:0,width:this.grid.width,height:this.grid.height,referential:"world"}),t=this.canvasRect,r=e.x>t.x+T.left,o=e.x+e.width<t.x+t.width-T.right,i=e.x+e.width/2-(t.x+t.width/2),n=e.width>t.width,l=e.height>t.height,c=e.y+e.height<t.y+t.height-T.bottom,a=e.y>t.y+T.top,u=e.y+e.height/2-(t.y+t.height/2),p=this.screenDelta2world({dx:n?o&&r?0:r?e.x-t.x-T.right:o?e.x+e.width-(t.x+t.width)+T.left:0:i,dy:l?c&&a?0:a?e.y-t.y-T.top:c?e.y+e.height-(t.y+t.height)+T.bottom:0:u,referential:"screen"});this.x+=p.dx,this.y+=p.dy}}const xs=s=>($e("data-v-fb3c93ab"),s=s(),Ge(),s),Rs={class:"dash-settings"},Ls={class:"dash-property"},Os=xs(()=>w("label",{class:"property-label"},"Name",-1)),Ns=z({__name:"DashSettings",props:{dash:null},setup(s){return(e,t)=>(y(),E("div",Rs,[w("div",Ls,[Os,fe(w("input",{"onUpdate:modelValue":t[0]||(t[0]=r=>s.dash.title=r),class:"property-input",placeholder:"Enter a name"},null,512),[[pt,s.dash.title]])]),L(os,{runtime:s.dash},null,8,["runtime"])]))}});const As=U(Ns,[["__scopeId","data-v-fb3c93ab"]]),Ts={class:"zoom-bar"},Cs={class:"zoom-value"},ks=z({__name:"ZoomBar",props:{camera:null},emits:["hover","leave"],setup(s,{emit:e}){const t=s,r=k(!1),o=k(null),i=()=>{var a;(a=t.camera)==null||a.zoomIn(1.1,{x:document.body.offsetWidth/2,y:document.body.offsetHeight/2,referential:"screen"})},n=()=>{var a;(a=t.camera)==null||a.zoomIn(.9,{x:document.body.offsetWidth/2,y:document.body.offsetHeight/2,referential:"screen"})},l=G(()=>{var c,a;return`${Math.floor(((a=(c=t.camera)==null?void 0:c.zoom)!=null?a:1)*100)}%`});return ce(()=>{var c;return(c=t.camera)==null?void 0:c.zoom},()=>{clearTimeout(o.value),r.value=!0,o.value=setTimeout(()=>r.value=!1,3e3)}),(c,a)=>fe((y(),E("div",{class:"zoom-bar-wrapper",onMouseover:a[0]||(a[0]=u=>e("hover")),onMouseleave:a[1]||(a[1]=u=>e("leave"))},[w("div",Ts,[w("span",{class:"zoom-control",onClick:n},"-"),w("span",Cs,W(m(l)),1),w("span",{class:"zoom-control",onClick:i},"+")])],544)),[[He,s.camera&&r.value]])}});const Ds=U(ks,[["__scopeId","data-v-f937a967"]]),ot={PandasDataFrame:"https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html",PlotlyFigure:"https://plotly.com/python-api-reference/generated/plotly.graph_objects.Figure.html","datetime.time":"https://docs.python.org/3/library/datetime.html#datetime.time","datetime.date":"https://docs.python.org/3/library/datetime.html#datetime.date","io.IOBase":"https://docs.python.org/3/library/io.html#io.IOBase","time.struct_time":"https://docs.python.org/3/library/time.html#time.struct_time"},Ws="#E286A3",Ms="#EF9542",$s="#B462DB",Gs="#40B6D3",Hs="#6FB96E",Bs=[Ws,Ms,$s,Gs,Hs];function it(s){let e=s;return Object.keys(ot).forEach(t=>{if(s.includes(t)){const r=ot[t];e=e.replace(t,`<a href="${r}" target="_blank">${t}</a>`)}}),e}const ie={},zs=s=>e=>{if(ie[e])return ie[e];const t=Object.keys(ie).length%s.length;return ie[e]=s[t],s[t]},nt=zs([...Bs]),Us=()=>{Object.keys(ie).forEach(s=>delete ie[s])};class Fs{constructor(){v(this,"globalEventListeners",[])}addGlobalEventListener(e,t){addEventListener(e,t),this.globalEventListeners.find(r=>r.evt===e)||this.globalEventListeners.push({evt:e,handler:t})}removeGlobalEventListeners(){this.globalEventListeners.forEach(({evt:e,handler:t})=>{removeEventListener(e,t)}),this.globalEventListeners=[]}}const js={class:"param-types"},Ks=["innerHTML"],Vs={key:1,class:"prop-type"},Zs=["innerHTML"],Js=z({__name:"ParamTypes",props:{param:null},setup(s){return(e,t)=>(y(),E("div",js,[s.param&&s.param.typeDescription?(y(!0),E(de,{key:0},he(s.param.typeDescription,r=>(y(),E("div",{key:r,class:"prop-type"},[w("p",{class:"type",style:ue({color:m(nt)(r)}),innerHTML:m(it)(r)},null,12,Ks)]))),128)):s.param&&s.param.typeName?(y(),E("div",Vs,[w("p",{class:"type",style:ue({color:m(nt)(s.param.typeName)}),innerHTML:m(it)(s.param.typeName)},null,12,Zs)])):M("",!0)]))}});const at=U(Js,[["__scopeId","data-v-d6aed39d"]]),Qs=["value","placeholder"],qs=["value","placeholder"],Ys=z({__name:"PythonPropInputRaw",props:{hasError:{type:Boolean},placeholder:null,value:null,paramName:null,isCode:{type:Boolean},commit:{type:Function}},emits:["input","change","clearSuggestions"],setup(s,{emit:e}){const t=s,r=gt({isActive:!1,hasChanges:!1}),o=c=>{e("input",c),r.hasChanges=!0},i=()=>{r.isActive=!1,e("clearSuggestions")},n=c=>{c.preventDefault();const a=c.target,u=a.selectionStart,p=a.selectionEnd,d=a.value;a.value=d.substring(0,u)+"	"+d.substring(p),a.selectionStart=a.selectionEnd=u+1,a.dispatchEvent(new Event("input"))},l=c=>{t.commit(c),r.hasChanges=!1};return ft(()=>{r.hasChanges&&t.commit(t.value)}),(c,a)=>{var p,d;const u=Ee("icon");return y(),E("div",{class:ee(["input-container",{error:s.hasError}])},[L(u,{path:m(gs),class:"icon",fill:s.hasError?"#D35249":r.isActive?"#3482E5":void 0},null,8,["path","fill"]),s.isCode?(y(),E("textarea",{key:0,value:s.value,class:"prop-input",placeholder:(p=s.placeholder)!=null?p:void 0,onInput:a[0]||(a[0]=h=>o(h.target.value)),onClick:a[1]||(a[1]=h=>r.isActive=!0),onBlur:i,onKeydown:a[2]||(a[2]=zt(h=>n(h),["tab"])),onChange:a[3]||(a[3]=h=>l(h.target.value))},null,40,Qs)):(y(),E("input",{key:1,value:s.value,class:"prop-input",placeholder:(d=s.placeholder)!=null?d:void 0,onInput:a[4]||(a[4]=h=>o(h.target.value)),onClick:a[5]||(a[5]=h=>r.isActive=!0),onBlur:i,onChange:a[6]||(a[6]=h=>l(h.target.value))},null,40,qs))],2)}}});const Xs=U(Ys,[["__scopeId","data-v-d30fa88e"]]),er={class:"suggestions"},tr=["onMousedown"],sr=z({__name:"PythonAutoCompleteSuggestions",props:{suggestions:null},emits:["select"],setup(s,{emit:e}){return(t,r)=>fe((y(),E("div",er,[(y(!0),E(de,null,he(s.suggestions,o=>(y(),E("div",{key:o,class:"suggestion",onMousedown:i=>e("select",o)},W(o),41,tr))),128))],512)),[[He,s.suggestions.length]])}});const rr=U(sr,[["__scopeId","data-v-afec000d"]]),or={class:"python-wrapper"},ir=z({__name:"PythonPropInput",props:{hasError:{type:Boolean},placeholder:null,value:null,paramName:null,dashPlayerService:null,isCode:{type:Boolean},commit:{type:Function}},emits:["input"],setup(s,{emit:e}){const t=s,r=G(()=>t.dashPlayerService.suggestionsFor),o=G(()=>t.dashPlayerService.suggestions),i=a=>{l(t.paramName,a),e("input",a)},n=a=>{c(),e("input",a),t.commit(a)},l=async(a,u)=>{!u||t.dashPlayerService.getAutocompleteSuggestions(a,u)},c=async()=>{await Be(),t.dashPlayerService.clearSuggestions()};return(a,u)=>(y(),E("div",or,[L(Xs,{value:s.value,commit:s.commit,"is-code":s.isCode,"param-name":s.paramName,"dash-player-service":s.dashPlayerService,onInput:i,onClearSuggestions:c},null,8,["value","commit","is-code","param-name","dash-player-service"]),m(r)===s.paramName?(y(),X(rr,{key:0,suggestions:m(o),onSelect:n},null,8,["suggestions"])):M("",!0)]))}});const xe=U(ir,[["__scopeId","data-v-63688ff1"]]),nr={name:"If Block",description:"A block of elements that is only rendered depending on a condition",params:[{typeName:"Boolean",argName:"condition",isKwarg:!1,default:null}],defaultEditProps:{condition:!0},thumbname:"IfBlock.svg"},ae={"if-block":nr},Z=s=>($e("data-v-718f02de"),s=s(),Ge(),s),ar={class:"wrapper"},lr={class:"title"},cr={key:0,class:"widget-prop"},dr=Z(()=>w("h2",null,"Error",-1)),hr=Z(()=>w("p",{class:"section-description"},"Some errors were found while computing the widget.",-1)),ur=["textContent"],pr={key:1,class:"section"},gr=Z(()=>w("h2",null,"VARIABLE",-1)),fr={key:0,class:"section-content"},vr={class:"widget-prop"},mr=Z(()=>w("p",{class:"prop-label"},"Bind a variable",-1)),yr=Z(()=>w("p",{class:"prop-description"},"Create a variable to be controlled by this widget.",-1)),wr={class:"input-container"},Sr={key:0,class:"variable-error prop-error"},Er=Z(()=>w("pre",null,"Variable not defined",-1)),_r={key:1,class:"prop-error",textContent:"SyntaxError: This field must be a variable name"},br=["textContent"],Ir={key:2,class:"section"},Pr=Z(()=>w("h2",null,"EVENTS",-1)),xr={key:0,class:"section-content"},Rr=Z(()=>w("p",{class:"section-description"}," Each event is a Python code that runs on specified situations ",-1)),Lr={class:"prop-label"},Or={class:"prop-description"},Nr={class:"section"},Ar=Z(()=>w("h2",null,"PROPERTIES",-1)),Tr={key:0,class:"section-content"},Cr=Z(()=>w("p",{class:"section-description"}," Each property is a Python expression, make sure to use the correct syntax. ",-1)),kr={class:"prop-label"},Dr={class:"prop-description"},Wr=["textContent"],Mr=Z(()=>w("div",{class:"feedback"},null,-1)),$r=[Mr],Gr=z({__name:"WidgetEditor",props:{selectedWidgetErrors:null,layoutModel:null,selectedWidgets:null,dashPlayerService:null},emits:["close","create-variable"],setup(s,{emit:e}){const t=s,r=k(null);ce(()=>t.selectedWidgetErrors,()=>{r.value=null});const o=S=>{f.openedSections.includes(S)?f.openedSections=f.openedSections.filter(b=>b!==S):f.openedSections.push(S)},i=S=>f.openedSections.includes(S),n=S=>D(S)?j[S.type].name:ae[S.type].name,l=G(()=>r.value===null?t.selectedWidgetErrors:r.value==="variable"?H.exports.omit(t.selectedWidgetErrors,"variable"):{...t.selectedWidgetErrors,props:H.exports.omit(t.selectedWidgetErrors.props,r.value)}),c=G(()=>a.value.type.includes("-input")&&a.value.type!=="click-input"),a=G(()=>t.selectedWidgets[0]),u=G(()=>{var I;if(!D(a.value))return;const b=((I=j[a.value.type].pythonAPI.params)!=null?I:[]).find(O=>O.argName==="initial_value");return b||null});function p(S){this.style.height="0",this.style.height=this.scrollHeight-24+"px"}const d=new Fs,h=k(null),g=402,f=gt({isActive:!1,resizing:!1,width:g,openedSections:["properties","variable"]});vt(()=>{h.value&&(d.addGlobalEventListener("mouseup",()=>f.resizing=!1),d.addGlobalEventListener("mousemove",I=>P(I))),document.querySelectorAll(".widget-props-editor textarea").forEach(I=>{!I||(I.setAttribute("style","height:"+(I.scrollHeight-24)+"px;overflow-y:hidden;"),I.addEventListener("input",p,!1))})}),Ut(()=>{Us(),d.removeGlobalEventListeners()});const P=S=>{f.resizing&&(f.width=Math.max(f.width-S.movementX,g))},_=G(()=>({width:`${f.width}px`})),x=S=>ae[S.type].params,q=G(()=>{const S=(O,F)=>O.argName===F.argName&&O.typeName===F.typeName,b=(O,F,R)=>R.findIndex(se=>S(O,se))===F,I=O=>!O.formOnly;return t.selectedWidgets.flatMap(O=>{var F;return D(O)?(F=j[O.type])==null?void 0:F.pythonAPI.params:x(O)}).filter(Boolean).filter(I).filter(b)}),tt=G(()=>{const S=(I,O)=>I.key===O.key,b=(I,O,F)=>F.findIndex(R=>S(I,R))===O;return t.selectedWidgets.flatMap(I=>{var O;return D(I)?(O=j[I.type])==null?void 0:O.events:[]}).filter(Boolean).filter(b).filter(I=>I.key!=="change")}),Lt=S=>{t.layoutModel.updateVariable(S,a.value.id),r.value="variable"},Ot=S=>b=>{t.layoutModel.updateProp({param:S,value:b},t.selectedWidgets.map(I=>I.id)),r.value=S.argName},Nt=S=>b=>{t.layoutModel.updateEvent({event:S,value:b},t.selectedWidgets.map(I=>I.id))},At=()=>{var S,b;return(b=(S=l.value.variable)==null?void 0:S.repr)==null?void 0:b.includes("SyntaxError")},Tt=()=>{var S,b;return(b=(S=l.value.variable)==null?void 0:S.repr)==null?void 0:b.includes("NameError")},Ct=S=>{!S||(t.dashPlayerService.sendVariableCreated(S),e("create-variable",S))},kt=()=>{var S,b;return((S=l.value.widget)==null?void 0:S.repr)&&!Object.values((b=l.value.props)!=null?b:{}).some(I=>I.repr)},Dt=()=>{var S;return(S=l.value.widget)==null?void 0:S.repr},be=S=>{var b,I;return(I=(b=l.value.props)==null?void 0:b[S])==null?void 0:I.repr},Wt=S=>H.exports.upperFirst(S.replace(/_/g," "));return(S,b)=>{var O,F;const I=Ee("icon");return y(),E("div",{class:"widget-props-editor",style:ue(m(_))},[w("div",ar,[w("div",lr,[w("h1",null,W(n(m(a))),1),L(I,{path:m(fs),fill:"#414A58",class:"close-icon",width:"16",height:"16",onClick:b[0]||(b[0]=R=>e("close"))},null,8,["path"])]),kt()?(y(),E("div",cr,[dr,hr,w("pre",{class:"prop-error",textContent:W(Dt())},null,8,ur)])):M("",!0),m(c)?(y(),E("div",pr,[w("div",{class:"section-header",onClick:b[1]||(b[1]=R=>o("variable"))},[L(I,{path:i("variable")?m(Ie):m(Pe),fill:"#414A58",class:"chevron-icon",width:"16",height:"16"},null,8,["path"]),gr]),i("variable")?(y(),E("div",fr,[w("div",vr,[mr,yr,w("div",wr,[L(xe,{placeholder:"variable_name","param-name":"variable","dash-player-service":s.dashPlayerService,value:(O=m(a).variable)!=null?O:"",commit:Lt,"is-code":!1,onInput:b[2]||(b[2]=R=>m(a).variable=R)},null,8,["dash-player-service","value"])]),Tt()&&m(a).variable?(y(),E("div",Sr,[Er,w("button",{onClick:b[3]||(b[3]=R=>Ct(m(a).variable))}," Create ")])):At()?(y(),E("pre",_r)):(F=m(l).variable)!=null&&F.repr?(y(),E("pre",{key:2,class:"prop-error",textContent:W(m(l).variable.repr)},null,8,br)):M("",!0),L(at,{param:m(u)},null,8,["param"])])])):M("",!0)])):M("",!0),m(tt).length?(y(),E("div",Ir,[w("div",{class:"section-header",onClick:b[4]||(b[4]=R=>o("events"))},[L(I,{path:i("events")?m(Ie):m(Pe),fill:"#414A58",class:"chevron-icon",width:"16",height:"16"},null,8,["path"]),Pr]),i("events")?(y(),E("div",xr,[Rr,(y(!0),E(de,null,he(m(tt),R=>(y(),E("div",{key:R.key,class:"widget-prop"},[w("label",Lr,"On "+W(R.key),1),w("p",Or,"Executed after "+W(R.key),1),L(xe,{"param-name":R.key,"dash-player-service":s.dashPlayerService,value:m(a).events[R.key],commit:Nt(R),"is-code":!0,onInput:se=>m(a).events[R.key]=se},null,8,["param-name","dash-player-service","value","commit","onInput"])]))),128))])):M("",!0)])):M("",!0),w("div",Nr,[w("div",{class:"section-header",onClick:b[5]||(b[5]=R=>o("properties"))},[L(I,{path:i("properties")?m(Ie):m(Pe),fill:"#414A58",class:"chevron-icon",width:"16",height:"16"},null,8,["path"]),Ar]),i("properties")?(y(),E("div",Tr,[Cr,(y(!0),E(de,null,he(m(q),R=>{var se;return y(),E("div",{key:R.argName,class:"widget-prop"},[w("p",kr,W(Wt(R.argName)),1),w("p",Dr,W(R.description),1),L(xe,{"has-error":!!be(R.argName),placeholder:(se=R.default)!=null?se:void 0,"param-name":R.argName,"dash-player-service":s.dashPlayerService,value:m(a).props[R.argName],commit:Ot(R),"is-code":!0,onInput:Mt=>m(a).props[R.argName]=Mt},null,8,["has-error","placeholder","param-name","dash-player-service","value","commit","onInput"]),be(R.argName)?(y(),E("pre",{key:0,class:"prop-error",textContent:W(be(R.argName))},null,8,Wr)):M("",!0),L(at,{param:R},null,8,["param"])])}),128))])):M("",!0)])]),w("div",{ref_key:"handlerRef",ref:h,class:"handler",onMousedown:b[6]||(b[6]=Ft(R=>f.resizing=!0,["stop"]))},$r,544)],4)}}});const Hr=U(Gr,[["__scopeId","data-v-718f02de"]]),yt=s=>($e("data-v-0d595f79"),s=s(),Ge(),s),Br={class:"interact-menu"},zr={class:"icon-container"},Ur=yt(()=>w("span",{class:"edit"},"Edit [Shift + P]",-1)),Fr={class:"icon-container"},jr=yt(()=>w("span",null,"Interact [Shift + P]",-1)),Kr=z({__name:"InteractMenu",props:{isPreview:{type:Boolean}},emits:["changePreview"],setup(s,{emit:e}){return(t,r)=>{const o=Ee("icon");return y(),E("div",Br,[w("div",zr,[L(o,{class:ee(["icon",{active:!s.isPreview}]),path:m(vs),fill:"#5A677A",onClick:r[0]||(r[0]=i=>e("changePreview",!1))},null,8,["class","path"]),Ur]),w("div",Fr,[L(o,{class:ee(["icon",{active:s.isPreview}]),path:m(ms),fill:"#5A677A",onClick:r[1]||(r[1]=i=>e("changePreview",!0))},null,8,["class","path"]),jr])])}}});const Vr=U(Kr,[["__scopeId","data-v-0d595f79"]]),Zr={class:"header"},Jr={key:0},Qr={key:1},qr={key:2,class:"state"},Yr={key:3,class:"state"},Xr={key:4,class:"state"},eo={key:5},to={key:6},so=z({__name:"RuntimeHeader",props:{dash:null,dashPlayerService:null},setup(s){return(e,t)=>(y(),E("div",Zr,[s.dash.title?(y(),E("p",Jr,W(s.dash.title),1)):(y(),E("p",Qr,W(s.dash.path),1)),s.dashPlayerService.state.type==="RUNNING"?(y(),E("p",qr,"\u{1F7E2} running")):s.dashPlayerService.state.type==="ERROR"?(y(),E("p",Yr,"\u274C error")):s.dashPlayerService.state.type==="AUTHENTICATING"?(y(),E("p",Xr," \u{1F510} authenticating ")):s.dashPlayerService.state.type==="IDLE"?(y(),E("p",eo,"\u26AA\uFE0F idle")):s.dashPlayerService.state.type==="READY"?(y(),E("p",to,"\u23F3 loading")):M("",!0)]))}});const ro=U(so,[["__scopeId","data-v-b5964f37"]]),oo={key:0,class:"widget-metadata-card"},io=["src"],no={class:"metadata-title"},ao={class:"metadata-description"},lo={key:1,class:"collapsed-widget-metadata-card"},co=["src"],ho=z({__name:"WidgetMetadataCard",props:{metadata:null,collapsed:{type:Boolean}},setup(s){const e=window.__baseURL?`${window.__baseURL}/media`:"",t=o=>o in ae?`${e}/${ae[o].thumbname}`:`${e}/widget-thumbs/${cs(o)}.svg`,r=window.__vscodeTheme===2?"dark":"light";return(o,i)=>s.collapsed?(y(),E("div",lo,[w("img",{class:"metadata-thumbnail",src:t(s.metadata.type),style:ue(m(r)==="dark"?{filter:"invert(1)"}:"")},null,12,co)])):(y(),E("div",oo,[w("img",{class:"metadata-thumbnail",src:t(s.metadata.type),style:ue(m(r)==="dark"?{filter:"invert(1)"}:"")},null,12,io),w("div",no,W(s.metadata.name),1),w("div",ao,W(s.metadata.description),1)]))}});const uo=U(ho,[["__scopeId","data-v-2b654c57"]]),ve={"click-input":-1,"text-output":0,"number-input":1,"text-input":2,"link-output":3,"multiple-choice-input":4,"file-input":5,"email-input":6,"markdown-output":7,"dropdown-input":8,"date-input":9,"cards-input":10,"textarea-input":11,"list-input":12,"file-output":13,"html-output":14,"pandas-output":15,"checkbox-input":16,"cnpj-input":17,"code-input":18,"progress-output":19,"pandas-row-selection-input":20,"image-input":21,"password-input":22,"currency-input":23,"iframe-output":24,"checklist-input":25,"image-output":26,"nps-input":27,"phone-input":28},po=z({__name:"WidgetsMetadataList",emits:["dragstart","hover","leave"],setup(s,{emit:e}){const t=k(""),r=k(),o=k(!0),i=()=>{o.value=!1},n=()=>{o.value=!0,c()},l=async()=>{await Be(),r.value&&r.value.focus()},c=()=>{t.value=""},a=Object.values(j).concat(Object.entries(ae).map(([d,h])=>({type:d,...h}))).reduce((d,h)=>h.formOnly?d:{...d,[h.type]:h},{}),u=G(()=>t.value?Object.values(a).map(d=>({widget:d,score:ds(d,t.value.split(" "))})).filter(({score:d})=>d>0).sort(({score:d},{score:h})=>h-d).map(({widget:d})=>d):Object.values(a).sort((d,h)=>{const g=d.type,f=h.type;if(g in ve){if(!(f in ve))return-1}else return 1;return ve[g]-ve[f]}));function p(d,h){e("dragstart",d,h)}return(d,h)=>{const g=Ee("icon");return y(),E("div",{class:"widgets-metadata",onMouseover:i,onMouseleave:n},[w("div",jt({class:["search",{collapsed:o.value}]},Kt(o.value?{click:l}:{},!0)),[L(g,{path:m(ys),class:"search-icon"},null,8,["path"]),o.value?M("",!0):fe((y(),E("input",{key:0,ref_key:"searchInput",ref:r,"onUpdate:modelValue":h[0]||(h[0]=f=>t.value=f),type:"search",class:"widgets-metadata-filter",placeholder:"Find widgets"},null,512)),[[pt,t.value]])],16),w("div",{class:ee(["widgets-metadata-list",{collapsed:o.value}])},[(y(!0),E(de,null,he(m(u),f=>(y(),X(uo,{key:f.type,metadata:f,draggable:!0,collapsed:o.value,onDragstart:P=>p(P,f.type)},{default:re(()=>[Vt(W(f.type),1)]),_:2},1032,["metadata","collapsed","onDragstart"]))),128))],2)],32)}}});const go=U(po,[["__scopeId","data-v-a17e6382"]]),fo={class:"dash-layout-editor"},vo=z({__name:"DashLayoutEditor",props:{dash:null,params:null,dashEditorService:null,workspace:null},emits:["navigate","create-variable","change-preview"],setup(s,{emit:e}){const t=s;console.log(t);const r=k(null),o=k(null),i=(_,x)=>t.dashEditorService.metadataDragStart(_,x),n=_=>e("navigate",_),l=_=>e("create-variable",_),c=_=>e("change-preview",_);t.dashEditorService.pubsub.subscribe("change-preview",c);const a=()=>{t.dashEditorService.hoverZoomBar()},u=()=>{t.dashEditorService.leaveZoomBar()};ce(t.dash.layout,()=>{t.dashEditorService.layoutModel.setLayout(t.dash.layout)}),t.dashEditorService.setupOnSave(),ce(t.dashEditorService.layoutModel,()=>t.dashEditorService.setupOnSave());const p=G(()=>t.dashEditorService.getWidgetsWithErrors()),d=G(()=>t.dashEditorService.getSelectedWidgetErrors()),h=k(null),g=k(null),f=k(null),P=k(null);return vt(()=>{t.dashEditorService.selection.setLayoutModel(t.dashEditorService.layoutModel),f.value&&P.value&&g.value&&o.value&&r.value&&h.value&&t.dashEditorService.setup(f.value,P.value,g.value,o.value,r.value,h.value)}),ft(()=>{t.dashEditorService.tearDown()}),ce(()=>t.dashEditorService.dashPlayerService.isAuthenticating(),_=>{_&&(t.dashEditorService.isPreview=!0)}),(_,x)=>(y(),E("div",fo,[fe(L(go,{onDragstart:i},null,512),[[He,!s.dashEditorService.isPreview]]),w("div",{ref_key:"editor",ref:f,class:ee(["editor"])},[w("div",{ref_key:"listeners",ref:P,class:"listeners",tabindex:"0"},[L(Xt,{ref_key:"player",ref:r,class:ee(["player",{preview:s.dashEditorService.isPreview}]),style:{top:0,left:0,height:"unset"},"is-preview":!0,params:s.params,camera:s.dashEditorService.camera,"editing-mode":!s.dashEditorService.isPreview,"force-responsivity":"desktop","widgets-with-errors":m(p),"dash-player-service":s.dashEditorService.dashPlayerService,onNavigate:n},null,8,["class","params","camera","editing-mode","widgets-with-errors","dash-player-service"]),w("canvas",{ref_key:"canvas",ref:g,class:ee(["layout-canvas",{hide:s.dashEditorService.isPreview}])},null,2)],512),L(ro,{ref_key:"runtimeHeader",ref:h,dash:s.dash,"dash-player-service":s.dashEditorService.dashPlayerService},null,8,["dash","dash-player-service"]),L(Vr,{ref_key:"interactMenu",ref:o,class:"interact-menu","is-preview":s.dashEditorService.isPreview,onChangePreview:c},null,8,["is-preview"])],512),(s.dashEditorService.selection.selectedWidgetsIds.length>0||s.dashEditorService.selection.selectedSlottableId)&&!s.dashEditorService.isPreview&&s.dashEditorService.mouseState.state==="IDLE"?(y(),X(Hr,{key:0,"selected-widget-errors":m(d),"layout-model":s.dashEditorService.layoutModel,"selected-widgets":s.dashEditorService.selection.selectedSlottable?[s.dashEditorService.selection.selectedSlottable]:s.dashEditorService.selection.selectedWidgets,"dash-player-service":s.dashEditorService.dashPlayerService,onClose:x[0]||(x[0]=q=>s.dashEditorService.selection.resetSelection()),onCreateVariable:l},null,8,["selected-widget-errors","layout-model","selected-widgets","dash-player-service"])):M("",!0),L(Ds,{camera:s.dashEditorService.camera,class:"zoom-bar",onHover:a,onLeave:u},null,8,["camera"])]))}});const mo=U(vo,[["__scopeId","data-v-7661d381"]]),yo="rgba(0, 128, 233, 0.05)";class pe{constructor(e,t){v(this,"context");this.canvas=e,this.context=this.canvas.getContext("2d"),t.slottableRenderer.setContext(this.context)}static create(e,t){return new pe(e,t)}render({mouseState:e,dashEditorService:t,hoverState:r,resizeHandlerRects:o,widgetsInRectangularSelection:i,selectedWidgets:n,computedState:l,isPreview:c,calculatedPositions:a,selectedSlottable:u}){const p=t.camera,d=t.dashPlayerService.layoutGrid,h=t.dashPlayerService.calculatePositions();if(t.dashPlayerService.state.type==="RUNNING"){if(!p)throw new Error("No camera value yet");this.renderFrame(d,p),this.renderGrid(d,p,e),this.renderWidgetShadow(l,d,p,a.widgets),this.renderInvisibleWidgets(p,a,d,h),this.renderWidgetHoverBorders(r,e,p,d,a.widgets),this.renderSelectionHull(e,p,d,n,a.widgets),this.renderWidgetsSelectionBorders(e,n,p,d,a.widgets),this.renderRectangularSelection(e),this.renderRectangularSelectionHovers(e,i,p,d,a.widgets),this.renderResizeHandlers(e,o),c||(t.slottableRenderer.slottables=a.slottables,t.slottableRenderer.renderSlottables(u))}}renderFrame(e,t){const r={x:0,y:0,width:e.width,height:e.height+e.navbarLength,referential:"world"};this.context.fillStyle="transparent",this.context.shadowColor="rgba(0,0,0,0.1)",this.context.shadowBlur=15;const o=t.worldRect2screen(r);this.context.fillRect(o.x,o.y,o.width,o.height),this.context.clearRect(o.x,o.y,o.width,o.height)}getGridDots(e,t){var u;const r=[];if(!e)return[];const o=t.worldPoint2screen({y:0,x:0,referential:"world"}),i=(u=t.projectedElement)==null?void 0:u.getBoundingClientRect(),n=e.margin*t.zoom,l=e.gap*t.zoom,c=e.cellHeight*t.zoom,a=(i.y+i.height-o.y-n)/(c+l);for(const p in Array(e.columns+1).fill(null))for(const d in Array(Math.ceil(a+1)).fill(null))r.push(t.worldPoint2screen({x:e.margin+parseInt(p)*(e.cellWidth+e.gap),y:e.margin+parseInt(d)*(e.cellHeight+e.gap)+e.navbarLength,referential:"world"}));return r}renderGrid(e,t,r){if(r.state==="MOVING"||r.state==="RESIZING"||r.state==="SLOTTABLE_RESIZING"||r.state==="MOVING_SLOTTABLE"||r.state==="DRAGGING_SLOTTABLE"||r.state==="DRAGGING"){this.context.fillStyle="rgba(0,0,0,0.1)";for(const o of this.getGridDots(e,t))this.context.beginPath(),this.context.ellipse(o.x,o.y,2,2,0,0,2*Math.PI),this.context.fill()}}renderWidgetShadow(e,t,r,o){this.context.fillStyle="rgba(0, 0, 0, 0.1)";for(const i in o){if(!e.operations.some(c=>c.path.includes(i)))continue;const n=o[i],l=r.worldRect2screen(B(n.position,t));this.context.fillRect(l.x,l.y,l.width,l.height)}}renderInvisibleWidgets(e,t,r,o){const n=t.widgets;for(const l in n){if(l in o.widgets)continue;const c=n[l],a=B(c.position,r),u={x:a.x+5,y:a.y+5,width:a.width-2*5,height:a.height-2*5,referential:"world"},p=e.worldRect2screen(u);this.context.fillStyle="rgba(0, 0, 0, 0.1)",this.context.fillRect(p.x,p.y,p.width,p.height),this.context.fillStyle="black",this.context.font="15px sans-serif",this.context.textAlign="center",this.context.textBaseline="middle",this.context.fillText(j[c.type].name,p.x+p.width/2,p.y+p.height/2)}}renderWidgetHoverBorders(e,t,r,o,i){if(this.context.strokeStyle="#ababab",e.state==="HOVERING_WIDGET"&&t.state==="IDLE"){const n=i[e.widgetId];if(!n)return;const l=r.worldRect2screen(B(n.position,o));this.context.strokeRect(l.x,l.y,l.width,l.height)}else(t.state==="MOVING"||t.state==="RESIZING"||t.state==="DRAGGING"||t.state==="SELECTING")&&Object.keys(i).forEach(n=>{const l=i[n],c=r.worldRect2screen(B(l.position,o));this.context.strokeRect(c.x,c.y,c.width,c.height)})}renderWidgetsSelectionBorders(e,t,r,o,i){if(e.state==="IDLE"||e.state==="SELECTING"){this.context.strokeStyle="#3482E5",this.context.lineWidth=2;for(const n of t){const l=i[n],c=r.worldRect2screen(B(l.position,o));this.context.strokeRect(c.x,c.y,c.width,c.height)}}}renderRectangularSelection(e){if(this.context.fillStyle=yo,e.state==="SELECTING"){const t=Math.min(e.initialMousePos.x,e.mousePos.x),r=Math.min(e.initialMousePos.y,e.mousePos.y),o=Math.abs(e.initialMousePos.x-e.mousePos.x),i=Math.abs(e.initialMousePos.y-e.mousePos.y),n={x:t,y:r,width:o,height:i};this.context.fillRect(n.x,n.y,o,i)}}renderRectangularSelectionHovers(e,t,r,o,i){if(this.context.strokeStyle="#3482E5",e.state==="SELECTING")for(const n of t){const l=i[n],c=r.worldRect2screen(B(l.position,o));this.context.strokeRect(c.x,c.y,c.width,c.height)}}renderSelectionHull(e,t,r,o,i){const n=ze(Object.entries(i).filter(([c])=>o.has(c)).map(([c,a])=>B(a.position,r)).filter(c=>c!==null));if(e.state!=="IDLE"||!n)return;this.context.strokeStyle="#3482E5";const l=t.worldRect2screen(n);this.context.strokeRect(l.x,l.y,l.width,l.height)}static drawResizeHandler(e,t){e.fillStyle="white",e.strokeStyle="#3482E5",e.lineWidth=1,e.fillRect(t.x,t.y,t.width,t.height),e.strokeRect(t.x,t.y,t.width,t.height)}renderResizeHandlers(e,t){if(e.state!=="MOVING")for(const{rect:r}of t)pe.drawResizeHandler(this.context,r)}cursor(e,t){if(e.state==="MOVING")return"grabbing";if(e.state==="SELECTING")return"crosshair";if(e.state==="RESIZING")switch(e.side){case"bottom":case"top":return"ns-resize";case"left":case"right":return"ew-resize"}else{if(e.state==="START_PANNING")return"grab";if(e.state==="PANNING")return"grabbing";if(e.state==="JUST_CLICKED_TOGGLE")return"grabbing";if(t.state==="HOVERING_WIDGET")return"grab";if(t.state==="HOVERING_RESIZE_HANDLER")switch(t.side){case"bottom":case"top":return"ns-resize";case"left":case"right":return"ew-resize";case"top-left":case"bottom-right":return"nwse-resize";case"top-right":case"bottom-left":return"nesw-resize"}else return t.state==="HOVERING_TOGGLE"?"pointer":t.state==="HOVERING_SLOTTABLE_RESIZE_HANDLER"?"ns-resize":t.state==="HOVERING_SLOTTABLE_SELECTOR"?"pointer":"default"}}}const Ne=()=>document.body.classList.contains("vscode-dark"),Ae=window.__baseURL?`${window.__baseURL}/media`:"",wo=(s,e,t,r,o,i)=>{let n=[];return wt(e)||(i||(n=n.concat(bo(s,t,r,o))),i&&(n=n.concat(So(s,t,r,o)).concat(Eo(s,t,r,o)))),n.concat(Io(s,t,r,e,o)).concat(xo(s,t,r,o))},wt=s=>{var e;return!((e=s.condition)==null||e)},So=(s,e,t,r)=>{const{row:o,height:i}=s.position,{x:n,y:l,height:c,width:a}=e.getCell(0,o),u=i*c,p=a*e.columns,d={x:n,y:l,width:p,height:u,referential:"world"},h=3,g=2,f=t.worldRect2screen(d);return r.strokeStyle="#3482E5",r.lineWidth=g,r.strokeRect(f.x+h,f.y,f.width-2*h,f.height),[]},Eo=(s,e,t,r)=>{const o=_o(s,e,t);return pe.drawResizeHandler(r,o),[{type:"resizer",position:o,elementId:s.id}]},_o=(s,e,t)=>{const{row:i,height:n}=s.position,{x:l,y:c,height:a,width:u}=e.getCell(0,i),p=n*a,d=u*e.columns,h=t.worldRect2screen({x:l,y:c,width:d,height:p,referential:"world"});return{x:h.x+h.width/2-20/2,y:h.y+h.height-6/2,width:20,height:6,referential:"screen"}},bo=(s,e,t,r)=>{const{row:o,height:i}=s.position,{x:n,y:l,height:c,width:a}=e.getCell(0,o),u=i*c,p=a*e.columns,d={x:n,y:l,width:p,height:u,referential:"world"},h=4,g=3,f=2,P=t.worldRect2screen(d);return r.strokeStyle="rgb(39, 67, 255, 0.13)",r.lineWidth=f,r.beginPath(),r.roundRect(P.x+g,P.y,P.width-2*g,P.height,h),r.stroke(),[]},Io=(s,e,t,r,o)=>{const{row:i,height:n}=s.position,l=Po(i,n,e,t),c=new Image(l.width,l.height);return c.src=wt(r)?`${Ae}/chevron-down-${Ne()?"dark":"light"}.svg`:`${Ae}/chevron-up-${Ne()?"dark":"light"}.svg`,c.style.viewBox=`0 0 ${l.width} ${l.height}`,o.drawImage(c,l.x,l.y,l.width,l.height),[{type:"toggle",position:l,elementId:s.id}]},Po=(s,e,t,r)=>{const{y:o}=t.getCell(0,e),i=24,n=24,l={x:-30,y:o+t.cellHeight*s-n,width:i,height:n,referential:"world"};return r.worldRect2screen(l)},xo=(s,e,t,r)=>{const{row:o}=s.position,i=Ro(o,e,t),n=new Image(i.width,i.height);return n.src=`${Ae}/drag-${Ne()?"dark":"light"}.svg`,r.drawImage(n,i.x,i.y,i.width,i.height),[{type:"selector",position:i,elementId:s.id}]},Ro=(s,e,t)=>{const{y:r}=e.getCell(0,s),o={x:-30,y:r,width:24,height:24,referential:"world"};return t.worldRect2screen(o)},Lo={"if-block":wo};class Ke{constructor(e,t){v(this,"context",null);v(this,"_slottables",[]);v(this,"selectableElements",[]);v(this,"getSlottableRenderedElement",(e,t)=>{var r;return(r=this.selectableElements.find(o=>o.elementId===e&&o.type===t))!=null?r:null});v(this,"getRenderedElementUnderCursor",(e,t)=>this._slottables.find(r=>{var i,n;const o=(n=(i=this.getSlottableRenderedElement(r.id,e))==null?void 0:i.position)!=null?n:null;return o?Oe(t,o):!1})||null);v(this,"getSelectorUnderCursor",e=>this.getRenderedElementUnderCursor("selector",e));v(this,"getToggleUnderCursor",e=>this.getRenderedElementUnderCursor("toggle",e));v(this,"getResizerUnderCursor",e=>this.getRenderedElementUnderCursor("resizer",e));this.layoutGrid=e,this.camera=t}static create(e,t){return new Ke(e,t)}setContext(e){this.context=e}set slottables(e){if(!this.context)throw new Error("No context set yet");this._slottables=Object.values(e)}renderSlottables(e){if(this.selectableElements=[],this._slottables.length!==0)for(const t of this._slottables)this.selectableElements=this.selectableElements.concat(this.renderSlottable(t,e===t.id))}renderSlottable(e,t){return Lo[e.type](e,e.props,this.layoutGrid,this.camera,this.context,t)}}const Oo=s=>e=>e[s],No=s=>[...new Set(s)];class Ve{constructor(){v(this,"_selectedWidgetsIds");v(this,"_selectedSlottableId");v(this,"layoutModel");this.layoutModel=null,this._selectedSlottableId=k(null),this._selectedWidgetsIds=k([])}static create(){return new Ve}setLayoutModel(e){this.layoutModel=e}get selectedWidgetsIds(){return this._selectedWidgetsIds.value}set selectedWidgetsIds(e){e.length!==0&&this.resetSelection(),this._selectedWidgetsIds.value=No(e)}get selectedWidgetId(){return this.selectedWidgetsIds[0]}get selectedWidget(){return this.layoutModel&&this.selectedWidgetId?this.layoutModel.getWidget(this.selectedWidgetId):null}get selectedWidgets(){return this.layoutModel?this.selectedWidgetsIds.map(e=>this.layoutModel.getWidget(e)):[]}addWidget(e){this.selectedWidgetsIds=[...this.selectedWidgetsIds,e]}addToSelectedWidgets(e){if(!this.layoutModel)return;const t=this.layoutModel.getWidgetOrSlottable(e);(!D(t)||this.selectedWidget&&!D(this.selectedWidget))&&this.clearWidgetSelection(),this.addWidget(e)}toggleWidgetSelection(e){this.selectedWidgetsIds.includes(e)?this.removeWidget(e):this.addWidget(e)}removeWidget(e){this.selectedWidgetsIds=this.selectedWidgetsIds.filter(t=>t!==e)}clearWidgetSelection(){this.selectedWidgetsIds=[]}selectAll(){!this.layoutModel||(this.selectedWidgetsIds=Object.keys(this.layoutModel.allWidgets))}get selectedSlottableId(){return this._selectedSlottableId.value}set selectedSlottableId(e){e&&this.resetSelection(),this._selectedSlottableId.value=e}get selectedSlottable(){return this.layoutModel&&this.selectedSlottableId?this.layoutModel.getSlottable(this.selectedSlottableId):null}has(e){return this.selectedWidgetsIds.includes(e)}resetSelection(){this.clearWidgetSelection(),this.selectedSlottableId=null}}class Ze{static get isMac(){return navigator.userAgent.includes("Mac OS X")}static get buildPlatform(){return{}.CURRENT_PLATFORM||"web"}}const Ao=s=>Ze.isMac&&s.ctrlKey,le=s=>Ze.isMac?s.metaKey:s.ctrlKey,Te=s=>s.altKey,J=s=>s.shiftKey,Re={alt:Te,"arrow-up":s=>s.code==="ArrowUp","arrow-down":s=>s.code==="ArrowDown","arrow-left":s=>s.code==="ArrowLeft","arrow-right":s=>s.code==="ArrowRight",ctrl:le,delete:s=>Ze.isMac?s.code==="Backspace":s.code==="Delete",enter:s=>s.code==="Enter",escape:s=>s.code==="Escape",shift:J,space:s=>s.code==="Space",a:s=>s.code==="KeyA",b:s=>s.code==="KeyB",c:s=>s.code==="KeyC",d:s=>s.code==="KeyD",f:s=>s.code==="KeyF",g:s=>s.code==="KeyG",h:s=>s.code==="KeyH",k:s=>s.code==="KeyK",p:s=>s.code==="KeyP",v:s=>s.code==="KeyV",x:s=>s.code==="KeyX",z:s=>s.code==="KeyZ",0:s=>s.code==="Digit0","[":s=>s.code==="BracketLeft","]":s=>s.code==="BracketRight"};class To{constructor(e){v(this,"pressedKeys");v(this,"evt");this.evt=e,this.pressedKeys={};const t=r=>o=>{Object.keys(Re).forEach(i=>{Re[i](o)&&this.setPressed(i,r)})};this.evt||(window.addEventListener("keydown",t(!0)),window.addEventListener("keyup",t(!1)))}setPressed(e,t){this.pressedKeys[e]=t}isPressed(e){var t;return this.evt?Re[e](this.evt):(t=this.pressedKeys[e])!=null?t:!1}}const Co=new To,ko=s=>e=>H.exports.uniq(s.map(Oo(e))).length===1,Do=s=>s.some(e=>j[e.type].autoHeight);function Wo(s,e){const t=ko(s),r=Do(s),o=[],i=16,n=6;return t("colStart")&&o.push({rect:{x:e.x-n/2,y:e.y+e.height/2-i/2,width:n,height:i,referential:"screen"},side:"left"}),t("colEnd")&&o.push({rect:{x:e.x+e.width-n/2,y:e.y+e.height/2-i/2,width:n,height:i,referential:"screen"},side:"right"}),t("colStart")&&t("rowStart")&&!r&&o.push({rect:{x:e.x-n/2,y:e.y-n/2,width:n,height:n,referential:"screen"},side:"top-left"}),t("colEnd")&&t("rowStart")&&!r&&o.push({rect:{x:e.x+e.width-n/2,y:e.y-n/2,width:n,height:n,referential:"screen"},side:"top-right"}),t("colStart")&&t("rowEnd")&&!r&&o.push({rect:{x:e.x-n/2,y:e.y+e.height-n/2,width:n,height:n,referential:"screen"},side:"bottom-left"}),t("colEnd")&&t("rowEnd")&&!r&&o.push({rect:{x:e.x+e.width-n/2,y:e.y+e.height-n/2,width:n,height:n,referential:"screen"},side:"bottom-right"}),t("rowStart")&&!r&&o.push({rect:{x:e.x+e.width/2-i/2,y:e.y-n/2,width:i,height:n,referential:"screen"},side:"top"}),t("rowEnd")&&!r&&o.push({rect:{x:e.x+e.width/2-i/2,y:e.y+e.height-n/2,width:i,height:n,referential:"screen"},side:"bottom"}),o}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */var Mo=globalThis&&globalThis.__extends||function(){var s=function(e,t){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,o){r.__proto__=o}||function(r,o){for(var i in o)o.hasOwnProperty(i)&&(r[i]=o[i])},s(e,t)};return function(e,t){s(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}}(),$o=Object.prototype.hasOwnProperty;function Ce(s,e){return $o.call(s,e)}function ke(s){if(Array.isArray(s)){for(var e=new Array(s.length),t=0;t<e.length;t++)e[t]=""+t;return e}if(Object.keys)return Object.keys(s);var r=[];for(var o in s)Ce(s,o)&&r.push(o);return r}function $(s){switch(typeof s){case"object":return JSON.parse(JSON.stringify(s));case"undefined":return null;default:return s}}function De(s){for(var e=0,t=s.length,r;e<t;){if(r=s.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Y(s){return s.indexOf("/")===-1&&s.indexOf("~")===-1?s:s.replace(/~/g,"~0").replace(/\//g,"~1")}function St(s){return s.replace(/~1/g,"/").replace(/~0/g,"~")}function We(s){if(s===void 0)return!0;if(s){if(Array.isArray(s)){for(var e=0,t=s.length;e<t;e++)if(We(s[e]))return!0}else if(typeof s=="object"){for(var r=ke(s),o=r.length,i=0;i<o;i++)if(We(s[r[i]]))return!0}}return!1}function lt(s,e){var t=[s];for(var r in e){var o=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof o<"u"&&t.push(r+": "+o)}return t.join(`
`)}var Et=function(s){Mo(e,s);function e(t,r,o,i,n){var l=this.constructor,c=s.call(this,lt(t,{name:r,index:o,operation:i,tree:n}))||this;return c.name=r,c.index=o,c.operation=i,c.tree=n,Object.setPrototypeOf(c,l.prototype),c.message=lt(t,{name:r,index:o,operation:i,tree:n}),c}return e}(Error),N=Et,Go=$,ne={add:function(s,e,t){return s[e]=this.value,{newDocument:t}},remove:function(s,e,t){var r=s[e];return delete s[e],{newDocument:t,removed:r}},replace:function(s,e,t){var r=s[e];return s[e]=this.value,{newDocument:t,removed:r}},move:function(s,e,t){var r=ye(t,this.path);r&&(r=$(r));var o=te(t,{op:"remove",path:this.from}).removed;return te(t,{op:"add",path:this.path,value:o}),{newDocument:t,removed:r}},copy:function(s,e,t){var r=ye(t,this.from);return te(t,{op:"add",path:this.path,value:$(r)}),{newDocument:t}},test:function(s,e,t){return{newDocument:t,test:ge(s[e],this.value)}},_get:function(s,e,t){return this.value=s[e],{newDocument:t}}},Ho={add:function(s,e,t){return De(e)?s.splice(e,0,this.value):s[e]=this.value,{newDocument:t,index:e}},remove:function(s,e,t){var r=s.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(s,e,t){var r=s[e];return s[e]=this.value,{newDocument:t,removed:r}},move:ne.move,copy:ne.copy,test:ne.test,_get:ne._get};function ye(s,e){if(e=="")return s;var t={op:"_get",path:e};return te(s,t),t.value}function te(s,e,t,r,o,i){if(t===void 0&&(t=!1),r===void 0&&(r=!0),o===void 0&&(o=!0),i===void 0&&(i=0),t&&(typeof t=="function"?t(e,0,s,e.path):we(e,0)),e.path===""){var n={newDocument:s};if(e.op==="add")return n.newDocument=e.value,n;if(e.op==="replace")return n.newDocument=e.value,n.removed=s,n;if(e.op==="move"||e.op==="copy")return n.newDocument=ye(s,e.from),e.op==="move"&&(n.removed=s),n;if(e.op==="test"){if(n.test=ge(s,e.value),n.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",i,e,s);return n.newDocument=s,n}else{if(e.op==="remove")return n.removed=s,n.newDocument=null,n;if(e.op==="_get")return e.value=s,n;if(t)throw new N("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,s);return n}}else{r||(s=$(s));var l=e.path||"",c=l.split("/"),a=s,u=1,p=c.length,d=void 0,h=void 0,g=void 0;for(typeof t=="function"?g=t:g=we;;){if(h=c[u],h&&h.indexOf("~")!=-1&&(h=St(h)),o&&(h=="__proto__"||h=="prototype"&&u>0&&c[u-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(a[h]===void 0?d=c.slice(0,u).join("/"):u==p-1&&(d=e.path),d!==void 0&&g(e,0,s,d)),u++,Array.isArray(a)){if(h==="-")h=a.length;else{if(t&&!De(h))throw new N("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,s);De(h)&&(h=~~h)}if(u>=p){if(t&&e.op==="add"&&h>a.length)throw new N("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,s);var n=Ho[e.op].call(e,a,h,s);if(n.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",i,e,s);return n}}else if(u>=p){var n=ne[e.op].call(e,a,h,s);if(n.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",i,e,s);return n}if(a=a[h],t&&u<p&&(!a||typeof a!="object"))throw new N("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,s)}}}function A(s,e,t,r,o){if(r===void 0&&(r=!0),o===void 0&&(o=!0),t&&!Array.isArray(e))throw new N("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(s=$(s));for(var i=new Array(e.length),n=0,l=e.length;n<l;n++)i[n]=te(s,e[n],t,!0,o,n),s=i[n].newDocument;return i.newDocument=s,i}function Bo(s,e,t){var r=te(s,e);if(r.test===!1)throw new N("Test operation failed","TEST_OPERATION_FAILED",t,e,s);return r.newDocument}function we(s,e,t,r){if(typeof s!="object"||s===null||Array.isArray(s))throw new N("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,s,t);if(ne[s.op]){if(typeof s.path!="string")throw new N("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,s,t);if(s.path.indexOf("/")!==0&&s.path.length>0)throw new N('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,s,t);if((s.op==="move"||s.op==="copy")&&typeof s.from!="string")throw new N("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,s,t);if((s.op==="add"||s.op==="replace"||s.op==="test")&&s.value===void 0)throw new N("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,s,t);if((s.op==="add"||s.op==="replace"||s.op==="test")&&We(s.value))throw new N("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,s,t);if(t){if(s.op=="add"){var o=s.path.split("/").length,i=r.split("/").length;if(o!==i+1&&o!==i)throw new N("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,s,t)}else if(s.op==="replace"||s.op==="remove"||s.op==="_get"){if(s.path!==r)throw new N("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,s,t)}else if(s.op==="move"||s.op==="copy"){var n={op:"_get",path:s.from,value:void 0},l=_t([n],t);if(l&&l.name==="OPERATION_PATH_UNRESOLVABLE")throw new N("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,s,t)}}}else throw new N("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,s,t)}function _t(s,e,t){try{if(!Array.isArray(s))throw new N("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)A($(e),$(s),t||!0);else{t=t||we;for(var r=0;r<s.length;r++)t(s[r],r,e,void 0)}}catch(o){if(o instanceof N)return o;throw o}}function ge(s,e){if(s===e)return!0;if(s&&e&&typeof s=="object"&&typeof e=="object"){var t=Array.isArray(s),r=Array.isArray(e),o,i,n;if(t&&r){if(i=s.length,i!=e.length)return!1;for(o=i;o--!==0;)if(!ge(s[o],e[o]))return!1;return!0}if(t!=r)return!1;var l=Object.keys(s);if(i=l.length,i!==Object.keys(e).length)return!1;for(o=i;o--!==0;)if(!e.hasOwnProperty(l[o]))return!1;for(o=i;o--!==0;)if(n=l[o],!ge(s[n],e[n]))return!1;return!0}return s!==s&&e!==e}const zo=Object.freeze(Object.defineProperty({__proto__:null,JsonPatchError:N,deepClone:Go,getValueByPointer:ye,applyOperation:te,applyPatch:A,applyReducer:Bo,validator:we,validate:_t,_areEquals:ge},Symbol.toStringTag,{value:"Module"}));/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2021 Joachim Wester
 * MIT license
 */var Je=new WeakMap,Uo=function(){function s(e){this.observers=new Map,this.obj=e}return s}(),Fo=function(){function s(e,t){this.callback=e,this.observer=t}return s}();function jo(s){return Je.get(s)}function Ko(s,e){return s.observers.get(e)}function Vo(s,e){s.observers.delete(e.callback)}function Zo(s,e){e.unobserve()}function Jo(s,e){var t=[],r,o=jo(s);if(!o)o=new Uo(s),Je.set(s,o);else{var i=Ko(o,e);r=i&&i.observer}if(r)return r;if(r={},o.value=$(s),e){r.callback=e,r.next=null;var n=function(){Me(r)},l=function(){clearTimeout(r.next),r.next=setTimeout(n)};typeof window<"u"&&(window.addEventListener("mouseup",l),window.addEventListener("keyup",l),window.addEventListener("mousedown",l),window.addEventListener("keydown",l),window.addEventListener("change",l))}return r.patches=t,r.object=s,r.unobserve=function(){Me(r),clearTimeout(r.next),Vo(o,r),typeof window<"u"&&(window.removeEventListener("mouseup",l),window.removeEventListener("keyup",l),window.removeEventListener("mousedown",l),window.removeEventListener("keydown",l),window.removeEventListener("change",l))},o.observers.set(e,new Fo(e,r)),r}function Me(s,e){e===void 0&&(e=!1);var t=Je.get(s.object);Qe(t.value,s.object,s.patches,"",e),s.patches.length&&A(t.value,s.patches);var r=s.patches;return r.length>0&&(s.patches=[],s.callback&&s.callback(r)),r}function Qe(s,e,t,r,o){if(e!==s){typeof e.toJSON=="function"&&(e=e.toJSON());for(var i=ke(e),n=ke(s),l=!1,c=n.length-1;c>=0;c--){var a=n[c],u=s[a];if(Ce(e,a)&&!(e[a]===void 0&&u!==void 0&&Array.isArray(e)===!1)){var p=e[a];typeof u=="object"&&u!=null&&typeof p=="object"&&p!=null&&Array.isArray(u)===Array.isArray(p)?Qe(u,p,t,r+"/"+Y(a),o):u!==p&&(o&&t.push({op:"test",path:r+"/"+Y(a),value:$(u)}),t.push({op:"replace",path:r+"/"+Y(a),value:$(p)}))}else Array.isArray(s)===Array.isArray(e)?(o&&t.push({op:"test",path:r+"/"+Y(a),value:$(u)}),t.push({op:"remove",path:r+"/"+Y(a)}),l=!0):(o&&t.push({op:"test",path:r,value:s}),t.push({op:"replace",path:r,value:e}))}if(!(!l&&i.length==n.length))for(var c=0;c<i.length;c++){var a=i[c];!Ce(s,a)&&e[a]!==void 0&&t.push({op:"add",path:r+"/"+Y(a),value:$(e[a])})}}}function Qo(s,e,t){t===void 0&&(t=!1);var r=[];return Qe(s,e,r,"",t),r}const qo=Object.freeze(Object.defineProperty({__proto__:null,unobserve:Zo,observe:Jo,generate:Me,compare:Qo},Symbol.toStringTag,{value:"Module"}));Object.assign({},zo,qo,{JsonPatchError:Et,deepClone:$,escapePathComponent:Y,unescapePathComponent:St});function qe(s,e,t){const{selectedWidgets:r,dashEditorService:o}=s,i=o.dashPlayerService.layoutGrid,n=[...r,...t||[]],l=Math.min(...n.map(d=>{var h,g;return(g=(h=Q(d,e))==null?void 0:h.colStart)!=null?g:null}).filter(d=>d!==null)),c=Math.max(...n.map(d=>{var h,g;return(g=(h=Q(d,e))==null?void 0:h.colEnd)!=null?g:null}).filter(d=>d!==null)),a=Math.min(...n.map(d=>{var h,g;return(g=(h=Q(d,e))==null?void 0:h.rowStart)!=null?g:null}).filter(d=>d!==null)),u=c>i.columns-1?i.columns-1-c:l<0?-l:0,p=a<0?-a:0;return n.flatMap(d=>{const h=Q(d,e);if(u===0&&p===0)return[];if(!h||!D(h))return[];const g=V(K(d,C(e)),e);return[{op:"replace",path:`${g}/${d}/colStart`,backup:h,value:h.colStart+u},{op:"replace",path:`${g}/${d}/colEnd`,backup:h,value:h.colEnd+u},{op:"replace",path:`${g}/${d}/rowStart`,backup:h,value:h.rowStart+p},{op:"replace",path:`${g}/${d}/rowEnd`,backup:h,value:h.rowEnd+p}]})}const K=(s,e,t=null)=>{for(const r in e){const o=e[r];if(D(o)){if(r==s)return t}else{const i=K(s,o.slot,r);if(i)return i}}return null},Yo=(s,e)=>s.rowStart>=e.row&&s.rowStart<e.row+e.height,bt=(s,e)=>{var t;return(t=Object.keys(e.slottables).find(r=>Yo(s,e.slottables[r].position)))!=null?t:null},ct=(s,e)=>{const t=C(e),r=(i,n,l)=>{for(const c in n){if(c==i)return l;const a=n[c];if(D(a))continue;const u=r(i,a.slot,`${l}/${c}/slot`);if(u)return u}return null},o=r(s,t,me(e));if(!o)throw new Error("Widget not found in layout");return o},V=(s,e)=>s?`${me(e)}/${s}/slot`:me(e),Se=(s,e,t)=>{if(t){const o=e.slottables[t];return{...s,rowStart:s.rowStart-o.position.row,rowEnd:s.rowEnd-o.position.row}}const r=Object.values(e.slottables).reduce((o,i)=>o+(i.position.row<s.rowStart?i.position.height:0),0);return{...s,rowStart:s.rowStart-r,rowEnd:s.rowEnd-r}};function Xo(s){const{dashEditorService:e,mouseState:t,workingLayout:r,calculatedPositions:o}=s,i=e.dashPlayerService.layoutGrid;if(t.state!=="MOVING_SLOTTABLE")return[];const n=i.cellAt(t.mousePos.x,t.mousePos.y),l=[],c=t.slottableId,a=r.getSlottable(c);if(!a)throw new Error("Slottable not found");const u=xt(Pt(n,a.height),o,c);return l.push({op:"replace",path:`/slot/${c}/row`,backup:a.row,value:u.row}),l.push({op:"replace",path:`/slot/${c}/order`,backup:a.order,value:u.order}),l}function ei(s,e){const{mouseState:t,selectedWidgets:r,calculatedPositions:o,workingLayout:i,dashEditorService:n}=s,l=n.dashPlayerService.layoutGrid;if(t.state!=="MOVING")return[];const c=l.cellAt(t.initialMousePos.x,t.initialMousePos.y),a=l.cellAt(t.mousePos.x,t.mousePos.y),u={deltaI:a.i-c.i,deltaJ:a.j-c.j},p=[];for(const d of r){const h=o.widgets[d],g={colStart:h.position.colStart+u.deltaI,colEnd:h.position.colEnd+u.deltaI,rowStart:h.position.rowStart+u.deltaJ,rowEnd:h.position.rowEnd+u.deltaJ},f=V(K(d,C(i.layout)),i.layout),P=bt(g,o),_=V(P,i.layout),x=oe(d,C(e));!x||!D(x)||(f===_?p.push({op:"replace",path:`${f}/${d}`,backup:x,value:{...x,...Se(g,o,P)}}):(p.push({op:"remove",path:`${f}/${d}`,backup:x}),p.push({op:"add",path:`${_}/${d}`,value:{...x,...Se(g,o,P)}})))}return p}function ti(s,e,t,r){const o=[];for(const i of s.selectedWidgets){const n=V(K(i,C(r)),r),l=Q(i,r);!D(l)||(o.push({op:"replace",path:`${n}/${i}/colStart`,backup:l,value:l.colStart+e}),o.push({op:"replace",path:`${n}/${i}/colEnd`,backup:l,value:l.colEnd+e}),o.push({op:"replace",path:`${n}/${i}/rowStart`,backup:l,value:l.rowStart+t}),o.push({op:"replace",path:`${n}/${i}/rowEnd`,backup:l,value:l.rowEnd+t}))}return o}function It(s,e,t,r){const{mouseState:o,dashEditorService:i}=s,n=i.dashPlayerService.layoutGrid,l=i.camera;if(!l)throw new Error("No camera value yet");if(o.state!=="RESIZING"&&o.state!=="SLOTTABLE_RESIZING")return null;const c=o.side,a=l.screenPoint2world(o.mousePos),u=c==="bottom"||c==="right"?"bottom-right":"top-left",p=n.snap(a,u),d=c.includes("left")?p.x:e.x,h=c.includes("top")?p.y:e.y,g=c.includes("right")?p.x:e.x+e.width,f=c.includes("bottom")?p.y:e.y+e.height,P=Math.abs(g-d),_=Math.abs(f-h);let x={x:Math.min(d,g),y:Math.min(h,f),width:P,height:_,referential:p.referential};return P<t&&(x={...x,width:t}),_<r&&(x={...x,height:r}),x}const si=({selectedWidgets:s,calculatedPositions:e,dashEditorService:t})=>{const r=t.dashPlayerService.layoutGrid;return ze(Object.entries(e.widgets).filter(([o])=>s.has(o)).map(([o,i])=>B(e.widgets[o].position,r)).filter(o=>o!==null))};function ri(s){const{mouseState:e,dashEditorService:t,calculatedPositions:r}=s,o=t.dashPlayerService.layoutGrid;if(e.state!=="SLOTTABLE_RESIZING")return[];const i=r.slottables[e.slottableId],n={colStart:0,rowStart:i.position.row,colEnd:o.columns,rowEnd:i.position.row+i.position.height},l=o.rectFromArea(n);if(!l)return[];const c=It(s,l,o.width,o.cellHeight);if(!c)return[];const a=o.areaFromRect(c);return[{op:"replace",path:`/slot/${e.slottableId}/height`,backup:i.position.height,value:a.rowEnd-a.rowStart+1}]}function oi(s){const{mouseState:e,selectedWidgets:t,dashEditorService:r,workingLayout:o,calculatedPositions:i}=s,n=r.dashPlayerService.layoutGrid;if(e.state!=="RESIZING")return[];const l=e.side,c=si(s);if(!c)return[];const a=Array.from(t).filter(d=>{const h=i.widgets[d];return es(B(h.position,n),c,l)}),{minWidth:u,minHeight:p}=j[e.type].dashProperties;return a.flatMap(d=>{const h=i.widgets[d],g=B(h.position,n),f=It(s,g,u,p);if(!f)return[];const P=K(d,C(o.layout)),_=V(P,o.layout),x=n.areaFromRect(g),q=Se(n.areaFromRect(f),i,P);return[{op:"replace",path:`${_}/${d}/colStart`,backup:x.colStart,value:Math.max(q.colStart,0)},{op:"replace",path:`${_}/${d}/colEnd`,backup:x.colEnd,value:Math.min(q.colEnd,n.columns-1)},{op:"replace",path:`${_}/${d}/rowStart`,backup:x.rowStart,value:Math.max(q.rowStart,0)},{op:"replace",path:`${_}/${d}/rowEnd`,backup:x.rowEnd,value:q.rowEnd}]})}function ii(s){const{mouseState:e,dashEditorService:t,calculatedPositions:r}=s,o=t.dashPlayerService.layoutGrid;if(e.state!=="DRAGGING")return{operations:[]};const i=Object.values(j[e.type].pythonAPI.params).reduce((g,f)=>(f.isKwarg||!f.dashesInitialValue||(g[f.argName]=f.dashesInitialValue),g),{}),{initialWidth:n,initialHeight:l}=j[e.type].dashProperties,c=o.areaFromRect({x:e.x,y:e.y,width:n,height:l,referential:"world"}),a=bt(c,r),u=V(a,s.workingLayout.layout),p=_e(),d={id:p,type:e.type,props:{...i},...Se(c,r,a),events:{}};return{operations:[{op:"add",path:`${u}/${p}`,value:d}],widgetId:p}}const Pt=({j:s},e)=>({row:s,height:e,order:0}),ni=(s,e)=>Object.keys(s).reduce((t,r)=>(r===e||(t[r]=s[r]),t),{}),xt=(s,e,t)=>{const r=t?{...e,slottables:ni(e.slottables,t)}:e,o=Math.max(Object.values(r.slottables).reduce((n,l)=>l.position.row>=s.row?n:l.position.row+l.position.height<=s.row?n-l.position.height:n-(s.row-l.position.row),s.row),0),i=ai(s,r);return{...s,row:o,order:i}},dt=(s,e,t)=>Object.values(e.slottables).filter(r=>r.id!==t).find(r=>s.row>=r.position.row+r.position.height/2&&s.row<=r.position.row+r.position.height),ht=(s,e,t)=>Object.values(e.slottables).filter(r=>r.id!==t).filter(r=>r.position.row+r.position.height/2>s.row&&r.position.row<=s.row+s.height).reduce((r,o)=>!r||o.position.order<r.position.order?o:r,null),ai=(s,e)=>{var u,p;const t=dt(s,e),r=ht(s,e),o=t?ht(t.position,e,t.id):null,i=r?dt(r.position,e,r.id):null,n=[t,i].reduce((d,h)=>d?h&&d.position.order>h.position.order?h:d:h,null),l=[r,o].reduce((d,h)=>d?h&&d.position.order<h.position.order?h:d:h,null);if(!n&&!l)return 0;const c=(u=n==null?void 0:n.position.order)!=null?u:l.position.order-2,a=(p=l==null?void 0:l.position.order)!=null?p:n.position.order+2;return(c+a)/2};function li(s){const{mouseState:e,dashEditorService:t,calculatedPositions:r}=s,o=t.dashPlayerService.layoutGrid;if(e.state!=="DRAGGING_SLOTTABLE")return{operations:[]};const i=o.cellAt(e.x,e.y),n=_e(),l={id:n,type:e.type,props:{condition:"True"},slot:{},...xt(Pt(i,1),r)};return{operations:[{op:"add",path:`/slot/${n}`,value:l}],widgetId:n}}function ci(s,e){const{mouseState:t,selectedWidgets:r}=s;if(t.state!=="MOVING"||!t.duplicating)return[];const o=[];for(const i of r){const n=V(K(i,C(e)),e),l=Q(i,e);if(!l)continue;const c=_e();o.push({op:"add",path:`${n}/${c}`,value:{...H.exports.cloneDeep(l),id:c}})}return o}function Rt(s,e,t){const r=s.selectedWidgets,o=r.keys().next().value,i=K(o,C(e)),n=i?Ue(i,e).slot:C(e),c=Object.keys(n).filter(p=>!r.has(p)&&!(t!=null&&t.some(d=>p==d))&&D(n[p])).sort((p,d)=>ts(oe(p,C(e)),oe(d,C(e)))),a=[...r,...t||[]].map(p=>oe(p,C(e))).filter(p=>p!=null),u=[];return c.forEach(p=>{const d=oe(p,C(e));if(!d||!D(d))return;let h=0,g={...d};const f=()=>a.some(P=>mt(g,P));for(;f();)h++,g={...d,rowStart:d.rowStart+h,rowEnd:d.rowEnd+h};if(h){const P=V(i,e);u.push({op:"replace",path:`${P}/${p}/rowStart`,backup:d.rowStart,value:d.rowStart+h}),u.push({op:"replace",path:`${P}/${p}/rowEnd`,backup:d.rowEnd,value:d.rowEnd+h})}a.push(g)}),u}function di(s,e,t,r){const o=s.selectedWidgets;if(!o.size)return[];const i=[...o],n=[];return i.some(c=>{const a=K(c,C(r)),u=a?Ue(a,r).slot:C(r),p=Object.keys(u).filter(h=>!o.has(h)&&D(u[h])),d=Q(c,r);return p.some(h=>mt(d,u[h]))})&&o.forEach(c=>{const a=oe(c,C(r)),u=V(K(c,C(r)),r);!a||!D(a)||(n.push({op:"replace",path:`${u}/${c}/rowStart`,backup:a.rowStart,value:a.rowStart-t}),n.push({op:"replace",path:`${u}/${c}/rowEnd`,backup:a.rowEnd,value:a.rowEnd-t}),n.push({op:"replace",path:`${u}/${c}/colStart`,backup:a.colStart,value:a.colStart-e}),n.push({op:"replace",path:`${u}/${c}/colEnd`,backup:a.colEnd,value:a.colEnd-e}))}),n}function hi(s,e){const t=[],r=[];for(const o of e){const i=_e();t.push({op:"add",path:`/slot/${i}`,value:{...H.exports.cloneDeep(o),id:i}}),r.push(i)}return{operations:t,widgetsId:r}}function ui(s){const e=$(s.workingLayout.layout),t=ci(s,e);A(e,t);const r=Xo(s);A(e,r);const o=ei(s,e);A(e,o);const i=oi(s);A(e,i);const n=ri(s);A(e,n);const l=ii(s);A(e,l.operations);const c=li(s);A(e,c.operations);const a=qe(s,e,l.widgetId?[l.widgetId]:[]);A(e,a);const u=Rt(s,e,l.widgetId?[l.widgetId]:[]);return A(e,u),{layout:e,operations:[...t,...o,...r,...i,...n,...l.operations,...a,...u,...c.operations]}}function pi(s,e,t){const r=s.workingLayout.layout,o=ti(s,e,t,r);A(r,o);const i=di(s,e,t,r);A(r,i);const n=qe(s,r);return A(r,n),[...o,...i,...n]}function gi(s,e){const t=s.workingLayout.layout,r=hi(s,e);A(t,r.operations);const o=qe(s,t,r.widgetsId);A(t,o);const i=Rt(s,t,r.widgetsId);return A(t,i),[...r.operations,...o,...i]}const fi=()=>window.location.href.startsWith("vscode-webview://"),vi=(s,e)=>{!fi()||window.vscode.postMessage({type:"usage-event",event:{type:s,payload:e}})},mi=async({operations:s,name:e})=>{vi("widgets_updated",{checkpoint:e,operations:$(s)})};class Ye{constructor(e,t){v(this,"pubsub");v(this,"checkpointHistory",{undos:[],redos:[]});v(this,"_save",null);this.workingLayout=e,this.dashEditorService=t,this.pubsub=new Fe}static create(e,t){return new Ye(e,t)}setWorkingLayout(e){this.workingLayout=e}undo(){if(this.dashEditorService.isPreview||!this.checkpointHistory.undos.length)return;const e=this.checkpointHistory.undos.pop();if(e)return A(this.workingLayout,e.operations),this.checkpointHistory.redos.push(Le(e)),e}redo(){if(this.dashEditorService.isPreview)return;const e=this.checkpointHistory.redos.pop();if(e)return A(this.workingLayout,e.operations),this.checkpointHistory.undos.push(Le(e)),e}execute(e){this.dashEditorService.isPreview||(A(this.workingLayout,e.operations),this.checkpointHistory.undos.push(Le(e)),this.checkpointHistory.redos=[],this.save(),this.pubsub.publish("updated"),mi(e))}onSave(e){this._save=e}save(){var e;(e=this._save)==null||e.call(this)}}const Le=s=>({selection:s.selection,name:`RE: ${s.name}`,operations:s.operations.slice().reverse().map(e=>yi(e))}),yi=s=>{switch(s.op){case"add":return{op:"remove",backup:s.value,path:s.path};case"remove":return{op:"add",path:s.path,value:s.backup};case"replace":return{op:"replace",backup:s.value,path:s.path,value:s.backup}}};class Xe{constructor(e,t){v(this,"operationQueue");v(this,"pubsub");this.layout=e,this.pubsub=new Fe,this.operationQueue=Ye.create(e,t)}getRootSlot(){return C(this.layout)}getRootSlotPath(){return me(this.layout)}setLayout(e){this.operationQueue.setWorkingLayout(e)}static create(e,t){return new Xe(e,t)}getWidget(e){return Q(e,this.layout)}getWidgetOrSlottable(e){const t=hs(e,this.layout);if(!t)throw new Error(`Could not find widget or slottable with id ${e}`);return t}get widgets(){return this.getRootSlot()}get allWidgets(){const e=t=>Object.entries(t).reduce((r,[o,i])=>D(i)?{...r,[o]:i}:{...r,...e(i.slot)},{});return e(this.widgets)}getSlottable(e){return Ue(e,this.layout)}redo(){let e=this.operationQueue.redo();for(;e&&e.operations.length===0;)e=this.operationQueue.redo();return this.operationQueue.save(),e}undo(){let e=this.operationQueue.undo();for(;e&&e.operations.length===0;)e=this.operationQueue.undo();return this.operationQueue.save(),e}updateVariable(e,t){const r=this.getWidget(t);if(!D(r))return;const o=V(K(t,this.getRootSlot()),this.layout);this.operationQueue.execute({name:"update variable",selection:new Set([t]),operations:[{op:"replace",backup:r.variable,value:e,path:`${o}/${t}/variable`}]})}updateProp({param:e,value:t},r){const o=n=>this.getWidgetOrSlottable(n).props,i=(n,l,c)=>{const a=ct(n,this.layout);return[{op:"replace",backup:o(n)[l],value:c,path:`${a}/${n}/props/${l}`}]};this.operationQueue.execute({name:"update props",operations:r.flatMap(n=>i(n,e.argName,t)),selection:new Set(r)})}updateEvent({event:e,value:t},r){const o=n=>this.getWidget(n).events,i=(n,l,c)=>{const a=V(K(n,this.getRootSlot()),this.layout);return[{op:"replace",backup:o(n)[l],value:c,path:`${a}/${n}/events/${l}`}]};this.operationQueue.execute({name:"update events",operations:r.flatMap(n=>i(n,e.key,t)),selection:new Set(r)})}delete(e){this.operationQueue.execute({name:"widgets deleted",operations:e.map(t=>{const r=ct(t,this.layout);return{op:"remove",backup:this.getWidgetOrSlottable(t),path:`${r}/${t}`}}),selection:new Set(e)})}onSave(e){this.operationQueue.onSave(e)}updateVersion(){this.layout.version!=="0.2"&&this.operationQueue.execute({name:"Version updated",operations:[{op:"replace",backup:this.layout.version,value:"0.2",path:"/version"},{op:"add",value:this.layout.widgets,path:"/slot"},{op:"remove",path:"/widgets",backup:this.layout.widgets}],selection:new Set})}}const wi=s=>({type:"copyAndPaste",selectedWidgets:s});function Si(s,e){return s.setData("text/plain",JSON.stringify(wi(e))),!0}function Ei(s,e,t){const r=s.getData("text/plain");try{const o=r&&JSON.parse(r);if(!(o&&"type"in o&&o.type==="copyAndPaste"&&"selectedWidgets"in o&&Array.isArray(o.selectedWidgets)))return!1;const n=gi(e,o.selectedWidgets);return t.operationQueue.execute({name:"paste",operations:n,selection:e.selectedWidgets}),!0}catch{return!1}}class _i{constructor(e){v(this,"event");this.event=e}setData(e,t){var r;(r=this.event.clipboardData)==null||r.setData(e,t)}getData(e){var t,r;return(r=(t=this.event.clipboardData)==null?void 0:t.getData(e))!=null?r:null}getTransferItems(){var e,t;return Object.values((t=(e=this.event.clipboardData)==null?void 0:e.items)!=null?t:[]).map(Ii)}}class bi{constructor(e){v(this,"item");this.item=e}get type(){return this.item.type}getAsString(){return new Promise(e=>this.item.getAsString(t=>e(t)))}getJSONValue(){return this.getAsString().then(e=>{try{return e?JSON.parse(e):null}catch{return null}})}getAsFile(){return this.item.getAsFile()}}function Ii(s){return new bi(s)}function ut(s){return new _i(s)}function Pi(s){var t;const e=(t=document.getSelection())==null?void 0:t.toString();return(s==null?void 0:s.selectionStart)!==void 0||!!e}class et{constructor(e,t,r){v(this,"dash");v(this,"zoom");v(this,"prevSlot");v(this,"_collapsedSlottables");v(this,"_isPreview");v(this,"camera");v(this,"slottableRenderer");v(this,"selection");v(this,"dashPlayerService");v(this,"layoutModel");v(this,"workspace");v(this,"_mouseState");v(this,"_hoverState");v(this,"pubsub");v(this,"editor");v(this,"listener");v(this,"canvas");v(this,"interactMenu");v(this,"dashPlayer");v(this,"runtimeHeader");v(this,"canvasService");v(this,"computedState");v(this,"throttledWidgetsChangedSend",H.exports.throttle(()=>{H.exports.isEqual(this.dash.rootSlot,this.prevSlot)||(this.prevSlot=H.exports.cloneDeep(this.dash.rootSlot),this.dashPlayerService.sendWidgetsChanged(this.dash.rootSlot))},500));v(this,"startPanning",()=>{this.mouseState.state!=="PANNING"&&(this.mouseState.state="START_PANNING")});v(this,"onKeyDownEvents",e=>({escape:()=>this.escapeEvent(),backspace:()=>this.backspaceEvent(),delete:()=>this.backspaceEvent(),z:()=>this.undoEvent(e),arrowup:()=>this.arrowUpEvent(),arrowdown:()=>this.arrowDownEvent(),arrowleft:()=>this.arrowLeftEvent(),arrowright:()=>this.arrowRightEvent(),a:()=>this.selectAllEvent(e),p:()=>this.togglePreviewEvent(e),space:()=>this.startPanning()}));v(this,"resizeEventListener",e=>function(t){e.centerCanvasHandler(t)});v(this,"copyEventListener",e=>function(t){e.copyHandler(t)});v(this,"pasteEventListener",e=>function(t){e.pasteHandler(t)});v(this,"mousemoveEventListener",e=>function(t){e.mouseMoveHandler(t)});v(this,"mouseupEventListener",e=>function(t){e.mouseup(t)});v(this,"updateHoverStateOnResizeHandler",e=>{for(const t of this.getResizeHandlerRects())if(Oe(e,t.rect)){this.hoverState={state:"HOVERING_RESIZE_HANDLER",side:t.side};return}});v(this,"updateHoverStateOnWidget",e=>{var o;if(this.dashPlayerService.state.type!=="RUNNING")return;const{widgets:t}=this.calculatePositions(),r=(o=Object.keys(t).find(i=>Oe(this.camera.screenPoint2world(e),B(t[i].position,this.dashPlayerService.layoutGrid))))!=null?o:null;r?this.hoverState={state:"HOVERING_WIDGET",widgetId:r}:this.hoverState={state:"NONE"}});window.__dashEditorService=this,this.zoom={active:!1,hoverZoomBar:!1},this._isPreview=k(!1),this.dashPlayerService=e,this.dashPlayerService.layoutGrid.calculatePositions=()=>this.isPreview?this.dashPlayerService.calculatePositions():this.calculatePositions(),this.camera=je.create(this.dashPlayerService.layoutGrid),this.slottableRenderer=Ke.create(this.dashPlayerService.layoutGrid,this.camera),this._collapsedSlottables=Zt({}),this._mouseState={state:"IDLE"},this._hoverState={state:"NONE"},this.selection=Ve.create(),this.dash=t,this.workspace=r,this.pubsub=new Fe,this.layoutModel=Xe.create(H.exports.cloneDeep(this.dash.layout),this),this.layoutModel.updateVersion(),this.prevSlot=H.exports.cloneDeep(us(this.getRootWidgets(),j)),this.dashPlayerService.onWidgetsComputedMessage(o=>{var l;const i=Object.keys(this.dashPlayerService.runnerData.layout.slot),n=Object.keys((l=o.props)!=null?l:{});ps(i,n)})}overloadCollapsedSlottablesCondition(e){return Object.entries(e).reduce((t,[r,o])=>r in this.collapsedSlottables?{...t,[r]:{condition:!0}}:{...t,[r]:o},{})}get collapsedSlottables(){return this._collapsedSlottables.value}set collapsedSlottables(e){console.log("set collapsedSlottables",e),this._collapsedSlottables.value=e}get isPreview(){return this._isPreview.value}set isPreview(e){this._isPreview.value=e}get mouseState(){return this._mouseState}set mouseState(e){this._mouseState=e}get hoverState(){return this._hoverState}set hoverState(e){this._hoverState=e}getWidgetsWithErrors(){const e=this.dashPlayerService.state;return e?e.type!=="RUNNING"?[]:Object.keys(this.layoutModel.widgets).reduce((t,r)=>{var l,c,a;const o=(l=e.errors.props)==null?void 0:l[r],i=(c=e.errors.variables)==null?void 0:c[r],n=(a=e.errors.widgets)==null?void 0:a[r];return!o&&!i&&!n||!Object.keys({...o,...i,...n}).length?t:t?[...t,r]:[r]},[]):[]}getSelectedWidgetErrors(){var r,o,i,n,l,c;const e={},t=this.dashPlayerService.state;return!t||t.type!=="RUNNING"?e:{props:(o=t.errors.props)==null?void 0:o[(r=this.selection.selectedSlottableId)!=null?r:this.selection.selectedWidgetId],widget:(n=t.errors.widgets)==null?void 0:n[(i=this.selection.selectedSlottableId)!=null?i:this.selection.selectedWidgetId],variable:(c=t.errors.variables)==null?void 0:c[(l=this.selection.selectedSlottableId)!=null?l:this.selection.selectedWidgetId]}}setupOnSave(){this.layoutModel.onSave(async()=>{!this.workspace||(this.dash.layout=this.layoutModel.layout,this.dashPlayerService.updateDashData(this.dash.makeRunnerData(this.workspace)),this.throttledWidgetsChangedSend())})}hoverZoomBar(){this.zoom.hoverZoomBar=!0}leaveZoomBar(){this.zoom.hoverZoomBar=!1}getRootWidgets(){return Object.keys(this.dash.rootSlot).reduce((e,t)=>{const r=this.dash.rootSlot[t];return r.position&&(e[t]=r),e},{})}static create(e,t,r){return new et(e,t,r)}metadataDragStart(e,t){if(!this.camera)return;const r=this.camera.screenPoint2world({x:e.pageX,y:e.pageY,referential:"screen"});this.selection.resetSelection(),t in ae?this.mouseState={state:"DRAGGING_SLOTTABLE",...r,type:t}:this.mouseState={state:"DRAGGING",...r,type:t}}fixPosition(e){if(!this.canvas)return;const{origin:t,element:r,ignoreZoom:o}=e;if(!this.camera||!r||!r.style)return;const i=this.camera.worldPoint2screen(t),n=this.canvas.getBoundingClientRect(),l=[`translate(${i.x-n.x}px, ${i.y-n.y}px)`,o?null:`scale(${this.camera.zoom})`].filter(c=>c).join(" ");Object.assign(r.style,{transform:l,transformOrigin:"top left"})}fixCanvasRectPosition(){var i,n,l,c,a,u,p,d,h,g;const e=this.camera.screenRect2world(this.camera.canvasRect),t=this.camera.screenDelta2world({dx:8,dy:8,referential:"screen"}),r=this.camera.screenRect2world({x:(i=this.interactMenu)==null?void 0:i.$el.getBoundingClientRect().x,y:(n=this.interactMenu)==null?void 0:n.$el.getBoundingClientRect().y,width:(l=this.interactMenu)==null?void 0:l.$el.getBoundingClientRect().width,height:(c=this.interactMenu)==null?void 0:c.$el.getBoundingClientRect().height,referential:"screen"});this.fixPosition({origin:{x:Math.min(this.dashPlayerService.layoutGrid.width+t.dx,e.x+e.width-r.width-t.dx),y:Math.max(e.y+t.dy,0),referential:"world"},element:(a=this.interactMenu)==null?void 0:a.$el,ignoreZoom:!0});const o=this.camera.screenRect2world({x:(u=this.runtimeHeader)==null?void 0:u.$el.getBoundingClientRect().x,y:(p=this.runtimeHeader)==null?void 0:p.$el.getBoundingClientRect().y,width:(d=this.runtimeHeader)==null?void 0:d.$el.getBoundingClientRect().width,height:(h=this.runtimeHeader)==null?void 0:h.$el.getBoundingClientRect().height,referential:"screen"});this.fixPosition({origin:{x:0,y:-o.height-t.dy,referential:"world"},element:(g=this.runtimeHeader)==null?void 0:g.$el,ignoreZoom:!0})}canvasMousedown(e){var o;if(!this.camera)return;const t={x:e.pageX,y:e.pageY,referential:"screen"};if(e.button==1||e.button==0&&Co.isPressed("space")){this.mouseState={state:"PANNING",initialMousePos:t,mousePos:t};return}const r=this.camera.screenPoint2world(t);this.hoverState.state==="HOVERING_WIDGET"?this.mouseState={state:"JUST_CLICKED",pos:r,widgetId:this.hoverState.widgetId}:this.hoverState.state==="HOVERING_RESIZE_HANDLER"?this.mouseState={state:"RESIZING",side:this.hoverState.side,initialMousePos:t,mousePos:t,type:(o=this.selection.selectedWidget)==null?void 0:o.type}:this.hoverState.state==="HOVERING_TOGGLE"?this.mouseState={state:"JUST_CLICKED_TOGGLE",mousePos:t,slottable:this.hoverState.slottable}:this.hoverState.state==="HOVERING_SLOTTABLE_RESIZE_HANDLER"?this.mouseState={state:"SLOTTABLE_RESIZING",initialMousePos:t,mousePos:t,slottableId:this.hoverState.slottableId,side:"bottom"}:this.hoverState.state==="HOVERING_SLOTTABLE_SELECTOR"?this.mouseState={state:"JUST_CLICKED_SLOTTABLE_SELECTOR",slottableId:this.hoverState.slottableId,mousePos:t}:(J(e)||this.selection.resetSelection(),this.mouseState={state:"SELECTING",initialMousePos:t,mousePos:t})}mouseMoveHandler(e){if(!this.camera)return;const t={x:e.pageX,y:e.pageY,referential:"screen"},r=this.camera.screenPoint2world(t);if(this.mouseState.state==="PANNING"){const o={dx:-e.movementX,dy:-e.movementY},i=this.camera.screenDelta2world({dx:o.dx,dy:o.dy,referential:"screen"});this.camera.translate(i),e.preventDefault(),e.stopPropagation();return}this.mouseState.state==="MOVING"&&(this.mouseState.mousePos=r,this.mouseState.duplicating=Te(e)),this.mouseState.state==="MOVING_SLOTTABLE"&&(this.mouseState.mousePos=r),this.mouseState.state==="JUST_CLICKED"&&rt(this.mouseState.pos,r)*this.camera.zoom>5&&(this.selection.has(this.mouseState.widgetId)||(J(e)?this.selection.addToSelectedWidgets(this.mouseState.widgetId):(this.selection.resetSelection(),this.selection.addToSelectedWidgets(this.mouseState.widgetId))),this.mouseState={state:"MOVING",initialMousePos:this.mouseState.pos,mousePos:r,duplicating:Te(e)}),this.mouseState.state==="JUST_CLICKED_SLOTTABLE_SELECTOR"&&rt(this.mouseState.mousePos,r)*this.camera.zoom>5&&(this.mouseState={state:"MOVING_SLOTTABLE",initialMousePos:this.camera.screenPoint2world(this.mouseState.mousePos),mousePos:r,slottableId:this.mouseState.slottableId}),this.mouseState.state==="SELECTING"&&(this.mouseState.mousePos=t),this.mouseState.state==="RESIZING"&&(this.mouseState.mousePos=t),this.mouseState.state==="SLOTTABLE_RESIZING"&&(this.mouseState.mousePos=t),this.computeHoverState(t)}everySelectedWidgetInPreviewState(){const e=this.dashPlayerService.state;return e.type!=="RUNNING"?!1:this.selection.selectedWidgetsIds.every(t=>Object.keys(e.widgets).includes(t))}getRectangularHull(){const e=this.dashPlayerService.state;return e.type!=="RUNNING"?null:ze(Object.entries(e.widgets).filter(([t])=>this.selection.has(t)).map(([t,r])=>B(r.position,this.dashPlayerService.layoutGrid)))}selectionRect(){if(this.mouseState.state!=="SELECTING")return null;const{x:e,y:t}=this.mouseState.initialMousePos,{x:r,y:o}=this.mouseState.mousePos;return{x:Math.min(e,r),y:Math.min(t,o),width:Math.abs(e-r),height:Math.abs(t-o),referential:"screen"}}pasteHandler(e){Ei(ut(e),this.getInput(),this.layoutModel)&&e.preventDefault()}renderScreenPositioning(){var r;if(!this.camera||!this.workspace||!this.canvas)return;this.fixPosition({origin:{x:0,y:0,referential:"world"},element:(r=this.dashPlayer)==null?void 0:r.$el}),this.fixCanvasRectPosition();const e=this.canvas.getContext("2d");if(!e)return;const t=this.canvas.getBoundingClientRect();this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,e.clearRect(0,0,this.canvas.width,this.canvas.height),e.translate(-t.x,-t.y)}renderComputeCursor(){var e,t;!this.canvas||(this.canvas.style.cursor=(t=(e=this.canvasService)==null?void 0:e.cursor(this.mouseState,this.hoverState))!=null?t:"default")}renderPreviewState(){var o,i;if(this.dashPlayerService.state.type!=="RUNNING")return;const e=this.getInput(),t=ui(e);(!H.exports.isEqual(t.operations,(o=this.computedState)==null?void 0:o.operations)||!H.exports.isEqual(t.layout,(i=this.computedState)==null?void 0:i.layout))&&(this.computedState=t),this.computedState&&this.canvasService&&this.canvasService.render({...e,computedState:this.computedState,isPreview:this.isPreview,calculatedPositions:this.calculatePositions(this.dash.makeRunnerData(this.workspace,this.computedState.layout).layout.slot)})}render(){try{this.renderScreenPositioning(),this.renderComputeCursor(),this.renderPreviewState()}catch(e){console.error(e)}finally{requestAnimationFrame(()=>this.render())}}onDragover(e){if(!this.camera)return;e.preventDefault();const t=this.camera.screenPoint2world({x:e.pageX,y:e.pageY,referential:"screen"});this.mouseState={...this.mouseState,...t}}canvasWheel(e){if(!this.camera)return;const t={x:e.pageX,y:e.pageY,referential:"screen"};if(le(e)||Ao(e))this.camera.zoomIn(Math.exp(-Math.sign(e.deltaY)*.05),t),e.preventDefault();else{const r=J(e)?{dx:e.deltaY,dy:0}:{dx:e.deltaX,dy:e.deltaY},o=this.camera.screenDelta2world({dx:r.dx,dy:r.dy,referential:"screen"});this.camera.translate(o)}e.stopPropagation()}togglePreviewEvent(e){J(e)&&this.pubsub.publish("change-preview",!this.isPreview)}resetEditingState(e){this.mouseState={state:"IDLE"},this.computeHoverState(e)}escapeEvent(){this.mouseState.state==="IDLE"&&this.selection.resetSelection(),this.resetEditingState({referential:"screen",x:0,y:0})}backspaceEvent(){this.selection.selectedSlottableId?this.layoutModel.delete([this.selection.selectedSlottableId]):this.layoutModel.delete(this.selection.selectedWidgetsIds),this.selection.resetSelection()}undoEvent(e){if(le(e)&&J(e)){e.preventDefault(),e.stopPropagation();const t=this.layoutModel.redo();if(t){if(t.operations.some(r=>r.op==="remove")){this.selection.resetSelection();return}this.selection.selectedWidgetsIds=[...Array.from(t.selection)]}return}else if(le(e)){e.preventDefault(),e.stopPropagation();const t=this.layoutModel.undo();if(t){if(t.operations.some(r=>r.op==="remove")){this.selection.resetSelection();return}this.selection.selectedWidgetsIds=[...Array.from(t.selection)]}return}}selectAllEvent(e){le(e)&&(e.preventDefault(),e.stopPropagation(),this.selection.selectAll())}move(e,t){const[r,o]={up:[0,-1],down:[0,1],left:[-1,0],right:[1,0]}[t],i=pi(e,r,o);this.layoutModel.operationQueue.execute({name:`move ${t}`,operations:i,selection:e.selectedWidgets})}arrowUpEvent(){this.move(this.getInput(),"up")}arrowDownEvent(){this.move(this.getInput(),"down")}arrowLeftEvent(){this.move(this.getInput(),"left")}arrowRightEvent(){this.move(this.getInput(),"right")}selectingOnMouseUp(e){J(e)?this.widgetsInRectangularSelection().forEach(t=>{this.selection.toggleWidgetSelection(t)}):(this.selection.resetSelection(),this.widgetsInRectangularSelection().forEach(t=>{this.selection.addToSelectedWidgets(t)}))}toggleSlottable(e){this.collapsedSlottables={...this.collapsedSlottables,[e]:!this.collapsedSlottables[e]}}mouseup(e){var r;(r=this.computedState)!=null&&r.operations.length&&this.layoutModel.operationQueue.execute({name:"mouse up",operations:this.computedState.operations,selection:new Set(this.selection.selectedWidgetsIds)}),this.mouseState.state==="SELECTING"&&this.selectingOnMouseUp(e),this.mouseState.state==="JUST_CLICKED"&&(J(e)?this.selection.toggleWidgetSelection(this.mouseState.widgetId):(this.selection.resetSelection(),this.selection.selectedSlottableId=null,this.selection.addToSelectedWidgets(this.mouseState.widgetId))),this.mouseState.state==="JUST_CLICKED_TOGGLE"&&this.toggleSlottable(this.mouseState.slottable),this.mouseState.state==="JUST_CLICKED_SLOTTABLE_SELECTOR"&&(this.selection.selectedSlottableId=this.mouseState.slottableId);const t={x:e.pageX,y:e.pageY,referential:"screen"};this.resetEditingState(t)}onKeydown(e){var t,r;(r=(t=this.onKeyDownEvents(e))[e.key.toLowerCase().trim()?e.key.toLowerCase():e.code.toLowerCase()])==null||r.call(t)}onKeyup(e){this.mouseState={state:"IDLE"}}copyHandler(e){Pi(e==null?void 0:e.target)||Si(ut(e),this.selection.selectedWidgets)&&e.preventDefault()}centerCanvasHandler(e){var t;(t=this.camera)==null||t.correct()}addGlobalEventListeners(){addEventListener("resize",this.resizeEventListener(this)),addEventListener("copy",this.copyEventListener(this)),addEventListener("paste",this.pasteEventListener(this)),addEventListener("mousemove",this.mousemoveEventListener(this)),addEventListener("mouseup",this.mouseupEventListener(this))}removeGlobalEventListeners(){removeEventListener("resize",this.resizeEventListener(this)),removeEventListener("copy",this.copyEventListener(this)),removeEventListener("paste",this.pasteEventListener(this)),removeEventListener("mousemove",this.mousemoveEventListener(this)),removeEventListener("mouseup",this.mouseupEventListener(this))}async setup(e,t,r,o,i,n){var c,a;if(this.editor=e,this.listener=t,this.interactMenu=o,this.dashPlayer=i,this.runtimeHeader=n,this.canvas=r,this.camera.setProjectedCanvas(r),this.camera.correct(),t.addEventListener("wheel",u=>this.canvasWheel(u)),r.addEventListener("mousedown",u=>this.canvasMousedown(u)),r.addEventListener("drop",u=>this.mouseup(u)),r.addEventListener("dragover",u=>this.onDragover(u)),(c=r.parentElement)==null||c.addEventListener("keydown",u=>this.onKeydown(u)),(a=r.parentElement)==null||a.addEventListener("keyup",u=>this.onKeyup(u)),!r.getContext("2d"))throw new Error(`I can't get no context 2d ${r}`);this.canvasService=pe.create(r,this),this.addGlobalEventListeners(),Be(()=>{this.camera.fit(),this.render()})}tearDown(){this.removeGlobalEventListeners()}widgetsInRectangularSelection(){if(!this.camera)throw new Error("No camera value yet");if(this.dashPlayerService.state.type!=="RUNNING")return new Set;const{widgets:e}=this.calculatePositions(),t=this.selectionRect();return t?new Set(Object.keys(e).filter(r=>ss(this.camera.worldRect2screen(B(e[r].position,this.dashPlayerService.layoutGrid)),t))):new Set}calculatePositions(e){return this.dashPlayerService.state.type!=="RUNNING"?{widgets:{},slottables:{}}:this.dashPlayerService.calculatePositions(this.overloadCollapsedSlottablesCondition(this.dashPlayerService.state.props),e)}getInput(){switch(this.dashPlayerService.state.type){case"AUTHENTICATING":case"RUNNING":return{mouseState:this.mouseState,dashEditorService:this,workingLayout:this.layoutModel,hoverState:this.hoverState,resizeHandlerRects:this.getResizeHandlerRects(),widgetsInRectangularSelection:this.widgetsInRectangularSelection(),selectedWidgets:new Set(this.selection.selectedWidgetsIds),dash:this.dash,calculatedPositions:this.calculatePositions(),selectedSlottable:this.selection.selectedSlottableId};default:throw new Error(`Invalid state ${JSON.stringify(this.dashPlayerService.state.type)} for getInput`)}}getResizeHandlerRects(){if(!this.camera)throw new Error("No camera value yet");const e=this.getRectangularHull();return!e||!this.everySelectedWidgetInPreviewState()?[]:Wo(this.selection.selectedWidgets,this.camera.worldRect2screen(e))}updateHoverStateOnToggle(e){const t=this.slottableRenderer.getToggleUnderCursor(e);t&&(this.hoverState={state:"HOVERING_TOGGLE",slottable:t.id})}updateHoverStateOnSlottableSelector(e){const t=this.slottableRenderer.getSelectorUnderCursor(e);t&&(this.hoverState={state:"HOVERING_SLOTTABLE_SELECTOR",slottableId:t.id})}updateHoverStateOnSlottableResizeHandler(e){const t=this.slottableRenderer.getResizerUnderCursor(e);t&&(this.hoverState={state:"HOVERING_SLOTTABLE_RESIZE_HANDLER",slottableId:t.id})}computeHoverState(e){!this.camera||(this.updateHoverStateOnWidget(e),this.updateHoverStateOnResizeHandler(e),this.updateHoverStateOnToggle(e),this.updateHoverStateOnSlottableSelector(e),this.updateHoverStateOnSlottableResizeHandler(e))}}const xi={class:"dash-editor"},Ri=z({__name:"DashEditor",setup(s){const e=Jt(),t=Qt(),r=({id:d,type:h})=>{h==="dash"?(e.push({name:"dashEditor",params:{dashId:d},query:t.query}),n()):e.push({name:"editor",params:{formId:d},query:t.query})},{loading:o,result:i,refetch:n}=ws(()=>Promise.all([Es.get(),Ss.get(t.params.dashPath)]).then(([d,h])=>qt({workspace:d,dash:h,...a(d,h)}))),l=d=>{i.value&&(i.value.dashEditorService.isPreview=d)},c=d=>{var h;return(h=i.value)==null?void 0:h.dash.addVariableToCode(d)};function a(d,h){const g=rs(h.makeRunnerData(d)),f=as.create(),P=et.create(g,h,d);return g.onRedirect(({url:_,queryParams:x})=>Ht(e,_,x)),g.on("eval-return",_=>{_.repr&&f.log({type:"eval-output",log:_.repr})}),g.on("eval-error",_=>{f.log({type:"eval-output",log:_.repr})}),g.on("stderr",_=>{f.log({type:"stderr",log:_.log})}),g.on("stdout",_=>{f.log({type:"stdout",log:_.log})}),g.on("widgets-computed",_=>{var x;(x=_.errors)!=null&&x.general&&f.log({type:"stderr",log:_.errors.general.repr})}),g.on("program-start-failed",_=>{var x;f.log({type:"stderr",log:(x=_.error)!=null?x:""})}),{dashPlayerService:g,logService:f,dashEditorService:P}}function u(d){var h;(h=i.value)==null||h.dashPlayerService.sendEvalRequest(d)}const p=()=>{!i.value||i.value.dashPlayerService.resetState()};return(d,h)=>{var g,f,P;return y(),E("div",xi,[m(o)||!((g=m(i))!=null&&g.dash)||!((f=m(i))!=null&&f.workspace)?(y(),X(ls,{key:0,class:"loading",justify:"center"})):(y(),X(Bt,{key:1},{left:re(()=>[L(_s,{link:"/_editor/dashes"})]),right:re(()=>[L(Ps,{path:"dashes/overview"}),L(Is,{model:m(i).dash},null,8,["model"]),L(bs,{model:m(i).dash},null,8,["model"])]),default:re(()=>[L(st,{title:"Layout editor"},{default:re(()=>{var _;return[(_=m(i))!=null&&_.dashPlayerService?(y(),X(mo,{key:0,workspace:m(i).workspace,dash:m(i).dash,"dash-editor-service":m(i).dashEditorService,params:m(t).query,onNavigate:r,onChangePreview:l,onCreateVariable:c},null,8,["workspace","dash","dash-editor-service","params"])):M("",!0)]}),_:1}),L(st,{title:"Settings"},{default:re(()=>[L(As,{dash:m(i).dash},null,8,["dash"])]),_:1})]),_:1})),m(i)?(y(),X(is,{key:2,"log-service":m(i).logService,runtime:"dashes",onRestart:p,onEvalRequest:u},null,8,["log-service"])):M("",!0),L(ns,{"has-changes":(P=m(i))==null?void 0:P.dash.hasChanges()},null,8,["has-changes"])])}}});const nn=U(Ri,[["__scopeId","data-v-41d35da0"]]);export{nn as default};
//# sourceMappingURL=DashEditor.8489c132.js.map
