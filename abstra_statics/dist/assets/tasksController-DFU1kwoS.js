import{a as I}from"./router-Bh5EUIsF.js";import{V as B,i as p,r as q,N as G}from"./jwt-decode.esm-BRRA-bKi.js";import"./contracts.generated-CcwXwzfb.js";import{a as C}from"./record-B_JjtlWo.js";import"./linters-CElNuqXo.js";import{u as F}from"./polling-D7gWgnWW.js";import{T as K}from"./taskCreator-DYP6TgxP.js";(function(){try{var c=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(c._sentryDebugIds=c._sentryDebugIds||{},c._sentryDebugIds[t]="fdc5c853-4f6d-4b5e-88ff-12b31953a6d4",c._sentryDebugIdIdentifier="sentry-dbid-fdc5c853-4f6d-4b5e-88ff-12b31953a6d4")}catch{}})();class Q{async list(){return await(await fetch("/_editor/api/forms")).json()}async create(t,e,a,n){return await(await fetch("/_editor/api/forms",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t,file:e,position:a,id:n})})).json()}async get(t){try{return await(await fetch(`/_editor/api/forms/${t}`)).json()}catch{return null}}async update(t,e){return await(await fetch(`/_editor/api/forms/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json()}async delete(t,e){const a=e?"?remove_file=true":"",n=`/_editor/api/forms/${t}`+a;await fetch(n,{method:"DELETE",headers:{"Content-Type":"application/json"}})}async duplicate(t){return await(await fetch(`/_editor/api/forms/${t}/duplicate`,{method:"POST"})).json()}}const y=new Q;class g{record;constructor(t){this.record=C.create(y,t)}static async list(){return(await y.list()).map(e=>new g(e))}static async create(t,e,a,n){const d=await y.create(t,e,a,n);return new g(d)}static async get(t){const e=await y.get(t);return e?new g(e):null}get id(){return this.record.get("id")}get type(){return"form"}get file(){return this.record.get("file")}set file(t){this.record.set("file",t)}get autoStart(){return this.record.get("auto_start")}set autoStart(t){this.record.set("auto_start",t)}get endMessage(){return this.record.get("end_message")}set endMessage(t){this.record.set("end_message",t)}get errorMessage(){return this.record.get("error_message")}set errorMessage(t){this.record.set("error_message",t)}get path(){return this.record.get("path")}set path(t){this.record.set("path",t)}get startButtonText(){return this.record.get("start_button_text")}set startButtonText(t){this.record.set("start_button_text",t)}get startMessage(){return this.record.get("start_message")}set startMessage(t){this.record.set("start_message",t)}get timeoutMessage(){return this.record.get("timeout_message")}set timeoutMessage(t){this.record.set("timeout_message",t)}get notificationTrigger(){return new Proxy(this.record.get("notification_trigger"),{set:(t,e,a)=>(this.record.set("notification_trigger",{...t,[e]:a}),!0)})}set notificationTrigger(t){this.record.set("notification_trigger",t)}get(t){return this.record.get(t)}set(t,e){this.record.set(t,e)}get title(){return this.record.get("title")}set title(t){this.record.set("title",t)}get codeContent(){return this.record.get("code_content")}set codeContent(t){this.record.set("code_content",t)}async save(t){const e=this.codeContent;await this.record.save(t),this.record.updateInitialState("code_content",e)}onUpdate(t){this.record.pubsub.subscribe("update",t)}hasChanges(t){return this.record.hasChanges(t)}getInitialState(t){return this.record.getInitialState(t)}updateInitialState(t,e){this.record.updateInitialState(t,e)}async delete(t){await y.delete(this.id,t)}async duplicate(){const t=await y.duplicate(this.id);return new g(t)}makeRunnerData(t){return{...t.makeRunnerData(),id:this.id,isLocal:!0,path:this.path,title:this.title,isInitial:this.isInitial,runtimeType:"form",autoStart:this.autoStart,endMessage:this.endMessage,errorMessage:this.errorMessage,startMessage:this.startMessage,timeoutMessage:this.timeoutMessage,startButtonText:this.startButtonText}}get position(){const[t,e]=this.record.get("workflow_position");return{x:t,y:e}}get isInitial(){return this.record.get("is_initial")}get input(){return this.record.get("input")}set input(t){this.record.set("input",t)}get output(){return this.record.get("output")}set output(t){this.record.set("output",t)}static from(t){return new g(t)}}class X{async list(){return await(await fetch("/_editor/api/hooks")).json()}async create(t,e,a,n){return await(await fetch("/_editor/api/hooks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t,file:e,position:a,id:n})})).json()}async get(t){try{return await(await fetch(`/_editor/api/hooks/${t}`)).json()}catch{return null}}async update(t,e){return await(await fetch(`/_editor/api/hooks/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json()}async delete(t,e){const a=e?"?remove_file=true":"",n=`/_editor/api/hooks/${t}`+a;await fetch(n,{method:"DELETE",headers:{"Content-Type":"application/json"}})}async run(t,e){const a=new URLSearchParams(e.query),n=await fetch(`/_editor/api/hooks/${t}/run?${a.toString()}`,{method:e.method,headers:{"Content-Type":"application/json",...e.headers},body:e.method==="GET"?void 0:e.body}),{status:d,headers:h,body:o}=await n.json();return{status:d,headers:h,body:o}}}const f=new X;class S{record;constructor(t){this.record=C.create(f,t)}static async list(){return(await f.list()).map(e=>new S(e))}static async create(t,e,a,n){const d=await f.create(t,e,a,n);return new S(d)}static async get(t){const e=await f.get(t);return e?new S(e):null}async delete(t){await f.delete(this.id,t)}async duplicate(){return this}async save(t){const e=this.codeContent;await this.record.save(t),this.record.updateInitialState("code_content",e)}onUpdate(t){this.record.pubsub.subscribe("update",t)}hasChanges(t){return this.record.hasChanges(t)}getInitialState(t){return this.record.getInitialState(t)}updateInitialState(t,e){this.record.updateInitialState(t,e)}get id(){return this.record.get("id")}get type(){return"hook"}get path(){return this.record.get("path")}set path(t){this.record.set("path",t)}get title(){return this.record.get("title")}set title(t){this.record.set("title",t)}get codeContent(){return this.record.get("code_content")}set codeContent(t){this.record.set("code_content",t)}get file(){return this.record.get("file")}set file(t){this.record.set("file",t)}async run(t){return f.run(this.id,t)}get position(){const[t,e]=this.record.get("workflow_position");return{x:t,y:e}}get isInitial(){return this.record.get("is_initial")}get input(){return this.record.get("input")}set input(t){this.record.set("input",t)}get output(){return this.record.get("output")}set output(t){this.record.set("output",t)}static from(t){return new S(t)}}class Y{async list(){return await(await fetch("/_editor/api/jobs")).json()}async create(t,e,a,n){return await(await fetch("/_editor/api/jobs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t,file:e,position:a,id:n})})).json()}async get(t){try{return await(await fetch(`/_editor/api/jobs/${t}`)).json()}catch{return null}}async update(t,e){return await(await fetch(`/_editor/api/jobs/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json()}async delete(t,e){const a=e?"?remove_file=true":"",n=`/_editor/api/jobs/${t}`+a;await fetch(n,{method:"DELETE",headers:{"Content-Type":"application/json"}})}async run(t){return(await fetch(`/_editor/api/jobs/${t}/run`,{method:"POST",headers:{"Content-Type":"application/json"}})).ok}}const w=new Y;class T{record;isInitial=!0;constructor(t){this.record=C.create(w,t)}static async list(){return(await w.list()).map(e=>new T(e))}static async create(t,e,a,n){const d=await w.create(t,e,a,n);return new T(d)}static async get(t){const e=await w.get(t);return e?new T(e):null}async delete(t){await w.delete(this.id,t)}async duplicate(){return this}async save(t){const e=this.codeContent;await this.record.save(t),this.record.updateInitialState("code_content",e)}onUpdate(t){this.record.pubsub.subscribe("update",t)}hasChanges(t){return this.record.hasChanges(t)}getInitialState(t){return this.record.getInitialState(t)}updateInitialState(t,e){this.record.updateInitialState(t,e)}get schedule(){return this.record.get("schedule")}set schedule(t){this.record.set("schedule",t)}get type(){return"job"}get title(){return this.record.get("title")}set title(t){this.record.set("title",t)}get codeContent(){return this.record.get("code_content")}set codeContent(t){this.record.set("code_content",t)}get file(){return this.record.get("file")}set file(t){this.record.set("file",t)}get id(){return this.record.get("id")}async run(){return w.run(this.id)}get position(){const[t,e]=this.record.get("workflow_position");return{x:t,y:e}}get input(){return this.record.get("input")}set input(t){this.record.set("input",t)}get output(){return this.record.get("output")}set output(t){this.record.set("output",t)}static from(t){return new T(t)}}class Z{async list(){return await(await fetch("/_editor/api/scripts")).json()}async create(t,e,a,n){return await(await fetch("/_editor/api/scripts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t,file:e,position:a,id:n})})).json()}async get(t){try{return await(await fetch(`/_editor/api/scripts/${t}`)).json()}catch{return null}}async update(t,e){return await(await fetch(`/_editor/api/scripts/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json()}async delete(t,e){const a=e?"?remove_file=true":"",n=`/_editor/api/scripts/${t}`+a;await fetch(n,{method:"DELETE",headers:{"Content-Type":"application/json"}})}async run(t,e){return(await fetch(`/_editor/api/scripts/${t}/run`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({task_id:e})})).ok}}const m=new Z;class _{record;constructor(t){this.record=C.create(m,t)}static async list(){return(await m.list()).map(e=>new _(e))}static async create(t,e,a,n){const d=await m.create(t,e,a,n);return new _(d)}static async get(t){const e=await m.get(t);return e?new _(e):null}async delete(t){await m.delete(this.id,t)}async duplicate(){return this}async save(t){const e=this.codeContent;await this.record.save(t),this.record.updateInitialState("code_content",e)}onUpdate(t){this.record.pubsub.subscribe("update",t)}hasChanges(t){return this.record.hasChanges(t)}getInitialState(t){return this.record.getInitialState(t)}updateInitialState(t,e){this.record.updateInitialState(t,e)}get id(){return this.record.get("id")}get codeContent(){return this.record.get("code_content")}set codeContent(t){this.record.set("code_content",t)}get title(){return this.record.get("title")}set title(t){this.record.set("title",t)}get type(){return"tasklet"}get file(){return this.record.get("file")}set file(t){this.record.set("file",t)}get path(){return this.record.get("path")}set path(t){this.record.set("path",t)}async run(t){return m.run(this.id,t)}get position(){const[t,e]=this.record.get("workflow_position");return{x:t,y:e}}get isInitial(){return!1}get input(){return this.record.get("input")}set input(t){this.record.set("input",t)}get output(){return this.record.get("output")}set output(t){this.record.set("output",t)}static from(t){return new _(t)}}class ct{async createTask(t,e,a){return fetch("/_editor/api/tasks",{method:"POST",body:JSON.stringify({name:t,payload:a,stage_id:e}),headers:{"Content-Type":"application/json"}}).then(n=>n.json())}async getAllTasks(t,e){const a={offset:t.currentIndex*t.pageSize,limit:t.pageSize,filter:{stage:e.stage,status:e.status,startDate:e.startDate,endDate:e.endDate,payloadValue:e.payloadValue,payloadMatchCase:e.payloadMatchCase,payloadMatchWholeWord:e.payloadMatchWholeWord}};return fetch("/_editor/api/tasks/list",{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}}).then(n=>n.json())}async getStageTasks(t){return fetch(`/_editor/api/tasks/${t}`).then(e=>e.json())}async getSentStageTasks(t){return fetch(`/_editor/api/tasks/${t}/sent`).then(e=>e.json())}async updateTaskStatus(t,e){return fetch(`/_editor/api/tasks/${t}/status`,{method:"PUT",body:JSON.stringify({status:e}),headers:{"Content-Type":"application/json"}}).then(a=>a.json())}async clearAllTasks(){return fetch("/_editor/api/tasks/clear",{method:"DELETE"}).then(t=>t.json())}}class dt{projectId;constructor(t){this.projectId=t}async createTask(t,e,a){return await I.post(`projects/${this.projectId}/tasks`,{name:t,stageId:e,payload:a})}async getAllTasks(t,e){const a={offset:(t.currentIndex*t.pageSize).toString(),limit:t.pageSize.toString(),stageId:e.stage,status:e.status,startDate:e.startDate,endDate:e.endDate,payloadValue:e.payloadValue,payloadMatchCase:e.payloadMatchCase?"true":void 0,payloadMatchWholeWord:e.payloadMatchWholeWord?"true":void 0};return Object.keys(a).forEach(d=>a[d]===void 0&&delete a[d]),await I.get(`projects/${this.projectId}/tasks`,a)}async getStageTasks(t){const e={stageId:t,offset:"0",limit:"1000"};return await I.get(`projects/${this.projectId}/tasks`,e)}async getSentStageTasks(t){const e={sourceStageId:t,offset:"0",limit:"1000"};return await I.get(`projects/${this.projectId}/tasks`,e)}async updateTaskStatus(t,e){await I.patch(`projects/${this.projectId}/tasks/${t}`,{status:e})}async fetchStages(){throw new Error("Method not implemented.")}async fetchStatuses(){throw new Error("Method not implemented.")}async clearAllTasks(){throw new Error("Method not implemented.")}}const O=["pink","orange","green","blue","purple","red","cyan","magenta","volcano","gold"],lt=({api:c,poll:t,stageId:e,status:a,stages:n,initialFilters:d,onFilterChange:h})=>{const o=B({tasks:[],sentTasks:[],colorMap:new Map,pagination:{currentIndex:0,pageSize:10,totalCount:0},filters:{stage:e,status:a,dateRange:void 0,payload:{value:void 0,matchCase:!1,matchWholeWord:!1},...d},filterOptions:{stages:[],statuses:[{label:p.translate("i18n_tasksview_status_pending"),value:"pending"},{label:p.translate("i18n_tasksview_status_running"),value:"locked"},{label:p.translate("i18n_tasksview_status_completed"),value:"completed"}]}}),P=[{name:"setToPending",label:p.translate("i18n_tasksview_action_set_to_pending"),handler:()=>{o.tasks.filter(s=>s.checked).map(s=>s.id).forEach(s=>v(s))}},{name:"setToCompleted",label:p.translate("i18n_tasksview_action_set_to_completed"),handler:()=>{o.tasks.filter(s=>s.checked).map(s=>s.id).forEach(s=>E(s))}},{name:"duplicate",label:p.translate("i18n_tasksview_action_duplicate"),handler:()=>{o.tasks.filter(s=>s.checked).forEach(async s=>{await c.createTask(s.type,s.targetStageId,s.payload),l()})}}],x=q(["pending"]),D=i=>{const s=o.tasks.findIndex(r=>r.id===i.id);s!==-1?o.tasks[s]=i:o.tasks.unshift(i)},l=async()=>{const i={stage:o.filters.stage,status:o.filters.status,startDate:o.filters.dateRange?.[0]?.startOf("day").toISOString(),endDate:o.filters.dateRange?.[1]?.endOf("day").toISOString(),payloadValue:o.filters.payload.value,payloadMatchCase:o.filters.payload.matchCase,payloadMatchWholeWord:o.filters.payload.matchWholeWord},s=e?await c.getStageTasks(e):await c.getAllTasks(o.pagination,i);o.tasks=s.tasks.map(r=>({key:r.id,id:r.id,type:r.type,status:r.status,targetStageId:r.targetStageId,targetStageTitle:r.targetStageTitle,targetStageType:r.targetStageType,sourceStageTitle:r.sourceStageTitle,sourceStageType:r.sourceStageType,created:{at:new Date(r.created.at).toString(),byExecutionId:r.created.byExecutionId,byStageId:r.created.byStageId},locked:r.locked?{at:new Date(r.locked.at).toString(),byExecutionId:r.locked.byExecutionId,byStageId:r.locked.byStageId}:null,completed:r.completed?{at:new Date(r.completed.at).toString(),byExecutionId:r.completed.byExecutionId,byStageId:r.completed.byStageId}:null,payload:r.payload,checked:!1})),o.pagination.totalCount=s.totalCount},b=async()=>{if(!e)return[];const i=await c.getSentStageTasks(e);o.sentTasks=i.tasks.map(s=>({key:s.id,id:s.id,type:s.type,status:s.status,targetStageId:s.targetStageId,targetStageTitle:s.targetStageTitle,targetStageType:s.targetStageType,sourceStageTitle:s.sourceStageTitle,sourceStageType:s.sourceStageType,created:{at:new Date(s.created.at).toString(),byExecutionId:s.created.byExecutionId,byStageId:s.created.byStageId},locked:s.locked?{at:new Date(s.locked.at).toString(),byExecutionId:s.locked.byExecutionId,byStageId:s.locked.byStageId}:null,completed:s.completed?{at:new Date(s.completed.at).toString(),byExecutionId:s.completed.byExecutionId,byStageId:s.completed.byStageId}:null,payload:s.payload}))},j=()=>{let i=0;o.tasks.concat(o.sentTasks??[]).forEach(r=>{o.colorMap.has(r.type)||(o.colorMap.set(r.type,O[i]),i=(i+1)%O.length)})},$=async()=>{await Promise.all([l(),b()]),j(),h&&h(o.filters)};G(o.filters,$);const A=async()=>{await Promise.all([l(),b()]),j()},{startPolling:M,endPolling:W}=F({task:A,interval:15e3}),N=async()=>{if(await Promise.all([l(),b()]),j(),n===null){const i=Promise.all([g.list(),S.list(),T.list(),_.list()]).then(([s,r,k,u])=>[...s,...r,...k,...u]);o.filterOptions.stages=(await i).map(s=>({label:s.title,value:s.id}))}else o.filterOptions.stages=n.map(i=>({label:i.stageTitle,value:i.id}));t&&M()},J=()=>{t&&W()},v=async i=>{await c.updateTaskStatus(i,"pending"),l()},E=async i=>{await c.updateTaskStatus(i,"completed"),l()},R=i=>{o.tasks=o.tasks.map(s=>(s.id===i&&(s.checked=!s.checked),s))},U=()=>{const i=[],s=o.tasks.filter(u=>u.checked);return s.length===0?[]:(i.push("duplicate"),s.every(u=>u.status==="pending")&&i.push("setToCompleted"),s.every(u=>u.status==="completed")&&i.push("setToPending"),P.filter(u=>i.includes(u.name)))},L=async()=>{await c.clearAllTasks(),l(),b()},V=()=>[{title:p.translate("i18n_tasksview_column_date"),key:"timeInfo",align:"left",width:"25%"},{title:p.translate("i18n_tasksview_column_task"),key:"stageInfo",align:"left",width:"30%"},{title:p.translate("i18n_tasksview_column_payload"),key:"payloadInfo",align:"left",width:400}],z=K({api:c,fetchTasks:l});return{setup:N,tearDown:J,state:o,getColumns:V,collapseValue:x,setToPending:v,setToCompleted:E,fetchTasks:l,updateStatus:async(i,s)=>{o.tasks=o.tasks.map(r=>{if(r.id===i.id&&(r.status=s,s==="completed"&&!r.completed)){const k=new Date().toISOString();r.completed={at:k,byExecutionId:"",byStageId:""}}return r}),await c.updateTaskStatus(i.id,s),l()},fetchSentTasks:b,checkTask:R,getPossibleActions:U,clearAllTasks:L,insertOrUpdate:D,...z}};export{g as F,S as H,T as J,ct as L,dt as R,_ as S,lt as T};
//# sourceMappingURL=tasksController-DFU1kwoS.js.map
