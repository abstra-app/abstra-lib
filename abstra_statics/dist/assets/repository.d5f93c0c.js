import{f as s,eG as ue,eP as he,r as ce,H as de,F as ke,d as M,b as l,c,w as t,ev as v,eC as P,ar as y,eD as k,u as e,cN as be,a$ as F,cF as K,v as Y,ex as h,bv as Se,eK as pe,e as z,eJ as V,b3 as we,cn as fe,eE as Ae,eF as Re,o as xe,L as Oe,a as Ce,ae as U,dm as De,cE as G,bV as se}from"./outputWidgets.108432da.js";import{a as _e}from"./asyncComputed.9818a09a.js";import{A as Ie,s as J}from"./api.405902d9.js";import{t as Pe}from"./ant-design.4dbd5b92.js";import{A as B}from"./Text.1a62e50a.js";import"./index.b565aa80.js";import{A as O}from"./index.3d290fbb.js";import{r as Fe,t as $e}from"./icons.9db31d3d.js";import{A as ge}from"./index.5578279a.js";import{f as Ee}from"./index.4c02e6d4.js";import{A as re}from"./Paragraph.d17409a8.js";import{A as q}from"./Title.98d4c800.js";import"./index.a69ef063.js";import{T as Te,A as Ne}from"./Timeline.49e21f60.js";import{A as ye,C as me}from"./CollapsePanel.bcc98d2c.js";import{A as Le}from"./Link.7230a499.js";import{A as ve}from"./index.ecee7129.js";import{A as je}from"./index.0672361b.js";import{A as Ve}from"./contracts.generated.428c81da.js";import"./workspaces.60095db4.js";import{S as qe}from"./scripts.3b10c996.js";import"./envVars.be0f1165.js";import{F as Ke,A as Be}from"./Form.a76f1164.js";import{E as ze}from"./ExpandOutlined.8cd5516d.js";import{C as Me}from"./Card.2be0ab03.js";(function(){try{var n=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},a=new Error().stack;a&&(n._sentryDebugIds=n._sentryDebugIds||{},n._sentryDebugIds[a]="31694fc4-7527-4fc9-9d28-c165b2297d16",n._sentryDebugIdIdentifier="sentry-dbid-31694fc4-7527-4fc9-9d28-c165b2297d16")}catch{}})();var Ue={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM641.7 520.8L442.3 677.6c-7.4 5.8-18.3.6-18.3-8.8V355.3c0-9.4 10.9-14.7 18.3-8.8l199.4 156.7a11.2 11.2 0 010 17.6z"}}]},name:"play-square",theme:"filled"};const Ge=Ue;function le(n){for(var a=1;a<arguments.length;a++){var o=arguments[a]!=null?Object(arguments[a]):{},r=Object.keys(o);typeof Object.getOwnPropertySymbols=="function"&&(r=r.concat(Object.getOwnPropertySymbols(o).filter(function(i){return Object.getOwnPropertyDescriptor(o,i).enumerable}))),r.forEach(function(i){He(n,i,o[i])})}return n}function He(n,a,o){return a in n?Object.defineProperty(n,a,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[a]=o,n}var Z=function(a,o){var r=le({},a,o.attrs);return s(ue,le({},r,{icon:he}),null)};Z.displayName="DownOutlined";Z.inheritAttrs=!1;const Je=Z;function oe(n){for(var a=1;a<arguments.length;a++){var o=arguments[a]!=null?Object(arguments[a]):{},r=Object.keys(o);typeof Object.getOwnPropertySymbols=="function"&&(r=r.concat(Object.getOwnPropertySymbols(o).filter(function(i){return Object.getOwnPropertyDescriptor(o,i).enumerable}))),r.forEach(function(i){We(n,i,o[i])})}return n}function We(n,a,o){return a in n?Object.defineProperty(n,a,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[a]=o,n}var Q=function(a,o){var r=oe({},a,o.attrs);return s(ue,oe({},r,{icon:Ge}),null)};Q.displayName="PlaySquareFilled";Q.inheritAttrs=!1;const ie=Q;function X(n){switch(n.status){case"waiting":return{color:"blue",text:"Waiting"};case"running":return{color:"processing",text:"Running"};case"finished":return{color:"success",text:"Success"};case"failed":return{color:"error",text:"Failed"};case"abandoned":return{color:"warning",text:"Abandoned"}}}function Ye(){const n=ce({state:"closed"});function a(){n.value={state:"closed"}}function o(){n.value={state:"visualizations"}}function r($,S){n.value={state:"stage-run",stageRun:S}}const i=de(()=>"stageRun"in n.value?n.value.stageRun:null);return{closeDrawer:a,openVisualizationEditor:o,inspectStageRun:r,drawerState:n,selectedStageRunForDrawer:i}}const H="kanban-selected-stage-ids",L=10;function Ze({kanbanRepository:n,storage:a,filterFactory:o}){const r=ke([]),i=_e(async()=>{try{return await n.getData({selection:r.value,filter:o()})}catch{return r.value=[],await a.set(H,[]),{columns:[],next_stage_options:[]}}});function $(d){const u=d.selected_stage.id,_=r.value.find(A=>A.stage_id===u);return _!=null&&_.limit?_.limit<d.total_count:!1}async function S(d){var _;const u=r.value.find(A=>A.stage_id===d);u&&(u.limit=((_=u.limit)!=null?_:0)+L,await i.refetch())}async function f(d){const u=r.value.find(_=>_.stage_id===d);u&&u.limit&&u.limit>L&&(u.limit-=L,await i.refetch())}async function w(){const d=await a.get(H)||[];r.value=d.map(u=>({stage_id:u,limit:L,offset:0}))}async function m(d,u){d?r.value=[...r.value.slice(0,u),{stage_id:d,limit:L,offset:0}]:r.value=r.value.slice(0,u),await a.set(H,r.value.map(_=>_.stage_id)),await i.refetch()}function E(d,u){var R;const _=(R=d.stages)==null?void 0:R.find(T=>T.id===d.selected_stage.id);if((_==null?void 0:_.type)!=="form")return null;const A=(u==null?void 0:u.status)==="waiting"?{[Ie]:u.id}:{};return{path:`/${_.path}`,query:A}}let D=null;const b=async()=>{await w(),i.refetch(),D=setInterval(()=>{i.refetch()},1e3)},C=()=>{D&&clearInterval(D)},I=de(()=>{var u,_,A;const d=(_=(u=i.result.value)==null?void 0:u.columns)!=null?_:[];return(A=d[d.length-1])==null?void 0:A.selected_stage});return{kanbanAsyncComputed:i,selection:r,seeMore:S,hasPagination:$,seeLess:f,setNewSelectedStageId:m,launchLink:E,lastSelectedStage:I,setup:b,tearDown:C}}const W=M({__name:"StageRunData",props:{data:{}},setup(n){return(a,o)=>(l(),c(e(K),{direction:"vertical",style:{"max-height":"200px",overflow:"hidden"}},{default:t(()=>[(l(!0),v(F,null,P(a.data,r=>(l(),v("div",{key:r.key},[s(e(B),{strong:""},{default:t(()=>[y(k(r.key),1)]),_:2},1024),s(e(be),{"tree-data":e(Pe)(r.value),style:{"pointer-events":"none"}},null,8,["tree-data"])]))),128))]),_:1}))}}),Qe={key:0},Xe={key:1,class:"terminal"},et=M({__name:"ExecutionInspector",props:{logs:{}},setup(n){return(a,o)=>a.logs.length===0?(l(),v("span",Qe)):(l(),v("div",Xe,[s(e(O),{vertical:""},{default:t(()=>[(l(!0),v(F,null,P(a.logs,r=>(l(),v("pre",{key:r.executionId,class:"log-text"},k(r.payload.text),1))),128))]),_:1})]))}});const tt=Y(et,[["__scopeId","data-v-032cbeba"]]),at=n=>(Ae("data-v-e10d3de6"),n=n(),Re(),n),nt={key:1},st={key:1},rt=at(()=>z("span",null,"[Deleted Stage]",-1)),lt=["onClick"],ot=M({__name:"StageRunInspector",props:{stageRun:{},kanbanRepository:{},stageRunRepository:{}},emits:["close"],setup(n,{emit:a}){const o=n;function r(f){return Object.entries(f).map(([w,m])=>({key:w,value:m,type:typeof m}))}const{result:i,loading:$}=_e(()=>{var f;return o.kanbanRepository.getLogs((f=o.stageRun)==null?void 0:f.id)}),S=(f,w)=>{var m;f.stopPropagation(),(m=o.stageRunRepository)==null||m.fork(w),a("close")};return(f,w)=>(l(),c(e(je),{open:"",title:"Thread details",size:"large",onClose:w[0]||(w[0]=m=>a("close"))},{extra:t(()=>[s(e(re),null,{default:t(()=>[s(e(ge),{style:{"font-weight":"600"}},{default:t(()=>{var m;return[y(k(e(X)({status:(m=f.stageRun)==null?void 0:m.status}).text),1)]}),_:1}),y(" "+k(e(Ee)(new Date(f.stageRun.created_at),{addSuffix:!0})),1)]),_:1})]),default:t(()=>{var m,E,D;return[(m=f.stageRun)!=null&&m.assignee?(l(),c(e(re),{key:0},{default:t(()=>{var b;return[y(" Assignee: "+k((b=f.stageRun)==null?void 0:b.assignee),1)]}),_:1})):h("",!0),((E=f.stageRun)==null?void 0:E.content)&&((D=f.stageRun)==null?void 0:D.content.length)>0?(l(),v("div",nt,[s(e(q),{level:4},{default:t(()=>[y("Current data")]),_:1}),s(W,{data:f.stageRun.content},null,8,["data"])])):h("",!0),s(e(q),{level:4,style:{"margin-bottom":"30px"}},{default:t(()=>[y(" Timeline ")]),_:1}),e($)?(l(),c(e(Se),{key:2})):e(i)?(l(),c(e(Te),{key:3},{default:t(()=>[(l(!0),v(F,null,P(e(i),({stage:b,stage_run:C,logs:I})=>(l(),c(e(Ne),{key:C.id},{default:t(()=>[s(e(me),{ghost:"","expand-icon-position":"end"},{default:t(()=>[s(e(ye),{class:"panel"},pe({header:t(()=>[b?(l(),c(e(O),{key:0,align:"center",gap:15},{default:t(()=>[s(V,{path:e(J)(b.type)},null,8,["path"]),I.length?(l(),v("span",st,k(b.title),1)):(l(),c(e(we),{key:0,placement:"right",title:"No logs"},{default:t(()=>[y(k(b.title),1)]),_:2},1024))]),_:2},1024)):(l(),c(e(O),{key:1,align:"center",gap:15},{default:t(()=>[s(V,{path:e($e)},null,8,["path"]),rt]),_:1}))]),default:t(()=>[r(C.data).length||I.length?(l(),c(e(O),{key:0,vertical:""},{default:t(()=>[r(C.data).length?(l(),c(e(O),{key:0,gap:0,vertical:""},{default:t(()=>[s(e(q),{level:5},{default:t(()=>[y(" Output data ")]),_:1}),s(W,{data:r(C.data)},null,8,["data"])]),_:2},1024)):h("",!0),I.length?(l(),c(e(O),{key:1,vertical:"",gap:0},{default:t(()=>[s(e(ve)),s(e(q),{level:5},{default:t(()=>[y(" Logs ")]),_:1}),s(tt,{logs:I},null,8,["logs"])]),_:2},1024)):h("",!0)]),_:2},1024)):(l(),c(e(fe),{key:1,description:"No logs"}))]),_:2},[f.stageRunRepository&&b?{name:"extra",fn:t(()=>[z("span",{onClick:d=>S(d,C.id)},[s(e(O),{gap:"small"},{default:t(()=>[s(V,{path:e(Fe),width:"22"},null,8,["path"]),s(e(Le),null,{default:t(()=>[y("Fork")]),_:1})]),_:1})],8,lt)]),key:"0"}:void 0]),1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):h("",!0)]}),_:1}))}});const it=Y(ot,[["__scopeId","data-v-e10d3de6"]]),j="Show All",ut=[j,...Ve];function ct(){const n=ce(j);return{filterStatus:n,filterFactory:()=>n.value==j?{}:{status:n.value},labelOption:r=>r==j?j:X({status:r}).text}}const dt={style:{width:"100%",padding:"20px"}},pt={class:"stages-container"},ft={class:"stages-content"},_t=["onClick"],gt=M({__name:"Kanban",props:{storage:{},kanbanRepository:{},stageRunRepository:{}},setup(n){const a=n,o=async(A,R,T)=>{A.stopPropagation();const x=await qe.get(R);!x||await x.run(T)},{filterFactory:r,filterStatus:i,labelOption:$}=ct(),{kanbanAsyncComputed:S,launchLink:f,setNewSelectedStageId:w,lastSelectedStage:m,setup:E,tearDown:D,seeMore:b,hasPagination:C}=Ze({kanbanRepository:a.kanbanRepository,storage:a.storage,filterFactory:r});xe(E),Oe(D);const{closeDrawer:I,inspectStageRun:d,drawerState:u,selectedStageRunForDrawer:_}=Ye();return(A,R)=>{const T=Ce("router-link");return l(),v("div",dt,[s(e(O),{vertical:"",style:{height:"100%"}},{default:t(()=>[s(e(me),{ghost:""},{default:t(()=>[s(e(ye),{header:"Filters"},{default:t(()=>[s(e(Ke),null,{default:t(()=>[s(e(Be),{label:"Status"},{default:t(()=>[s(e(U),{value:e(i),"onUpdate:value":R[0]||(R[0]=x=>De(i)?i.value=x:null),style:{width:"300px"}},{default:t(()=>[(l(!0),v(F,null,P(e(ut),x=>(l(),c(e(G),{key:x,value:x},{default:t(()=>[y(k(e($)(x)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),z("div",pt,[z("div",ft,[s(e(K),{align:"start"},{default:t(()=>{var x,ee,te;return[(l(!0),v(F,null,P((ee=(x=e(S).result.value)==null?void 0:x.columns)!=null?ee:[],(p,ae)=>(l(),c(e(K),{key:ae,direction:"vertical"},{default:t(()=>[s(e(U),{style:{width:"250px"},"allow-clear":"",value:p.selected_stage.id,"onUpdate:value":g=>e(w)(g,ae)},{suffixIcon:t(()=>[s(e(B),{type:"secondary",style:{"font-size":"small","margin-right":"2px"}},{default:t(()=>[y(k(p.total_count),1)]),_:2},1024),s(e(ve),{type:"vertical"}),s(e(Je))]),default:t(()=>[(l(!0),v(F,null,P(p.stages,g=>(l(),c(e(G),{key:g.id,value:g.id},{default:t(()=>[s(e(O),{gap:"5"},{default:t(()=>[s(V,{path:e(J)(g.type),style:{"flex-shrink":"0"}},null,8,["path"]),s(e(B),{ellipsis:""},{default:t(()=>[y(k(g.title),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"]),p.selected_stage.id?(l(),c(e(K),{key:0,direction:"vertical",style:{width:"100%"}},{default:t(()=>[(l(!0),v(F,null,P(p.stage_run_cards,g=>{var ne;return l(),c(e(Me),{key:g.id,size:"small",style:{"max-width":"250px",cursor:"pointer"},"body-style":{display:((ne=g.content)==null?void 0:ne.length)>0?"block":"none"},onClick:N=>e(d)(p,g)},pe({title:t(()=>[s(e(ge),null,{default:t(()=>[y(k(e(X)({status:g.status}).text),1)]),_:2},1024)]),default:t(()=>[s(W,{data:g.content},null,8,["data"]),y(" "+k(g.assignee),1)]),extra:t(()=>[s(e(ze),{onClick:N=>e(d)(p,g)},null,8,["onClick"])]),_:2},[g.status==="waiting"?{name:"actions",fn:t(()=>[e(f)(p,g)?(l(),c(T,{key:0,to:e(f)(p,g),target:"_blank",onClick:R[1]||(R[1]=N=>N.stopPropagation())},{default:t(()=>[s(e(ie))]),_:2},1032,["to"])):h("",!0),p.selected_stage.type==="script"?(l(),v("span",{key:1,onClick:N=>o(N,p.selected_stage.id,g.id)},[s(e(ie))],8,_t)):h("",!0)]),key:"0"}:void 0]),1032,["body-style","onClick"])}),128)),p.stage_run_cards.length===0?(l(),c(e(fe),{key:0})):h("",!0),e(C)(p)?(l(),c(e(se),{key:1,style:{width:"100%"},onClick:g=>e(b)(p.selected_stage.id)},{default:t(()=>[y("See more")]),_:2},1032,["onClick"])):h("",!0),p.selected_stage.can_be_started&&e(f)(p)!==null?(l(),c(T,{key:2,target:"_blank",to:e(f)(p)},{default:t(()=>[s(e(se),{style:{width:"100%"}},{default:t(()=>[y(" Start ")]),_:1})]),_:2},1032,["to"])):h("",!0)]),_:2},1024)):h("",!0)]),_:2},1024))),128)),e(S).result.value&&e(S).result.value.next_stage_options.length>0?(l(),c(e(U),{key:(te=e(m))==null?void 0:te.id,style:{width:"100%","min-width":"200px"},"allow-clear":"","onUpdate:value":R[2]||(R[2]=p=>e(w)(p,e(S).result.value.columns.length))},{default:t(()=>[(l(!0),v(F,null,P(e(S).result.value.next_stage_options,p=>(l(),c(e(G),{key:p.id,value:p.id},{default:t(()=>[s(e(O),{gap:"middle"},{default:t(()=>[s(V,{path:e(J)(p.type)},null,8,["path"]),s(e(B),null,{default:t(()=>[y(k(p.title),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["value"]))),128))]),_:1})):h("",!0)]}),_:1})])])]),_:1}),e(u).state==="stage-run"&&e(_)?(l(),c(it,{key:0,"kanban-repository":a.kanbanRepository,"stage-run":e(_),"stage-run-repository":a.stageRunRepository,onClose:e(I)},null,8,["kanban-repository","stage-run","stage-run-repository","onClose"])):h("",!0)])}}});const Kt=Y(gt,[["__scopeId","data-v-4134843d"]]);class Bt{constructor(a,o=localStorage){this.contextKey=a,this.storage=o}makeKey(a){return`${this.contextKey}:${a}`}async get(a){const o=this.storage.getItem(this.makeKey(a));return o?JSON.parse(o):null}async set(a,o){this.storage.setItem(this.makeKey(a),JSON.stringify(o))}}export{Kt as K,Bt as L};
//# sourceMappingURL=repository.d5f93c0c.js.map
