var ke=Object.defineProperty;var be=(o,e,t)=>e in o?ke(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var I=(o,e,t)=>(be(o,typeof e!="symbol"?e+"":e,t),t);import{u as te}from"./uuid.93a55bf4.js";import{F as pe,d as z,r as m,S as ae,G as Q,b as v,ev as E,e as u,ez as P,eE as he,eF as fe,v as Z,eB as Ee,H as se,a3 as ve,o as ge,K as _e,a as me,f,u as i,I as N,aq as C,eD as V,ex as D,ew as Se,bq as oe,eC as Me,c as W,eP as Ie,eV as xe,eI as De,w as p,bH as ye,E as Y,bO as J,br as ee}from"./outputWidgets.6ccbc4ef.js";import{k as ie,l as le,n as re,o as Oe,q as Re,u as Fe}from"./icons.82dddcb2.js";import{l as Ae}from"./NavbarControls.eb082505.js";import{H as Be,J as We,v as $e,n as He}from"./validations.78a90ce9.js";import{S as Pe}from"./scripts.c40c3624.js";import{A as Ce}from"./FormItem.2f8cfa6a.js";import{W as Te}from"./workspaces.45b49dc8.js";import{a as ce}from"./asyncComputed.4b57594c.js";import{l as Le,e as G,R as Ne}from"./toggleHighContrast.6bd10bf6.js";import{A as ue}from"./index.45b7cc0d.js";import{A as Ve}from"./index.0434f529.js";import{C as ze}from"./Card.e43cee13.js";(function(){try{var o=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(o._sentryDebugIds=o._sentryDebugIds||{},o._sentryDebugIds[e]="54d053fa-e705-4c69-801d-7f653685a012",o._sentryDebugIdIdentifier="sentry-dbid-54d053fa-e705-4c69-801d-7f653685a012")}catch{}})();class we{constructor(){I(this,"logState",pe({log:[]}));I(this,"_listeners",{})}static create(){return new we}get logs(){return this.logState.log}log(e,t){if(e.type!=="restart"&&e.log.trim()==="")return;const s=t?this.logs.find(l=>l.id===t):null;return s?Object.assign(s,e):this.logs.push({...e,id:t||te()}),this.notifyListeners(e),t}clear(){this.logState.log=[]}listen(e){const t=te();return this._listeners[t]=e,t}unlisten(e){delete this._listeners[e]}notifyListeners(e){Object.values(this._listeners).forEach(t=>t(e))}}class Ke{static async*sendMessage(e,t){var c;const l=(c=(await fetch("/_editor/api/ai/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:e,runtime:t})})).body)==null?void 0:c.getReader();if(!l)throw new Error("No response body");for(;;){const h=await l.read();if(h.done)break;yield new TextDecoder().decode(h.value)}}}const qe=o=>(he("data-v-59ca7295"),o=o(),fe(),o),Ue=qe(()=>u("div",{class:"text"}," Changes were made in your code. Click Restart to refresh the preview window. ",-1)),de="ignoreCodeChangesWarning",je=z({__name:"ChangesWarning",props:{hasChanges:{type:Boolean}},setup(o){var c;const e=o,t=m((c=ae.get(de))!=null?c:!1),s=Q(()=>e.hasChanges&&!t.value),l=()=>{ae.set(de,!0),t.value=!0};return(h,O)=>(v(),E("div",{class:P(["changes-warning",{visible:s.value}])},[Ue,u("div",{class:"no-more-alert",onClick:l},"Do not show again")],2))}});const Je=Z(je,[["__scopeId","data-v-59ca7295"]]),Ye=o=>(he("data-v-9d2d7cb6"),o=o(),fe(),o),Ge={class:"smart-console"},Qe={class:"header"},Xe={class:"left"},Ze={class:"right"},et={class:"changes-container"},tt=["unseen-severity"],st={class:"cli"},ot={class:"left"},nt=Ye(()=>u("div",{class:"entry ai-output"}," Hello there! I'm both an output console and AI assistant. You can ask me anything. ",-1)),at={key:1,class:"local-entry"},it={class:"input"},lt=["pointer-events","onKeydown"],rt={class:"right"},ct=z({__name:"SmartConsole",props:{inputEnabled:{type:Boolean},formCode:{},runtime:{},logService:{}},emits:["eval-request","clear-terminal","restart","enter"],setup(o,{emit:e}){const t=o,s=m(""),l=m(null),c=Ee(),h=m({type:"seen"}),O=m(!1),R=m(!1),A=()=>{S.value=S.value==="assistant"?"debugger":"assistant"};function F(d){switch(d.type){case"ai-input":return{role:"user",content:d.log};case"ai-output":return{role:"assistant",content:d.log};case"stderr":case"stdout":return{role:"user",content:d.log};case"restart":return{role:"user",content:"-- new session --"};case"files-changed":return{role:"user",content:"-- files changed --"};default:throw new Error(`Unknown log type: ${d.type}`)}}const y=Q(()=>t.logService.logs.some(d=>d.type==="files-changed"));function x(){w.value=!w.value,w.value&&(h.value={type:"seen"})}se(c,()=>{t.logService.clear(),e("clear-terminal")});const g=m(null),S=m("assistant"),T=async d=>{var n;if(d.preventDefault(),s.value=((n=g.value)==null?void 0:n.innerText)||"",d.shiftKey){document.execCommand("insertLineBreak");return}g.value&&(g.value.innerText=""),S.value==="assistant"?await $():await M()},$=async()=>{var n;if(e("enter",s.value),t.logService.log({type:"ai-input",log:s.value}),s.value="",!R.value){t.logService.log({type:"stderr",log:"Please login to use the AI assistant."});return}O.value=!0;const d={role:"user",content:(n=t.formCode)!=null?n:""};try{const a=te();let _="";const k=Ke.sendMessage([d,...t.logService.logs.map(b=>F(b)),{role:"user",content:s.value}],t.runtime);for await(const b of k)_+=b,t.logService.log({type:"ai-output",log:_},a)}catch(a){t.logService.log({type:"ai-output",log:"Sorry, I don't know how to answer that."}),console.error(a),xe(a)}finally{O.value=!1}},M=async()=>{s.value&&(t.logService.log({type:"eval-input",log:`>>> ${s.value}`}),e("eval-request",s.value),s.value="")},L=()=>{t.logService.clear()};t.logService.listen(async d=>{w.value||(h.value={type:"unseen",count:h.value.type==="unseen"?h.value.count+1:1,severity:d.type==="stderr"?"error":"info"}),d.type!=="restart"&&(await ve(),l.value&&(l.value.scrollTop=l.value.scrollHeight))});const w=m(!1),K=m(400),r=Q(()=>({height:`${K.value}px`})),H=m(!1),q=()=>H.value=!0,U=d=>{!H.value||(K.value=document.body.clientHeight-d.clientY)},j=()=>H.value=!1;return ge(()=>{document.addEventListener("mousemove",U),document.addEventListener("mouseup",j),Ae.get().then(d=>{R.value=!!d.logged})}),_e(()=>{document.removeEventListener("mousemove",U),document.removeEventListener("mouseup",j)}),(d,n)=>{const a=me("Markdown");return v(),E("div",Ge,[u("div",Qe,[u("div",Xe,[f(N,{path:S.value==="assistant"?i(ie):i(le)},null,8,["path"]),C(" Smart Console ")]),u("div",Ze,[u("div",et,[f(Je,{"has-changes":y.value},null,8,["has-changes"])]),u("div",{class:"toggle-button",onClick:x},[f(N,{class:P(["icon",{open:w.value}]),path:i(re),fill:"#fff"},null,8,["class","path"]),h.value.type==="unseen"?(v(),E("div",{key:0,class:"unseen-count","unseen-severity":h.value.severity},V(h.value.count),9,tt)):D("",!0)])])]),w.value?(v(),E("div",{key:0,class:"terminal",style:Se(r.value)},[u("div",{class:"resize-handler",onMousedown:q},null,32),u("div",st,[u("div",ot,[u("div",{ref_key:"entriesContainer",ref:l,class:"entries"},[nt,(v(!0),E(oe,null,Me(t.logService.logs,(_,k)=>(v(),E("div",{key:k,class:P([_.type,"entry"])},[_.type==="ai-output"?(v(),W(a,{key:0,source:_.log},null,8,["source"])):(v(),E("div",at,V(_.type==="restart"?"-- restarted --":_.log),1))],2))),128))],512),u("div",it,[f(N,{class:P(["icon",{open:w.value}]),path:i(re)},null,8,["class","path"]),u("div",{ref_key:"inputRef",ref:g,class:"input-text",contenteditable:"","pointer-events":O.value?"none":"auto",placeholder:"Ask AI anything",onKeydown:Ie(T,["enter"])},null,40,lt)])]),u("div",rt,[u("div",{class:"icons",onClick:L},[f(N,{class:"icon",path:i(Oe)},null,8,["path"])]),u("div",null,[f(N,{class:"icon clickable",path:S.value==="assistant"?i(ie):i(le),onClick:n[0]||(n[0]=_=>A())},null,8,["path"])])])])],4)):D("",!0)])}}});const At=Z(ct,[["__scopeId","data-v-9d2d7cb6"]]),ut=z({__name:"PathInput",props:{runtime:{}},setup(o){const e=o,t=m(!1),s=async()=>{t.value=!0;const c=await(await fetch("/_editor/api/utils/normalize_path",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e.runtime.path})})).text();c&&c!==e.runtime.path&&(e.runtime.path=c),t.value=!1};return(l,c)=>(v(),W(i(ye),{value:l.runtime.path,"onUpdate:value":c[0]||(c[0]=h=>l.runtime.path=h),type:"text",disabled:t.value,onBlur:s},De({_:2},[l.runtime instanceof i(Be)?{name:"addonBefore",fn:p(()=>[C(" https://[your-subdomain].abstra.app/_hooks/ ")]),key:"0"}:{name:"addonBefore",fn:p(()=>[C(" https://[your-subdomain].abstra.app/ ")]),key:"1"}]),1032,["value","disabled"]))}}),dt={key:1},pt=z({__name:"RuntimeCommonSettings",props:{runtime:{}},setup(o){const e=pe({pathError:null});return(t,s)=>(v(),E(oe,null,[t.runtime instanceof i(We)||t.runtime instanceof i(Pe)?D("",!0):(v(),W(i(Ce),{key:0,label:"URL path"},{default:p(()=>[f(ut,{runtime:t.runtime},null,8,["runtime"])]),_:1})),e.pathError?(v(),E("div",dt,V(e.pathError),1)):D("",!0)],64))}});const Bt=Z(pt,[["__scopeId","data-v-60a397e0"]]);let X={};function ht(o){return o in X?"\n\n```python\n"+o+" = "+X[o]+"\n```":""}Le.registerHoverProvider("python",{provideHover:function(o,e){const t=o.getWordAtPosition(e);if(!!t)return{contents:[{value:ht(t.word)}]}}});const ft=(o,e,t={})=>{var F;const s=G.create(o,{language:"python",value:e,minimap:{enabled:!1},readOnly:(F=t.readOnly)!=null?F:!1,contextmenu:!t.readOnly,automaticLayout:!t.readOnly,tabSize:4,fixedOverflowWidgets:!0,theme:t.theme?t.theme:"vs",fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:t.readOnly?0:5,scrollBeyondLastLine:!t.readOnly,renderLineHighlight:t.readOnly?"none":"all",scrollbar:{useShadows:!1,alwaysConsumeMouseWheel:!1}}),l=s.getContribution("editor.contrib.messageController");s.onDidAttemptReadOnlyEdit(()=>{l.showMessage("Cannot edit during preview execution",s.getPosition())});const c=s.createDecorationsCollection([]),h=(y,x)=>{c.set(y.map(g=>({range:new Ne(g.lineno,1,g.lineno,1),options:{isWholeLine:!0,className:x}}))),X=y.reduce((g,S)=>({...g,...S.locals}),{})};return{editor:s,highlight:(y,x)=>g=>{var $,M;const T=((M=($=g.debug)==null?void 0:$.stack)!=null?M:[]).filter(L=>L.filename.endsWith(x));h(T,y)},clearHighlights:()=>{c.clear(),X={}},setReadOnly:y=>{s.updateOptions({readOnly:y})}}},vt=(o,e,t)=>{const s=G.createModel(e),l=G.createModel(t),c=G.createDiffEditor(o,{minimap:{enabled:!1},readOnly:!0,contextmenu:!1,automaticLayout:!0,renderWhitespace:"none",guides:{indentation:!1},fontFamily:"monospace",lineNumbers:"on",scrollBeyondLastColumn:0,scrollBeyondLastLine:!1,renderLineHighlight:"none"});return c.setModel({original:s,modified:l}),{diffEditor:c}};class gt{constructor(e,t){I(this,"_script");I(this,"_localEditorCode");I(this,"_monacoEditor");I(this,"_diffEditor");I(this,"_viewMode");I(this,"_alertMessage");I(this,"_conflictingChanges");this._localEditorCode=e,this._script=t,this._monacoEditor=null,this._diffEditor=null,this._viewMode=Y("editor"),this._alertMessage=Y(""),this._conflictingChanges=Y(!1)}get alertMessage(){return this._alertMessage.value}set alertMessage(e){this._alertMessage.value=e}get conflictingChanges(){return this._conflictingChanges.value}set conflictingChanges(e){this._conflictingChanges.value=e}get viewMode(){return this._viewMode.value}set viewMode(e){this._viewMode.value=e}get abstraIDECode(){return this._script.codeContent}get localEditorCode(){return this._localEditorCode}set monacoEditor(e){this._monacoEditor=e}set diffEditor(e){this._diffEditor=e}finishPreview(){var e;this._viewMode.value="editor",this._script.codeContent=this._localEditorCode,(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.save("code_content"),this._script.updateInitialState("code_content",this._localEditorCode),this.alertMessage=""}updateCodeWhileEditing(e){var l;const t=e!==this._localEditorCode;if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1;return}const s=!this._script.hasChanges("code_content");if(s){(l=this._monacoEditor)==null||l.setValue(e),this._script.codeContent=e,this._script.updateInitialState("code_content",e);return}if(!s&&t){this.alertMessage="You have conflicting changes with your local editor code",this.conflictingChanges=!0;return}}updateCodeWhileDiff(e){var t,s;if(e===this._script.codeContent){this.alertMessage="",this.conflictingChanges=!1,this.viewMode="editor",this._localEditorCode=e;return}if(e!==this._localEditorCode){(s=(t=this._diffEditor)==null?void 0:t.getModel())==null||s.modified.setValue(e),this._localEditorCode=e;return}}updateCodeWhilePreview(e){if(this._localEditorCode=e,e===this._script.codeContent){this.alertMessage="";return}this.alertMessage="The changes on your code will be shown after the preview stops running"}updateCode(e){switch(this._viewMode.value){case"editor":return this.updateCodeWhileEditing(e);case"diff":return this.updateCodeWhileDiff(e);case"preview":return this.updateCodeWhilePreview(e)}}keepAbstraIDECode(){var e;(e=this._monacoEditor)==null||e.setValue(this._script.codeContent),this._script.save("code_content"),this._script.updateInitialState("code_content",this._script.codeContent),this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}keepLocalEditor(){var e;(e=this._monacoEditor)==null||e.setValue(this._localEditorCode),this._script.updateInitialState("code_content",this._localEditorCode),this.conflictingChanges=!1,this.alertMessage="",this.viewMode="editor"}}const _t={class:"container"},mt=z({__name:"SourceCode",props:{script:{},workspace:{},broker:{}},emits:["update-file"],setup(o,{expose:e,emit:t}){const s=o,l=()=>{!s.script.file||s.workspace.openFile(s.script.file)},c=()=>{r.value.viewMode="diff",j()},h=m(null),O=m(null);let R,A,F,y;const{result:x}=ce(()=>fetch("/_editor/api/workspace/root").then(n=>n.text())),g=m(s.script.file);se(()=>s.script.file,()=>g.value=s.script.file);const{result:S,refetch:T}=ce(()=>Te.checkFile(g.value)),$=()=>{M.value.valid?t("update-file",He(g.value)):t("update-file",g.value),T()},M=Q(()=>{var a;const n=$e(g.value);return n.valid?((a=S.value)==null?void 0:a.exists)&&s.script.hasChanges("file")?{valid:!0,help:"This file already exists"}:s.script.hasChanges("file")?{valid:!0,help:"The original file will be renamed"}:n:n}),L=()=>{!s.workspace||!x.value||s.workspace.openFile(".")},w=m(!1),K=async()=>{var a;if(!s.script.file)return;const n=await s.workspace.readFile(s.script.file);if(n===null){w.value=!0;return}w.value=!1,(a=r.value)==null||a.updateCode(n)},r=Y(null);let H;ge(()=>{r.value=new gt(s.script.codeContent,s.script),H=setInterval(K,1e3),U()}),_e(()=>{clearInterval(H)}),se(()=>s.broker,()=>{A(),q()});const q=()=>{var n,a,_;(n=s.broker)==null||n.on("start",()=>{y(!0),r.value.viewMode="preview"}),(a=s.broker)==null||a.on("form",F("executing-line",s.script.file)),(_=s.broker)==null||_.on("program:end",k=>{var b;(b=r.value)==null||b.finishPreview(),y(!1),k.exception?F("error-line",s.script.file)(k):A()})},U=async()=>{await ve(),s.workspace.readFile(s.script.file).then(n=>{if(n===null)return;const a=ft(h.value,n);A=a.clearHighlights,F=a.highlight,y=a.setReadOnly,q(),R=a.editor,r.value.monacoEditor=R,R.onDidChangeModelContent(()=>{s.script.codeContent=R.getValue()})})},j=async()=>{var k,b;const n=(k=r.value)==null?void 0:k.localEditorCode,a=(b=r.value)==null?void 0:b.abstraIDECode,_=vt(O.value,a,n);r.value.diffEditor=_.diffEditor};return e({restartEditor:()=>{var n;A(),y(!1),(n=r.value)==null||n.finishPreview()}}),(n,a)=>{var k,b,ne;const _=me("icon");return v(),E(oe,null,[f(i(Ce),{"validate-status":M.value.valid?"success":"error",help:M.value.valid?M.value.help:M.value.reason},{default:p(()=>[f(i(ye),{value:n.script.file,"onUpdate:value":a[0]||(a[0]=B=>n.script.file=B),onBlur:$},{addonBefore:p(()=>[i(x)?(v(),E("span",{key:0,class:"clickable",onClick:L},[f(_,{path:i(Re)},null,8,["path"]),u("span",null,V(i(x)),1)])):D("",!0)]),addonAfter:p(()=>[u("span",{class:"clickable",onClick:l},[C(" Open in editor "),f(_,{path:i(Fe),width:"22"},null,8,["path"])])]),_:1},8,["value"])]),_:1},8,["validate-status","help"]),(k=r.value)!=null&&k.alertMessage?(v(),W(i(Ve),{key:0,type:"warning","show-icon":""},{message:p(()=>{var B;return[C(V((B=r.value)==null?void 0:B.alertMessage),1)]}),action:p(()=>[r.value.conflictingChanges&&r.value.viewMode!=="diff"?(v(),W(i(ue),{key:0,gap:"small"},{default:p(()=>[f(i(J),{type:"primary",onClick:c},{default:p(()=>[C("Compare")]),_:1}),f(i(ee),null,{title:p(()=>[C("Keep the local editor version")]),default:p(()=>[f(i(J),{onClick:a[1]||(a[1]=B=>r.value.keepLocalEditor())},{default:p(()=>[C("Discard")]),_:1})]),_:1})]),_:1})):D("",!0),r.value.conflictingChanges&&r.value.viewMode==="diff"?(v(),W(i(ue),{key:1,gap:"small"},{default:p(()=>[f(i(ee),null,{title:p(()=>[C("Keep your current changes")]),default:p(()=>[f(i(J),{onClick:a[2]||(a[2]=B=>r.value.keepAbstraIDECode())},{default:p(()=>[C("Keep left")]),_:1})]),_:1}),f(i(ee),null,{title:p(()=>[C("Keep the local editor version")]),default:p(()=>[f(i(J),{onClick:a[3]||(a[3]=B=>r.value.keepLocalEditor())},{default:p(()=>[C("Keep right")]),_:1})]),_:1})]),_:1})):D("",!0)]),_:1})):D("",!0),u("div",_t,[u("div",{id:"code1",ref_key:"codeComponent",ref:h,class:P(["code-container",{hide:((b=r.value)==null?void 0:b.viewMode)==="diff",blur:w.value}])},null,2),w.value?(v(),W(i(ze),{key:0,class:"not-found-popup"},{title:p(()=>[C("File not found")]),_:1})):D("",!0)]),u("div",{id:"code2",ref_key:"codeDiffComponent",ref:O,class:P(["code-container",{hide:((ne=r.value)==null?void 0:ne.viewMode)!=="diff"}])},null,2)],64)}}});const Wt=Z(mt,[["__scopeId","data-v-21fc4ec1"]]);export{we as L,Bt as R,Wt as S,At as a};
//# sourceMappingURL=SourceCode.e4954acb.js.map
