import{d as F,J as M,r as z,H as Z,a as i,b as r,et as y,f as t,w as a,bq as q,aT as w,eC as P,ew as R,e as c,u,eB as X,c as A,t as W,K as ee,ez as te,eD as ae,eE as ne,x as oe,eA as ce,eF as de}from"./outputWidgets.52de64cd.js";import{B as pe}from"./BaseLayout.c2f90625.js";import{T as me}from"./tables.2760999e.js";import{a as le}from"./asyncComputed.00e76dd1.js";import{p as j}from"./popupNotifcation.d6d253ed.js";import{n as _e}from"./index.a07ffcc5.js";import{L as be}from"./CircularLoading.b5138fc9.js";import{w as fe,Q as ve}from"./icons.bf6505eb.js";import{P as ye}from"./project.3a024f51.js";import"./console.4411c7a7.js";import{O as ge}from"./organization.c1c9ebf3.js";import"./index.8361ad88.js";import{T as he,A as G}from"./TabPane.c3c2f5a1.js";import{B as ke,a as we,c as Ce}from"./index.7800af0b.js";import"./gateway.e1457457.js";import"./activeRecord.ebcbfc07.js";import"./pubsub.6e9aa6f2.js";import"./Form.09072055.js";import"./Title.baba2b21.js";import"./index.e5d92658.js";import"./dayjs.7ad6aa6d.js";import"./index.5718341d.js";import"./index.3ed5d65c.js";import"./index.396ff1b5.js";import"./CollapsePanel.d756b861.js";import"./index.9b3c2ba8.js";import"./index.f6c308cc.js";import"./index.f7915957.js";import"./index.1ebdd57a.js";import"./index.7fdb6bd8.js";import"./index.693f4596.js";import"./index.5a37ef67.js";import"./index.c0e74c90.js";import"./index.19e4a065.js";(function(){try{var d=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},m=new Error().stack;m&&(d._sentryDebugIds=d._sentryDebugIds||{},d._sentryDebugIds[m]="5f5b5d68-e3af-4b69-85e6-75a95e9b489a",d._sentryDebugIdIdentifier="sentry-dbid-5f5b5d68-e3af-4b69-85e6-75a95e9b489a")}catch{}})();const De={class:"table-data"},xe={key:1},Ie=["onClick"],Te=c("a",null,"Delete",-1),$e=F({__name:"TableData",props:{table:{}},setup(d){var x;const m=d,{result:s,loading:l,refetch:E}=le(()=>m.table.select()),C=M(()=>{var b;return[...(b=m.table)==null?void 0:b.getColumns().map($=>({title:$.name,dataIndex:$.name})),{title:"Actions",key:"action",fixed:"right",width:100,align:"center"}]}),_=M(()=>{var p;return((p=s.value)==null?void 0:p.map(b=>({key:b.id,...b})))||[]}),D=z(!1),e=z({}),N=()=>{D.value=!0},I=()=>{e.value={},D.value=!1};let g=Z((x=m.table)==null?void 0:x.getUnprotectedColumns().reduce((p,b)=>({...p,[b.name]:""}),{}));async function o(){if(!(!m.table||!g))try{if(e.value.id){await m.table.updateRow(e.value.id,e.value);return}else await m.table.insertRow(e.value);e.value={},E(),I()}catch(p){p instanceof Error&&j("Database error",p.message)}}const h=async p=>{if(!(!s.value||!s.value.find(b=>b.id===p)))try{await m.table.deleteRow(p),E()}catch(b){b instanceof Error&&j("Database error",b.message)}},T=p=>{var b;e.value=W.exports.pick(W.exports.cloneDeep((b=_.value)==null?void 0:b.filter($=>p===$.key)[0]),m.table.getColumns().map($=>$.name)),N()};return(p,b)=>{const $=i("a-divider"),f=i("a-popconfirm"),n=i("a-button"),v=i("a-table"),B=i("a-input"),K=i("a-form-item"),H=i("a-form"),J=i("a-space"),U=i("a-drawer");return r(),y("div",De,[t(v,{columns:C.value,"data-source":_.value,bordered:"",loading:u(l),scroll:{x:2e3,y:720}},{bodyCell:a(({column:S,text:L,record:O})=>[C.value.map(V=>V.title).includes(S.dataIndex)?(r(),y(q,{key:0},[w(P(L),1)],64)):R("",!0),S.key==="action"?(r(),y("div",xe,[c("span",null,[c("a",{onClick:V=>T(O.id)},"Edit",8,Ie)]),t($,{type:"vertical"}),t(f,{title:"Sure to delete?",onConfirm:V=>h(O.id)},{default:a(()=>[Te]),_:2},1032,["onConfirm"])])):R("",!0)]),footer:a(()=>[t(n,{type:"primary",onClick:N},{default:a(()=>[w("+ Add New Data")]),_:1})]),_:1},8,["columns","data-source","loading"]),t(U,{title:"Data",width:720,open:D.value,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:I},{extra:a(()=>[t(J,null,{default:a(()=>[t(n,{onClick:I},{default:a(()=>[w("Cancel")]),_:1}),t(n,{type:"primary",onClick:o},{default:a(()=>[w("Submit")]),_:1})]),_:1})]),default:a(()=>[t(H,{model:e.value,layout:"vertical"},{default:a(()=>[(r(!0),y(q,null,X(p.table.getUnprotectedColumns(),S=>(r(),A(K,{key:S.id,label:S.name},{default:a(()=>[e.value?(r(),A(B,{key:0,value:e.value[S.name],"onUpdate:value":L=>e.value[S.name]=L},null,8,["value","onUpdate:value"])):R("",!0)]),_:2},1032,["label"]))),128))]),_:1},8,["model"])]),_:1},8,["open"])])}}});const se=d=>(ae("data-v-0e9ed4de"),d=d(),ne(),d),Ee={class:"table-settings"},Be={key:0},Ne=se(()=>c("span",null," protected ",-1)),Se=[Ne],Ae={key:1},Re=["onClick"],Ue=se(()=>c("a",null,"Delete",-1)),ze=F({__name:"TableColumns",props:{table:{},loading:{type:Boolean}},emits:["refresh"],setup(d,{emit:m}){var $;const s=d,l=z(s.loading);ee(()=>s.loading,()=>{l.value=s.loading});const E=["varchar","int","boolean","json","date","timestamp","uuid"],C=te();($=s.table)==null||$.onUpdate(()=>{var f;C.replace({name:"tableEditor",params:{tableName:(f=s.table)==null?void 0:f.name}})});const D=[...[{title:"Name",dataIndex:"name"},{title:"Type",dataIndex:"type"},{title:"Default Value",dataIndex:"default"},{title:"Nullable",dataIndex:"nullable"},{title:"Primary Key",dataIndex:"primaryKey"}],{title:"Actions",key:"action"}],e=z({name:"",type:"",nullable:!0,unique:!1}),N=()=>{e.value={name:"",type:"",nullable:!0,unique:!1}},I=M(()=>{var f;return(f=s.table)==null?void 0:f.getColumns().map(n=>({name:n.name,type:n.type,default:n.default,nullable:n.nullable,primaryKey:n.primaryKey,id:n.id,unique:n.unique}))}),g=z(!1),o=()=>{g.value=!0},h=()=>{g.value=!1};function T(f){var n,v;(v=(n=s.table)==null?void 0:n.getColumn(f))==null||v.delete(),l.value=!0,setTimeout(()=>{m("refresh")},2e3)}async function x(){var f;if(!!s.table&&!(!e.value.name||!e.value.type)){if(e.value.id){const n=(f=s.table)==null?void 0:f.getColumn(e.value.id);if(!n)return;const{success:v,error:B}=await n.update(e.value);v||j("Database error",B)}else{const{success:n,error:v}=await s.table.addColumn(e.value);n||j("Database error",v)}N(),l.value=!0,h(),setTimeout(()=>{m("refresh")},2e3)}}const p=f=>{var n,v,B;return(B=(v=(n=s.table)==null?void 0:n.getColumn(f))==null?void 0:v.protected)!=null?B:!1},b=f=>{var v;const n=W.exports.cloneDeep((v=I.value)==null?void 0:v.filter(B=>B.id===f));!n||(e.value=n[0],o())};return(f,n)=>{const v=i("a-divider"),B=i("a-popconfirm"),K=i("a-button"),H=i("a-table"),J=i("a-input"),U=i("a-form-item"),S=i("a-select-option"),L=i("a-select"),O=i("a-switch"),V=i("a-form"),re=i("a-space"),ie=i("a-drawer");return r(),y("div",Ee,[t(H,{columns:D,"data-source":I.value,bordered:"",loading:l.value,pagination:!1},{bodyCell:a(({column:k,text:ue,record:Q})=>[k.key!=="action"?(r(),y(q,{key:0},[w(P(ue),1)],64)):(r(),y(q,{key:1},[p(Q.id)?(r(),y("div",Be,Se)):(r(),y("div",Ae,[c("span",null,[c("a",{onClick:()=>b(Q.id)},"Edit",8,Re)]),t(v,{type:"vertical"}),t(B,{title:"Sure to delete?",onConfirm:tt=>T(Q.id)},{default:a(()=>[Ue]),_:2},1032,["onConfirm"])]))],64))]),footer:a(()=>[t(K,{type:"primary",onClick:o},{default:a(()=>[w("+ Add New Column")]),_:1})]),_:1},8,["data-source","loading"]),t(ie,{title:"Column",width:720,open:g.value,"body-style":{paddingBottom:"80px"},"footer-style":{textAlign:"right"},onClose:h},{extra:a(()=>[t(re,null,{default:a(()=>[t(K,{onClick:h},{default:a(()=>[w("Cancel")]),_:1}),t(K,{type:"primary",onClick:x},{default:a(()=>[w("Submit")]),_:1})]),_:1})]),default:a(()=>[t(V,{model:e.value,layout:"vertical"},{default:a(()=>[t(U,{key:"name",label:"Name"},{default:a(()=>[t(J,{value:e.value.name,"onUpdate:value":n[0]||(n[0]=k=>e.value.name=k)},null,8,["value"])]),_:1}),t(U,{key:"type",label:"Type"},{default:a(()=>[t(L,{value:e.value.type,"onUpdate:value":n[1]||(n[1]=k=>e.value.type=k),"default-active-first-option":""},{default:a(()=>[(r(),y(q,null,X(E,k=>t(S,{key:k,value:k},{default:a(()=>[w(P(k),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])]),_:1}),t(U,{key:"nullable",label:"Nullable"},{default:a(()=>[t(O,{checked:e.value.nullable,"onUpdate:checked":n[2]||(n[2]=k=>e.value.nullable=k)},null,8,["checked"])]),_:1}),t(U,{key:"unique",label:"Unique"},{default:a(()=>[t(O,{checked:e.value.unique,"onUpdate:checked":n[3]||(n[3]=k=>e.value.unique=k)},null,8,["checked"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])])}}});const qe=oe(ze,[["__scopeId","data-v-0e9ed4de"]]),Y=d=>(ae("data-v-e6bea20b"),d=d(),ne(),d),Pe={class:"table-settings"},je=Y(()=>c("h2",{class:"title"},"Table settings",-1)),Ke=Y(()=>c("div",{class:"subtitle"},"Edit table metadata",-1)),Le={key:0,class:"table-presenter"},Oe={class:"table-property-item"},Ve={class:"property-item"},Me={key:1},Fe={class:"change-warning"},He={class:"section-title"},Je=Y(()=>c("div",{class:"section-body"}," Changing the table's name can possibly result in the break of running applications. ",-1)),Qe={class:"input-section"},Ge={class:"table-name-value-input"},We=["value"],Xe={key:0,class:"error"},Ye={class:"option-buttons"},Ze=F({__name:"TableSettings",props:{table:{}},emits:["refresh"],setup(d,{emit:m}){var I,g;const s=d,l=Z({name:(g=(I=s.table)==null?void 0:I.name)!=null?g:"",error:"",editing:!1,loading:!1}),E=()=>l.editing=!0,C=()=>{e(),l.editing=!1,l.error=""},_=async()=>{l.error="",l.loading=!0;try{await D()}catch(o){o instanceof Error&&(j("Database error",o.message),l.error=o.message)}l.error||(l.editing=!1),l.loading=!1},D=async()=>{if(!(!s.table||s.table.name===l.name)){if(!l.name){l.error="Table name cannot be empty";return}s.table.name=l.name;try{await s.table.save(),m("refresh")}catch(o){o instanceof Error&&(j("Database error",o.message),l.error=o.message)}}},e=()=>{var o,h;return l.name=(h=(o=s.table)==null?void 0:o.name)!=null?h:""},N=o=>{l.name=_e(o.target.value,{replacement:"-",lower:!0,strict:!0})};return ee(()=>{var o;return(o=s.table)==null?void 0:o.name},()=>e()),(o,h)=>{var x;const T=i("icon");return r(),y("div",Pe,[je,Ke,l.editing?(r(),y("div",Me,[c("div",Fe,[c("div",He,[t(T,{path:u(fe),width:"12",height:"12",fill:"#D35249"},null,8,["path"]),w(" Be careful ")]),Je]),c("div",Qe,[c("div",Ge,[c("input",{value:l.name,type:"text",onInput:N},null,40,We)]),l.error?(r(),y("div",Xe,[t(T,{path:u(ve),fill:"#D35249",width:"12",height:"12"},null,8,["path"]),w(" "+P(l.error),1)])):R("",!0),c("div",Ye,[c("button",{class:"cancel-button",onClick:C},"Cancel"),c("button",{class:"save-button",onClick:_},[w(" Save Changes "),l.loading?(r(),A(be,{key:0,size:"16"})):R("",!0)])])])])):(r(),y("div",Le,[c("div",Oe,[c("div",Ve,"Name: "+P((x=o.table)==null?void 0:x.name),1)]),c("button",{onClick:E},"Edit Name")]))])}}});const et=oe(Ze,[["__scopeId","data-v-e6bea20b"]]),zt=F({__name:"TableEditor",setup(d){const m=te(),s=ce(),l=s.params.tableId,E=s.params.projectId,C=z("data"),{result:_,loading:D,refetch:e}=le(()=>Promise.all([ye.get(E).then(async g=>{const o=await ge.get(g.organizationId);return{project:g,organization:o}}),me.get(E,l)]).then(([{project:g,organization:o},h])=>de({project:g,organization:o,table:h}))),N=M(()=>!D.value&&_.value?[{label:"My organizations",path:"/organizations"},{label:_.value.organization.name,path:`/organizations/${_.value.organization.id}`},{label:_.value.project.name,path:`/projects/${_.value.project.id}/tables`}]:void 0);function I(){m.push({name:"tables",params:{projectId:E}})}return(g,o)=>{const h=i("router-link");return r(),A(pe,null,{navbar:a(()=>{var T;return[t(u(Ce),{title:(T=u(_))==null?void 0:T.table.name,onBack:I},{footer:a(()=>[t(u(he),{"active-key":C.value,"onUpdate:activeKey":o[0]||(o[0]=x=>C.value=x)},{default:a(()=>[t(u(G),{key:"data",tab:"Data"}),t(u(G),{key:"columns",tab:"Columns"}),t(u(G),{key:"settings",tab:"Settings"})]),_:1},8,["active-key"])]),breadcrumb:a(()=>[N.value?(r(),A(u(ke),{key:0},{default:a(()=>[(r(!0),y(q,null,X(N.value,(x,p)=>(r(),A(u(we),{key:p},{default:a(()=>[t(h,{to:x.path},{default:a(()=>[w(P(x.label),1)]),_:2},1032,["to"])]),_:2},1024))),128))]),_:1})):R("",!0)]),_:1},8,["title"])]}),content:a(()=>[u(_)&&C.value==="data"?(r(),A($e,{key:0,loading:u(D),table:u(_).table},null,8,["loading","table"])):R("",!0),u(_)&&C.value==="columns"?(r(),A(qe,{key:1,table:u(_).table,loading:u(D),onRefresh:o[1]||(o[1]=T=>u(e)())},null,8,["table","loading"])):R("",!0),u(_)&&C.value==="settings"?(r(),A(et,{key:2,table:u(_).table,loading:u(D),onRefresh:o[2]||(o[2]=T=>u(e)())},null,8,["table","loading"])):R("",!0)]),_:1})}}});export{zt as default};
//# sourceMappingURL=TableEditor.e0a3c30e.js.map
