import{t as ne}from"./ant-design.f8e1bed1.js";import{f as l,eG as ge,r as re,H as oe,F as _e,d as M,b as r,ev as y,w as a,a$ as C,eC as I,eD as x,u as e,v as U,c as g,ar as v,ex as A,cN as le,bv as ye,eI as ie,e as K,eH as Q,o as me,L as he,a as ve,ae as V,dm as ke,cE as q,cF as B,cn as be,bV as X}from"./outputWidgets.6830fc2d.js";import{a as ue}from"./asyncComputed.46a733c1.js";import{s as we}from"./metadata.7c5b6440.js";import{B as Se}from"./icons.31e4fa46.js";import{A as j}from"./index.a26dbe33.js";import{A as ce}from"./index.ec7fc193.js";import{f as Re}from"./index.6a8055e7.js";import{A as ee}from"./Paragraph.c22304c7.js";import"./index.7bf97bdd.js";import{A as te}from"./Title.10b04a9c.js";import{D as Ae,A as xe}from"./index.b0a80c9e.js";import"./index.d467c68d.js";import{T as Ce,A as Ie}from"./Timeline.cfdef03c.js";import{A as de,C as pe}from"./CollapsePanel.a4052cc9.js";import{A as De}from"./Link.9fd1fe6c.js";import{A as Pe}from"./index.1562909b.js";import{A as Fe}from"./contracts.generated.df963128.js";import{S as Oe}from"./scripts.48cf1ca3.js";import{A as $e}from"./FormItem.278e4518.js";import{E as Ee}from"./ExpandOutlined.fba0d71e.js";import{F as Te}from"./Form.a8618886.js";import{C as Le}from"./Card.03412a32.js";import{l as fe}from"./index.60a3b943.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},t=new Error().stack;t&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[t]="c73503c5-71bd-4881-9f79-1dcdd0980056",s._sentryDebugIdIdentifier="sentry-dbid-c73503c5-71bd-4881-9f79-1dcdd0980056")}catch{}})();var Ne={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM641.7 520.8L442.3 677.6c-7.4 5.8-18.3.6-18.3-8.8V355.3c0-9.4 10.9-14.7 18.3-8.8l199.4 156.7a11.2 11.2 0 010 17.6z"}}]},name:"play-square",theme:"filled"};const Ke=Ne;function ae(s){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?Object(arguments[t]):{},o=Object.keys(n);typeof Object.getOwnPropertySymbols=="function"&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(f){return Object.getOwnPropertyDescriptor(n,f).enumerable}))),o.forEach(function(f){je(s,f,n[f])})}return s}function je(s,t,n){return t in s?Object.defineProperty(s,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):s[t]=n,s}var H=function(t,n){var o=ae({},t,n.attrs);return l(ge,ae({},o,{icon:Ke}),null)};H.displayName="PlaySquareFilled";H.inheritAttrs=!1;const se=H;function J(s){switch(s.status){case"waiting":return{color:"blue",text:"Waiting"};case"running":return{color:"processing",text:"Running"};case"finished":return{color:"success",text:"Success"};case"failed":return{color:"error",text:"Failed"};case"abandoned":return{color:"warning",text:"Abandoned"}}}function Ve(){const s=re({state:"closed"});function t(){s.value={state:"closed"}}function n(){s.value={state:"visualizations"}}function o(P,u){s.value={state:"stage-run",stageRun:u}}const f=oe(()=>"stageRun"in s.value?s.value.stageRun:null);return{closeDrawer:t,openVisualizationEditor:n,inspectStageRun:o,drawerState:s,selectedStageRunForDrawer:f}}const z="kanban-selected-stage-ids",L=10;function qe({kanbanRepository:s,storage:t,filterFactory:n}){const o=_e([]),f=ue(async()=>{try{return await s.getData({selection:o.value,filter:n()})}catch{return o.value=[],await t.set(z,[]),{columns:[],next_stage_options:[]}}});function P(c){const i=c.selected_stage.id,d=o.value.find(w=>w.stage_id===i);return d!=null&&d.limit?d.limit<c.total_count:!1}async function u(c){var d;const i=o.value.find(w=>w.stage_id===c);i&&(i.limit=((d=i.limit)!=null?d:0)+L,await f.refetch())}async function k(c){const i=o.value.find(d=>d.stage_id===c);i&&i.limit&&i.limit>L&&(i.limit-=L,await f.refetch())}async function m(){const c=await t.get(z)||[];o.value=c.map(i=>({stage_id:i,limit:L,offset:0}))}async function F(c,i){c?o.value=[...o.value.slice(0,i),{stage_id:c,limit:L,offset:0}]:o.value=o.value.slice(0,i),await t.set(z,o.value.map(d=>d.stage_id)),await f.refetch()}function O(c,i){var S;const d=(S=c.stages)==null?void 0:S.find($=>$.id===c.selected_stage.id);if((d==null?void 0:d.type)!=="form")return null;const w=(i==null?void 0:i.status)==="waiting"?{"abstra-run-id":i.id}:{};return{path:`/${d.path}`,query:w}}let h=null;const b=async()=>{await m(),f.refetch(),h=setInterval(()=>{f.refetch()},1e3)},E=()=>{h&&clearInterval(h)},T=oe(()=>{var i,d,w;const c=(d=(i=f.result.value)==null?void 0:i.columns)!=null?d:[];return(w=c[c.length-1])==null?void 0:w.selected_stage});return{kanbanAsyncComputed:f,selection:o,seeMore:u,hasPagination:P,seeLess:k,setNewSelectedStageId:F,launchLink:O,lastSelectedStage:T,setup:b,tearDown:E}}const Be={key:0},ze={key:1,class:"terminal"},Me=M({__name:"ExecutionInspector",props:{logs:{}},setup(s){return(t,n)=>t.logs.length===0?(r(),y("span",Be)):(r(),y("div",ze,[l(e(j),{vertical:""},{default:a(()=>[(r(!0),y(C,null,I(t.logs,o=>(r(),y("pre",{key:o.executionId,class:"log-text"},x(o.payload.text),1))),128))]),_:1})]))}});const Ue=U(Me,[["__scopeId","data-v-032cbeba"]]),He={key:1},Je=["onClick"],Ge=M({__name:"StageRunInspector",props:{stageRun:{},kanbanRepository:{},stageRunRepository:{}},emits:["close"],setup(s,{emit:t}){const n=s,{result:o,loading:f}=ue(()=>{var u;return n.kanbanRepository.getLogs((u=n.stageRun)==null?void 0:u.id)}),P=(u,k)=>{var m;u.stopPropagation(),(m=n.stageRunRepository)==null||m.fork(k),t("close")};return(u,k)=>(r(),g(e(Pe),{open:"",title:"Thread details",size:"large",onClose:k[0]||(k[0]=m=>t("close"))},{extra:a(()=>[l(e(ee),null,{default:a(()=>[l(e(ce),{style:{"font-weight":"600"}},{default:a(()=>{var m;return[v(x(e(J)({status:(m=u.stageRun)==null?void 0:m.status}).text),1)]}),_:1}),v(" "+x(e(Re)(new Date(u.stageRun.created_at),{addSuffix:!0})),1)]),_:1})]),default:a(()=>{var m,F,O;return[(m=u.stageRun)!=null&&m.assignee?(r(),g(e(ee),{key:0},{default:a(()=>{var h;return[v(" Assignee: "+x((h=u.stageRun)==null?void 0:h.assignee),1)]}),_:1})):A("",!0),((F=u.stageRun)==null?void 0:F.content)&&((O=u.stageRun)==null?void 0:O.content.length)>0?(r(),y("div",He,[l(e(te),{level:4},{default:a(()=>[v("Current data")]),_:1}),l(e(xe),{size:"small",column:1},{default:a(()=>{var h;return[(r(!0),y(C,null,I((h=u.stageRun)==null?void 0:h.content,b=>(r(),g(e(Ae),{key:b.key,label:b.key},{default:a(()=>[l(e(le),{"tree-data":e(ne)(b.value)},null,8,["tree-data"])]),_:2},1032,["label"]))),128))]}),_:1})])):A("",!0),l(e(te),{level:4,style:{"margin-bottom":"30px"}},{default:a(()=>[v(" Timeline ")]),_:1}),e(f)?(r(),g(e(ye),{key:2})):e(o)?(r(),g(e(Ce),{key:3},{default:a(()=>[(r(!0),y(C,null,I(e(o),({stage:h,stage_run:b,logs:E})=>(r(),g(e(Ie),{key:b.id},{default:a(()=>[l(e(pe),{ghost:"","expand-icon-position":"end"},{default:a(()=>[l(e(de),{class:"panel"},ie({header:a(()=>[l(e(j),{align:"center",gap:15},{default:a(()=>[l(Q,{path:e(we)(h.type)},null,8,["path"]),v(" "+x(h.title),1)]),_:2},1024)]),default:a(()=>[K("span",null,"Data: "+x(b.data),1),l(Ue,{logs:E},null,8,["logs"])]),_:2},[u.stageRunRepository?{name:"extra",fn:a(()=>[K("span",{onClick:T=>P(T,b.id)},[l(e(j),{gap:"small"},{default:a(()=>[l(Q,{path:e(Se),width:"22"},null,8,["path"]),l(e(De),null,{default:a(()=>[v("Fork")]),_:1})]),_:1})],8,Je)]),key:"0"}:void 0]),1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):A("",!0)]}),_:1}))}});const We=U(Ge,[["__scopeId","data-v-3683921a"]]),N="Show All",Ye=[N,...Fe];function Ze(){const s=re(N);return{filterStatus:s,filterFactory:()=>s.value==N?{}:{status:s.value},labelOption:o=>o==N?N:J({status:o}).text}}const Qe={class:"stages-container"},Xe={class:"stages-content"},et={style:{"max-height":"200px","overflow-y":"hidden"}},tt=["onClick"],at=M({__name:"Kanban",props:{storage:{},kanbanRepository:{},stageRunRepository:{}},setup(s){const t=s,n=async(w,S,$)=>{w.stopPropagation();const R=await Oe.get(S);!R||await R.run($)},{filterFactory:o,filterStatus:f,labelOption:P}=Ze(),{kanbanAsyncComputed:u,launchLink:k,setNewSelectedStageId:m,lastSelectedStage:F,setup:O,tearDown:h,seeMore:b,hasPagination:E}=qe({kanbanRepository:t.kanbanRepository,storage:t.storage,filterFactory:o});me(O),he(h);const{closeDrawer:T,inspectStageRun:c,drawerState:i,selectedStageRunForDrawer:d}=Ve();return(w,S)=>{const $=ve("router-link");return r(),y("div",null,[l(e(j),{vertical:"",style:{height:"100%"}},{default:a(()=>[l(e(pe),{ghost:""},{default:a(()=>[l(e(de),{header:"Filters"},{default:a(()=>[l(e(Te),null,{default:a(()=>[l(e($e),{label:"Status"},{default:a(()=>[l(e(V),{value:e(f),"onUpdate:value":S[0]||(S[0]=R=>ke(f)?f.value=R:null),style:{width:"300px"}},{default:a(()=>[(r(!0),y(C,null,I(e(Ye),R=>(r(),g(e(q),{key:R,value:R},{default:a(()=>[v(x(e(P)(R)),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1})]),_:1})]),_:1})]),_:1}),K("div",Qe,[K("div",Xe,[l(e(B),{align:"start"},{default:a(()=>{var R,G,W;return[(r(!0),y(C,null,I((G=(R=e(u).result.value)==null?void 0:R.columns)!=null?G:[],(p,Y)=>(r(),g(e(B),{key:Y,direction:"vertical"},{default:a(()=>[l(e(V),{style:{width:"100%","min-width":"250px"},"allow-clear":"",value:p.selected_stage.id,"onUpdate:value":_=>e(m)(_,Y)},{default:a(()=>[(r(!0),y(C,null,I(p.stages,_=>(r(),g(e(q),{key:_.id,value:_.id},{default:a(()=>[v(x(_.title),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"]),p.selected_stage.id?(r(),g(e(B),{key:0,direction:"vertical",style:{width:"100%"}},{default:a(()=>[(r(!0),y(C,null,I(p.stage_run_cards,_=>{var Z;return r(),g(e(Le),{key:_.id,size:"small",style:{"max-width":"250px",cursor:"pointer"},"body-style":{display:((Z=_.content)==null?void 0:Z.length)>0?"block":"none"},onClick:D=>e(c)(p,_)},ie({title:a(()=>[l(e(ce),null,{default:a(()=>[v(x(e(J)({status:_.status}).text),1)]),_:2},1024)]),default:a(()=>[K("div",et,[(r(!0),y(C,null,I(_.content,D=>(r(),g(e(le),{key:D.key,"tree-data":e(ne)(D.value)},null,8,["tree-data"]))),128))]),v(" "+x(_.assignee),1)]),extra:a(()=>[l(e(Ee),{onClick:D=>e(c)(p,_)},null,8,["onClick"])]),_:2},[_.status==="waiting"?{name:"actions",fn:a(()=>[e(k)(p,_)?(r(),g($,{key:0,to:e(k)(p,_),target:"_blank",onClick:S[1]||(S[1]=D=>D.stopPropagation())},{default:a(()=>[l(e(se))]),_:2},1032,["to"])):A("",!0),p.selected_stage.type==="script"?(r(),y("span",{key:1,onClick:D=>n(D,p.selected_stage.id,_.id)},[l(e(se))],8,tt)):A("",!0)]),key:"0"}:void 0]),1032,["body-style","onClick"])}),128)),p.stage_run_cards.length===0?(r(),g(e(be),{key:0})):A("",!0),e(E)(p)?(r(),g(e(X),{key:1,style:{width:"100%"},onClick:_=>e(b)(p.selected_stage.id)},{default:a(()=>[v("See more")]),_:2},1032,["onClick"])):A("",!0),p.selected_stage.can_be_started&&e(k)(p)!==null?(r(),g($,{key:2,target:"_blank",to:e(k)(p)},{default:a(()=>[l(e(X),{style:{width:"100%"}},{default:a(()=>[v(" Start ")]),_:1})]),_:2},1032,["to"])):A("",!0)]),_:2},1024)):A("",!0)]),_:2},1024))),128)),e(u).result.value&&e(u).result.value.next_stage_options.length>0?(r(),g(e(V),{key:(W=e(F))==null?void 0:W.id,style:{width:"100%","min-width":"200px"},"allow-clear":"","onUpdate:value":S[2]||(S[2]=p=>e(m)(p,e(u).result.value.columns.length))},{default:a(()=>[(r(!0),y(C,null,I(e(u).result.value.next_stage_options,p=>(r(),g(e(q),{key:p.id,value:p.id},{default:a(()=>[v(x(p.title),1)]),_:2},1032,["value"]))),128))]),_:1})):A("",!0)]}),_:1})])])]),_:1}),e(i).state==="stage-run"&&e(d)?(r(),g(We,{key:0,"kanban-repository":t.kanbanRepository,"stage-run":e(d),"stage-run-repository":t.stageRunRepository,onClose:e(T)},null,8,["kanban-repository","stage-run","stage-run-repository","onClose"])):A("",!0)])}}});const Ct=U(at,[["__scopeId","data-v-0cd7f22b"]]);class It{constructor(t=fe){this.fetch=t}async getData(t){return(await this.fetch("/_editor/api/kanban",{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}})).json()}async getLogs(t){return(await this.fetch(`/_editor/api/kanban/logs/${t}`)).json()}}class Dt{constructor(t,n=fe){this.authProvider=t,this.fetch=n}get headers(){return{"Content-Type":"application/json",...this.authProvider.authHeaders()}}async getData(t){return(await this.fetch("/_kanban/",{method:"POST",body:JSON.stringify(t),headers:this.headers})).json()}async getLogs(t){return(await this.fetch(`/_kanban/logs/${t}`,{headers:this.headers})).json()}}class Pt{constructor(t,n=localStorage){this.contextKey=t,this.storage=n}makeKey(t){return`${this.contextKey}:${t}`}async get(t){const n=this.storage.getItem(this.makeKey(t));return n?JSON.parse(n):null}async set(t,n){this.storage.setItem(this.makeKey(t),JSON.stringify(n))}}export{It as E,Ct as K,Pt as L,Dt as P};
//# sourceMappingURL=repository.e9cb7dee.js.map
