var ht=Object.defineProperty;var gt=(a,e,t)=>e in a?ht(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var T=(a,e,t)=>(gt(a,typeof e!="symbol"?e+"":e,t),t);import{d as H,D as O,f as E,o as n,Y as S,$ as z,S as A,e8 as fe,a as $,O as l,cM as Ie,R as Ze,ej as W,b as p,w as v,u as i,aS as K,eb as ve,c as I,dh as oe,dc as se,aG as L,e9 as Y,da as ft,ec as R,cO as vt,bT as Ye,a0 as ie,e as F,g as ye,bB as Se,X as xe,ah as Ee,Z as le,bL as me,cz as ge,cy as Ke,cL as yt,eq as mt,aW as wt,ed as Xe,aB as _e,eo as kt,d9 as St,em as _t,en as bt,eh as It,er as $t,es as Tt}from"./index.dc88667e.js";import{M as We,u as U,P as xt,_ as Et,a as Ct,b as At,g as Ue,c as re,N as Pt,d as Dt,e as Ft,f as Nt,h as Vt}from"./vue-flow-minimap.043b13dc.js";import{a as Mt,n as Ge,v as qe,c as Je}from"./validations.c6bf328a.js";import{u as pe}from"./uuid.2fd8adce.js";import{w as we,s as zt}from"./metadata.839477e7.js";import{a as Qe}from"./asyncComputed.a7dbdd76.js";import"./linters.c98c6d53.js";import{W as he}from"./workspaces.7e54abb0.js";import{U as Ht,G as jt}from"./UnsavedChangesHandler.fe0c5cec.js";import{A as Bt}from"./index.c08afab6.js";import{A as $e}from"./index.d6710f2c.js";import{G as Lt}from"./PhArrowCounterClockwise.vue.54d82a27.js";import{T as Zt}from"./TasksManager.32835c5c.js";import{A as Rt}from"./index.d7ee2b29.js";import{t as et}from"./index.d7c0c8c1.js";import{B as Ot}from"./Badge.a75be3a7.js";import{G as Re}from"./PhArrowDown.vue.ea4810d7.js";import"./string.e754d5d0.js";import"./PhRobot.vue.807dd4b4.js";import"./PhWebhooksLogo.vue.7bd328f8.js";import"./workspaceStore.d9e3c30c.js";import"./url.5ed3520f.js";import"./colorHelpers.8de24d2e.js";import"./record.360cbd9f.js";import"./ExclamationCircleOutlined.2f5e763a.js";import"./tasksController.ed09d419.js";import"./gateway.bfbb9203.js";import"./popupNotifcation.07f02947.js";import"./scripts.16092801.js";import"./polling.b8dd3a80.js";import"./ant-design.e2e6a292.js";import"./PhArrowSquareOut.vue.e5d0b99d.js";import"./AbstraButton.vue_vue_type_script_setup_true_lang.52a79043.js";import"./Card.bc9db42d.js";import"./TabPane.51585bae.js";import"./CollapsePanel.d231cb2c.js";import"./index.2fce01dd.js";(function(){try{var a=typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},e=new Error().stack;e&&(a._sentryDebugIds=a._sentryDebugIds||{},a._sentryDebugIds[e]="9d5c0641-d510-4e5a-b316-60c49363d939",a._sentryDebugIdIdentifier="sentry-dbid-9d5c0641-d510-4e5a-b316-60c49363d939")}catch{}})();const Yt=["width","height","fill","transform"],Kt={key:0},Xt=$("path",{d:"M244,56v48a12,12,0,0,1-12,12H184a12,12,0,1,1,0-24H201.1l-19-17.38c-.13-.12-.26-.24-.38-.37A76,76,0,1,0,127,204h1a75.53,75.53,0,0,0,52.15-20.72,12,12,0,0,1,16.49,17.45A99.45,99.45,0,0,1,128,228h-1.37A100,100,0,1,1,198.51,57.06L220,76.72V56a12,12,0,0,1,24,0Z"},null,-1),Wt=[Xt],Ut={key:1},Gt=$("path",{d:"M216,128a88,88,0,1,1-88-88A88,88,0,0,1,216,128Z",opacity:"0.2"},null,-1),qt=$("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1,0-16H211.4L184.81,71.64l-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,0,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60L224,85.8V56a8,8,0,1,1,16,0Z"},null,-1),Jt=[Gt,qt],Qt={key:2},es=$("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1-5.66-13.66l17-17-10.55-9.65-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,1,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60l10.93,10L226.34,50.3A8,8,0,0,1,240,56Z"},null,-1),ts=[es],ss={key:3},as=$("path",{d:"M238,56v48a6,6,0,0,1-6,6H184a6,6,0,0,1,0-12h32.55l-30.38-27.8c-.06-.06-.12-.13-.19-.19a82,82,0,1,0-1.7,117.65,6,6,0,0,1,8.24,8.73A93.46,93.46,0,0,1,128,222h-1.28A94,94,0,1,1,194.37,61.4L226,90.35V56a6,6,0,1,1,12,0Z"},null,-1),os=[as],is={key:4},ns=$("path",{d:"M240,56v48a8,8,0,0,1-8,8H184a8,8,0,0,1,0-16H211.4L184.81,71.64l-.25-.24a80,80,0,1,0-1.67,114.78,8,8,0,0,1,11,11.63A95.44,95.44,0,0,1,128,224h-1.32A96,96,0,1,1,195.75,60L224,85.8V56a8,8,0,1,1,16,0Z"},null,-1),rs=[ns],ls={key:5},ds=$("path",{d:"M236,56v48a4,4,0,0,1-4,4H184a4,4,0,0,1,0-8h37.7L187.53,68.69l-.13-.12a84,84,0,1,0-1.75,120.51,4,4,0,0,1,5.5,5.82A91.43,91.43,0,0,1,128,220h-1.26A92,92,0,1,1,193,62.84l35,32.05V56a4,4,0,1,1,8,0Z"},null,-1),cs=[ds],us={name:"PhArrowClockwise"},ps=H({...us,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(a){const e=a,t=O("weight","regular"),s=O("size","1em"),o=O("color","currentColor"),r=O("mirrored",!1),u=E(()=>{var g;return(g=e.weight)!=null?g:t}),h=E(()=>{var g;return(g=e.size)!=null?g:s}),m=E(()=>{var g;return(g=e.color)!=null?g:o}),d=E(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:r?"scale(-1, 1)":void 0);return(g,f)=>(n(),S("svg",fe({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:h.value,height:h.value,fill:m.value,transform:d.value},g.$attrs),[z(g.$slots,"default"),u.value==="bold"?(n(),S("g",Kt,Wt)):u.value==="duotone"?(n(),S("g",Ut,Jt)):u.value==="fill"?(n(),S("g",Qt,ts)):u.value==="light"?(n(),S("g",ss,os)):u.value==="regular"?(n(),S("g",is,rs)):u.value==="thin"?(n(),S("g",ls,cs)):A("",!0)],16,Yt))}}),hs=["width","height","fill","transform"],gs={key:0},fs=$("path",{d:"M234.29,47.91A20,20,0,0,0,216,36H40A20,20,0,0,0,25.2,69.45l.12.14L92,140.75V216a20,20,0,0,0,31.1,16.64l32-21.33A20,20,0,0,0,164,194.66V140.75l66.67-71.16.12-.14A20,20,0,0,0,234.29,47.91Zm-91,79.89A12,12,0,0,0,140,136v56.52l-24,16V136a12,12,0,0,0-3.25-8.2L49.23,60H206.77Z"},null,-1),vs=[fs],ys={key:1},ms=$("path",{d:"M221.9,61.38,152,136v58.65a8,8,0,0,1-3.56,6.66l-32,21.33A8,8,0,0,1,104,216V136L34.1,61.38A8,8,0,0,1,40,48H216A8,8,0,0,1,221.9,61.38Z",opacity:"0.2"},null,-1),ws=$("path",{d:"M230.6,49.53A15.81,15.81,0,0,0,216,40H40A16,16,0,0,0,28.19,66.76l.08.09L96,139.17V216a16,16,0,0,0,24.87,13.32l32-21.34A16,16,0,0,0,160,194.66V139.17l67.74-72.32.08-.09A15.8,15.8,0,0,0,230.6,49.53ZM40,56h0Zm106.18,74.58A8,8,0,0,0,144,136v58.66L112,216V136a8,8,0,0,0-2.16-5.47L40,56H216Z"},null,-1),ks=[ms,ws],Ss={key:2},_s=$("path",{d:"M227.81,66.76l-.08.09L160,139.17v55.49A16,16,0,0,1,152.87,208l-32,21.34A16,16,0,0,1,96,216V139.17L28.27,66.85l-.08-.09A16,16,0,0,1,40,40H216a16,16,0,0,1,11.84,26.76Z"},null,-1),bs=[_s],Is={key:3},$s=$("path",{d:"M228.77,50.34A13.8,13.8,0,0,0,216,42H40A14,14,0,0,0,29.67,65.42l.06.07L98,138.38V216a14,14,0,0,0,21.77,11.64l32-21.33A14,14,0,0,0,158,194.66V138.38l68.33-73A13.82,13.82,0,0,0,228.77,50.34Zm-11.26,6.94L147.62,131.9A6,6,0,0,0,146,136v58.66a2,2,0,0,1-.89,1.67l-32,21.33A2,2,0,0,1,110,216V136a6,6,0,0,0-1.62-4.1L38.53,57.32A2,2,0,0,1,40,54H216a1.9,1.9,0,0,1,1.83,1.19A1.86,1.86,0,0,1,217.51,57.28Z"},null,-1),Ts=[$s],xs={key:4},Es=$("path",{d:"M230.6,49.53A15.81,15.81,0,0,0,216,40H40A16,16,0,0,0,28.19,66.76l.08.09L96,139.17V216a16,16,0,0,0,24.87,13.32l32-21.34A16,16,0,0,0,160,194.66V139.17l67.74-72.32.08-.09A15.8,15.8,0,0,0,230.6,49.53ZM40,56h0Zm106.18,74.58A8,8,0,0,0,144,136v58.66L112,216V136a8,8,0,0,0-2.16-5.47L40,56H216Z"},null,-1),Cs=[Es],As={key:5},Ps=$("path",{d:"M227,51.15A11.85,11.85,0,0,0,216,44H40a12,12,0,0,0-8.88,20.07l.05.05L100,137.59V216a12,12,0,0,0,18.66,10l32-21.33a12,12,0,0,0,5.35-10V137.59l68.86-73.52A11.85,11.85,0,0,0,227,51.15Zm-8,7.5-69.9,74.62A4,4,0,0,0,148,136v58.65a4,4,0,0,1-1.78,3.33l-32,21.33A4,4,0,0,1,108,216V136a4,4,0,0,0-1.08-2.74L37.05,58.67A4,4,0,0,1,40,52H216a4,4,0,0,1,3,6.65Z"},null,-1),Ds=[Ps],Fs={name:"PhFunnel"},Ns=H({...Fs,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(a){const e=a,t=O("weight","regular"),s=O("size","1em"),o=O("color","currentColor"),r=O("mirrored",!1),u=E(()=>{var g;return(g=e.weight)!=null?g:t}),h=E(()=>{var g;return(g=e.size)!=null?g:s}),m=E(()=>{var g;return(g=e.color)!=null?g:o}),d=E(()=>e.mirrored!==void 0?e.mirrored?"scale(-1, 1)":void 0:r?"scale(-1, 1)":void 0);return(g,f)=>(n(),S("svg",fe({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:h.value,height:h.value,fill:m.value,transform:d.value},g.$attrs),[z(g.$slots,"default"),u.value==="bold"?(n(),S("g",gs,vs)):u.value==="duotone"?(n(),S("g",ys,ks)):u.value==="fill"?(n(),S("g",Ss,bs)):u.value==="light"?(n(),S("g",Is,Ts)):u.value==="regular"?(n(),S("g",xs,Cs)):u.value==="thin"?(n(),S("g",As,Ds)):A("",!0)],16,hs))}}),Vs=l.object({type:l.enum(["forms","hooks"]),id:l.string(),title:l.string(),position:l.object({x:l.number(),y:l.number()}),props:l.object({path:l.string().nullable(),filename:l.string().nullable()})}),Ms=l.object({type:l.literal("scripts"),id:l.string(),title:l.string(),position:l.object({x:l.number(),y:l.number()}),props:l.object({filename:l.string().nullable()})}),zs=l.object({type:l.literal("jobs"),id:l.string(),title:l.string(),position:l.object({x:l.number(),y:l.number()}),props:l.object({filename:l.string().nullable()})}),Hs=l.object({type:l.literal("agents"),id:l.string(),title:l.string(),position:l.object({x:l.number(),y:l.number()}),props:l.object({projectId:l.string().nullable(),clientStageId:l.string().nullable()})}),js=l.object({type:l.literal("clients"),id:l.string(),title:l.string(),position:l.object({x:l.number(),y:l.number()}),props:l.object({})}),Bs=l.union([Ms,Vs,Hs,js,zs]),Ls=l.object({id:l.string(),type:l.literal("task"),sourceStageId:l.string(),targetStageId:l.string(),props:l.object({taskType:l.string().nullable()})}),Oe=l.object({stages:l.array(Bs),transitions:l.array(Ls)}),Zs={"Content-Type":"application/json"};class Rs{async load(){const e=await fetch("/_editor/api/workflows");if(e.ok){const t=await e.json(),s=Oe.safeParse(t);if(s.success)return s.data;throw console.error(s.error.errors),new Error("Failed to parse initial data")}else throw new Error("Failed to fetch initial data")}async update(e){const t=await fetch("/_editor/api/workflows",{method:"PUT",headers:Zs,body:JSON.stringify(e)});if(t.ok){const s=await t.json(),o=Oe.safeParse(s);if(o.success)return o.data;throw new Error("Failed to parse updated data:",s)}else throw new Error("Failed to update workflow")}}const Os=new Rs;function tt(){return Math.random().toString(36).slice(2,9)}class ne{constructor(e){this.changes=e}apply(e){return this.changes.reduce((t,s)=>s.apply(t),e)}reverse(){return new ne(this.changes.map(e=>e.reverse()).reverse())}}class st{constructor(e){T(this,"removed");this.stageId=e,this.removed=null}apply(e){const t=e.stages.find(o=>o.id===this.stageId)||null;if(!t)throw new Error(`Stage ${this.stageId} not found`);const s=e.transitions.filter(o=>o.sourceStageId===this.stageId||o.targetStageId===this.stageId);return this.removed={stage:t,transitions:s},{stages:e.stages.filter(o=>o.id!==t.id),transitions:e.transitions.filter(o=>!s.find(r=>r.id===o.id))}}reverse(){if(!this.removed)throw new Error("Cannot reverse change that was not applied");const e=new at(this.removed.stage.type,this.removed.stage.title,this.removed.stage.position,this.removed.stage.id,this.removed.stage.props),t=this.removed.transitions.map(s=>new Ce(s.sourceStageId,s.targetStageId,s.type,s.id));return new ne([e,...t])}}class at{constructor(e,t,s,o,r){T(this,"addedStage");this.stageType=e,this.nodeTitle=t,this.position=s,this.id=o,this.props=r,this.addedStage=null}assertStageDoesNotExist(e){if(e.stages.find(t=>t.id===this.id))throw new Error(`Stage ${this.id} already exists`)}assertValidStageType(){if(!we.stages.find(e=>e.typeName===this.stageType))throw new Error(`Invalid stage type ${this.stageType}`)}assertTransitionDoesNotExist(e){if(e.transitions.find(t=>t.sourceStageId===this.id||t.targetStageId===this.id))throw new Error("Stage already has transitions")}makePath(e){switch(this.stageType){case"forms":return`new-form-${e}`;case"hooks":return`new-hook-${e}`;default:return null}}makeFilename(e){switch(this.stageType){case"forms":return`new_form_${e}.py`;case"hooks":return`new_hook_${e}.py`;case"jobs":return`new_job_${e}.py`;case"scripts":return`new_script_${e}.py`;default:return null}}apply(e){var s,o,r,u;const t=tt();switch(this.assertStageDoesNotExist(e),this.assertValidStageType(),this.assertTransitionDoesNotExist(e),this.stageType){case"forms":case"hooks":{const h={path:this.makePath(t),filename:this.makeFilename(t),...this.props};this.addedStage={id:(s=this.id)!=null?s:pe(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:h};break}case"jobs":case"scripts":{const h={filename:this.makeFilename(t),...this.props};this.addedStage={id:(o=this.id)!=null?o:pe(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:h};break}case"agents":{this.addedStage={id:(r=this.id)!=null?r:pe(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:{projectId:null,clientStageId:null}};break}case"clients":{this.addedStage={id:(u=this.id)!=null?u:pe(),title:this.nodeTitle,type:this.stageType,position:{x:this.position.x,y:this.position.y},props:{}};break}default:throw new Error(`Invalid stage type ${this.stageType}`)}if(!this.addedStage)throw new Error("Stage not created");return{transitions:e.transitions,stages:[...e.stages,this.addedStage]}}reverse(){if(!this.addedStage)throw new Error("Cannot reverse change that was not applied");return new st(this.addedStage.id)}}class Ys extends ne{constructor(e){super(e.map(t=>new at(t.type,t.title,t.position,t.id)))}}class ot{constructor(e){T(this,"removedTransition");this.transitionId=e,this.removedTransition=null}apply(e){const t=e.transitions.find(s=>s.id===this.transitionId);if(!t)throw new Error(`Transition ${this.transitionId} not found`);return this.removedTransition=t!=null?t:null,{stages:e.stages,transitions:e.transitions.filter(s=>s.id!==this.transitionId)}}reverse(){if(!this.removedTransition)throw new Error("Cannot reverse change that was not applied");return new Ce(this.removedTransition.sourceStageId,this.removedTransition.targetStageId,this.removedTransition.type,this.removedTransition.id)}}class Ce{constructor(e,t,s,o){T(this,"addedTransition");this.sourceStageId=e,this.targetStageId=t,this.transitionType=s,this.transitionId=o,this.addedTransition=null}assertSourceStageExists(e){if(!e.stages.find(t=>t.id===this.sourceStageId))throw new Error(`Stage ${this.sourceStageId} not found`)}assertTargetStageExists(e){if(!e.stages.find(t=>t.id===this.targetStageId))throw new Error(`Stage ${this.targetStageId} not found`)}assertTransitionDoesNotExist(e){if(e.transitions.find(t=>t.id===this.transitionId))throw new Error(`Transition ${this.transitionId} already exists`)}assertNotSelfTransition(){if(this.sourceStageId===this.targetStageId)throw new Error("Self transitions are not allowed")}assertNoDuplicatedTransitionStages(e){if(e.transitions.find(t=>t.sourceStageId===this.sourceStageId&&t.targetStageId===this.targetStageId))throw Ie.error({message:"Invalid transition",description:"Transition already exists"}),new Error("Transition already exists")}assertNoStageWithSameId(e){if(e.stages.find(t=>t.id===this.transitionId))throw new Error(`Stage with id ${this.transitionId} already exists`)}apply(e){return this.assertSourceStageExists(e),this.assertTargetStageExists(e),this.assertTransitionDoesNotExist(e),this.assertNotSelfTransition(),this.assertNoDuplicatedTransitionStages(e),this.assertNoStageWithSameId(e),this.addedTransition={id:this.transitionId,sourceStageId:this.sourceStageId,targetStageId:this.targetStageId,type:this.transitionType,props:{taskType:null}},{stages:e.stages,transitions:[...e.transitions,this.addedTransition]}}reverse(){if(!this.addedTransition)throw new Error("Cannot reverse change that was not applied");return new ot(this.addedTransition.id)}}class Ks extends ne{constructor(e){super(e.map(t=>new Ce(t.sourceStageId,t.targetStageId,t.type,t.id)))}}class Ae{constructor(e){T(this,"oldPositions");this.newPositions=e,this.oldPositions=null}assertStagesExists(e){this.newPositions.forEach(({id:t})=>{if(!e.stages.find(s=>s.id===t))throw new Error(`Stage ${t} not found`)})}assertIsNumber(){this.newPositions.forEach(({position:e})=>{if(Number.isNaN(e.x)||Number.isNaN(e.y)||!Number.isFinite(e.x)||!Number.isFinite(e.y))throw new Error("Position must be a number")})}apply(e){return this.assertIsNumber(),this.assertStagesExists(e),this.oldPositions=e.stages.map(s=>({id:s.id,position:s.position})),{stages:e.stages.map(s=>{var r,u;const o=(u=(r=this.newPositions.find(h=>h.id===s.id))==null?void 0:r.position)!=null?u:s.position;return{...s,position:{x:o.x,y:o.y}}}),transitions:e.transitions}}reverse(){if(!this.oldPositions)throw new Error("Cannot reverse change that was not applied");return new Ae(this.oldPositions)}}class Pe{constructor(e,t){T(this,"stageId");T(this,"newTitle");T(this,"oldTitle");this.stageId=e,this.newTitle=t,this.oldTitle=""}assertStageExists(e){if(!e.stages.find(t=>t.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}apply(e){return this.assertStageExists(e),this.oldTitle=e.stages.find(t=>t.id===this.stageId).title,{stages:e.stages.map(t=>t.id===this.stageId?{...t,title:this.newTitle}:t),transitions:e.transitions}}reverse(){return new Pe(this.stageId,this.oldTitle)}}class De{constructor(e,t){T(this,"stageId");T(this,"newProps");T(this,"oldProps");this.stageId=e,this.newProps=t}assertStageExists(e){if(!e.stages.find(t=>t.id===this.stageId))throw new Error(`Stage ${this.stageId} not found`)}assertValidPath(){if(!("path"in this.newProps)||!this.newProps.path)return;const e=Mt(this.newProps.path);if(!e.valid){Ie.error({message:"Invalid path",description:e.reason});return}this.newProps.path=Ge(this.newProps.path)}assertValidFilename(){if(!("filename"in this.newProps)||!this.newProps.filename)return;const e=qe(this.newProps.filename);if(!e.valid){Ie.error({message:"Invalid filename",description:e.reason});return}this.newProps.filename=Je(this.newProps.filename)}apply(e){return this.assertStageExists(e),this.assertValidPath(),this.assertValidFilename(),this.oldProps=e.stages.find(t=>t.id===this.stageId).props,{stages:e.stages.map(t=>t.id===this.stageId?{...t,props:this.newProps}:t),transitions:e.transitions}}reverse(){return new De(this.stageId,this.oldProps)}}class Fe{constructor(e,t){T(this,"newProps");T(this,"transitionId");T(this,"oldProps");this.newProps=t,this.transitionId=e,this.oldProps=t}apply(e){return{transitions:e.transitions.map(t=>t.id===this.transitionId?(this.oldProps=t.props,{...t,props:this.newProps}):t),stages:e.stages}}reverse(){return new Fe(this.transitionId,this.oldProps)}}class Xs extends ne{constructor(e,t){super([...t.map(s=>new ot(s)),...e.map(s=>new st(s))])}}class Ws{constructor(e){T(this,"currentState");T(this,"serverState");T(this,"undoStack");T(this,"redoStack");this.undoStack=[],this.redoStack=[],this.currentState=Ze(Object.freeze(e)),this.serverState=Ze(Object.freeze(e))}apply(e){return this.currentState.value=e.apply(this.currentState.value),this.undoStack.push(e),this.redoStack=[],this.currentState.value}canUndo(){return this.undoStack.length>0}undo(){const e=this.undoStack.pop();if(e){const t=e.reverse();this.currentState.value=t.apply(this.currentState.value),this.redoStack.push(e)}return this.currentState.value}canRedo(){return this.redoStack.length>0}redo(){const e=this.redoStack.pop();return e&&(this.currentState.value=e.apply(this.currentState.value),this.undoStack.push(e)),this.currentState.value}getState(){return this.currentState.value}setServerState(e){this.serverState.value=e}getServerState(){return this.serverState.value}hasStageChanges(){return!W.exports.isEqual(this.currentState.value.stages,this.serverState.value.stages)}hasChanges(){const e={...this.currentState.value,stages:[...this.currentState.value.stages].sort((s,o)=>s.id.localeCompare(o.id)),transitions:[...this.currentState.value.transitions].sort((s,o)=>s.id.localeCompare(o.id))},t={...this.serverState.value,stages:[...this.serverState.value.stages].sort((s,o)=>s.id.localeCompare(o.id)),transitions:[...this.serverState.value.transitions].sort((s,o)=>s.id.localeCompare(o.id))};return!W.exports.isEqual(e,t)}stageHasChanges(e){const t=this.currentState.value.stages.find(o=>o.id===e),s=this.serverState.value.stages.find(o=>o.id===e);return!W.exports.isEqual(t,s)}stageHasNonPositionChanges(e){const t=this.currentState.value.stages.find(o=>o.id===e),s=this.serverState.value.stages.find(o=>o.id===e);return!W.exports.isEqual(W.exports.omit(t,"position"),W.exports.omit(s,"position"))}}const Us=2;class Ne{constructor(e,t,s){T(this,"api");T(this,"editable");T(this,"history");T(this,"vueFlowNodes");T(this,"vueFlowEdges");this.editable=s,this.api=e,this.history=new Ws(t),this.vueFlowNodes=E(()=>this.computeVueFlowNodes()),this.vueFlowEdges=E(()=>this.computeVueFlowEdges())}static async init(e,t){const s=await e.load();return new Ne(e,s,t)}inflateYFactor(){return this.editable?1:Us}computeVueFlowNodes(){return this.history.getState().stages.map(t=>({id:t.id,type:t.type,data:t,position:{x:t.position.x,y:t.position.y*this.inflateYFactor()}}))}computeVueFlowEdges(){return this.history.getState().transitions.map(t=>({id:t.id,source:t.sourceStageId,target:t.targetStageId,type:"task",label:"task",markerEnd:{type:We.Arrow,width:24,height:24},data:t}))}getStage(e){var t;return(t=this.history.getState().stages.find(s=>s.id===e))!=null?t:null}updateStageTitle(e,t){this.history.apply(new Pe(e,t))}updateStageProps(e,t){this.history.apply(new De(e,t))}addStages(e){const t=e[0].type.slice(0,-1),s=t==="script"?"tasklet":t;return this.history.apply(new Ys(e.map(o=>{var r;return{...o,title:(r=o.title)!=null?r:`New ${s}`}}))),this.history.getState().stages.slice(-e.length)}connect(e){this.history.apply(new Ks(e))}move(e){this.history.apply(new Ae(e))}delete(e){const t=this.history.getState(),s=t.stages.filter(r=>e.includes(r.id)).map(r=>r.id),o=t.transitions.filter(r=>e.includes(r.id)).map(r=>r.id);this.history.apply(new Xs(s,o))}updateTransitionProps(e,t){this.history.apply(new Fe(e,t))}hasChanges(){return this.history.hasChanges()}async save(){if(this.history.hasChanges()){const e=await this.api.update(this.history.getState());this.history.setServerState(e)}}}class Ve{static get isMac(){return navigator.userAgent.includes("Mac OS X")}static get buildPlatform(){return{}.CURRENT_PLATFORM||"web"}}const Q=a=>Ve.isMac?a.metaKey:a.ctrlKey,Gs=a=>a.altKey,it=a=>a.shiftKey,be={alt:Gs,"arrow-up":a=>a.code==="ArrowUp","arrow-down":a=>a.code==="ArrowDown","arrow-left":a=>a.code==="ArrowLeft","arrow-right":a=>a.code==="ArrowRight",ctrl:Q,delete:a=>Ve.isMac?a.code==="Backspace":a.code==="Delete",enter:a=>a.code==="Enter",escape:a=>a.code==="Escape",shift:it,space:a=>a.code==="Space",a:a=>a.code==="KeyA",b:a=>a.code==="KeyB",c:a=>a.code==="KeyC",d:a=>a.code==="KeyD",f:a=>a.code==="KeyF",g:a=>a.code==="KeyG",h:a=>a.code==="KeyH",k:a=>a.code==="KeyK",p:a=>a.code==="KeyP",v:a=>a.code==="KeyV",x:a=>a.code==="KeyX",z:a=>a.code==="KeyZ",0:a=>a.code==="Digit0","[":a=>a.code==="BracketLeft","]":a=>a.code==="BracketRight"};class qs{constructor(e){T(this,"pressedKeys");T(this,"evt");this.evt=e,this.pressedKeys={};const t=s=>o=>{Object.keys(be).forEach(r=>{be[r](o)&&this.setPressed(r,s)})};this.evt||(window.addEventListener("keydown",t(!0)),window.addEventListener("keyup",t(!1)))}setPressed(e,t){this.pressedKeys[e]=t}isPressed(e){var t;return this.evt?be[e](this.evt):(t=this.pressedKeys[e])!=null?t:!1}}new qs;const Js=["onDragstart"],Qs={style:{display:"flex","flex-direction":"column","max-width":"250px"}},ea=H({__name:"BottomToolbar",props:{controller:{}},emits:["drag-start"],setup(a,{emit:e}){return(t,s)=>(n(),S(K,null,[p(i(oe),{class:"toolbar",align:"center"},{default:v(()=>[(n(!0),S(K,null,ve(i(we).stages,o=>(n(),I(i(vt),{key:o.key,placement:"top"},{title:v(()=>[p(i(oe),{gap:"small"},{default:v(()=>[p(i(se),null,{default:v(()=>[L(Y(o.title),1)]),_:2},1024),p(i(se),{keyboard:""},{default:v(()=>[L(Y(o.key),1)]),_:2},1024)]),_:2},1024)]),content:v(()=>[$("div",Qs,[p(i(se),null,{default:v(()=>[L(Y(o.description),1)]),_:2},1024),o.beta?(n(),I(i($e),{key:0,type:"warning",class:"beta-alert"},{description:v(()=>[p(i(se),null,{default:v(()=>[L(" This is a beta feature, "),p(i(ft),{href:"https://abstra.io/docs/concepts/agents/",target:"_blank"},{default:v(()=>[L(" click here ")]),_:1}),L(" to learn more about it ")]),_:1})]),_:1})):A("",!0)])]),default:v(()=>[$("div",{draggable:!0,class:"toolbar__item",onDragstart:r=>e("drag-start",r.dataTransfer,o.typeName)},[(n(),I(R(o.icon),{size:18}))],40,Js)]),_:2},1024))),128)),p(i(Bt),{type:"vertical"}),p(i(Ye),{disabled:!t.controller.hasChanges(),onClick:s[0]||(s[0]=o=>t.controller.save())},{default:v(()=>[p(i(oe),{align:"center",gap:"small"},{default:v(()=>[p(i(jt),{size:16}),L(" Save ")]),_:1})]),_:1},8,["disabled"])]),_:1}),p(Ht,{"has-changes":t.controller.hasChanges()},null,8,["has-changes"])],64))}});const ta=ie(ea,[["__scopeId","data-v-8abfff78"]]);function nt(){let a;const e={draggedType:F(null),isDragOver:F(!1),isAdding:F(!1),isDragging:F(!1),mousePosition:F(null)},{draggedType:t,isDragOver:s,isDragging:o,isAdding:r}=e,u=_=>{a=_,document.addEventListener("mousemove",C)},{screenToFlowCoordinate:h}=U();ye(r,_=>{document.body.style.userSelect=_?"none":""});function m(_,V){r.value=!0,_?(_.setData("application/vueflow",V),_.effectAllowed="move",t.value=V,o.value=!0,document.addEventListener("drop",f)):(t.value=V,document.addEventListener("click",y))}function d(_){_.preventDefault(),t.value&&(s.value=!0,_.dataTransfer&&(_.dataTransfer.dropEffect="move"))}function g(){s.value=!1}function f(){r.value=!1,o.value=!1,s.value=!1,t.value=null,document.removeEventListener("drop",f)}function C(_){const V={x:_.pageX-200,y:_.pageY-80};e.mousePosition.value=V}function w(_){if(!t.value)throw new Error("No dragged type");return h({x:_.clientX-70,y:_.clientY-25})}function y(_){if(!a)return;if(!t.value)throw new Error("No dragged type");const V=w(_);a.addStages([{type:t.value,position:V}]),f()}function N(){document.removeEventListener("mousemove",C)}return{init:u,tearDown:N,draggedType:t,isDragOver:s,isAdding:r,isDragging:o,mousePosition:e.mousePosition,onDragStart:m,onDragLeave:g,onDragOver:d,onDrop:y}}const sa={name:"ControlButton",compatConfig:{MODE:3}},aa=(a,e)=>{const t=a.__vccOpts||a;for(const[s,o]of e)t[s]=o;return t},oa={class:"vue-flow__controls-button"};function ia(a,e,t,s,o,r){return n(),S("button",oa,[z(a.$slots,"default")])}const ae=aa(sa,[["render",ia]]),na={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32"},ra=$("path",{d:"M32 18.133H18.133V32h-4.266V18.133H0v-4.266h13.867V0h4.266v13.867H32z"},null,-1),la=[ra];function da(a,e){return n(),S("svg",na,la)}const ca={render:da},ua={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 5"},pa=$("path",{d:"M0 0h32v4.2H0z"},null,-1),ha=[pa];function ga(a,e){return n(),S("svg",ua,ha)}const fa={render:ga},va={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 30"},ya=$("path",{d:"M3.692 4.63c0-.53.4-.938.939-.938h5.215V0H4.708C2.13 0 0 2.054 0 4.63v5.216h3.692V4.631zM27.354 0h-5.2v3.692h5.17c.53 0 .984.4.984.939v5.215H32V4.631A4.624 4.624 0 0 0 27.354 0zm.954 24.83c0 .532-.4.94-.939.94h-5.215v3.768h5.215c2.577 0 4.631-2.13 4.631-4.707v-5.139h-3.692v5.139zm-23.677.94a.919.919 0 0 1-.939-.94v-5.138H0v5.139c0 2.577 2.13 4.707 4.708 4.707h5.138V25.77H4.631z"},null,-1),ma=[ya];function wa(a,e){return n(),S("svg",va,ma)}const ka={render:wa},Sa={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},_a=$("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0 8 0 4.571 3.429 4.571 7.619v3.048H3.048A3.056 3.056 0 0 0 0 13.714v15.238A3.056 3.056 0 0 0 3.048 32h18.285a3.056 3.056 0 0 0 3.048-3.048V13.714a3.056 3.056 0 0 0-3.048-3.047zM12.19 24.533a3.056 3.056 0 0 1-3.047-3.047 3.056 3.056 0 0 1 3.047-3.048 3.056 3.056 0 0 1 3.048 3.048 3.056 3.056 0 0 1-3.048 3.047zm4.724-13.866H7.467V7.619c0-2.59 2.133-4.724 4.723-4.724 2.591 0 4.724 2.133 4.724 4.724v3.048z"},null,-1),ba=[_a];function Ia(a,e){return n(),S("svg",Sa,ba)}const $a={render:Ia},Ta={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},xa=$("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0c-4.114 1.828-1.37 2.133.305 2.438 1.676.305 4.42 2.59 4.42 5.181v3.048H3.047A3.056 3.056 0 0 0 0 13.714v15.238A3.056 3.056 0 0 0 3.048 32h18.285a3.056 3.056 0 0 0 3.048-3.048V13.714a3.056 3.056 0 0 0-3.048-3.047zM12.19 24.533a3.056 3.056 0 0 1-3.047-3.047 3.056 3.056 0 0 1 3.047-3.048 3.056 3.056 0 0 1 3.048 3.048 3.056 3.056 0 0 1-3.048 3.047z"},null,-1),Ea=[xa];function Ca(a,e){return n(),S("svg",Ta,Ea)}const Aa={render:Ca},Pa={name:"Controls",compatConfig:{MODE:3}},Da=H({...Pa,props:{showZoom:{type:Boolean,default:!0},showFitView:{type:Boolean,default:!0},showInteractive:{type:Boolean,default:!0},fitViewParams:{},position:{default:()=>xt.BottomLeft}},emits:["zoomIn","zoomOut","fitView","interactionChange"],setup(a,{emit:e}){const{nodesDraggable:t,nodesConnectable:s,elementsSelectable:o,setInteractive:r,zoomIn:u,zoomOut:h,fitView:m,viewport:d,minZoom:g,maxZoom:f}=U(),C=Se(()=>t.value||s.value||o.value),w=Se(()=>d.value.zoom<=g.value),y=Se(()=>d.value.zoom>=f.value);function N(){u(),e("zoomIn")}function _(){h(),e("zoomOut")}function V(){m(a.fitViewParams),e("fitView")}function j(){r(!C.value),e("interactionChange",!C.value)}return(x,Z)=>(n(),I(i(Et),{class:"vue-flow__controls",position:x.position},{default:v(()=>[z(x.$slots,"top"),x.showZoom?(n(),S(K,{key:0},[z(x.$slots,"control-zoom-in",{},()=>[p(ae,{class:"vue-flow__controls-zoomin",disabled:y.value,onClick:N},{default:v(()=>[z(x.$slots,"icon-zoom-in",{},()=>[(n(),I(R(i(ca))))])]),_:3},8,["disabled"])]),z(x.$slots,"control-zoom-out",{},()=>[p(ae,{class:"vue-flow__controls-zoomout",disabled:w.value,onClick:_},{default:v(()=>[z(x.$slots,"icon-zoom-out",{},()=>[(n(),I(R(i(fa))))])]),_:3},8,["disabled"])])],64)):A("",!0),x.showFitView?z(x.$slots,"control-fit-view",{key:1},()=>[p(ae,{class:"vue-flow__controls-fitview",onClick:V},{default:v(()=>[z(x.$slots,"icon-fit-view",{},()=>[(n(),I(R(i(ka))))])]),_:3})]):A("",!0),x.showInteractive?z(x.$slots,"control-interactive",{key:2},()=>[x.showInteractive?(n(),I(ae,{key:0,class:"vue-flow__controls-interactive",onClick:j},{default:v(()=>[C.value?z(x.$slots,"icon-unlock",{key:0},()=>[(n(),I(R(i(Aa))))]):A("",!0),C.value?A("",!0):z(x.$slots,"icon-lock",{key:1},()=>[(n(),I(R(i($a))))])]),_:3})):A("",!0)]):A("",!0),z(x.$slots,"default")]),_:3},8,["position"]))}}),Fa=H({__name:"ControlButtons",props:{workflow:{}},setup(a){return(e,t)=>(n(),I(i(Da),{position:"top-left","show-interactive":!1},{default:v(()=>[p(i(ae),{title:"Undo",disabled:!e.workflow.history.canUndo(),onClick:t[0]||(t[0]=s=>e.workflow.history.undo())},{default:v(()=>[p(i(Lt))]),_:1},8,["disabled"]),p(i(ae),{title:"Redo",disabled:!e.workflow.history.canRedo(),onClick:t[1]||(t[1]=s=>e.workflow.history.redo())},{default:v(()=>[p(i(ps))]),_:1},8,["disabled"])]),_:1}))}});class Na{constructor(e,t){T(this,"dx");T(this,"dy");this.dx=t.x-e.x,this.dy=t.y-e.y}get x(){return this.dx}get y(){return this.dy}get length(){return Math.sqrt(this.dx*this.dx+this.dy*this.dy)}get m(){return this.dy/this.dx}}function Va(a,e,t=0){const{x:s,y:o}=e.center,{width:r,height:u}=e,h=new Na(a,e.center),m=t*(h.x/h.length),d=t*(h.y/h.length),g=u/r;let f,C;if(Math.abs(h.m)>Math.abs(g)){const w=u/2*(1/h.m);f=s-(h.y>0?w:-w),C=o+(h.y>0?-u/2:u/2)}else{const w=r/2*h.m;f=s+(h.x>0?-r/2:r/2),C=o-(h.x>0?w:-w)}return{x:f+m,y:C+d}}const Ma=(a,e=0,t=0)=>{const s=Math.atan2(a.ty-a.sy,a.tx-a.sx),o=e*Math.sin(s),r=e*Math.cos(s),u=t*Math.cos(s),h=t*Math.sin(s);return{sourceX:a.sx-o+u,sourceY:a.sy+r+h,targetX:a.tx-o-u,targetY:a.ty+r-h}};function Te(a,e,t=0){const s={x:a.computedPosition.x+a.dimensions.width/2,y:a.computedPosition.y+a.dimensions.height/2},r={center:{x:e.computedPosition.x+e.dimensions.width/2,y:e.computedPosition.y+e.dimensions.height/2},width:e.dimensions.width,height:e.dimensions.height};return Va(s,r,t)}function rt(a,e){const t=Te(a,e,-10),s=Te(e,a,-10);return{sx:s.x,sy:s.y,tx:t.x,ty:t.y}}const za=H({__name:"TaskEdge",props:{id:{},sourceNode:{},targetNode:{},source:{},target:{},type:{},label:{type:[String,Object,Function]},style:{},selected:{type:Boolean},sourcePosition:{},targetPosition:{},sourceHandleId:{},targetHandleId:{},animated:{type:Boolean},updatable:{type:Boolean},markerStart:{},markerEnd:{},curvature:{},interactionWidth:{},data:{},events:{},labelStyle:{},labelShowBg:{type:Boolean},labelBgStyle:{},labelBgPadding:{},labelBgBorderRadius:{},sourceX:{},sourceY:{},targetX:{},targetY:{},controller:{}},setup(a){const e=a,t=F(e.data.props.taskType||""),s=F(!1),o=()=>{!s.value||(t.value!==e.data.props.taskType&&e.controller.updateTransitionProps(e.data.id,{taskType:t.value}),s.value=!1)},{onEdgeClick:r,onPaneClick:u}=U();r(g=>{g.edge.id===e.id&&!s.value&&(s.value=!0)}),u(()=>o());const h=E(()=>rt(e.sourceNode,e.targetNode)),m=E(()=>Ue(Ma(h.value))),d=g=>{g.key==="Enter"&&o()};return xe(()=>window.addEventListener("keydown",d)),Ee(()=>window.removeEventListener("keydown",d)),(g,f)=>(n(),S(K,null,[p(i(Ct),{path:m.value[0],"marker-end":g.markerEnd},null,8,["path","marker-end"]),p(i(At),null,{default:v(()=>[s.value?(n(),S("div",{key:1,style:le({transform:`translate(-50%, -50%) translate(${m.value[1]}px,${m.value[2]}px)`}),class:"nodrag nopan edge-input-container"},[p(i(me),{value:t.value,"onUpdate:value":f[0]||(f[0]=C=>t.value=C),placeholder:"Task type"},null,8,["value"])],4)):(n(),S("div",{key:0,style:le({transform:`translate(-50%, -50%) translate(${m.value[1]}px,${m.value[2]}px)`}),class:"nodrag nopan edge-label"},[e.data.props.taskType?(n(),I(i(se),{key:1},{default:v(()=>[L(Y(e.data.props.taskType),1)]),_:1})):(n(),I(i(Ns),{key:0,size:16}))],4))]),_:1})],64))}});const Ha=ie(za,[["__scopeId","data-v-d1728a8a"]]),ja={key:0},Ba=$("defs",null,[$("marker",{id:"arrowhead",markerWidth:"8",markerHeight:"8",refX:"0",refY:"4",orient:"auto",markerUnits:"strokeWidth"},[$("path",{d:"M0,0 L8,4 L0,8",fill:"none",stroke:"#222","stroke-width":"1"})])],-1),La=["d"],Za=H({__name:"LineFloating",props:{targetX:{},targetY:{},sourcePosition:{},targetPosition:{},sourceNode:{}},setup(a){const e=a,t=F(!0),{onNodeMouseEnter:s,onNodeMouseLeave:o}=U();s(m=>{m.node.id===e.sourceNode.id&&(t.value=!1)}),o(m=>{m.node.id===e.sourceNode.id&&(t.value=!0)});const r=E(()=>({id:"connection-target",computedPosition:{x:e.targetX,y:e.targetY},dimensions:{width:1,height:1}})),u=E(()=>rt(e.sourceNode,r.value)),h=E(()=>Ue({sourceX:u.value.sx,sourceY:u.value.sy,targetX:u.value.tx,targetY:u.value.ty}));return(m,d)=>t.value?(n(),S("g",ja,[Ba,$("path",{fill:"none",stroke:"#222","stroke-width":1,class:"animated",d:h.value[0],"marker-end":"url(#arrowhead)"},null,8,La)])):A("",!0)}}),Ra=H({__name:"CreateStageFile",props:{filename:{},creatingFileStatus:{},fileExists:{type:Boolean}},emits:["create-file","cancel","update-filename"],setup(a,{emit:e}){const t=a,s=E(()=>{const o=qe(t.filename);return o.valid?t.fileExists?{valid:!0,help:"This file already exists, stage will point to it."}:{valid:!0,help:"File doesn't exist yet. It will be created."}:o});return(o,r)=>(n(),I(i(yt),{open:o.creatingFileStatus==="prompting"||o.creatingFileStatus==="creating",closable:!1,"confirm-loading":o.creatingFileStatus==="creating",onOk:r[1]||(r[1]=u=>e("create-file",o.filename)),onCancel:r[2]||(r[2]=u=>e("cancel"))},{default:v(()=>[p(i(Ke),{layout:"vertical",disabled:o.creatingFileStatus=="creating"},{default:v(()=>[p(i(ge),{label:"You're creating a new file. What should it be called?","validate-status":s.value.valid?"success":"error",help:s.value.valid?s.value.help:s.value.reason},{default:v(()=>[p(i(me),{value:o.filename,onChange:r[0]||(r[0]=u=>e("update-filename",u.target.value||""))},null,8,["value"])]),_:1},8,["validate-status","help"])]),_:1},8,["disabled"])]),_:1},8,["open","confirm-loading"]))}}),Oa={name:"NodeToolbar",compatConfig:{MODE:3},inheritAttrs:!1},Ya=H({...Oa,props:{nodeId:null,isVisible:{type:Boolean},position:{default:re.Top},offset:{default:10},align:{default:"center"}},setup(a){const e=a,t=O(Pt,null),{viewportRef:s,viewport:o,getSelectedNodes:r,findNode:u}=U();function h(w,y,N,_,V){let j=.5;V==="start"?j=0:V==="end"&&(j=1);let x=[(w.x+w.width*j)*y.zoom+y.x,w.y*y.zoom+y.y-_],Z=[-100*j,-100];switch(N){case re.Right:x=[(w.x+w.width)*y.zoom+y.x+_,(w.y+w.height*j)*y.zoom+y.y],Z=[0,-100*j];break;case re.Bottom:x[1]=(w.y+w.height)*y.zoom+y.y+_,Z[1]=0;break;case re.Left:x=[w.x*y.zoom+y.x-_,(w.y+w.height*j)*y.zoom+y.y],Z=[-100,-100*j];break}return`translate(${x[0]}px, ${x[1]}px) translate(${Z[0]}%, ${Z[1]}%)`}const m=E(()=>(Array.isArray(e.nodeId)?e.nodeId:[e.nodeId||t||""]).reduce((w,y)=>{const N=u(y);return N&&w.push(N),w},[])),d=E(()=>typeof e.isVisible=="boolean"?e.isVisible:m.value.length===1&&m.value[0].selected&&r.value.length===1),g=E(()=>Dt(m.value)),f=E(()=>Math.max(...m.value.map(w=>(w.computedPosition.z||1)+1))),C=E(()=>({position:"absolute",transform:h(g.value,o.value,e.position,e.offset,e.align),zIndex:f.value}));return(w,y)=>(n(),I(mt,{to:i(s),disabled:!i(s)},[i(d)&&i(m).length?(n(),S("div",fe({key:0},w.$attrs,{style:i(C),class:"vue-flow__node-toolbar"}),[z(w.$slots,"default")],16)):A("",!0)],8,["to","disabled"]))}}),Ka=H({__name:"NodeMenu",props:{isConnecting:{type:Boolean},isEditing:{type:Boolean},menuOptions:{}},setup(a){return(e,t)=>(n(),I(i(Ya),{"is-visible":e.isConnecting||e.isEditing?!1:void 0,position:i(re).Right},{default:v(()=>[p(i(oe),{vertical:"",gap:"small",style:le({marginBottom:`-${16*e.menuOptions.length}%`})},{default:v(()=>[(n(!0),S(K,null,ve(e.menuOptions,s=>(n(),I(i(wt),{key:s.label,title:s.tooltip,placement:"right"},{default:v(()=>[p(i(Ye),{class:Xe([{"warning-button":s.warning}]),disabled:s.disabled,style:le({backgroundColor:s.disabled?"#f5f5f5":void 0}),onClick:o=>s.click(o)},{default:v(()=>[p(i(oe),{gap:"small",style:{width:"100%"},justify:"space-between",align:"center"},{default:v(()=>[L(Y(s.label)+" ",1),s.key?(n(),I(i(se),{key:0,keyboard:"",disabled:s.disabled},{default:v(()=>[L(Y(s.key),1)]),_:2},1032,["disabled"])):A("",!0)]),_:2},1024)]),_:2},1032,["class","disabled","style","onClick"])]),_:2},1032,["title"]))),128))]),_:1},8,["style"])]),_:1},8,["is-visible","position"]))}});const Xa=H({__name:"AgentItems",props:{stageProps:{}},emits:["update:stage-props"],setup(a,{emit:e}){const t=a,s=F(!1),o=l.object({title:l.string(),clientStageId:l.string().uuid(),inputSchemas:l.any(),outputSchemas:l.any()});ye(()=>t.stageProps.projectId,()=>{s.value=!0,g()});const r=l.array(o),{result:u,loading:h,refetch:m,error:d}=Qe(async()=>{const y=t.stageProps.projectId;if(!y)return[];const _=await(await fetch(`/_editor/api/services/roles/client/entrypoints/${y}`)).json();return r.parse(_)}),g=W.exports.debounce(()=>{s.value=!1,m()},500),f=E(()=>h.value||!u.value?[]:u.value.map(y=>({label:y.title,value:y.clientStageId})));function C(y){e("update:stage-props",{...t.stageProps,projectId:y})}function w(y){const N=String(y);!u.value||e("update:stage-props",{...t.stageProps,clientStageId:N})}return(y,N)=>(n(),S(K,null,[p(i(ge),{label:"Project ID"},{default:v(()=>{var _;return[p(i(me),{value:(_=y.stageProps.projectId)!=null?_:"",placeholder:"Project ID",autofocus:"","onUpdate:value":C},null,8,["value"])]}),_:1}),p(i(ge),{label:"Client entrypoint"},{default:v(()=>{var _;return[s.value||i(h)?(n(),I(i(_e),{key:0,disabled:"",loading:""})):i(d)?(n(),I(i($e),{key:1,type:"error",message:"Invalid project id"})):y.stageProps.projectId?i(u).length===0?(n(),I(i($e),{key:3,type:"warning",message:"The project has no entrypoints"})):(n(),I(i(_e),{key:4,options:f.value,value:(_=y.stageProps.clientStageId)!=null?_:void 0,"onUpdate:value":w},null,8,["options","value"])):(n(),I(i(_e),{key:2,disabled:""}))]}),_:1})],64))}}),Wa=H({__name:"StageNode",props:{stage:{},node:{},initialFileCheck:{type:Boolean},controller:{}},setup(a){var Le;const e=a,{useToken:t}=et,{token:s}=t(),o=s.value.colorText,r=[{label:"Add transition",key:"T",click:c=>ze(c)},{label:"Rename",key:"R",click:()=>B.value=!0},{label:"Go to editor",key:"Enter",click:()=>Me()},{label:"Tasks",key:"M",click:()=>h.value=!0},{label:"Delete",key:"Del",click:()=>P(e.stage)}],u=E(()=>{let c=[...r];return m.value||c.unshift({label:"Create missing file",warning:!0,click:()=>V()}),e.controller.hasChanges()&&(c=c.map(b=>b.label==="Go to editor"?{...b,disabled:!0,tooltip:"Save it to allow editing"}:b)),(e.stage.type==="agents"||e.stage.type==="clients")&&(c=c.filter(b=>!["Create missing file","Go to editor","Tasks"].includes(b.label))),c}),h=F(!1),m=F(e.initialFileCheck);ye(()=>e.initialFileCheck,c=>{m.value=c});const d=c=>{w.value=c,C()},g=c=>{e.controller.updateStageProps(e.stage.id,c)},f=()=>{var c;y.value="idle",(e.stage.type==="forms"||e.stage.type==="jobs"||e.stage.type==="hooks"||e.stage.type==="scripts")&&(w.value=(c=e.stage.props.filename)!=null?c:"",C())},C=W.exports.debounce(async()=>{const c=w.value;if(!c){m.value=!0;return}he.checkFile(c).then(b=>{m.value=b.exists})},500),w=F((e.stage.type==="forms"||e.stage.type==="hooks"||e.stage.type==="scripts"||e.stage.type==="jobs")&&(Le=e.stage.props.filename)!=null?Le:""),y=F("idle"),N=async()=>{y.value="creating",await he.initFile(w.value,e.stage.type),m.value=!0;const c=await he.checkFile(w.value);if(m.value=c.exists,y.value="idle",e.stage.type==="forms"||e.stage.type==="hooks")e.controller.updateStageProps(e.stage.id,{path:e.stage.props.path,filename:w.value});else if(e.stage.type==="scripts"||e.stage.type==="jobs")e.controller.updateStageProps(e.stage.id,{filename:w.value});else throw new Error(`Invalid stage type: ${e.stage.type}`)},_=E(()=>["forms","hooks","scripts","jobs"].includes(e.stage.type)?!m.value:e.stage.type==="agents"?!e.stage.props.clientStageId||!e.stage.props.projectId:!1),V=()=>{y.value="prompting"},{startConnection:j,updateConnection:x,onNodeClick:Z,addEdges:de,endConnection:k,removeNodes:P,onPaneClick:D,getSelectedNodes:G,flowToScreenCoordinate:X,onNodeMouseEnter:ce,onNodeMouseLeave:ue,getNodes:dt,onNodesChange:ct,applyNodeChanges:ut}=U(),pt=kt(),q=F(!1),B=F(!1),J=F(e.stage.title),ke=F(!1);ct(async c=>{var M;const b=[];for(const ee of c)ee.type==="remove"?B.value||((M=e.controller)==null||M.delete([ee.id]),b.push(ee)):b.push(ee);ut(b)});const Me=()=>{const c=e.stage.type==="scripts"?"tasklet":e.stage.type.slice(0,-1);pt.push({path:`/_editor/${c}/${e.stage.id}`})},ze=(c,b=!0)=>{j({nodeId:e.stage.id,type:"source",handleId:e.stage.id},{x:b?c.pageX-180:c.pageX-90,y:b?c.pageY-50:c.pageY-20}),document.addEventListener("mousemove",He),q.value=!0},He=c=>{q.value&&!ke.value&&x({x:c.pageX-180,y:c.pageY-52})};Z(c=>{if(c.node.id===e.stage.id&&C(),q.value&&c.node.id!==e.stage.id){const b={sourceStageId:e.stage.id,targetStageId:c.node.id,type:"task",id:tt(),props:{taskType:null}};try{e.controller.connect([b]),document.removeEventListener("mousemove",He),de({source:e.stage.id,target:c.node.id,type:"task",markerEnd:{type:We.Arrow,width:24,height:24},data:b}),k(),q.value=!1}catch(M){console.error(M)}}}),ce(c=>{if(q.value&&c.node.id!==e.stage.id){ke.value=!0;const b=dt.value.find(ee=>ee.id===e.stage.id);if(!b)return;const M=Te(b,c.node,-10);x(X({x:M.x-180,y:M.y-52}))}}),ue(()=>{ke.value=!1});const je=()=>{if(!m.value){const c=Je(J.value+".py");w.value=c;let b={filename:c,path:null};if(["forms","hooks"].includes(e.stage.type)){const M=Ge(J.value);b={...b,path:M}}e.controller.updateStageProps(e.stage.id,b)}};D(()=>{B.value=!1,e.stage.title!==J.value&&(e.controller.updateStageTitle(e.stage.id,J.value),je()),q.value=!1,k()});const Be=c=>{if(!!G.value.map(b=>b.id).includes(e.stage.id)&&y.value==="idle"){if(c.key==="Enter")if(B.value)B.value=!1,e.controller.updateStageTitle(e.stage.id,J.value),je();else{if(e.controller.hasChanges()||e.stage.type==="agents"||e.stage.type==="clients")return;Me()}if(!B.value){if(c.key==="t"||c.key==="T"){const b=X(e.stage.position);ze({pageX:b.x,pageY:b.y},!1)}(c.key==="r"||c.key==="R")&&(B.value=!0),(c.key==="m"||c.key==="M")&&(h.value=!0)}}};return xe(()=>{window.addEventListener("keydown",Be)}),Ee(()=>{window.removeEventListener("keydown",Be)}),(c,b)=>(n(),S(K,null,[p(Ka,{"is-connecting":q.value,"is-editing":B.value,"menu-options":u.value},null,8,["is-connecting","is-editing","menu-options"]),$("div",{class:"stage",onDblclick:b[1]||(b[1]=M=>B.value=!0)},[p(i(oe),{vertical:B.value,class:"point",gap:"small",align:"center",style:{padding:"4px 0"}},{default:v(()=>[(n(),I(R(i(zt)(c.stage.type)),{size:18,color:i(o)},null,8,["color"])),B.value?(n(),I(i(Ke),{key:1,layout:"vertical"},{default:v(()=>[p(i(ge),{label:"Title"},{default:v(()=>[p(i(me),{value:J.value,"onUpdate:value":b[0]||(b[0]=M=>J.value=M),class:"nodrag nopan",autofocus:""},null,8,["value"])]),_:1}),c.stage.type==="agents"?(n(),I(Xa,{key:0,"stage-props":c.stage.props,"onUpdate:stageProps":g},null,8,["stage-props"])):A("",!0)]),_:1})):(n(),I(i(St),{key:0,class:"title"},{default:v(()=>[L(Y(c.stage.title),1)]),_:1}))]),_:1},8,["vertical"])],32),_.value?(n(),I(i(Ot),{key:0,count:"!",color:"gold",style:{position:"absolute",top:"-4px",right:"-4px","z-index":"1"}})):A("",!0),y.value==="prompting"||y.value==="creating"?(n(),I(Ra,{key:1,filename:w.value,"file-exists":m.value,"creating-file-status":y.value,onCreateFile:N,onCancel:f,onUpdateFilename:d},null,8,["filename","file-exists","creating-file-status"])):A("",!0),p(i(Rt),{visible:h.value,"onUpdate:visible":b[2]||(b[2]=M=>h.value=M),title:"Tasks",width:"500",onClose:b[3]||(b[3]=M=>h.value=!1)},{default:v(()=>[p(Zt,{"stage-id":c.stage.id},null,8,["stage-id"])]),_:1},8,["visible"])],64))}});const te=ie(Wa,[["__scopeId","data-v-c24aae5d"]]),lt=a=>(_t("data-v-f4278104"),a=a(),bt(),a),Ua={class:"empty-hint"},Ga={key:0,class:"drag-hint"},qa=lt(()=>$("div",{class:"title"},"Start here",-1)),Ja={key:1,class:"drop-hint"},Qa=lt(()=>$("div",{class:"title"},"Drop here",-1)),eo={key:2,class:"stages-hint"},to={class:"header"},so={class:"title"},ao={class:"description"},oo=H({__name:"EmptyHint",props:{showDragHint:{type:Boolean}},setup(a){return(e,t)=>(n(),S("div",Ua,[e.showDragHint?(n(),S("div",Ga,[qa,p(i(Re),{size:32,class:"arrow"})])):A("",!0),e.showDragHint?A("",!0):(n(),S("div",Ja,[Qa,p(i(Re),{size:32,class:"arrow"})])),e.showDragHint?(n(),S("div",eo,[(n(!0),S(K,null,ve(i(we).stages,s=>(n(),S("div",{key:s.key,class:"stage-hint"},[$("div",to,[(n(),I(R(s.icon))),$("span",so,Y(s.title),1)]),$("div",ao,Y(s.description),1)]))),128))])):A("",!0)]))}});const io=ie(oo,[["__scopeId","data-v-f4278104"]]),no=H({__name:"Workflow",props:{workflow:{},editable:{type:Boolean},showDragHint:{type:Boolean},checkFileStatus:{type:Boolean},initialFileCheckStatus:{}},setup(a){const e=a;It(d=>({ecafe25e:i(u),"3094d9cc":i(r)}));const t=nt(),{useToken:s}=et,{token:o}=s(),r=o.value.colorPrimaryBorder,u=o.value.colorBgElevated,{onInit:h}=U();h(d=>{d.fitView()});const m=d=>{var g;return!e.checkFileStatus||!e.initialFileCheckStatus?!0:d&&(g=e.initialFileCheckStatus[d])!=null?g:!1};return(d,g)=>d.workflow?(n(),I(i(Ft),{key:0,nodes:d.workflow.vueFlowNodes.value,edges:d.workflow.vueFlowEdges.value,"max-zoom":1.25,class:"vue-flow-root","select-nodes-on-drag":!1,"zoom-on-double-click":!1,multi:"","multi-selection-key-code":"Shift","nodes-draggable":d.editable,"pan-on-scroll":i(Ve).isMac,"elements-selectable":d.editable,"snap-to-grid":"","apply-default":!1,onDragover:i(t).onDragOver,onDragleave:i(t).onDragLeave},{"connection-line":v(f=>[p(Za,$t(Tt(f)),null,16)]),"edge-task":v(f=>[p(Ha,fe(f,{controller:d.workflow}),null,16,["controller"])]),"node-forms":v(f=>[p(te,{stage:f.data,node:f,controller:d.workflow,"initial-file-check":m(f.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-hooks":v(f=>[p(te,{stage:f.data,node:f,controller:d.workflow,"initial-file-check":m(f.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-scripts":v(f=>[p(te,{stage:f.data,node:f,controller:d.workflow,"initial-file-check":m(f.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-jobs":v(f=>[p(te,{stage:f.data,node:f,controller:d.workflow,"initial-file-check":m(f.data.props.filename)},null,8,["stage","node","controller","initial-file-check"])]),"node-agents":v(f=>[p(te,{stage:f.data,node:f,controller:d.workflow,"initial-file-check":!0},null,8,["stage","node","controller"])]),"node-clients":v(f=>[p(te,{stage:f.data,node:f,controller:d.workflow,"initial-file-check":!0},null,8,["stage","node","controller"])]),default:v(()=>[p(i(Nt)),d.editable&&!d.workflow.vueFlowNodes.value.length?(n(),I(io,{key:0,"show-drag-hint":d.showDragHint},null,8,["show-drag-hint"])):A("",!0),p(i(Vt),{pannable:"",zoomable:""}),d.editable?(n(),I(Fa,{key:1,workflow:d.workflow},null,8,["workflow"])):A("",!0)]),_:1},8,["nodes","edges","nodes-draggable","pan-on-scroll","elements-selectable","onDragover","onDragleave"])):A("",!0)}});const ro=ie(no,[["__scopeId","data-v-d709f269"]]),lo=H({__name:"WorkflowEditor",setup(a){const{init:e,tearDown:t,onDragStart:s,onDrop:o,isDragging:r,isAdding:u,draggedType:h,mousePosition:m}=nt(),{result:d}=Qe(async()=>await Ne.init(Os,!0)),g=F(null),f=async()=>{if(!d.value)return;const k=d.value.vueFlowNodes.value.map(P=>{var D,G,X,ce,ue;return((D=P.data)==null?void 0:D.type)==="forms"||((G=P.data)==null?void 0:G.type)==="hooks"||((X=P.data)==null?void 0:X.type)==="scripts"||((ce=P.data)==null?void 0:ce.type)==="jobs"?(ue=P.data)==null?void 0:ue.props.filename:null});g.value=await he.checkFiles(k.filter(P=>typeof P=="string"))};ye(()=>d.value,()=>{d.value&&(e(d.value),f())});const{onNodeDragStop:C,onEdgesChange:w,getSelectedElements:y,getNodes:N,addSelectedNodes:_,zoomIn:V,fitView:j,zoomOut:x,applyEdgeChanges:Z}=U();C(k=>{var P;(P=d.value)==null||P.move(k.nodes.map(D=>({id:D.id,position:D.position})))}),w(k=>{var P;for(const D of k)D.type==="remove"&&((P=d.value)==null||P.delete([D.id]));Z(k)});const de=k=>{var P,D;!d.value||((k.key==="z"||k.key==="Z")&&Q(k)&&(it(k)?d.value.history.redo():(P=d.value)==null||P.history.undo(),k.preventDefault()),Q(k)&&(k.key==="s"||k.key==="S")&&((D=d.value)==null||D.save(),k.preventDefault()),!y.value.length&&(k.key==="f"||k.key==="F"?s(null,"forms"):k.key==="h"||k.key==="H"?s(null,"hooks"):k.key==="j"||k.key==="J"?s(null,"jobs"):k.key==="o"||k.key==="O"?s(null,"scripts"):(k.key==="a"||k.key==="A")&&Q(k)?(_(N.value),k.preventDefault()):k.key==="0"&&Q(k)?(j(),k.preventDefault()):(k.key==="="||k.key==="+")&&Q(k)?(k.preventDefault(),V()):k.key==="-"&&Q(k)&&(k.preventDefault(),x())))};return xe(()=>{window.addEventListener("keydown",de)}),Ee(()=>{window.removeEventListener("keydown",de),t()}),(k,P)=>i(d)?(n(),S("div",{key:0,class:Xe(["workflow-container",{dragging:i(u)}]),onDrop:P[0]||(P[0]=(...D)=>i(o)&&i(o)(...D))},[p(ro,{workflow:i(d),editable:"","show-drag-hint":!i(u),"check-file-status":!0,"initial-file-check-status":g.value},null,8,["workflow","show-drag-hint","initial-file-check-status"]),p(ta,{controller:i(d),onDragStart:i(s)},null,8,["controller","onDragStart"]),(n(!0),S(K,null,ve(i(we).stages,D=>{var G,X;return n(),S("div",{key:D.key},[i(u)&&!i(r)&&D.typeName===i(h)?(n(),S("div",{key:0,class:"dragging-node",style:le({left:`${(G=i(m))==null?void 0:G.x}px`,top:`${(X=i(m))==null?void 0:X.y}px`,position:"absolute",cursor:i(u)?"grabbing":"grab"})},[(n(),I(R(D.icon),{size:18}))],4)):A("",!0)])}),128))],34)):A("",!0)}});const Wo=ie(lo,[["__scopeId","data-v-5f802ac0"]]);export{Wo as default};
//# sourceMappingURL=WorkflowEditor.5c15789b.js.map
